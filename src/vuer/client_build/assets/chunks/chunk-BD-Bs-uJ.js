const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/chunk-Hzh-wOeE.js","assets/chunks/chunk-Dn3xWmgR.js","assets/chunks/chunk-CF7PZJR8.js","assets/chunks/chunk-BdvozYt0.js","assets/static/pages_index-c6b9ae3c.CWSrK-Yb.css","assets/chunks/chunk-DH1DswfA.js","assets/chunks/chunk-BXl3LOEh.js","assets/chunks/chunk-DvrnVFXc.js","assets/chunks/chunk-2B0sFjzh.js","assets/chunks/chunk-ChHTQ4Sk.js","assets/chunks/chunk-SmZMj1n8.js","assets/chunks/chunk-BHDKgRpG.js","assets/chunks/chunk-Q1j31JH2.js"])))=>i.map(i=>d[i]);
import{c as kg,a as Og,u as Ng}from"./chunk-4_gci6_w.js";import{_ as Z,t as Kd,F as Vi,a as Ug,b as zg,c as Gg}from"./chunk-BHDKgRpG.js";import{E as $g,r as d,D as xl,z as Mt,j as Y}from"./chunk-CF7PZJR8.js";import{h as _,u as El,v as me,r as Ve,o as Fi,w as pi,j as re,Q as ue,b as we,x as On,D as dt,y as xr,z as wt,A as wi,B as Zt,F as Er,a as oe,G as Re,P as Qt,I as Ui,J as Yr,K as Ps,N as Co,V as de,X as Al,g as gi,l as yi,Y as Ro,Z as He,O as rt,_ as Hg,t as Ms,$ as vi,a0 as Vd,a1 as Kg,a2 as jd,a3 as Vg,a4 as jg,W as Ze,R as Sl,H as tn,a5 as Wg,a6 as Yi,a7 as Pn,a8 as Wd,a9 as Xg,aa as Xd,ab as Ga,ac as fi,ad as Yg,ae as Qg,af as Jg,ag as qg,ah as Ic,e as Ar,ai as Zg,aj as e1,i as Qi,ak as hi,al as t1,am as Tl,an as Yd,ao as i1,q as nn,s as Qd,ap as Jd,aq as qd,ar as Zd,as as bl,at as ef,au as tf,p as nf,av as n1,m as ts,aw as Mn,M as s1,ax as sf,S as Ut,ay as r1,c as bt,L as Ji,az as o1,aA as rf,aB as ht,aC as of,aD as a1,aE as l1,aF as c1,aG as qi,aH as wo,aI as u1,aJ as Io,aK as h1,aL as d1,aM as f1,aN as _o,aO as m1,E as p1,aP as af,aQ as lf,k as $a,aR as g1,aS as y1}from"./chunk-DvrnVFXc.js";import{u as H,a as ee,h as v1,e as Mi,i as us,j as ei,b as je,s as Gt,k as ft,l as xi,v as pt,m as ui,n as Ei,o as Di,p as x1,q as Ds,r as Qr,t as Cl,d as Rl,T as cf,I as uf,c as hf,D as df,g as ff,E as mf,w as Lo,x as E1,y as wl,f as A1,z as S1,A as T1,B as b1,G as C1,H as R1,J as w1,K as I1,L as _1,N as L1,M as P1,P as M1,O as D1,Q as B1,R as F1,S as k1,U as ki,V as pf}from"./chunk-BGUxsRwc.js";import{ai as Nn,aj as gf,ak as O1,al as yf,am as N1,an as U1,ao as z1,ap as G1,aq as $1,ar as H1,as as K1,at as V1,au as j1,av as W1,aw as X1,ax as Y1,ay as Q1,az as vf,aA as xf,aB as J1,aC as q1,aD as Z1,aE as e2,aF as Po,aG as Il,aH as t2,aI as i2,aJ as n2,aK as s2,aL as Ef,aM as _l,aN as Ll,aO as Af,aP as Sf,aQ as Tf,aR as Pl,aS as r2,aT as o2,aU as a2,aV as bf,aW as l2,aX as Mo,aY as c2,aZ as Sr,a_ as u2,a$ as Cf}from"./chunk-DH1DswfA.js";import{_ as Ml}from"./chunk-BXl3LOEh.js";const eT=Object.freeze(Object.defineProperty({__proto__:null,create:kg,createStore:Og,useStore:Ng},Symbol.toStringTag,{value:"Module"}));var h2=Object.defineProperty,d2=(s,e,t)=>e in s?h2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ye=(s,e,t)=>(d2(s,typeof e!="symbol"?e+"":e,t),t);const _c=new _;let f2=class extends Nn{constructor(e,t){super(),ye(this,"object"),ye(this,"domElement"),ye(this,"enabled",!0),ye(this,"movementSpeed",1),ye(this,"lookSpeed",.005),ye(this,"lookVertical",!0),ye(this,"autoForward",!1),ye(this,"activeLook",!0),ye(this,"heightSpeed",!1),ye(this,"heightCoef",1),ye(this,"heightMin",0),ye(this,"heightMax",1),ye(this,"constrainVertical",!1),ye(this,"verticalMin",0),ye(this,"verticalMax",Math.PI),ye(this,"mouseDragOn",!1),ye(this,"autoSpeedFactor",0),ye(this,"mouseX",0),ye(this,"mouseY",0),ye(this,"moveForward",!1),ye(this,"moveBackward",!1),ye(this,"moveLeft",!1),ye(this,"moveRight",!1),ye(this,"moveUp",!1),ye(this,"moveDown",!1),ye(this,"viewHalfX",0),ye(this,"viewHalfY",0),ye(this,"lat",0),ye(this,"lon",0),ye(this,"lookDirection",new _),ye(this,"spherical",new El),ye(this,"target",new _),ye(this,"connect",i=>{i.setAttribute("tabindex","-1"),i.style.touchAction="none",i.addEventListener("contextmenu",this.contextmenu),i.addEventListener("mousemove",this.onMouseMove),i.addEventListener("mousedown",this.onMouseDown),i.addEventListener("mouseup",this.onMouseUp),this.domElement=i,window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize()}),ye(this,"dispose",()=>{var i,n,r,o;(i=this.domElement)==null||i.removeEventListener("contextmenu",this.contextmenu),(n=this.domElement)==null||n.removeEventListener("mousedown",this.onMouseDown),(r=this.domElement)==null||r.removeEventListener("mousemove",this.onMouseMove),(o=this.domElement)==null||o.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}),ye(this,"handleResize",()=>{this.domElement&&(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)}),ye(this,"onMouseDown",i=>{var n;if((n=this.domElement)==null||n.focus(),this.activeLook)switch(i.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0;break}this.mouseDragOn=!0}),ye(this,"onMouseUp",i=>{if(this.activeLook)switch(i.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1;break}this.mouseDragOn=!1}),ye(this,"onMouseMove",i=>{this.domElement&&(this.mouseX=i.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=i.pageY-this.domElement.offsetTop-this.viewHalfY)}),ye(this,"onKeyDown",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0;break}}),ye(this,"onKeyUp",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1;break}}),ye(this,"lookAt",(i,n,r)=>(i instanceof _?this.target.copy(i):n&&r&&this.target.set(i,n,r),this.object.lookAt(this.target),this.setOrientation(),this)),ye(this,"update",i=>{if(!this.enabled)return;if(this.heightSpeed){const h=me.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=i*(h*this.heightCoef)}else this.autoSpeedFactor=0;const n=i*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(n+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(n),this.moveLeft&&this.object.translateX(-n),this.moveRight&&this.object.translateX(n),this.moveUp&&this.object.translateY(n),this.moveDown&&this.object.translateY(-n);let r=i*this.lookSpeed;this.activeLook||(r=0);let o=1;this.constrainVertical&&(o=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.mouseX*r,this.lookVertical&&(this.lat-=this.mouseY*r*o),this.lat=Math.max(-85,Math.min(85,this.lat));let a=me.degToRad(90-this.lat);const c=me.degToRad(this.lon);this.constrainVertical&&(a=me.mapLinear(a,0,Math.PI,this.verticalMin,this.verticalMax));const l=this.object.position;_c.setFromSphericalCoords(1,a,c).add(l),this.object.lookAt(_c)}),ye(this,"contextmenu",i=>i.preventDefault()),ye(this,"setOrientation",()=>{this.lookDirection.set(0,0,-1).applyQuaternion(this.object.quaternion),this.spherical.setFromVector3(this.lookDirection),this.lat=90-me.radToDeg(this.spherical.phi),this.lon=me.radToDeg(this.spherical.theta)}),this.object=e,this.domElement=t,this.setOrientation(),t&&this.connect(t)}};var m2=Object.defineProperty,p2=(s,e,t)=>e in s?m2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,J=(s,e,t)=>(p2(s,typeof e!="symbol"?e+"":e,t),t);let g2=class extends Ve{constructor(e,t){super(),J(this,"isTransformControls",!0),J(this,"visible",!1),J(this,"domElement"),J(this,"raycaster",new Fi),J(this,"gizmo"),J(this,"plane"),J(this,"tempVector",new _),J(this,"tempVector2",new _),J(this,"tempQuaternion",new ue),J(this,"unit",{X:new _(1,0,0),Y:new _(0,1,0),Z:new _(0,0,1)}),J(this,"pointStart",new _),J(this,"pointEnd",new _),J(this,"offset",new _),J(this,"rotationAxis",new _),J(this,"startNorm",new _),J(this,"endNorm",new _),J(this,"rotationAngle",0),J(this,"cameraPosition",new _),J(this,"cameraQuaternion",new ue),J(this,"cameraScale",new _),J(this,"parentPosition",new _),J(this,"parentQuaternion",new ue),J(this,"parentQuaternionInv",new ue),J(this,"parentScale",new _),J(this,"worldPositionStart",new _),J(this,"worldQuaternionStart",new ue),J(this,"worldScaleStart",new _),J(this,"worldPosition",new _),J(this,"worldQuaternion",new ue),J(this,"worldQuaternionInv",new ue),J(this,"worldScale",new _),J(this,"eye",new _),J(this,"positionStart",new _),J(this,"quaternionStart",new ue),J(this,"scaleStart",new _),J(this,"camera"),J(this,"object"),J(this,"enabled",!0),J(this,"axis",null),J(this,"mode","translate"),J(this,"translationSnap",null),J(this,"rotationSnap",null),J(this,"scaleSnap",null),J(this,"space","world"),J(this,"size",1),J(this,"dragging",!1),J(this,"showX",!0),J(this,"showY",!0),J(this,"showZ",!0),J(this,"changeEvent",{type:"change"}),J(this,"mouseDownEvent",{type:"mouseDown",mode:this.mode}),J(this,"mouseUpEvent",{type:"mouseUp",mode:this.mode}),J(this,"objectChangeEvent",{type:"objectChange"}),J(this,"intersectObjectWithRay",(n,r,o)=>{const a=r.intersectObject(n,!0);for(let c=0;c<a.length;c++)if(a[c].object.visible||o)return a[c];return!1}),J(this,"attach",n=>(this.object=n,this.visible=!0,this)),J(this,"detach",()=>(this.object=void 0,this.visible=!1,this.axis=null,this)),J(this,"reset",()=>this.enabled?(this.dragging&&this.object!==void 0&&(this.object.position.copy(this.positionStart),this.object.quaternion.copy(this.quaternionStart),this.object.scale.copy(this.scaleStart),this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent),this.pointStart.copy(this.pointEnd)),this):this),J(this,"updateMatrixWorld",()=>{this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.parentQuaternionInv.copy(this.parentQuaternion).invert(),this.worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld()}),J(this,"pointerHover",n=>{if(this.object===void 0||this.dragging===!0)return;this.raycaster.setFromCamera(n,this.camera);const r=this.intersectObjectWithRay(this.gizmo.picker[this.mode],this.raycaster);r?this.axis=r.object.name:this.axis=null}),J(this,"pointerDown",n=>{if(!(this.object===void 0||this.dragging===!0||n.button!==0)&&this.axis!==null){this.raycaster.setFromCamera(n,this.camera);const r=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(r){let o=this.space;if(this.mode==="scale"?o="local":(this.axis==="E"||this.axis==="XYZE"||this.axis==="XYZ")&&(o="world"),o==="local"&&this.mode==="rotate"){const a=this.rotationSnap;this.axis==="X"&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),this.axis==="Y"&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),this.axis==="Z"&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent&&this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(r.point).sub(this.worldPositionStart)}this.dragging=!0,this.mouseDownEvent.mode=this.mode,this.dispatchEvent(this.mouseDownEvent)}}),J(this,"pointerMove",n=>{const r=this.axis,o=this.mode,a=this.object;let c=this.space;if(o==="scale"?c="local":(r==="E"||r==="XYZE"||r==="XYZ")&&(c="world"),a===void 0||r===null||this.dragging===!1||n.button!==-1)return;this.raycaster.setFromCamera(n,this.camera);const l=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(l){if(this.pointEnd.copy(l.point).sub(this.worldPositionStart),o==="translate")this.offset.copy(this.pointEnd).sub(this.pointStart),c==="local"&&r!=="XYZ"&&this.offset.applyQuaternion(this.worldQuaternionInv),r.indexOf("X")===-1&&(this.offset.x=0),r.indexOf("Y")===-1&&(this.offset.y=0),r.indexOf("Z")===-1&&(this.offset.z=0),c==="local"&&r!=="XYZ"?this.offset.applyQuaternion(this.quaternionStart).divide(this.parentScale):this.offset.applyQuaternion(this.parentQuaternionInv).divide(this.parentScale),a.position.copy(this.offset).add(this.positionStart),this.translationSnap&&(c==="local"&&(a.position.applyQuaternion(this.tempQuaternion.copy(this.quaternionStart).invert()),r.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),r.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),r.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(this.quaternionStart)),c==="world"&&(a.parent&&a.position.add(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld)),r.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),r.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),r.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld))));else if(o==="scale"){if(r.search("XYZ")!==-1){let u=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(u*=-1),this.tempVector2.set(u,u,u)}else this.tempVector.copy(this.pointStart),this.tempVector2.copy(this.pointEnd),this.tempVector.applyQuaternion(this.worldQuaternionInv),this.tempVector2.applyQuaternion(this.worldQuaternionInv),this.tempVector2.divide(this.tempVector),r.search("X")===-1&&(this.tempVector2.x=1),r.search("Y")===-1&&(this.tempVector2.y=1),r.search("Z")===-1&&(this.tempVector2.z=1);a.scale.copy(this.scaleStart).multiply(this.tempVector2),this.scaleSnap&&this.object&&(r.search("X")!==-1&&(this.object.scale.x=Math.round(a.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),r.search("Y")!==-1&&(a.scale.y=Math.round(a.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),r.search("Z")!==-1&&(a.scale.z=Math.round(a.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(o==="rotate"){this.offset.copy(this.pointEnd).sub(this.pointStart);const u=20/this.worldPosition.distanceTo(this.tempVector.setFromMatrixPosition(this.camera.matrixWorld));r==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this.startNorm.copy(this.pointStart).normalize(),this.endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this.endNorm.cross(this.startNorm).dot(this.eye)<0?1:-1):r==="XYZE"?(this.rotationAxis.copy(this.offset).cross(this.eye).normalize(),this.rotationAngle=this.offset.dot(this.tempVector.copy(this.rotationAxis).cross(this.eye))*u):(r==="X"||r==="Y"||r==="Z")&&(this.rotationAxis.copy(this.unit[r]),this.tempVector.copy(this.unit[r]),c==="local"&&this.tempVector.applyQuaternion(this.worldQuaternion),this.rotationAngle=this.offset.dot(this.tempVector.cross(this.eye).normalize())*u),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),c==="local"&&r!=="E"&&r!=="XYZE"?(a.quaternion.copy(this.quaternionStart),a.quaternion.multiply(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this.parentQuaternionInv),a.quaternion.copy(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),a.quaternion.multiply(this.quaternionStart).normalize())}this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent)}}),J(this,"pointerUp",n=>{n.button===0&&(this.dragging&&this.axis!==null&&(this.mouseUpEvent.mode=this.mode,this.dispatchEvent(this.mouseUpEvent)),this.dragging=!1,this.axis=null)}),J(this,"getPointer",n=>{var r;if(this.domElement&&((r=this.domElement.ownerDocument)!=null&&r.pointerLockElement))return{x:0,y:0,button:n.button};{const o=n.changedTouches?n.changedTouches[0]:n,a=this.domElement.getBoundingClientRect();return{x:(o.clientX-a.left)/a.width*2-1,y:-(o.clientY-a.top)/a.height*2+1,button:n.button}}}),J(this,"onPointerHover",n=>{if(this.enabled)switch(n.pointerType){case"mouse":case"pen":this.pointerHover(this.getPointer(n));break}}),J(this,"onPointerDown",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="none",this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.pointerHover(this.getPointer(n)),this.pointerDown(this.getPointer(n)))}),J(this,"onPointerMove",n=>{this.enabled&&this.pointerMove(this.getPointer(n))}),J(this,"onPointerUp",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="",this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.pointerUp(this.getPointer(n)))}),J(this,"getMode",()=>this.mode),J(this,"setMode",n=>{this.mode=n}),J(this,"setTranslationSnap",n=>{this.translationSnap=n}),J(this,"setRotationSnap",n=>{this.rotationSnap=n}),J(this,"setScaleSnap",n=>{this.scaleSnap=n}),J(this,"setSize",n=>{this.size=n}),J(this,"setSpace",n=>{this.space=n}),J(this,"update",()=>{console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}),J(this,"connect",n=>{n===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointermove",this.onPointerHover),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp)}),J(this,"dispose",()=>{var n,r,o,a,c,l;(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(r=this.domElement)==null||r.removeEventListener("pointermove",this.onPointerHover),(a=(o=this.domElement)==null?void 0:o.ownerDocument)==null||a.removeEventListener("pointermove",this.onPointerMove),(l=(c=this.domElement)==null?void 0:c.ownerDocument)==null||l.removeEventListener("pointerup",this.onPointerUp),this.traverse(u=>{const h=u;h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()})}),this.domElement=t,this.camera=e,this.gizmo=new y2,this.add(this.gizmo),this.plane=new v2,this.add(this.plane);const i=(n,r)=>{let o=r;Object.defineProperty(this,n,{get:function(){return o!==void 0?o:r},set:function(a){o!==a&&(o=a,this.plane[n]=a,this.gizmo[n]=a,this.dispatchEvent({type:n+"-changed",value:a}),this.dispatchEvent(this.changeEvent))}}),this[n]=r,this.plane[n]=r,this.gizmo[n]=r};i("camera",this.camera),i("object",this.object),i("enabled",this.enabled),i("axis",this.axis),i("mode",this.mode),i("translationSnap",this.translationSnap),i("rotationSnap",this.rotationSnap),i("scaleSnap",this.scaleSnap),i("space",this.space),i("size",this.size),i("dragging",this.dragging),i("showX",this.showX),i("showY",this.showY),i("showZ",this.showZ),i("worldPosition",this.worldPosition),i("worldPositionStart",this.worldPositionStart),i("worldQuaternion",this.worldQuaternion),i("worldQuaternionStart",this.worldQuaternionStart),i("cameraPosition",this.cameraPosition),i("cameraQuaternion",this.cameraQuaternion),i("pointStart",this.pointStart),i("pointEnd",this.pointEnd),i("rotationAxis",this.rotationAxis),i("rotationAngle",this.rotationAngle),i("eye",this.eye),t!==void 0&&this.connect(t)}};class y2 extends Ve{constructor(){super(),J(this,"isTransformControlsGizmo",!0),J(this,"type","TransformControlsGizmo"),J(this,"tempVector",new _(0,0,0)),J(this,"tempEuler",new pi),J(this,"alignVector",new _(0,1,0)),J(this,"zeroVector",new _(0,0,0)),J(this,"lookAtMatrix",new re),J(this,"tempQuaternion",new ue),J(this,"tempQuaternion2",new ue),J(this,"identityQuaternion",new ue),J(this,"unitX",new _(1,0,0)),J(this,"unitY",new _(0,1,0)),J(this,"unitZ",new _(0,0,1)),J(this,"gizmo"),J(this,"picker"),J(this,"helper"),J(this,"rotationAxis",new _),J(this,"cameraPosition",new _),J(this,"worldPositionStart",new _),J(this,"worldQuaternionStart",new ue),J(this,"worldPosition",new _),J(this,"worldQuaternion",new ue),J(this,"eye",new _),J(this,"camera",null),J(this,"enabled",!0),J(this,"axis",null),J(this,"mode","translate"),J(this,"space","world"),J(this,"size",1),J(this,"dragging",!1),J(this,"showX",!0),J(this,"showY",!0),J(this,"showZ",!0),J(this,"updateMatrixWorld",()=>{let N=this.space;this.mode==="scale"&&(N="local");const B=N==="local"?this.worldQuaternion:this.identityQuaternion;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let G=[];G=G.concat(this.picker[this.mode].children),G=G.concat(this.gizmo[this.mode].children),G=G.concat(this.helper[this.mode].children);for(let j=0;j<G.length;j++){const L=G[j];L.visible=!0,L.rotation.set(0,0,0),L.position.copy(this.worldPosition);let X;if(this.camera.isOrthographicCamera?X=(this.camera.top-this.camera.bottom)/this.camera.zoom:X=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),L.scale.set(1,1,1).multiplyScalar(X*this.size/7),L.tag==="helper"){L.visible=!1,L.name==="AXIS"?(L.position.copy(this.worldPositionStart),L.visible=!!this.axis,this.axis==="X"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,0)),L.quaternion.copy(B).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(B).dot(this.eye))>.9&&(L.visible=!1)),this.axis==="Y"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,Math.PI/2)),L.quaternion.copy(B).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(B).dot(this.eye))>.9&&(L.visible=!1)),this.axis==="Z"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),L.quaternion.copy(B).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(B).dot(this.eye))>.9&&(L.visible=!1)),this.axis==="XYZE"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),this.alignVector.copy(this.rotationAxis),L.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.zeroVector,this.alignVector,this.unitY)),L.quaternion.multiply(this.tempQuaternion),L.visible=this.dragging),this.axis==="E"&&(L.visible=!1)):L.name==="START"?(L.position.copy(this.worldPositionStart),L.visible=this.dragging):L.name==="END"?(L.position.copy(this.worldPosition),L.visible=this.dragging):L.name==="DELTA"?(L.position.copy(this.worldPositionStart),L.quaternion.copy(this.worldQuaternionStart),this.tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),this.tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),L.scale.copy(this.tempVector),L.visible=this.dragging):(L.quaternion.copy(B),this.dragging?L.position.copy(this.worldPositionStart):L.position.copy(this.worldPosition),this.axis&&(L.visible=this.axis.search(L.name)!==-1));continue}L.quaternion.copy(B),this.mode==="translate"||this.mode==="scale"?((L.name==="X"||L.name==="XYZX")&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(B).dot(this.eye))>.99&&(L.scale.set(1e-10,1e-10,1e-10),L.visible=!1),(L.name==="Y"||L.name==="XYZY")&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(B).dot(this.eye))>.99&&(L.scale.set(1e-10,1e-10,1e-10),L.visible=!1),(L.name==="Z"||L.name==="XYZZ")&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(B).dot(this.eye))>.99&&(L.scale.set(1e-10,1e-10,1e-10),L.visible=!1),L.name==="XY"&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(B).dot(this.eye))<.2&&(L.scale.set(1e-10,1e-10,1e-10),L.visible=!1),L.name==="YZ"&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(B).dot(this.eye))<.2&&(L.scale.set(1e-10,1e-10,1e-10),L.visible=!1),L.name==="XZ"&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(B).dot(this.eye))<.2&&(L.scale.set(1e-10,1e-10,1e-10),L.visible=!1),L.name.search("X")!==-1&&(this.alignVector.copy(this.unitX).applyQuaternion(B).dot(this.eye)<0?L.tag==="fwd"?L.visible=!1:L.scale.x*=-1:L.tag==="bwd"&&(L.visible=!1)),L.name.search("Y")!==-1&&(this.alignVector.copy(this.unitY).applyQuaternion(B).dot(this.eye)<0?L.tag==="fwd"?L.visible=!1:L.scale.y*=-1:L.tag==="bwd"&&(L.visible=!1)),L.name.search("Z")!==-1&&(this.alignVector.copy(this.unitZ).applyQuaternion(B).dot(this.eye)<0?L.tag==="fwd"?L.visible=!1:L.scale.z*=-1:L.tag==="bwd"&&(L.visible=!1))):this.mode==="rotate"&&(this.tempQuaternion2.copy(B),this.alignVector.copy(this.eye).applyQuaternion(this.tempQuaternion.copy(B).invert()),L.name.search("E")!==-1&&L.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.eye,this.zeroVector,this.unitY)),L.name==="X"&&(this.tempQuaternion.setFromAxisAngle(this.unitX,Math.atan2(-this.alignVector.y,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),L.quaternion.copy(this.tempQuaternion)),L.name==="Y"&&(this.tempQuaternion.setFromAxisAngle(this.unitY,Math.atan2(this.alignVector.x,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),L.quaternion.copy(this.tempQuaternion)),L.name==="Z"&&(this.tempQuaternion.setFromAxisAngle(this.unitZ,Math.atan2(this.alignVector.y,this.alignVector.x)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),L.quaternion.copy(this.tempQuaternion))),L.visible=L.visible&&(L.name.indexOf("X")===-1||this.showX),L.visible=L.visible&&(L.name.indexOf("Y")===-1||this.showY),L.visible=L.visible&&(L.name.indexOf("Z")===-1||this.showZ),L.visible=L.visible&&(L.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),L.material.tempOpacity=L.material.tempOpacity||L.material.opacity,L.material.tempColor=L.material.tempColor||L.material.color.clone(),L.material.color.copy(L.material.tempColor),L.material.opacity=L.material.tempOpacity,this.enabled?this.axis&&(L.name===this.axis?(L.material.opacity=1,L.material.color.lerp(new we(1,1,1),.5)):this.axis.split("").some(function(Q){return L.name===Q})?(L.material.opacity=1,L.material.color.lerp(new we(1,1,1),.5)):(L.material.opacity*=.25,L.material.color.lerp(new we(1,1,1),.5))):(L.material.opacity*=.5,L.material.color.lerp(new we(1,1,1),.5))}super.updateMatrixWorld()});const e=new On({depthTest:!1,depthWrite:!1,transparent:!0,side:dt,fog:!1,toneMapped:!1}),t=new xr({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;const n=e.clone();n.opacity=.33;const r=e.clone();r.color.set(16711680);const o=e.clone();o.color.set(65280);const a=e.clone();a.color.set(255);const c=e.clone();c.opacity=.25;const l=c.clone();l.color.set(16776960);const u=c.clone();u.color.set(65535);const h=c.clone();h.color.set(16711935),e.clone().color.set(16776960);const m=t.clone();m.color.set(16711680);const p=t.clone();p.color.set(65280);const g=t.clone();g.color.set(255);const y=t.clone();y.color.set(65535);const v=t.clone();v.color.set(16711935);const E=t.clone();E.color.set(16776960);const x=t.clone();x.color.set(7895160);const T=E.clone();T.opacity=.25;const A=new wt(0,.05,.2,12,1,!1),C=new wi(.125,.125,.125),b=new Zt;b.setAttribute("position",new Er([0,0,0,1,0,0],3));const R=(N,B)=>{const G=new Zt,j=[];for(let L=0;L<=64*B;++L)j.push(0,Math.cos(L/32*Math.PI)*N,Math.sin(L/32*Math.PI)*N);return G.setAttribute("position",new Er(j,3)),G},I=()=>{const N=new Zt;return N.setAttribute("position",new Er([0,0,0,1,1,1],3)),N},w={X:[[new oe(A,r),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new oe(A,r),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Re(b,m)]],Y:[[new oe(A,o),[0,1,0],null,null,"fwd"],[new oe(A,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Re(b,p),null,[0,0,Math.PI/2]]],Z:[[new oe(A,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new oe(A,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Re(b,g),null,[0,-Math.PI/2,0]]],XYZ:[[new oe(new Ui(.1,0),c.clone()),[0,0,0],[0,0,0]]],XY:[[new oe(new Qt(.295,.295),l.clone()),[.15,.15,0]],[new Re(b,E),[.18,.3,0],null,[.125,1,1]],[new Re(b,E),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new oe(new Qt(.295,.295),u.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new Re(b,y),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Re(b,y),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new oe(new Qt(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new Re(b,v),[.18,0,.3],null,[.125,1,1]],[new Re(b,v),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},M={X:[[new oe(new wt(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new oe(new wt(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new oe(new wt(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new oe(new Ui(.2,0),i)]],XY:[[new oe(new Qt(.4,.4),i),[.2,.2,0]]],YZ:[[new oe(new Qt(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new oe(new Qt(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},P={START:[[new oe(new Ui(.01,2),n),null,null,null,"helper"]],END:[[new oe(new Ui(.01,2),n),null,null,null,"helper"]],DELTA:[[new Re(I(),n),null,null,null,"helper"]],X:[[new Re(b,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Re(b,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Re(b,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},O={X:[[new Re(R(1,.5),m)],[new oe(new Ui(.04,0),r),[0,0,.99],null,[1,3,1]]],Y:[[new Re(R(1,.5),p),null,[0,0,-Math.PI/2]],[new oe(new Ui(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new Re(R(1,.5),g),null,[0,Math.PI/2,0]],[new oe(new Ui(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new Re(R(1.25,1),T),null,[0,Math.PI/2,0]],[new oe(new wt(.03,0,.15,4,1,!1),T),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new oe(new wt(.03,0,.15,4,1,!1),T),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new oe(new wt(.03,0,.15,4,1,!1),T),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new oe(new wt(.03,0,.15,4,1,!1),T),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Re(R(1,1),x),null,[0,Math.PI/2,0]]]},z={AXIS:[[new Re(b,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},D={X:[[new oe(new Ps(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new oe(new Ps(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new oe(new Ps(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new oe(new Ps(1.25,.1,2,24),i)]],XYZE:[[new oe(new Yr(.7,10,8),i)]]},F={X:[[new oe(C,r),[.8,0,0],[0,0,-Math.PI/2]],[new Re(b,m),null,null,[.8,1,1]]],Y:[[new oe(C,o),[0,.8,0]],[new Re(b,p),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new oe(C,a),[0,0,.8],[Math.PI/2,0,0]],[new Re(b,g),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new oe(C,l),[.85,.85,0],null,[2,2,.2]],[new Re(b,E),[.855,.98,0],null,[.125,1,1]],[new Re(b,E),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new oe(C,u),[0,.85,.85],null,[.2,2,2]],[new Re(b,y),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Re(b,y),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new oe(C,h),[.85,0,.85],null,[2,.2,2]],[new Re(b,v),[.855,0,.98],null,[.125,1,1]],[new Re(b,v),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new oe(new wi(.125,.125,.125),c.clone()),[1.1,0,0]]],XYZY:[[new oe(new wi(.125,.125,.125),c.clone()),[0,1.1,0]]],XYZZ:[[new oe(new wi(.125,.125,.125),c.clone()),[0,0,1.1]]]},k={X:[[new oe(new wt(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new oe(new wt(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new oe(new wt(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new oe(C,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new oe(C,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new oe(C,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new oe(new wi(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new oe(new wi(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new oe(new wi(.2,.2,.2),i),[0,0,1.1]]]},$={X:[[new Re(b,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Re(b,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Re(b,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},U=N=>{const B=new Ve;for(let G in N)for(let j=N[G].length;j--;){const L=N[G][j][0].clone(),X=N[G][j][1],Q=N[G][j][2],ne=N[G][j][3],he=N[G][j][4];L.name=G,L.tag=he,X&&L.position.set(X[0],X[1],X[2]),Q&&L.rotation.set(Q[0],Q[1],Q[2]),ne&&L.scale.set(ne[0],ne[1],ne[2]),L.updateMatrix();const xe=L.geometry.clone();xe.applyMatrix4(L.matrix),L.geometry=xe,L.renderOrder=1/0,L.position.set(0,0,0),L.rotation.set(0,0,0),L.scale.set(1,1,1),B.add(L)}return B};this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=U(w)),this.add(this.gizmo.rotate=U(O)),this.add(this.gizmo.scale=U(F)),this.add(this.picker.translate=U(M)),this.add(this.picker.rotate=U(D)),this.add(this.picker.scale=U(k)),this.add(this.helper.translate=U(P)),this.add(this.helper.rotate=U(z)),this.add(this.helper.scale=U($)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}}class v2 extends oe{constructor(){super(new Qt(1e5,1e5,2,2),new On({visible:!1,wireframe:!0,side:dt,transparent:!0,opacity:.1,toneMapped:!1})),J(this,"isTransformControlsPlane",!0),J(this,"type","TransformControlsPlane"),J(this,"unitX",new _(1,0,0)),J(this,"unitY",new _(0,1,0)),J(this,"unitZ",new _(0,0,1)),J(this,"tempVector",new _),J(this,"dirVector",new _),J(this,"alignVector",new _),J(this,"tempMatrix",new re),J(this,"identityQuaternion",new ue),J(this,"cameraQuaternion",new ue),J(this,"worldPosition",new _),J(this,"worldQuaternion",new ue),J(this,"eye",new _),J(this,"axis",null),J(this,"mode","translate"),J(this,"space","world"),J(this,"updateMatrixWorld",()=>{let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),this.unitX.set(1,0,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),this.mode){case"translate":case"scale":switch(this.axis){case"X":this.alignVector.copy(this.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0);break}break;case"rotate":default:this.dirVector.set(0,0,0)}this.dirVector.length()===0?this.quaternion.copy(this.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),super.updateMatrixWorld()})}}var x2=Object.defineProperty,E2=(s,e,t)=>e in s?x2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ye=(s,e,t)=>(E2(s,typeof e!="symbol"?e+"":e,t),t);const sn=new pi(0,0,0,"YXZ"),rn=new _,A2={type:"change"},S2={type:"lock"},T2={type:"unlock"},Lc=.002,Pc=Math.PI/2;let b2=class extends Nn{constructor(e,t){super(),Ye(this,"camera"),Ye(this,"domElement"),Ye(this,"isLocked"),Ye(this,"minPolarAngle"),Ye(this,"maxPolarAngle"),Ye(this,"pointerSpeed"),Ye(this,"onMouseMove",i=>{!this.domElement||this.isLocked===!1||(sn.setFromQuaternion(this.camera.quaternion),sn.y-=i.movementX*Lc*this.pointerSpeed,sn.x-=i.movementY*Lc*this.pointerSpeed,sn.x=Math.max(Pc-this.maxPolarAngle,Math.min(Pc-this.minPolarAngle,sn.x)),this.camera.quaternion.setFromEuler(sn),this.dispatchEvent(A2))}),Ye(this,"onPointerlockChange",()=>{this.domElement&&(this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(S2),this.isLocked=!0):(this.dispatchEvent(T2),this.isLocked=!1))}),Ye(this,"onPointerlockError",()=>{console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}),Ye(this,"connect",i=>{this.domElement=i||this.domElement,this.domElement&&(this.domElement.ownerDocument.addEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this.onPointerlockError))}),Ye(this,"disconnect",()=>{this.domElement&&(this.domElement.ownerDocument.removeEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this.onPointerlockError))}),Ye(this,"dispose",()=>{this.disconnect()}),Ye(this,"getObject",()=>this.camera),Ye(this,"direction",new _(0,0,-1)),Ye(this,"getDirection",i=>i.copy(this.direction).applyQuaternion(this.camera.quaternion)),Ye(this,"moveForward",i=>{rn.setFromMatrixColumn(this.camera.matrix,0),rn.crossVectors(this.camera.up,rn),this.camera.position.addScaledVector(rn,i)}),Ye(this,"moveRight",i=>{rn.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(rn,i)}),Ye(this,"lock",()=>{this.domElement&&this.domElement.requestPointerLock()}),Ye(this,"unlock",()=>{this.domElement&&this.domElement.ownerDocument.exitPointerLock()}),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,t&&this.connect(t)}};var C2=Object.defineProperty,R2=(s,e,t)=>e in s?C2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Qe=(s,e,t)=>(R2(s,typeof e!="symbol"?e+"":e,t),t);let w2=class extends Nn{constructor(e){super(),Qe(this,"object"),Qe(this,"changeEvent",{type:"change"}),Qe(this,"EPS",1e-6),Qe(this,"enabled",!0),Qe(this,"deviceOrientation",{alpha:0,beta:0,gamma:0}),Qe(this,"screenOrientation",0),Qe(this,"alphaOffset",0),Qe(this,"onDeviceOrientationChangeEvent",t=>{this.deviceOrientation=t}),Qe(this,"onScreenOrientationChangeEvent",()=>{this.screenOrientation=window.orientation||0}),Qe(this,"zee",new _(0,0,1)),Qe(this,"euler",new pi),Qe(this,"q0",new ue),Qe(this,"q1",new ue(-Math.sqrt(.5),0,0,Math.sqrt(.5))),Qe(this,"setObjectQuaternion",(t,i,n,r,o)=>{this.euler.set(n,i,-r,"YXZ"),t.setFromEuler(this.euler),t.multiply(this.q1),t.multiply(this.q0.setFromAxisAngle(this.zee,-o))}),Qe(this,"connect",()=>{this.onScreenOrientationChangeEvent(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(t=>{t=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))}).catch(t=>{console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",t)}):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0}),Qe(this,"disconnect",()=>{window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this.enabled=!1}),Qe(this,"lastQuaternion",new ue),Qe(this,"update",()=>{if(this.enabled===!1)return;const t=this.deviceOrientation;if(t){const i=t.alpha?me.degToRad(t.alpha)+this.alphaOffset:0,n=t.beta?me.degToRad(t.beta):0,r=t.gamma?me.degToRad(t.gamma):0,o=this.screenOrientation?me.degToRad(this.screenOrientation):0;this.setObjectQuaternion(this.object.quaternion,i,n,r,o),8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(this.changeEvent))}}),Qe(this,"dispose",()=>this.disconnect()),this.object=e,this.object.rotation.reorder("YXZ"),this.connect()}};var I2=Object.defineProperty,_2=(s,e,t)=>e in s?I2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,te=(s,e,t)=>(_2(s,typeof e!="symbol"?e+"":e,t),t);let L2=class extends Nn{constructor(e,t){super(),te(this,"enabled",!0),te(this,"screen",{left:0,top:0,width:0,height:0}),te(this,"rotateSpeed",1),te(this,"zoomSpeed",1.2),te(this,"panSpeed",.3),te(this,"noRotate",!1),te(this,"noZoom",!1),te(this,"noPan",!1),te(this,"staticMoving",!1),te(this,"dynamicDampingFactor",.2),te(this,"minDistance",0),te(this,"maxDistance",1/0),te(this,"keys",["KeyA","KeyS","KeyD"]),te(this,"mouseButtons",{LEFT:Co.ROTATE,MIDDLE:Co.DOLLY,RIGHT:Co.PAN}),te(this,"object"),te(this,"domElement"),te(this,"cursorZoom",!1),te(this,"target",new _),te(this,"mousePosition",new de),te(this,"STATE",{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4}),te(this,"EPS",1e-6),te(this,"lastZoom",1),te(this,"lastPosition",new _),te(this,"cursorVector",new _),te(this,"targetVector",new _),te(this,"_state",this.STATE.NONE),te(this,"_keyState",this.STATE.NONE),te(this,"_eye",new _),te(this,"_movePrev",new de),te(this,"_moveCurr",new de),te(this,"_lastAxis",new _),te(this,"_lastAngle",0),te(this,"_zoomStart",new de),te(this,"_zoomEnd",new de),te(this,"_touchZoomDistanceStart",0),te(this,"_touchZoomDistanceEnd",0),te(this,"_panStart",new de),te(this,"_panEnd",new de),te(this,"target0"),te(this,"position0"),te(this,"up0"),te(this,"zoom0"),te(this,"changeEvent",{type:"change"}),te(this,"startEvent",{type:"start"}),te(this,"endEvent",{type:"end"}),te(this,"onScreenVector",new de),te(this,"getMouseOnScreen",(i,n)=>(this.onScreenVector.set((i-this.screen.left)/this.screen.width,(n-this.screen.top)/this.screen.height),this.onScreenVector)),te(this,"onCircleVector",new de),te(this,"getMouseOnCircle",(i,n)=>(this.onCircleVector.set((i-this.screen.width*.5-this.screen.left)/(this.screen.width*.5),(this.screen.height+2*(this.screen.top-n))/this.screen.width),this.onCircleVector)),te(this,"axis",new _),te(this,"quaternion",new ue),te(this,"eyeDirection",new _),te(this,"objectUpDirection",new _),te(this,"objectSidewaysDirection",new _),te(this,"moveDirection",new _),te(this,"angle",0),te(this,"rotateCamera",()=>{this.moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),this.angle=this.moveDirection.length(),this.angle?(this._eye.copy(this.object.position).sub(this.target),this.eyeDirection.copy(this._eye).normalize(),this.objectUpDirection.copy(this.object.up).normalize(),this.objectSidewaysDirection.crossVectors(this.objectUpDirection,this.eyeDirection).normalize(),this.objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),this.objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),this.moveDirection.copy(this.objectUpDirection.add(this.objectSidewaysDirection)),this.axis.crossVectors(this.moveDirection,this._eye).normalize(),this.angle*=this.rotateSpeed,this.quaternion.setFromAxisAngle(this.axis,this.angle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion),this._lastAxis.copy(this.axis),this._lastAngle=this.angle):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),this.quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion)),this._movePrev.copy(this._moveCurr)}),te(this,"zoomCamera",()=>{let i;if(this._state===this.STATE.TOUCH_ZOOM_PAN)i=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(i):this.object.isOrthographicCamera?(this.object.zoom/=i,this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type");else{if(i=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,Math.abs(i-1)>this.EPS&&i>0&&(this.object.isPerspectiveCamera?(i>1&&this._eye.length()>=this.maxDistance-this.EPS&&(i=1),this._eye.multiplyScalar(i)):this.object.isOrthographicCamera?(i>1&&this.object.zoom<this.maxDistance*this.maxDistance&&(i=1),this.object.zoom/=i):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor,this.cursorZoom){this.targetVector.copy(this.target).project(this.object);let n=this.cursorVector.set(this.mousePosition.x,this.mousePosition.y,this.targetVector.z).unproject(this.object);this.target.lerpVectors(n,this.target,i)}this.object.isOrthographicCamera&&this.object.updateProjectionMatrix()}}),te(this,"mouseChange",new de),te(this,"objectUp",new _),te(this,"pan",new _),te(this,"panCamera",()=>{if(this.domElement&&(this.mouseChange.copy(this._panEnd).sub(this._panStart),this.mouseChange.lengthSq()>this.EPS)){if(this.object.isOrthographicCamera){const i=this.object,n=(i.right-i.left)/this.object.zoom,r=(i.top-i.bottom)/this.object.zoom;this.mouseChange.x*=n,this.mouseChange.y*=r}else this.mouseChange.multiplyScalar(this._eye.length()*this.panSpeed);this.pan.copy(this._eye).cross(this.object.up).setLength(this.mouseChange.x),this.pan.add(this.objectUp.copy(this.object.up).setLength(this.mouseChange.y)),this.object.position.add(this.pan),this.target.add(this.pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(this.mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}),te(this,"checkDistances",()=>{(!this.noZoom||!this.noPan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}),te(this,"handleResize",()=>{if(!this.domElement)return;const i=this.domElement.getBoundingClientRect(),n=this.domElement.ownerDocument.documentElement;this.screen.left=i.left+window.pageXOffset-n.clientLeft,this.screen.top=i.top+window.pageYOffset-n.clientTop,this.screen.width=i.width,this.screen.height=i.height}),te(this,"update",()=>{this._eye.subVectors(this.object.position,this.target),this.noRotate||this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this.checkDistances(),this.object.lookAt(this.target),this.lastPosition.distanceToSquared(this.object.position)>this.EPS&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||this.lastZoom!==this.object.zoom)&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")}),te(this,"reset",()=>{this._state=this.STATE.NONE,this._keyState=this.STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom}),te(this,"keydown",i=>{this.enabled!==!1&&(window.removeEventListener("keydown",this.keydown),this._keyState===this.STATE.NONE&&(i.code===this.keys[this.STATE.ROTATE]&&!this.noRotate?this._keyState=this.STATE.ROTATE:i.code===this.keys[this.STATE.ZOOM]&&!this.noZoom?this._keyState=this.STATE.ZOOM:i.code===this.keys[this.STATE.PAN]&&!this.noPan&&(this._keyState=this.STATE.PAN)))}),te(this,"onPointerDown",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseDown(i);break}}),te(this,"onPointerMove",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseMove(i);break}}),te(this,"onPointerUp",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseUp();break}}),te(this,"keyup",()=>{this.enabled!==!1&&(this._keyState=this.STATE.NONE,window.addEventListener("keydown",this.keydown))}),te(this,"onMouseDown",i=>{if(!this.domElement)return;if(this._state===this.STATE.NONE)switch(i.button){case this.mouseButtons.LEFT:this._state=this.STATE.ROTATE;break;case this.mouseButtons.MIDDLE:this._state=this.STATE.ZOOM;break;case this.mouseButtons.RIGHT:this._state=this.STATE.PAN;break}const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY)),this._movePrev.copy(this._moveCurr)):n===this.STATE.ZOOM&&!this.noZoom?(this._zoomStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._zoomEnd.copy(this._zoomStart)):n===this.STATE.PAN&&!this.noPan&&(this._panStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._panEnd.copy(this._panStart)),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.startEvent)}),te(this,"onMouseMove",i=>{if(this.enabled===!1)return;const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY))):n===this.STATE.ZOOM&&!this.noZoom?this._zoomEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY)):n===this.STATE.PAN&&!this.noPan&&this._panEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY))}),te(this,"onMouseUp",()=>{this.domElement&&this.enabled!==!1&&(this._state=this.STATE.NONE,this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.endEvent))}),te(this,"mousewheel",i=>{if(this.enabled!==!1&&this.noZoom!==!0){switch(i.preventDefault(),i.deltaMode){case 2:this._zoomStart.y-=i.deltaY*.025;break;case 1:this._zoomStart.y-=i.deltaY*.01;break;default:this._zoomStart.y-=i.deltaY*25e-5;break}this.mousePosition.x=i.offsetX/this.screen.width*2-1,this.mousePosition.y=-(i.offsetY/this.screen.height)*2+1,this.dispatchEvent(this.startEvent),this.dispatchEvent(this.endEvent)}}),te(this,"touchstart",i=>{if(this.enabled!==!1){switch(i.preventDefault(),i.touches.length){case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this._state=this.STATE.TOUCH_ZOOM_PAN;const n=i.touches[0].pageX-i.touches[1].pageX,r=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(n*n+r*r);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(o,a)),this._panEnd.copy(this._panStart);break}this.dispatchEvent(this.startEvent)}}),te(this,"touchmove",i=>{if(this.enabled!==!1)switch(i.preventDefault(),i.touches.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY));break;default:const n=i.touches[0].pageX-i.touches[1].pageX,r=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(n*n+r*r);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(o,a));break}}),te(this,"touchend",i=>{if(this.enabled!==!1){switch(i.touches.length){case 0:this._state=this.STATE.NONE;break;case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break}this.dispatchEvent(this.endEvent)}}),te(this,"contextmenu",i=>{this.enabled!==!1&&i.preventDefault()}),te(this,"connect",i=>{i===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=i,this.domElement.addEventListener("contextmenu",this.contextmenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("wheel",this.mousewheel),this.domElement.addEventListener("touchstart",this.touchstart),this.domElement.addEventListener("touchend",this.touchend),this.domElement.addEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup),this.handleResize()}),te(this,"dispose",()=>{this.domElement&&(this.domElement.removeEventListener("contextmenu",this.contextmenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("wheel",this.mousewheel),this.domElement.removeEventListener("touchstart",this.touchstart),this.domElement.removeEventListener("touchend",this.touchend),this.domElement.removeEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup))}),this.object=e,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,t!==void 0&&this.connect(t),this.update()}};var P2=Object.defineProperty,M2=(s,e,t)=>e in s?P2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,W=(s,e,t)=>(M2(s,typeof e!="symbol"?e+"":e,t),t);const le={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},_e={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},ve={x:0,y:0},Ct={camera:new re,gizmos:new re},Ne={type:"change"},kt={type:"start"},Lt={type:"end"};let D2=class extends Nn{constructor(e,t=null,i=null){super(),W(this,"camera"),W(this,"domElement"),W(this,"scene"),W(this,"mouseActions"),W(this,"_mouseOp"),W(this,"_v2_1"),W(this,"_v3_1"),W(this,"_v3_2"),W(this,"_m4_1"),W(this,"_m4_2"),W(this,"_quat"),W(this,"_translationMatrix"),W(this,"_rotationMatrix"),W(this,"_scaleMatrix"),W(this,"_rotationAxis"),W(this,"_cameraMatrixState"),W(this,"_cameraProjectionState"),W(this,"_fovState"),W(this,"_upState"),W(this,"_zoomState"),W(this,"_nearPos"),W(this,"_farPos"),W(this,"_gizmoMatrixState"),W(this,"_up0"),W(this,"_zoom0"),W(this,"_fov0"),W(this,"_initialNear"),W(this,"_nearPos0"),W(this,"_initialFar"),W(this,"_farPos0"),W(this,"_cameraMatrixState0"),W(this,"_gizmoMatrixState0"),W(this,"_button"),W(this,"_touchStart"),W(this,"_touchCurrent"),W(this,"_input"),W(this,"_switchSensibility"),W(this,"_startFingerDistance"),W(this,"_currentFingerDistance"),W(this,"_startFingerRotation"),W(this,"_currentFingerRotation"),W(this,"_devPxRatio"),W(this,"_downValid"),W(this,"_nclicks"),W(this,"_downEvents"),W(this,"_clickStart"),W(this,"_maxDownTime"),W(this,"_maxInterval"),W(this,"_posThreshold"),W(this,"_movementThreshold"),W(this,"_currentCursorPosition"),W(this,"_startCursorPosition"),W(this,"_grid"),W(this,"_gridPosition"),W(this,"_gizmos"),W(this,"_curvePts"),W(this,"_timeStart"),W(this,"_animationId"),W(this,"focusAnimationTime"),W(this,"_timePrev"),W(this,"_timeCurrent"),W(this,"_anglePrev"),W(this,"_angleCurrent"),W(this,"_cursorPosPrev"),W(this,"_cursorPosCurr"),W(this,"_wPrev"),W(this,"_wCurr"),W(this,"adjustNearFar"),W(this,"scaleFactor"),W(this,"dampingFactor"),W(this,"wMax"),W(this,"enableAnimations"),W(this,"enableGrid"),W(this,"cursorZoom"),W(this,"minFov"),W(this,"maxFov"),W(this,"enabled"),W(this,"enablePan"),W(this,"enableRotate"),W(this,"enableZoom"),W(this,"minDistance"),W(this,"maxDistance"),W(this,"minZoom"),W(this,"maxZoom"),W(this,"target"),W(this,"_currentTarget"),W(this,"_tbRadius"),W(this,"_state"),W(this,"onWindowResize",()=>{const n=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;if(this.camera){const l=this.calculateTbRadius(this.camera);l!==void 0&&(this._tbRadius=l)}const r=this._tbRadius/n,a=new Ro(0,0,r,r).getPoints(this._curvePts),c=new Zt().setFromPoints(a);for(const l in this._gizmos.children){const u=this._gizmos.children[l];u.geometry=c}this.dispatchEvent(Ne)}),W(this,"onContextMenu",n=>{if(this.enabled){for(let r=0;r<this.mouseActions.length;r++)if(this.mouseActions[r].mouse==2){n.preventDefault();break}}}),W(this,"onPointerCancel",()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=_e.NONE}),W(this,"onPointerDown",n=>{if(n.button==0&&n.isPrimary?(this._downValid=!0,this._downEvents.push(n)):this._downValid=!1,n.pointerType=="touch"&&this._input!=_e.CURSOR)switch(this._touchStart.push(n),this._touchCurrent.push(n),this._input){case _e.NONE:this._input=_e.ONE_FINGER,this.onSinglePanStart(n,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case _e.ONE_FINGER:case _e.ONE_FINGER_SWITCHED:this._input=_e.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case _e.TWO_FINGER:this._input=_e.MULT_FINGER,this.onTriplePanStart();break}else if(n.pointerType!="touch"&&this._input==_e.NONE){let r=null;n.ctrlKey||n.metaKey?r="CTRL":n.shiftKey&&(r="SHIFT"),this._mouseOp=this.getOpFromAction(n.button,r),this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=_e.CURSOR,this._button=n.button,this.onSinglePanStart(n,this._mouseOp))}}),W(this,"onPointerMove",n=>{if(n.pointerType=="touch"&&this._input!=_e.CURSOR)switch(this._input){case _e.ONE_FINGER:this.updateTouchEvent(n),this.onSinglePanMove(n,le.ROTATE);break;case _e.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],n)*this._devPxRatio>=this._switchSensibility){this._input=_e.ONE_FINGER,this.updateTouchEvent(n),this.onSinglePanStart(n,"ROTATE");break}break;case _e.TWO_FINGER:this.updateTouchEvent(n),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case _e.MULT_FINGER:this.updateTouchEvent(n),this.onTriplePanMove();break}else if(n.pointerType!="touch"&&this._input==_e.CURSOR){let r=null;n.ctrlKey||n.metaKey?r="CTRL":n.shiftKey&&(r="SHIFT");const o=this.getOpStateFromAction(this._button,r);o&&this.onSinglePanMove(n,o)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],n)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}),W(this,"onPointerUp",n=>{if(n.pointerType=="touch"&&this._input!=_e.CURSOR){const r=this._touchCurrent.length;for(let o=0;o<r;o++)if(this._touchCurrent[o].pointerId==n.pointerId){this._touchCurrent.splice(o,1),this._touchStart.splice(o,1);break}switch(this._input){case _e.ONE_FINGER:case _e.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=_e.NONE,this.onSinglePanEnd();break;case _e.TWO_FINGER:this.onDoublePanEnd(),this.onPinchEnd(),this.onRotateEnd(),this._input=_e.ONE_FINGER_SWITCHED;break;case _e.MULT_FINGER:this._touchCurrent.length==0&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=_e.NONE,this.onTriplePanEnd());break}}else n.pointerType!="touch"&&this._input==_e.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=_e.NONE,this.onSinglePanEnd(),this._button=-1);if(n.isPrimary)if(this._downValid)if(n.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(this._nclicks==0)this._nclicks=1,this._clickStart=performance.now();else{const o=n.timeStamp-this._clickStart,a=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;o<=this._maxInterval&&a<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(n)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length);else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}),W(this,"onWheel",n=>{var r,o;if(this.enabled&&this.enableZoom&&this.domElement){let a=null;n.ctrlKey||n.metaKey?a="CTRL":n.shiftKey&&(a="SHIFT");const c=this.getOpFromAction("WHEEL",a);if(c){n.preventDefault(),this.dispatchEvent(kt);const l=125;let u=n.deltaY/l,h=1;switch(u>0?h=1/this.scaleFactor:u<0&&(h=this.scaleFactor),c){case"ZOOM":if(this.updateTbState(le.SCALE,!0),u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u)),this.cursorZoom&&this.enablePan){let f;this.camera instanceof rt&&(f=(r=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:r.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position)),this.camera instanceof He&&(f=(o=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:o.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),f!==void 0&&this.applyTransformMatrix(this.applyScale(h,f))}else this.applyTransformMatrix(this.applyScale(h,this._gizmos.position));this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(le.IDLE,!1),this.dispatchEvent(Ne),this.dispatchEvent(Lt);break;case"FOV":if(this.camera instanceof He){this.updateTbState(le.FOV,!0),n.deltaX!=0&&(u=n.deltaX/l,h=1,u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const f=this._v3_1.distanceTo(this._gizmos.position);let m=f/h;m=me.clamp(m,this.minDistance,this.maxDistance);const p=f*Math.tan(me.DEG2RAD*this.camera.fov*.5);let g=me.RAD2DEG*(Math.atan(p/m)*2);g>this.maxFov?g=this.maxFov:g<this.minFov&&(g=this.minFov);const y=p/Math.tan(me.DEG2RAD*(g/2));h=f/y,this.setFov(g),this.applyTransformMatrix(this.applyScale(h,this._gizmos.position,!1))}this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(le.IDLE,!1),this.dispatchEvent(Ne),this.dispatchEvent(Lt);break}}}}),W(this,"onSinglePanStart",(n,r)=>{if(this.enabled&&this.domElement)switch(this.dispatchEvent(kt),this.setCenter(n.clientX,n.clientY),r){case"PAN":if(!this.enablePan)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(Ne)),this.camera){this.updateTbState(le.PAN,!0);const o=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement);o!==void 0&&this._startCursorPosition.copy(o),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(Ne))}break;case"ROTATE":if(!this.enableRotate)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.camera){this.updateTbState(le.ROTATE,!0);const o=this.unprojectOnTbSurface(this.camera,ve.x,ve.y,this.domElement,this._tbRadius);o!==void 0&&this._startCursorPosition.copy(o),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr)}this.dispatchEvent(Ne);break;case"FOV":if(!this.enableZoom)return;this.camera instanceof He&&(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(Ne)),this.updateTbState(le.FOV,!0),this._startCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":if(!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(Ne)),this.updateTbState(le.SCALE,!0),this._startCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break}}),W(this,"onSinglePanMove",(n,r)=>{if(this.enabled&&this.domElement){const o=r!=this._state;switch(this.setCenter(n.clientX,n.clientY),r){case le.PAN:if(this.enablePan&&this.camera)if(o){this.dispatchEvent(Lt),this.dispatchEvent(kt),this.updateTbState(r,!0);const a=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)}else{const a=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement);a!==void 0&&this._currentCursorPosition.copy(a),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))}break;case le.ROTATE:if(this.enableRotate&&this.camera)if(o){this.dispatchEvent(Lt),this.dispatchEvent(kt),this.updateTbState(r,!0);const a=this.unprojectOnTbSurface(this.camera,ve.x,ve.y,this.domElement,this._tbRadius);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)}else{const a=this.unprojectOnTbSurface(this.camera,ve.x,ve.y,this.domElement,this._tbRadius);a!==void 0&&this._currentCursorPosition.copy(a);const c=this._startCursorPosition.distanceTo(this._currentCursorPosition),l=this._startCursorPosition.angleTo(this._currentCursorPosition),u=Math.max(c/this._tbRadius,l);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),u)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=u,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case le.SCALE:if(this.enableZoom)if(o)this.dispatchEvent(Lt),this.dispatchEvent(kt),this.updateTbState(r,!0),this._startCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5);const c=this._currentCursorPosition.y-this._startCursorPosition.y;let l=1;c<0?l=1/Math.pow(this.scaleFactor,-c*8):c>0&&(l=Math.pow(this.scaleFactor,c*8)),this.applyTransformMatrix(this.applyScale(l,this._gizmos.position))}break;case le.FOV:if(this.enableZoom&&this.camera instanceof He)if(o)this.dispatchEvent(Lt),this.dispatchEvent(kt),this.updateTbState(r,!0),this._startCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5);const c=this._currentCursorPosition.y-this._startCursorPosition.y;let l=1;c<0?l=1/Math.pow(this.scaleFactor,-c*8):c>0&&(l=Math.pow(this.scaleFactor,c*8)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/l;h=me.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(me.DEG2RAD*this._fovState*.5);let m=me.RAD2DEG*(Math.atan(f/h)*2);m=me.clamp(m,this.minFov,this.maxFov);const p=f/Math.tan(me.DEG2RAD*(m/2));l=u/p,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(m),this.applyTransformMatrix(this.applyScale(l,this._v3_2,!1));const g=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(p/u);this._m4_1.makeTranslation(g.x,g.y,g.z)}break}this.dispatchEvent(Ne)}}),W(this,"onSinglePanEnd",()=>{if(this._state==le.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const r=Math.abs((this._wPrev+this._wCurr)/2),o=this;this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(le.ANIMATION_ROTATE,!0);const c=o.calculateRotationAxis(o._cursorPosPrev,o._cursorPosCurr);o.onRotationAnim(a,c,Math.min(r,o.wMax))})}else this.updateTbState(le.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Ne);else this.updateTbState(le.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Ne)}else(this._state==le.PAN||this._state==le.IDLE)&&(this.updateTbState(le.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(Ne));this.dispatchEvent(Lt)}),W(this,"onDoubleTap",n=>{if(this.enabled&&this.enablePan&&this.scene&&this.camera&&this.domElement){this.dispatchEvent(kt),this.setCenter(n.clientX,n.clientY);const r=this.unprojectOnObj(this.getCursorNDC(ve.x,ve.y,this.domElement),this.camera);if(r&&this.enableAnimations){const o=this;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(le.ANIMATION_FOCUS,!0),o.onFocusAnim(a,r,o._cameraMatrixState,o._gizmoMatrixState)})}else r&&!this.enableAnimations&&(this.updateTbState(le.FOCUS,!0),this.focus(r,this.scaleFactor),this.updateTbState(le.IDLE,!1),this.dispatchEvent(Ne))}this.dispatchEvent(Lt)}),W(this,"onDoublePanStart",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.dispatchEvent(kt),this.updateTbState(le.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const n=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement,!0);n!==void 0&&this._startCursorPosition.copy(n),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1)}}),W(this,"onDoublePanMove",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=le.PAN&&(this.updateTbState(le.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition));const n=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement,!0);n!==void 0&&this._currentCursorPosition.copy(n),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(Ne)}}),W(this,"onDoublePanEnd",()=>{this.updateTbState(le.IDLE,!1),this.dispatchEvent(Lt)}),W(this,"onRotateStart",()=>{var n;this.enabled&&this.enableRotate&&(this.dispatchEvent(kt),this.updateTbState(le.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,(n=this.camera)==null||n.getWorldDirection(this._rotationAxis),!this.enablePan&&!this.enableZoom&&this.activateGizmos(!0))}),W(this,"onRotateMove",()=>{var n;if(this.enabled&&this.enableRotate&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let r;this._state!=le.ZROTATE&&(this.updateTbState(le.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?this.camera&&(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),r=(n=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):r=new _().setFromMatrixPosition(this._gizmoMatrixState);const o=me.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);r!==void 0&&this.applyTransformMatrix(this.zRotate(r,o)),this.dispatchEvent(Ne)}}),W(this,"onRotateEnd",()=>{this.updateTbState(le.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Lt)}),W(this,"onPinchStart",()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(kt),this.updateTbState(le.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))}),W(this,"onPinchMove",()=>{var n,r;if(this.enabled&&this.enableZoom&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const o=12;this._state!=le.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(le.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),o*this._devPxRatio);const a=this._currentFingerDistance/this._startFingerDistance;let c;this.enablePan?this.camera instanceof rt?c=(n=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera instanceof He&&(c=(r=this.unprojectOnTbPlane(this.camera,ve.x,ve.y,this.domElement))==null?void 0:r.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):c=this._gizmos.position,c!==void 0&&this.applyTransformMatrix(this.applyScale(a,c)),this.dispatchEvent(Ne)}}),W(this,"onPinchEnd",()=>{this.updateTbState(le.IDLE,!1),this.dispatchEvent(Lt)}),W(this,"onTriplePanStart",()=>{if(this.enabled&&this.enableZoom&&this.domElement){this.dispatchEvent(kt),this.updateTbState(le.SCALE,!0);let n=0,r=0;const o=this._touchCurrent.length;for(let a=0;a<o;a++)n+=this._touchCurrent[a].clientX,r+=this._touchCurrent[a].clientY;this.setCenter(n/o,r/o),this._startCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition)}}),W(this,"onTriplePanMove",()=>{if(this.enabled&&this.enableZoom&&this.camera&&this.domElement){let n=0,r=0;const o=this._touchCurrent.length;for(let y=0;y<o;y++)n+=this._touchCurrent[y].clientX,r+=this._touchCurrent[y].clientY;this.setCenter(n/o,r/o);const a=8;this._currentCursorPosition.setY(this.getCursorNDC(ve.x,ve.y,this.domElement).y*.5);const c=this._currentCursorPosition.y-this._startCursorPosition.y;let l=1;c<0?l=1/Math.pow(this.scaleFactor,-c*a):c>0&&(l=Math.pow(this.scaleFactor,c*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/l;h=me.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(me.DEG2RAD*this._fovState*.5);let m=me.RAD2DEG*(Math.atan(f/h)*2);m=me.clamp(m,this.minFov,this.maxFov);const p=f/Math.tan(me.DEG2RAD*(m/2));l=u/p,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(m),this.applyTransformMatrix(this.applyScale(l,this._v3_2,!1));const g=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(p/u);this._m4_1.makeTranslation(g.x,g.y,g.z),this.dispatchEvent(Ne)}}),W(this,"onTriplePanEnd",()=>{this.updateTbState(le.IDLE,!1),this.dispatchEvent(Lt)}),W(this,"setCenter",(n,r)=>{ve.x=n,ve.y=r}),W(this,"initializeMouseActions",()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")}),W(this,"setMouseAction",(n,r,o=null)=>{const a=["PAN","ROTATE","ZOOM","FOV"],c=[0,1,2,"WHEEL"],l=["CTRL","SHIFT",null];let u;if(!a.includes(n)||!c.includes(r)||!l.includes(o)||r=="WHEEL"&&n!="ZOOM"&&n!="FOV")return!1;switch(n){case"PAN":u=le.PAN;break;case"ROTATE":u=le.ROTATE;break;case"ZOOM":u=le.SCALE;break;case"FOV":u=le.FOV;break}const h={operation:n,mouse:r,key:o,state:u};for(let f=0;f<this.mouseActions.length;f++)if(this.mouseActions[f].mouse==h.mouse&&this.mouseActions[f].key==h.key)return this.mouseActions.splice(f,1,h),!0;return this.mouseActions.push(h),!0}),W(this,"getOpFromAction",(n,r)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==r)return o.operation;if(r){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.operation}return null}),W(this,"getOpStateFromAction",(n,r)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==r)return o.state;if(r){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.state}return null}),W(this,"getAngle",(n,r)=>Math.atan2(r.clientY-n.clientY,r.clientX-n.clientX)*180/Math.PI),W(this,"updateTouchEvent",n=>{for(let r=0;r<this._touchCurrent.length;r++)if(this._touchCurrent[r].pointerId==n.pointerId){this._touchCurrent.splice(r,1,n);break}}),W(this,"calculateAngularSpeed",(n,r,o,a)=>{const c=r-n,l=(a-o)/1e3;return l==0?0:c/l}),W(this,"calculatePointersDistance",(n,r)=>Math.sqrt(Math.pow(r.clientX-n.clientX,2)+Math.pow(r.clientY-n.clientY,2))),W(this,"calculateRotationAxis",(n,r)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(n,r).applyQuaternion(this._quat),this._rotationAxis.normalize().clone())),W(this,"calculateTbRadius",n=>{const o=n.position.distanceTo(this._gizmos.position);if(n instanceof He){const a=me.DEG2RAD*n.fov*.5,c=Math.atan(n.aspect*Math.tan(a));return Math.tan(Math.min(a,c))*o*.67}else if(n instanceof rt)return Math.min(n.top,n.right)*.67}),W(this,"focus",(n,r,o=1)=>{if(this.camera){const a=n.clone();a.sub(this._gizmos.position).multiplyScalar(o),this._translationMatrix.makeTranslation(a.x,a.y,a.z);const c=this._gizmoMatrixState.clone();this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale);const l=this._cameraMatrixState.clone();this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.applyScale(r,this._gizmos.position)),this._gizmoMatrixState.copy(c),this._cameraMatrixState.copy(l)}}),W(this,"drawGrid",()=>{if(this.scene){let o,a,c,l;if(this.camera instanceof rt){const u=this.camera.right-this.camera.left,h=this.camera.bottom-this.camera.top;c=Math.max(u,h),l=c/20,o=c/this.camera.zoom*3,a=o/l*this.camera.zoom}else if(this.camera instanceof He){const u=this.camera.position.distanceTo(this._gizmos.position),h=me.DEG2RAD*this.camera.fov*.5,f=Math.atan(this.camera.aspect*Math.tan(h));c=Math.tan(Math.max(h,f))*u*2,l=c/20,o=c*3,a=o/l}this._grid==null&&this.camera&&(this._grid=new Hg(o,a,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(Math.PI*.5),this.scene.add(this._grid))}}),W(this,"connect",n=>{n===document&&console.error('THREE.ArcballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.style.touchAction="none",this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),this.domElement.addEventListener("wheel",this.onWheel)}),W(this,"dispose",()=>{var n,r,o,a,c;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(r=this.domElement)==null||r.removeEventListener("pointercancel",this.onPointerCancel),(o=this.domElement)==null||o.removeEventListener("wheel",this.onWheel),(a=this.domElement)==null||a.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),(c=this.scene)==null||c.remove(this._gizmos),this.disposeGrid()}),W(this,"disposeGrid",()=>{this._grid&&this.scene&&(this.scene.remove(this._grid),this._grid=null)}),W(this,"easeOutCubic",n=>1-Math.pow(1-n,3)),W(this,"activateGizmos",n=>{for(const r of this._gizmos.children)r.material.setValues({opacity:n?1:.6})}),W(this,"getCursorNDC",(n,r,o)=>{const a=o.getBoundingClientRect();return this._v2_1.setX((n-a.left)/a.width*2-1),this._v2_1.setY((a.bottom-r)/a.height*2-1),this._v2_1.clone()}),W(this,"getCursorPosition",(n,r,o)=>(this._v2_1.copy(this.getCursorNDC(n,r,o)),this.camera instanceof rt&&(this._v2_1.x*=(this.camera.right-this.camera.left)*.5,this._v2_1.y*=(this.camera.top-this.camera.bottom)*.5),this._v2_1.clone())),W(this,"setCamera",n=>{if(n){n.lookAt(this.target),n.updateMatrix(),n instanceof He&&(this._fov0=n.fov,this._fovState=n.fov),this._cameraMatrixState0.copy(n.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(n.projectionMatrix),this._zoom0=n.zoom,this._zoomState=this._zoom0,this._initialNear=n.near,this._nearPos0=n.position.distanceTo(this.target)-n.near,this._nearPos=this._initialNear,this._initialFar=n.far,this._farPos0=n.position.distanceTo(this.target)-n.far,this._farPos=this._initialFar,this._up0.copy(n.up),this._upState.copy(n.up),this.camera=n,this.camera.updateProjectionMatrix();const r=this.calculateTbRadius(n);r!==void 0&&(this._tbRadius=r),this.makeGizmos(this.target,this._tbRadius)}}),W(this,"makeGizmos",(n,r)=>{const a=new Ro(0,0,r,r).getPoints(this._curvePts),c=new Zt().setFromPoints(a),l=new xr({color:16744576,fog:!1,transparent:!0,opacity:.6}),u=new xr({color:8454016,fog:!1,transparent:!0,opacity:.6}),h=new xr({color:8421631,fog:!1,transparent:!0,opacity:.6}),f=new Re(c,l),m=new Re(c,u),p=new Re(c,h),g=Math.PI*.5;if(f.rotation.x=g,m.rotation.y=g,this._gizmoMatrixState0.identity().setPosition(n),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera&&this.camera.zoom!=1){const y=1/this.camera.zoom;this._scaleMatrix.makeScale(y,y,y),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(n.x,n.y,n.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.clear(),this._gizmos.add(f),this._gizmos.add(m),this._gizmos.add(p)}),W(this,"onFocusAnim",(n,r,o,a)=>{if(this._timeStart==-1&&(this._timeStart=n),this._state==le.ANIMATION_FOCUS){const l=(n-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(a),l>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(r,this.scaleFactor),this._timeStart=-1,this.updateTbState(le.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Ne);else{const u=this.easeOutCubic(l),h=1-u+this.scaleFactor*u;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(r,h,u),this.dispatchEvent(Ne);const f=this;this._animationId=window.requestAnimationFrame(function(m){f.onFocusAnim(m,r,o,a.clone())})}}else this._animationId=-1,this._timeStart=-1}),W(this,"onRotationAnim",(n,r,o)=>{if(this._timeStart==-1&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=n),this._state==le.ANIMATION_ROTATE){const a=(n-this._timeStart)/1e3;if(o+-this.dampingFactor*a>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(a,2)+o*a+0,this.applyTransformMatrix(this.rotate(r,this._angleCurrent)),this.dispatchEvent(Ne);const l=this;this._animationId=window.requestAnimationFrame(function(u){l.onRotationAnim(u,r,o)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(le.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Ne)}else this._animationId=-1,this._timeStart=-1,this._state!=le.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(Ne))}),W(this,"pan",(n,r,o=!1)=>{if(this.camera){const a=n.clone().sub(r);if(this.camera instanceof rt&&a.multiplyScalar(1/this.camera.zoom),this.camera instanceof He&&o){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const c=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);a.multiplyScalar(1/c)}this._v3_1.set(a.x,a.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1)}return Ct}),W(this,"reset",()=>{if(this.camera){this.camera.zoom=this._zoom0,this.camera instanceof He&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix();const n=this.calculateTbRadius(this.camera);n!==void 0&&(this._tbRadius=n),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(le.IDLE,!1),this.dispatchEvent(Ne)}}),W(this,"rotate",(n,r)=>{const o=this._gizmos.position;return this._translationMatrix.makeTranslation(-o.x,-o.y,-o.z),this._rotationMatrix.makeRotationAxis(n,-r),this._m4_1.makeTranslation(o.x,o.y,o.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),Ct}),W(this,"copyState",()=>{if(this.camera){const n=JSON.stringify(this.camera instanceof rt?{arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}:{arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}});navigator.clipboard.writeText(n)}}),W(this,"pasteState",()=>{const n=this;navigator.clipboard.readText().then(function(o){n.setStateFromJSON(o)})}),W(this,"saveState",()=>{this.camera&&(this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera instanceof He&&(this._fov0=this.camera.fov))}),W(this,"applyScale",(n,r,o=!0)=>{if(!this.camera)return;const a=r.clone();let c=1/n;if(this.camera instanceof rt){this.camera.zoom=this._zoomState,this.camera.zoom*=n,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,c=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,c=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(c,c,c),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),a.sub(this._v3_1);const l=a.clone().multiplyScalar(c);return a.sub(l),this._m4_1.makeTranslation(a.x,a.y,a.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),Ct}if(this.camera instanceof He){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let l=this._v3_1.distanceTo(a),u=l-l*c;const h=l-u;h<this.minDistance?(c=this.minDistance/l,u=l-l*c):h>this.maxDistance&&(c=this.maxDistance/l,u=l-l*c);let f=a.clone().sub(this._v3_1).normalize().multiplyScalar(u);if(this._m4_1.makeTranslation(f.x,f.y,f.z),o){const m=this._v3_2;l=m.distanceTo(a),u=l-l*c,f=a.clone().sub(this._v3_2).normalize().multiplyScalar(u),this._translationMatrix.makeTranslation(m.x,m.y,m.z),this._scaleMatrix.makeScale(c,c,c),this._m4_2.makeTranslation(f.x,f.y,f.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-m.x,-m.y,-m.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return Ct}}),W(this,"setFov",n=>{this.camera instanceof He&&(this.camera.fov=me.clamp(n,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())}),W(this,"setTarget",(n,r,o)=>{if(this.camera){this.target.set(n,r,o),this._gizmos.position.set(n,r,o);const a=this.calculateTbRadius(this.camera);a!==void 0&&(this._tbRadius=a),this.makeGizmos(this.target,this._tbRadius),this.camera.lookAt(this.target)}}),W(this,"zRotate",(n,r)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,r),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._m4_1.makeTranslation(n.x,n.y,n.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(n),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,r),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),Ct)),W(this,"unprojectOnObj",(n,r)=>{if(!this.scene)return null;const o=new Fi;o.near=r.near,o.far=r.far,o.setFromCamera(n,r);const a=o.intersectObjects(this.scene.children,!0);for(let c=0;c<a.length;c++)if(a[c].object.uuid!=this._gizmos.uuid&&a[c].face)return a[c].point.clone();return null}),W(this,"unprojectOnTbSurface",(n,r,o,a,c)=>{if(n instanceof rt){this._v2_1.copy(this.getCursorPosition(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const l=Math.pow(this._v2_1.x,2),u=Math.pow(this._v2_1.y,2),h=Math.pow(this._tbRadius,2);return l+u<=h*.5?this._v3_1.setZ(Math.sqrt(h-(l+u))):this._v3_1.setZ(h*.5/Math.sqrt(l+u)),this._v3_1}if(n instanceof He){this._v2_1.copy(this.getCursorNDC(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const l=this._v3_1.clone().normalize(),u=n.position.distanceTo(this._gizmos.position),h=Math.pow(c,2),f=this._v3_1.z,m=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(m==0)return l.set(this._v3_1.x,this._v3_1.y,c),l;const p=f/m,g=u;let y=Math.pow(p,2)+1,v=2*p*g,E=Math.pow(g,2)-h,x=Math.pow(v,2)-4*y*E;if(x>=0&&(this._v2_1.setX((-v-Math.sqrt(x))/(2*y)),this._v2_1.setY(p*this._v2_1.x+g),me.RAD2DEG*this._v2_1.angle()>=45)){const C=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return l.multiplyScalar(C),l.z+=u,l}y=p,v=g,E=-h*.5,x=Math.pow(v,2)-4*y*E,this._v2_1.setX((-v-Math.sqrt(x))/(2*y)),this._v2_1.setY(p*this._v2_1.x+g);const T=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return l.multiplyScalar(T),l.z+=u,l}}),W(this,"unprojectOnTbPlane",(n,r,o,a,c=!1)=>{if(n instanceof rt)return this._v2_1.copy(this.getCursorPosition(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(n instanceof He){this._v2_1.copy(this.getCursorNDC(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const l=this._v3_1.clone().normalize(),u=this._v3_1.z,h=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let f;if(c?f=this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):f=n.position.distanceTo(this._gizmos.position),h==0)return l.set(0,0,0),l;const m=u/h,p=f,g=-p/m,y=Math.sqrt(Math.pow(p,2)+Math.pow(g,2));return l.multiplyScalar(y),l.z=0,l}}),W(this,"updateMatrixState",()=>{this.camera&&(this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera instanceof rt&&(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom),this.camera instanceof He&&(this._fovState=this.camera.fov))}),W(this,"updateTbState",(n,r)=>{this._state=n,r&&this.updateMatrixState()}),W(this,"update",()=>{if(!this.target.equals(this._currentTarget)&&this.camera){this._gizmos.position.set(this.target.x,this.target.y,this.target.z);const r=this.calculateTbRadius(this.camera);r!==void 0&&(this._tbRadius=r),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)}if(this.camera){if(this.camera instanceof rt&&(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)){const r=me.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.applyScale(r/this.camera.zoom,this._gizmos.position,!0))}if(this.camera instanceof He){const r=this.camera.position.distanceTo(this._gizmos.position);if(r>this.maxDistance+1e-6||r<this.minDistance-1e-6){const c=me.clamp(r,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.applyScale(c/r,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=me.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const o=this._tbRadius,a=this.calculateTbRadius(this.camera);if(a!==void 0&&(this._tbRadius=a),o<this._tbRadius-1e-6||o>this._tbRadius+1e-6){const c=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,l=this._tbRadius/c,h=new Ro(0,0,l,l).getPoints(this._curvePts),f=new Zt().setFromPoints(h);for(const m in this._gizmos.children){const p=this._gizmos.children[m];p.geometry=f}}}this.camera.lookAt(this._gizmos.position)}}),W(this,"setStateFromJSON",n=>{const r=JSON.parse(n);if(r.arcballState&&this.camera){this._cameraMatrixState.fromArray(r.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(r.arcballState.cameraUp),this.camera.near=r.arcballState.cameraNear,this.camera.far=r.arcballState.cameraFar,this.camera.zoom=r.arcballState.cameraZoom,this.camera instanceof He&&(this.camera.fov=r.arcballState.cameraFov),this._gizmoMatrixState.fromArray(r.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix();const o=this.calculateTbRadius(this.camera);o!==void 0&&(this._tbRadius=o);const a=new re().copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(a),this.camera.lookAt(this._gizmos.position),this.updateTbState(le.IDLE,!1),this.dispatchEvent(Ne)}}),this.camera=null,this.domElement=t,this.scene=i,this.mouseActions=[],this._mouseOp=null,this._v2_1=new de,this._v3_1=new _,this._v3_2=new _,this._m4_1=new re,this._m4_2=new re,this._quat=new ue,this._translationMatrix=new re,this._rotationMatrix=new re,this._scaleMatrix=new re,this._rotationAxis=new _,this._cameraMatrixState=new re,this._cameraProjectionState=new re,this._fovState=1,this._upState=new _,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new re,this._up0=new _,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new re,this._gizmoMatrixState0=new re,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=_e.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new _,this._startCursorPosition=new _,this._grid=null,this._gridPosition=new _,this._gizmos=new Al,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new _,this._cursorPosCurr=new _,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.target=new _(0,0,0),this._currentTarget=new _(0,0,0),this._tbRadius=1,this._state=le.IDLE,this.setCamera(e),this.scene&&this.scene.add(this._gizmos),this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement&&this.connect(this.domElement),window.addEventListener("resize",this.onWindowResize)}applyTransformMatrix(e){if(e?.camera&&this.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(e.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),(this._state==le.ROTATE||this._state==le.ZROTATE||this._state==le.ANIMATION_ROTATE)&&this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),e?.gizmos&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(e.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),(this._state==le.SCALE||this._state==le.FOCUS||this._state==le.ANIMATION_FOCUS)&&this.camera){const t=this.calculateTbRadius(this.camera);if(t!==void 0&&(this._tbRadius=t),this.adjustNearFar){const i=this.camera.position.distanceTo(this._gizmos.position),n=new gi;n.setFromObject(this._gizmos);const r=new yi;n.getBoundingSphere(r);const o=Math.max(this._nearPos0,r.radius+r.center.length()),a=i-this._initialNear,c=Math.min(o,a);this.camera.near=i-c;const l=Math.min(this._farPos0,-r.radius+r.center.length()),u=i-this._initialFar,h=Math.min(l,u);this.camera.far=i-h,this.camera.updateProjectionMatrix()}else{let i=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,i=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,i=!0),i&&this.camera.updateProjectionMatrix()}}}setGizmosVisible(e){this._gizmos.visible=e,this.dispatchEvent(Ne)}setTransformationMatrices(e=null,t=null){e?Ct.camera?Ct.camera.copy(e):Ct.camera=e.clone():Ct.camera=null,t?Ct.gizmos?Ct.gizmos.copy(t):Ct.gizmos=t.clone():Ct.gizmos=null}};var B2=Object.defineProperty,F2=(s,e,t)=>e in s?B2(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Be=(s,e,t)=>(F2(s,typeof e!="symbol"?e+"":e,t),t);function Mc(s){s.preventDefault()}let k2=class extends Nn{constructor(e,t){super(),Be(this,"object"),Be(this,"domElement",null),Be(this,"movementSpeed",1),Be(this,"rollSpeed",.005),Be(this,"dragToLook",!1),Be(this,"autoForward",!1),Be(this,"changeEvent",{type:"change"}),Be(this,"EPS",1e-6),Be(this,"tmpQuaternion",new ue),Be(this,"mouseStatus",0),Be(this,"movementSpeedMultiplier",1),Be(this,"moveState",{up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}),Be(this,"moveVector",new _(0,0,0)),Be(this,"rotationVector",new _(0,0,0)),Be(this,"keydown",i=>{if(!i.altKey){switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this.moveState.forward=1;break;case"KeyS":this.moveState.back=1;break;case"KeyA":this.moveState.left=1;break;case"KeyD":this.moveState.right=1;break;case"KeyR":this.moveState.up=1;break;case"KeyF":this.moveState.down=1;break;case"ArrowUp":this.moveState.pitchUp=1;break;case"ArrowDown":this.moveState.pitchDown=1;break;case"ArrowLeft":this.moveState.yawLeft=1;break;case"ArrowRight":this.moveState.yawRight=1;break;case"KeyQ":this.moveState.rollLeft=1;break;case"KeyE":this.moveState.rollRight=1;break}this.updateMovementVector(),this.updateRotationVector()}}),Be(this,"keyup",i=>{switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this.moveState.forward=0;break;case"KeyS":this.moveState.back=0;break;case"KeyA":this.moveState.left=0;break;case"KeyD":this.moveState.right=0;break;case"KeyR":this.moveState.up=0;break;case"KeyF":this.moveState.down=0;break;case"ArrowUp":this.moveState.pitchUp=0;break;case"ArrowDown":this.moveState.pitchDown=0;break;case"ArrowLeft":this.moveState.yawLeft=0;break;case"ArrowRight":this.moveState.yawRight=0;break;case"KeyQ":this.moveState.rollLeft=0;break;case"KeyE":this.moveState.rollRight=0;break}this.updateMovementVector(),this.updateRotationVector()}),Be(this,"pointerdown",i=>{if(this.dragToLook)this.mouseStatus++;else{switch(i.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1;break}this.updateMovementVector()}}),Be(this,"pointermove",i=>{if(!this.dragToLook||this.mouseStatus>0){const n=this.getContainerDimensions(),r=n.size[0]/2,o=n.size[1]/2;this.moveState.yawLeft=-(i.pageX-n.offset[0]-r)/r,this.moveState.pitchDown=(i.pageY-n.offset[1]-o)/o,this.updateRotationVector()}}),Be(this,"pointerup",i=>{if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(i.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0;break}this.updateMovementVector()}this.updateRotationVector()}),Be(this,"lastQuaternion",new ue),Be(this,"lastPosition",new _),Be(this,"update",i=>{const n=i*this.movementSpeed,r=i*this.rollSpeed;this.object.translateX(this.moveVector.x*n),this.object.translateY(this.moveVector.y*n),this.object.translateZ(this.moveVector.z*n),this.tmpQuaternion.set(this.rotationVector.x*r,this.rotationVector.y*r,this.rotationVector.z*r,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS)&&(this.dispatchEvent(this.changeEvent),this.lastQuaternion.copy(this.object.quaternion),this.lastPosition.copy(this.object.position))}),Be(this,"updateMovementVector",()=>{const i=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-i+this.moveState.back}),Be(this,"updateRotationVector",()=>{this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}),Be(this,"getContainerDimensions",()=>this.domElement!=document&&!(this.domElement instanceof Document)?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}),Be(this,"connect",i=>{this.domElement=i,i instanceof Document||i.setAttribute("tabindex",-1),this.domElement.addEventListener("contextmenu",Mc),this.domElement.addEventListener("pointermove",this.pointermove),this.domElement.addEventListener("pointerdown",this.pointerdown),this.domElement.addEventListener("pointerup",this.pointerup),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}),Be(this,"dispose",()=>{this.domElement.removeEventListener("contextmenu",Mc),this.domElement.removeEventListener("pointermove",this.pointermove),this.domElement.removeEventListener("pointerdown",this.pointerdown),this.domElement.removeEventListener("pointerup",this.pointerup),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup)}),this.object=e,t!==void 0&&this.connect(t),this.updateMovementVector(),this.updateRotationVector()}},Bs;const Do=()=>{if(Bs)return Bs;const s="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",e="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if(typeof WebAssembly!="object")return{supported:!1};let n=s;WebAssembly.validate(t)&&(n=e);let r;const o=WebAssembly.instantiate(a(n),{}).then(h=>{r=h.instance,r.exports.__wasm_call_ctors()});function a(h){const f=new Uint8Array(h.length);for(let p=0;p<h.length;++p){const g=h.charCodeAt(p);f[p]=g>96?g-71:g>64?g-65:g>47?g+4:g>46?63:62}let m=0;for(let p=0;p<h.length;++p)f[m++]=f[p]<60?i[f[p]]:(f[p]-60)*64+f[++p];return f.buffer.slice(0,m)}function c(h,f,m,p,g,y){const v=r.exports.sbrk,E=m+3&-4,x=v(E*p),T=v(g.length),A=new Uint8Array(r.exports.memory.buffer);A.set(g,T);const C=h(x,m,p,T,g.length);if(C===0&&y&&y(x,E,p),f.set(A.subarray(x,x+m*p)),v(x-v(0)),C!==0)throw new Error(`Malformed buffer data: ${C}`)}const l={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},u={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return Bs={ready:o,supported:!0,decodeVertexBuffer(h,f,m,p,g){c(r.exports.meshopt_decodeVertexBuffer,h,f,m,p,r.exports[l[g]])},decodeIndexBuffer(h,f,m,p){c(r.exports.meshopt_decodeIndexBuffer,h,f,m,p)},decodeIndexSequence(h,f,m,p){c(r.exports.meshopt_decodeIndexSequence,h,f,m,p)},decodeGltfBuffer(h,f,m,p,g,y){c(r.exports[u[g]],h,f,m,p,r.exports[l[y]])}},Bs},ie=Number.isFinite||function(s){return typeof s=="number"&&isFinite(s)},O2=Number.isSafeInteger||function(s){return typeof s=="number"&&Math.abs(s)<=N2},N2=Number.MAX_SAFE_INTEGER||9007199254740991;let ae=(function(s){return s.NETWORK_ERROR="networkError",s.MEDIA_ERROR="mediaError",s.KEY_SYSTEM_ERROR="keySystemError",s.MUX_ERROR="muxError",s.OTHER_ERROR="otherError",s})({}),V=(function(s){return s.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",s.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",s.KEY_SYSTEM_NO_SESSION="keySystemNoSession",s.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",s.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",s.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",s.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",s.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",s.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",s.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",s.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",s.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",s.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",s.MANIFEST_LOAD_ERROR="manifestLoadError",s.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",s.MANIFEST_PARSING_ERROR="manifestParsingError",s.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",s.LEVEL_EMPTY_ERROR="levelEmptyError",s.LEVEL_LOAD_ERROR="levelLoadError",s.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",s.LEVEL_PARSING_ERROR="levelParsingError",s.LEVEL_SWITCH_ERROR="levelSwitchError",s.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",s.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",s.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",s.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",s.FRAG_LOAD_ERROR="fragLoadError",s.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",s.FRAG_DECRYPT_ERROR="fragDecryptError",s.FRAG_PARSING_ERROR="fragParsingError",s.FRAG_GAP="fragGap",s.REMUX_ALLOC_ERROR="remuxAllocError",s.KEY_LOAD_ERROR="keyLoadError",s.KEY_LOAD_TIMEOUT="keyLoadTimeOut",s.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",s.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",s.BUFFER_APPEND_ERROR="bufferAppendError",s.BUFFER_APPENDING_ERROR="bufferAppendingError",s.BUFFER_STALLED_ERROR="bufferStalledError",s.BUFFER_FULL_ERROR="bufferFullError",s.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",s.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",s.ASSET_LIST_LOAD_ERROR="assetListLoadError",s.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",s.ASSET_LIST_PARSING_ERROR="assetListParsingError",s.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",s.INTERNAL_EXCEPTION="internalException",s.INTERNAL_ABORTED="aborted",s.ATTACH_MEDIA_ERROR="attachMediaError",s.UNKNOWN="unknown",s})({}),S=(function(s){return s.MEDIA_ATTACHING="hlsMediaAttaching",s.MEDIA_ATTACHED="hlsMediaAttached",s.MEDIA_DETACHING="hlsMediaDetaching",s.MEDIA_DETACHED="hlsMediaDetached",s.MEDIA_ENDED="hlsMediaEnded",s.STALL_RESOLVED="hlsStallResolved",s.BUFFER_RESET="hlsBufferReset",s.BUFFER_CODECS="hlsBufferCodecs",s.BUFFER_CREATED="hlsBufferCreated",s.BUFFER_APPENDING="hlsBufferAppending",s.BUFFER_APPENDED="hlsBufferAppended",s.BUFFER_EOS="hlsBufferEos",s.BUFFERED_TO_END="hlsBufferedToEnd",s.BUFFER_FLUSHING="hlsBufferFlushing",s.BUFFER_FLUSHED="hlsBufferFlushed",s.MANIFEST_LOADING="hlsManifestLoading",s.MANIFEST_LOADED="hlsManifestLoaded",s.MANIFEST_PARSED="hlsManifestParsed",s.LEVEL_SWITCHING="hlsLevelSwitching",s.LEVEL_SWITCHED="hlsLevelSwitched",s.LEVEL_LOADING="hlsLevelLoading",s.LEVEL_LOADED="hlsLevelLoaded",s.LEVEL_UPDATED="hlsLevelUpdated",s.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",s.LEVELS_UPDATED="hlsLevelsUpdated",s.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",s.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",s.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",s.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",s.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",s.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",s.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",s.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",s.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",s.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",s.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",s.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",s.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",s.CUES_PARSED="hlsCuesParsed",s.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",s.INIT_PTS_FOUND="hlsInitPtsFound",s.FRAG_LOADING="hlsFragLoading",s.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",s.FRAG_LOADED="hlsFragLoaded",s.FRAG_DECRYPTED="hlsFragDecrypted",s.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",s.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",s.FRAG_PARSING_METADATA="hlsFragParsingMetadata",s.FRAG_PARSED="hlsFragParsed",s.FRAG_BUFFERED="hlsFragBuffered",s.FRAG_CHANGED="hlsFragChanged",s.FPS_DROP="hlsFpsDrop",s.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",s.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",s.ERROR="hlsError",s.DESTROYING="hlsDestroying",s.KEY_LOADING="hlsKeyLoading",s.KEY_LOADED="hlsKeyLoaded",s.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",s.BACK_BUFFER_REACHED="hlsBackBufferReached",s.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",s.ASSET_LIST_LOADING="hlsAssetListLoading",s.ASSET_LIST_LOADED="hlsAssetListLoaded",s.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",s.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",s.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",s.INTERSTITIAL_STARTED="hlsInterstitialStarted",s.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",s.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",s.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",s.INTERSTITIAL_ENDED="hlsInterstitialEnded",s.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",s.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",s.EVENT_CUE_ENTER="hlsEventCueEnter",s})({});var Se={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},se={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class on{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class U2{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new on(e),this.fast_=new on(t),this.defaultTTFB_=n,this.ttfb_=new on(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new on(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new on(t,n.getEstimate(),n.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new on(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,n=e/1e3,r=i/n;this.fast_.sample(n,r),this.slow_.sample(n,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function z2(s,e,t){return(e=$2(e))in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function De(){return De=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(s[i]=t[i])}return s},De.apply(null,arguments)}function Dc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function Le(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Dc(Object(t),!0).forEach(function(i){z2(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Dc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function G2(s,e){if(typeof s!="object"||!s)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var i=t.call(s,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(s)}function $2(s){var e=G2(s,"string");return typeof e=="symbol"?e:e+""}class Bt{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=Ii,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const Ii=function(){},H2={trace:Ii,debug:Ii,log:Ii,warn:Ii,info:Ii,error:Ii};function Ha(){return De({},H2)}function K2(s,e){const t=self.console[s];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${s}] >`):Ii}function Bc(s,e,t){return e[s]?e[s].bind(e):K2(s,t)}const Ka=Ha();function V2(s,e,t){const i=Ha();if(typeof console=="object"&&s===!0||typeof s=="object"){const n=["debug","log","info","warn","error"];n.forEach(r=>{i[r]=Bc(r,s,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.15`)}catch{return Ha()}n.forEach(r=>{Ka[r]=Bc(r,s)})}else De(Ka,i);return i}const Pe=Ka;function mi(s=!0){return typeof self>"u"?void 0:(s||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function j2(s){return typeof self<"u"&&s===self.ManagedMediaSource}function Rf(s,e){const t=Object.keys(s),i=Object.keys(e),n=t.length,r=i.length;return!n||!r||n===r&&!t.some(o=>i.indexOf(o)===-1)}function _t(s,e=!1){if(typeof TextDecoder<"u"){const l=new TextDecoder("utf-8").decode(s);if(e){const u=l.indexOf("\0");return u!==-1?l.substring(0,u):l}return l.replace(/\0/g,"")}const t=s.length;let i,n,r,o="",a=0;for(;a<t;){if(i=s[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:n=s[a++],o+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=s[a++],r=s[a++],o+=String.fromCharCode((i&15)<<12|(n&63)<<6|(r&63)<<0);break}}return o}function at(s){let e="";for(let t=0;t<s.length;t++){let i=s[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}function wf(s){return Uint8Array.from(s.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function W2(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Bo={exports:{}},Fc;function X2(){return Fc||(Fc=1,(function(s,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(c,l,u){if(u=u||{},c=c.trim(),l=l.trim(),!l){if(!u.alwaysNormalize)return c;var h=a.parseURL(c);if(!h)throw new Error("Error trying to parse base URL.");return h.path=a.normalizePath(h.path),a.buildURLFromParts(h)}var f=a.parseURL(l);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=a.normalizePath(f.path),a.buildURLFromParts(f)):l;var m=a.parseURL(c);if(!m)throw new Error("Error trying to parse base URL.");if(!m.netLoc&&m.path&&m.path[0]!=="/"){var p=n.exec(m.path);m.netLoc=p[1],m.path=p[2]}m.netLoc&&!m.path&&(m.path="/");var g={scheme:m.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(g.netLoc=m.netLoc,f.path[0]!=="/"))if(!f.path)g.path=m.path,f.params||(g.params=m.params,f.query||(g.query=m.query));else{var y=m.path,v=y.substring(0,y.lastIndexOf("/")+1)+f.path;g.path=a.normalizePath(v)}return g.path===null&&(g.path=u.alwaysNormalize?a.normalizePath(f.path):f.path),a.buildURLFromParts(g)},parseURL:function(c){var l=i.exec(c);return l?{scheme:l[1]||"",netLoc:l[2]||"",path:l[3]||"",params:l[4]||"",query:l[5]||"",fragment:l[6]||""}:null},normalizePath:function(c){for(c=c.split("").reverse().join("").replace(r,"");c.length!==(c=c.replace(o,"")).length;);return c.split("").reverse().join("")},buildURLFromParts:function(c){return c.scheme+c.netLoc+c.path+c.params+c.query+c.fragment}};s.exports=a})()})(Bo)),Bo.exports}var Dl=X2();class Jr{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var Fe={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Bl{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,Y2(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let n;i.length===1?n=t?.byteRangeEndOffset||0:n=parseInt(i[1]),this._byteRange=[n,parseInt(i[0])+n]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[Fe.AUDIO]:null,[Fe.VIDEO]:null,[Fe.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new Jr),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Dl.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[Fe.AUDIO]=null,e[Fe.VIDEO]=null,e[Fe.AUDIOVIDEO]=null}}function Ke(s){return s.sn!=="initSegment"}class Tr extends Bl{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange.length){const e=this.byteRange[0],t=this.byteRange[1];if(ie(e)&&ie(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){var e;const{levelkeys:t}=this;if(!t||t.NONE)return null;if(t.identity)this._decryptdata||(this._decryptdata=t.identity.getDecryptData(this.sn));else if(!((e=this._decryptdata)!=null&&e.keyId)){const i=Object.keys(t);if(i.length===1){const n=this._decryptdata=t[i[0]]||null;n&&(this._decryptdata=n.getDecryptData(this.sn,t))}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=ie(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t;const i=Object.keys(this.levelkeys),n=i.length;if(n>1||n===1&&(t=this.levelkeys[i[0]])!=null&&t.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!ie(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return Ke(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){const t=this.levelkeys;if(t){var i;const n=t[e];n&&!((i=this._decryptdata)!=null&&i.keyId)&&(this._decryptdata=n.getDecryptData(this.sn,t))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,n,r,o=!1){const{elementaryStreams:a}=this,c=a[e];if(!c){a[e]={startPTS:t,endPTS:i,startDTS:n,endDTS:r,partial:o};return}c.startPTS=Math.min(c.startPTS,t),c.endPTS=Math.max(c.endPTS,i),c.startDTS=Math.min(c.startDTS,n),c.endDTS=Math.max(c.endDTS,r)}}class If extends Bl{constructor(e,t,i,n,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=n;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function _f(s,e){const t=Object.getPrototypeOf(s);if(t){const i=Object.getOwnPropertyDescriptor(t,e);return i||_f(t,e)}}function Y2(s,e){const t=_f(s,e);t&&(t.enumerable=!0,Object.defineProperty(s,e,t))}const kc=Math.pow(2,32)-1,Q2=[].push,Lf={video:1,audio:2,id3:3,text:4};function Je(s){return String.fromCharCode.apply(null,s)}function Pf(s,e){const t=s[e]<<8|s[e+1];return t<0?65536+t:t}function fe(s,e){const t=Mf(s,e);return t<0?4294967296+t:t}function Oc(s,e){let t=fe(s,e);return t*=Math.pow(2,32),t+=fe(s,e+4),t}function Mf(s,e){return s[e]<<24|s[e+1]<<16|s[e+2]<<8|s[e+3]}function J2(s){const e=s.byteLength;for(let t=0;t<e;){const i=fe(s,t);if(i>8&&s[t+4]===109&&s[t+5]===111&&s[t+6]===111&&s[t+7]===102)return!0;t=i>1?t+i:e}return!1}function Ae(s,e){const t=[];if(!e.length)return t;const i=s.byteLength;for(let n=0;n<i;){const r=fe(s,n),o=Je(s.subarray(n+4,n+8)),a=r>1?n+r:i;if(o===e[0])if(e.length===1)t.push(s.subarray(n+8,a));else{const c=Ae(s.subarray(n+8,a),e.slice(1));c.length&&Q2.apply(t,c)}n=a}return t}function q2(s){const e=[],t=s[0];let i=8;const n=fe(s,i);i+=4;let r=0,o=0;t===0?(r=fe(s,i),o=fe(s,i+4),i+=8):(r=Oc(s,i),o=Oc(s,i+8),i+=16),i+=2;let a=s.length+o;const c=Pf(s,i);i+=2;for(let l=0;l<c;l++){let u=i;const h=fe(s,u);u+=4;const f=h&2147483647;if((h&2147483648)>>>31===1)return Pe.warn("SIDX has hierarchical references (not supported)"),null;const p=fe(s,u);u+=4,e.push({referenceSize:f,subsegmentDuration:p,info:{duration:p/n,start:a,end:a+f-1}}),a+=f,u+=4,i=u}return{earliestPresentationTime:r,timescale:n,version:t,referencesCount:c,references:e}}function Df(s){const e=[],t=Ae(s,["moov","trak"]);for(let n=0;n<t.length;n++){const r=t[n],o=Ae(r,["tkhd"])[0];if(o){let a=o[0];const c=fe(o,a===0?12:20),l=Ae(r,["mdia","mdhd"])[0];if(l){a=l[0];const u=fe(l,a===0?12:20),h=Ae(r,["mdia","hdlr"])[0];if(h){const f=Je(h.subarray(8,12)),m={soun:Fe.AUDIO,vide:Fe.VIDEO}[f],p=Ae(r,["mdia","minf","stbl","stsd"])[0],g=Z2(p);m?(e[c]={timescale:u,type:m,stsd:g},e[m]=Le({timescale:u,id:c},g)):e[c]={timescale:u,type:f,stsd:g}}}}}return Ae(s,["moov","mvex","trex"]).forEach(n=>{const r=fe(n,4),o=e[r];o&&(o.default={duration:fe(n,12),flags:fe(n,20)})}),e}function Z2(s){const e=s.subarray(8),t=e.subarray(86),i=Je(e.subarray(4,8));let n=i,r;const o=i==="enca"||i==="encv";if(o){const l=Ae(e,[i])[0].subarray(i==="enca"?28:78);Ae(l,["sinf"]).forEach(h=>{const f=Ae(h,["schm"])[0];if(f){const m=Je(f.subarray(4,8));if(m==="cbcs"||m==="cenc"){const p=Ae(h,["frma"])[0];p&&(n=Je(p))}}})}const a=n;switch(n){case"avc1":case"avc2":case"avc3":case"avc4":{const c=Ae(t,["avcC"])[0];c&&c.length>3&&(n+="."+ks(c[1])+ks(c[2])+ks(c[3]),r=Fs(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const c=Ae(e,[i])[0],l=Ae(c.subarray(28),["esds"])[0];if(l&&l.length>7){let u=4;if(l[u++]!==3)break;u=Fo(l,u),u+=2;const h=l[u++];if(h&128&&(u+=2),h&64&&(u+=l[u++]),l[u++]!==4)break;u=Fo(l,u);const f=l[u++];if(f===64)n+="."+ks(f);else break;if(u+=12,l[u++]!==5)break;u=Fo(l,u);const m=l[u++];let p=(m&248)>>3;p===31&&(p+=1+((m&7)<<3)+((l[u]&224)>>5)),n+="."+p}break}case"hvc1":case"hev1":{const c=Ae(t,["hvcC"])[0];if(c&&c.length>12){const l=c[1],u=["","A","B","C"][l>>6],h=l&31,f=fe(c,2),m=(l&32)>>5?"H":"L",p=c[12],g=c.subarray(6,12);n+="."+u+h,n+="."+ey(f).toString(16).toUpperCase(),n+="."+m+p;let y="";for(let v=g.length;v--;){const E=g[v];(E||y)&&(y="."+E.toString(16).toUpperCase()+y)}n+=y}r=Fs(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{n=Fs(n,t)||n;break}case"vp09":{const c=Ae(t,["vpcC"])[0];if(c&&c.length>6){const l=c[4],u=c[5],h=c[6]>>4&15;n+="."+Xt(l)+"."+Xt(u)+"."+Xt(h)}break}case"av01":{const c=Ae(t,["av1C"])[0];if(c&&c.length>2){const l=c[1]>>>5,u=c[1]&31,h=c[2]>>>7?"H":"M",f=(c[2]&64)>>6,m=(c[2]&32)>>5,p=l===2&&f?m?12:10:f?10:8,g=(c[2]&16)>>4,y=(c[2]&8)>>3,v=(c[2]&4)>>2,E=c[2]&3;n+="."+l+"."+Xt(u)+h+"."+Xt(p)+"."+g+"."+y+v+E+"."+Xt(1)+"."+Xt(1)+"."+Xt(1)+"."+0,r=Fs("dav1",t)}break}}return{codec:n,encrypted:o,supplemental:r}}function Fs(s,e){const t=Ae(e,["dvvC"]),i=t.length?t[0]:Ae(e,["dvcC"])[0];if(i){const n=i[2]>>1&127,r=i[2]<<5&32|i[3]>>3&31;return s+"."+Xt(n)+"."+Xt(r)}}function ey(s){let e=0;for(let t=0;t<32;t++)e|=(s>>t&1)<<31-t;return e>>>0}function Fo(s,e){const t=e+5;for(;s[e++]&128&&e<t;);return e}function ks(s){return("0"+s.toString(16).toUpperCase()).slice(-2)}function Xt(s){return(s<10?"0":"")+s}function ty(s,e){if(!s||!e)return;const t=e.keyId;t&&e.isCommonEncryption&&Bf(s,(i,n)=>{const r=i.subarray(8,24);r.some(o=>o!==0)||(Pe.log(`[eme] Patching keyId in 'enc${n?"a":"v"}>sinf>>tenc' box: ${at(r)} -> ${at(t)}`),i.set(t,8))})}function iy(s){const e=[];return Bf(s,t=>e.push(t.subarray(8,24))),e}function Bf(s,e){Ae(s,["moov","trak"]).forEach(i=>{const n=Ae(i,["mdia","minf","stbl","stsd"])[0];if(!n)return;const r=n.subarray(8);let o=Ae(r,["enca"]);const a=o.length>0;a||(o=Ae(r,["encv"])),o.forEach(c=>{const l=a?c.subarray(28):c.subarray(78);Ae(l,["sinf"]).forEach(h=>{const f=Ff(h);f&&e(f,a)})})})}function Ff(s){const e=Ae(s,["schm"])[0];if(e){const t=Je(e.subarray(4,8));if(t==="cbcs"||t==="cenc"){const i=Ae(s,["schi","tenc"])[0];if(i)return i}}}function ny(s,e,t){const i={},n=Ae(s,["moof","traf"]);for(let r=0;r<n.length;r++){const o=n[r],a=Ae(o,["tfhd"])[0],c=fe(a,4),l=e[c];if(!l)continue;i[c]||(i[c]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type});const u=i[c],h=Ae(o,["tfdt"])[0];if(h){const x=h[0];let T=fe(h,4);x===1&&(T===kc?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(T*=kc+1,T+=fe(h,8))),ie(T)&&(!ie(u.start)||T<u.start)&&(u.start=T)}const f=l.default,m=fe(a,0)|f?.flags;let p=f?.duration||0;m&8&&(m&2?p=fe(a,12):p=fe(a,8));const g=Ae(o,["trun"]);let y=u.start||0,v=0,E=p;for(let x=0;x<g.length;x++){const T=g[x],A=fe(T,4),C=u.sampleCount;u.sampleCount+=A;const b=T[3]&1,R=T[3]&4,I=T[2]&1,w=T[2]&2,M=T[2]&4,P=T[2]&8;let O=8,z=A;for(b&&(O+=4),R&&A&&(!(T[O+1]&1)&&u.keyFrameIndex===void 0&&(u.keyFrameIndex=C),O+=4,I?(E=fe(T,O),O+=4):E=p,w&&(O+=4),P&&(O+=4),y+=E,v+=E,z--);z--;)I?(E=fe(T,O),O+=4):E=p,w&&(O+=4),M&&(T[O+1]&1||u.keyFrameIndex===void 0&&(u.keyFrameIndex=u.sampleCount-(z+1),u.keyFrameStart=y),O+=4),P&&(O+=4),y+=E,v+=E;!v&&p&&(v+=p*A)}u.duration+=v}if(!Object.keys(i).some(r=>i[r].duration)){let r=1/0,o=0;const a=Ae(s,["sidx"]);for(let c=0;c<a.length;c++){const l=q2(a[c]);if(l!=null&&l.references){r=Math.min(r,l.earliestPresentationTime/l.timescale);const u=l.references.reduce((h,f)=>h+f.info.duration||0,0);o=Math.max(o,u+l.earliestPresentationTime/l.timescale)}}o&&ie(o)&&Object.keys(i).forEach(c=>{i[c].duration||(i[c].duration=o*i[c].timescale-i[c].start)})}return i}function sy(s){const e={valid:null,remainder:null},t=Ae(s,["moof"]);if(t.length<2)return e.remainder=s,e;const i=t[t.length-1];return e.valid=s.slice(0,i.byteOffset-8),e.remainder=s.slice(i.byteOffset-8),e}function Dt(s,e){const t=new Uint8Array(s.length+e.length);return t.set(s),t.set(e,s.length),t}function Nc(s,e){const t=[],i=e.samples,n=e.timescale,r=e.id;let o=!1;return Ae(i,["moof"]).map(c=>{const l=c.byteOffset-8;Ae(c,["traf"]).map(h=>{const f=Ae(h,["tfdt"]).map(m=>{const p=m[0];let g=fe(m,4);return p===1&&(g*=Math.pow(2,32),g+=fe(m,8)),g/n})[0];return f!==void 0&&(s=f),Ae(h,["tfhd"]).map(m=>{const p=fe(m,4),g=fe(m,0)&16777215,y=(g&1)!==0,v=(g&2)!==0,E=(g&8)!==0;let x=0;const T=(g&16)!==0;let A=0;const C=(g&32)!==0;let b=8;p===r&&(y&&(b+=8),v&&(b+=4),E&&(x=fe(m,b),b+=4),T&&(A=fe(m,b),b+=4),C&&(b+=4),e.type==="video"&&(o=qr(e.codec)),Ae(h,["trun"]).map(R=>{const I=R[0],w=fe(R,0)&16777215,M=(w&1)!==0;let P=0;const O=(w&4)!==0,z=(w&256)!==0;let D=0;const F=(w&512)!==0;let k=0;const $=(w&1024)!==0,U=(w&2048)!==0;let N=0;const B=fe(R,4);let G=8;M&&(P=fe(R,G),G+=4),O&&(G+=4);let j=P+l;for(let L=0;L<B;L++){if(z?(D=fe(R,G),G+=4):D=x,F?(k=fe(R,G),G+=4):k=A,$&&(G+=4),U&&(I===0?N=fe(R,G):N=Mf(R,G),G+=4),e.type===Fe.VIDEO){let X=0;for(;X<k;){const Q=fe(i,j);if(j+=4,ry(o,i[j])){const ne=i.subarray(j,j+Q);Fl(ne,o?2:1,s+N/n,t)}j+=Q,X+=Q+4}}s+=D/n}}))})})}),t}function qr(s){if(!s)return!1;const e=s.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function ry(s,e){if(s){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Fl(s,e,t,i){const n=kf(s);let r=0;r+=e;let o=0,a=0,c=0;for(;r<n.length;){o=0;do{if(r>=n.length)break;c=n[r++],o+=c}while(c===255);a=0;do{if(r>=n.length)break;c=n[r++],a+=c}while(c===255);const l=n.length-r;let u=r;if(a<l)r+=a;else if(a>l){Pe.error(`Malformed SEI payload. ${a} is too small, only ${l} bytes left to parse.`);break}if(o===4){if(n[u++]===181){const f=Pf(n,u);if(u+=2,f===49){const m=fe(n,u);if(u+=4,m===1195456820){const p=n[u++];if(p===3){const g=n[u++],y=31&g,v=64&g,E=v?2+y*3:0,x=new Uint8Array(E);if(v){x[0]=g;for(let T=1;T<E;T++)x[T]=n[u++]}i.push({type:p,payloadType:o,pts:t,bytes:x})}}}}}else if(o===5&&a>16){const h=[];for(let p=0;p<16;p++){const g=n[u++].toString(16);h.push(g.length==1?"0"+g:g),(p===3||p===5||p===7||p===9)&&h.push("-")}const f=a-16,m=new Uint8Array(f);for(let p=0;p<f;p++)m[p]=n[u++];i.push({payloadType:o,pts:t,uuid:h.join(""),userData:_t(m),userDataBytes:m})}}}function kf(s){const e=s.byteLength,t=[];let i=1;for(;i<e-2;)s[i]===0&&s[i+1]===0&&s[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return s;const n=e-t.length,r=new Uint8Array(n);let o=0;for(i=0;i<n;o++,i++)o===t[0]&&(o++,t.shift()),r[i]=s[o];return r}function oy(s){const e=s[0];let t="",i="",n=0,r=0,o=0,a=0,c=0,l=0;if(e===0){for(;Je(s.subarray(l,l+1))!=="\0";)t+=Je(s.subarray(l,l+1)),l+=1;for(t+=Je(s.subarray(l,l+1)),l+=1;Je(s.subarray(l,l+1))!=="\0";)i+=Je(s.subarray(l,l+1)),l+=1;i+=Je(s.subarray(l,l+1)),l+=1,n=fe(s,12),r=fe(s,16),a=fe(s,20),c=fe(s,24),l=28}else if(e===1){l+=4,n=fe(s,l),l+=4;const h=fe(s,l);l+=4;const f=fe(s,l);for(l+=4,o=2**32*h+f,O2(o)||(o=Number.MAX_SAFE_INTEGER,Pe.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=fe(s,l),l+=4,c=fe(s,l),l+=4;Je(s.subarray(l,l+1))!=="\0";)t+=Je(s.subarray(l,l+1)),l+=1;for(t+=Je(s.subarray(l,l+1)),l+=1;Je(s.subarray(l,l+1))!=="\0";)i+=Je(s.subarray(l,l+1)),l+=1;i+=Je(s.subarray(l,l+1)),l+=1}const u=s.subarray(l,s.byteLength);return{schemeIdUri:t,value:i,timeScale:n,presentationTime:o,presentationTimeDelta:r,eventDuration:a,id:c,payload:u}}function ay(s,...e){const t=e.length;let i=8,n=t;for(;n--;)i+=e[n].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(s,4),n=0,i=8;n<t;n++)r.set(e[n],i),i+=e[n].byteLength;return r}function ly(s,e,t){if(s.byteLength!==16)throw new RangeError("Invalid system id");let i,n;i=0,n=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const o=new Uint8Array(4);return t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),ay([112,115,115,104],new Uint8Array([i,0,0,0]),s,r,n,o,t)}function cy(s){const e=[];if(s instanceof ArrayBuffer){const t=s.byteLength;let i=0;for(;i+32<t;){const n=new DataView(s,i),r=uy(n);e.push(r),i+=r.size}}return e}function uy(s){const e=s.getUint32(0),t=s.byteOffset,i=s.byteLength;if(i<e)return{offset:t,size:i};if(s.getUint32(4)!==1886614376)return{offset:t,size:e};const r=s.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};const o=s.buffer,a=at(new Uint8Array(o,t+12,16));let c=null,l=null,u=0;if(r===0)u=28;else{const f=s.getUint32(28);if(!f||i<32+f*16)return{offset:t,size:e};c=[];for(let m=0;m<f;m++)c.push(new Uint8Array(o,t+32+m*16,16));u=32+f*16}if(!u)return{offset:t,size:e};const h=s.getUint32(u);return e-32<h?{offset:t,size:e}:(l=new Uint8Array(o,t+u+4,h),{version:r,systemId:a,kids:c,data:l,offset:t,size:e})}const Of=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Dn={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function kl(s,e){const t=Dn[e];return!!t&&!!t[s.slice(0,4)]}function hs(s,e,t=!0){return!s.split(",").some(i=>!Ol(i,e,t))}function Ol(s,e,t=!0){var i;const n=mi(t);return(i=n?.isTypeSupported(ds(s,e)))!=null?i:!1}function ds(s,e){return`${e}/mp4;codecs=${s}`}function Uc(s){if(s){const e=s.substring(0,4);return Dn.video[e]}return 2}function Dr(s){const e=Of();return s.split(",").reduce((t,i)=>{const r=e&&qr(i)?9:Dn.video[i];return r?(r*2+t)/(t?3:2):(Dn.audio[i]+t)/(t?2:1)},0)}const ko={};function hy(s,e=!0){if(ko[s])return ko[s];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[s];for(let n=0;n<t.length;n++){var i;if(Ol(t[n],"audio",e))return ko[s]=t[n],t[n];if(t[n]==="mp3"&&(i=mi(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return s}const dy=/flac|opus|mp4a\.40\.34/i;function Br(s,e=!0){return s.replace(dy,t=>hy(t.toLowerCase(),e))}function fy(s,e){const t=[];if(s){const i=s.split(",");for(let n=0;n<i.length;n++)kl(i[n],"video")||t.push(i[n])}return e&&t.push(e),t.join(",")}function br(s,e){if(s&&(s.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(s)!==-1)&&(zc(s,"audio")||zc(s,"video")))return s;if(e){const t=e.split(",");if(t.length>1){if(s){for(let i=t.length;i--;)if(t[i].substring(0,4)===s.substring(0,4))return t[i]}return t[0]}}return e||s}function zc(s,e){return kl(s,e)&&Ol(s,e)}function my(s){const e=s.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");i.length>2&&i[0]==="avc1"&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}function py(s){if(s.startsWith("av01.")){const e=s.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return s}function Gc(s){const e=mi(s)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Va(s){return s.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const gy={supported:!0,powerEfficient:!0,smooth:!0},yy={supported:!1,smooth:!1,powerEfficient:!1},Nf={supported:!0,configurations:[],decodingInfoResults:[gy]};function Uf(s,e){return{supported:!1,configurations:e,decodingInfoResults:[yy],error:s}}function vy(s,e,t,i,n,r){const o=s.videoCodec,a=s.audioCodec?s.audioGroups:null,c=r?.audioCodec,l=r?.channels,u=l?parseInt(l):c?1/0:2;let h=null;if(a!=null&&a.length)try{a.length===1&&a[0]?h=e.groups[a[0]].channels:h=a.reduce((f,m)=>{if(m){const p=e.groups[m];if(!p)throw new Error(`Audio track group ${m} not found`);Object.keys(p.channels).forEach(g=>{f[g]=(f[g]||0)+p.channels[g]})}return f},{2:0})}catch{return!0}return o!==void 0&&(o.split(",").some(f=>qr(f))||s.width>1920&&s.height>1088||s.height>1920&&s.width>1088||s.frameRate>Math.max(i,30)||s.videoRange!=="SDR"&&s.videoRange!==t||s.bitrate>Math.max(n,8e6))||!!h&&ie(u)&&Object.keys(h).some(f=>parseInt(f)>u)}function zf(s,e,t,i={}){const n=s.videoCodec;if(!n&&!s.audioCodec||!t)return Promise.resolve(Nf);const r=[],o=xy(s),a=o.length,c=Ey(s,e,a>0),l=c.length;for(let u=a||1*l||1;u--;){const h={type:"media-source"};if(a&&(h.video=o[u%a]),l){h.audio=c[u%l];const f=h.audio.bitrate;h.video&&f&&(h.video.bitrate-=f)}r.push(h)}if(n){const u=navigator.userAgent;if(n.split(",").some(h=>qr(h))&&Of())return Promise.resolve(Uf(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${u})`),r))}return Promise.all(r.map(u=>{const h=Sy(u);return i[h]||(i[h]=t.decodingInfo(u))})).then(u=>({supported:!u.some(h=>!h.supported),configurations:r,decodingInfoResults:u})).catch(u=>({supported:!1,configurations:r,decodingInfoResults:[],error:u}))}function xy(s){var e;const t=(e=s.videoCodec)==null?void 0:e.split(","),i=Gf(s),n=s.width||640,r=s.height||480,o=s.frameRate||30,a=s.videoRange.toLowerCase();return t?t.map(c=>{const l={contentType:ds(py(c),"video"),width:n,height:r,bitrate:i,framerate:o};return a!=="sdr"&&(l.transferFunction=a),l}):[]}function Ey(s,e,t){var i;const n=(i=s.audioCodec)==null?void 0:i.split(","),r=Gf(s);return n&&s.audioGroups?s.audioGroups.reduce((o,a)=>{var c;const l=a?(c=e.groups[a])==null?void 0:c.tracks:null;return l?l.reduce((u,h)=>{if(h.groupId===a){const f=parseFloat(h.channels||"");n.forEach(m=>{const p={contentType:ds(m,"audio"),bitrate:t?Ay(m,r):r};f&&(p.channels=""+f),u.push(p)})}return u},o):o},[]):[]}function Ay(s,e){if(e<=1)return 1;let t=128e3;return s==="ec-3"?t=768e3:s==="ac-3"&&(t=64e4),Math.min(e/2,t)}function Gf(s){return Math.ceil(Math.max(s.bitrate*.9,s.averageBitrate)/1e3)*1e3||1}function Sy(s){let e="";const{audio:t,video:i}=s;if(i){const n=Va(i.contentType);e+=`${n}_r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${Math.ceil(i.bitrate/1e5)}`}if(t){const n=Va(t.contentType);e+=`${i?"_":""}${n}_c${t.channels}`}return e}const ja=["NONE","TYPE-0","TYPE-1",null];function Ty(s){return ja.indexOf(s)>-1}const Fr=["SDR","PQ","HLG"];function by(s){return!!s&&Fr.indexOf(s)>-1}var rs={No:"",Yes:"YES",v2:"v2"};function $c(s){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=s,n=i<e/2;return e&&n?t?rs.v2:rs.Yes:rs.No}class Wa{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Bn{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Hc(this._audioGroups,e)}hasSubtitleGroup(e){return Hc(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function Hc(s,e){return!e||!s?!1:s.indexOf(e)!==-1}function Cy(){if(typeof matchMedia=="function"){const s=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(s.media!==e.media)return s.matches===!0}return!1}function Ry(s,e){let t=!1,i=[];if(s&&(t=s!=="SDR",i=[s]),e){i=e.allowedVideoRanges||Fr.slice(0);const n=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:n&&Cy(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const wy=s=>{const e=new WeakSet;return(t,i)=>{if(s&&(i=s(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},ke=(s,e)=>JSON.stringify(s,wy(e));function Iy(s,e,t,i,n){const r=Object.keys(s),o=i?.channels,a=i?.audioCodec,c=n?.videoCodec,l=o&&parseInt(o)===2;let u=!1,h=!1,f=1/0,m=1/0,p=1/0,g=1/0,y=0,v=[];const{preferHDR:E,allowedVideoRanges:x}=Ry(e,n);for(let R=r.length;R--;){const I=s[r[R]];u||(u=I.channels[2]>0),f=Math.min(f,I.minHeight),m=Math.min(m,I.minFramerate),p=Math.min(p,I.minBitrate),x.filter(M=>I.videoRanges[M]>0).length>0&&(h=!0)}f=ie(f)?f:0,m=ie(m)?m:0;const T=Math.max(1080,f),A=Math.max(30,m);p=ie(p)?p:t,t=Math.max(p,t),h||(e=void 0);const C=r.length>1;return{codecSet:r.reduce((R,I)=>{const w=s[I];if(I===R)return R;if(v=h?x.filter(M=>w.videoRanges[M]>0):[],C){if(w.minBitrate>t)return Kt(I,`min bitrate of ${w.minBitrate} > current estimate of ${t}`),R;if(!w.hasDefaultAudio)return Kt(I,"no renditions with default or auto-select sound found"),R;if(a&&I.indexOf(a.substring(0,4))%5!==0)return Kt(I,`audio codec preference "${a}" not found`),R;if(o&&!l){if(!w.channels[o])return Kt(I,`no renditions with ${o} channel sound found (channels options: ${Object.keys(w.channels)})`),R}else if((!a||l)&&u&&w.channels[2]===0)return Kt(I,"no renditions with stereo sound found"),R;if(w.minHeight>T)return Kt(I,`min resolution of ${w.minHeight} > maximum of ${T}`),R;if(w.minFramerate>A)return Kt(I,`min framerate of ${w.minFramerate} > maximum of ${A}`),R;if(!v.some(M=>w.videoRanges[M]>0))return Kt(I,`no variants with VIDEO-RANGE of ${ke(v)} found`),R;if(c&&I.indexOf(c.substring(0,4))%5!==0)return Kt(I,`video codec preference "${c}" not found`),R;if(w.maxScore<y)return Kt(I,`max score of ${w.maxScore} < selected max of ${y}`),R}return R&&(Dr(I)>=Dr(R)||w.fragmentError>s[R].fragmentError)?R:(g=w.minIndex,y=w.maxScore,I)},void 0),videoRanges:v,preferHDR:E,minFramerate:m,minBitrate:p,minIndex:g}}function Kt(s,e){Pe.log(`[abr] start candidates with "${s}" ignored because ${e}`)}function $f(s){return s.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function _y(s,e,t,i){return s.slice(t,i+1).reduce((n,r,o)=>{if(!r.codecSet)return n;const a=r.audioGroups;let c=n[r.codecSet];c||(n[r.codecSet]=c={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),c.minBitrate=Math.min(c.minBitrate,r.bitrate);const l=Math.min(r.height,r.width);return c.minHeight=Math.min(c.minHeight,l),c.minFramerate=Math.min(c.minFramerate,r.frameRate),c.minIndex=Math.min(c.minIndex,o),c.maxScore=Math.max(c.maxScore,r.score),c.fragmentError+=r.fragmentError,c.videoRanges[r.videoRange]=(c.videoRanges[r.videoRange]||0)+1,a&&a.forEach(u=>{if(!u)return;const h=e.groups[u];h&&(c.hasDefaultAudio=c.hasDefaultAudio||e.hasDefaultAudio?h.hasDefault:h.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(h.channels).forEach(f=>{c.channels[f]=(c.channels[f]||0)+h.channels[f]}))}),n},{})}function Kc(s){if(!s)return s;const{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:r}=s;return{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:r}}function qt(s,e,t){if("attrs"in s){const i=e.indexOf(s);if(i!==-1)return i}for(let i=0;i<e.length;i++){const n=e[i];if(Wi(s,n,t))return i}return-1}function Wi(s,e,t){const{groupId:i,name:n,lang:r,assocLang:o,default:a}=s,c=s.forced;return(i===void 0||e.groupId===i)&&(n===void 0||e.name===n)&&(r===void 0||Ly(r,e.lang))&&(r===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(c===void 0||e.forced===c)&&(!("characteristics"in s)||Py(s.characteristics||"",e.characteristics))&&(t===void 0||t(s,e))}function Ly(s,e="--"){return s.length===e.length?s===e:s.startsWith(e)||e.startsWith(s)}function Py(s,e=""){const t=s.split(","),i=e.split(",");return t.length===i.length&&!t.some(n=>i.indexOf(n)===-1)}function Ki(s,e){const{audioCodec:t,channels:i}=s;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function My(s,e,t,i,n){const r=e[i],a=e.reduce((f,m,p)=>{const g=m.uri;return(f[g]||(f[g]=[])).push(p),f},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));const c=r.videoRange,l=r.frameRate,u=r.codecSet.substring(0,4),h=Vc(e,i,f=>{if(f.videoRange!==c||f.frameRate!==l||f.codecSet.substring(0,4)!==u)return!1;const m=f.audioGroups,p=t.filter(g=>!m||m.indexOf(g.groupId)!==-1);return qt(s,p,n)>-1});return h>-1?h:Vc(e,i,f=>{const m=f.audioGroups,p=t.filter(g=>!m||m.indexOf(g.groupId)!==-1);return qt(s,p,n)>-1})}function Vc(s,e,t){for(let i=e;i>-1;i--)if(t(s[i]))return i;for(let i=e+1;i<s.length;i++)if(t(s[i]))return i;return-1}function kr(s,e){var t;return!!s&&s!==((t=e.loadLevelObj)==null?void 0:t.uri)}class Hf extends Bt{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:n,partCurrent:r,hls:o}=this,{autoLevelEnabled:a,media:c}=o;if(!n||!c)return;const l=performance.now(),u=r?r.stats:n.stats,h=r?r.duration:n.duration,f=l-u.loading.start,m=o.minAutoLevel,p=n.level,g=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||p<=m){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const y=g>-1&&g!==p,v=!!t||y;if(!v&&(c.paused||!c.playbackRate||!c.readyState))return;const E=o.mainForwardBufferInfo;if(!v&&E===null)return;const x=this.bwEstimator.getEstimateTTFB(),T=Math.abs(c.playbackRate);if(f<=Math.max(x,1e3*(h/(T*2))))return;const A=E?E.len/T:0,C=u.loading.first?u.loading.first-u.loading.start:-1,b=u.loaded&&C>-1,R=this.getBwEstimate(),I=o.levels,w=I[p],M=Math.max(u.loaded,Math.round(h*(n.bitrate||w.averageBitrate)/8));let P=b?f-C:f;P<1&&b&&(P=Math.min(f,u.loaded*8/R));const O=b?u.loaded*1e3/P:0,z=x/1e3,D=O?(M-u.loaded)/O:M*8/R+z;if(D<=A)return;const F=O?O*8:R,k=((i=t?.details||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,$=this.hls.config.abrBandWidthUpFactor;let U=Number.POSITIVE_INFINITY,N;for(N=p-1;N>m;N--){const L=I[N].maxBitrate,X=!I[N].details||k;if(U=this.getTimeToLoadFrag(z,F,h*L,X),U<Math.min(A,h+z))break}if(U>=D||U>h*10)return;b?this.bwEstimator.sample(f-Math.min(x,C),u.loaded):this.bwEstimator.sampleTTFB(f);const B=I[N].maxBitrate;this.getBwEstimate()*$>B&&this.resetEstimator(B);const G=this.findBestLevel(B,m,N,0,A,1,1);G>-1&&(N=G),this.warn(`Fragment ${n.sn}${r?" part "+r.index:""} of level ${p} is loading too slowly;
      Fragment duration: ${n.duration.toFixed(3)}
      Time to underbuffer: ${A.toFixed(3)} s
      Estimated load time for current fragment: ${D.toFixed(3)} s
      Estimated load time for down switch fragment: ${U.toFixed(3)} s
      TTFB estimate: ${C|0} ms
      Current BW estimate: ${ie(R)?R|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${N} @ ${B|0} bps`),o.nextLoadLevel=o.nextAutoLevel=N,this.clearTimer();const j=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===N&&N>0){const L=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${N>0?"and switching down":""}
      Fragment duration: ${n.duration.toFixed(3)} s
      Time to underbuffer: ${L.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,N>m){let X=this.findBestLevel(this.hls.levels[m].bitrate,m,N,0,L,1,1);X===-1&&(X=m),this.hls.nextLoadLevel=this.hls.nextAutoLevel=X,this.resetEstimator(this.hls.levels[X].bitrate)}}};y||D>U*2?j():this.timer=self.setInterval(j,U*1e3),o.trigger(S.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:r,stats:u})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new U2(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.FRAG_LOADING,this.onFragLoading,this),e.on(S.FRAG_LOADED,this.onFragLoaded,this),e.on(S.FRAG_BUFFERED,this.onFragBuffered,this),e.on(S.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(S.LEVEL_LOADED,this.onLevelLoaded,this),e.on(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(S.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(S.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.FRAG_LOADING,this.onFragLoading,this),e.off(S.FRAG_LOADED,this.onFragLoaded,this),e.off(S.FRAG_BUFFERED,this.onFragBuffered,this),e.off(S.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(S.LEVEL_LOADED,this.onLevelLoaded,this),e.off(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(S.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(S.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var n;this.fragCurrent=i,this.partCurrent=(n=t.part)!=null?n:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case V.BUFFER_ADD_CODEC_ERROR:case V.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case V.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:n,partCurrent:r}=this;if(i&&n&&i.sn===n.sn&&i.level===n.level){const o=performance.now(),a=r?r.stats:i.stats,c=o-a.loading.start,l=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&l>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(c-Math.min(h,l),a.loaded)}else this.bwEstimator.sampleTTFB(c)}break}}}getTimeToLoadFrag(e,t,i,n){const r=e+i/t,o=n?e+this.lastLevelLoadSec:0;return r+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,r=n.end-n.first;ie(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===se.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+n.loaded,c=(o.loaded?o.loaded.duration:0)+r;o.loaded={bytes:a,duration:c},o.realBitrate=Math.round(8*a/c)}if(t.bitrateTest){const r={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(S.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,r=n!=null&&n.stats.loaded?n.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const o=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==se.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,n,1,1);if(r>-1)return r;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,r)&&o[e].loadError<=o[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:n,config:r,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,c=this.getBwEstimate(),l=this.getStarvationDelay();let u=r.abrBandWidthFactor,h=r.abrBandWidthUpFactor;if(l){const y=this.findBestLevel(c,o,n,l,0,u,h);if(y>=0)return this.rebufferNotice=-1,y}let f=a?Math.min(a,r.maxStarvationDelay):r.maxStarvationDelay;if(!l){const y=this.bitrateTestDelay;y&&(f=(a?Math.min(a,r.maxLoadingDelay):r.maxLoadingDelay)-y,this.info(`bitrate test took ${Math.round(1e3*y)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=h=1)}const m=this.findBestLevel(c,o,n,l,f,u,h);if(this.rebufferNotice!==m&&(this.rebufferNotice=m,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${m}`)),m>-1)return m;const p=i.levels[o],g=i.loadLevelObj;return g&&p?.bitrate<g.bitrate?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,r,o,a){var c;const l=n+r,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:m}=this,{levels:p,allAudioTracks:g,loadLevel:y,config:v}=this.hls;if(p.length===1)return 0;const E=p[h],x=!!((c=this.hls.latestLevelDetails)!=null&&c.live),T=y===-1||u===-1;let A,C="SDR",b=E?.frameRate||0;const{audioPreference:R,videoPreference:I}=v,w=this.audioTracksByGroup||(this.audioTracksByGroup=$f(g));let M=-1;if(T){if(this.firstSelection!==-1)return this.firstSelection;const F=this.codecTiers||(this.codecTiers=_y(p,w,t,i)),k=Iy(F,C,e,R,I),{codecSet:$,videoRanges:U,minFramerate:N,minBitrate:B,minIndex:G,preferHDR:j}=k;M=G,A=$,C=j?U[U.length-1]:U[0],b=N,e=Math.max(e,B),this.log(`picked start tier ${ke(k)}`)}else A=E?.codecSet,C=E?.videoRange;const P=m?m.duration:f?f.duration:0,O=this.bwEstimator.getEstimateTTFB()/1e3,z=[];for(let F=i;F>=t;F--){var D;const k=p[F],$=F>h;if(!k)continue;if(v.useMediaCapabilities&&!k.supportedResult&&!k.supportedPromise){const X=navigator.mediaCapabilities;typeof X?.decodingInfo=="function"&&vy(k,w,C,b,e,R)?(k.supportedPromise=zf(k,w,X,this.supportedCache),k.supportedPromise.then(Q=>{if(!this.hls)return;k.supportedResult=Q;const ne=this.hls.levels,he=ne.indexOf(k);Q.error?this.warn(`MediaCapabilities decodingInfo error: "${Q.error}" for level ${he} ${ke(Q)}`):Q.supported?Q.decodingInfoResults.some(xe=>xe.smooth===!1||xe.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${he} not smooth or powerEfficient: ${ke(Q)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${he} ${ke(Q)}`),he>-1&&ne.length>1&&(this.log(`Removing unsupported level ${he}`),this.hls.removeLevel(he),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))}).catch(Q=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${Q}`)})):k.supportedResult=Nf}if((A&&k.codecSet!==A||C&&k.videoRange!==C||$&&b>k.frameRate||!$&&b>0&&b<k.frameRate||(D=k.supportedResult)!=null&&(D=D.decodingInfoResults)!=null&&D.some(X=>X.smooth===!1))&&(!T||F!==M)){z.push(F);continue}const U=k.details,N=(m?U?.partTarget:U?.averagetargetduration)||P;let B;$?B=a*e:B=o*e;const G=P&&n>=P*2&&r===0?k.averageBitrate:k.maxBitrate,j=this.getTimeToLoadFrag(O,B,G*N,U===void 0);if(B>=G&&(F===u||k.loadError===0&&k.fragmentError===0)&&(j<=O||!ie(j)||x&&!this.bitrateTestDelay||j<l)){const X=this.forcedAutoLevel;return F!==y&&(X===-1||X!==y)&&(z.length&&this.trace(`Skipped level(s) ${z.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${p[z[0]].codecs}" ${p[z[0]].videoRange}; not compatible with "${A}" ${C}`),this.info(`switch candidate:${h}->${F} adjustedbw(${Math.round(B)})-bitrate=${Math.round(B-G)} ttfb:${O.toFixed(1)} avgDuration:${N.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${j.toFixed(1)} firstSelection:${T} codecSet:${k.codecSet} videoRange:${k.videoRange} hls.loadLevel:${y}`)),T&&(this.firstSelection=F),F}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const Kf={search:function(s,e){let t=0,i=s.length-1,n=null,r=null;for(;t<=i;){n=(t+i)/2|0,r=s[n];const o=e(r);if(o>0)t=n+1;else if(o<0)i=n-1;else return r}return null}};function Dy(s,e,t){if(e===null||!Array.isArray(s)||!s.length||!ie(e))return null;const i=s[0].programDateTime;if(e<(i||0))return null;const n=s[s.length-1].endProgramDateTime;if(e>=(n||0))return null;for(let r=0;r<s.length;++r){const o=s[r];if(Fy(e,t,o))return o}return null}function Zi(s,e,t=0,i=0,n=.005){let r=null;if(s){r=e[1+s.sn-e[0].sn]||null;const a=s.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),r&&s.level!==r.level&&r.end<=s.end&&(r=e[2+s.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!s||s.level===r.level)&&jc(t,i,r)===0||By(r,s,Math.min(n,i))))return r;const o=Kf.search(e,jc.bind(null,t,i));return o&&(o!==s||!r)?o:r}function By(s,e,t){if(e&&e.start===0&&e.level<s.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((n,r)=>(r[0]==="INF"&&(n+=parseFloat(r[1])),n),t);return s.start<=i}return!1}function jc(s=0,e=0,t){if(t.start<=s&&t.start+t.duration>s)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=s?1:t.start-i>s&&t.start?-1:0}function Fy(s,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>s}function Vf(s,e,t){if(s&&s.startCC<=e&&s.endCC>=e){let i=s.fragments;const{fragmentHint:n}=s;n&&(i=i.concat(n));let r;return Kf.search(i,o=>o.cc<e?1:o.cc>e?-1:(r=o,o.end<=t?1:o.start>t?-1:0)),r||null}return null}function Or(s){switch(s.details){case V.FRAG_LOAD_TIMEOUT:case V.KEY_LOAD_TIMEOUT:case V.LEVEL_LOAD_TIMEOUT:case V.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function jf(s){return s.details.startsWith("key")}function Wf(s){return jf(s)&&!!s.frag&&!s.frag.decryptdata}function Wc(s,e){const t=Or(e);return s.default[`${t?"timeout":"error"}Retry`]}function Nl(s,e){const t=s.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*s.retryDelayMs,s.maxRetryDelayMs)}function Xc(s){return Le(Le({},s),{errorRetry:null,timeoutRetry:null})}function Nr(s,e,t,i){if(!s)return!1;const n=i?.code,r=e<s.maxNumRetry&&(ky(n)||!!t);return s.shouldRetry?s.shouldRetry(s,e,t,i,r):r}function ky(s){return Xa(s)||!!s&&(s<400||s>499)}function Xa(s){return s===0&&navigator.onLine===!1}var qe={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},vt={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4,SwitchToSDR:8};class Xf extends Bt{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(S.ERROR,this.onError,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(S.ERROR,this.onError,this),e.off(S.ERROR,this.onErrorOut,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return e?.type===se.MAIN?e.level:this.getVariantIndex()}getVariantIndex(){var e;const t=this.hls,i=t.currentLevel;return(e=t.loadLevelObj)!=null&&e.details||i===-1?t.loadLevel:i}variantHasKey(e,t){if(e){var i;if((i=e.details)!=null&&i.hasKey(t))return!0;const n=e.audioGroups;if(n)return this.hls.allAudioTracks.filter(o=>n.indexOf(o.groupId)>=0).some(o=>{var a;return(a=o.details)==null?void 0:a.hasKey(t)})}return!1}onManifestLoading(){this.playlistError=0}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const n=this.hls,r=t.context;switch(t.details){case V.FRAG_LOAD_ERROR:case V.FRAG_LOAD_TIMEOUT:case V.KEY_LOAD_ERROR:case V.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case V.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Cn();return}case V.FRAG_GAP:case V.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=qe.SendAlternateToPenaltyBox;return}case V.LEVEL_EMPTY_ERROR:case V.LEVEL_PARSING_ERROR:{var o;const c=t.parent===se.MAIN?t.level:n.loadLevel;t.details===V.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(o=o.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case V.LEVEL_LOAD_ERROR:case V.LEVEL_LOAD_TIMEOUT:typeof r?.level=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case V.AUDIO_TRACK_LOAD_ERROR:case V.AUDIO_TRACK_LOAD_TIMEOUT:case V.SUBTITLE_LOAD_ERROR:case V.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const c=n.loadLevelObj;if(c&&(r.type===Se.AUDIO_TRACK&&c.hasAudioGroup(r.groupId)||r.type===Se.SUBTITLE_TRACK&&c.hasSubtitleGroup(r.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.loadLevel),t.errorAction.action=qe.SendAlternateToPenaltyBox,t.errorAction.flags=vt.MoveAllAlternatesMatchingHost;return}}return;case V.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:t.errorAction={action:qe.SendAlternateToPenaltyBox,flags:vt.MoveAllAlternatesMatchingHDCP};return;case V.KEY_SYSTEM_SESSION_UPDATE_FAILED:case V.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case V.KEY_SYSTEM_NO_SESSION:t.errorAction={action:qe.SendAlternateToPenaltyBox,flags:vt.MoveAllAlternatesMatchingKey};return;case V.BUFFER_ADD_CODEC_ERROR:case V.REMUX_ALLOC_ERROR:case V.BUFFER_APPEND_ERROR:if(!t.errorAction){var a;t.errorAction=this.getLevelSwitchAction(t,(a=t.level)!=null?a:n.loadLevel)}return;case V.INTERNAL_EXCEPTION:case V.BUFFER_APPENDING_ERROR:case V.BUFFER_FULL_ERROR:case V.LEVEL_SWITCH_ERROR:case V.BUFFER_STALLED_ERROR:case V.BUFFER_SEEK_OVER_HOLE:case V.BUFFER_NUDGE_ON_STALL:t.errorAction=Cn();return}t.type===ae.KEY_SYSTEM_ERROR&&(t.levelRetry=!1,t.errorAction=Cn())}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,n=Wc(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(Nr(n,r,Or(e),e.response))return{action:qe.RetryRequest,flags:vt.None,retryConfig:n,retryCount:r};const a=this.getLevelSwitchAction(e,t);return n&&(a.retryConfig=n,a.retryCount=r),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:o}=t.config,a=Wc(jf(e)?o:r,e),c=t.levels.reduce((u,h)=>u+h.fragmentError,0);if(n&&(e.details!==V.FRAG_GAP&&n.fragmentError++,!Wf(e)&&Nr(a,c,Or(e),e.response)))return{action:qe.RetryRequest,flags:vt.None,retryConfig:a,retryCount:c};const l=this.getLevelSwitchAction(e,i);return a&&(l.retryConfig=a,l.retryCount=c),l}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var r,o;const l=e.details;n.loadError++,l===V.BUFFER_APPEND_ERROR&&n.fragmentError++;let u=-1;const{levels:h,loadLevel:f,minAutoLevel:m,maxAutoLevel:p}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);const g=(r=e.frag)==null?void 0:r.type,v=(g===se.AUDIO&&l===V.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(l===V.BUFFER_ADD_CODEC_ERROR||l===V.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:C})=>n.audioCodec!==C),x=e.sourceBufferName==="video"&&(l===V.BUFFER_ADD_CODEC_ERROR||l===V.BUFFER_APPEND_ERROR)&&h.some(({codecSet:C,audioCodec:b})=>n.codecSet!==C&&n.audioCodec===b),{type:T,groupId:A}=(o=e.context)!=null?o:{};for(let C=h.length;C--;){const b=(C+f)%h.length;if(b!==f&&b>=m&&b<=p&&h[b].loadError===0){var a,c;const R=h[b];if(l===V.FRAG_GAP&&g===se.MAIN&&e.frag){const I=h[b].details;if(I){const w=Zi(e.frag,I.fragments,e.frag.start);if(w!=null&&w.gap)continue}}else{if(T===Se.AUDIO_TRACK&&R.hasAudioGroup(A)||T===Se.SUBTITLE_TRACK&&R.hasSubtitleGroup(A))continue;if(g===se.AUDIO&&(a=n.audioGroups)!=null&&a.some(I=>R.hasAudioGroup(I))||g===se.SUBTITLE&&(c=n.subtitleGroups)!=null&&c.some(I=>R.hasSubtitleGroup(I))||v&&n.audioCodec===R.audioCodec||x&&n.codecSet===R.codecSet||!v&&n.codecSet!==R.codecSet)continue}u=b;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:qe.SendAlternateToPenaltyBox,flags:vt.None,nextAutoLevel:u}}return{action:qe.SendAlternateToPenaltyBox,flags:vt.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case qe.DoNothing:break;case qe.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==V.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case qe.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n}=i,r=i.nextAutoLevel;switch(n){case vt.None:this.switchLevel(e,r);break;case vt.MoveAllAlternatesMatchingHDCP:{const c=this.getVariantLevelIndex(e.frag),l=t.levels[c],u=l?.attrs["HDCP-LEVEL"];if(i.hdcpLevel=u,u==="NONE")this.warn("HDCP policy resticted output with HDCP-LEVEL=NONE");else if(u){t.maxHdcpLevel=ja[ja.indexOf(u)-1],i.resolved=!0,this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}}case vt.MoveAllAlternatesMatchingKey:{const c=e.decryptdata;if(c){const l=this.hls.levels,u=l.length;for(let f=u;f--;)if(this.variantHasKey(l[f],c)){var o,a;this.log(`Banned key found in level ${f} (${l[f].bitrate}bps) or audio group "${(o=l[f].audioGroups)==null?void 0:o.join(",")}" (${(a=e.frag)==null?void 0:a.type} fragment) ${at(c.keyId||[])}`),l[f].fragmentError++,l[f].loadError++,this.log(`Removing level ${f} with key error (${e.error})`),this.hls.removeLevel(f)}const h=e.frag;if(this.hls.levels.length<u)i.resolved=!0;else if(h&&h.type!==se.MAIN){const f=h.decryptdata;f&&!c.matches(f)&&(i.resolved=!0)}}break}}i.resolved||this.switchLevel(e,r)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===V.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=Va(e.mimeType),n=this.hls.levels;for(let r=n.length;r--;)n[r][`${e.sourceBufferName}Codec`]===i&&(this.log(`Removing level ${r} for ${e.details} ("${i}" not supported)`),this.hls.removeLevel(r))}}}function Cn(s){const e={action:qe.DoNothing,flags:vt.None};return s&&(e.resolved=!0),e}var et={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class Oy{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e&&(e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.BUFFER_APPENDED,this.onBufferAppended,this),e.on(S.FRAG_BUFFERED,this.onFragBuffered,this),e.on(S.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.BUFFER_APPENDED,this.onBufferAppended,this),e.off(S.FRAG_BUFFERED,this.onFragBuffered,this),e.off(S.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let n=i.length;n--;){const r=i[n];if(!r)break;if(r.start<=e&&e<=r.end&&r.loaded)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:n}=this,r=Object.keys(n);for(let o=r.length;o--;){const a=n[r[o]];if(a?.body.type===t&&(!i||a.buffered)){const c=a.body;if(c.start<=e&&e<=c.end)return c}}return null}detectEvictedFragments(e,t,i,n,r){this.timeRanges&&(this.timeRanges[e]=t);const o=n?.fragment.sn||-1;Object.keys(this.fragments).forEach(a=>{const c=this.fragments[a];if(!c||o>=c.body.sn)return;if(!c.buffered&&(!c.loaded||r)){c.body.type===i&&this.removeFragment(c.body);return}const l=c.range[e];if(l){if(l.time.length===0){this.removeFragment(c.body);return}l.time.some(u=>{const h=!this.isTimeBuffered(u.startPTS,u.endPTS,t);return h&&this.removeFragment(c.body),h})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const i=e.frag,n=an(i),r=this.fragments[n];if(!r||r.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(a=>{const c=i.elementaryStreams[a];if(!c)return;const l=t[a],u=o||c.partial===!0;r.range[a]=this.getBufferedTimes(i,e.part,u,l)}),r.loaded=null,Object.keys(r.range).length?(this.bufferedEnd(r,i),Os(r)||this.removeParts(i.sn-1,i.type)):this.removeFragment(r.body)}bufferedEnd(e,t){e.buffered=!0,(e.body.endList=t.endList||e.body.endList)&&(this.endListFragments[e.body.type]=e)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=Yc(i,n=>n.fragment.sn>=e))}fragBuffered(e,t){const i=an(e);let n=this.fragments[i];!n&&t&&(n=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,this.bufferedEnd(n,e))}getBufferedTimes(e,t,i,n){const r={time:[],partial:i},o=e.start,a=e.end,c=e.minEndPTS||a,l=e.maxStartPTS||o;for(let u=0;u<n.length;u++){const h=n.start(u)-this.bufferPadding,f=n.end(u)+this.bufferPadding;if(l>=h&&c<=f){r.time.push({startPTS:Math.max(o,n.start(u)),endPTS:Math.min(a,n.end(u))});break}else if(o<f&&a>h){const m=Math.max(o,n.start(u)),p=Math.min(a,n.end(u));p>m&&(r.partial=!0,r.time.push({startPTS:m,endPTS:p}))}else if(a<=h)break}return r}getPartialFragment(e){let t=null,i,n,r,o=0;const{bufferPadding:a,fragments:c}=this;return Object.keys(c).forEach(l=>{const u=c[l];u&&Os(u)&&(n=u.body.start-a,r=u.body.end+a,e>=n&&e<=r&&(i=Math.min(e-n,r-e),o<=i&&(t=u.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Os(t))}getState(e){const t=an(e),i=this.fragments[t];return i?i.buffered?Os(i)?et.PARTIAL:et.OK:et.APPENDING:et.NOT_LOADED}isTimeBuffered(e,t,i){let n,r;for(let o=0;o<i.length;o++){if(n=i.start(o)-this.bufferPadding,r=i.end(o)+this.bufferPadding,e>=n&&t<=r)return!0;if(t<=n)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const i=t.frag,n=t.part?null:t,r=an(i);this.fragments[r]={body:i,appendedPTS:null,loaded:n,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:n,timeRanges:r,type:o}=t;if(i.sn==="initSegment")return;const a=i.type;if(n){let l=this.activePartLists[a];l||(this.activePartLists[a]=l=[]),l.push(n)}this.timeRanges=r;const c=r[o];this.detectEvictedFragments(o,c,a,n)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=an(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let n=i.length;n--;){const r=t[i[n]];if(r?.body.type===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,n,r){n&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const c=a.body;c.type!==i||n&&!c.gap||c.start<t&&c.end>e&&(a.buffered||r)&&this.removeFragment(c)})}removeFragment(e){const t=an(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const n=e.sn;this.activePartLists[e.type]=Yc(i,r=>r.fragment.sn!==n)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const t=(e=this.hls)==null||(e=e.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(i=>i.clearElementaryStreamInfo())}}function Os(s){var e,t,i;return s.buffered&&!!(s.body.gap||(e=s.range.video)!=null&&e.partial||(t=s.range.audio)!=null&&t.partial||(i=s.range.audiovideo)!=null&&i.partial)}function an(s){return`${s.type}_${s.level}_${s.sn}`}function Yc(s,e){return s.filter(t=>{const i=e(t);return i||t.clearElementaryStreamInfo(),i})}var Bi={cbc:0,ctr:1};class Ny{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case Bi.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Bi.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function Uy(s){const e=s.byteLength,t=e&&new DataView(s.buffer).getUint8(e-1);return t?s.slice(0,e-t):s}class zy{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let n=0;n<4;n++)i[n]=t.getUint32(n*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],r=i[1],o=i[2],a=i[3],c=this.invSubMix,l=c[0],u=c[1],h=c[2],f=c[3],m=new Uint32Array(256);let p=0,g=0,y=0;for(y=0;y<256;y++)y<128?m[y]=y<<1:m[y]=y<<1^283;for(y=0;y<256;y++){let v=g^g<<1^g<<2^g<<3^g<<4;v=v>>>8^v&255^99,e[p]=v,t[v]=p;const E=m[p],x=m[E],T=m[x];let A=m[v]*257^v*16843008;n[p]=A<<24|A>>>8,r[p]=A<<16|A>>>16,o[p]=A<<8|A>>>24,a[p]=A,A=T*16843009^x*65537^E*257^p*16843008,l[v]=A<<24|A>>>8,u[v]=A<<16|A>>>16,h[v]=A<<8|A>>>24,f[v]=A,p?(p=E^m[m[m[T^E]]],g^=m[m[g]]):p=g=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const o=this.ksRows=(r+6+1)*4;let a,c;const l=this.keySchedule=new Uint32Array(o),u=this.invKeySchedule=new Uint32Array(o),h=this.sBox,f=this.rcon,m=this.invSubMix,p=m[0],g=m[1],y=m[2],v=m[3];let E,x;for(a=0;a<o;a++){if(a<r){E=l[a]=t[a];continue}x=E,a%r===0?(x=x<<8|x>>>24,x=h[x>>>24]<<24|h[x>>>16&255]<<16|h[x>>>8&255]<<8|h[x&255],x^=f[a/r|0]<<24):r>6&&a%r===4&&(x=h[x>>>24]<<24|h[x>>>16&255]<<16|h[x>>>8&255]<<8|h[x&255]),l[a]=E=(l[a-r]^x)>>>0}for(c=0;c<o;c++)a=o-c,c&3?x=l[a]:x=l[a-4],c<4||a<=4?u[c]=x:u[c]=p[h[x>>>24]]^g[h[x>>>16&255]]^y[h[x>>>8&255]]^v[h[x&255]],u[c]=u[c]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,r=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,c=a[0],l=a[1],u=a[2],h=a[3],f=this.uint8ArrayToUint32Array_(i);let m=f[0],p=f[1],g=f[2],y=f[3];const v=new Int32Array(e),E=new Int32Array(v.length);let x,T,A,C,b,R,I,w,M,P,O,z,D,F;const k=this.networkToHostOrderSwap;for(;t<v.length;){for(M=k(v[t]),P=k(v[t+1]),O=k(v[t+2]),z=k(v[t+3]),b=M^r[0],R=z^r[1],I=O^r[2],w=P^r[3],D=4,F=1;F<n;F++)x=c[b>>>24]^l[R>>16&255]^u[I>>8&255]^h[w&255]^r[D],T=c[R>>>24]^l[I>>16&255]^u[w>>8&255]^h[b&255]^r[D+1],A=c[I>>>24]^l[w>>16&255]^u[b>>8&255]^h[R&255]^r[D+2],C=c[w>>>24]^l[b>>16&255]^u[R>>8&255]^h[I&255]^r[D+3],b=x,R=T,I=A,w=C,D=D+4;x=o[b>>>24]<<24^o[R>>16&255]<<16^o[I>>8&255]<<8^o[w&255]^r[D],T=o[R>>>24]<<24^o[I>>16&255]<<16^o[w>>8&255]<<8^o[b&255]^r[D+1],A=o[I>>>24]<<24^o[w>>16&255]<<16^o[b>>8&255]<<8^o[R&255]^r[D+2],C=o[w>>>24]<<24^o[b>>16&255]<<16^o[R>>8&255]<<8^o[I&255]^r[D+3],E[t]=k(x^m),E[t+1]=k(C^p),E[t+2]=k(A^g),E[t+3]=k(T^y),m=M,p=P,g=O,y=z,t=t+4}return E.buffer}}class Gy{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=$y(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function $y(s){switch(s){case Bi.cbc:return"AES-CBC";case Bi.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${s}`)}}const Hy=16;class Ul{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?Uy(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,n){return this.useSoftware?new Promise((r,o)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,n);const c=this.flush();c?r(c.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,n)}softwareDecrypt(e,t,i,n){const{currentIV:r,currentResult:o,remainderData:a}=this;if(n!==Bi.cbc||t.byteLength!==16)return Pe.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=Dt(a,e),this.remainderData=null);const c=this.getValidChunk(e);if(!c.length)return null;r&&(i=r);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new zy),l.expandKey(t);const u=o;return this.currentResult=l.decrypt(c.buffer,0,i),this.currentIV=c.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,i,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,n));this.key=t,this.fastAesKey=new Gy(this.subtle,t,n)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new Ny(this.subtle,new Uint8Array(i),n).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(Pe.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i,n)))}onWebCryptoError(e,t,i,n){const r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,n);const o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%Hy;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(Pe.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const Qc=Math.pow(2,17);class Ky{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new ai({type:ae.NETWORK_ERROR,details:V.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const n=this.config,r=n.fLoader,o=n.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(p=>p[0]==="GAP")){c(qc(e));return}else e.gap=!1;const l=this.loader=r?new r(n):new o(n),u=Jc(e);e.loader=l;const h=Xc(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Qc};e.stats=l.stats;const m={onSuccess:(p,g,y,v)=>{this.resetLoader(e,l);let E=p.data;y.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(E.slice(0,16)),E=E.slice(16)),a({frag:e,part:null,payload:E,networkDetails:v})},onError:(p,g,y,v)=>{this.resetLoader(e,l),c(new ai({type:ae.NETWORK_ERROR,details:V.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Le({url:i,data:void 0},p),error:new Error(`HTTP Error ${p.code} ${p.text}`),networkDetails:y,stats:v}))},onAbort:(p,g,y)=>{this.resetLoader(e,l),c(new ai({type:ae.NETWORK_ERROR,details:V.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:y,stats:p}))},onTimeout:(p,g,y)=>{this.resetLoader(e,l),c(new ai({type:ae.NETWORK_ERROR,details:V.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:y,stats:p}))}};t&&(m.onProgress=(p,g,y,v)=>t({frag:e,part:null,payload:y,networkDetails:v})),l.load(u,f,m)})}loadPart(e,t,i){this.abort();const n=this.config,r=n.fLoader,o=n.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){c(qc(e,t));return}const l=this.loader=r?new r(n):new o(n),u=Jc(e,t);e.loader=l;const h=Xc(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Qc};t.stats=l.stats,l.load(u,f,{onSuccess:(m,p,g,y)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const v={frag:e,part:t,payload:m.data,networkDetails:y};i(v),a(v)},onError:(m,p,g,y)=>{this.resetLoader(e,l),c(new ai({type:ae.NETWORK_ERROR,details:V.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:Le({url:u.url,data:void 0},m),error:new Error(`HTTP Error ${m.code} ${m.text}`),networkDetails:g,stats:y}))},onAbort:(m,p,g)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),c(new ai({type:ae.NETWORK_ERROR,details:V.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:g,stats:m}))},onTimeout:(m,p,g)=>{this.resetLoader(e,l),c(new ai({type:ae.NETWORK_ERROR,details:V.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:g,stats:m}))}})})}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,r=n.total;if(i.loaded+=n.loaded,r){const c=Math.round(e.duration/t.duration),l=Math.min(Math.round(i.loaded/r),c),h=(c-l)*Math.round(i.loaded/l);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=n.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Jc(s,e=null){const t=e||s,i={frag:s,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},n=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(ie(n)&&ie(r)){var o;let a=n,c=r;if(s.sn==="initSegment"&&Vy((o=s.decryptdata)==null?void 0:o.method)){const l=r-n;l%16&&(c=r+(16-l%16)),n!==0&&(i.resetIV=!0,a=n-16)}i.rangeStart=a,i.rangeEnd=c}return i}function qc(s,e){const t=new Error(`GAP ${s.gap?"tag":"attribute"} found`),i={type:ae.MEDIA_ERROR,details:V.FRAG_GAP,fatal:!1,frag:s,error:t,networkDetails:null};return e&&(i.part=e),(e||s).stats.aborted=!0,new ai(i)}function Vy(s){return s==="AES-128"||s==="AES-256"}class ai extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Yf extends Bt{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Zr{constructor(e,t,i,n=0,r=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Ns(),this.buffering={audio:Ns(),video:Ns(),audiovideo:Ns()},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=r,this.partial=o}}function Ns(){return{start:0,executeStart:0,executeEnd:0,end:0}}const Zc={length:0,start:()=>0,end:()=>0};class pe{static isBuffered(e,t){if(e){const i=pe.getBuffered(e);for(let n=i.length;n--;)if(t>=i.start(n)&&t<=i.end(n))return!0}return!1}static bufferedRanges(e){if(e){const t=pe.getBuffered(e);return pe.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const n=pe.bufferedRanges(e);if(n.length)return pe.bufferedInfo(n,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((u,h)=>u.start-h.start||h.end-u.end);let n=-1,r=[];if(i)for(let u=0;u<e.length;u++){t>=e[u].start&&t<=e[u].end&&(n=u);const h=r.length;if(h){const f=r[h-1].end;e[u].start-f<i?e[u].end>f&&(r[h-1].end=e[u].end):r.push(e[u])}else r.push(e[u])}else r=e;let o=0,a,c=t,l=t;for(let u=0;u<r.length;u++){const h=r[u].start,f=r[u].end;if(n===-1&&t>=h&&t<=f&&(n=u),t+i>=h&&t<f)c=h,l=f,o=l-t;else if(t+i<h){a=h;break}}return{len:o,start:c||0,end:l||0,nextStart:a,buffered:e,bufferedIndex:n}}static getBuffered(e){try{return e.buffered||Zc}catch(t){return Pe.log("failed to get media.buffered",t),Zc}}}const Qf=/\{\$([a-zA-Z0-9-_]+)\}/g;function eu(s){return Qf.test(s)}function Ya(s,e){if(s.variableList!==null||s.hasVariableRefs){const t=s.variableList;return e.replace(Qf,i=>{const n=i.substring(2,i.length-1),r=t?.[n];return r===void 0?(s.playlistParsingError||(s.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),i):r})}return e}function tu(s,e,t){let i=s.variableList;i||(s.variableList=i={});let n,r;if("QUERYPARAM"in e){n=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(n))r=o.get(n);else throw new Error(`"${n}" does not match any query parameter in URI: "${t}"`)}catch(o){s.playlistParsingError||(s.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else n=e.NAME,r=e.VALUE;n in i?s.playlistParsingError||(s.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${n}"`)):i[n]=r||""}function jy(s,e,t){const i=e.IMPORT;if(t&&i in t){let n=s.variableList;n||(s.variableList=n={}),n[i]=t[i]}else s.playlistParsingError||(s.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const Wy=/^(\d+)x(\d+)$/,iu=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Ue{constructor(e,t){typeof e=="string"&&(e=Ue.parseAttrList(e,t)),De(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let n=0;n<t.length/2;n++)i[n]=parseInt(t.slice(n*2,n*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((n,r)=>(n[r.toLowerCase()]=!0,n),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=Wy.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const n={};for(iu.lastIndex=0;(i=iu.exec(e))!==null;){const o=i[1].trim();let a=i[2];const c=a.indexOf('"')===0&&a.lastIndexOf('"')===a.length-1;let l=!1;if(c)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":l=!0}if(t&&(c||l))a=Ya(t,a);else if(!l&&!c)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":Pe.warn(`${e}: attribute ${o} is missing quotes`)}n[o]=a}return n}}const Xy="com.apple.hls.interstitial";function Yy(s){return s!=="ID"&&s!=="CLASS"&&s!=="CUE"&&s!=="START-DATE"&&s!=="DURATION"&&s!=="END-DATE"&&s!=="END-ON-NEXT"}function Qy(s){return s==="SCTE35-OUT"||s==="SCTE35-IN"||s==="SCTE35-CMD"}class zl{constructor(e,t,i=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=(n=t?.tagOrder)!=null?n:i,t){const r=t.attr;for(const o in r)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==r[o]){Pe.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=De(new Ue({}),r,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const r=t?.endDate||new Date(this.attr["END-DATE"]);ie(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(Pe.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(ie(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===Xy}get isValid(){return!!this.id&&!this._badValueForSameId&&ie(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const Jy=10;class Jf{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}hasKey(e){return this.encryptedFragments.some(t=>{let i=t.decryptdata;return i||(t.setKeyFormat(e.keyFormat),i=t.decryptdata),!!i&&e.matches(i)})}get hasProgramDateTime(){return this.fragments.length?ie(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Jy}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function Ur(s,e){return s.length===e.length?!s.some((t,i)=>t!==e[i]):!1}function nu(s,e){return!s&&!e?!0:!s||!e?!1:Ur(s,e)}function Rn(s){return s==="AES-128"||s==="AES-256"||s==="AES-256-CTR"}function Gl(s){switch(s){case"AES-128":case"AES-256":return Bi.cbc;case"AES-256-CTR":return Bi.ctr;default:throw new Error(`invalid full segment method ${s}`)}}function $l(s){return Uint8Array.from(atob(s),e=>e.charCodeAt(0))}function Qa(s){return Uint8Array.from(unescape(encodeURIComponent(s)),e=>e.charCodeAt(0))}function qy(s){const e=Qa(s).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function qf(s){const e=function(i,n,r){const o=i[n];i[n]=i[r],i[r]=o};e(s,0,3),e(s,1,2),e(s,4,5),e(s,6,7)}function Zf(s){const e=s.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),n=i[i.length-1].split(",");if(n.length===2){const r=n[0]==="base64",o=n[1];r?(i.splice(-1,1),t=$l(o)):t=qy(o)}}return t}const zr=typeof self<"u"?self:void 0;var ze={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},nt={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Cr(s){switch(s){case nt.FAIRPLAY:return ze.FAIRPLAY;case nt.PLAYREADY:return ze.PLAYREADY;case nt.WIDEVINE:return ze.WIDEVINE;case nt.CLEARKEY:return ze.CLEARKEY}}function Oo(s){switch(s){case ze.FAIRPLAY:return nt.FAIRPLAY;case ze.PLAYREADY:return nt.PLAYREADY;case ze.WIDEVINE:return nt.WIDEVINE;case ze.CLEARKEY:return nt.CLEARKEY}}function is(s){const{drmSystems:e,widevineLicenseUrl:t}=s,i=e?[ze.FAIRPLAY,ze.WIDEVINE,ze.PLAYREADY,ze.CLEARKEY].filter(n=>!!e[n]):[];return!i[ze.WIDEVINE]&&t&&i.push(ze.WIDEVINE),i}const Hl=(function(s){return zr!=null&&(s=zr.navigator)!=null&&s.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null})();function Zy(s,e,t,i){let n;switch(s){case ze.FAIRPLAY:n=["cenc","sinf"];break;case ze.WIDEVINE:case ze.PLAYREADY:n=["cenc"];break;case ze.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${s}`)}return e3(n,e,t,i)}function e3(s,e,t,i){return[{initDataTypes:s,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs=${r}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs=${r}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function t3(s){var e;return!!s&&(s.sessionType==="persistent-license"||!!((e=s.sessionTypes)!=null&&e.some(t=>t==="persistent-license")))}function e0(s){const e=new Uint16Array(s.buffer,s.byteOffset,s.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){const a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){const c=$l(a).subarray(0,16);return qf(c),c}}return null}let ln={};class di{static clearKeyUriToKeyIdMap(){ln={}}static setKeyIdForUri(e,t){ln[e]=t}static addKeyIdForUri(e){const t=Object.keys(ln).length%Number.MAX_SAFE_INTEGER,i=new Uint8Array(16);return new DataView(i.buffer,12,4).setUint32(0,t),ln[e]=i,i}constructor(e,t,i,n=[1],r=null,o){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Rn(e),o!=null&&o.startsWith("0x")&&(this.keyId=new Uint8Array(wf(o)))}matches(e){return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&Ur(e.keyFormatVersions,this.keyFormatVersions)&&nu(e.iv,this.iv)&&nu(e.keyId,this.keyId)}isSupported(){if(this.method){if(Rn(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case nt.FAIRPLAY:case nt.WIDEVINE:case nt.PLAYREADY:case nt.CLEARKEY:return["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e,t){if(!this.encrypted||!this.uri)return null;if(Rn(this.method)){let r=this.iv;return r||(typeof e!="number"&&(Pe.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0),r=n3(e)),new di(this.method,this.uri,"identity",this.keyFormatVersions,r)}if(this.keyId){const r=ln[this.uri];if(r&&!Ur(this.keyId,r)&&di.setKeyIdForUri(this.uri,this.keyId),this.pssh)return this}const i=Zf(this.uri);if(i)switch(this.keyFormat){case nt.WIDEVINE:if(this.pssh=i,!this.keyId){const r=cy(i.buffer);if(r.length){var n;const o=r[0];this.keyId=(n=o.kids)!=null&&n.length?o.kids[0]:null}}this.keyId||(this.keyId=su(t));break;case nt.PLAYREADY:{const r=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=ly(r,null,i),this.keyId=e0(i);break}default:{let r=i.subarray(0,16);if(r.length!==16){const o=new Uint8Array(16);o.set(r,16-r.length),r=o}this.keyId=r;break}}if(!this.keyId||this.keyId.byteLength!==16){let r;r=i3(t),r||(r=su(t),r||(r=ln[this.uri])),r&&(this.keyId=r,di.setKeyIdForUri(this.uri,r))}return this}}function i3(s){const e=s?.[nt.WIDEVINE];return e?e.keyId:null}function su(s){const e=s?.[nt.PLAYREADY];if(e){const t=Zf(e.uri);if(t)return e0(t)}return null}function n3(s){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=s>>8*(15-t)&255;return e}const ru=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,ou=/#EXT-X-MEDIA:(.*)/g,s3=/^#EXT(?:INF|-X-TARGETDURATION):/m,No=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),r3=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class zt{static findGroup(e,t){for(let i=0;i<e.length;i++){const n=e[i];if(n.id===t)return n}}static resolve(e,t){return Dl.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return s3.test(e)}static parseMasterPlaylist(e,t){const i=eu(e),n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];if(ru.lastIndex=0,!e.startsWith("#EXTM3U"))return n.playlistParsingError=new Error("no EXTM3U delimiter"),n;let o;for(;(o=ru.exec(e))!=null;)if(o[1]){var a;const l=new Ue(o[1],n),u=Ya(n,o[2]),h={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:zt.resolve(u,t)},f=l.decimalResolution("RESOLUTION");f&&(h.width=f.width,h.height=f.height),cu(l.CODECS,h);const m=l["SUPPLEMENTAL-CODECS"];m&&(h.supplemental={},cu(m,h.supplemental)),(a=h.unknownCodecs)!=null&&a.length||r.push(h),n.levels.push(h)}else if(o[3]){const l=o[3],u=o[4];switch(l){case"SESSION-DATA":{const h=new Ue(u,n),f=h["DATA-ID"];f&&(n.sessionData===null&&(n.sessionData={}),n.sessionData[f]=h);break}case"SESSION-KEY":{const h=au(u,t,n);h.encrypted&&h.isSupported()?(n.sessionKeys===null&&(n.sessionKeys=[]),n.sessionKeys.push(h)):Pe.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new Ue(u,n);tu(n,h,t)}break}case"CONTENT-STEERING":{const h=new Ue(u,n);n.contentSteering={uri:zt.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{n.startTimeOffset=lu(u);break}}}const c=r.length>0&&r.length<n.levels.length;return n.levels=c?r:n.levels,n.levels.length===0&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,i){let n;const r={},o=i.levels,a={AUDIO:o.map(l=>({id:l.attrs.AUDIO,audioCodec:l.audioCodec})),SUBTITLES:o.map(l=>({id:l.attrs.SUBTITLES,textCodec:l.textCodec})),"CLOSED-CAPTIONS":[]};let c=0;for(ou.lastIndex=0;(n=ou.exec(e))!==null;){const l=new Ue(n[1],i),u=l.TYPE;if(u){const h=a[u],f=r[u]||[];r[u]=f;const m=l.LANGUAGE,p=l["ASSOC-LANGUAGE"],g=l.CHANNELS,y=l.CHARACTERISTICS,v=l["INSTREAM-ID"],E={attrs:l,bitrate:0,id:c++,groupId:l["GROUP-ID"]||"",name:l.NAME||m||"",type:u,default:l.bool("DEFAULT"),autoselect:l.bool("AUTOSELECT"),forced:l.bool("FORCED"),lang:m,url:l.URI?zt.resolve(l.URI,t):""};if(p&&(E.assocLang=p),g&&(E.channels=g),y&&(E.characteristics=y),v&&(E.instreamId=v),h!=null&&h.length){const x=zt.findGroup(h,E.groupId)||h[0];uu(E,x,"audioCodec"),uu(E,x,"textCodec")}f.push(E)}}return r}static parseLevelPlaylist(e,t,i,n,r,o){var a;const c={url:t},l=new Jf(t),u=l.fragments,h=[];let f=null,m=0,p=0,g=0,y=0,v=0,E=null,x=new Tr(n,c),T,A,C,b=-1,R=!1,I=null,w;if(No.lastIndex=0,l.m3u8=e,l.hasVariableRefs=eu(e),((a=No.exec(e))==null?void 0:a[0])!=="#EXTM3U")return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;(T=No.exec(e))!==null;){R&&(R=!1,x=new Tr(n,c),x.playlistOffset=g,x.setStart(g),x.sn=m,x.cc=y,v&&(x.bitrate=v),x.level=i,f&&(x.initSegment=f,f.rawProgramDateTime&&(x.rawProgramDateTime=f.rawProgramDateTime,f.rawProgramDateTime=null),I&&(x.setByteRange(I),I=null)));const z=T[1];if(z){x.duration=parseFloat(z);const D=(" "+T[2]).slice(1);x.title=D||null,x.tagList.push(D?["INF",z,D]:["INF",z])}else if(T[3]){if(ie(x.duration)){x.playlistOffset=g,x.setStart(g),C&&du(x,C,l),x.sn=m,x.level=i,x.cc=y,u.push(x);const D=(" "+T[3]).slice(1);x.relurl=Ya(l,D),Ja(x,E,h),E=x,g+=x.duration,m++,p=0,R=!0}}else{if(T=T[0].match(r3),!T){Pe.warn("No matches on slow regex match for level playlist!");continue}for(A=1;A<T.length&&T[A]===void 0;A++);const D=(" "+T[A]).slice(1),F=(" "+T[A+1]).slice(1),k=T[A+2]?(" "+T[A+2]).slice(1):null;switch(D){case"BYTERANGE":E?x.setByteRange(F,E):x.setByteRange(F);break;case"PROGRAM-DATE-TIME":x.rawProgramDateTime=F,x.tagList.push(["PROGRAM-DATE-TIME",F]),b===-1&&(b=u.length);break;case"PLAYLIST-TYPE":l.type&&si(l,D,T),l.type=F.toUpperCase();break;case"MEDIA-SEQUENCE":l.startSN!==0?si(l,D,T):u.length>0&&fu(l,D,T),m=l.startSN=parseInt(F);break;case"SKIP":{l.skippedSegments&&si(l,D,T);const $=new Ue(F,l),U=$.decimalInteger("SKIPPED-SEGMENTS");if(ie(U)){l.skippedSegments+=U;for(let B=U;B--;)u.push(null);m+=U}const N=$.enumeratedString("RECENTLY-REMOVED-DATERANGES");N&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat(N.split("	")));break}case"TARGETDURATION":l.targetduration!==0&&si(l,D,T),l.targetduration=Math.max(parseInt(F),1);break;case"VERSION":l.version!==null&&si(l,D,T),l.version=parseInt(F);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||si(l,D,T),l.live=!1;break;case"#":(F||k)&&x.tagList.push(k?[F,k]:[F]);break;case"DISCONTINUITY":y++,x.tagList.push(["DIS"]);break;case"GAP":x.gap=!0,x.tagList.push([D]);break;case"BITRATE":x.tagList.push([D,F]),v=parseInt(F)*1e3,ie(v)?x.bitrate=v:v=0;break;case"DATERANGE":{const $=new Ue(F,l),U=new zl($,l.dateRanges[$.ID],l.dateRangeTagCount);l.dateRangeTagCount++,U.isValid||l.skippedSegments?l.dateRanges[U.id]=U:Pe.warn(`Ignoring invalid DATERANGE tag: "${F}"`),x.tagList.push(["EXT-X-DATERANGE",F]);break}case"DEFINE":{{const $=new Ue(F,l);"IMPORT"in $?jy(l,$,o):tu(l,$,t)}break}case"DISCONTINUITY-SEQUENCE":l.startCC!==0?si(l,D,T):u.length>0&&fu(l,D,T),l.startCC=y=parseInt(F);break;case"KEY":{const $=au(F,t,l);if($.isSupported()){if($.method==="NONE"){C=void 0;break}C||(C={});const U=C[$.keyFormat];U!=null&&U.matches($)||(U&&(C=De({},C)),C[$.keyFormat]=$)}else Pe.warn(`[Keys] Ignoring unsupported EXT-X-KEY tag: "${F}"`);break}case"START":l.startTimeOffset=lu(F);break;case"MAP":{const $=new Ue(F,l);if(x.duration){const U=new Tr(n,c);hu(U,$,i,C),f=U,x.initSegment=f,f.rawProgramDateTime&&!x.rawProgramDateTime&&(x.rawProgramDateTime=f.rawProgramDateTime)}else{const U=x.byteRangeEndOffset;if(U){const N=x.byteRangeStartOffset;I=`${U-N}@${N}`}else I=null;hu(x,$,i,C),f=x,R=!0}f.cc=y;break}case"SERVER-CONTROL":{w&&si(l,D,T),w=new Ue(F),l.canBlockReload=w.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=w.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&w.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=w.optionalFloat("PART-HOLD-BACK",0),l.holdBack=w.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{l.partTarget&&si(l,D,T);const $=new Ue(F);l.partTarget=$.decimalFloatingPoint("PART-TARGET");break}case"PART":{let $=l.partList;$||($=l.partList=[]);const U=p>0?$[$.length-1]:void 0,N=p++,B=new Ue(F,l),G=new If(B,x,c,N,U);$.push(G),x.duration+=G.duration;break}case"PRELOAD-HINT":{const $=new Ue(F,l);l.preloadHint=$;break}case"RENDITION-REPORT":{const $=new Ue(F,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push($);break}default:Pe.warn(`line parsed but not handled: ${T}`);break}}}E&&!E.relurl?(u.pop(),g-=E.duration,l.partList&&(l.fragmentHint=E)):l.partList&&(Ja(x,E,h),x.cc=y,l.fragmentHint=x,C&&du(x,C,l)),l.targetduration||(l.playlistParsingError=new Error("Missing Target Duration"));const M=u.length,P=u[0],O=u[M-1];if(g+=l.skippedSegments*l.targetduration,g>0&&M&&O){l.averagetargetduration=g/M;const z=O.sn;l.endSN=z!=="initSegment"?z:0,l.live||(O.endList=!0),b>0&&(a3(u,b),P&&h.unshift(P))}return l.fragmentHint&&(g+=l.fragmentHint.duration),l.totalduration=g,h.length&&l.dateRangeTagCount&&P&&t0(h,l),l.endCC=y,l}}function t0(s,e){let t=s.length;if(!t)if(e.hasProgramDateTime){const a=e.fragments[e.fragments.length-1];s.push(a),t++}else return;const i=s[t-1],n=e.live?1/0:e.totalduration,r=Object.keys(e.dateRanges);for(let a=r.length;a--;){const c=e.dateRanges[r[a]],l=c.startDate.getTime();c.tagAnchor=i.ref;for(let u=t;u--;){var o;if(((o=s[u])==null?void 0:o.sn)<e.startSN)break;const h=o3(e,l,s,u,n);if(h!==-1){c.tagAnchor=e.fragments[h].ref;break}}}}function o3(s,e,t,i,n){const r=t[i];if(r){const a=r.programDateTime;if(e>=a||i===0){var o;const c=(((o=t[i+1])==null?void 0:o.start)||n)-r.start;if(e<=a+c*1e3){const l=t[i].sn-s.startSN;if(l<0)return-1;const u=s.fragments;if(u.length>t.length){const f=(t[i+1]||u[u.length-1]).sn-s.startSN;for(let m=f;m>l;m--){const p=u[m].programDateTime;if(e>=p&&e<p+u[m].duration*1e3)return m}}return l}}}return-1}function au(s,e,t){var i,n;const r=new Ue(s,t),o=(i=r.METHOD)!=null?i:"",a=r.URI,c=r.hexadecimalInteger("IV"),l=r.KEYFORMATVERSIONS,u=(n=r.KEYFORMAT)!=null?n:"identity";a&&r.IV&&!c&&Pe.error(`Invalid IV: ${r.IV}`);const h=a?zt.resolve(a,e):"",f=(l||"1").split("/").map(Number).filter(Number.isFinite);return new di(o,h,u,f,c,r.KEYID)}function lu(s){const t=new Ue(s).decimalFloatingPoint("TIME-OFFSET");return ie(t)?t:null}function cu(s,e){let t=(s||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const n=t.filter(r=>kl(r,i));n.length&&(e[`${i}Codec`]=n.map(r=>r.split("/")[0]).join(","),t=t.filter(r=>n.indexOf(r)===-1))}),e.unknownCodecs=t}function uu(s,e,t){const i=e[t];i&&(s[t]=i)}function a3(s,e){let t=s[e];for(let i=e;i--;){const n=s[i];if(!n)return;n.programDateTime=t.programDateTime-n.duration*1e3,t=n}}function Ja(s,e,t){s.rawProgramDateTime?t.push(s):e!=null&&e.programDateTime&&(s.programDateTime=e.endProgramDateTime)}function hu(s,e,t,i){s.relurl=e.URI,e.BYTERANGE&&s.setByteRange(e.BYTERANGE),s.level=t,s.sn="initSegment",i&&(s.levelkeys=i),s.initSegment=null}function du(s,e,t){s.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(n=>e[n].isCommonEncryption)&&i.push(s)}function si(s,e,t){s.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function fu(s,e,t){s.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function Uo(s,e){const t=e.startPTS;if(ie(t)){let i=0,n;e.sn>s.sn?(i=t-s.start,n=s):(i=s.start-t,n=e),n.duration!==i&&n.setDuration(i)}else e.sn>s.sn?s.cc===e.cc&&s.minEndPTS?e.setStart(s.start+(s.minEndPTS-s.start)):e.setStart(s.start+s.duration):e.setStart(Math.max(s.start-e.duration,0))}function i0(s,e,t,i,n,r,o){i-t<=0&&(o.warn("Fragment should have a positive duration",e),i=t+e.duration,r=n+e.duration);let c=t,l=i;const u=e.startPTS,h=e.endPTS;if(ie(u)){const v=Math.abs(u-t);s&&v>s.totalduration?o.warn(`media timestamps and playlist times differ by ${v}s for level ${e.level} ${s.url}`):ie(e.deltaPTS)?e.deltaPTS=Math.max(v,e.deltaPTS):e.deltaPTS=v,c=Math.max(t,u),t=Math.min(t,u),n=e.startDTS!==void 0?Math.min(n,e.startDTS):n,l=Math.min(i,h),i=Math.max(i,h),r=e.endDTS!==void 0?Math.max(r,e.endDTS):r}const f=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=c,e.startDTS=n,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const m=e.sn;if(!s||m<s.startSN||m>s.endSN)return 0;let p;const g=m-s.startSN,y=s.fragments;for(y[g]=e,p=g;p>0;p--)Uo(y[p],y[p-1]);for(p=g;p<y.length-1;p++)Uo(y[p],y[p+1]);return s.fragmentHint&&Uo(y[y.length-1],s.fragmentHint),s.PTSKnown=s.alignedSliding=!0,f}function l3(s,e,t){if(s===e)return;let i=null;const n=s.fragments;for(let u=n.length-1;u>=0;u--){const h=n[u].initSegment;if(h){i=h;break}}s.fragmentHint&&delete s.fragmentHint.endPTS;let r;h3(s,e,(u,h,f,m)=>{if((!e.startCC||e.skippedSegments)&&h.cc!==u.cc){const p=u.cc-h.cc;for(let g=f;g<m.length;g++)m[g].cc+=p;e.endCC=m[m.length-1].cc}ie(u.startPTS)&&ie(u.endPTS)&&(h.setStart(h.startPTS=u.startPTS),h.startDTS=u.startDTS,h.maxStartPTS=u.maxStartPTS,h.endPTS=u.endPTS,h.endDTS=u.endDTS,h.minEndPTS=u.minEndPTS,h.setDuration(u.endPTS-u.startPTS),h.duration&&(r=h),e.PTSKnown=e.alignedSliding=!0),u.hasStreams&&(h.elementaryStreams=u.elementaryStreams),h.loader=u.loader,u.hasStats&&(h.stats=u.stats),u.initSegment&&(h.initSegment=u.initSegment,i=u.initSegment)});const o=e.fragments,a=e.fragmentHint?o.concat(e.fragmentHint):o;if(i&&a.forEach(u=>{var h;u&&(!u.initSegment||u.initSegment.relurl===((h=i)==null?void 0:h.relurl))&&(u.initSegment=i)}),e.skippedSegments){if(e.deltaUpdateFailed=o.some(u=>!u),e.deltaUpdateFailed){t.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let u=e.skippedSegments;u--;)o.shift();e.startSN=o[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=c3(s.dateRanges,e,t));const u=s.fragments.filter(h=>h.rawProgramDateTime);if(s.hasProgramDateTime&&!e.hasProgramDateTime)for(let h=1;h<a.length;h++)a[h].programDateTime===null&&Ja(a[h],a[h-1],u);t0(u,e)}e.endCC=o[o.length-1].cc}if(!e.startCC){var c;const u=r0(s,e.startSN-1);e.startCC=(c=u?.cc)!=null?c:o[0].cc}u3(s.partList,e.partList,(u,h)=>{h.elementaryStreams=u.elementaryStreams,h.stats=u.stats}),r?i0(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS,t):n0(s,e),o.length&&(e.totalduration=e.edge-o[0].start),e.driftStartTime=s.driftStartTime,e.driftStart=s.driftStart;const l=e.advancedDateTime;if(e.advanced&&l){const u=e.edge;e.driftStart||(e.driftStartTime=l,e.driftStart=u),e.driftEndTime=l,e.driftEnd=u}else e.driftEndTime=s.driftEndTime,e.driftEnd=s.driftEnd,e.advancedDateTime=s.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=s.requestScheduled)}function c3(s,e,t){const{dateRanges:i,recentlyRemovedDateranges:n}=e,r=De({},s);n&&n.forEach(c=>{delete r[c]});const a=Object.keys(r).length;return a?(Object.keys(i).forEach(c=>{const l=r[c],u=new zl(i[c].attr,l);u.isValid?(r[c]=u,l||(u.tagOrder+=a)):t.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${ke(i[c].attr)}"`)}),r):i}function u3(s,e,t){if(s&&e){let i=0;for(let n=0,r=s.length;n<=r;n++){const o=s[n],a=e[n+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function h3(s,e,t){const i=e.skippedSegments,n=Math.max(s.startSN,e.startSN)-e.startSN,r=(s.fragmentHint?1:0)+(i?e.endSN:Math.min(s.endSN,e.endSN))-e.startSN,o=e.startSN-s.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,c=s.fragmentHint?s.fragments.concat(s.fragmentHint):s.fragments;for(let l=n;l<=r;l++){const u=c[o+l];let h=a[l];if(i&&!h&&u&&(h=e.fragments[l]=u),u&&h){t(u,h,l,a);const f=u.relurl,m=h.relurl;if(f&&d3(f,m)){e.playlistParsingError=mu(`media sequence mismatch ${h.sn}:`,s,e,u,h);return}else if(u.cc!==h.cc){e.playlistParsingError=mu(`discontinuity sequence mismatch (${u.cc}!=${h.cc})`,s,e,u,h);return}}}}function mu(s,e,t,i,n){return new Error(`${s} ${n.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function n0(s,e,t=!0){const i=e.startSN+e.skippedSegments-s.startSN,n=s.fragments,r=i>=0;let o=0;if(r&&i<n.length)o=n[i].start;else if(r&&e.startSN===s.endSN+1)o=s.fragmentEnd;else if(r&&t)o=s.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=s.fragmentStart;else return;qa(e,o)}function qa(s,e){if(e){const t=s.fragments;for(let i=s.skippedSegments;i<t.length;i++)t[i].addStart(e);s.fragmentHint&&s.fragmentHint.addStart(e)}}function s0(s,e=1/0){let t=1e3*s.targetduration;if(s.updated){const i=s.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function r0(s,e,t){if(!s)return null;let i=s.fragments[e-s.startSN];return i||(i=s.fragmentHint,i&&i.sn===e)?i:e<s.startSN&&t&&t.sn===e?t:null}function pu(s,e,t){return s?o0(s.partList,e,t):null}function o0(s,e,t){if(s)for(let i=s.length;i--;){const n=s[i];if(n.index===t&&n.fragment.sn===e)return n}return null}function a0(s){s.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(n=>{n.level=t,n.initSegment&&(n.initSegment.level=t)})})}function d3(s,e){return s!==e&&e?gu(s)!==gu(e):!1}function gu(s){return s.replace(/\?[^?]*$/,"")}function os(s,e){for(let i=0,n=s.length;i<n;i++){var t;if(((t=s[i])==null?void 0:t.cc)===e)return s[i]}return null}function f3(s,e){return!!(s&&e.startCC<s.endCC&&e.endCC>s.startCC)}function yu(s,e){const t=s.start+e;s.startPTS=t,s.setStart(t),s.endPTS=t+s.duration}function l0(s,e){const t=e.fragments;for(let i=0,n=t.length;i<n;i++)yu(t[i],s);e.fragmentHint&&yu(e.fragmentHint,s),e.alignedSliding=!0}function m3(s,e){s&&(c0(e,s),e.alignedSliding||Gr(e,s),!e.alignedSliding&&!e.skippedSegments&&n0(s,e,!1))}function c0(s,e){if(!f3(e,s))return;const t=Math.min(e.endCC,s.endCC),i=os(e.fragments,t),n=os(s.fragments,t);if(!i||!n)return;Pe.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const r=i.start-n.start;l0(r,s)}function Gr(s,e){if(!s.hasProgramDateTime||!e.hasProgramDateTime)return;const t=s.fragments,i=e.fragments;if(!t.length||!i.length)return;let n,r;const o=Math.min(e.endCC,s.endCC);e.startCC<o&&s.startCC<o&&(n=os(i,o),r=os(t,o)),(!n||!r)&&(n=i[Math.floor(i.length/2)],r=os(t,n.cc)||t[Math.floor(t.length/2)]);const a=n.programDateTime,c=r.programDateTime;if(!a||!c)return;const l=(c-a)/1e3-(r.start-n.start);l0(l,s)}function mt(s,e,t){Et(s,e,t),s.addEventListener(e,t)}function Et(s,e,t){s.removeEventListener(e,t)}const p3={toString:function(s){let e="";const t=s.length;for(let i=0;i<t;i++)e+=`[${s.start(i).toFixed(3)}-${s.end(i).toFixed(3)}]`;return e}},q={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class eo extends Yf{constructor(e,t,i,n,r){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=q.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:o,fragCurrent:a,media:c,mediaBuffer:l,state:u}=this,h=c?c.currentTime:0,f=pe.bufferInfo(l||c,h,o.maxBufferHole),m=!f.len;if(this.log(`Media seeking to ${ie(h)?h.toFixed(3):h}, state: ${u}, ${m?"out of":"in"} buffer`),this.state===q.ENDED)this.resetLoadingState();else if(a){const p=o.maxFragLookUpTolerance,g=a.start-p,y=a.start+a.duration+p;if(m||y<f.start||g>f.end){const v=h>y;(h<g||v)&&(v&&a.loader&&(this.log(`Cancelling fragment load for seek (sn: ${a.sn})`),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(c){this.fragmentTracker.removeFragmentsInRange(h,1/0,this.playlistType,!0);const p=this.lastCurrentTime;if(h>p&&(this.lastCurrentTime=h),!this.loadingParts){const g=Math.max(f.end,h),y=this.shouldLoadParts(this.getLevelDetails(),g);y&&(this.log(`LL-Part loading ON after seeking to ${h.toFixed(2)} with buffer @${g.toFixed(2)}`),this.loadingParts=y)}}this.hls.hasEnoughToStart||(this.log(`Setting ${m?"startPosition":"nextLoadPosition"} to ${h} for seek without enough to start`),this.nextLoadPosition=h,m&&(this.startPosition=h)),m&&this.state===q.IDLE&&this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new Ky(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Ul(e.config)}registerListeners(){const{hls:e}=this;e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(S.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(S.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===q.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=q.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,n=this.config.timelineOffset||0;if(i<=n)return!1;const r=e.buffered;this.config.maxBufferHole&&r&&r.length>1&&(e=pe.bufferedInfo(r,e.start,0));const o=e.nextStart;if(o&&o>n&&o<t.edge||this.media.currentTime<e.start)return!1;const c=t.partList;if(c!=null&&c.length){const u=c[c.length-1];return pe.isBuffered(this.media,u.start+u.duration/2)}const l=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;mt(i,"seeking",this.onMediaSeeking),mt(i,"ended",this.onMediaEnded);const n=this.config;this.levels&&n.autoStartLoad&&this.state===q.STOPPED&&this.startLoad(n.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(n!==null){if(n.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),Et(n,"seeking",this.onMediaSeeking),Et(n,"ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=q.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const n=r=>{const o=r.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${r.part?" part: "+r.part.index:""} of ${this.fragInfo(o,!1,r.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,n).then(r=>{if(!r)return;const o=this.state,a=r.frag;if(this.fragContextChanged(a)){(o===q.FRAG_LOADING||!this.fragCurrent&&o===q.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=q.IDLE);return}"payload"in r&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(S.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===q.STOPPED||this.state===q.ERROR||(this.warn(`Frag error: ${r?.message||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===et.APPENDING){const r=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,r),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),c=this.backtrackFragment;((c?e.sn-c.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===et.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return t?.live&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(S.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const n=i?.frag;if(!n||this.fragContextChanged(n)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:n}=this,{frag:r,payload:o}=i,a=r.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&Rn(a.method)){const c=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,Gl(a.method)).catch(l=>{throw n.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:r}),l}).then(l=>{const u=self.performance.now();return n.trigger(S.FRAG_DECRYPTED,{frag:r,payload:l,stats:{tstart:c,tdecrypt:u}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===q.STOPPED||this.state===q.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==q.STOPPED&&(this.state=q.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(e,t){var i,n;const r=e.tracks;if(r&&!t.encrypted&&((i=r.audio)!=null&&i.encrypted||(n=r.video)!=null&&n.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const o=this.media,a=new Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${o?"attached mediaKeys: "+o.mediaKeys:"detached"})`);return this.warn(a.message),!o||o.mediaKeys?!1:(this.hls.trigger(S.ERROR,{type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_NO_KEYS,fatal:!1,error:a,frag:t}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?p3.toString(pe.getBuffered(i)):"(detached)"})`),Ke(e)){var n;if(e.type!==se.SUBTITLE){const o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=q.IDLE;return}}const r=(n=this.levels)==null?void 0:n[e.level];r!=null&&r.fragmentError&&(this.log(`Resetting level fragment error count of ${r.fragmentError} on frag buffered`),r.fragmentError=0)}this.state=q.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:r}=e,o=!r||r.length===0||r.some(c=>!c),a=new Zr(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var r;this.fragCurrent=e;const o=t.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;if(e.encrypted&&!((r=e.decryptdata)!=null&&r.key)){if(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=q.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(f=>{if(!this.fragContextChanged(f.frag))return this.hls.trigger(S.KEY_LOADED,f),this.state===q.KEY_LOADING&&(this.state=q.IDLE),f}),this.hls.trigger(S.KEY_LOADING,{frag:e}),this.fragCurrent===null)return this.log("context changed in KEY_LOADING"),Promise.resolve(null)}else e.encrypted||(a=this.keyLoader.loadClear(e,o.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired"));const c=this.fragPrevious;if(Ke(e)&&(!c||e.sn!==c.sn)){const f=this.shouldLoadParts(t.details,e.end);f!==this.loadingParts&&(this.log(`LL-Part loading ${f?"ON":"OFF"} loading sn ${c?.sn}->${e.sn}`),this.loadingParts=f)}if(i=Math.max(e.start,i||0),this.loadingParts&&Ke(e)){const f=o.partList;if(f&&n){i>o.fragmentEnd&&o.fragmentHint&&(e=o.fragmentHint);const m=this.getNextPart(f,e,i);if(m>-1){const p=f[m];e=this.fragCurrent=p.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${p.index} (${m}/${f.length-1}) of ${this.fragInfo(e,!1,p)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=p.start+p.duration,this.state=q.FRAG_LOADING;let g;return a?g=a.then(y=>!y||this.fragContextChanged(y.frag)?null:this.doFragPartsLoad(e,p,t,n)).catch(y=>this.handleFragLoadError(y)):g=this.doFragPartsLoad(e,p,t,n).catch(y=>this.handleFragLoadError(y)),this.hls.trigger(S.FRAG_LOADING,{frag:e,part:p,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(f,i))return Promise.resolve(null)}}if(Ke(e)&&this.loadingParts){var l;this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${(l=o.partList)==null?void 0:l.filter(f=>f.loaded).map(f=>`[${f.start}-${f.end}]`)}`),this.loadingParts=!1}else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${"["+o.startSN+"-"+o.endSN+"]"}, target: ${parseFloat(i.toFixed(3))}`),ie(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=q.FRAG_LOADING;const u=this.config.progressive&&e.type!==se.SUBTITLE;let h;return u&&a?h=a.then(f=>!f||this.fragContextChanged(f.frag)?null:this.fragmentLoader.load(e,n)).catch(f=>this.handleFragLoadError(f)):h=Promise.all([this.fragmentLoader.load(e,u?n:void 0),a]).then(([f])=>(!u&&n&&n(f),f)).catch(f=>this.handleFragLoadError(f)),this.hls.trigger(S.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(e,t,i,n){return new Promise((r,o)=>{var a;const c=[],l=(a=i.details)==null?void 0:a.partList,u=h=>{this.fragmentLoader.loadPart(e,h,n).then(f=>{c[h.index]=f;const m=f.part;this.hls.trigger(S.FRAG_LOADED,f);const p=pu(i.details,e.sn,h.index+1)||o0(l,e.sn,h.index+1);if(p)u(p);else return r({frag:e,part:m,partsLoaded:c})}).catch(o)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;t.frag&&t.details===V.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):t.frag&&t.type===ae.KEY_SYSTEM_ERROR?(t.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(t.frag)):this.hls.trigger(S.ERROR,t)}else this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==q.PARSING){!this.fragCurrent&&this.state!==q.STOPPED&&this.state!==q.ERROR&&(this.state=q.IDLE);return}const{frag:i,part:n,level:r}=t,o=self.performance.now();i.stats.parsing.end=o,n&&(n.stats.parsing.end=o);const a=this.getLevelDetails(),l=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);l!==this.loadingParts&&(this.log(`LL-Part loading ${l?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=l),this.updateLevelTiming(i,n,r,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){var i;const r=e.partList[0];if(r.fragment.type===se.SUBTITLE)return!1;const o=r.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var n;if((this.hls.hasEnoughToStart?((n=this.media)==null?void 0:n.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:r,part:o}=e;if(!(t!=null&&t[n]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${n}. The current chunk will not be buffered.`),null;const a=t[n],c=a.details,l=o>-1?pu(c,r,o):null,u=l?l.fragment:r0(c,r,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:l,level:a}):null}bufferFragmentData(e,t,i,n,r){if(this.state!==q.PARSING)return;const{data1:o,data2:a}=e;let c=o;if(a&&(c=Dt(o,a)),!c.length)return;const l=this.initPTS[t.cc],u=l?-l.baseTime/l.timescale:void 0,h={type:e.type,frag:t,part:i,chunkMeta:n,offset:u,parent:t.type,data:c};if(this.hls.trigger(S.BUFFER_APPENDING,h),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!pe.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,n=pe.bufferInfo(t,i,0),r=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),a=Math.max(Math.min(e.start-o,n.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const n=this.getLoadPosition();if(!ie(n))return null;const o=this.lastCurrentTime>n||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,o)}getFwdBufferInfoAtPos(e,t,i,n){const r=pe.bufferInfo(e,t,n);if(r.len===0&&r.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(r.nextStart<=o.end||o.gap)){const a=Math.max(Math.min(r.nextStart,o.end)-t,n);return pe.bufferInfo(e,t,a)}}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,n=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,n);return r>=n?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=se.MAIN){const i=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:r}=this,o=i[0].start,a=r.lowLatencyMode&&!!t.partList;let c=null;if(t.live){const h=r.initialLiveManifestSize;if(n<h)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${h})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),c=this.getInitialLiveFragment(t);const f=this.hls.startPosition,m=this.hls.liveSyncPosition,p=c?(f!==-1&&f>=o?f:m)||c.start:e;this.log(`Setting startPosition to ${p} to match start frag at live edge. mainStart: ${f} liveSyncPosition: ${m} frag.start: ${(l=c)==null?void 0:l.start}`),this.startPosition=this.nextLoadPosition=p}}else e<=o&&(c=i[0]);if(!c){const h=this.loadingParts?t.partEnd:t.fragmentEnd;c=this.getFragmentAtPosition(e,h,t)}let u=this.filterReplacedPrimary(c,t);if(!u&&c){const h=c.sn-t.startSN;u=this.filterReplacedPrimary(i[h+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===et.OK||i===et.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,r){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n,0);if(a!==null&&i.len+a.len>=r){const c=o.sn;return this.loopSn!==c&&(this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${c}`),this.loopSn=c),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(vu(this.config)){var e;if((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null?void 0:e.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(vu(this.config)&&e.type!==se.SUBTITLE){const i=this.hls.interstitialsManager,n=i?.bufferingItem;if(n){const o=n.event;if(o){if(o.appendInPlace||Math.abs(e.start-n.start)>1||n.start===0)return null}else if(e.end<=n.start&&t?.live===!1||e.start>n.end&&n.nextEvent&&(n.nextEvent.appendInPlace||e.start-n.end>1))return null}const r=i?.playerQueue;if(r)for(let o=r.length;o--;){const a=r[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let n=-1,r=!1,o=!0;for(let a=0,c=e.length;a<c;a++){const l=e[a];if(o=o&&!l.independent,n>-1&&i<l.start)break;const u=l.loaded;u?n=-1:(r||(l.independent||o)&&l.fragment===t)&&(l.fragment!==t&&this.warn(`Need buffer at ${i} but next unloaded part starts at ${l.start}`),n=a),r=u}return n}loadedEndOfParts(e,t){let i;for(let n=e.length;n--;){if(i=e[n],!i.loaded)return!1;if(t>i.start)return!0}return!1}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=Dy(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const o=t[r-e.startSN];i.cc===o.cc&&(n=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=Vf(e,i.cc,i.end),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(n=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:r}=this,{fragments:o,endSN:a}=i;const{fragmentHint:c}=i,{maxFragLookUpTolerance:l}=n,u=i.partList,h=!!(this.loadingParts&&u!=null&&u.length&&c);h&&!this.bitrateTest&&u[u.length-1].fragment.sn===c.sn&&(o=o.concat(c),a=c.sn);let f;if(e<t){var m;const g=e<this.lastCurrentTime||e>t-l||(m=this.media)!=null&&m.paused||!this.startFragRequested?0:l;f=Zi(r,o,e,g)}else f=o[o.length-1];if(f){const p=f.sn-i.startSN,g=this.fragmentTracker.getState(f);if((g===et.OK||g===et.PARTIAL&&f.gap)&&(r=f),r&&f.sn===r.sn&&(!h||u[0].fragment.sn>f.sn||!i.live)&&f.level===r.level){const v=o[p+1];f.sn<a&&this.fragmentTracker.getState(v)!==et.OK?f=v:f=null}}return f}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const r=e.fragmentStart,o=!t,a=e.alignedSliding&&ie(r);if(o||!a&&!r){m3(i,e);const c=e.fragmentStart;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),c}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const n=this.timelineOffset;if(i===-1){const r=this.startTimeOffset!==null,o=r?this.startTimeOffset:e.startTimeOffset;o!==null&&ie(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${r?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+n}this.nextLoadPosition=i+n}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Ke(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==q.FRAG_LOADING_WAITING_RETRY)&&(this.state=q.IDLE)}onFragmentOrKeyLoadError(e,t){var i;if(t.chunkMeta&&!t.frag){const v=this.getCurrentContext(t.chunkMeta);v&&(t.frag=v.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;if(this.fragContextChanged(n)){var r;this.warn(`Frag load error must match current frag to retry ${n.url} > ${(r=this.fragCurrent)==null?void 0:r.url}`);return}const o=t.details===V.FRAG_GAP;o&&this.fragmentTracker.fragBuffered(n,!0);const a=t.errorAction;if(!a){this.state=q.ERROR;return}const{action:c,flags:l,retryCount:u=0,retryConfig:h}=a,f=!!h,m=f&&c===qe.RetryRequest,p=f&&!a.resolved&&l===vt.MoveAllAlternatesMatchingHost,g=(i=this.hls.latestLevelDetails)==null?void 0:i.live;if(!m&&p&&Ke(n)&&!n.endList&&g&&!Wf(t))this.resetFragmentErrors(e),this.treatAsGap(n),a.resolved=!0;else if((m||p)&&u<h.maxNumRetry){var y;const v=Xa((y=t.response)==null?void 0:y.code),E=Nl(h,u);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+E,this.state=q.FRAG_LOADING_WAITING_RETRY,a.resolved=!0,v){this.log("Waiting for connection (offline)"),this.retryDate=1/0,t.reason="offline";return}this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${u+1}/${h.maxNumRetry} in ${E}ms`)}else if(h)if(this.resetFragmentErrors(e),u<h.maxNumRetry)!o&&c!==qe.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${u})`);return}else c===qe.SendAlternateToPenaltyBox?this.state=q.WAITING_LEVEL:this.state=q.ERROR;this.tickImmediate()}checkRetryDate(){const e=self.performance.now(),t=this.retryDate,i=t===1/0;(!t||e>=t||i&&!Xa(0))&&(i&&this.log("Connection restored (online)"),this.resetStartWhenNotLoaded(),this.state=q.IDLE)}reduceLengthAndFlushBuffer(e){if(this.state===q.PARSING||this.state===q.PARSED){const t=e.frag,i=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,i),r=n&&n.len>.5;r&&this.reduceMaxBufferLength(n.len,t?.duration||10);const o=!r;return o&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===se.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==q.STOPPED&&(this.state=q.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const n=pe.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===q.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==q.STOPPED&&(this.state=q.IDLE)}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const e=this.levelLastLoaded,t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.log(`Loading context changed while buffering sn ${e.sn} of ${this.playlistLabel()} ${e.level===-1?"<removed>":e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){const r=i.details;if(!r){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((c,l)=>{const u=e.elementaryStreams[l];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${l} duration reliably (${h})`),c||!1;const f=n?0:i0(r,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS,this);return this.hls.trigger(S.LEVEL_PTS_UPDATED,{details:r,level:i,drift:f,type:l,frag:e,start:u.startPTS,end:u.endPTS}),!0}return c},!1)){var a;const c=((a=this.transmuxer)==null?void 0:a.error)===null;if((i.fragmentError===0||c&&(i.fragmentError<2||e.endList))&&this.treatAsGap(e,i),c){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=q.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(S.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===se.MAIN?"level":"track"}fragInfo(e,t=!0,i){var n,r;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((n=t&&!i?e.startPTS:(i||e).start)!=null?n:NaN).toFixed(3)}-${((r=t&&!i?e.endPTS:(i||e).end)!=null?r:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function vu(s){return!!s.interstitialsController&&s.enableInterstitialPlayback!==!1}class u0{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=g3(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function g3(s,e){const t=new Uint8Array(e);let i=0;for(let n=0;n<s.length;n++){const r=s[n];t.set(r,i),i+=r.length}return t}var zo={exports:{}},xu;function y3(){return xu||(xu=1,(function(s){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function n(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function r(c,l,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var m=new n(u,h||c,f),p=t?t+l:l;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],m]:c._events[p].push(m):(c._events[p]=m,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new i:delete c._events[l]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,h;if(this._eventsCount===0)return l;for(h in u=this._events)e.call(u,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=t?t+l:l,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,m=h.length,p=new Array(m);f<m;f++)p[f]=h[f].fn;return p},a.prototype.listenerCount=function(l){var u=t?t+l:l,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,u,h,f,m,p){var g=t?t+l:l;if(!this._events[g])return!1;var y=this._events[g],v=arguments.length,E,x;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),v){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,u),!0;case 3:return y.fn.call(y.context,u,h),!0;case 4:return y.fn.call(y.context,u,h,f),!0;case 5:return y.fn.call(y.context,u,h,f,m),!0;case 6:return y.fn.call(y.context,u,h,f,m,p),!0}for(x=1,E=new Array(v-1);x<v;x++)E[x-1]=arguments[x];y.fn.apply(y.context,E)}else{var T=y.length,A;for(x=0;x<T;x++)switch(y[x].once&&this.removeListener(l,y[x].fn,void 0,!0),v){case 1:y[x].fn.call(y[x].context);break;case 2:y[x].fn.call(y[x].context,u);break;case 3:y[x].fn.call(y[x].context,u,h);break;case 4:y[x].fn.call(y[x].context,u,h,f);break;default:if(!E)for(A=1,E=new Array(v-1);A<v;A++)E[A-1]=arguments[A];y[x].fn.apply(y[x].context,E)}}return!0},a.prototype.on=function(l,u,h){return r(this,l,u,h,!1)},a.prototype.once=function(l,u,h){return r(this,l,u,h,!0)},a.prototype.removeListener=function(l,u,h,f){var m=t?t+l:l;if(!this._events[m])return this;if(!u)return o(this,m),this;var p=this._events[m];if(p.fn)p.fn===u&&(!f||p.once)&&(!h||p.context===h)&&o(this,m);else{for(var g=0,y=[],v=p.length;g<v;g++)(p[g].fn!==u||f&&!p[g].once||h&&p[g].context!==h)&&y.push(p[g]);y.length?this._events[m]=y.length===1?y[0]:y:o(this,m)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&o(this,u)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,s.exports=a})(zo)),zo.exports}var v3=y3(),Kl=W2(v3);const fs="1.6.15",Fn={};function x3(){return typeof __HLS_WORKER_BUNDLE__=="function"}function E3(){const s=Fn[fs];if(s)return s.clientCount++,s;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),n={worker:new self.Worker(t),objectURL:t,clientCount:1};return Fn[fs]=n,n}function A3(s){const e=Fn[s];if(e)return e.clientCount++,e;const t=new self.URL(s,self.location.href).href,n={worker:new self.Worker(t),scriptURL:t,clientCount:1};return Fn[s]=n,n}function S3(s){const e=Fn[s||fs];if(e&&e.clientCount--===1){const{worker:i,objectURL:n}=e;delete Fn[s||fs],n&&self.URL.revokeObjectURL(n),i.terminate()}}function h0(s,e){return e+10<=s.length&&s[e]===51&&s[e+1]===68&&s[e+2]===73&&s[e+3]<255&&s[e+4]<255&&s[e+6]<128&&s[e+7]<128&&s[e+8]<128&&s[e+9]<128}function Vl(s,e){return e+10<=s.length&&s[e]===73&&s[e+1]===68&&s[e+2]===51&&s[e+3]<255&&s[e+4]<255&&s[e+6]<128&&s[e+7]<128&&s[e+8]<128&&s[e+9]<128}function to(s,e){let t=0;return t=(s[e]&127)<<21,t|=(s[e+1]&127)<<14,t|=(s[e+2]&127)<<7,t|=s[e+3]&127,t}function ms(s,e){const t=e;let i=0;for(;Vl(s,e);){i+=10;const n=to(s,e+6);i+=n,h0(s,e+10)&&(i+=10),e+=i}if(i>0)return s.subarray(t,t+i)}function T3(s,e,t,i){const n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=e[t+2],o=r>>2&15;if(o>12){const m=new Error(`invalid ADTS sampling index:${o}`);s.emit(S.ERROR,S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_PARSING_ERROR,fatal:!0,error:m,reason:m.message});return}const a=(r>>6&3)+1,c=e[t+3]>>6&3|(r&1)<<2,l="mp4a.40."+a,u=n[o];let h=o;(a===5||a===29)&&(h-=3);const f=[a<<3|(h&14)>>1,(h&1)<<7|c<<3];return Pe.log(`manifest codec:${i}, parsed codec:${l}, channels:${c}, rate:${u} (ADTS object type:${a} sampling index:${o})`),{config:f,samplerate:u,channelCount:c,codec:l,parsedCodec:l,manifestCodec:i}}function d0(s,e){return s[e]===255&&(s[e+1]&246)===240}function f0(s,e){return s[e+1]&1?7:9}function jl(s,e){return(s[e+3]&3)<<11|s[e+4]<<3|(s[e+5]&224)>>>5}function b3(s,e){return e+5<s.length}function $r(s,e){return e+1<s.length&&d0(s,e)}function C3(s,e){return b3(s,e)&&d0(s,e)&&jl(s,e)<=s.length-e}function R3(s,e){if($r(s,e)){const t=f0(s,e);if(e+t>=s.length)return!1;const i=jl(s,e);if(i<=t)return!1;const n=e+i;return n===s.length||$r(s,n)}return!1}function m0(s,e,t,i,n){if(!s.samplerate){const r=T3(e,t,i,n);if(!r)return;De(s,r)}}function p0(s){return 1024*9e4/s}function w3(s,e){const t=f0(s,e);if(e+t<=s.length){const i=jl(s,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function g0(s,e,t,i,n){const r=p0(s.samplerate),o=i+n*r,a=w3(e,t);let c;if(a){const{frameLength:h,headerLength:f}=a,m=f+h,p=Math.max(0,t+m-e.length);p?(c=new Uint8Array(m-f),c.set(e.subarray(t+f,e.length),0)):c=e.subarray(t+f,t+m);const g={unit:c,pts:o};return p||s.samples.push(g),{sample:g,length:m,missing:p}}const l=e.length-t;return c=new Uint8Array(l),c.set(e.subarray(t,e.length),0),{sample:{unit:c,pts:o},length:l,missing:-1}}function I3(s,e){return Vl(s,e)&&to(s,e+6)+10<=s.length-e}function _3(s){return s instanceof ArrayBuffer?s:s.byteOffset==0&&s.byteLength==s.buffer.byteLength?s.buffer:new Uint8Array(s).buffer}function Go(s,e=0,t=1/0){return L3(s,e,t,Uint8Array)}function L3(s,e,t,i){const n=P3(s);let r=1;"BYTES_PER_ELEMENT"in i&&(r=i.BYTES_PER_ELEMENT);const o=M3(s)?s.byteOffset:0,a=(o+s.byteLength)/r,c=(o+e)/r,l=Math.floor(Math.max(0,Math.min(c,a))),u=Math.floor(Math.min(l+Math.max(t,0),a));return new i(n,l,u-l)}function P3(s){return s instanceof ArrayBuffer?s:s.buffer}function M3(s){return s&&s.buffer instanceof ArrayBuffer&&s.byteLength!==void 0&&s.byteOffset!==void 0}function D3(s){const e={key:s.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(s.size<2)return;if(s.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=s.data.subarray(1).indexOf(0);if(i===-1)return;const n=_t(Go(s.data,1,i)),r=s.data[2+i],o=s.data.subarray(3+i).indexOf(0);if(o===-1)return;const a=_t(Go(s.data,3+i,o));let c;return n==="-->"?c=_t(Go(s.data,4+i+o)):c=_3(s.data.subarray(4+i+o)),e.mimeType=n,e.pictureType=r,e.description=a,e.data=c,e}function B3(s){if(s.size<2)return;const e=_t(s.data,!0),t=new Uint8Array(s.data.subarray(e.length+1));return{key:s.type,info:e,data:t.buffer}}function F3(s){if(s.size<2)return;if(s.type==="TXXX"){let t=1;const i=_t(s.data.subarray(t),!0);t+=i.length+1;const n=_t(s.data.subarray(t));return{key:s.type,info:i,data:n}}const e=_t(s.data.subarray(1));return{key:s.type,info:"",data:e}}function k3(s){if(s.type==="WXXX"){if(s.size<2)return;let t=1;const i=_t(s.data.subarray(t),!0);t+=i.length+1;const n=_t(s.data.subarray(t));return{key:s.type,info:i,data:n}}const e=_t(s.data);return{key:s.type,info:"",data:e}}function O3(s){return s.type==="PRIV"?B3(s):s.type[0]==="W"?k3(s):s.type==="APIC"?D3(s):F3(s)}function N3(s){const e=String.fromCharCode(s[0],s[1],s[2],s[3]),t=to(s,4),i=10;return{type:e,size:t,data:s.subarray(i,i+t)}}const Us=10,U3=10;function y0(s){let e=0;const t=[];for(;Vl(s,e);){const i=to(s,e+6);s[e+5]>>6&1&&(e+=Us),e+=Us;const n=e+i;for(;e+U3<n;){const r=N3(s.subarray(e)),o=O3(r);o&&t.push(o),e+=r.size+Us}h0(s,e)&&(e+=Us)}return t}function v0(s){return s&&s.key==="PRIV"&&s.info==="com.apple.streaming.transportStreamTimestamp"}function z3(s){if(s.data.byteLength===8){const e=new Uint8Array(s.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function Wl(s){const e=y0(s);for(let t=0;t<e.length;t++){const i=e[t];if(v0(i))return z3(i)}}let xt=(function(s){return s.audioId3="org.id3",s.dateRange="com.apple.quicktime.HLS",s.emsg="https://aomedia.org/emsg/ID3",s.misbklv="urn:misb:KLV:bin:1910.1",s})({});function Jt(s="",e=9e4){return{type:s,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class Xl{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Dt(this.cachedData,e),this.cachedData=null);let i=ms(e,0),n=i?i.length:0,r;const o=this._audioTrack,a=this._id3Track,c=i?Wl(i):void 0,l=e.length;for((this.basePTS===null||this.frameIndex===0&&ie(c))&&(this.basePTS=G3(c,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:xt.audioId3,duration:Number.POSITIVE_INFINITY});n<l;){if(this.canParse(e,n)){const u=this.appendFrame(o,e,n);u?(this.frameIndex++,this.lastPTS=u.sample.pts,n+=u.length,r=n):n=l}else I3(e,n)?(i=ms(e,n),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:xt.audioId3,duration:Number.POSITIVE_INFINITY}),n+=i.length,r=n):n++;if(n===l&&r!==l){const u=e.slice(r);this.cachedData?this.cachedData=Dt(this.cachedData,u):this.cachedData=u}}return{audioTrack:o,videoTrack:Jt(),id3Track:a,textTrack:Jt()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Jt(),id3Track:this._id3Track,textTrack:Jt()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const G3=(s,e,t)=>{if(ie(s))return s*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let zs=null;const $3=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],H3=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],K3=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],V3=[0,1,1,4];function x0(s,e,t,i,n){if(t+24>e.length)return;const r=E0(e,t);if(r&&t+r.frameLength<=e.length){const o=r.samplesPerFrame*9e4/r.sampleRate,a=i+n*o,c={unit:e.subarray(t,t+r.frameLength),pts:a,dts:a};return s.config=[],s.channelCount=r.channelCount,s.samplerate=r.sampleRate,s.samples.push(c),{sample:c,length:r.frameLength,missing:0}}}function E0(s,e){const t=s[e+1]>>3&3,i=s[e+1]>>1&3,n=s[e+2]>>4&15,r=s[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&r!==3){const o=s[e+2]>>1&1,a=s[e+3]>>6,c=t===3?3-i:i===3?3:4,l=$3[c*14+n-1]*1e3,h=H3[(t===3?0:t===2?1:2)*3+r],f=a===3?1:2,m=K3[t][i],p=V3[i],g=m*8*p,y=Math.floor(m*l/h+o)*p;if(zs===null){const x=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);zs=x?parseInt(x[1]):0}return!!zs&&zs<=87&&i===2&&l>=224e3&&a===0&&(s[e+3]=s[e+3]|128),{sampleRate:h,channelCount:f,frameLength:y,samplesPerFrame:g}}}function Yl(s,e){return s[e]===255&&(s[e+1]&224)===224&&(s[e+1]&6)!==0}function A0(s,e){return e+1<s.length&&Yl(s,e)}function j3(s,e){return Yl(s,e)&&4<=s.length-e}function S0(s,e){if(e+1<s.length&&Yl(s,e)){const i=E0(s,e);let n=4;i!=null&&i.frameLength&&(n=i.frameLength);const r=e+n;return r===s.length||A0(s,r)}return!1}class W3 extends Xl{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=ms(e,0);let n=i?.length||0;if(S0(e,n))return!1;for(let r=e.length;n<r;n++)if(R3(e,n))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return C3(e,t)}appendFrame(e,t,i){m0(e,this.observer,t,i,e.manifestCodec);const n=g0(e,t,i,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n}}const T0=(s,e)=>{let t=0,i=5;e+=i;const n=new Uint32Array(1),r=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=s[e];const a=Math.min(i,8),c=8-a;r[0]=4278190080>>>24+c<<c,n[0]=(o[0]&r[0])>>c,t=t?t<<a|n[0]:n[0],e+=1,i-=a}return t};class X3 extends Xl{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=b0(e,t,i,this.basePTS,this.frameIndex);if(n!==-1)return{sample:e.samples[e.samples.length-1],length:n,missing:0}}static probe(e){if(!e)return!1;const t=ms(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&Wl(t)!==void 0&&T0(e,i)<16}}function b0(s,e,t,i,n){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const a=[48e3,44100,32e3][r],c=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][c*3+r]*2;if(t+u>e.length)return-1;const h=e[t+6]>>5;let f=0;h===2?f+=2:(h&1&&h!==1&&(f+=2),h&4&&(f+=2));const m=(e[t+6]<<8|e[t+7])>>12-f&1,g=[2,1,2,3,3,4,4,5][h]+m,y=e[t+5]>>3,v=e[t+5]&7,E=new Uint8Array([r<<6|y<<1|v>>2,(v&3)<<6|h<<3|m<<2|c>>4,c<<4&224]),x=1536/a*9e4,T=i+n*x,A=e.subarray(t,t+u);return s.config=E,s.channelCount=g,s.samplerate=a,s.samples.push({unit:A,pts:T}),u}class Y3 extends Xl{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=ms(e,0);let i=t?.length||0;if(t&&e[i]===11&&e[i+1]===119&&Wl(t)!==void 0&&T0(e,i)<=16)return!1;for(let n=e.length;i<n;i++)if(S0(e,i))return Pe.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return j3(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return x0(e,t,i,this.basePTS,this.frameIndex)}}const Q3=/\/emsg[-/]ID3/i;class J3{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const r=this.videoTrack=Jt("video",1),o=this.audioTrack=Jt("audio",1),a=this.txtTrack=Jt("text",1);if(this.id3Track=Jt("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const c=Df(e);if(c.video){const{id:l,timescale:u,codec:h,supplemental:f}=c.video;r.id=l,r.timescale=a.timescale=u,r.codec=h,r.supplemental=f}if(c.audio){const{id:l,timescale:u,codec:h}=c.audio;o.id=l,o.timescale=u,o.codec=h}a.id=Lf.text,r.sampleDuration=0,r.duration=o.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return J2(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Dt(this.remainderData,e));const a=sy(i);this.remainderData=a.remainder,n.samples=a.valid||new Uint8Array}else n.samples=i;const o=this.extractID3Track(n,t);return r.samples=Nc(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=Nc(e,t),{videoTrack:t,audioTrack:Jt(),id3Track:n,textTrack:Jt()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=Ae(e.samples,["emsg"]);n&&n.forEach(r=>{const o=oy(r);if(Q3.test(o.schemeIdUri)){const a=Eu(o,t);let c=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;c<=.001&&(c=Number.POSITIVE_INFINITY);const l=o.payload;i.samples.push({data:l,len:l.byteLength,dts:a,pts:a,type:xt.emsg,duration:c})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=Eu(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:xt.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function Eu(s,e){return ie(s.presentationTime)?s.presentationTime/s.timeScale:e+s.presentationTimeDelta/s.timeScale}class q3{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Ul(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Bi.cbc)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const r=n.subarray(16,n.length-n.length%16),o=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(o).then(a=>{const c=new Uint8Array(a);n.set(c,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)}).catch(i)}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let n=0;for(let r=32;r<e.length-16;r+=160,n+=16)i.set(e.subarray(r,r+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let r=32;r<e.length-16;r+=160,n+=16)e.set(i.subarray(n,n+16),r);return e}decryptAvcSample(e,t,i,n,r){const o=kf(r.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(c=>{r.data=this.getAvcDecryptedUnit(o,c),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)}).catch(n)}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){n();return}const r=e[t].units;for(;!(i>=r.length);i++){const o=r[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,n,o),!this.decrypter.isSync()))return}}}}class C0{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,n;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;n=r[r.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,n=i.length;if(n){const r=i[n-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const n=t.byteLength;let r=e.naluState||0;const o=r,a=[];let c=0,l,u,h,f=-1,m=0;for(r===-1&&(f=0,m=this.getNALuType(t,0),r=0,c=1);c<n;){if(l=t[c++],!r){r=l?0:1;continue}if(r===1){r=l?0:2;continue}if(!l)r=3;else if(l===1){if(u=c-r-1,f>=0){const p={data:t.subarray(f,u),type:m};a.push(p)}else{const p=this.getLastNalUnit(e.samples);p&&(o&&c<=4-o&&p.state&&(p.data=p.data.subarray(0,p.data.byteLength-o)),u>0&&(p.data=Dt(p.data,t.subarray(0,u)),p.state=0))}c<n?(h=this.getNALuType(t,c),f=c,m=h,r=0):r=-1}else r=0}if(f>=0&&r>=0){const p={data:t.subarray(f,n),type:m,state:r};a.push(p)}if(a.length===0){const p=this.getLastNalUnit(e.samples);p&&(p.data=Dt(p.data,t))}return e.naluState=r,a}}class as{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");n.set(e.subarray(i,i+r)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&Pe.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Z3 extends C0{parsePES(e,t,i,n){const r=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,c=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(l=>{var u,h;switch(l.type){case 1:{let g=!1;a=!0;const y=l.data;if(c&&y.length>4){const v=this.readSliceType(y);(v===2||v===4||v===7||v===9)&&(g=!0)}if(g){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=g;break}case 5:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,Fl(l.data,1,i.pts,t.samples);break}case 7:{var m,p;a=!0,c=!0;const g=l.data,y=this.readSPS(g);if(!e.sps||e.width!==y.width||e.height!==y.height||((m=e.pixelRatio)==null?void 0:m[0])!==y.pixelRatio[0]||((p=e.pixelRatio)==null?void 0:p[1])!==y.pixelRatio[1]){e.width=y.width,e.height=y.height,e.pixelRatio=y.pixelRatio,e.sps=[g];const v=g.subarray(1,4);let E="avc1.";for(let x=0;x<3;x++){let T=v[x].toString(16);T.length<2&&(T="0"+T),E+=T}e.codec=E}break}case 8:a=!0,e.pps=[l.data];break;case 9:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(l)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new as(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,n=8,r;for(let o=0;o<e;o++)n!==0&&(r=t.readEG(),n=(i+r+256)%256),i=n===0?i:n}readSPS(e){const t=new as(e);let i=0,n=0,r=0,o=0,a,c,l;const u=t.readUByte.bind(t),h=t.readBits.bind(t),f=t.readUEG.bind(t),m=t.readBoolean.bind(t),p=t.skipBits.bind(t),g=t.skipEG.bind(t),y=t.skipUEG.bind(t),v=this.skipScalingList.bind(this);u();const E=u();if(h(5),p(3),u(),y(),E===100||E===110||E===122||E===244||E===44||E===83||E===86||E===118||E===128){const R=f();if(R===3&&p(1),y(),y(),p(1),m())for(c=R!==3?8:12,l=0;l<c;l++)m()&&(l<6?v(16,t):v(64,t))}y();const x=f();if(x===0)f();else if(x===1)for(p(1),g(),g(),a=f(),l=0;l<a;l++)g();y(),p(1);const T=f(),A=f(),C=h(1);C===0&&p(1),p(1),m()&&(i=f(),n=f(),r=f(),o=f());let b=[1,1];if(m()&&m())switch(u()){case 1:b=[1,1];break;case 2:b=[12,11];break;case 3:b=[10,11];break;case 4:b=[16,11];break;case 5:b=[40,33];break;case 6:b=[24,11];break;case 7:b=[20,11];break;case 8:b=[32,11];break;case 9:b=[80,33];break;case 10:b=[18,11];break;case 11:b=[15,11];break;case 12:b=[64,33];break;case 13:b=[160,99];break;case 14:b=[4,3];break;case 15:b=[3,2];break;case 16:b=[2,1];break;case 255:{b=[u()<<8|u(),u()<<8|u()];break}}return{width:Math.ceil((T+1)*16-i*2-n*2),height:(2-C)*(A+1)*16-(C?2:4)*(r+o),pixelRatio:b}}}class ev extends C0{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,n){const r=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,c=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(l=>{var u,h;switch(l.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,c){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,Fl(l.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=De(e.params,this.readVPS(l.data)),this.initVPS=l.data),e.vps=[l.data];break;case 33:if(a=!0,c=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],l.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const m=this.readSPS(l.data);e.width=m.width,e.height=m.height,e.pixelRatio=m.pixelRatio,e.codec=m.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const p in m.params)e.params[p]=m.params[p]}this.pushParameterSet(e.sps,l.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const m=this.readPPS(l.data);for(const p in m)e.params[p]=m[p]}this.pushParameterSet(e.pps,l.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(l)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let n=0;n<e.byteLength;n++)n>=2&&e[n]===3&&e[n-1]===0&&e[n-2]===0||(t[i]=e[n],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new as(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),n=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:n}}readSPS(e){const t=new as(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const n=t.readBits(2),r=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),c=t.readUByte(),l=t.readUByte(),u=t.readUByte(),h=t.readUByte(),f=t.readUByte(),m=t.readUByte(),p=t.readUByte(),g=t.readUByte(),y=t.readUByte(),v=t.readUByte(),E=[],x=[];for(let Te=0;Te<i;Te++)E.push(t.readBoolean()),x.push(t.readBoolean());if(i>0)for(let Te=i;Te<8;Te++)t.readBits(2);for(let Te=0;Te<i;Te++)E[Te]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),x[Te]&&t.readUByte();t.readUEG();const T=t.readUEG();T==3&&t.skipBits(1);const A=t.readUEG(),C=t.readUEG(),b=t.readBoolean();let R=0,I=0,w=0,M=0;b&&(R+=t.readUEG(),I+=t.readUEG(),w+=t.readUEG(),M+=t.readUEG());const P=t.readUEG(),O=t.readUEG(),z=t.readUEG(),D=t.readBoolean();for(let Te=D?0:i;Te<=i;Te++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let Ce=0;Ce<4;Ce++)for(let Xe=0;Xe<(Ce===3?2:6);Xe++)if(!t.readBoolean())t.readUEG();else{const st=Math.min(64,1<<4+(Ce<<1));Ce>1&&t.readEG();for(let Ht=0;Ht<st;Ht++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const $=t.readUEG();let U=0;for(let Te=0;Te<$;Te++){let Ce=!1;if(Te!==0&&(Ce=t.readBoolean()),Ce){Te===$&&t.readUEG(),t.readBoolean(),t.readUEG();let Xe=0;for(let Tt=0;Tt<=U;Tt++){const st=t.readBoolean();let Ht=!1;st||(Ht=t.readBoolean()),(st||Ht)&&Xe++}U=Xe}else{const Xe=t.readUEG(),Tt=t.readUEG();U=Xe+Tt;for(let st=0;st<Xe;st++)t.readUEG(),t.readBoolean();for(let st=0;st<Tt;st++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const Te=t.readUEG();for(let Ce=0;Ce<Te;Ce++){for(let Xe=0;Xe<z+4;Xe++)t.readBits(1);t.readBits(1)}}let B=0,G=1,j=1,L=!0,X=1,Q=0;t.readBoolean(),t.readBoolean();let ne=!1;if(t.readBoolean()){if(t.readBoolean()){const ge=t.readUByte(),be=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Me=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];ge>0&&ge<16?(G=be[ge-1],j=Me[ge-1]):ge===255&&(G=t.readBits(16),j=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),ne=t.readBoolean(),ne&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(X=t.readBits(32),Q=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const Me=t.readBoolean(),Oe=t.readBoolean();let We=!1;(Me||Oe)&&(We=t.readBoolean(),We&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),We&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let Ge=0;Ge<=i;Ge++){L=t.readBoolean();const Si=L||t.readBoolean();let Ti=!1;Si?t.readEG():Ti=t.readBoolean();const bi=Ti?1:t.readUEG()+1;if(Me)for(let ni=0;ni<bi;ni++)t.readUEG(),t.readUEG(),We&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(Oe)for(let ni=0;ni<bi;ni++)t.readUEG(),t.readUEG(),We&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),B=t.readUEG())}let xe=A,ce=C;if(b){let Te=1,Ce=1;T===1?Te=Ce=2:T==2&&(Te=2),xe=A-Te*I-Te*R,ce=C-Ce*M-Ce*w}const Ee=n?["A","B","C"][n]:"",ct=a<<24|c<<16|l<<8|u;let ut=0;for(let Te=0;Te<32;Te++)ut=(ut|(ct>>Te&1)<<31-Te)>>>0;let St=ut.toString(16);return o===1&&St==="2"&&(St="6"),{codecString:`hvc1.${Ee}${o}.${St}.${r?"H":"L"}${v}.B0`,params:{general_tier_flag:r,general_profile_idc:o,general_profile_space:n,general_profile_compatibility_flags:[a,c,l,u],general_constraint_indicator_flags:[h,f,m,p,g,y],general_level_idc:v,bit_depth:P+8,bit_depth_luma_minus8:P,bit_depth_chroma_minus8:O,min_spatial_segmentation_idc:B,chroma_format_idc:T,frame_rate:{fixed:L,fps:Q/X}},width:xe,height:ce,pixelRatio:[G,j]}}readPPS(e){const t=new as(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),r=t.readBoolean();let o=1;return r&&n?o=0:r?o=3:n&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const it=188;class _i{constructor(e,t,i,n){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.videoParser=null}static probe(e,t){const i=_i.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(it*5,t-it)+1,n=0;for(;n<i;){let r=!1,o=-1,a=0;for(let c=n;c<t;c+=it)if(e[c]===71&&(t-c===it||e[c+it]===71)){if(a++,o===-1&&(o=c,o!==0&&(i=Math.min(o+it*99,e.length-it)+1)),r||(r=Za(e,c)===0),r&&a>1&&(o===0&&a>2||c+it>i))return o}else{if(a)return-1;break}n++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Lf[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=_i.createTrack("video"),this._videoTrack.duration=n,this._audioTrack=_i.createTrack("audio",n),this._id3Track=_i.createTrack("id3"),this._txtTrack=_i.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){i||(this.sampleAes=null);let r;const o=this._videoTrack,a=this._audioTrack,c=this._id3Track,l=this._txtTrack;let u=o.pid,h=o.pesData,f=a.pid,m=c.pid,p=a.pesData,g=c.pesData,y=null,v=this.pmtParsed,E=this._pmtId,x=e.length;if(this.remainderData&&(e=Dt(this.remainderData,e),x=e.length,this.remainderData=null),x<it&&!n)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:c,textTrack:l};const T=Math.max(0,_i.syncOffset(e));x-=(x-T)%it,x<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,x,e.buffer.byteLength-x));let A=0;for(let b=T;b<x;b+=it)if(e[b]===71){const R=!!(e[b+1]&64),I=Za(e,b),w=(e[b+3]&48)>>4;let M;if(w>1){if(M=b+5+e[b+4],M===b+it)continue}else M=b+4;switch(I){case u:R&&(h&&(r=cn(h,this.logger))&&(this.readyVideoParser(o.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(o,l,r,!1)),h={data:[],size:0}),h&&(h.data.push(e.subarray(M,b+it)),h.size+=b+it-M);break;case f:if(R){if(p&&(r=cn(p,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,r);break;case"mp3":this.parseMPEGPES(a,r);break;case"ac3":this.parseAC3PES(a,r);break}p={data:[],size:0}}p&&(p.data.push(e.subarray(M,b+it)),p.size+=b+it-M);break;case m:R&&(g&&(r=cn(g,this.logger))&&this.parseID3PES(c,r),g={data:[],size:0}),g&&(g.data.push(e.subarray(M,b+it)),g.size+=b+it-M);break;case 0:R&&(M+=e[M]+1),E=this._pmtId=tv(e,M);break;case E:{R&&(M+=e[M]+1);const P=iv(e,M,this.typeSupported,i,this.observer,this.logger);u=P.videoPid,u>0&&(o.pid=u,o.segmentCodec=P.segmentVideoCodec),f=P.audioPid,f>0&&(a.pid=f,a.segmentCodec=P.segmentAudioCodec),m=P.id3Pid,m>0&&(c.pid=m),y!==null&&!v&&(this.logger.warn(`MPEG-TS PMT found at ${b} after unknown PID '${y}'. Backtracking to sync byte @${T} to parse all TS packets.`),y=null,b=T-188),v=this.pmtParsed=!0;break}case 17:case 8191:break;default:y=I;break}}else A++;A>0&&el(this.observer,new Error(`Found ${A} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=h,a.pesData=p,c.pesData=g;const C={audioTrack:a,videoTrack:o,id3Track:c,textTrack:l};return n&&this.extractRemainingSamples(C),C}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:r}=e,o=i.pesData,a=t.pesData,c=n.pesData;let l;if(o&&(l=cn(o,this.logger))?(this.readyVideoParser(i.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(i,r,l,!0),i.pesData=null)):i.pesData=o,a&&(l=cn(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;c&&(l=cn(c,this.logger))?(this.parseID3PES(n,l),n.pesData=null):n.pesData=c}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new q3(this.observer,this.config,t);return this.decrypt(n,r)}readyVideoParser(e){this.videoParser===null&&(e==="avc"?this.videoParser=new Z3:e==="hevc"&&(this.videoParser=new ev))}decrypt(e,t){return new Promise(i=>{const{audioTrack:n,videoTrack:r}=e;n.samples&&n.segmentCodec==="aac"?t.decryptAacSamples(n.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let r=t.data;if(n){this.aacOverFlow=null;const h=n.missing,f=n.sample.unit.byteLength;if(h===-1)r=Dt(n.sample.unit,r);else{const m=f-h;n.sample.unit.set(r.subarray(0,h),m),e.samples.push(n.sample),i=n.missing}}let o,a;for(o=i,a=r.length;o<a-1&&!$r(r,o);o++);if(o!==i){let h;const f=o<a-1;if(f?h=`AAC PES did not start with ADTS header,offset:${o}`:h="No ADTS header found in AAC PES",el(this.observer,new Error(h),f,this.logger),!f)return}m0(e,this.observer,r,o,this.audioCodec);let c;if(t.pts!==void 0)c=t.pts;else if(n){const h=p0(e.samplerate);c=n.sample.pts+h}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let l=0,u;for(;o<a;)if(u=g0(e,r,o,c,l),o+=u.length,u.missing){this.aacOverFlow=u;break}else for(l++;o<a-1&&!$r(r,o);o++);}parseMPEGPES(e,t){const i=t.data,n=i.length;let r=0,o=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<n;)if(A0(i,o)){const c=x0(e,i,o,a,r);if(c)o+=c.length,r++;else break}else o++}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(n===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let o=0,a=0,c;for(;a<r&&(c=b0(e,i,a,n,o++))>0;)a+=c}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=De({},t,{type:this._videoTrack?xt.emsg:xt.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Za(s,e){return((s[e+1]&31)<<8)+s[e+2]}function tv(s,e){return(s[e+10]&31)<<8|s[e+11]}function iv(s,e,t,i,n,r){const o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(s[e+1]&15)<<8|s[e+2],c=e+3+a-4,l=(s[e+10]&15)<<8|s[e+11];for(e+=12+l;e<c;){const u=Za(s,e),h=(s[e+3]&15)<<8|s[e+4];switch(s[e]){case 207:if(!i){$o("ADTS AAC",r);break}case 15:o.audioPid===-1&&(o.audioPid=u);break;case 21:o.id3Pid===-1&&(o.id3Pid=u);break;case 219:if(!i){$o("H.264",r);break}case 27:o.videoPid===-1&&(o.videoPid=u);break;case 3:case 4:!t.mpeg&&!t.mp3?r.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="mp3");break;case 193:if(!i){$o("AC-3",r);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&h>0){let f=e+5,m=h;for(;m>2;){switch(s[f]){case 106:t.ac3!==!0?r.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=u,o.segmentAudioCodec="ac3");break}const g=s[f+1]+2;f+=g,m-=g}}break;case 194:case 135:return el(n,new Error("Unsupported EC-3 in M2TS found"),void 0,r),o;case 36:o.videoPid===-1&&(o.videoPid=u,o.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"));break}e+=h+5}return o}function el(s,e,t,i){i.warn(`parsing error: ${e.message}`),s.emit(S.ERROR,S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function $o(s,e){e.log(`${s} with AES-128-CBC encryption found in unencrypted stream`)}function cn(s,e){let t=0,i,n,r,o,a;const c=s.data;if(!s||s.size===0)return null;for(;c[0].length<19&&c.length>1;)c[0]=Dt(c[0],c[1]),c.splice(1,1);if(i=c[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(n=(i[4]<<8)+i[5],n&&n>s.size-6)return null;const u=i[7];u&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,u&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),r=i[8];let h=r+9;if(s.size<=h)return null;s.size-=h;const f=new Uint8Array(s.size);for(let m=0,p=c.length;m<p;m++){i=c[m];let g=i.byteLength;if(h)if(h>g){h-=g;continue}else i=i.subarray(h),g-=h,h=0;f.set(i,t),t+=g}return n&&(n-=r+3),{data:f,pts:o,dts:a,len:n}}return null}class nv{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Ci=Math.pow(2,32)-1;class K{static init(){K.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in K.types)K.types.hasOwnProperty(e)&&(K.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);K.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);K.STTS=K.STSC=K.STCO=r,K.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),K.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),K.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),K.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),c=new Uint8Array([0,0,0,1]);K.FTYP=K.box(K.types.ftyp,o,c,o,a),K.DINF=K.box(K.types.dinf,K.box(K.types.dref,n))}static box(e,...t){let i=8,n=t.length;const r=n;for(;n--;)i+=t[n].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),n=0,i=8;n<r;n++)o.set(t[n],i),i+=t[n].byteLength;return o}static hdlr(e){return K.box(K.types.hdlr,K.HDLR_TYPES[e])}static mdat(e){return K.box(K.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(Ci+1)),n=Math.floor(t%(Ci+1));return K.box(K.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}static mdia(e){return K.box(K.types.mdia,K.mdhd(e.timescale||0,e.duration||0),K.hdlr(e.type),K.minf(e))}static mfhd(e){return K.box(K.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?K.box(K.types.minf,K.box(K.types.smhd,K.SMHD),K.DINF,K.stbl(e)):K.box(K.types.minf,K.box(K.types.vmhd,K.VMHD),K.DINF,K.stbl(e))}static moof(e,t,i){return K.box(K.types.moof,K.mfhd(e),K.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=K.trak(e[t]);return K.box.apply(null,[K.types.moov,K.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(K.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=K.trex(e[t]);return K.box.apply(null,[K.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(Ci+1)),n=Math.floor(t%(Ci+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return K.box(K.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,r;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return K.box(K.types.sdtp,i)}static stbl(e){return K.box(K.types.stbl,K.stsd(e),K.box(K.types.stts,K.STTS),K.box(K.types.stsc,K.STSC),K.box(K.types.stsz,K.STSZ),K.box(K.types.stco,K.STCO))}static avc1(e){let t=[],i=[],n,r,o;for(n=0;n<e.sps.length;n++)r=e.sps[n],o=r.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(r));for(n=0;n<e.pps.length;n++)r=e.pps[n],o=r.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(r));const a=K.box(K.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),c=e.width,l=e.height,u=e.pixelRatio[0],h=e.pixelRatio[1];return K.box(K.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,K.box(K.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),K.box(K.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return K.box(K.types.mp4a,K.audioStsd(e),K.box(K.types.esds,K.esds(e)))}static mp3(e){return K.box(K.types[".mp3"],K.audioStsd(e))}static ac3(e){return K.box(K.types["ac-3"],K.audioStsd(e),K.box(K.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return K.box(K.types.stsd,K.STSD,K.mp4a(e));if(t==="ac3"&&e.config)return K.box(K.types.stsd,K.STSD,K.ac3(e));if(t==="mp3"&&e.codec==="mp3")return K.box(K.types.stsd,K.STSD,K.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return K.box(K.types.stsd,K.STSD,K.avc1(e));if(t==="hevc"&&e.vps)return K.box(K.types.stsd,K.STSD,K.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),n=e.width||0,r=e.height||0,o=Math.floor(i/(Ci+1)),a=Math.floor(i%(Ci+1));return K.box(K.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,n&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=K.sdtp(e),n=e.id,r=Math.floor(t/(Ci+1)),o=Math.floor(t%(Ci+1));return K.box(K.types.traf,K.box(K.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),K.box(K.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,o>>24,o>>16&255,o>>8&255,o&255])),K.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,K.box(K.types.trak,K.tkhd(e),K.mdia(e))}static trex(e){const t=e.id;return K.box(K.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,r=12+16*n,o=new Uint8Array(r);let a,c,l,u,h,f;for(t+=8+r,o.set([e.type==="video"?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<n;a++)c=i[a],l=c.duration,u=c.size,h=c.flags,f=c.cts,o.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*a);return K.box(K.types.trun,o)}static initSegment(e){K.types||K.init();const t=K.moov(e);return Dt(K.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],n=4,r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),n-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let o=r.length;for(let p=0;p<i.length;p+=1){o+=3;for(let g=0;g<i[p].length;g+=1)o+=2+i[p][g].length}const a=new Uint8Array(o);a.set(r,0),o=r.length;const c=i.length-1;for(let p=0;p<i.length;p+=1){a.set(new Uint8Array([32+p|(p===c?128:0),0,i[p].length]),o),o+=3;for(let g=0;g<i[p].length;g+=1)a.set(new Uint8Array([i[p][g].length>>8,i[p][g].length&255]),o),o+=2,a.set(i[p][g],o),o+=i[p][g].length}const l=K.box(K.types.hvcC,a),u=e.width,h=e.height,f=e.pixelRatio[0],m=e.pixelRatio[1];return K.box(K.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,K.box(K.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),K.box(K.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,m>>24,m>>16&255,m>>8&255,m&255])))}}K.types=void 0;K.HDLR_TYPES=void 0;K.STTS=void 0;K.STSC=void 0;K.STCO=void 0;K.STSZ=void 0;K.VMHD=void 0;K.SMHD=void 0;K.STSD=void 0;K.FTYP=void 0;K.DINF=void 0;const R0=9e4;function Ql(s,e,t=1,i=!1){const n=s*e*t;return i?Math.round(n):n}function sv(s,e,t=1,i=!1){return Ql(s,e,1/t,i)}function $n(s,e=!1){return Ql(s,1e3,1/R0,e)}function rv(s,e=1){return Ql(s,R0,1/e)}function Au(s){const{baseTime:e,timescale:t,trackId:i}=s;return`${e/t} (${e}/${t}) trackId: ${i}`}const ov=10*1e3,av=1024,lv=1152,cv=1536;let un=null,Ho=null;function Su(s,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:s?2:1,isNonSync:s?0:1}}}class Rr extends Bt{constructor(e,t,i,n){if(super("mp4-remuxer",n),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,un===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);un=o?parseInt(o[1]):0}if(Ho===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);Ho=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){const t=this._initPTS;(!t||!e||e.trackId!==t.trackId||e.baseTime!==t.baseTime||e.timescale!==t.timescale)&&this.log(`Reset initPTS: ${t&&Au(t)} > ${e&&Au(e)}`),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,n=e.reduce((r,o)=>{let a=o.pts,c=a-r;return c<-4294967296&&(t=!0,a=It(a,i),c=a-r),c>0?r:a},i);return t&&this.debug("PTS rollover detected"),n}remux(e,t,i,n,r,o,a,c){let l,u,h,f,m,p,g=r,y=r;const v=e.pid>-1,E=t.pid>-1,x=t.samples.length,T=e.samples.length>0,A=a&&x>0||x>1;if((!v||T)&&(!E||A)||this.ISGenerated||a){if(this.ISGenerated){var b,R,I,w;const z=this.videoTrackConfig;(z&&(t.width!==z.width||t.height!==z.height||((b=t.pixelRatio)==null?void 0:b[0])!==((R=z.pixelRatio)==null?void 0:R[0])||((I=t.pixelRatio)==null?void 0:I[1])!==((w=z.pixelRatio)==null?void 0:w[1]))||!z&&A||this.nextAudioTs===null&&T)&&this.resetInitSegment()}this.ISGenerated||(h=this.generateIS(e,t,r,o));const M=this.isVideoContiguous;let P=-1,O;if(A&&(P=uv(t.samples),!M&&this.config.forceKeyFrameOnDiscontinuity))if(p=!0,P>0){this.warn(`Dropped ${P} out of ${x} video samples due to a missing keyframe`);const z=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(P),t.dropped+=P,y+=(t.samples[0].pts-z)/t.inputTimeScale,O=y}else P===-1&&(this.warn(`No keyframe found out of ${x} video samples`),p=!1);if(this.ISGenerated){if(T&&A){const z=this.getVideoStartPts(t.samples),F=(It(e.samples[0].pts,z)-z)/t.inputTimeScale;g+=Math.max(0,F),y+=Math.max(0,-F)}if(T){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),h=this.generateIS(e,t,r,o)),u=this.remuxAudio(e,g,this.isAudioContiguous,o,E||A||c===se.AUDIO?y:void 0),A){const z=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),h=this.generateIS(e,t,r,o)),l=this.remuxVideo(t,y,M,z)}}else A&&(l=this.remuxVideo(t,y,M,0));l&&(l.firstKeyFrame=P,l.independent=P!==-1,l.firstKeyFramePTS=O)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(m=w0(i,r,this._initPTS,this._initDTS)),n.samples.length&&(f=I0(n,r,this._initPTS))),{audio:u,video:l,initSegment:h,independent:p,text:f,id3:m}}computeInitPts(e,t,i,n){const r=Math.round(i*t);let o=It(e,r);if(o<r+t)for(this.log(`Adjusting PTS for rollover in timeline near ${(r-o)/t} ${n}`);o<r+t;)o+=8589934592;return o-r}generateIS(e,t,i,n){const r=e.samples,o=t.samples,a=this.typeSupported,c={},l=this._initPTS;let u=!l||n,h="audio/mp4",f,m,p,g=-1;if(u&&(f=m=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(h="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}c.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):K.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(g=e.id,p=e.inputTimeScale,!l||p!==l.timescale?f=m=this.computeInitPts(r[0].pts,p,i,"audio"):u=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,c.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:K.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(g=t.id,p=t.inputTimeScale,!l||p!==l.timescale){const y=this.getVideoStartPts(o),v=It(o[0].dts,y),E=this.computeInitPts(v,p,i,"video"),x=this.computeInitPts(y,p,i,"video");m=Math.min(m,E),f=Math.min(f,x)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(c).length)return this.ISGenerated=!0,u?(l&&this.warn(`Timestamps at playlist time: ${n?"":"~"}${i} ${f/p} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${i} offset: ${f/p} (${f}/${p}) trackId: ${g}`),this._initPTS={baseTime:f,timescale:p,trackId:g},this._initDTS={baseTime:m,timescale:p,trackId:g}):f=p=void 0,{tracks:c,initPTS:f,timescale:p,trackId:g}}remuxVideo(e,t,i,n){const r=e.inputTimeScale,o=e.samples,a=[],c=o.length,l=this._initPTS,u=l.baseTime*r/l.timescale;let h=this.nextVideoTs,f=8,m=this.videoSampleDuration,p,g,y=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,E=!1;if(!i||h===null){const B=u+t*r,G=o[0].pts-It(o[0].dts,o[0].pts);un&&h!==null&&Math.abs(B-G-(h+u))<15e3?i=!0:h=B-G-u}const x=h+u;for(let B=0;B<c;B++){const G=o[B];G.pts=It(G.pts,x),G.dts=It(G.dts,x),G.dts<o[B>0?B-1:B].dts&&(E=!0)}E&&o.sort(function(B,G){const j=B.dts-G.dts,L=B.pts-G.pts;return j||L}),p=o[0].dts,g=o[o.length-1].dts;const T=g-p,A=T?Math.round(T/(c-1)):m||e.inputTimeScale/30;if(i){const B=p-x,G=B>A,j=B<-1;if((G||j)&&(G?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${$n(B,!0)} ms (${B}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${$n(-B,!0)} ms (${B}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!j||x>=o[0].pts||un)){p=x;const L=o[0].pts-B;if(G)o[0].dts=p,o[0].pts=L;else{let X=!0;for(let Q=0;Q<o.length&&!(o[Q].dts>L&&X);Q++){const ne=o[Q].pts;if(o[Q].dts-=B,o[Q].pts-=B,Q<o.length-1){const he=o[Q+1].pts,xe=o[Q].pts,ce=he<=xe,Ee=he<=ne;X=ce==Ee}}}this.log(`Video: Initial PTS/DTS adjusted: ${$n(L,!0)}/${$n(p,!0)}, delta: ${$n(B,!0)} ms`)}}p=Math.max(0,p);let C=0,b=0,R=p;for(let B=0;B<c;B++){const G=o[B],j=G.units,L=j.length;let X=0;for(let Q=0;Q<L;Q++)X+=j[Q].data.length;b+=X,C+=L,G.length=X,G.dts<R?(G.dts=R,R+=A/4|0||1):R=G.dts,y=Math.min(G.pts,y),v=Math.max(G.pts,v)}g=o[c-1].dts;const I=b+4*C+8;let w;try{w=new Uint8Array(I)}catch(B){this.observer.emit(S.ERROR,S.ERROR,{type:ae.MUX_ERROR,details:V.REMUX_ALLOC_ERROR,fatal:!1,error:B,bytes:I,reason:`fail allocating video mdat ${I}`});return}const M=new DataView(w.buffer);M.setUint32(0,I),w.set(K.types.mdat,4);let P=!1,O=Number.POSITIVE_INFINITY,z=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,F=Number.NEGATIVE_INFINITY;for(let B=0;B<c;B++){const G=o[B],j=G.units;let L=0;for(let ne=0,he=j.length;ne<he;ne++){const xe=j[ne],ce=xe.data,Ee=xe.data.byteLength;M.setUint32(f,Ee),f+=4,w.set(ce,f),f+=Ee,L+=4+Ee}let X;if(B<c-1)m=o[B+1].dts-G.dts,X=o[B+1].pts-G.pts;else{const ne=this.config,he=B>0?G.dts-o[B-1].dts:A;if(X=B>0?G.pts-o[B-1].pts:A,ne.stretchShortVideoTrack&&this.nextAudioTs!==null){const xe=Math.floor(ne.maxBufferHole*r),ce=(n?y+n*r:this.nextAudioTs+u)-G.pts;ce>xe?(m=ce-he,m<0?m=he:P=!0,this.log(`It is approximately ${ce/90} ms to the next segment; using duration ${m/90} ms for the last video frame.`)):m=he}else m=he}const Q=Math.round(G.pts-G.dts);O=Math.min(O,m),D=Math.max(D,m),z=Math.min(z,X),F=Math.max(F,X),a.push(Su(G.key,m,L,Q))}if(a.length){if(un){if(un<70){const B=a[0].flags;B.dependsOn=2,B.isNonSync=0}}else if(Ho&&F-z<D-O&&A/D<.025&&a[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let B=p;for(let G=0,j=a.length;G<j;G++){const L=B+a[G].duration,X=B+a[G].cts;if(G<j-1){const Q=L+a[G+1].cts;a[G].duration=Q-X}else a[G].duration=G?a[G-1].duration:A;a[G].cts=0,B=L}}}m=P||!m?A:m;const k=g+m;this.nextVideoTs=h=k-u,this.videoSampleDuration=m,this.isVideoContiguous=!0;const N={data1:K.moof(e.sequenceNumber++,p,De(e,{samples:a})),data2:w,startPTS:(y-u)/r,endPTS:(v+m-u)/r,startDTS:(p-u)/r,endDTS:h/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,N}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return lv;case"ac3":return cv;default:return av}}remuxAudio(e,t,i,n,r){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,c=o/a,l=this.getSamplesPerFrame(e),u=l*c,h=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,m=[],p=r!==void 0;let g=e.samples,y=f?0:8,v=this.nextAudioTs||-1;const E=h.baseTime*o/h.timescale,x=E+t*o;if(this.isAudioContiguous=i=i||g.length&&v>0&&(n&&Math.abs(x-(v+E))<9e3||Math.abs(It(g[0].pts,x)-(v+E))<20*u),g.forEach(function(F){F.pts=It(F.pts,x)}),!i||v<0){const F=g.length;if(g=g.filter(k=>k.pts>=0),F!==g.length&&this.warn(`Removed ${g.length-F} of ${F} samples (initPTS ${E} / ${o})`),!g.length)return;r===0?v=0:n&&!p?v=Math.max(0,x-E):v=g[0].pts-E}if(e.segmentCodec==="aac"){const F=this.config.maxAudioFramesDrift;for(let k=0,$=v+E;k<g.length;k++){const U=g[k],N=U.pts,B=N-$,G=Math.abs(1e3*B/o);if(B<=-F*u&&p)k===0&&(this.warn(`Audio frame @ ${(N/o).toFixed(3)}s overlaps marker by ${Math.round(1e3*B/o)} ms.`),this.nextAudioTs=v=N-E,$=N);else if(B>=F*u&&G<ov&&p){let j=Math.round(B/u);for($=N-j*u;$<0&&j&&u;)j--,$+=u;k===0&&(this.nextAudioTs=v=$-E),this.warn(`Injecting ${j} audio frames @ ${(($-E)/o).toFixed(3)}s due to ${Math.round(1e3*B/o)} ms gap.`);for(let L=0;L<j;L++){let X=nv.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);X||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),X=U.unit.subarray()),g.splice(k,0,{unit:X,pts:$}),$+=u,k++}}U.pts=$,$+=u}}let T=null,A=null,C,b=0,R=g.length;for(;R--;)b+=g[R].unit.byteLength;for(let F=0,k=g.length;F<k;F++){const $=g[F],U=$.unit;let N=$.pts;if(A!==null){const G=m[F-1];G.duration=Math.round((N-A)/c)}else if(i&&e.segmentCodec==="aac"&&(N=v+E),T=N,b>0){b+=y;try{C=new Uint8Array(b)}catch(G){this.observer.emit(S.ERROR,S.ERROR,{type:ae.MUX_ERROR,details:V.REMUX_ALLOC_ERROR,fatal:!1,error:G,bytes:b,reason:`fail allocating audio mdat ${b}`});return}f||(new DataView(C.buffer).setUint32(0,b),C.set(K.types.mdat,4))}else return;C.set(U,y);const B=U.byteLength;y+=B,m.push(Su(!0,l,B,0)),A=N}const I=m.length;if(!I)return;const w=m[m.length-1];v=A-E,this.nextAudioTs=v+c*w.duration;const M=f?new Uint8Array(0):K.moof(e.sequenceNumber++,T/c,De({},e,{samples:m}));e.samples=[];const P=(T-E)/o,O=this.nextAudioTs/o,D={data1:M,data2:C,startPTS:P,endPTS:O,startDTS:P,endDTS:O,type:"audio",hasAudio:!0,hasVideo:!1,nb:I};return this.isAudioContiguous=!0,D}}function It(s,e){let t;if(e===null)return s;for(e<s?t=-8589934592:t=8589934592;Math.abs(s-e)>4294967296;)s+=t;return s}function uv(s){for(let e=0;e<s.length;e++)if(s[e].key)return e;return-1}function w0(s,e,t,i){const n=s.samples.length;if(!n)return;const r=s.inputTimeScale;for(let a=0;a<n;a++){const c=s.samples[a];c.pts=It(c.pts-t.baseTime*r/t.timescale,e*r)/r,c.dts=It(c.dts-i.baseTime*r/i.timescale,e*r)/r}const o=s.samples;return s.samples=[],{samples:o}}function I0(s,e,t){const i=s.samples.length;if(!i)return;const n=s.inputTimeScale;for(let o=0;o<i;o++){const a=s.samples[o];a.pts=It(a.pts-t.baseTime*n/t.timescale,e*n)/n}s.samples.sort((o,a)=>o.pts-a.pts);const r=s.samples;return s.samples=[],{samples:r}}class hv extends Bt{constructor(e,t,i,n){super("passthrough-remuxer",n),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(e,n),this.emitInitSegment=!0}generateInitSegment(e,t){let{audioCodec:i,videoCodec:n}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:r,video:o}=this.initData=Df(e);if(t)ty(e,t);else{const c=r||o;c!=null&&c.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${c.codec}")!`)}r&&(i=Tu(r,Fe.AUDIO,this)),o&&(n=Tu(o,Fe.VIDEO,this));const a={};r&&o?a.audiovideo={container:"video/mp4",codec:i+","+n,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:r?a.audio={container:"audio/mp4",codec:i,encrypted:r.encrypted,initSegment:e,id:"audio"}:o?a.video={container:"video/mp4",codec:n,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(e,t,i,n,r,o){var a,c;let{initPTS:l,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};ie(u)||(u=this.lastEndTime=r||0);const f=t.samples;if(!f.length)return h;const m={initPTS:void 0,timescale:void 0,trackId:void 0};let p=this.initData;if((a=p)!=null&&a.length||(this.generateInitSegment(f),p=this.initData),!((c=p)!=null&&c.length))return this.warn("Failed to generate initSegment."),h;this.emitInitSegment&&(m.tracks=this.initTracks,this.emitInitSegment=!1);const g=ny(f,p,this),y=p.audio?g[p.audio.id]:null,v=p.video?g[p.video.id]:null,E=Gs(v,1/0),x=Gs(y,1/0),T=Gs(v,0,!0),A=Gs(y,0,!0);let C=r,b=0;const R=y&&(!v||!l&&x<E||l&&l.trackId===p.audio.id),I=R?y:v;if(I){const $=I.timescale,U=I.start-r*$,N=R?p.audio.id:p.video.id;C=I.start/$,b=R?A-x:T-E,(o||!l)&&(dv(l,C,r,b)||$!==l.timescale)&&(l&&this.warn(`Timestamps at playlist time: ${o?"":"~"}${r} ${U/$} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${r} offset: ${C-r} (${U}/${$}) trackId: ${N}`),l=null,m.initPTS=U,m.timescale=$,m.trackId=N)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${r}`);l?(m.initPTS=l.baseTime,m.timescale=l.timescale,m.trackId=l.trackId):((!m.timescale||m.trackId===void 0||m.initPTS===void 0)&&(this.warn("Could not set initPTS"),m.initPTS=C,m.timescale=1,m.trackId=-1),this.initPTS=l={baseTime:m.initPTS,timescale:m.timescale,trackId:m.trackId});const w=C-l.baseTime/l.timescale,M=w+b;b>0?this.lastEndTime=M:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const P=!!p.audio,O=!!p.video;let z="";P&&(z+="audio"),O&&(z+="video");const D=(p.audio?p.audio.encrypted:!1)||(p.video?p.video.encrypted:!1),F={data1:f,startPTS:w,startDTS:w,endPTS:M,endDTS:M,type:z,hasAudio:P,hasVideo:O,nb:1,dropped:0,encrypted:D};h.audio=P&&!O?F:void 0,h.video=O?F:void 0;const k=v?.sampleCount;if(k){const $=v.keyFrameIndex,U=$!==-1;F.nb=k,F.dropped=$===0||this.isVideoContiguous?0:U?$:k,F.independent=U,F.firstKeyFrame=$,U&&v.keyFrameStart&&(F.firstKeyFramePTS=(v.keyFrameStart-l.baseTime)/l.timescale),this.isVideoContiguous||(h.independent=U),this.isVideoContiguous||(this.isVideoContiguous=U),F.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${$}/${k} dropped: ${F.dropped} start: ${F.firstKeyFramePTS||"NA"}`)}return h.initSegment=m,h.id3=w0(i,r,l,l),n.samples.length&&(h.text=I0(n,r,l)),h}}function Gs(s,e,t=!1){return s?.start!==void 0?(s.start+(t?s.duration:0))/s.timescale:e}function dv(s,e,t,i){if(s===null)return!0;const n=Math.max(i,1),r=e-s.baseTime/s.timescale;return Math.abs(r-t)>n}function Tu(s,e,t){const i=s.codec;return i&&i.length>4?i:e===Fe.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?Br(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}let li;try{li=self.performance.now.bind(self.performance)}catch{li=Date.now}const wr=[{demux:J3,remux:hv},{demux:_i,remux:Rr},{demux:W3,remux:Rr},{demux:Y3,remux:Rr}];wr.splice(2,0,{demux:X3,remux:Rr});class bu{constructor(e,t,i,n,r,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=r,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const r=i.transmuxing;r.executeStart=li();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:c}=this;n&&(this.currentTransmuxState=n);const{contiguous:l,discontinuity:u,trackSwitch:h,accurateTimeOffset:f,timeOffset:m,initSegmentChange:p}=n||a,{audioCodec:g,videoCodec:y,defaultInitPts:v,duration:E,initSegmentData:x}=c,T=fv(o,t);if(T&&Rn(T.method)){const R=this.getDecrypter(),I=Gl(T.method);if(R.isSync()){let w=R.softwareDecrypt(o,T.key.buffer,T.iv.buffer,I);if(i.part>-1){const P=R.flush();w=P&&P.buffer}if(!w)return r.executeEnd=li(),Ko(i);o=new Uint8Array(w)}else return this.asyncResult=!0,this.decryptionPromise=R.webCryptoDecrypt(o,T.key.buffer,T.iv.buffer,I).then(w=>{const M=this.push(w,null,i);return this.decryptionPromise=null,M}),this.decryptionPromise}const A=this.needsProbing(u,h);if(A){const R=this.configureTransmuxer(o);if(R)return this.logger.warn(`[transmuxer] ${R.message}`),this.observer.emit(S.ERROR,S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_PARSING_ERROR,fatal:!1,error:R,reason:R.message}),r.executeEnd=li(),Ko(i)}(u||h||p||A)&&this.resetInitSegment(x,g,y,E,t),(u||p||A)&&this.resetInitialTimestamp(v),l||this.resetContiguity();const C=this.transmux(o,T,m,f,i);this.asyncResult=ps(C);const b=this.currentTransmuxState;return b.contiguous=!0,b.discontinuity=!1,b.trackSwitch=!1,r.executeEnd=li(),C}flush(e){const t=e.transmuxing;t.executeStart=li();const{decrypter:i,currentTransmuxState:n,decryptionPromise:r}=this;if(r)return this.asyncResult=!0,r.then(()=>this.flush(e));const o=[],{timeOffset:a}=n;if(i){const h=i.flush();h&&o.push(this.push(h.buffer,null,e))}const{demuxer:c,remuxer:l}=this;if(!c||!l){t.executeEnd=li();const h=[Ko(e)];return this.asyncResult?Promise.resolve(h):h}const u=c.flush(a);return ps(u)?(this.asyncResult=!0,u.then(h=>(this.flushRemux(o,h,e),o))):(this.flushRemux(o,u,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:r,id3Track:o,textTrack:a}=t,{accurateTimeOffset:c,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===se.MAIN?"level":"track"} ${i.level}`);const u=this.remuxer.remux(n,r,o,a,l,c,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=li()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,r){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,n),a.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,r){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,n,r):o=this.transmuxUnencrypted(e,i,n,r),o}transmuxUnencrypted(e,t,i,n){const{audioTrack:r,videoTrack:o,id3Track:a,textTrack:c}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,o,a,c,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,r){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,n,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n}=this;let r;for(let h=0,f=wr.length;h<f;h++){var o;if((o=wr[h].demux)!=null&&o.probe(e,this.logger)){r=wr[h];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,c=this.remuxer,l=r.remux,u=r.demux;(!c||!(c instanceof l))&&(this.remuxer=new l(i,t,n,this.logger)),(!a||!(a instanceof u))&&(this.demuxer=new u(i,t,n,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Ul(this.config)),e}}function fv(s,e){let t=null;return s.byteLength>0&&e?.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Ko=s=>({remuxResult:{},chunkMeta:s});function ps(s){return"then"in s&&s.then instanceof Function}class mv{constructor(e,t,i,n,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=r||null}}class pv{constructor(e,t,i,n,r,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=r,this.initSegmentChange=o}}let Cu=0;class _0{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Cu++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=c=>{const l=c.data,u=this.hls;if(!(!u||!(l!=null&&l.event)||l.instanceNo!==this.instanceNo))switch(l.event){case"init":{var h;const f=(h=this.workerContext)==null?void 0:h.objectURL;f&&self.URL.revokeObjectURL(f);break}case"transmuxComplete":{this.handleTransmuxComplete(l.data);break}case"flush":{this.onFlush(l.data);break}case"workerLog":{u.logger[l.data.logType]&&u.logger[l.data.logType](l.data.message);break}default:{l.data=l.data||{},l.data.frag=this.frag,l.data.part=this.part,l.data.id=this.id,u.trigger(l.event,l.data);break}}},this.onWorkerError=c=>{if(!this.hls)return;const l=new Error(`${c.message}  (${c.filename}:${c.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:l})};const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const o=(c,l)=>{l=l||{},l.frag=this.frag||void 0,c===S.ERROR&&(l=l,l.parent=this.id,l.part=this.part,this.error=l.error),this.hls.trigger(c,l)};this.observer=new Kl,this.observer.on(S.FRAG_DECRYPTED,o),this.observer.on(S.ERROR,o);const a=Gc(r.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const c=this.hls.logger;if(r.workerPath||x3()){try{r.workerPath?(c.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=A3(r.workerPath)):(c.log(`injecting Web Worker for "${t}"`),this.workerContext=E3());const{worker:u}=this.workerContext;u.addEventListener("message",this.onWorkerMessage),u.addEventListener("error",this.onWorkerError),u.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:ke(r)})}catch(u){c.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.terminateWorker(),this.error=null,this.transmuxer=new bu(this.observer,a,r,"",t,e.logger)}return}}this.transmuxer=new bu(this.observer,a,r,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Cu++;const t=this.hls.config,i=Gc(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:ke(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),S3(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,n,r,o,a,c,l,u){var h,f;l.transmuxing.start=self.performance.now();const{instanceNo:m,transmuxer:p}=this,g=o?o.start:r.start,y=r.decryptdata,v=this.frag,E=!(v&&r.cc===v.cc),x=!(v&&l.level===v.level),T=v?l.sn-v.sn:-1,A=this.part?l.part-this.part.index:-1,C=T===0&&l.id>1&&l.id===v?.stats.chunkCount,b=!x&&(T===1||T===0&&(A===1||C&&A<=0)),R=self.performance.now();(x||T||r.stats.parsing.start===0)&&(r.stats.parsing.start=R),o&&(A||!b)&&(o.stats.parsing.start=R);const I=!(v&&((h=r.initSegment)==null?void 0:h.url)===((f=v.initSegment)==null?void 0:f.url)),w=new pv(E,b,c,x,g,I);if(!b||E||I){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===se.MAIN?"level":"track"}: ${l.level} id: ${l.id}
        discontinuity: ${E}
        trackSwitch: ${x}
        contiguous: ${b}
        accurateTimeOffset: ${c}
        timeOffset: ${g}
        initSegmentChange: ${I}`);const M=new mv(i,n,t,a,u);this.configureTransmuxer(M)}if(this.frag=r,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:m,cmd:"demux",data:e,decryptdata:y,chunkMeta:l,state:w},e instanceof ArrayBuffer?[e]:[]);else if(p){const M=p.push(e,y,l,w);ps(M)?M.then(P=>{this.handleTransmuxComplete(P)}).catch(P=>{this.transmuxerError(P,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(M)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const n=i.flush(e);ps(n)?n.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")}):this.handleFlushResult(n,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const Ru=100;class L0 extends eo{constructor(e,t,i){super(e,t,i,"audio-stream-controller",se.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(S.LEVEL_LOADED,this.onLevelLoaded,this),e.on(S.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(S.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(S.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(S.BUFFER_RESET,this.onBufferReset,this),e.on(S.BUFFER_CREATED,this.onBufferCreated,this),e.on(S.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(S.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(S.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(S.FRAG_LOADING,this.onFragLoading,this),e.on(S.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(S.LEVEL_LOADED,this.onLevelLoaded,this),e.off(S.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(S.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(S.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(S.BUFFER_RESET,this.onBufferReset,this),e.off(S.BUFFER_CREATED,this.onBufferCreated,this),e.off(S.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(S.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(S.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(S.FRAG_LOADING,this.onFragLoading,this),e.off(S.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:r,trackId:o}){if(i===se.MAIN){const a=t.cc,c=this.fragCurrent;if(this.initPTS[a]={baseTime:n,timescale:r,trackId:o},this.log(`InitPTS for cc: ${a} found from main: ${n/r} (${n}/${r}) trackId: ${o}`),this.mainAnchor=t,this.state===q.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==a)&&this.syncWithAnchor(t,l?.frag)}else!this.hls.hasEnoughToStart&&c&&c.cc!==a?(c.abortRequests(),this.syncWithAnchor(t,c)):this.state===q.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const n=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&n?.cc===t.cc)return;const r=(n||e).cc,o=this.getLevelDetails(),a=this.getLoadPosition(),c=Vf(o,r,a);c&&(this.log(`Syncing with main frag at ${c.start} cc ${c.cc}`),this.startFragRequested=!1,this.nextLoadPosition=c.start,this.resetLoadingState(),this.state===q.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=q.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(Ru),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=q.IDLE):this.state=q.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case q.IDLE:this.doTickIdle();break;case q.WAITING_TRACK:{const{levels:e,trackId:t}=this,i=e?.[t],n=i?.details;if(n&&!this.waitForLive(i)){if(this.waitForCdnTuneIn(n))break;this.state=q.WAITING_INIT_PTS}break}case q.FRAG_LOADING_WAITING_RETRY:{this.checkRetryDate();break}case q.WAITING_INIT_PTS:{const e=this.waitingData;if(e){const{frag:t,part:i,cache:n,complete:r}=e,o=this.mainAnchor;if(this.initPTS[t.cc]!==void 0){this.waitingData=null,this.state=q.FRAG_LOADING;const a=n.flush().buffer,c={frag:t,part:i,payload:a,networkDetails:null};this._handleFragmentLoadProgress(c),r&&super._handleFragmentLoadComplete(c)}else o&&o.cc!==e.frag.cc&&this.syncWithAnchor(o,e.frag)}else this.state=q.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:n,trackId:r}=this,o=t.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[r]))return;const a=i[r],c=a.details;if(!c||this.waitForLive(a)||this.waitForCdnTuneIn(c)){this.state=q.WAITING_TRACK,this.startFragRequested=!1;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,Fe.AUDIO,se.AUDIO));const u=this.getFwdBufferInfo(l,se.AUDIO);if(u===null)return;if(!this.switchingTrack&&this._streamEnded(u,c)){t.trigger(S.BUFFER_EOS,{type:"audio"}),this.state=q.ENDED;return}const h=u.len,f=t.maxBufferLength,m=c.fragments,p=m[0].start,g=this.getLoadPosition(),y=this.flushing?g:u.end;if(this.switchingTrack&&n){const x=g;c.PTSKnown&&x<p&&(u.end>p||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=p+.05)}if(h>=f&&!this.switchingTrack&&y<m[m.length-1].start)return;let v=this.getNextFragment(y,c);if(v&&this.isLoopLoading(v,y)&&(v=this.getNextFragmentLoopLoading(v,c,u,se.MAIN,f)),!v){this.bufferFlushed=!0;return}let E=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&E&&Ke(v)&&!v.endList&&(!c.live||!this.loadingParts&&y<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(E)===et.OK&&(this.mainFragLoading=E=null),E&&Ke(E))){if(v.start>E.end){const T=this.fragmentTracker.getFragAtPos(y,se.MAIN);T&&T.end>E.end&&(E=T,this.mainFragLoading={frag:T,targetBufferTime:null})}if(v.start>E.end)return}this.loadFragment(v,a,y)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Bn(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==q.STOPPED&&(this.setInterval(Ru),this.state=q.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(S.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:n}=this,{details:r,id:o,groupId:a,track:c}=t;if(!n){this.warn(`Audio tracks reset while loading track ${o} "${c.name}" of "${a}"`);return}const l=this.mainDetails;if(!l||r.endCC>l.endCC||l.expired){this.cachedTrackLoadedData=t,this.state!==q.STOPPED&&(this.state=q.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${c.name}" of "${a}" loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const u=n[o];let h=0;if(r.live||(i=u.details)!=null&&i.live){if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;if(u.details){var f;h=this.alignPlaylists(r,u.details,(f=this.levelLastLoaded)==null?void 0:f.details)}r.alignedSliding||(c0(r,l),r.alignedSliding||Gr(r,l),h=r.fragmentStart)}u.details=r,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(l,h),this.hls.trigger(S.AUDIO_TRACK_UPDATED,{details:r,id:o,groupId:t.groupId}),this.state===q.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=q.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:r}=e,{config:o,trackId:a,levels:c}=this;if(!c){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const l=c[a];if(!l){this.warn("Audio track is undefined on fragment load progress");return}const u=l.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=o.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new _0(this.hls,se.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const m=this.initPTS[i.cc],p=(t=i.initSegment)==null?void 0:t.data;if(m!==void 0){const y=n?n.index:-1,v=y!==-1,E=new Zr(i.level,i.sn,i.stats.chunkCount,r.byteLength,y,v);f.push(r,p,h,"",i,n,u.totalduration,!1,E,m)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${a}`);const{cache:g}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new u0,complete:!1};g.push(new Uint8Array(r)),this.state!==q.STOPPED&&(this.state=q.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===se.MAIN&&Ke(t.frag)&&(this.mainFragLoading=t,this.state===q.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type!==se.AUDIO){!this.audioOnly&&i.type===se.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Ke(i)){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(S.AUDIO_TRACK_SWITCHED,Le({},r)))}this.fragBufferedComplete(i,n),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=q.ERROR;return}switch(t.details){case V.FRAG_GAP:case V.FRAG_PARSING_ERROR:case V.FRAG_DECRYPT_ERROR:case V.FRAG_LOAD_ERROR:case V.FRAG_LOAD_TIMEOUT:case V.KEY_LOAD_ERROR:case V.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(se.AUDIO,t);break;case V.AUDIO_TRACK_LOAD_ERROR:case V.AUDIO_TRACK_LOAD_TIMEOUT:case V.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===q.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Se.AUDIO_TRACK&&(this.state=q.IDLE);break;case V.BUFFER_ADD_CODEC_ERROR:case V.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case V.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case V.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==Fe.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==Fe.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===q.ENDED&&(this.state=q.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,se.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:c,part:l,level:u}=a,{details:h}=u,{audio:f,text:m,id3:p,initSegment:g}=r;if(this.fragContextChanged(c)||!h){this.fragmentTracker.removeFragment(c);return}if(this.state=q.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),g!=null&&g.tracks){const y=c.initSegment||c;if(this.unhandledEncryptionError(g,c))return;this._bufferInitSegment(u,g.tracks,y,o),n.trigger(S.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:i,tracks:g.tracks})}if(f){const{startPTS:y,endPTS:v,startDTS:E,endDTS:x}=f;l&&(l.elementaryStreams[Fe.AUDIO]={startPTS:y,endPTS:v,startDTS:E,endDTS:x}),c.setElementaryStreamInfo(Fe.AUDIO,y,v,E,x),this.bufferFragmentData(f,c,l,o)}if(p!=null&&(t=p.samples)!=null&&t.length){const y=De({id:i,frag:c,details:h},p);n.trigger(S.FRAG_PARSING_METADATA,y)}if(m){const y=De({id:i,frag:c,details:h},m);n.trigger(S.FRAG_PARSING_USERDATA,y)}}_bufferInitSegment(e,t,i,n){if(this.state!==q.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const r=t.audio;r.id=se.AUDIO;const o=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${o}/${r.codec}]`),o&&o.split(",").length===1&&(r.levelCodec=o),this.hls.trigger(S.BUFFER_CODECS,t);const a=r.initSegment;if(a!=null&&a.byteLength){const c={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:a};this.hls.trigger(S.BUFFER_APPENDING,c)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);if(this.switchingTrack||n===et.NOT_LOADED||n===et.PARTIAL){var r;if(!Ke(e))this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=q.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&Gr(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:n,characteristics:r,audioCodec:o,channels:a}=this.bufferedTrack;Wi({name:t,lang:i,assocLang:n,characteristics:r,audioCodec:o,channels:a},e,Ki)||(kr(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(S.AUDIO_TRACK_SWITCHED,Le({},e))}}class io extends Bt{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const n=t?.renditionReports;if(n){let r=-1;for(let o=0;o<n.length;o++){const a=n[o];let c;try{c=new self.URL(a.URI,t.url).href}catch(l){this.warn(`Could not construct new URL for Rendition Report: ${l}`),c=a.URI||""}if(c===e){r=o;break}else c===e.substring(0,c.length)&&(r=o)}if(r!==-1){const o=n[r],a=parseInt(o["LAST-MSN"])||t.lastPartSn;let c=parseInt(o["LAST-PART"])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);c>=0&&u>t.partTarget&&(c+=1)}const l=i&&$c(i);return new Wa(a,c>=0?c:void 0,l)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:n,stats:r}=t,o=self.performance.now(),a=r.loading.first?Math.max(0,o-r.loading.first):0;n.advancedDateTime=Date.now()-a;const c=this.hls.config.timelineOffset;if(c!==n.appliedTimelineOffset){const u=Math.max(c||0,0);n.appliedTimelineOffset=u,n.fragments.forEach(h=>{h.setStart(h.playlistOffset+u)})}if(n.live||i!=null&&i.live){const u="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(i),i&&n.fragments.length>0){l3(i,n,this);const E=n.playlistParsingError;if(E){this.warn(E);const x=this.hls;if(!x.config.ignorePlaylistParsingErrors){var l;const{networkDetails:T}=t;x.trigger(S.ERROR,{type:ae.NETWORK_ERROR,details:V.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:E,reason:E.message,level:t.level||void 0,parent:(l=n.fragments[0])==null?void 0:l.type,networkDetails:T,stats:r});return}n.playlistParsingError=null}}n.requestScheduled===-1&&(n.requestScheduled=r.loading.start);const h=this.hls.mainForwardBufferInfo,f=h?h.end-h.len:0,m=(n.edge-f)*1e3,p=s0(n,m);if(n.requestScheduled+p<o?n.requestScheduled=o:n.requestScheduled+=p,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let g,y,v;if(n.canBlockReload&&n.endSN&&n.advanced){const E=this.hls.config.lowLatencyMode,x=n.lastPartSn,T=n.endSN,A=n.lastPartIndex,C=A!==-1,b=x===T;C?b?(y=T+1,v=E?0:A):(y=x,v=E?A+1:n.maxPartIndex):y=T+1;const R=n.age,I=R+n.ageHeader;let w=Math.min(I-n.partTarget,n.targetduration*1.5);if(w>0){if(I>n.targetduration*3)this.log(`Playlist last advanced ${R.toFixed(2)}s ago. Omitting segment and part directives.`),y=void 0,v=void 0;else if(i!=null&&i.tuneInGoal&&I-n.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${w} with playlist age: ${n.age}`),w=0;else{const M=Math.floor(w/n.targetduration);if(y+=M,v!==void 0){const P=Math.round(w%n.targetduration/n.partTarget);v+=P}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${R.toFixed(2)}s goal: ${w} skip sn ${M} to part ${v}`)}n.tuneInGoal=w}if(g=this.getDeliveryDirectives(n,t.deliveryDirectives,y,v),E||!b){n.requestScheduled=o,this.loadingPlaylist(u,g);return}}else(n.canBlockReload||n.canSkipUntil)&&(g=this.getDeliveryDirectives(n,t.deliveryDirectives,y,v));g&&y!==void 0&&n.canBlockReload&&(n.requestScheduled=r.loading.first+Math.max(p-a*2,p/2)),this.scheduleLoading(u,g,n)}else this.clearTimer()}scheduleLoading(e,t,i){const n=i||e.details;if(!n){this.loadingPlaylist(e,t);return}const r=self.performance.now(),o=n.requestScheduled;if(r>=o){this.loadingPlaylist(e,t);return}const a=o-r;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,n){let r=$c(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,r=rs.No),new Wa(i,n,r)}checkRetry(e){const t=e.details,i=Or(e),n=e.errorAction,{action:r,retryCount:o=0,retryConfig:a}=n||{},c=!!n&&!!a&&(r===qe.RetryRequest||!n.resolved&&r===qe.SendAlternateToPenaltyBox);if(c){var l;if(o>=a.maxNumRetry)return!1;if(i&&(l=e.context)!=null&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=Nl(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,n.resolved=!0}return c}}function P0(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!gs(s[t].attrs,e[t].attrs))return!1;return!0}function gs(s,e,t){const i=s["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>s[n]!==e[n])}function tl(s,e){return e.label.toLowerCase()===s.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(s.lang||"").toLowerCase())}class M0 extends io{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_PARSED,this.onManifestParsed,this),e.on(S.LEVEL_LOADING,this.onLevelLoading,this),e.on(S.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(S.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(S.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_PARSED,this.onManifestParsed,this),e.off(S.LEVEL_LOADING,this.onLevelLoading,this),e.off(S.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(S.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(S.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Audio track with id:${i} and group:${n} not found in active group ${o?.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let r=this.currentTrack;if(!i||n?.length!==i?.length||i!=null&&i.some(a=>n?.indexOf(a)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(f=>f.default)&&(this.selectDefaultTrack=!1),a.forEach((f,m)=>{f.id=m});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const c=this.hls.config.audioPreference;if(!r&&c){const f=qt(c,a,Ki);if(f>-1)r=a[f];else{const m=qt(c,this.tracks);r=this.tracks[m]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const u={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i?.join(",")}`),this.hls.trigger(S.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(l!==-1&&h===-1)this.setAudioTrack(l);else if(a.length&&h===-1){var o;const f=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(f.message),this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}}onError(e,t){t.fatal||!t.context||t.context.type===Se.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&Wi(e,n,Ki))return n;const r=qt(e,this.tracksInGroup,Ki);if(r>-1){const o=this.tracksInGroup[r];return this.setAudioTrack(r),o}else if(n){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=My(e,t.levels,i,o,Ki);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=qt(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],r=n.details&&!n.details.live;if(e===this.trackId&&n===i&&r||(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(S.AUDIO_TRACK_SWITCHING,Le({},n)),r))return;const o=this.switchParams(n.url,i?.details,n.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(!(this.selectDefaultTrack&&!n.default)&&(!e||Wi(e,n,Ki)))return i}if(e){const{name:i,lang:n,assocLang:r,characteristics:o,audioCodec:a,channels:c}=e;for(let l=0;l<t.length;l++){const u=t[l];if(Wi({name:i,lang:n,assocLang:r,characteristics:o,audioCodec:a,channels:c},u,Ki))return l}for(let l=0;l<t.length;l++){const u=t[l];if(gs(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){const u=t[l];if(gs(e.attrs,u.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&kr(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(S.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:n,deliveryDirectives:t||null,track:e})}}class gv{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const n=this.queues[t];n.push(e),n.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(r){var i;if(n.onError(r),this.queues===null||this.tracks===null)return;const o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],n=i?.buffer;return n?`SourceBuffer${n.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const wu=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,D0="HlsJsTrackRemovedError";class yv extends Error{constructor(e){super(e),this.name=D0}}class B0 extends Bt{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var n;this.hls&&((n=this.mediaSource)==null?void 0:n.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:n,mediaSource:r}=this;i&&this.log("Media source opened"),!(!n||!r)&&(r.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(S.MEDIA_ATTACHED,{media:n,mediaSource:r}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:n}=this;i!==n&&this.error(`Media element src was set while attaching MediaSource (${n} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=j2(mi(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_PARSED,this.onManifestParsed,this),e.on(S.BUFFER_RESET,this.onBufferReset,this),e.on(S.BUFFER_APPENDING,this.onBufferAppending,this),e.on(S.BUFFER_CODECS,this.onBufferCodecs,this),e.on(S.BUFFER_EOS,this.onBufferEos,this),e.on(S.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(S.FRAG_PARSED,this.onFragParsed,this),e.on(S.FRAG_CHANGED,this.onFragChanged,this),e.on(S.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_PARSED,this.onManifestParsed,this),e.off(S.BUFFER_RESET,this.onBufferReset,this),e.off(S.BUFFER_APPENDING,this.onBufferAppending,this),e.off(S.BUFFER_CODECS,this.onBufferCodecs,this),e.off(S.BUFFER_EOS,this.onBufferEos,this),e.off(S.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(S.FRAG_PARSED,this.onFragParsed,this),e.off(S.FRAG_CHANGED,this.onFragChanged,this),e.off(S.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const r=this.isUpdating();r||this.operationQueue.removeBlockers();const o=this.isQueued();(r||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${r?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const n=this.transferData;return!this.sourceBufferCount&&n&&n.mediaSource===t?De(i,n.tracks):this.sourceBuffers.forEach(r=>{const[o]=r;o&&(i[o]=De({},this.tracks[o]),this.removeBuffer(o)),r[0]=r[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsTotal=n,this.log(`${n} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&n&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media;this.transferData=this.overrides=void 0;const n=mi(this.appendSource);if(n){const r=!!t.mediaSource;(r||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const o=this.mediaSource=t.mediaSource||new n;if(this.assignMediaSource(o),r)this._objectUrl=i.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const c=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||c&&o instanceof c,Iu(i),vv(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,n=t.tracks,r=n?Object.keys(n):null,o=r?r.length:0,a=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(n&&r&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${ke(i,(c,l)=>c==="initSegment"?void 0:l)};
transfer tracks: ${ke(n,(c,l)=>c==="initSegment"?void 0:l)}}`),!Rf(n,i)){t.mediaSource=null,t.tracks=void 0;const c=e.currentTime,l=this.details,u=Math.max(c,l?.fragments[0].start||0);if(u-c>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${c} -> ${u}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(n)}"->"${Object.keys(i)}") start time: ${u} currentTime: ${c}`),this.onMediaDetaching(S.MEDIA_DETACHING,{}),this.onMediaAttaching(S.MEDIA_ATTACHING,t),e.currentTime=u;return}this.transferData=void 0,r.forEach(c=>{const l=c,u=n[l];if(u){const h=u.buffer;if(h){const f=this.fragmentTracker,m=u.id;if(f.hasFragments(m)||f.hasParts(m)){const y=pe.getBuffered(h);f.detectEvictedFragments(l,y,m,null,!0)}const p=Vo(l),g=[l,h];this.sourceBuffers[p]=g,h.updating&&this.operationQueue&&this.operationQueue.prependBlocker(l),this.trackSourceBuffer(l,u)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:n,mediaSource:r,_objectUrl:o}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=r.readyState==="open";try{const c=r.sourceBuffers;for(let l=c.length;l--;)a&&c[l].abort(),r.removeSourceBuffer(c[l]);a&&r.endOfStream()}catch(c){this.warn(`onMediaDetaching: ${c.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}n&&(n.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(n.removeAttribute("src"),this.appendSource&&Iu(n),n.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(S.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(r){this.warn(`onBufferReset ${e}`,r)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Vo(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new gv(this.tracks)}onBufferCodecs(e,t){var i;const n=this.tracks,r=Object.keys(t);this.log(`BUFFER_CODECS: "${r}" (current SB count ${this.sourceBufferCount})`);const o="audiovideo"in t&&(n.audio||n.video)||n.audiovideo&&("audio"in t||"video"in t),a=!o&&this.sourceBufferCount&&this.media&&r.some(c=>!n[c]);if(o||a){this.warn(`Unsupported transition between "${Object.keys(n)}" and "${r}" SourceBuffers`);return}r.forEach(c=>{var l,u;const h=t[c],{id:f,codec:m,levelCodec:p,container:g,metadata:y,supplemental:v}=h;let E=n[c];const x=(l=this.transferData)==null||(l=l.tracks)==null?void 0:l[c],T=x!=null&&x.buffer?x:E,A=T?.pendingCodec||T?.codec,C=T?.levelCodec;E||(E=n[c]={buffer:void 0,listeners:[],codec:m,supplemental:v,container:g,levelCodec:p,metadata:y,id:f});const b=br(A,C),R=b?.replace(wu,"$1");let I=br(m,p);const w=(u=I)==null?void 0:u.replace(wu,"$1");I&&b&&R!==w&&(c.slice(0,5)==="audio"&&(I=Br(I,this.appendSource)),this.log(`switching codec ${A} to ${I}`),I!==(E.pendingCodec||E.codec)&&(E.pendingCodec=I),E.container=g,this.appendChangeType(c,g,I))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!t.video&&((i=t.audio)==null?void 0:i.id)==="main"&&(this.log("Main audio-only"),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const n=`${t};codecs=${i}`,r={label:`change-type=${n}`,execute:()=>{const o=this.tracks[e];if(o){const a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${n}`),a.changeType(n),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(r,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,n=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,se.MAIN))==null?void 0:t.gap)===!0)return;const o={label:"block-audio",execute:()=>{var a;const c=this.tracks.video;(this.lastVideoAppendEnd>n||c!=null&&c.buffer&&pe.isBuffered(c.buffer,n)||((a=this.fragmentTracker.getAppendedFrag(n,se.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:n,type:r,parent:o,frag:a,part:c,chunkMeta:l,offset:u}=t,h=l.buffering[r],{sn:f,cc:m}=a,p=self.performance.now();h.start=p;const g=a.stats.buffering,y=c?c.stats.buffering:null;g.start===0&&(g.start=p),y&&y.start===0&&(y.start=p);const v=i.audio;let E=!1;r==="audio"&&v?.container==="audio/mpeg"&&(E=!this.lastMpegAudioChunk||l.id===1||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);const x=i.video,T=x?.buffer;if(T&&f!=="initSegment"){const b=c||a,R=this.blockedAudioAppend;if(r==="audio"&&o!=="main"&&!this.blockedAudioAppend&&!(x.ending||x.ended)){const w=b.start+b.duration*.05,M=T.buffered,P=this.currentOp("video");!M.length&&!P?this.blockAudio(b):!P&&!pe.isBuffered(T,w)&&this.lastVideoAppendEnd<w&&this.blockAudio(b)}else if(r==="video"){const I=b.end;if(R){const w=R.frag.start;(I>w||I<this.lastVideoAppendEnd||pe.isBuffered(T,w))&&this.unblockAudio()}this.lastVideoAppendEnd=I}}const A=(c||a).start,C={label:`append-${r}`,execute:()=>{var b;h.executeStart=self.performance.now();const R=(b=this.tracks[r])==null?void 0:b.buffer;R&&(E?this.updateTimestampOffset(R,A,.1,r,f,m):u!==void 0&&ie(u)&&this.updateTimestampOffset(R,u,1e-6,r,f,m)),this.appendExecutor(n,r)},onStart:()=>{},onComplete:()=>{const b=self.performance.now();h.executeEnd=h.end=b,g.first===0&&(g.first=b),y&&y.first===0&&(y.first=b);const R={};this.sourceBuffers.forEach(([I,w])=>{I&&(R[I]=pe.getBuffered(w))}),this.appendErrors[r]=0,r==="audio"||r==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(S.BUFFER_APPENDED,{type:r,frag:a,part:c,chunkMeta:l,parent:a.type,timeRanges:R})},onError:b=>{var R;const I={type:ae.MEDIA_ERROR,parent:a.type,details:V.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:a,part:c,chunkMeta:l,error:b,err:b,fatal:!1},w=(R=this.media)==null?void 0:R.error;if(b.code===DOMException.QUOTA_EXCEEDED_ERR||b.name=="QuotaExceededError"||"quota"in b)I.details=V.BUFFER_FULL_ERROR;else if(b.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!w)I.errorAction=Cn(!0);else if(b.name===D0&&this.sourceBufferCount===0)I.errorAction=Cn(!0);else{const M=++this.appendErrors[r];this.warn(`Failed ${M}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${w||"no media error"})`),(M>=this.hls.config.appendErrorMaxRetry||w)&&(I.fatal=!0)}this.hls.trigger(S.ERROR,I)}};this.log(`queuing "${r}" append sn: ${f}${c?" p: "+c.index:""} of ${a.type===se.MAIN?"level":"track"} ${a.level} cc: ${m}`),this.append(C,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(S.BUFFER_FLUSHED,{type:e})},onError:n=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,n)}}}onBufferFlushing(e,t){const{type:i,startOffset:n,endOffset:r}=t;i?this.append(this.getFlushOp(i,n,r),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,n,r),o)})}onFragParsed(e,t){const{frag:i,part:n}=t,r=[],o=n?n.elementaryStreams:i.elementaryStreams;o[Fe.AUDIOVIDEO]?r.push("audiovideo"):(o[Fe.AUDIO]&&r.push("audio"),o[Fe.VIDEO]&&r.push("video"));const a=()=>{const c=self.performance.now();i.stats.buffering.end=c,n&&(n.stats.buffering.end=c);const l=n?n.stats:i.stats;this.hls.trigger(S.FRAG_BUFFERED,{frag:i,part:n,stats:l,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,r).catch(c=>{this.warn(`Fragment buffered callback ${c}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){const t=this.tracks[e];if(t)return!t.ended||t.ending}return!1})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){const a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});const n=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})?n?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(S.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(S.BUFFERED_TO_END,void 0)):t.type==="video"&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===V.BUFFER_APPEND_ERROR&&t.frag){var i;const n=(i=t.errorAction)==null?void 0:i.nextAutoLevel;ie(n)&&n!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const n=e.config,r=i.currentTime,o=t.levelTargetDuration,a=t.live&&n.liveBackBufferLength!==null?n.liveBackBufferLength:n.backBufferLength;if(ie(a)&&a>=0){const l=Math.max(a,o),u=Math.floor(r/o)*o-l;this.flushBackBuffer(r,o,u)}const c=n.frontBufferFlushThreshold;if(ie(c)&&c>0){const l=Math.max(n.maxBufferLength,c),u=Math.max(l,o),h=Math.floor(r/o)*o+u;this.flushFrontBuffer(r,o,h)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([n,r])=>{if(r){const a=pe.getBuffered(r);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(S.BACK_BUFFER_REACHED,{bufferEnd:i});const c=this.tracks[n];if((o=this.details)!=null&&o.live)this.hls.trigger(S.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(c!=null&&c.ended){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(S.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([n,r])=>{if(r){const o=pe.getBuffered(r),a=o.length;if(a<2)return;const c=o.start(a-1),l=o.end(a-1);if(i>c||e>=c&&e<=l)return;this.hls.trigger(S.BUFFER_FLUSHING,{startOffset:c,endOffset:1/0,type:n})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||i?.readyState!=="open")return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&i.setLiveSeekableRange){const l=Math.max(0,t.fragmentStart),u=Math.max(l,n);return{duration:1/0,start:l,end:u}}return{duration:1/0}}const r=(e=this.overrides)==null?void 0:e.duration;if(r)return ie(r)?{duration:r}:null;const o=this.media.duration,a=ie(i.duration)?i.duration:0;return n>a&&n>o||!ie(o)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:i}){const n=this.mediaSource;!this.media||!n||n.readyState!=="open"||(n.duration!==e&&(ie(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${i}.`),n.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${ke(i)}`),this.tracksReady){var n;const r=(n=this.transferData)==null?void 0:n.tracks;r&&Object.keys(r).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const n=this.tracks[t];e[t]={buffer:i,container:n.container,codec:n.codec,supplemental:n.supplemental,levelCodec:n.levelCodec,id:n.id,metadata:n.metadata}}}),this.hls.trigger(S.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const r in e){const o=r,a=e[o];if(this.isPending(a)){const c=this.getTrackCodec(a,o),l=`${a.container};codecs=${c}`;a.codec=c,this.log(`creating sourceBuffer(${l})${this.currentOp(o)?" Queued":""} ${ke(a)}`);try{const u=i.addSourceBuffer(l),h=Vo(o),f=[o,u];t[h]=f,a.buffer=u}catch(u){var n;this.error(`error while trying to add sourceBuffer: ${u.message}`),this.shiftAndExecuteNext(o),(n=this.operationQueue)==null||n.removeBlockers(),delete this.tracks[o],this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:u,sourceBufferName:o,mimeType:l,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let n=e.codec;i&&(t==="video"||t==="audiovideo")&&hs(i,"video")&&(n=fy(n,i));const r=br(n,e.levelCodec);return r?t.slice(0,5)==="audio"?Br(r,this.appendSource):r:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const n=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:n,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(r,o)=>{const a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(S.BUFFER_FLUSHED,{type:r})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i?.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const r=this.currentOp(e);r&&r.onError(n)}updateTimestampOffset(e,t,i,n,r,o){const a=t-e.timestampOffset;Math.abs(a)>=i&&(this.log(`Updating ${n} SourceBuffer timestampOffset to ${t} (sn: ${r} cc: ${o})`),e.timestampOffset=t)}removeExecutor(e,t,i){const{media:n,mediaSource:r}=this,o=this.tracks[e],a=o?.buffer;if(!n||!r||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const c=ie(n.duration)?n.duration:1/0,l=ie(r.duration)?r.duration:1/0,u=Math.max(0,t),h=Math.min(i,c,l);h>u&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${u},${h}] from the ${e} SourceBuffer`),a.remove(u,h)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],n=i?.buffer;if(!n)throw new yv(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,n.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(n).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const n=(i=this.tracks[t])==null?void 0:i.buffer;!n||n.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const n=this.tracks[e];if(!n)return;const r=n.buffer;if(!r)return;const o=i.bind(this,e);n.listeners.push({event:t,listener:o}),r.addEventListener(t,o)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(n=>{i.removeEventListener(n.event,n.listener)}),t.listeners.length=0)}}function Iu(s){const e=s.querySelectorAll("source");[].slice.call(e).forEach(t=>{s.removeChild(t)})}function vv(s,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,s.appendChild(t)}function Vo(s){return s==="audio"?1:0}class no{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(S.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(S.MANIFEST_PARSED,this.onManifestParsed,this),e.on(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(S.BUFFER_CODECS,this.onBufferCodecs,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(S.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(S.MANIFEST_PARSED,this.onManifestParsed,this),e.off(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(S.BUFFER_CODECS,this.onBufferCodecs,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&ie(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((n,r)=>this.isLevelAllowed(n)&&r<=e);return this.clientRect=null,no.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const n=(a,c)=>c?a.width!==c.width||a.height!==c.height:!0;let r=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const c=e[a];if((c.width>=o||c.height>=o)&&n(c,e[a+1])){r=a;break}}return r}}const xv={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},gt=xv,Ev={HLS:"h"},Av=Ev;class ti{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof ti?i:new ti(i))),this.value=e,this.params=t}}const Sv="Dict";function Tv(s){return Array.isArray(s)?JSON.stringify(s):s instanceof Map?"Map{}":s instanceof Set?"Set{}":typeof s=="object"?JSON.stringify(s):String(s)}function bv(s,e,t,i){return new Error(`failed to ${s} "${Tv(e)}" as ${t}`,{cause:i})}function ii(s,e,t){return bv("serialize",s,e,t)}class F0{constructor(e){this.description=e}}const _u="Bare Item",Cv="Boolean";function Rv(s){if(typeof s!="boolean")throw ii(s,Cv);return s?"?1":"?0"}function wv(s){return btoa(String.fromCharCode(...s))}const Iv="Byte Sequence";function _v(s){if(ArrayBuffer.isView(s)===!1)throw ii(s,Iv);return`:${wv(s)}:`}const Lv="Integer";function Pv(s){return s<-999999999999999||999999999999999<s}function k0(s){if(Pv(s))throw ii(s,Lv);return s.toString()}function Mv(s){return`@${k0(s.getTime()/1e3)}`}function O0(s,e){if(s<0)return-O0(-s,e);const t=Math.pow(10,e);if(Math.abs(s*t%1-.5)<Number.EPSILON){const n=Math.floor(s*t);return(n%2===0?n:n+1)/t}else return Math.round(s*t)/t}const Dv="Decimal";function Bv(s){const e=O0(s,3);if(Math.floor(Math.abs(e)).toString().length>12)throw ii(s,Dv);const t=e.toString();return t.includes(".")?t:`${t}.0`}const Fv="String",kv=/[\x00-\x1f\x7f]+/;function Ov(s){if(kv.test(s))throw ii(s,Fv);return`"${s.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function Nv(s){return s.description||s.toString().slice(7,-1)}const Uv="Token";function Lu(s){const e=Nv(s);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw ii(e,Uv);return e}function il(s){switch(typeof s){case"number":if(!ie(s))throw ii(s,_u);return Number.isInteger(s)?k0(s):Bv(s);case"string":return Ov(s);case"symbol":return Lu(s);case"boolean":return Rv(s);case"object":if(s instanceof Date)return Mv(s);if(s instanceof Uint8Array)return _v(s);if(s instanceof F0)return Lu(s);default:throw ii(s,_u)}}const zv="Key";function nl(s){if(/^[a-z*][a-z0-9\-_.*]*$/.test(s)===!1)throw ii(s,zv);return s}function Jl(s){return s==null?"":Object.entries(s).map(([e,t])=>t===!0?`;${nl(e)}`:`;${nl(e)}=${il(t)}`).join("")}function N0(s){return s instanceof ti?`${il(s.value)}${Jl(s.params)}`:il(s)}function Gv(s){return`(${s.value.map(N0).join(" ")})${Jl(s.params)}`}function $v(s,e={whitespace:!0}){if(typeof s!="object"||s==null)throw ii(s,Sv);const t=s instanceof Map?s.entries():Object.entries(s),i=e?.whitespace?" ":"";return Array.from(t).map(([n,r])=>{r instanceof ti||(r=new ti(r));let o=nl(n);return r.value===!0?o+=Jl(r.params):(o+="=",Array.isArray(r.value)?o+=Gv(r):o+=N0(r)),o}).join(`,${i}`)}function U0(s,e){return $v(s,e)}const Vt="CMCD-Object",$e="CMCD-Request",zi="CMCD-Session",Ri="CMCD-Status",Hv={br:Vt,ab:Vt,d:Vt,ot:Vt,tb:Vt,tpb:Vt,lb:Vt,tab:Vt,lab:Vt,url:Vt,pb:$e,bl:$e,tbl:$e,dl:$e,ltc:$e,mtp:$e,nor:$e,nrr:$e,rc:$e,sn:$e,sta:$e,su:$e,ttfb:$e,ttfbb:$e,ttlb:$e,cmsdd:$e,cmsds:$e,smrt:$e,df:$e,cs:$e,ts:$e,cid:zi,pr:zi,sf:zi,sid:zi,st:zi,v:zi,msd:zi,bs:Ri,bsd:Ri,cdn:Ri,rtp:Ri,bg:Ri,pt:Ri,ec:Ri,e:Ri},Kv={REQUEST:$e};function Vv(s){return Object.keys(s).reduce((e,t)=>{var i;return(i=s[t])===null||i===void 0||i.forEach(n=>e[n]=t),e},{})}function jv(s,e){const t={};if(!s)return t;const i=Object.keys(s),n=e?Vv(e):{};return i.reduce((r,o)=>{var a;const c=Hv[o]||n[o]||Kv.REQUEST,l=(a=r[c])!==null&&a!==void 0?a:r[c]={};return l[o]=s[o],r},t)}function Wv(s){return["ot","sf","st","e","sta"].includes(s)}function Xv(s){return typeof s=="number"?ie(s):s!=null&&s!==""&&s!==!1}const z0="event";function Yv(s,e){const t=new URL(s),i=new URL(e);if(t.origin!==i.origin)return s;const n=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;n[0]===r[0];)n.shift(),r.shift();for(;r.length;)r.shift(),n.unshift("..");return n.join("/")+t.search+t.hash}const Ir=s=>Math.round(s),sl=(s,e)=>Array.isArray(s)?s.map(t=>sl(t,e)):s instanceof ti&&typeof s.value=="string"?new ti(sl(s.value,e),s.params):(e.baseUrl&&(s=Yv(s,e.baseUrl)),e.version===1?encodeURIComponent(s):s),$s=s=>Ir(s/100)*100,Qv=(s,e)=>{let t=s;return e.version>=2&&(s instanceof ti&&typeof s.value=="string"?t=new ti([s]):typeof s=="string"&&(t=[s])),sl(t,e)},Jv={br:Ir,d:Ir,bl:$s,dl:$s,mtp:$s,nor:Qv,rtp:$s,tb:Ir},G0="request",$0="response",ql=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],qv=["e"],Zv=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function so(s){return Zv.test(s)}function ex(s){return ql.includes(s)||qv.includes(s)||so(s)}const H0=["d","dl","nor","ot","rtp","su"];function tx(s){return ql.includes(s)||H0.includes(s)||so(s)}const ix=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function nx(s){return ql.includes(s)||H0.includes(s)||ix.includes(s)||so(s)}const sx=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function rx(s){return sx.includes(s)||so(s)}const ox={[$0]:nx,[z0]:ex,[G0]:tx};function K0(s,e={}){const t={};if(s==null||typeof s!="object")return t;const i=e.version||s.v||1,n=e.reportingMode||G0,r=i===1?rx:ox[n];let o=Object.keys(s).filter(r);const a=e.filter;typeof a=="function"&&(o=o.filter(a));const c=n===$0||n===z0;c&&!o.includes("ts")&&o.push("ts"),i>1&&!o.includes("v")&&o.push("v");const l=De({},Jv,e.formatters),u={version:i,reportingMode:n,baseUrl:e.baseUrl};return o.sort().forEach(h=>{let f=s[h];const m=l[h];if(typeof m=="function"&&(f=m(f,u)),h==="v"){if(i===1)return;f=i}h=="pr"&&f===1||(c&&h==="ts"&&!ie(f)&&(f=Date.now()),Xv(f)&&(Wv(h)&&typeof f=="string"&&(f=new F0(f)),t[h]=f))}),t}function ax(s,e={}){const t={};if(!s)return t;const i=K0(s,e),n=jv(i,e?.customHeaderMap);return Object.entries(n).reduce((r,[o,a])=>{const c=U0(a,{whitespace:!1});return c&&(r[o]=c),r},t)}function lx(s,e,t){return De(s,ax(e,t))}const cx="CMCD";function ux(s,e={}){return s?U0(K0(s,e),{whitespace:!1}):""}function hx(s,e={}){if(!s)return"";const t=ux(s,e);return encodeURIComponent(t)}function dx(s,e={}){if(!s)return"";const t=hx(s,e);return`${cx}=${t}`}const Pu=/CMCD=[^&#]+/;function fx(s,e,t){const i=dx(e,t);if(!i)return s;if(Pu.test(s))return s.replace(Pu,i);const n=s.includes("?")?"&":"?";return`${s}${n}${i}`}class V0{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=n=>{try{this.apply(n,{ot:gt.MANIFEST,su:!this.initialized})}catch(r){this.hls.logger.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=n=>{try{const{frag:r,part:o}=n,a=this.hls.levels[r.level],c=this.getObjectType(r),l={d:(o||r).duration*1e3,ot:c};(c===gt.VIDEO||c===gt.AUDIO||c==gt.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(c)/1e3,l.bl=this.getBufferLength(c));const u=o?this.getNextPart(o):this.getNextFrag(r);u!=null&&u.url&&u.url!==r.url&&(l.nor=u.url),this.apply(n,l)}catch(r){this.hls.logger.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHED,this.onMediaDetached,this),e.on(S.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHED,this.onMediaDetached,this),e.off(S.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(n=t.tracks.video)==null?void 0:n.buffer}createData(){var e;return{v:1,sf:Av.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){De(t,this.createData());const i=t.ot===gt.INIT||t.ot===gt.VIDEO||t.ot===gt.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce((o,a)=>(n.includes(a)&&(o[a]=t[a]),o),{}));const r={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),lx(e.headers,t,r)):e.url=fx(e.url,t,r)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const n=e.sn-i.startSN;return i.fragments[n+1]}}getNextPart(e){var t;const{index:i,fragment:n}=e,r=(t=this.hls.levels[n.level])==null||(t=t.details)==null?void 0:t.partList;if(r){const{sn:o}=n;for(let a=r.length-1;a>=0;a--){const c=r[a];if(c.index===i&&c.fragment.sn===o)return r[a+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return gt.TIMED_TEXT;if(e.sn==="initSegment")return gt.INIT;if(t==="audio")return gt.AUDIO;if(t==="main")return this.hls.audioTracks.length?gt.VIDEO:gt.MUXED}getTopBandwidth(e){let t=0,i;const n=this.hls;if(e===gt.AUDIO)i=n.audioTracks;else{const r=n.maxAutoLevel,o=r>-1?r+1:n.levels.length;i=n.levels.slice(0,o)}return i.forEach(r=>{r.bitrate>t&&(t=r.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===gt.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:pe.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}}const mx=3e5;class j0 extends Bt{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(S.MANIFEST_PARSED,this.onManifestParsed,this),e.on(S.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(S.MANIFEST_PARSED,this.onManifestParsed,this),e.off(S.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if(i?.action===qe.SendAlternateToPenaltyBox&&i.flags===vt.MoveAllAlternatesMatchingHost){const n=this.levels;let r=this._pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:c,type:l}=t.context;a&&n?o=this.getPathwayForGroupId(a,l,o):c&&(o=c)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!r&&n&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==o),t.details===V.BUFFER_APPEND_ERROR&&!t.fatal?i.resolved=!0:i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${n&&n.length} priorities: ${ke(r)} penalized: ${ke(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach(r=>{n-i[r]>mx&&delete i[r]});for(let r=0;r<e.length;r++){const o=e[r];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,c=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,a0(t),this.hls.trigger(S.LEVELS_UPDATED,{levels:t});const l=this.hls.levels[a];c&&l&&this.levels&&(l.attrs["STABLE-VARIANT-ID"]!==c.attrs["STABLE-VARIANT-ID"]&&l.bitrate!==c.bitrate&&this.log(`Unstable Pathways change from bitrate ${c.bitrate} to ${l.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<n.length;r++)if(t===Se.AUDIO_TRACK&&n[r].hasAudioGroup(e)||t===Se.SUBTITLE_TRACK&&n[r].hasSubtitleGroup(e))return n[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach(r=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":c}=r;if(t.some(u=>u.pathwayId===o))return;const l=this.getLevelsForPathway(a).map(u=>{const h=new Ue(u.attrs);h["PATHWAY-ID"]=o;const f=h.AUDIO&&`${h.AUDIO}_clone_${o}`,m=h.SUBTITLES&&`${h.SUBTITLES}_clone_${o}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),m&&(n[h.SUBTITLES]=m,h.SUBTITLES=m);const p=W0(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",c),g=new Bn({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:p,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let y=1;y<u.audioGroups.length;y++)g.addGroupId("audio",`${u.audioGroups[y]}_clone_${o}`);if(u.subtitleGroups)for(let y=1;y<u.subtitleGroups.length;y++)g.addGroupId("text",`${u.subtitleGroups[y]}_clone_${o}`);return g});t.push(...l),Mu(this.audioTracks,i,c,o),Mu(this.subtitleTracks,n,c,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let n;try{n=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(n.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+u)}const r={responseType:"json",url:n.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},c={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(u,h,f,m)=>{this.log(`Loaded steering manifest: "${n}"`);const p=u.data;if(p?.VERSION!==1){this.log(`Steering VERSION ${p.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=p.TTL;const{"RELOAD-URI":g,"PATHWAY-CLONES":y,"PATHWAY-PRIORITY":v}=p;if(g)try{this.uri=new self.URL(g,n).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${g}`);return}this.scheduleRefresh(this.uri||f.url),y&&this.clonePathways(y);const E={steeringManifest:p,url:n.toString()};this.hls.trigger(S.STEERING_MANIFEST_LOADED,E),v&&this.updatePathwayPriority(v)},onError:(u,h,f,m)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let p=this.timeToLoad*1e3;if(u.code===429){const g=this.loader;if(typeof g?.getResponseHeader=="function"){const y=g.getResponseHeader("Retry-After");y&&(p=parseFloat(y)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,p)},onTimeout:(u,h,f)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(r,c,l)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const n=(i=this.hls)==null?void 0:i.media;if(n&&!n.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function Mu(s,e,t,i){s&&Object.keys(e).forEach(n=>{const r=s.filter(o=>o.groupId===n).map(o=>{const a=De({},o);return a.details=void 0,a.attrs=new Ue(a.attrs),a.url=a.attrs.URI=W0(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[n],a.attrs["PATHWAY-ID"]=i,a});s.push(...r)})}function W0(s,e,t,i){const{HOST:n,PARAMS:r,[t]:o}=i;let a;e&&(a=o?.[e],a&&(s=a));const c=new self.URL(s);return n&&!a&&(c.host=n),r&&Object.keys(r).sort().forEach(l=>{l&&c.searchParams.set(l,r[l])}),c.href}class Xi extends Bt{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=Xi.CDMCleanupPromise?[Xi.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=t=>{const{initDataType:i,initData:n}=t,r=`"${t.type}" event: init data type: "${i}"`;if(this.debug(r),n!==null){if(!this.keyFormatPromise){let o=Object.keys(this.keySystemAccessPromises);o.length||(o=is(this.config));const a=o.map(Oo).filter(c=>!!c);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(o=>{const a=Cr(o);if(i!=="sinf"||a!==ze.FAIRPLAY){this.log(`Ignoring "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}let c;try{const m=Je(new Uint8Array(n)),p=$l(JSON.parse(m).sinf),g=Ff(p);if(!g)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");c=new Uint8Array(g.subarray(8,24))}catch(m){this.warn(`${r} Failed to parse sinf: ${m}`);return}const l=at(c),{keyIdToKeySessionPromise:u,mediaKeySessions:h}=this;let f=u[l];for(let m=0;m<h.length;m++){const p=h[m],g=p.decryptdata;if(!g.keyId)continue;const y=at(g.keyId);if(Ur(c,g.keyId)||g.uri.replace(/-/g,"").indexOf(l)!==-1){if(f=u[y],!f)continue;if(g.pssh)break;delete u[y],g.pssh=new Uint8Array(n),g.keyId=c,f=u[l]=f.then(()=>this.generateRequestWithPreferredKeySession(p,i,n,"encrypted-event-key-match")),f.catch(v=>this.handleError(v));break}}f||this.handleError(new Error(`Key ID ${l} not encountered in playlist. Key-system sessions ${h.length}.`))}).catch(o=>this.handleError(o))}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(S.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(S.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(S.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(S.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(S.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(S.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(S.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(S.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t?.[e];if(n)return n.licenseUrl;if(e===ze.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t?.[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,c)=>!!o&&c.indexOf(o)===a,n=t.map(o=>o.audioCodec).filter(i),r=t.map(o=>o.videoCodec).filter(i);return n.length+r.length===0&&r.push("avc1.42e01e"),new Promise((o,a)=>{const c=l=>{const u=l.shift();this.getMediaKeysPromise(u,n,r).then(h=>o({keySystem:u,mediaKeys:h})).catch(h=>{l.length?c(l):h instanceof Rt?a(h):a(new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};c(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let n=`Configured requestMediaKeySystemAccess is not a function ${i}`;return Hl===null&&self.location.protocol==="http:"&&(n=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(n))}return i(e,t)}getMediaKeysPromise(e,t,i){var n;const r=Zy(e,t,i,this.config.drmSystemOptions||{});let o=this.keySystemAccessPromises[e],a=(n=o)==null?void 0:n.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${ke(r)}`),a=this.requestMediaKeySystemAccess(e,r);const c=o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const u=this.fetchServerCertificate(e);this.log(`Create media-keys for "${e}"`);const h=c.mediaKeys=l.createMediaKeys().then(f=>(this.log(`Media-keys created for "${e}"`),c.hasMediaKeys=!0,u.then(m=>m?this.setMediaKeysServerCertificate(f,e,m):f)));return h.catch(f=>{this.error(`Failed to create media-keys for "${e}"}: ${f}`)}),h})}return a.then(()=>o.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${at(e.keyId||[])} keyUri: ${e.uri}`);const n=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=Hs(t),r="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,r,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}updateKeySession(e,t){const i=e.mediaKeysSession;return this.log(`Updating key-session "${i.sessionId}" for keyId ${at(e.decryptdata.keyId||[])}
      } (data length: ${t.byteLength})`),i.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>Oo(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:i})=>this.attemptSetMediaKeys(t,i))}selectKeySystem(e){return new Promise((t,i)=>{this.getKeySystemSelectionPromise(e).then(({keySystem:n})=>{const r=Oo(n);r?t(r):i(new Error(`Unable to find format for key-system "${n}"`))}).catch(i)})}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=is(this.config),i=e.map(Cr).filter(n=>!!n&&t.indexOf(n)!==-1);return this.selectKeySystem(i)}getKeyStatus(e){const{mediaKeySessions:t}=this;for(let i=0;i<t.length;i++){const n=px(e,t[i]);if(n)return n}}loadKey(e){const t=e.keyInfo.decryptdata,i=Hs(t),n=this.bannedKeyIds[i];if(n||this.getKeyStatus(t)==="internal-error"){const a=Du(n||"internal-error",t);return this.handleError(a,e.frag),Promise.reject(a)}const r=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);const o=this.keyIdToKeySessionPromise[i];if(!o){const a=this.getKeySystemForKeyPromise(t).then(({keySystem:c,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(c,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:c,mediaKeys:l,decryptdata:t}))))).then(c=>{const l="cenc",u=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(c,l,u,"playlist-key")});return a.catch(c=>this.handleError(c,e.frag)),this.keyIdToKeySessionPromise[i]=a,a}return o.catch(a=>{if(a instanceof Rt){const c=Le({},a.data);this.getKeyStatus(t)==="internal-error"&&(c.decryptdata=t);const l=new Rt(c,a.message);this.handleError(l,e.frag)}}),o}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e,t){if(this.hls)if(e instanceof Rt){t&&(e.data.frag=t);const i=e.data.decryptdata;this.error(`${e.message}${i?` (${at(i.keyId||[])})`:""}`),this.hls.trigger(S.ERROR,e.data)}else this.error(e.message),this.hls.trigger(S.ERROR,{type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0})}getKeySystemForKeyPromise(e){const t=Hs(e),i=this.keyIdToKeySessionPromise[t];if(!i){const n=Cr(e.keyFormat),r=n?[n]:is(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=is(this.config)),e.length===0)throw new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${ke({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaResolved=void 0,this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then(()=>this.media?this.media.setMediaKeys(t):new Promise((r,o)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return o(new Error("Attempted to set mediaKeys without media element attached"));this.mediaKeys=t,this.media.setMediaKeys(t).then(r).catch(o)}}));return this.mediaKeys=t,this.setMediaKeysQueue.push(n),n.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,n){var r;const o=(r=this.config.drmSystems)==null||(r=r[e.keySystem])==null?void 0:r.generateRequest;if(o)try{const p=o.call(this.hls,t,i,e);if(!p)throw new Error("Invalid response from configured generateRequest filter");t=p.initDataType,i=p.initData?p.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(p){if(this.warn(p.message),this.hls&&this.hls.config.debug)throw p}if(i===null)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const a=Hs(e.decryptdata),c=e.decryptdata.uri;this.log(`Generating key-session request for "${n}" keyId: ${a} URI: ${c} (init data type: ${t} length: ${i.byteLength})`);const l=new Kl,u=e._onmessage=p=>{const g=e.mediaKeysSession;if(!g){l.emit("error",new Error("invalid state"));return}const{messageType:y,message:v}=p;this.log(`"${y}" message event for session "${g.sessionId}" message size: ${v.byteLength}`),y==="license-request"||y==="license-renewal"?this.renewLicense(e,v).catch(E=>{l.eventNames().length?l.emit("error",E):this.handleError(E)}):y==="license-release"?e.keySystem===ze.FAIRPLAY&&this.updateKeySession(e,Qa("acknowledged")).then(()=>this.removeSession(e)).catch(E=>this.handleError(E)):this.warn(`unhandled media key message type "${y}"`)},h=(p,g)=>{g.keyStatus=p;let y;p.startsWith("usable")?l.emit("resolved"):p==="internal-error"||p==="output-restricted"||p==="output-downscaled"?y=Du(p,g.decryptdata):p==="expired"?y=new Error(`key expired (keyId: ${a})`):p==="released"?y=new Error("key released"):p==="status-pending"||this.warn(`unhandled key status change "${p}" (keyId: ${a})`),y&&(l.eventNames().length?l.emit("error",y):this.handleError(y))},f=e._onkeystatuseschange=p=>{if(!e.mediaKeysSession){l.emit("error",new Error("invalid state"));return}const y=this.getKeyStatuses(e);if(!Object.keys(y).some(T=>y[T]!=="status-pending"))return;if(y[a]==="expired"){this.log(`Expired key ${ke(y)} in key-session "${e.mediaKeysSession.sessionId}"`),this.renewKeySession(e);return}let E=y[a];if(E)h(E,e);else{var x;e.keyStatusTimeouts||(e.keyStatusTimeouts={}),(x=e.keyStatusTimeouts)[a]||(x[a]=self.setTimeout(()=>{if(!e.mediaKeysSession||!this.mediaKeys)return;const A=this.getKeyStatus(e.decryptdata);if(A&&A!=="status-pending")return this.log(`No status for keyId ${a} in key-session "${e.mediaKeysSession.sessionId}". Using session key-status ${A} from other session.`),h(A,e);this.log(`key status for ${a} in key-session "${e.mediaKeysSession.sessionId}" timed out after 1000ms`),E="internal-error",h(E,e)},1e3)),this.log(`No status for keyId ${a} (${ke(y)}).`)}};mt(e.mediaKeysSession,"message",u),mt(e.mediaKeysSession,"keystatuseschange",f);const m=new Promise((p,g)=>{l.on("error",g),l.on("resolved",p)});return e.mediaKeysSession.generateRequest(t,i).then(()=>{this.log(`Request generated for key-session "${e.mediaKeysSession.sessionId}" keyId: ${a} URI: ${c}`)}).catch(p=>{throw new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_NO_SESSION,error:p,decryptdata:e.decryptdata,fatal:!1},`Error generating key-session request: ${p}`)}).then(()=>m).catch(p=>(l.removeAllListeners(),this.removeSession(e).then(()=>{throw p}))).then(()=>(l.removeAllListeners(),e))}getKeyStatuses(e){const t={};return e.mediaKeysSession.keyStatuses.forEach((i,n)=>{if(typeof n=="string"&&typeof i=="object"){const a=n;n=i,i=a}const r="buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n);if(e.keySystem===ze.PLAYREADY&&r.length===16){const a=at(r);t[a]=i,qf(r)}const o=at(r);i==="internal-error"&&(this.bannedKeyIds[o]=i),this.log(`key status change "${i}" for keyStatuses keyId: ${o} key-session "${e.mediaKeysSession.sessionId}"`),t[o]=i}),t}fetchServerCertificate(e){const t=this.config,i=t.loader,n=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const c={responseType:"arraybuffer",url:r},l=t.certLoadPolicy.default,u={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,m,p,g)=>{o(f.data)},onError:(f,m,p,g)=>{a(new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:p,response:Le({url:c.url,data:void 0},f)},`"${e}" certificate request failed (${r}). Status: ${f.code} (${f.text})`))},onTimeout:(f,m,p)=>{a(new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:p,response:{url:c.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(f,m,p)=>{a(new Error("aborted"))}};n.load(c,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((n,r)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i.byteLength}) on "${t}"`),n(e)}).catch(o=>{r(new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(n=>{throw new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:e.decryptdata,error:n,fatal:!1},n.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=new DOMParser().parseFromString(i,"application/xml"),r=n.querySelectorAll("HttpHeader");if(r.length>0){let u;for(let h=0,f=r.length;h<f;h++){var o,a;u=r[h];const m=(o=u.querySelector("name"))==null?void 0:o.textContent,p=(a=u.querySelector("value"))==null?void 0:a.textContent;m&&p&&e.setRequestHeader(m,p)}}const c=n.querySelector("Challenge"),l=c?.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return Qa(atob(l))}setupLicenseXHR(e,t,i,n){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,n)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),r.call(this.hls,e,t,i,n)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||n})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((n,r)=>{const o=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let c=a.response;this.log(`License received ${c instanceof ArrayBuffer?c.byteLength:c}`);const l=this.config.licenseResponseCallback;if(l)try{c=l.call(this.hls,a,o,e)}catch(u){this.error(u)}n(c)}else{const c=i.errorRetry,l=c?c.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)r(new Rt({type:ae.KEY_SYSTEM_ERROR,details:V.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:e.decryptdata,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const u=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(n,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:c,licenseChallenge:l})=>{e.keySystem==ze.PLAYREADY&&(l=this.unpackPlayReadyKeyMessage(c,l)),c.send(l)}).catch(r)})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,mt(i,"encrypted",this.onMediaEncrypted),mt(i,"waitingforkey",this.onWaitingForKey);const n=this.mediaResolved;n?n():this.mediaKeys=i.mediaKeys}onMediaDetached(){const e=this.media;e&&(Et(e,"encrypted",this.onMediaEncrypted),Et(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};const t=this.mediaResolved;if(t&&t(),!this.mediaKeys&&!this.mediaKeySessions.length)return;const i=this.media,n=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,di.clearKeyUriToKeyIdMap();const r=n.length;Xi.CDMCleanupPromise=Promise.all(n.map(o=>this.removeSession(o)).concat((i==null||(e=i.setMediaKeys(null))==null?void 0:e.catch(o=>{this.log(`Could not clear media keys: ${o}`),this.hls&&this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${o}`)})}))||Promise.resolve())).catch(o=>{this.log(`Could not close sessions and clear media keys: ${o}`),this.hls&&this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${o}`)})}).then(()=>{r&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this._clear()}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((n,r)=>(n.indexOf(r.keyFormat)===-1&&n.push(r.keyFormat),n),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i,decryptdata:n}=e;if(t){this.log(`Remove licenses and keys and close session "${t.sessionId}" keyId: ${at(n?.keyId||[])}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);r>-1&&this.mediaKeySessions.splice(r,1);const{keyStatusTimeouts:o}=e;o&&Object.keys(o).forEach(l=>self.clearTimeout(o[l]));const{drmSystemOptions:a}=this.config;return(t3(a)?new Promise((l,u)=>{self.setTimeout(()=>u(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(l).catch(u)}):Promise.resolve()).catch(l=>{this.log(`Could not remove session: ${l}`),this.hls&&this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${l}`)})}).then(()=>t.close()).catch(l=>{this.log(`Could not close session: ${l}`),this.hls&&this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${l}`)})})}return Promise.resolve()}}Xi.CDMCleanupPromise=void 0;function Hs(s){if(!s)throw new Error("Could not read keyId of undefined decryptdata");if(s.keyId===null)throw new Error("keyId is null");return at(s.keyId)}function px(s,e){if(s.keyId&&e.mediaKeysSession.keyStatuses.has(s.keyId))return e.mediaKeysSession.keyStatuses.get(s.keyId);if(s.matches(e.decryptdata))return e.keyStatus}class Rt extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}function Du(s,e){const t=s==="output-restricted",i=t?V.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:V.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new Rt({type:ae.KEY_SYSTEM_ERROR,details:i,fatal:!1,decryptdata:e},t?"HDCP level output restricted":`key status changed to "${s}"`)}class X0{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(S.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(S.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(S.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(S.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&typeof n.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const r=n-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,c=1e3*o/r,l=this.hls;if(l.trigger(S.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),c>0&&o>l.config.fpsDroppedMonitoringThreshold*a){let u=l.currentLevel;l.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(l.autoLevelCapping===-1||l.autoLevelCapping>=u)&&(u=u-1,l.trigger(S.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:l.currentLevel}),l.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function Y0(s,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=s,e.dispatchEvent(t)}function Q0(s,e){const t=s.mode;if(t==="disabled"&&(s.mode="hidden"),s.cues&&!s.cues.getCueById(e.id))try{if(s.addCue(e),!s.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){Pe.debug(`[texttrack-utils]: ${i}`);try{const n=new self.TextTrackCue(e.startTime,e.endTime,e.text);n.id=e.id,s.addCue(n)}catch(n){Pe.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${n}`)}}t==="disabled"&&(s.mode=t)}function bn(s,e){const t=s.mode;if(t==="disabled"&&(s.mode="hidden"),s.cues)for(let i=s.cues.length;i--;)e&&s.cues[i].removeEventListener("enter",e),s.removeCue(s.cues[i]);t==="disabled"&&(s.mode=t)}function rl(s,e,t,i){const n=s.mode;if(n==="disabled"&&(s.mode="hidden"),s.cues&&s.cues.length>0){const r=yx(s.cues,e,t);for(let o=0;o<r.length;o++)(!i||i(r[o]))&&s.removeCue(r[o])}n==="disabled"&&(s.mode=n)}function gx(s,e){if(e<=s[0].startTime)return 0;const t=s.length-1;if(e>s[t].endTime)return-1;let i=0,n=t,r;for(;i<=n;)if(r=Math.floor((n+i)/2),e<s[r].startTime)n=r-1;else if(e>s[r].startTime&&i<t)i=r+1;else return r;return s[i].startTime-e<e-s[n].startTime?i:n}function yx(s,e,t){const i=[],n=gx(s,e);if(n>-1)for(let r=n,o=s.length;r<o;r++){const a=s[r];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function _r(s){const e=[];for(let t=0;t<s.length;t++){const i=s[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(s[t])}return e}class J0 extends io{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=_r(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const n=this.findTrackForTextTrack(t);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_PARSED,this.onManifestParsed,this),e.on(S.LEVEL_LOADING,this.onLevelLoading,this),e.on(S.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(S.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(S.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_PARSED,this.onManifestParsed,this),e.off(S.LEVEL_LOADING,this.onLevelLoading,this),e.off(S.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(S.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(S.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const n=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,n)return;_r(i.textTracks).forEach(o=>{bn(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${o?.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let r=this.currentTrack;if(!i||n?.length!==i?.length||i!=null&&i.some(o=>n?.indexOf(o)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(u=>u.default)&&(this.selectDefaultTrack=!1),o.forEach((u,h)=>{u.id=h});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!r&&a){this.selectDefaultTrack=!1;const u=qt(a,o);if(u>-1)r=o[u];else{const h=qt(a,this.tracks);r=this.tracks[h]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));const l={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i?.join(",")}" group-id`),this.hls.trigger(S.SUBTITLE_TRACKS_UPDATED,l),c!==-1&&this.trackId===-1&&this.setSubtitleTrack(c)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const r=t[n];if(!(i&&!r.default||!i&&!e)&&(!e||Wi(r,e)))return n}if(e){for(let n=0;n<t.length;n++){const r=t[n];if(gs(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const r=t[n];if(gs(e.attrs,r.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(tl(n,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Se.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&Wi(e,i))return i;const n=qt(e,this.tracksInGroup);if(n>-1){const r=this.tracksInGroup[n];return this.setSubtitleTrack(n),r}else{if(i)return null;{const r=qt(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(S.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:n,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=_r(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter(r=>tl(i,r))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==n&&(r.mode="disabled")}),n){const r=this.subtitleDisplay?"showing":"hidden";n.mode!==r&&(n.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!ie(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n){this.hls.trigger(S.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:o,groupId:a="",name:c,type:l,url:u}=n;this.hls.trigger(S.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:c,type:l,url:u});const h=this.switchParams(n.url,i?.details,n.details);this.loadPlaylist(h)}}function vx(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(n=="x"?r:r&3|8).toString(16)})}}}function ls(s){let e=5381,t=s.length;for(;t;)e=e*33^s.charCodeAt(--t);return(e>>>0).toString()}const wn=.025;let Hr=(function(s){return s[s.Point=0]="Point",s[s.Range=1]="Range",s})({});function xx(s,e,t){return`${s.identifier}-${t+1}-${ls(e)}`}class Ex{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return jo(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=jo(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=ie(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return jo(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<wn))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Hr.Range:Hr.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return Ax(this)}}function jo(s,e){return s-e.start<e.duration/2&&!(Math.abs(s-(e.start+e.duration))<wn)?e.start:e.start+e.duration}function q0(s,e,t){const i=new self.URL(s,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function Wo(s,e){for(;(t=s.assetList[++e])!=null&&t.error;)var t;return e}function Ax(s){return`["${s.identifier}" ${s.cue.pre?"<pre>":s.cue.post?"<post>":""}${s.timelineStart.toFixed(2)}-${s.resumeTime.toFixed(2)}]`}function An(s){const e=s.timelineStart,t=s.duration||0;return`["${s.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class Sx{constructor(e,t,i,n){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(S.PLAYOUT_LIMIT_REACHED,{})};const r=this.hls=new e(t);this.interstitial=i,this.assetItem=n;const o=()=>{this.hasDetails=!0};r.once(S.LEVEL_LOADED,o),r.once(S.AUDIO_TRACK_LOADED,o),r.once(S.SUBTITLE_TRACK_LOADED,o),r.on(S.MEDIA_ATTACHING,(a,{media:c})=>{this.removeMediaListeners(),this.mediaAttached=c,this.interstitial.playoutLimit&&(c.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&r.on(S.BUFFER_APPENDED,()=>{const u=this.bufferedEnd;this.reachedPlayout(u)&&(this._bufferedEosTime=u,r.trigger(S.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,!0);else{let t=this.assetItem.uri;try{t=q0(t,e.config.primarySessionId||"").href}catch{}e.loadSource(t)}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e)return!1;const i=Math.min(this._bufferedEosTime||1/0,this.duration),n=this.timelineOffset,r=pe.bufferInfo(e,n,0);return this.getAssetTime(r.end)>=i-.02}reachedPlayout(e){const i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=pe.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;if(!e)return 0;const t=this.interstitial.playoutLimit;if(t){const i=t-this.startOffset;if(i>0&&i<e)return i}return e}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e)}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia()}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering()}transferMedia(){var e;return this.bufferSnapShot(),((e=this.hls)==null?void 0:e.transferMedia())||null}resetDetails(){const e=this.hls;if(e&&this.hasDetails){e.stopLoad();const t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){var n;(n=this.hls)==null||n.on(e,t)}once(e,t,i){var n;(n=this.hls)==null||n.once(e,t)}off(e,t,i){var n;(n=this.hls)==null||n.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${An(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const Bu=.033;class Tx extends Bt{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,n)=>e<=n.startOffset&&t>n.startOffset?(delete n.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const n=this.items;if(n)for(n[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(r=n[i])!=null&&r.event;){var r;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let n=0;n<i.length;n++){let r=i[n];if(t&&t!=="primary"&&(r=r[t]),e===r.start||e>r.start&&e<r.end)return n}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let n=e;n<=t&&i[n];n++){const r=i[n].event;if(r!=null&&r.restrictions.jump&&!r.appendInPlace)return n}return-1}findEventIndex(e){const t=this.items;if(t)for(let n=t.length;n--;){var i;if(((i=t[n].event)==null?void 0:i.identifier)===e)return n}return-1}findAssetIndex(e,t){const i=e.assetList,n=i.length;if(n>1)for(let r=0;r<n;r++){const o=i[r];if(!o.error){const a=o.timelineStart;if(t===a||t>a&&(t<a+(o.duration||0)||r===n-1))return r}}return 0}get assetIdAtEnd(){var e;const t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){const i=t.assetList,n=i[i.length-1];if(n)return n.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:n}=i,r=this.events,o=this.parseDateRanges(n,{url:i.url},t),a=Object.keys(n),c=r?r.filter(l=>!a.includes(l.identifier)):[];o.length&&o.sort((l,u)=>{const h=l.cue.pre,f=l.cue.post,m=u.cue.pre,p=u.cue.post;if(h&&!m)return-1;if(m&&!h||f&&!p)return 1;if(p&&!f)return-1;if(!h&&!m&&!f&&!p){const g=l.startTime,y=u.startTime;if(g!==y)return g-y}return l.dateRange.tagOrder-u.dateRange.tagOrder}),this.events=o,c.forEach(l=>{this.removeEvent(l)}),this.updateSchedule(e,c)}updateSchedule(e,t=[],i=!1){const n=this.events||[];if(n.length||t.length||this.length<2){const r=this.items,o=this.parseSchedule(n,e);(i||t.length||r?.length!==o.length||o.some((c,l)=>Math.abs(c.playout.start-r[l].playout.start)>.005||Math.abs(c.playout.end-r[l].playout.end)>.005))&&(this.items=o,this.onScheduleUpdate(t,r))}}parseDateRanges(e,t,i){const n=[],r=Object.keys(e);for(let o=0;o<r.length;o++){const a=r[o],c=e[a];if(c.isInterstitial){let l=this.eventMap[a];l?l.setDateRange(c):(l=new Ex(c,t),this.eventMap[a]=l,i===!1&&(l.appendInPlace=i)),n.push(l)}}return n}parseSchedule(e,t){const i=[],n=t.main.details,r=n.live?1/0:n.edge;let o=0;if(e=e.filter(c=>!c.error&&!(c.cue.once&&c.hasPlayed)),e.length){this.resolveOffsets(e,t);let c=0,l=0;if(e.forEach((u,h)=>{const f=u.cue.pre,m=u.cue.post,p=e[h-1]||null,g=u.appendInPlace,y=m?r:u.startOffset,v=u.duration,E=u.timelineOccupancy===Hr.Range?v:0,x=u.resumptionOffset,T=p?.startTime===y,A=y+u.cumulativeDuration;let C=g?A+v:y+x;if(f||!m&&y<=0){const R=l;l+=E,u.timelineStart=A;const I=o;o+=v,i.push({event:u,start:A,end:C,playout:{start:I,end:o},integrated:{start:R,end:l}})}else if(y<=r){if(!T){const w=y-c;if(w>Bu){const M=c,P=l;l+=w;const O=o;o+=w;const z={previousEvent:e[h-1]||null,nextEvent:u,start:M,end:M+w,playout:{start:O,end:o},integrated:{start:P,end:l}};i.push(z)}else w>0&&p&&(p.cumulativeDuration+=w,i[i.length-1].end=y)}m&&(C=A),u.timelineStart=A;const R=l;l+=E;const I=o;o+=v,i.push({event:u,start:A,end:C,playout:{start:I,end:o},integrated:{start:R,end:l}})}else return;const b=u.resumeTime;m||b>r?c=r:c=b}),c<r){var a;const u=c,h=l,f=r-c;l+=f;const m=o;o+=f,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:c,end:u+f,playout:{start:m,end:o},integrated:{start:h,end:l}})}this.setDurations(r,o,l)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,n=i.live?1/0:i.edge;let r=0,o=-1;e.forEach((a,c)=>{const l=a.cue.pre,u=a.cue.post,h=l?0:u?n:a.startTime;this.updateAssetDurations(a),o===h?a.cumulativeDuration=r:(r=0,o=h),!u&&a.snapOptions.in&&(a.resumeAnchor=Zi(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&c+1<e.length&&e[c+1].startTime-e[c].resumeTime<Bu&&(e[c+1].appendInPlace=!1,e[c+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const m=ie(a.resumeOffset)?a.resumeOffset:a.duration;r+=m})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,n=e.startTime+e.resumptionOffset;return Math.abs(i-n)>wn?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${n}`),!1):!Object.keys(t).some(o=>{const a=t[o].details,c=a.edge;if(i>=c)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${c}`),!1;const l=Zi(null,a.fragments,i);if(!l)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const u=o==="audio"?.175:0;return Math.abs(l.start-i)<wn+u||Math.abs(l.end-i)<wn+u?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${l.start}-${l.end} sn: ${l.sn} cc: ${l.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,n=!1,r=!1;for(let o=0;o<e.assetList.length;o++){const a=e.assetList[o],c=t+i;a.startOffset=i,a.timelineStart=c,n||(n=a.duration===null),r||(r=!!a.error);const l=a.error?0:a.duration||0;i+=l}n&&!r?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Ot(s){return`[${s.event?'"'+s.event.identifier+'"':"primary"}: ${s.start.toFixed(2)}-${s.end.toFixed(2)}]`}class bx{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let n;try{n=q0(i,this.hls.sessionId,e.baseUrl)}catch(f){const m=this.assignAssetListError(e,V.ASSET_LIST_LOAD_ERROR,f,i);this.hls.trigger(S.ERROR,m);return}t&&n.protocol!=="data:"&&n.searchParams.set("_HLS_start_offset",""+t);const r=this.hls.config,o=r.loader,a=new o(r),c={responseType:"json",url:n.href},l=r.interstitialAssetListLoadPolicy.default,u={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,m,p,g)=>{const y=f.data,v=y?.ASSETS;if(!Array.isArray(v)){const E=this.assignAssetListError(e,V.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),p.url,m,g);this.hls.trigger(S.ERROR,E);return}e.assetListResponse=y,this.hls.trigger(S.ASSET_LIST_LOADED,{event:e,assetListResponse:y,networkDetails:g})},onError:(f,m,p,g)=>{const y=this.assignAssetListError(e,V.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${f.code} ${f.text} (${m.url})`),m.url,g,p);this.hls.trigger(S.ERROR,y)},onTimeout:(f,m,p)=>{const g=this.assignAssetListError(e,V.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${m.url})`),m.url,f,p);this.hls.trigger(S.ERROR,g)}};return a.load(c,u,h),this.hls.trigger(S.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,n,r,o){return e.error=i,{type:ae.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:n,error:i,networkDetails:o,stats:r}}}function Fu(s){var e;s==null||(e=s.play())==null||e.catch(()=>{})}function Ks(s,e){return`[${s}] Advancing timeline position to ${e}`}class Cx extends Bt{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled||!this.schedule)return;const n=i-this.timelinePos;if(Math.abs(n)<1/7056e5)return;const o=n<=-.01;this.timelinePos=i,this.bufferedPos=i;const a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-n)&&this.updateSchedule(!0),this.checkBuffer(),o&&i<a.start||i>=a.end){var c;const m=this.findItemIndex(a);let p=this.schedule.findItemIndexAtTime(i);if(p===-1&&(p=m+(o?-1:1),this.log(`seeked ${o?"back ":""}to position not covered by schedule ${i} (resolving from ${m} to ${p})`)),!this.isInterstitial(a)&&(c=this.media)!=null&&c.paused&&(this.shouldPlay=!1),!o&&p>m){const g=this.schedule.findJumpRestrictedIndex(m+1,p);if(g>m){this.setSchedulePosition(g);return}}this.setSchedulePosition(p);return}const l=this.playingAsset;if(!l){if(this.playingLastItem&&this.isInterstitial(a)){const m=a.event.assetList[0];m&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,m))}return}const u=l.timelineStart,h=l.duration||0;if(o&&i<u||i>=u+h){var f;(f=a.event)!=null&&f.appendInPlace&&(this.clearAssetPlayers(a.event,a),this.flushFrontBuffer(i)),this.setScheduleToAssetAtTime(i,l)}},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const n=this.playingItem;if(!n||this.playingLastItem)return;if(i>=n.end){this.timelinePos=n.end;const a=this.findItemIndex(n);this.setSchedulePosition(a+1)}const r=this.playingAsset;if(!r)return;const o=r.timelineStart+(r.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,r)},this.onScheduleUpdate=(i,n)=>{const r=this.schedule;if(!r)return;const o=this.playingItem,a=r.events||[],c=r.items||[],l=r.durations,u=i.map(g=>g.identifier),h=!!(a.length||u.length);(h||n)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${c.map(g=>Ot(g))} pos: ${this.timelinePos}`),u.length&&this.log(`Removed events ${u}`);let f=null,m=null;o&&(f=this.updateItem(o,this.timelinePos),this.itemsMatch(o,f)?this.playingItem=f:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const p=this.bufferingItem;if(p&&(m=this.updateItem(p,this.bufferedPos),this.itemsMatch(p,m)?this.bufferingItem=m:p.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(p.event,null))),i.forEach(g=>{g.assetList.forEach(y=>{this.clearAssetPlayer(y.identifier,null)})}),this.playerQueue.forEach(g=>{if(g.interstitial.appendInPlace){const y=g.assetItem.timelineStart,v=g.timelineOffset-y;if(v)try{g.timelineOffset=y}catch(E){Math.abs(v)>wn&&this.warn(`${E} ("${g.assetId}" ${g.timelineOffset}->${y})`)}}}),h||n){if(this.hls.trigger(S.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:c.slice(0),durations:l,removedIds:u}),this.isInterstitial(o)&&u.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}o&&this.trimInPlace(f,o),p&&m!==f&&this.trimInPlace(m,p),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new bx(e),this.schedule=new Tx(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e&&(e.on(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(S.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(S.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(S.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(S.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(S.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(S.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(S.BUFFER_APPENDED,this.onBufferAppended,this),e.on(S.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(S.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(S.MEDIA_ENDED,this.onMediaEnded,this),e.on(S.ERROR,this.onError,this),e.on(S.DESTROYING,this.onDestroying,this))}unregisterListeners(){const e=this.hls;e&&(e.off(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(S.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(S.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(S.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(S.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(S.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(S.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(S.BUFFER_CODECS,this.onBufferCodecs,this),e.off(S.BUFFER_APPENDED,this.onBufferAppended,this),e.off(S.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(S.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(S.MEDIA_ENDED,this.onMediaEnded,this),e.off(S.ERROR,this.onError,this),e.off(S.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){Et(e,"play",this.onPlay),Et(e,"pause",this.onPause),Et(e,"seeking",this.onSeeking),Et(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;mt(i,"seeking",this.onSeeking),mt(i,"timeupdate",this.onTimeupdate),mt(i,"play",this.onPlay),mt(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,n=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!n){this.clearScheduleState();const r=this.findItemIndex(i);this.setSchedulePosition(r)}}clearScheduleState(){this.log("clear schedule state"),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(this.media=null,!i&&(n&&this.removeMediaListeners(n),this.detachedData)){const r=this.getBufferingPlayer();r&&(this.log(`Removing schedule state for detachedData and ${r}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,r.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=h=>h&&e.getAssetPlayer(h.identifier),n=(h,f,m,p,g)=>{if(h){let y=h[f].start;const v=h.event;if(v){if(f==="playout"||v.timelineOccupancy!==Hr.Point){const E=i(m);E?.interstitial===v&&(y+=E.assetItem.startOffset+E[g])}}else{const E=p==="bufferedPos"?o():e[p];y+=E-h.start}return y}return 0},r=(h,f)=>{var m;if(h!==0&&f!=="primary"&&(m=e.schedule)!=null&&m.length){var p;const g=e.schedule.findItemIndexAtTime(h),y=(p=e.schedule.items)==null?void 0:p[g];if(y){const v=y[f].start-y.start;return h+v}}return h},o=()=>{const h=e.bufferedPos;return h===Number.MAX_VALUE?a("primary"):Math.max(h,0)},a=h=>{var f,m;return(f=e.primaryDetails)!=null&&f.live?e.primaryDetails.edge:((m=e.schedule)==null?void 0:m.durations[h])||0},c=(h,f)=>{var m,p;const g=e.effectivePlayingItem;if(g!=null&&(m=g.event)!=null&&m.restrictions.skip||!e.schedule)return;e.log(`seek to ${h} "${f}"`);const y=e.effectivePlayingItem,v=e.schedule.findItemIndexAtTime(h,f),E=(p=e.schedule.items)==null?void 0:p[v],x=e.getBufferingPlayer(),T=x?.interstitial,A=T?.appendInPlace,C=y&&e.itemsMatch(y,E);if(y&&(A||C)){const b=i(e.playingAsset),R=b?.media||e.primaryMedia;if(R){const I=f==="primary"?R.currentTime:n(y,f,e.playingAsset,"timelinePos","currentTime"),w=h-I,M=(A?I:R.currentTime)+w;if(M>=0&&(!b||A||M<=b.duration)){R.currentTime=M;return}}}if(E){let b=h;if(f!=="primary"){const I=E[f].start,w=h-I;b=E.start+w}const R=!e.isInterstitial(E);if((!e.isInterstitial(y)||y.event.appendInPlace)&&(R||E.event.appendInPlace)){const I=e.media||(A?x?.media:null);I&&(I.currentTime=b)}else if(y){const I=e.findItemIndex(y);if(v>I){const M=e.schedule.findJumpRestrictedIndex(I+1,v);if(M>I){e.setSchedulePosition(M);return}}let w=0;if(R)e.timelinePos=b,e.checkBuffer();else{const M=E.event.assetList,P=h-(E[f]||E).start;for(let O=M.length;O--;){const z=M[O];if(z.duration&&P>=z.startOffset&&P<z.startOffset+z.duration){w=O;break}}}e.setSchedulePosition(v,w)}}},l=()=>{const h=e.effectivePlayingItem;if(e.isInterstitial(h))return h;const f=t();return e.isInterstitial(f)?f:null},u={get bufferedEnd(){const h=t(),f=e.bufferingItem;if(f&&f===h){var m;return n(f,"playout",e.bufferingAsset,"bufferedPos","bufferedEnd")-f.playout.start||((m=e.bufferingAsset)==null?void 0:m.startOffset)||0}return 0},get currentTime(){const h=l(),f=e.effectivePlayingItem;return f&&f===h?n(f,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-f.playout.start:0},set currentTime(h){const f=l(),m=e.effectivePlayingItem;m&&m===f&&c(h+m.playout.start,"playout")},get duration(){const h=l();return h?h.playout.end-h.playout.start:0},get assetPlayers(){var h;const f=(h=l())==null?void 0:h.event.assetList;return f?f.map(m=>e.getAssetPlayer(m.identifier)):[]},get playingIndex(){var h;const f=(h=l())==null?void 0:h.event;return f&&e.effectivePlayingAsset?f.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};return this.manager={get events(){var h;return((h=e.schedule)==null||(h=h.events)==null?void 0:h.slice(0))||[]},get schedule(){var h;return((h=e.schedule)==null||(h=h.items)==null?void 0:h.slice(0))||[]},get interstitialPlayer(){return l()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const h=t();return e.findItemIndex(h)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const h=e.effectivePlayingItem;return e.findItemIndex(h)},primary:{get bufferedEnd(){return o()},get currentTime(){const h=e.timelinePos;return h>0?h:0},set currentTime(h){c(h,"primary")},get duration(){return a("primary")},get seekableStart(){var h;return((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0}},integrated:{get bufferedEnd(){return n(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return n(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(h){c(h,"integrated")},get duration(){return a("integrated")},get seekableStart(){var h;return r(((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0,"integrated")}},skip:()=>{const h=e.effectivePlayingItem,f=h?.event;if(f&&!f.restrictions.skip){const m=e.findItemIndex(h);if(f.appendInPlace){const p=h.playout.start+h.event.duration;c(p+.001,"playout")}else e.advanceAfterAssetEnded(f,m,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t;if(this.mediaSelection===null)return;const i=this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&!i.event.appendInPlace)return;let n=this.media;!n&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(n=this.primaryMedia);const r=(t=n)==null?void 0:t.currentTime;if(!(r===void 0||!ie(r)))return r}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,n=e.media;if(i&&n===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&n){this.detachedData={media:n};return}const r=e.transferMedia();this.log(`transfer MediaSource from ${e} ${ke(r)}`),this.detachedData=r}else t&&n&&(this.shouldPlay||(this.shouldPlay=!n.paused))}transferMediaTo(e,t){var i,n;if(e.media===t)return;let r=null;const o=this.hls,a=e!==o,c=a&&e.interstitial.appendInPlace,l=(i=this.detachedData)==null?void 0:i.mediaSource;let u;if(o.media)c&&(r=o.transferMedia(),this.detachedData=r),u="Primary";else if(l){const p=this.getBufferingPlayer();p?(r=p.transferMedia(),u=`${p}`):u="detached MediaSource"}else u="detached media";if(!r){if(l)r=this.detachedData,this.log(`using detachedData: MediaSource ${ke(r)}`);else if(!this.detachedData||o.media===t){const p=this.playerQueue;p.length>1&&p.forEach(g=>{if(a&&g.interstitial.appendInPlace!==c){const y=g.interstitial;this.clearInterstitial(g.interstitial,null),y.appendInPlace=!1,y.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${y}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const h=r&&"mediaSource"in r&&((n=r.mediaSource)==null?void 0:n.readyState)!=="closed",f=h&&r?r:t;this.log(`${h?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${u} (media.currentTime: ${t.currentTime})`);const m=this.schedule;if(f===r&&m){const p=a&&e.assetId===m.assetIdAtEnd;f.overrides={duration:m.duration,endOfStream:!a||p,cueRemoval:!a}}e.attachMedia(f)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e?.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,n=this.effectivePlayingItem;if(i===-1){const r=this.hls.startPosition;if(this.log(Ks("checkStart",r)),this.timelinePos=r,t.length&&t[0].cue.pre){const o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(r>=0||!this.primaryLive){const o=this.timelinePos=r>0?r:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(n&&!this.playingItem){const r=e.findItemIndex(n);this.setSchedulePosition(r)}}advanceAssetBuffering(e,t){const i=e.event,n=i.findAssetIndex(t),r=Wo(i,n);if(!i.isAssetPastPlayoutLimit(r))this.bufferedToEvent(e,r);else if(this.schedule){var o;const a=(o=this.schedule.items)==null?void 0:o[this.findItemIndex(e)+1];a&&this.bufferedToItem(a)}}advanceAfterAssetEnded(e,t,i){const n=Wo(e,i);if(e.isAssetPastPlayoutLimit(n)){if(this.schedule){const r=this.schedule.items;if(r){const o=t+1,a=r.length;if(o>=a){this.setSchedulePosition(-1);return}const c=e.resumeTime;this.timelinePos<c&&(this.log(Ks("advanceAfterAssetEnded",c)),this.timelinePos=c,e.appendInPlace&&this.advanceInPlace(c),this.checkBuffer(this.bufferedPos<c)),this.setSchedulePosition(o)}}}else{if(e.appendInPlace){const r=e.assetList[n];r&&this.advanceInPlace(r.timelineStart)}this.setSchedulePosition(t,n)}}setScheduleToAssetAtTime(e,t){const i=this.schedule;if(!i)return;const n=t.parentIdentifier,r=i.getEvent(n);if(r){const o=i.findEventIndex(n),a=i.findAssetIndex(r,e);this.advanceAfterAssetEnded(r,o,a-1)}}setSchedulePosition(e,t){var i;const n=(i=this.schedule)==null?void 0:i.items;if(!n||this.playbackDisabled)return;const r=e>=0?n[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${r&&Ot(r)}) pos: ${this.timelinePos}`);const o=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(o)){const u=o.event,h=this.playingAsset,f=h?.identifier,m=f?this.getAssetPlayer(f):null;if(m&&f&&(!this.eventItemsMatch(o,r)||t!==void 0&&f!==u.assetList[t].identifier)){var c;const p=u.findAssetIndex(h);if(this.log(`INTERSTITIAL_ASSET_ENDED ${p+1}/${u.assetList.length} ${An(h)}`),this.endedAsset=h,this.playingAsset=null,this.hls.trigger(S.INTERSTITIAL_ASSET_ENDED,{asset:h,assetListIndex:p,event:u,schedule:n.slice(0),scheduleIndex:e,player:m}),o!==this.playingItem){this.itemsMatch(o,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(u,this.findItemIndex(this.playingItem),p);return}this.retreiveMediaSource(f,r),m.media&&!((c=this.detachedData)!=null&&c.mediaSource)&&m.detachMedia()}if(!this.eventItemsMatch(o,r)&&(this.endedItem=o,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${u} ${Ot(o)}`),u.hasPlayed=!0,this.hls.trigger(S.INTERSTITIAL_ENDED,{event:u,schedule:n.slice(0),scheduleIndex:e}),u.cue.once)){var l;this.updateSchedule();const p=(l=this.schedule)==null?void 0:l.items;if(r&&p){const g=this.findItemIndex(r);this.advanceSchedule(g,p,t,o,a)}return}}this.advanceSchedule(e,n,t,o,a)}advanceSchedule(e,t,i,n,r){const o=this.schedule;if(!o)return;const a=t[e]||null,c=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(u=>{const h=u.interstitial,f=o.findEventIndex(h.identifier);(f<e||f>e+1)&&this.clearInterstitial(h,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const u=a.event;if(i===void 0){i=o.findAssetIndex(u,this.timelinePos);const p=Wo(u,i-1);if(u.isAssetPastPlayoutLimit(p)||u.appendInPlace&&this.timelinePos===a.end){this.advanceAfterAssetEnded(u,e,i);return}i=p}const h=this.waitingItem;this.assetsBuffered(a,c)||this.setBufferingItem(a);let f=this.preloadAssets(u,i);if(this.eventItemsMatch(a,h||n)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${Ot(a)} ${u.appendInPlace?"append in place":""}`),this.hls.trigger(S.INTERSTITIAL_STARTED,{event:u,schedule:t.slice(0),scheduleIndex:e})),!u.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${u}`);return}if(u.assetListLoader&&(u.assetListLoader.destroy(),u.assetListLoader=void 0),!c){this.log(`Waiting for attachMedia to start Interstitial ${u}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const m=u.assetList[i];if(!m){this.advanceAfterAssetEnded(u,e,i||0);return}if(f||(f=this.getAssetPlayer(m.identifier)),f===null||f.destroyed){const p=u.assetList.length;this.warn(`asset ${i+1}/${p} player destroyed ${u}`),f=this.createAssetPlayer(u,m,i),f.loadSource()}if(!this.eventItemsMatch(a,this.bufferingItem)&&u.appendInPlace&&this.isAssetBuffered(m))return;this.startAssetPlayer(f,i,t,e,c),this.shouldPlay&&Fu(f.media)}else a?(this.resumePrimary(a,e,n),this.shouldPlay&&Fu(this.hls.media)):r&&this.isInterstitial(n)&&(this.endedItem=null,this.playingItem=n,n.event.appendInPlace||this.attachPrimary(o.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e;return(e=this.mediaSelection)==null?void 0:e.main.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var n,r;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Ot(e)}`),!((n=this.detachedData)!=null&&n.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.log(Ks("resumePrimary",a)),this.timelinePos=a),this.attachPrimary(a,e)}if(!i)return;const o=(r=this.schedule)==null?void 0:r.items;o&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Ot(e)}`),this.hls.trigger(S.INTERSTITIALS_PRIMARY_RESUMED,{schedule:o.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const n=this.primaryDetails;if(t===0)return this.hls.startPosition;if(n&&(i<n.fragmentStart||i>n.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:pe.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const n=this.primaryMedia;if(!n)return;const r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,n),i&&this.startLoadingPrimaryAt(e,i)),i||(this.log(Ks("attachPrimary",e)),this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const n=this.hls;!n.loadingEnabled||!n.media||Math.abs((((i=n.mainForwardBufferInfo)==null?void 0:i.start)||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(S.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(S.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;const i=this.hls.levels[t.level];if(!i.details)return;const n=Le(Le({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=n,this.schedule.parseInterstitialDateRanges(n,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=Le(Le({},this.altSelection),{},{audio:i});return}const r=Le(Le({},n),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=Le(Le({},this.altSelection),{},{subtitles:i});return}const r=Le(Le({},n),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(e,t){const i=Kc(t);this.playerQueue.forEach(({hls:n})=>n&&(n.setAudioOption(t)||n.setAudioOption(i)))}onSubtitleTrackSwitch(e,t){const i=Kc(t);this.playerQueue.forEach(({hls:n})=>n&&(n.setSubtitleOption(t)||t.id!==-1&&n.setSubtitleOption(i)))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const n=this.timelinePos;this.bufferedPos=n,this.checkBuffer()}}onBufferedToEnd(e){if(!this.schedule)return;const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let n=0;n<t.length;n++){const r=t[n];if(r.cue.post){var i;const o=this.schedule.findEventIndex(r.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){var i;const n=(i=this.schedule)==null?void 0:i.items;if(e&&n){const r=this.findItemIndex(e,t);return n[r]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((r,o)=>{e.event.isAssetPastPlayoutLimit(o)&&this.clearAssetPlayer(r.identifier,null)});const i=e.end+.25,n=pe.bufferInfo(this.primaryMedia,i,0);(n.end>i||(n.nextStart||0)>i)&&(this.log(`trim buffered interstitial ${Ot(e)} (was ${Ot(t)})`),this.attachPrimary(i,null,!0),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=!1){var t;const i=this.mediaSelection;i&&((t=this.schedule)==null||t.updateSchedule(i,[],e))}checkBuffer(e){var t;const i=(t=this.schedule)==null?void 0:t.items;if(!i)return;const n=pe.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=n.len<1),this.updateBufferedPos(n.end,i,e)}updateBufferedPos(e,t,i){const n=this.schedule,r=this.bufferingItem;if(this.bufferedPos>e||!n)return;if(t.length===1&&this.itemsMatch(t[0],r)){this.bufferedPos=e;return}const o=this.playingItem,a=this.findItemIndex(o);let c=n.findItemIndexAtTime(e);if(this.bufferedPos<e){var l;const u=this.findItemIndex(r),h=Math.min(u+1,t.length-1),f=t[h];if((c===-1&&r&&e>=r.end||(l=f.event)!=null&&l.appendInPlace&&e+.01>=f.start)&&(c=h),this.isInterstitial(r)){const m=r.event;if(h-a>1&&m.appendInPlace===!1||m.assetList.length===0&&m.assetListLoader)return}if(this.bufferedPos=e,c>u&&c>a)this.bufferedToItem(f);else{const m=this.primaryDetails;this.primaryLive&&m&&e>m.edge-m.targetduration&&f.start<m.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(f)&&this.preloadAssets(f.event,0)}}else i&&o&&!this.itemsMatch(o,r)&&(c===a?this.bufferedToItem(o):c===a+1&&this.bufferedToItem(t[c]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(n=>{const r=this.getAssetPlayer(n.identifier);return!(r!=null&&r.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(!this.itemsMatch(e,t)&&i){const{items:n,events:r}=i;if(!n||!r)return t;const o=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const c=a?a.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Ot(e)}`+(t?` (${c.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(o){const l=i.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((u,h)=>{const f=this.getAssetPlayer(u.identifier);f&&(h===l&&f.loadSource(),f.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(l=>l.pauseBuffering());this.hls.trigger(S.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:n.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const n=this.detachedData;n?n.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,n=i.assetList.length===0&&!i.assetListLoader,r=i.cue.once;if(n||!r){const o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){const a=this.primaryMedia;a&&this.bufferAssetPlayer(o,a)}}}preloadAssets(e,t){const i=e.assetUrl,n=e.assetList.length,r=n===0&&!e.assetListLoader,o=e.cue.once;if(r){const c=e.timelineStart;if(e.appendInPlace){var a;const f=this.playingItem;!this.isInterstitial(f)&&(f==null||(a=f.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(c+.25)}let l,u=0;if(!this.playingItem&&this.primaryLive&&(u=this.hls.startPosition,u===-1&&(u=this.hls.liveSyncPosition||0)),u&&!(e.cue.pre||e.cue.post)){const f=u-c;f>0&&(l=Math.round(f*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:n} ${e}${l?` live-start: ${u} start-offset: ${l}`:""}`),i)return this.createAsset(e,0,0,c,e.duration,i);const h=this.assetListLoader.loadAssetList(e,l);h&&(e.assetListLoader=h)}else if(!o&&n){for(let l=t;l<n;l++){const u=e.assetList[l],h=this.getAssetPlayerQueueIndex(u.identifier);(h===-1||this.playerQueue[h].destroyed)&&!u.error&&this.createAssetPlayer(e,u,l)}const c=e.assetList[t];if(c){const l=this.getAssetPlayer(c.identifier);return l&&l.loadSource(),l}}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(n=>{this.hls.trigger(S.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:n})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,n,r,o){const a={parentIdentifier:e.identifier,identifier:xx(e,o,t),duration:r,startOffset:i,timelineStart:n,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){const n=this.hls,r=n.userConfig;let o=r.videoPreference;const a=n.loadLevelObj||n.levels[n.currentLevel];(o||a)&&(o=De({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));const c=n.audioTracks[n.audioTrack],l=n.subtitleTracks[n.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const T=this.timelinePos-t.timelineStart;if(T>1){const A=t.duration;A&&T<A&&(u=T)}}const h=t.identifier,f=Le(Le({},r),{},{maxMaxBufferLength:Math.min(180,n.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:n.sessionId,assetPlayerId:h,abrEwmaDefaultEstimate:n.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:c||r.audioPreference,subtitlePreference:l||r.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(f.timelineOffset=t.timelineStart));const m=f.cmcd;m!=null&&m.sessionId&&m.contentId&&(f.cmcd=De({},m,{contentId:ls(t.uri)})),this.getAssetPlayer(h)&&this.warn(`Duplicate date range identifier ${e} and asset ${h}`);const p=new Sx(this.HlsPlayerClass,f,e,t);this.playerQueue.push(p),e.assetList[i]=t;let g=!0;const y=T=>{if(T.live){var A;const R=new Error(`Interstitials MUST be VOD assets ${e}`),I={fatal:!0,type:ae.OTHER_ERROR,details:V.INTERSTITIAL_ASSET_ITEM_ERROR,error:R},w=((A=this.schedule)==null?void 0:A.findEventIndex(e.identifier))||-1;this.handleAssetItemError(I,e,w,i,R.message);return}const C=T.edge-T.fragmentStart,b=t.duration;(g||b===null||C>b)&&(g=!1,this.log(`Interstitial asset "${h}" duration change ${b} > ${C}`),t.duration=C,this.updateSchedule())};p.on(S.LEVEL_UPDATED,(T,{details:A})=>y(A)),p.on(S.LEVEL_PTS_UPDATED,(T,{details:A})=>y(A)),p.on(S.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const v=(T,A)=>{const C=this.getAssetPlayer(h);if(C&&A.tracks){C.off(S.BUFFER_CODECS,v),C.tracks=A.tracks;const b=this.primaryMedia;this.bufferingAsset===C.assetItem&&b&&!C.media&&this.bufferAssetPlayer(C,b)}};p.on(S.BUFFER_CODECS,v);const E=()=>{var T;const A=this.getAssetPlayer(h);if(this.log(`buffered to end of asset ${A}`),!A||!this.schedule)return;const C=this.schedule.findEventIndex(e.identifier),b=(T=this.schedule.items)==null?void 0:T[C];this.isInterstitial(b)&&this.advanceAssetBuffering(b,t)};p.on(S.BUFFERED_TO_END,E);const x=T=>()=>{if(!this.getAssetPlayer(h)||!this.schedule)return;this.shouldPlay=!0;const C=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,C,T)};return p.once(S.MEDIA_ENDED,x(i)),p.once(S.PLAYOUT_LIMIT_REACHED,x(1/0)),p.on(S.ERROR,(T,A)=>{if(!this.schedule)return;const C=this.getAssetPlayer(h);if(A.details===V.BUFFER_STALLED_ERROR){if(C!=null&&C.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(A,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${A.error} ${e}`)}),p.on(S.DESTROYING,()=>{if(!this.getAssetPlayer(h)||!this.schedule)return;const A=new Error(`Asset player destroyed unexpectedly ${h}`),C={fatal:!0,type:ae.OTHER_ERROR,details:V.INTERSTITIAL_ASSET_ITEM_ERROR,error:A};this.handleAssetItemError(C,e,this.schedule.findEventIndex(e.identifier),i,A.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${An(t)}`),this.hls.trigger(S.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:p}),p}clearInterstitial(e,t){this.clearAssetPlayers(e,t),e.reset()}clearAssetPlayers(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)})}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){const n=this.playerQueue[i];this.log(`clear ${n} toSegment: ${t&&Ot(t)}`),this.transferMediaFromPlayer(n,t),this.playerQueue.splice(i,1),n.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,n,r){const{interstitial:o,assetItem:a,assetId:c}=e,l=o.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!u||u.identifier!==c)&&(u&&(this.clearAssetPlayer(u.identifier,i[n]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${l} ${An(a)}`),this.hls.trigger(S.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:n,player:e})),this.bufferAssetPlayer(e,r)}bufferAssetPlayer(e,t){var i,n;if(!this.schedule)return;const{interstitial:r,assetItem:o}=e,a=this.schedule.findEventIndex(r.identifier),c=(i=this.schedule.items)==null?void 0:i[a];if(!c)return;e.loadSource(),this.setBufferingItem(c),this.bufferingAsset=o;const l=this.getBufferingPlayer();if(l===e)return;const u=r.appendInPlace;if(u&&l?.interstitial.appendInPlace===!1)return;const h=l?.tracks||((n=this.detachedData)==null?void 0:n.tracks)||this.requiredTracks;if(u&&o!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(h&&!Rf(h,e.tracks)){const f=new Error(`Asset ${An(o)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(h)}')`),m={fatal:!0,type:ae.OTHER_ERROR,details:V.INTERSTITIAL_ASSET_ITEM_ERROR,error:f},p=r.findAssetIndex(o);this.handleAssetItemError(m,r,a,p,f.message);return}}this.transferMediaTo(e,t)}handleInPlaceStall(e){const t=this.schedule,i=this.primaryMedia;if(!t||!i)return;const n=i.currentTime,r=t.findAssetIndex(e,n),o=e.assetList[r];if(o){const a=this.getAssetPlayer(o.identifier);if(a){const c=a.currentTime||n-o.timelineStart,l=a.duration-c;if(this.warn(`Stalled at ${c} of ${c+l} in ${a} ${e} (media.currentTime: ${n})`),c&&(l/i.playbackRate<.5||a.bufferedInPlaceToEnd(i))&&a.hls){const u=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,u,r)}}}}advanceInPlace(e){const t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e)}handleAssetItemError(e,t,i,n,r){if(e.details===V.BUFFER_STALLED_ERROR)return;const o=t.assetList[n]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${o&&An(o)} ${e.error}`),!this.schedule)return;const a=o?.identifier||"",c=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[c]||null,u=this.schedule.items,h=De({},e,{fatal:!1,errorAction:Cn(!0),asset:o,assetListIndex:n,event:t,schedule:u,scheduleIndex:i,player:l});if(this.hls.trigger(S.INTERSTITIAL_ASSET_ERROR,h),!e.fatal)return;const f=this.playingAsset,m=this.bufferingAsset,p=new Error(r);if(o&&(this.clearAssetPlayer(a,null),o.error=p),!t.assetList.some(g=>!g.error))t.error=p;else for(let g=n;g<t.assetList.length;g++)this.resetAssetPlayer(t.assetList[g].identifier);this.updateSchedule(!0),t.error?this.primaryFallback(t):f&&f.identifier===a?this.advanceAfterAssetEnded(t,i,n):m&&m.identifier===a&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,m)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;let n=this.timelinePos;if(i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${n} playing: ${Ot(i)} error: ${e.error}`),n===-1&&(n=this.hls.startPosition);const o=this.updateItem(i,n);this.itemsMatch(i,o)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}else if(n===-1){this.checkStart();return}if(!this.schedule)return;const r=this.schedule.findItemIndexAtTime(n);this.setSchedulePosition(r)}onAssetListLoaded(e,t){var i,n;const r=t.event,o=r.identifier,a=t.assetListResponse.ASSETS;if(!((i=this.schedule)!=null&&i.hasEvent(o)))return;const c=r.timelineStart,l=r.duration;let u=0;a.forEach((g,y)=>{const v=parseFloat(g.DURATION);this.createAsset(r,y,u,c+u,v,g.URI),u+=v}),r.duration=u,this.log(`Loaded asset-list with duration: ${u} (was: ${l}) ${r}`);const h=this.waitingItem,f=h?.event.identifier===o;this.updateSchedule();const m=(n=this.bufferingItem)==null?void 0:n.event;if(f){var p;const g=this.schedule.findEventIndex(o),y=(p=this.schedule.items)==null?void 0:p[g];if(y){if(!this.playingItem&&this.timelinePos>y.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==g){r.error=new Error(`Interstitial ${a.length?"no longer within playback range":"asset-list is empty"} ${this.timelinePos} ${r}`),this.log(r.error.message),this.updateSchedule(!0),this.primaryFallback(r);return}this.setBufferingItem(y)}this.setSchedulePosition(g)}else if(m?.identifier===o){const g=r.assetList[0];if(g){const y=this.getAssetPlayer(g.identifier);if(m.appendInPlace){const v=this.primaryMedia;y&&v&&this.bufferAssetPlayer(y,v)}else y&&y.loadSource()}}}onError(e,t){if(this.schedule)switch(t.details){case V.ASSET_LIST_PARSING_ERROR:case V.ASSET_LIST_LOAD_ERROR:case V.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&(this.updateSchedule(!0),this.primaryFallback(i));break}case V.BUFFER_STALLED_ERROR:{const i=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&i.event.appendInPlace){this.handleInPlaceStall(i.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}}const ku=500;class Z0 extends eo{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",se.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(S.LEVEL_LOADED,this.onLevelLoaded,this),e.on(S.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(S.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(S.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(S.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(S.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(S.LEVEL_LOADED,this.onLevelLoaded,this),e.off(S.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(S.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(S.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(S.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(S.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=q.IDLE,this.setInterval(ku),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(this.fragContextChanged(i)||(Ke(i)&&(this.fragPrevious=i),this.state=q.IDLE),!n)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let o;const a=i.start;for(let l=0;l<r.length;l++)if(a>=r[l].start&&a<=r[l].end){o=r[l];break}const c=i.start+i.duration;o?o.end=c:(o={start:a,end:c},r.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(i===0&&n!==Number.POSITIVE_INFINITY){const r=n-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=r){o.shift();continue}else if(o[a].start<r)o[a].start=r;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,r,se.SUBTITLE)}}onError(e,t){const i=t.frag;i?.type===se.SUBTITLE&&(t.details===V.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==q.STOPPED&&(this.state=q.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&P0(this.levels,t)){this.levels=t.map(i=>new Bn(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const n=new Bn(i);return this.tracksBuffered[n.id]=[],n}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,se.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.state!==q.STOPPED&&this.setInterval(ku)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:r}=this,{details:o,id:a}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const c=r[a];if(a>=r.length||!c)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(o.live||(i=c.details)!=null&&i.live){if(o.deltaUpdateFailed)return;const h=this.mainDetails;if(!h){this.startFragRequested=!1;return}const f=h.fragments[0];if(!c.details)o.hasProgramDateTime&&h.hasProgramDateTime?(Gr(o,h),l=o.fragmentStart):f&&(l=f.start,qa(o,l));else{var u;l=this.alignPlaylists(o,c.details,(u=this.levelLastLoaded)==null?void 0:u.details),l===0&&f&&(l=f.start,qa(o,l))}h&&!this.startFragRequested&&this.setStartPosition(h,l)}c.details=o,this.levelLastLoaded=c,a===n&&(this.hls.trigger(S.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===q.IDLE&&(Zi(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&Rn(n.method)){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,Gl(n.method)).catch(a=>{throw r.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const c=performance.now();r.trigger(S.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:c}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=q.IDLE})}}doTick(){if(!this.media){this.state=q.IDLE;return}if(this.state===q.IDLE){const{currentTrackId:e,levels:t}=this,i=t?.[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:n}=this,r=this.getLoadPosition(),o=pe.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,n.maxBufferHole),{end:a,len:c}=o,l=i.details,u=this.hls.maxBufferLength+l.levelTargetDuration;if(c>u)return;const h=l.fragments,f=h.length,m=l.edge;let p=null;const g=this.fragPrevious;if(a<m){const E=n.maxFragLookUpTolerance,x=a>m-E?0:E;p=Zi(g,h,Math.max(h[0].start,a),x),!p&&g&&g.start<h[0].start&&(p=h[0])}else p=h[f-1];if(p=this.filterReplacedPrimary(p,i.details),!p)return;const y=p.sn-l.startSN,v=h[y-1];if(v&&v.cc===p.cc&&this.fragmentTracker.getState(v)===et.NOT_LOADED&&(p=v),this.fragmentTracker.getState(p)===et.NOT_LOADED){const E=this.mapToInitFragWhenRequired(p);E&&this.loadFragment(E,i,a)}}}loadFragment(e,t,i){Ke(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new Rx(this.tracksBuffered[this.currentTrackId]||[])}}class Rx{constructor(e){this.buffered=void 0;const t=(i,n,r)=>{if(n=n>>>0,n>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const wx={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},em=s=>String.fromCharCode(wx[s]||s),Nt=15,ri=100,Ix={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},_x={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Lx={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Px={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Mx=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class Dx{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;Pe.log(`${this.time} [${e}] ${i}`)}}}const Gi=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class tm{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Bx{constructor(){this.uchar=" ",this.penState=new tm}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class Fx{constructor(e){this.chars=[],this.pos=0,this.currPenState=new tm,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<ri;t++)this.chars.push(new Bx);this.logger=e}equals(e){for(let t=0;t<ri;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<ri;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<ri;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>ri&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=ri)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=em(e);if(this.pos>=ri){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<ri;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<ri;i++){const n=this.chars[i].uchar;n!==" "&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Xo{constructor(e){this.rows=[],this.currRow=Nt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Nt;t++)this.rows.push(new Fx(e));this.logger=e}reset(){for(let e=0;e<Nt;e++)this.rows[e].clear();this.currRow=Nt-1}equals(e){let t=!0;for(let i=0;i<Nt;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Nt;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Nt;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+ke(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<Nt;a++)this.rows[a].clear();const r=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[r].cueStartTime,c=this.logger.time;if(a!==null&&c!==null&&a<c)for(let l=0;l<this.nrRollUpRows;l++)this.rows[t-this.nrRollUpRows+l+1].copy(o.rows[r+l])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,o=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+ke(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let r=0;r<Nt;r++){const o=this.rows[r].getTextString();o&&(n=r+1,e?t.push("Row "+n+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class Ou{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Xo(i),this.nonDisplayedMemory=new Xo(i),this.lastOutputScreen=new Xo(i),this.currRollUpRow=this.displayedMemory.rows[Nt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Nt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+ke(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Nu{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=Ox(),this.logger=void 0;const n=this.logger=new Dx;this.channels=[null,new Ou(e,t,n),new Ou(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const n=t[i]&127,r=t[i+1]&127;let o=!1,a=null;if(n===0&&r===0)continue;this.logger.log(3,()=>"["+Gi([t[i],t[i+1]])+"] -> ("+Gi([n,r])+")");const c=this.cmdHistory;if(n>=16&&n<=31){if(kx(n,r,c)){Vs(null,null,c),this.logger.log(3,()=>"Repeated command ("+Gi([n,r])+") is dropped");continue}Vs(n,r,this.cmdHistory),o=this.parseCmd(n,r),o||(o=this.parseMidrow(n,r)),o||(o=this.parsePAC(n,r)),o||(o=this.parseBackgroundAttributes(n,r))}else Vs(null,null,c);if(!o&&(a=this.parseChars(n,r),a)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Gi([n,r])+" orig: "+Gi([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=33&&t<=35;if(!(i||n))return!1;const r=e===20||e===21||e===23?1:2,o=this.channels[r];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return n?(n.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Gi([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const n=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(n||r))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?Ix[e]:Lx[e]:i=o===1?_x[e]:Px[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,n.underline=(i&1)===1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=Math.floor((i-16)/2)*4,n}parseChars(e,t){let i,n=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let o;r===17?o=t+80:r===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+em(o)+"' in channel "+i),n=[o]}else e>=32&&e<=127&&(n=t===0?[e]:[e,t]);return n&&this.logger.log(3,()=>"Char codes =  "+Gi(n).join(",")),n}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=45&&t<=47;if(!(i||n))return!1;let r;const o={};e===16||e===24?(r=Math.floor((t-32)/2),o.background=Mx[r],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}Vs(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function Vs(s,e,t){t.a=s,t.b=e}function kx(s,e,t){return t.a===s&&t.b===e}function Ox(){return{a:null,b:null}}var Zl=(function(){if(zr!=null&&zr.VTTCue)return self.VTTCue;const s=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,c){if(typeof c!="string"||!Array.isArray(a))return!1;const l=c.toLowerCase();return~a.indexOf(l)?l:!1}function i(a){return t(s,a)}function n(a){return t(e,a)}function r(a,...c){let l=1;for(;l<arguments.length;l++){const u=arguments[l];for(const h in u)a[h]=u[h]}return a}function o(a,c,l){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let f="",m=!1,p=a,g=c,y=l,v=null,E="",x=!0,T="auto",A="start",C=50,b="middle",R=50,I="middle";Object.defineProperty(u,"id",r({},h,{get:function(){return f},set:function(w){f=""+w}})),Object.defineProperty(u,"pauseOnExit",r({},h,{get:function(){return m},set:function(w){m=!!w}})),Object.defineProperty(u,"startTime",r({},h,{get:function(){return p},set:function(w){if(typeof w!="number")throw new TypeError("Start time must be set to a number.");p=w,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",r({},h,{get:function(){return g},set:function(w){if(typeof w!="number")throw new TypeError("End time must be set to a number.");g=w,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",r({},h,{get:function(){return y},set:function(w){y=""+w,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",r({},h,{get:function(){return v},set:function(w){v=w,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",r({},h,{get:function(){return E},set:function(w){const M=i(w);if(M===!1)throw new SyntaxError("An invalid or illegal string was specified.");E=M,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",r({},h,{get:function(){return x},set:function(w){x=!!w,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",r({},h,{get:function(){return T},set:function(w){if(typeof w!="number"&&w!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");T=w,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",r({},h,{get:function(){return A},set:function(w){const M=n(w);if(!M)throw new SyntaxError("An invalid or illegal string was specified.");A=M,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",r({},h,{get:function(){return C},set:function(w){if(w<0||w>100)throw new Error("Position must be between 0 and 100.");C=w,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",r({},h,{get:function(){return b},set:function(w){const M=n(w);if(!M)throw new SyntaxError("An invalid or illegal string was specified.");b=M,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",r({},h,{get:function(){return R},set:function(w){if(w<0||w>100)throw new Error("Size must be between 0 and 100.");R=w,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",r({},h,{get:function(){return I},set:function(w){const M=n(w);if(!M)throw new SyntaxError("An invalid or illegal string was specified.");I=M,this.hasBeenReset=!0}})),u.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o})();class Nx{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function im(s){function e(i,n,r,o){return(i|0)*3600+(n|0)*60+(r|0)+parseFloat(o||0)}const t=s.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class Ux{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function nm(s,e,t,i){const n=i?s.split(i):[s];for(const r in n){if(typeof n[r]!="string")continue;const o=n[r].split(t);if(o.length!==2)continue;const a=o[0],c=o[1];e(a,c)}}const ol=new Zl(0,0,""),js=ol.align==="middle"?"middle":"center";function zx(s,e,t){const i=s;function n(){const a=im(s);if(a===null)throw new Error("Malformed timestamp: "+i);return s=s.replace(/^[^\sa-zA-Z-]+/,""),a}function r(a,c){const l=new Ux;nm(a,function(f,m){let p;switch(f){case"region":for(let g=t.length-1;g>=0;g--)if(t[g].id===m){l.set(f,t[g].region);break}break;case"vertical":l.alt(f,m,["rl","lr"]);break;case"line":p=m.split(","),l.integer(f,p[0]),l.percent(f,p[0])&&l.set("snapToLines",!1),l.alt(f,p[0],["auto"]),p.length===2&&l.alt("lineAlign",p[1],["start",js,"end"]);break;case"position":p=m.split(","),l.percent(f,p[0]),p.length===2&&l.alt("positionAlign",p[1],["start",js,"end","line-left","line-right","auto"]);break;case"size":l.percent(f,m);break;case"align":l.alt(f,m,["start",js,"end","left","right"]);break}},/:/,/\s/),c.region=l.get("region",null),c.vertical=l.get("vertical","");let u=l.get("line","auto");u==="auto"&&ol.line===-1&&(u=-1),c.line=u,c.lineAlign=l.get("lineAlign","start"),c.snapToLines=l.get("snapToLines",!0),c.size=l.get("size",100),c.align=l.get("align",js);let h=l.get("position","auto");h==="auto"&&ol.position===50&&(h=c.align==="start"||c.align==="left"?0:c.align==="end"||c.align==="right"?100:50),c.position=h}function o(){s=s.replace(/^\s+/,"")}if(o(),e.startTime=n(),o(),s.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);s=s.slice(3),o(),e.endTime=n(),o(),r(s,e)}function sm(s){return s.replace(/<br(?: \/)?>/gi,`
`)}class Gx{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new Nx,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,o=0;for(r=sm(r);o<r.length&&r[o]!=="\r"&&r[o]!==`
`;)++o;const a=r.slice(0,o);return r[o]==="\r"&&++o,r[o]===`
`&&++o,t.buffer=r.slice(o),a}function n(r){nm(r,function(o,a){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const a=r.match(/^()?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:r=i(),t.state){case"HEADER":/:/.test(r)?n(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new Zl(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{zx(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=r.indexOf("-->")!==-1;if(!r||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const $x=/\r\n|\n\r|\n|\r/g,Yo=function(e,t,i=0){return e.slice(i,i+t.length)===t},Hx=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!ie(t)||!ie(i)||!ie(n)||!ie(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*n,t+=3600*1e3*r,t};function ec(s,e,t){return ls(s.toString())+ls(e.toString())+ls(t)}const Kx=function(e,t,i){let n=e[t],r=e[n.prevCC];if(!r||!r.new&&n.new){e.ccOffset=e.presentationOffset=n.start,n.new=!1;return}for(;(o=r)!=null&&o.new;){var o;e.ccOffset+=n.start-r.start,n.new=!1,n=r,r=e[n.prevCC]}e.presentationOffset=i};function Vx(s,e,t,i,n,r,o){const a=new Gx,c=_t(new Uint8Array(s)).trim().replace($x,`
`).split(`
`),l=[],u=e?rv(e.baseTime,e.timescale):0;let h="00:00.000",f=0,m=0,p,g=!0;a.oncue=function(y){const v=t[i];let E=t.ccOffset;const x=(f-u)/9e4;if(v!=null&&v.new&&(m!==void 0?E=t.ccOffset=v.start:Kx(t,i,x)),x){if(!e){p=new Error("Missing initPTS for VTT MPEGTS");return}E=x-t.presentationOffset}const T=y.endTime-y.startTime,A=It((y.startTime+E-m)*9e4,n*9e4)/9e4;y.startTime=Math.max(A,0),y.endTime=Math.max(A+T,0);const C=y.text.trim();y.text=decodeURIComponent(encodeURIComponent(C)),y.id||(y.id=ec(y.startTime,y.endTime,C)),y.endTime>0&&l.push(y)},a.onparsingerror=function(y){p=y},a.onflush=function(){if(p){o(p);return}r(l)},c.forEach(y=>{if(g)if(Yo(y,"X-TIMESTAMP-MAP=")){g=!1,y.slice(16).split(",").forEach(v=>{Yo(v,"LOCAL:")?h=v.slice(6):Yo(v,"MPEGTS:")&&(f=parseInt(v.slice(7)))});try{m=Hx(h)/1e3}catch(v){p=v}return}else y===""&&(g=!1);a.parse(y+`
`)}),a.flush()}const Qo="stpp.ttml.im1t",rm=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,om=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,jx={left:"start",center:"center",right:"end",start:"start",end:"end"};function Uu(s,e,t,i){const n=Ae(new Uint8Array(s),["mdat"]);if(n.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=n.map(a=>_t(a)),o=sv(e.baseTime,1,e.timescale);try{r.forEach(a=>t(Wx(a,o)))}catch(a){i(a)}}function Wx(s,e){const n=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(r).reduce((h,f)=>(h[f]=n.getAttribute(`ttp:${f}`)||r[f],h),{}),a=n.getAttribute("xml:space")!=="preserve",c=zu(Jo(n,"styling","style")),l=zu(Jo(n,"layout","region")),u=Jo(n,"body","[begin]");return[].map.call(u,h=>{const f=am(h,a);if(!f||!h.hasAttribute("begin"))return null;const m=Zo(h.getAttribute("begin"),o),p=Zo(h.getAttribute("dur"),o);let g=Zo(h.getAttribute("end"),o);if(m===null)throw Gu(h);if(g===null){if(p===null)throw Gu(h);g=m+p}const y=new Zl(m-e,g-e,f);y.id=ec(y.startTime,y.endTime,y.text);const v=l[h.getAttribute("region")],E=c[h.getAttribute("style")],x=Xx(v,E,c),{textAlign:T}=x;if(T){const A=jx[T];A&&(y.lineAlign=A),y.align=T}return De(y,x),y}).filter(h=>h!==null)}function Jo(s,e,t){const i=s.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function zu(s){return s.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function am(s,e){return[].slice.call(s.childNodes).reduce((t,i,n)=>{var r;return i.nodeName==="br"&&n?t+`
`:(r=i.childNodes)!=null&&r.length?am(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function Xx(s,e,t){const i="http://www.w3.org/ns/ttml#styling";let n=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=s!=null&&s.hasAttribute("style")?s.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(n=t[o]),r.reduce((a,c)=>{const l=qo(e,i,c)||qo(s,i,c)||qo(n,i,c);return l&&(a[c]=l),a},{})}function qo(s,e,t){return s&&s.hasAttributeNS(e,t)?s.getAttributeNS(e,t):null}function Gu(s){return new Error(`Could not parse ttml timestamp ${s}`)}function Zo(s,e){if(!s)return null;let t=im(s);return t===null&&(rm.test(s)?t=Yx(s,e):om.test(s)&&(t=Qx(s,e))),t}function Yx(s,e){const t=rm.exec(s),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function Qx(s,e){const t=om.exec(s),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class Ws{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class lm{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Hu(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(S.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(S.FRAG_LOADING,this.onFragLoading,this),e.on(S.FRAG_LOADED,this.onFragLoaded,this),e.on(S.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(S.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(S.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(S.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(S.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(S.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(S.FRAG_LOADING,this.onFragLoading,this),e.off(S.FRAG_LOADED,this.onFragLoaded,this),e.off(S.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(S.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(S.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(S.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(S.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new Ws(this,"textTrack1"),t=new Ws(this,"textTrack2"),i=new Ws(this,"textTrack3"),n=new Ws(this,"textTrack4");this.cea608Parser1=new Nu(1,e,t),this.cea608Parser2=new Nu(3,i,n)}addCues(e,t,i,n,r){let o=!1;for(let a=r.length;a--;){const c=r[a],l=Jx(c[0],c[1],t,i);if(l>=0&&(c[0]=Math.min(c[0],t),c[1]=Math.max(c[1],i),o=!0,l/(i-t)>.5))return}if(o||r.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,n)}else{const a=this.Cues.newCue(null,t,i,n);this.hls.trigger(S.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:r,trackId:o}){const{unparsedVttFrags:a}=this;i===se.MAIN&&(this.initPTS[t.cc]={baseTime:n,timescale:r,trackId:o}),a.length&&(this.unparsedVttFrags=[],a.forEach(c=>{this.initPTS[c.frag.cc]?this.onFragLoaded(S.FRAG_LOADED,c):this.hls.trigger(S.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:c.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const r=i.textTracks[n];if($u(r,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:r,languageCode:o}=t[e],a=this.getExistingTrack(r,o);if(a)i[e]=a,bn(i[e]),Y0(i[e],n);else{const c=this.createTextTrack("captions",r,o);c&&(c[e]=!0,i[e]=c)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,n={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(S.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:n}=this;Object.keys(n).forEach(r=>{bn(n[r]),delete n[r]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Hu(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)bn(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some(r=>r.textCodec===Qo);if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(P0(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?_r(o.textTracks):null;if(this.tracks.forEach((c,l)=>{let u;if(a){let h=null;for(let f=0;f<a.length;f++)if(a[f]&&$u(a[f],c)){h=a[f],a[f]=null;break}h&&(u=h)}if(u)bn(u);else{const h=cm(c);u=this.createTextTrack(h,c.name,c.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),a!=null&&a.length){const c=a.filter(l=>l!==null).map(l=>l.label);c.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${c.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(S.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const n=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!n)return;const r=`textTrack${n[1]}`,o=this.captionsProperties[r];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t?.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===se.MAIN){var i,n;const{cea608Parser1:r,cea608Parser2:o,lastSn:a}=this,{cc:c,sn:l}=t.frag,u=(i=(n=t.part)==null?void 0:n.index)!=null?i:-1;r&&o&&(l!==a+1||l===a&&u!==this.lastPartIndex+1||c!==this.lastCc)&&(r.reset(),o.reset()),this.lastCc=c,this.lastSn=l,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===se.SUBTITLE)if(n.byteLength){const r=i.decryptdata,o="stats"in t;if(r==null||!r.encrypted||o){const a=this.tracks[i.level],c=this.vttCCs;c[i.cc]||(c[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===Qo?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(S.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;Uu(t,this.initPTS[e.cc],n=>{this._appendCues(n,e.level),i.trigger(S.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},n=>{i.logger.log(`Failed to parse IMSC1: ${n}`),i.trigger(S.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:r,unparsedVttFrags:o}=this,a=r.length-1;if(!r[i.cc]&&a===-1){o.push(e);return}const c=this.hls,l=(t=i.initSegment)!=null&&t.data?Dt(i.initSegment.data,new Uint8Array(n)).buffer:n;Vx(l,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),c.trigger(S.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?o.push(e):this._fallbackToIMSC1(i,n),c.logger.log(`Failed to parse VTT cue: ${u}`),!(h&&a>i.cc)&&c.trigger(S.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||Uu(t,this.initPTS[e.cc],()=>{i.textCodec=Qo,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||n.mode==="disabled")return;e.forEach(r=>Q0(n,r))}else{const n=this.tracks[t];if(!n)return;const r=n.default?"default":"subtitles"+t;i.trigger(S.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===se.SUBTITLE&&this.onFragLoaded(S.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:n}=t;if(!(i.type===se.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let r=0;r<n.length;r++){const o=n[r].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(o);this.cea608Parser1.addData(n[r].pts,a[0]),this.cea608Parser2.addData(n[r].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:r}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!r||r==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(c=>rl(a[c],t,i))}if(this.config.renderTextTracksNatively&&t===0&&n!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(c=>rl(a[c],t,n))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let n=2;for(let r=0;r<i;r++){const o=e[n++],a=127&e[n++],c=127&e[n++];if(a===0&&c===0)continue;if((4&o)!==0){const u=3&o;(u===0||u===1)&&(t[u].push(a),t[u].push(c))}}return t}}function cm(s){return s.characteristics&&/transcribes-spoken-dialog/gi.test(s.characteristics)&&/describes-music-and-sound/gi.test(s.characteristics)?"captions":"subtitles"}function $u(s,e){return!!s&&s.kind===cm(e)&&tl(e,s)}function Jx(s,e,t,i){return Math.min(e,i)-Math.max(s,t)}function Hu(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const qx=/\s/,um={newCue(s,e,t,i){const n=[];let r,o,a,c,l;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(r=i.rows[f],a=!0,c=0,l="",!r.isEmpty()){var h;for(let g=0;g<r.chars.length;g++)qx.test(r.chars[g].uchar)&&a?c++:(l+=r.chars[g].uchar,a=!1);r.cueStartTime=e,e===t&&(t+=1e-4),c>=16?c--:c++;const m=sm(l.trim()),p=ec(e,t,m);s!=null&&(h=s.cues)!=null&&h.getCueById(p)||(o=new u(e,t,m),o.id=p,o.line=f+1,o.align="left",o.position=10+Math.min(80,Math.floor(c*8/32)*10),n.push(o))}return s&&n.length&&(n.sort((f,m)=>f.line==="auto"||m.line==="auto"?0:f.line>8&&m.line>8?m.line-f.line:f.line-m.line),n.forEach(f=>Q0(s,f))),n}};function hm(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const Zx=/(\d+)-(\d+)\/(\d+)/;class al{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||n4,this.controller=new self.AbortController,this.stats=new Jr}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const n=this.stats;if(n.loading.start)throw new Error("Loader can only be used once.");n.loading.start=self.performance.now();const r=e4(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=c&&ie(c)?c:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},t.timeout),(ps(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(h=>{var f;this.response=this.loader=h;const m=Math.max(self.performance.now(),n.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},l-(m-n.loading.start)),!h.ok){const{status:g,statusText:y}=h;throw new s4(y||"fetch, bad network response",g,h)}n.loading.first=m,n.total=i4(h.headers)||n.total;const p=(f=this.callbacks)==null?void 0:f.onProgress;return p&&ie(t.highWaterMark)?this.loadProgressively(h,n,e,t.highWaterMark,p):o?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{var f,m;const p=this.response;if(!p)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),n.loading.end=Math.max(self.performance.now(),n.loading.first);const g=h[a];g&&(n.loaded=n.total=g);const y={url:p.url,data:h,code:p.status},v=(f=this.callbacks)==null?void 0:f.onProgress;v&&!ie(t.highWaterMark)&&v(n,e,h,p),(m=this.callbacks)==null||m.onSuccess(y,n,e,p)}).catch(h=>{var f;if(self.clearTimeout(this.requestTimeout),n.aborted)return;const m=h&&h.code||0,p=h?h.message:null;(f=this.callbacks)==null||f.onError({code:m,text:p},e,h?h.details:null,n)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,n=0,r){const o=new u0,a=e.body.getReader(),c=()=>a.read().then(l=>{if(l.done)return o.dataLength&&r(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const u=l.value,h=u.length;return t.loaded+=h,h<n||o.dataLength?(o.push(u),o.dataLength>=n&&r(t,i,o.flush().buffer,e)):r(t,i,u.buffer,e),c()}).catch(()=>Promise.reject());return c()}}function e4(s,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(De({},s.headers))};return s.rangeEnd&&t.headers.set("Range","bytes="+s.rangeStart+"-"+String(s.rangeEnd-1)),t}function t4(s){const e=Zx.exec(s);if(e)return parseInt(e[2])-parseInt(e[1])+1}function i4(s){const e=s.get("Content-Range");if(e){const i=t4(e);if(ie(i))return i}const t=s.get("Content-Length");if(t)return parseInt(t)}function n4(s,e){return new self.Request(s.url,e)}class s4 extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const r4=/^age:\s*[\d.]+\s*$/im;class tc{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Jr,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,n)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:o}=i.loadPolicy;if(n)for(const a in n)e.setRequestHeader(a,n[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&ie(r)?r:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,r=this.config;if(!i.aborted&&n>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),n===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const l=t.status,u=t.responseType==="text"?t.responseText:null;if(l>=200&&l<300){const p=u??t.response;if(p!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const g=t.responseType==="arraybuffer"?p.byteLength:p.length;i.loaded=i.total=g,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const y=(o=this.callbacks)==null?void 0:o.onProgress;y&&y(i,e,p,t);const v={url:t.responseURL,data:p,code:l};(a=this.callbacks)==null||a.onSuccess(v,i,e,t);return}}const h=r.loadPolicy.errorRetry,f=i.retry,m={url:e.url,data:void 0,code:l};if(Nr(h,f,!1,m))this.retry(h);else{var c;Pe.error(`${l} while loading ${e.url}`),(c=this.callbacks)==null||c.onError({code:l,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Nr(e,t,!0))this.retry(e);else{var i;Pe.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Nl(e,i.retry),i.retry++,Pe.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t?.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&r4.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const o4={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},a4=Le(Le({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:tc,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Hf,bufferController:B0,capLevelController:no,errorController:Xf,fpsController:X0,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Hl,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:o4},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},l4()),{},{subtitleStreamController:Z0,subtitleTrackController:J0,timelineController:lm,audioStreamController:L0,audioTrackController:M0,emeController:Xi,cmcdController:V0,contentSteeringController:j0,interstitialsController:Cx});function l4(){return{cueHandler:um,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function c4(s,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=ll(s),n=["manifest","level","frag"],r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return n.forEach(o=>{const a=`${o==="level"?"playlist":o}LoadPolicy`,c=e[a]===void 0,l=[];r.forEach(u=>{const h=`${o}Loading${u}`,f=e[h];if(f!==void 0&&c){l.push(h);const m=i[a].default;switch(e[a]={default:m},u){case"TimeOut":m.maxLoadTimeMs=f,m.maxTimeToFirstByteMs=f;break;case"MaxRetry":m.errorRetry.maxNumRetry=f,m.timeoutRetry.maxNumRetry=f;break;case"RetryDelay":m.errorRetry.retryDelayMs=f,m.timeoutRetry.retryDelayMs=f;break;case"MaxRetryTimeout":m.errorRetry.maxRetryDelayMs=f,m.timeoutRetry.maxRetryDelayMs=f;break}}}),l.length&&t.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${ke(e[a])}`)}),Le(Le({},i),e)}function ll(s){return s&&typeof s=="object"?Array.isArray(s)?s.map(ll):Object.keys(s).reduce((e,t)=>(e[t]=ll(s[t]),e),{}):s}function u4(s,e){const t=s.loader;t!==al&&t!==tc?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),s.progressive=!1):hm()&&(s.loader=al,s.progressive=!0,s.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const Lr=2,h4=.1,d4=.05,f4=100;class m4 extends Yf{constructor(e,t){super("gap-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(S.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(f4),this.mediaSource=t.mediaSource;const i=this.media=t.media;mt(i,"playing",this.onMediaPlaying),mt(i,"waiting",this.onMediaWaiting),mt(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(Et(i,"playing",this.onMediaPlaying),Et(i,"waiting",this.onMediaWaiting),Et(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,n;const r=(i=this.hls)==null?void 0:i.config;if(!r)return;const o=this.media;if(!o)return;const{seeking:a}=o,c=this.seeking&&!a,l=!this.seeking&&a,u=o.paused&&!a||o.ended||o.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,r.nudgeOnVideoHole&&!u&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(l||c){c&&this.stallResolved(e);return}if(u){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(S.MEDIA_ENDED,{stalled:!1}));return}if(!pe.getBuffered(o).length){this.nudgeRetry=0;return}const h=pe.bufferInfo(o,e,0),f=h.nextStart||0,m=this.fragmentTracker;if(a&&m&&this.hls){const C=Ku(this.hls.inFlightFragments,e),b=h.len>Lr,R=!f||C||f-e>Lr&&!m.getPartialFragment(e);if(b||R)return;this.moved=!1}const p=(n=this.hls)==null?void 0:n.latestLevelDetails;if(!this.moved&&this.stalled!==null&&m){if(!(h.len>0)&&!f)return;const b=Math.max(f,h.start||0)-e,I=!!(p!=null&&p.live)?p.targetduration*2:Lr,w=Xs(e,m);if(b>0&&(b<=I||w)){o.paused||this._trySkipBufferHole(w);return}}const g=r.detectStallWithCurrentTimeMs,y=self.performance.now(),v=this.waiting;let E=this.stalled;if(E===null)if(v>0&&y-v<g)E=this.stalled=v;else{this.stalled=y;return}const x=y-E;if(!a&&(x>=g||v)&&this.hls){var T;if(((T=this.mediaSource)==null?void 0:T.readyState)==="ended"&&!(p!=null&&p.live)&&Math.abs(e-(p?.edge||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(S.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(h),!this.media||!this.hls)return}const A=pe.bufferInfo(o,e,r.maxBufferHole);this._tryFixBufferStall(A,x,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(S.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const n=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&n&&n.length>1&&e>n.end(0)){const r=pe.bufferedInfo(pe.timeRangesToArray(this.buffered.audio),e,0);if(r.len>1&&t>=r.start){const o=pe.timeRangesToArray(n),a=pe.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){const c=pe.bufferedInfo(o,e,0).bufferedIndex,l=o[a].end,u=o[a+1].start;if((c===-1||c>a)&&u-l<1&&e-l<2){const h=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${l} -> ${u} buffered index: ${c}`);this.warn(h.message),this.media.currentTime+=1e-6;let f=Xs(e,this.fragmentTracker);f&&"fragment"in f?f=f.fragment:f||(f=void 0);const m=pe.bufferInfo(this.media,e,0);this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:h,reason:h.message,frag:f,buffer:m.len,bufferInfo:m})}}}}}_tryFixBufferStall(e,t,i){var n,r;const{fragmentTracker:o,media:a}=this,c=(n=this.hls)==null?void 0:n.config;if(!a||!o||!c)return;const l=(r=this.hls)==null?void 0:r.latestLevelDetails,u=Xs(i,o);if((u||l!=null&&l.live&&i<l.fragmentStart)&&(this._trySkipBufferHole(u)||!this.media))return;const h=e.buffered,f=this.adjacentTraversal(e,i);(h&&h.length>1&&e.len>c.maxBufferHole||e.nextStart&&(e.nextStart-i<c.maxBufferHole||f))&&(t>c.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const i=this.fragmentTracker,n=e.nextStart;if(i&&n){const r=i.getFragAtPos(t,se.MAIN),o=i.getFragAtPos(n,se.MAIN);if(r&&o)return o.sn-r.sn<2}return!1}_reportStall(e){const{hls:t,media:i,stallReported:n,stalled:r}=this;if(!n&&r!==null&&i&&t){this.stallReported=!0;const o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${ke(e)})`);this.warn(o.message),t.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:r}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:n}=this,r=(t=this.hls)==null?void 0:t.config;if(!n||!i||!r)return 0;const o=n.currentTime,a=pe.bufferInfo(n,o,0),c=o<a.start?a.start:a.nextStart;if(c&&this.hls){const u=a.len<=r.maxBufferHole,h=a.len>0&&a.len<1&&n.readyState<3,f=c-o;if(f>0&&(u||h)){if(f>r.maxBufferHole){let p=!1;if(o===0){const g=i.getAppendedFrag(0,se.MAIN);g&&c<g.end&&(p=!0)}if(!p&&e){var l;if(!((l=this.hls.loadLevelObj)!=null&&l.details)||Ku(this.hls.inFlightFragments,c))return 0;let y=!1,v=e.end;for(;v<c;){const E=Xs(v,i);if(E)v+=E.duration;else{y=!0;break}}if(y)return 0}}const m=Math.max(c+d4,o+h4);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${m}`),this.moved=!0,n.currentTime=m,!(e!=null&&e.gap)){const p=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${m}`),g={type:ae.MEDIA_ERROR,details:V.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:p,reason:p.message,buffer:a.len,bufferInfo:a};e&&("fragment"in e?g.part=e:g.frag=e),this.hls.trigger(S.ERROR,g)}return m}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:n}=this,r=t?.config;if(!i||!r)return 0;const o=i.currentTime;if(this.nudgeRetry++,n<r.nudgeMaxRetry){const a=o+(n+1)*r.nudgeOffset,c=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(c.message),i.currentTime=a,t.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_NUDGE_ON_STALL,error:c,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${o} after ${r.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function Ku(s,e){const t=Vu(s.main);if(t&&t.start<=e)return t;const i=Vu(s.audio);return i&&i.start<=e?i:null}function Vu(s){if(!s)return null;switch(s.state){case q.IDLE:case q.STOPPED:case q.ENDED:case q.ERROR:return null}return s.frag}function Xs(s,e){return e.getAppendedFrag(s,se.MAIN)||e.getPartialFragment(s)}const p4=.25;function cl(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function ea(s,e,t,i,n){let r=new s(e,t,"");try{r.value=i,n&&(r.type=n)}catch{r=new s(e,t,ke(n?Le({type:n},i):i))}return r}const Ys=(()=>{const s=cl();try{s&&new s(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class g4{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(S.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e&&(e.on(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(S.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(S.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(S.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(S.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(S.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){var e;const t=(e=this.hls)==null?void 0:e.latestLevelDetails;t&&this.updateDateRangeCues(t)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&bn(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return Y0(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media||!this.hls)return;const{enableEmsgMetadataCues:i,enableID3MetadataCues:n}=this.hls.config;if(!i&&!n)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=cl();if(o)for(let a=0;a<r.length;a++){const c=r[a].type;if(c===xt.emsg&&!i||!n)continue;const l=y0(r[a].data),u=r[a].pts;let h=u+r[a].duration;h>Ys&&(h=Ys),h-u<=0&&(h=u+p4);for(let m=0;m<l.length;m++){const p=l[m];if(!v0(p)){this.updateId3CueEnds(u,c);const g=ea(o,u,h,p,c);g&&this.id3Track.addCue(g)}}}}updateId3CueEnds(e,t){var i;const n=(i=this.id3Track)==null?void 0:i.cues;if(n)for(let r=n.length;r--;){const o=n[r];o.type===t&&o.startTime<e&&o.endTime===Ys&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:n}){const{id3Track:r,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:c}}=o;if(r&&(a||c)){let l;n==="audio"?l=u=>u.type===xt.audioId3&&c:n==="video"?l=u=>u.type===xt.emsg&&a:l=u=>u.type===xt.audioId3&&c||u.type===xt.emsg&&a,rl(r,t,i,l)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.hls||!this.media)return;const{assetPlayerId:i,timelineOffset:n,enableDateRangeMetadataCues:r,interstitialsController:o}=this.hls.config;if(!r)return;const a=cl();if(i&&n&&!o){const{fragmentStart:g,fragmentEnd:y}=e;let v=this.assetCue;v?(v.startTime=g,v.endTime=y):a&&(v=this.assetCue=ea(a,g,y,{assetPlayerId:this.hls.config.assetPlayerId},"hlsjs.interstitial.asset"),v&&(v.id=i,this.id3Track||(this.id3Track=this.createTrack(this.media)),this.id3Track.addCue(v),v.addEventListener("enter",this.onEventCueEnter)))}if(!e.hasProgramDateTime)return;const{id3Track:c}=this,{dateRanges:l}=e,u=Object.keys(l);let h=this.dateRangeCuesAppended;if(c&&t){var f;if((f=c.cues)!=null&&f.length){const g=Object.keys(h).filter(y=>!u.includes(y));for(let y=g.length;y--;){var m;const v=g[y],E=(m=h[v])==null?void 0:m.cues;delete h[v],E&&Object.keys(E).forEach(x=>{const T=E[x];if(T){T.removeEventListener("enter",this.onEventCueEnter);try{c.removeCue(T)}catch{}}})}}else h=this.dateRangeCuesAppended={}}const p=e.fragments[e.fragments.length-1];if(!(u.length===0||!ie(p?.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(let g=0;g<u.length;g++){const y=u[g],v=l[y],E=v.startTime,x=h[y],T=x?.cues||{};let A=x?.durationKnown||!1,C=Ys;const{duration:b,endDate:R}=v;if(R&&b!==null)C=E+b,A=!0;else if(v.endOnNext&&!A){const w=u.reduce((M,P)=>{if(P!==v.id){const O=l[P];if(O.class===v.class&&O.startDate>v.startDate&&(!M||v.startDate<M.startDate))return O}return M},null);w&&(C=w.startTime,A=!0)}const I=Object.keys(v.attr);for(let w=0;w<I.length;w++){const M=I[w];if(!Yy(M))continue;const P=T[M];if(P)A&&!(x!=null&&x.durationKnown)?P.endTime=C:Math.abs(P.startTime-E)>.01&&(P.startTime=E,P.endTime=C);else if(a){let O=v.attr[M];Qy(M)&&(O=wf(O));const D=ea(a,E,C,{key:M,data:O},xt.dateRange);D&&(D.id=y,this.id3Track.addCue(D),T[M]=D,o&&(M==="X-ASSET-LIST"||M==="X-ASSET-URL")&&D.addEventListener("enter",this.onEventCueEnter))}}h[y]={cues:T,dateRange:v,durationKnown:A}}}}}class y4{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;const n=this.computeLatency();if(n===null)return;this._latency=n;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:o}=this.config;if(!r||o===1||!i.live)return;const a=this.targetLatency;if(a===null)return;const c=n-a,l=Math.min(this.maxLatency,a+i.targetduration);if(c<l&&c>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,o)),f=Math.round(2/(1+Math.exp(-.75*c-this.edgeStalled))*20)/20,m=Math.min(h,Math.max(1,f));this.changeMediaPlaybackRate(t,m)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:i,targetduration:n}=e,{liveSyncDuration:r,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,c=this.hls.userConfig;let l=a&&i||t;(this._targetLatencyUpdated||c.liveSyncDuration||c.liveSyncDurationCount||l===0)&&(l=r!==void 0?r:o*n);const u=n;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,u)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const i=this.levelDetails;if(i===null)return null;const n=i.edge,r=e-t-this.edgeStalled,o=n-i.totalduration,a=n-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,r),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(S.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(S.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(S.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(S.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===V.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,n;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(n=this.targetLatency)==null?void 0:n.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class v4 extends io{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(S.LEVEL_LOADED,this.onLevelLoaded,this),e.on(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(S.FRAG_BUFFERED,this.onFragBuffered,this),e.on(S.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(S.LEVEL_LOADED,this.onLevelLoaded,this),e.off(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(S.FRAG_BUFFERED,this.onFragBuffered,this),e.off(S.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,n=[],r={},o={};let a=!1,c=!1,l=!1;t.levels.forEach(u=>{const h=u.attrs;let{audioCodec:f,videoCodec:m}=u;f&&(u.audioCodec=f=Br(f,i)||void 0),m&&(m=u.videoCodec=my(m));const{width:p,height:g,unknownCodecs:y}=u,v=y?.length||0;if(a||(a=!!(p&&g)),c||(c=!!m),l||(l=!!f),v||f&&!this.isAudioSupported(f)||m&&!this.isVideoSupported(m)){this.log(`Some or all CODECS not supported "${h.CODECS}"`);return}const{CODECS:E,"FRAME-RATE":x,"HDCP-LEVEL":T,"PATHWAY-ID":A,RESOLUTION:C,"VIDEO-RANGE":b}=h,I=`${`${A||"."}-`}${u.bitrate}-${C}-${x}-${E}-${b}-${T}`;if(r[I])if(r[I].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const w=o[I]+=1;u.attrs["PATHWAY-ID"]=new Array(w+1).join(".");const M=this.createLevel(u);r[I]=M,n.push(M)}else r[I].addGroupId("audio",h.AUDIO),r[I].addGroupId("text",h.SUBTITLES);else{const w=this.createLevel(u);r[I]=w,o[I]=1,n.push(w)}}),this.filterAndSortMediaOptions(n,t,a,c,l)}createLevel(e){const t=new Bn(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const n=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(n.message),t.supportedResult=Uf(n,[])}return t}isAudioSupported(e){return hs(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return hs(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,n,r){var o;let a=[],c=[],l=e;const u=((o=t.stats)==null?void 0:o.parsing)||{};if((i||n)&&r&&(l=l.filter(({videoCodec:E,videoRange:x,width:T,height:A})=>(!!E||!!(T&&A))&&by(x))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let E="no level with compatible codecs found in manifest",x=E;t.levels.length&&(x=`one or more CODECS in variant not supported: ${ke(t.levels.map(A=>A.attrs.CODECS).filter((A,C,b)=>b.indexOf(A)===C))}`,this.warn(x),E+=` (${x})`);const T=new Error(E);this.hls.trigger(S.ERROR,{type:ae.MEDIA_ERROR,details:V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:T,reason:x})}}),u.end=performance.now();return}t.audioTracks&&(a=t.audioTracks.filter(E=>!E.audioCodec||this.isAudioSupported(E.audioCodec)),ju(a)),t.subtitles&&(c=t.subtitles,ju(c));const h=l.slice(0);l.sort((E,x)=>{if(E.attrs["HDCP-LEVEL"]!==x.attrs["HDCP-LEVEL"])return(E.attrs["HDCP-LEVEL"]||"")>(x.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&E.height!==x.height)return E.height-x.height;if(E.frameRate!==x.frameRate)return E.frameRate-x.frameRate;if(E.videoRange!==x.videoRange)return Fr.indexOf(E.videoRange)-Fr.indexOf(x.videoRange);if(E.videoCodec!==x.videoCodec){const T=Uc(E.videoCodec),A=Uc(x.videoCodec);if(T!==A)return A-T}if(E.uri===x.uri&&E.codecSet!==x.codecSet){const T=Dr(E.codecSet),A=Dr(x.codecSet);if(T!==A)return A-T}return E.averageBitrate!==x.averageBitrate?E.averageBitrate-x.averageBitrate:0});let f=h[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==h.length)){for(let E=0;E<h.length;E++)if(h[E].pathwayId===l[0].pathwayId){f=h[E];break}}this._levels=l;for(let E=0;E<l.length;E++)if(l[E]===f){var m;this._firstLevel=E;const x=f.bitrate,T=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${x}`),((m=this.hls.userConfig)==null?void 0:m.abrEwmaDefaultEstimate)===void 0){const A=Math.min(x,this.hls.config.abrEwmaDefaultEstimateMax);A>T&&T===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=A)}break}const p=r&&!n,g=this.hls.config,y=!!(g.audioStreamController&&g.audioTrackController),v={levels:l,audioTracks:a,subtitleTracks:c,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:n,altAudio:y&&!p&&a.some(E=>!!E.url)};u.end=performance.now(),this.hls.trigger(S.MANIFEST_PARSED,v)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const u=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:u,reason:u.message}),h)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,n=this.currentLevel,r=n?n.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&n&&r===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${r?" with Pathway "+r:""}`);const c={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(S.LEVEL_SWITCHING,c);const l=o.details;if(!l||l.live){const u=this.switchParams(o.uri,n?.details,l);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(n=>t.indexOf(n)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===Se.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===se.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const n=this._levels[t.level];n!=null&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var i;const{level:n,details:r}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${n}`),(a=t.deliveryDirectives)!=null&&a.skip&&(r.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let c=o.details;c===t.details&&c.advanced&&(c=void 0),this.playlistLoaded(n,t,c)}else(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),n=this.currentLevelIndex,r=e.attrs["PATHWAY-ID"],o=e.details,a=o?.age;this.log(`Loading level index ${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${r?" Pathway "+r:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(S.LEVEL_LOADING,{url:i,level:n,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const i=this._levels.filter((r,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(r),r===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,r.details&&r.details.fragments.forEach(a=>a.level=-1)),!1));a0(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const n=i.length-1;this._firstLevel=Math.min(this._firstLevel,n),this._startLevel&&(this._startLevel=Math.min(this._startLevel,n)),this.hls.trigger(S.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(S.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function ju(s){const e={};s.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function dm(){return self.SourceBuffer||self.WebKitSourceBuffer}function ic(){if(!mi())return!1;const e=dm();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function fm(){if(!ic())return!1;const s=mi();return typeof s?.isTypeSupported=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>s.isTypeSupported(ds(e,"video")))||["mp4a.40.2","fLaC"].some(e=>s.isTypeSupported(ds(e,"audio"))))}function x4(){var s;const e=dm();return typeof(e==null||(s=e.prototype)==null?void 0:s.changeType)=="function"}const E4=100;class A4 extends eo{constructor(e,t,i){super(e,t,i,"stream-controller",se.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const n=this.media,r=n?n.currentTime:null;if(r===null||!ie(r)||(this.log(`Media seeked to ${r.toFixed(3)}`),!this.getBufferedFrag(r)))return;const o=this.getFwdBufferInfoAtPos(n,r,se.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${r} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(S.MANIFEST_PARSED,this.onManifestParsed,this),e.on(S.LEVEL_LOADING,this.onLevelLoading,this),e.on(S.LEVEL_LOADED,this.onLevelLoaded,this),e.on(S.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(S.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(S.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(S.BUFFER_CREATED,this.onBufferCreated,this),e.on(S.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(S.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(S.MANIFEST_PARSED,this.onManifestParsed,this),e.off(S.LEVEL_LOADED,this.onLevelLoaded,this),e.off(S.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(S.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(S.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(S.BUFFER_CREATED,this.onBufferCreated,this),e.off(S.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(S.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(S.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:n}=this;if(this.stopLoad(),this.setInterval(E4),this.level=-1,!this.startFragRequested){let r=n.startLevel;r===-1&&(n.config.testBandwidth&&this.levels.length>1?(r=0,this.bitrateTest=!0):r=n.firstAutoLevel),n.nextLoadLevel=r,this.level=n.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=q.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=q.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case q.WAITING_LEVEL:{const{levels:e,level:t}=this,i=e?.[t],n=i?.details;if(n&&(!n.live||this.levelLastLoaded===i&&!this.waitForLive(i))){if(this.waitForCdnTuneIn(n))break;this.state=q.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=q.IDLE;break}break}case q.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break}this.state===q.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:n}=this;if(t===null||!n&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const r=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[r]))return;const o=i[r],a=this.getMainFwdBufferInfo();if(a===null)return;const c=this.getLevelDetails();if(c&&this._streamEnded(a,c)){const g={};this.altAudio===2&&(g.type="video"),this.hls.trigger(S.BUFFER_EOS,g),this.state=q.ENDED;return}if(!this.buffering)return;e.loadLevel!==r&&e.manualLevel===-1&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=e.nextLoadLevel=r;const l=o.details;if(!l||this.state===q.WAITING_LEVEL||this.waitForLive(o)){this.level=r,this.state=q.WAITING_LEVEL,this.startFragRequested=!1;return}const u=a.len,h=this.getMaxBufferLength(o.maxBitrate);if(u>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:a.end;let m=this.getNextFragment(f,l);if(this.couldBacktrack&&!this.fragPrevious&&m&&Ke(m)&&this.fragmentTracker.getState(m)!==et.OK){var p;const y=((p=this.backtrackFragment)!=null?p:m).sn-l.startSN,v=l.fragments[y-1];v&&m.cc===v.cc&&(m=v,this.fragmentTracker.removeFragment(v))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(m&&this.isLoopLoading(m,f)){if(!m.gap){const y=this.audioOnly&&!this.altAudio?Fe.AUDIO:Fe.VIDEO,v=(y===Fe.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;v&&this.afterBufferFlushed(v,y,se.MAIN)}m=this.getNextFragmentLoopLoading(m,l,a,se.MAIN,h)}m&&(m.initSegment&&!m.initSegment.data&&!this.bitrateTest&&(m=m.initSegment),this.loadFragment(m,o,f))}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);n===et.NOT_LOADED||n===et.PARTIAL?Ke(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,se.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const n=this.getAppendedFrag(t.currentTime);n&&n.start>1&&this.flushMainBuffer(0,n.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<r.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,c=e[a],l=this.fragLastKbps;l&&this.fragCurrent?i=this.fragCurrent.duration*c.maxBitrate/(1e3*l)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const c=a.maxStartPTS?a.maxStartPTS:a.start,l=a.duration,u=Math.max(o.end,c+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*(this.couldBacktrack?.5:.125)),l*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case q.KEY_LOADING:case q.FRAG_LOADING:case q.FRAG_LOADING_WAITING_RETRY:case q.PARSING:case q.PARSED:this.state=q.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;mt(i,"playing",this.onMediaPlaying),mt(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(Et(i,"playing",this.onMediaPlaying),Et(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(S.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,n=!1;for(let r=0;r<t.levels.length;r++){const o=t.levels[r].audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,n=n||o.indexOf("mp4a.40.5")!==-1)}this.audioCodecSwitch=i&&n&&!x4(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==q.IDLE)return;const n=t.levelInfo;(!n.details||n.details.live&&(this.levelLastLoaded!==n||n.details.expired)||this.waitForCdnTuneIn(n.details))&&(this.state=q.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:n,startFragRequested:r}=this,o=t.level,a=t.details,c=a.totalduration;if(!n){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${c}`);const l=t.levelInfo,u=this.fragCurrent;u&&(this.state===q.FRAG_LOADING||this.state===q.FRAG_LOADING_WAITING_RETRY)&&u.level!==t.level&&u.loader&&this.abortCurrentFrag();let h=0;if(a.live||(i=l.details)!=null&&i.live){var f;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,l.details,(f=this.levelLastLoaded)==null?void 0:f.details)}if(l.details=a,this.levelLastLoaded=l,r||this.setStartPosition(a,h),this.hls.trigger(S.LEVEL_UPDATED,{details:a,level:o}),this.state===q.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=q.IDLE}r&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const n=this.hls.liveSyncPosition,r=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,c=r>=o-t.maxFragLookUpTolerance&&r<=a;if(n!==null&&i.duration>n&&(r<n||!c)){const u=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!c&&i.readyState<4||r<a-u)&&(this._hasEnoughToStart||(this.nextLoadPosition=n),i.readyState))if(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${n.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var l;const h=pe.bufferInfo(i,n,0);if(!((l=h.buffered)!=null&&l.length)){i.currentTime=n;return}if(h.start<=r){i.currentTime=n;return}const{nextStart:m}=pe.bufferedInfo(h.buffered,r,0);m&&(i.currentTime=m)}else i.currentTime=n}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:r}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}const c=a.details;if(!c){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const l=a.videoCodec,u=c.PTSKnown||!c.live,h=(t=i.initSegment)==null?void 0:t.data,f=this._getAudioCodec(a),m=this.transmuxer=this.transmuxer||new _0(this.hls,se.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),p=n?n.index:-1,g=p!==-1,y=new Zr(i.level,i.sn,i.stats.chunkCount,r.byteLength,p,g),v=this.initPTS[i.cc];m.push(r,h,f,l,i,n,c.totalduration,u,y,v)}onAudioTrackSwitching(e,t){const i=this.hls,n=this.altAudio!==0;if(kr(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(n){this.altAudio=0,this.fragmentTracker.removeAllFragments(),i.once(S.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(S.AUDIO_TRACK_SWITCHED,t)}),i.trigger(S.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(S.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=kr(t.url,this.hls);if(i){const n=this.videoBuffer;n&&this.mediaBuffer!==n&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=n)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let n,r,o=!1;for(const a in i){const c=i[a];if(c.id==="main"){if(r=a,n=c,a==="video"){const l=i[a];l&&(this.videoBuffer=l.buffer)}}else o=!0}o&&n?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=n.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:n}=t,r=i.type===se.MAIN;if(r){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===q.PARSED&&(this.state=q.IDLE);return}const a=n?n.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),Ke(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,n)}const o=this.media;o&&(!this._hasEnoughToStart&&pe.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),r&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=q.ERROR;return}switch(t.details){case V.FRAG_GAP:case V.FRAG_PARSING_ERROR:case V.FRAG_DECRYPT_ERROR:case V.FRAG_LOAD_ERROR:case V.FRAG_LOAD_TIMEOUT:case V.KEY_LOAD_ERROR:case V.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(se.MAIN,t);break;case V.LEVEL_LOAD_ERROR:case V.LEVEL_LOAD_TIMEOUT:case V.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===q.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===Se.LEVEL&&(this.state=q.IDLE);break;case V.BUFFER_ADD_CODEC_ERROR:case V.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case V.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,Number.POSITIVE_INFINITY));break;case V.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=q.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==Fe.AUDIO||!this.altAudio){const i=(t===Fe.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,se.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const n=this.timelineOffset;n&&i&&(i+=n);const r=this.getLevelDetails(),o=pe.getBuffered(e),a=o.length?o.start(0):0,c=a-i,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||c>0&&(c<l||this.loadingParts&&c<2*(r?.partTarget||0)))&&(this.log(`adjusting start position by ${c} to match buffer start`),i+=c,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:n}=this,r=i?.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=q.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const o=r.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),n.trigger(S.FRAG_LOADED,i),r.bitrateTest=!1}).catch(i=>{this.state===q.STOPPED||this.state===q.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}_handleTransmuxComplete(e){const t=this.playlistType,{hls:i}=this,{remuxResult:n,chunkMeta:r}=e,o=this.getCurrentContext(r);if(!o){this.resetWhenMissingContext(r);return}const{frag:a,part:c,level:l}=o,{video:u,text:h,id3:f,initSegment:m}=n,{details:p}=l,g=this.altAudio?void 0:n.audio;if(this.fragContextChanged(a)){this.fragmentTracker.removeFragment(a);return}if(this.state=q.PARSING,m){const y=m.tracks;if(y){const T=a.initSegment||a;if(this.unhandledEncryptionError(m,a))return;this._bufferInitSegment(l,y,T,r),i.trigger(S.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:t,tracks:y})}const v=m.initPTS,E=m.timescale,x=this.initPTS[a.cc];if(ie(v)&&(!x||x.baseTime!==v||x.timescale!==E)){const T=m.trackId;this.initPTS[a.cc]={baseTime:v,timescale:E,trackId:T},i.trigger(S.INIT_PTS_FOUND,{frag:a,id:t,initPTS:v,timescale:E,trackId:T})}}if(u&&p){g&&u.type==="audiovideo"&&this.logMuxedErr(a);const y=p.fragments[a.sn-1-p.startSN],v=a.sn===p.startSN,E=!y||a.cc>y.cc;if(n.independent!==!1){const{startPTS:x,endPTS:T,startDTS:A,endDTS:C}=u;if(c)c.elementaryStreams[u.type]={startPTS:x,endPTS:T,startDTS:A,endDTS:C};else if(u.firstKeyFrame&&u.independent&&r.id===1&&!E&&(this.couldBacktrack=!0),u.dropped&&u.independent){const b=this.getMainFwdBufferInfo(),R=(b?b.end:this.getLoadPosition())+this.config.maxBufferHole,I=u.firstKeyFramePTS?u.firstKeyFramePTS:x;if(!v&&R<I-this.config.maxBufferHole&&!E){this.backtrack(a);return}else E&&(a.gap=!0);a.setElementaryStreamInfo(u.type,a.start,T,a.start,C,!0)}else v&&x-(p.appliedTimelineOffset||0)>Lr&&(a.gap=!0);a.setElementaryStreamInfo(u.type,x,T,A,C),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(u,a,c,r,v||E)}else if(v||E)a.gap=!0;else{this.backtrack(a);return}}if(g){const{startPTS:y,endPTS:v,startDTS:E,endDTS:x}=g;c&&(c.elementaryStreams[Fe.AUDIO]={startPTS:y,endPTS:v,startDTS:E,endDTS:x}),a.setElementaryStreamInfo(Fe.AUDIO,y,v,E,x),this.bufferFragmentData(g,a,c,r)}if(p&&f!=null&&f.samples.length){const y={id:t,frag:a,details:p,samples:f.samples};i.trigger(S.FRAG_PARSING_METADATA,y)}if(p&&h){const y={id:t,frag:a,details:p,samples:h.samples};i.trigger(S.FRAG_PARSING_USERDATA,y)}}logMuxedErr(e){this.warn(`${Ke(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,n){if(this.state!==q.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:r,video:o,audiovideo:a}=t;if(r){const l=e.audioCodec;let u=br(r.codec,l);u==="mp4a"&&(u="mp4a.40.5");const h=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){u&&(u.indexOf("mp4a.40.5")!==-1?u="mp4a.40.2":u="mp4a.40.5");const f=r.metadata;f&&"channelCount"in f&&(f.channelCount||1)!==1&&h.indexOf("firefox")===-1&&(u="mp4a.40.5")}u&&u.indexOf("mp4a.40.5")!==-1&&h.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(u="mp4a.40.2",this.log(`Android: force audio codec to ${u}`)),l&&l!==u&&this.log(`Swapping manifest audio codec "${l}" for "${u}"`),r.levelCodec=u,r.id=se.MAIN,this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${u||""}/${l||""}/${r.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=se.MAIN;const l=o.codec;if(l?.length===4)switch(l){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${l}]${o.codec!==l?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const c=Object.keys(t);if(c.length){if(this.hls.trigger(S.BUFFER_CODECS,t),!this.hls)return;c.forEach(l=>{const h=t[l].initSegment;h!=null&&h.byteLength&&this.hls.trigger(S.BUFFER_APPENDING,{type:l,data:h,frag:i,part:null,chunkMeta:n,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,se.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,i=e?.[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=q.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(pe.isBuffered(e,i)?t=this.getAppendedFrag(i):pe.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const n=this.fragPlaying,r=t.level;(!n||t.sn!==n.sn||n.level!==r)&&(this.fragPlaying=t,this.hls.trigger(S.FRAG_CHANGED,{frag:t}),(!n||n.level!==r)&&this.hls.trigger(S.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return ie(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(ie(t)){const i=this.getLevelDetails(),n=this.currentFrag||(i?Zi(null,i.fragments,t):null);if(n){const r=n.programDateTime;if(r!==null){const o=r+(t-n.start)*1e3;return new Date(o)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class S4 extends Bt{constructor(e,t){super("key-loader",t),this.config=void 0,this.keyIdToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyIdToKeyInfo){const n=this.keyIdToKeyInfo[i].loader;if(n){var t;if(e&&e!==((t=n.context)==null?void 0:t.frag.type))return;n.abort()}}}detach(){for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyIdToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e].loader;t&&t.destroy()}this.keyIdToKeyInfo={}}createKeyLoadError(e,t=V.KEY_LOAD_ERROR,i,n,r){return new ai({type:ae.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:n})}loadClear(e,t,i){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let n=0,r=t.length;n<r;n++){const o=t[n];if(e.cc<=o.cc&&(!Ke(e)||!Ke(o)||e.sn<o.sn)||!i&&n==r-1)return this.emeController.selectKeySystemFormat(o).then(a=>{if(!this.emeController)return;o.setKeyFormat(a);const c=Cr(a);if(c)return this.emeController.getKeySystemAccess([c])})}if(this.config.requireKeySystemAccessOnStart){const n=is(this.config);if(n.length)return this.emeController.getKeySystemAccess(n)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,n;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const l=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:`Missing decryption data on fragment in onKeyLoading (emeEnabled with controller: ${this.emeController&&this.config.emeEnabled})`);return Promise.reject(this.createKeyLoadError(e,V.KEY_LOAD_ERROR,l))}const o=r.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,V.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));const a=ta(r);let c=this.keyIdToKeyInfo[a];if((i=c)!=null&&i.decryptdata.key)return r.key=c.decryptdata.key,Promise.resolve({frag:e,keyInfo:c});if(this.emeController&&(n=c)!=null&&n.keyLoadPromise)switch(this.emeController.getKeyStatus(c.decryptdata)){case"usable":case"usable-in-future":return c.keyLoadPromise.then(u=>{const{keyInfo:h}=u;return r.key=h.decryptdata.key,{frag:e,keyInfo:h}})}switch(this.log(`${this.keyIdToKeyInfo[a]?"Rel":"L"}oading${r.keyId?" keyId: "+at(r.keyId):""} URI: ${r.uri} from ${e.type} ${e.level}`),c=this.keyIdToKeyInfo[a]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(c,e):this.loadKeyEME(c,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(c,e);default:return Promise.reject(this.createKeyLoadError(e,V.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var n;if(!e.decryptdata.keyId&&(n=t.initSegment)!=null&&n.data){const o=iy(t.initSegment.data);if(o.length){let a=o[0];a.some(c=>c!==0)?(this.log(`Using keyId found in init segment ${at(a)}`),di.setKeyIdForUri(e.decryptdata.uri,a)):(a=di.addKeyIdForUri(e.decryptdata.uri),this.log(`Generating keyId to patch media ${at(a)}`)),e.decryptdata.keyId=a}}if(!e.decryptdata.keyId&&!Ke(t))return Promise.resolve(i);const r=this.emeController.loadKey(i);return(e.keyLoadPromise=r.then(o=>(e.mediaKeySessionContext=o,i))).catch(o=>{throw e.keyLoadPromise=null,"data"in o&&(o.data.frag=t),o})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,n=i.loader,r=new n(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((o,a)=>{const c={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},l=i.keyLoadPolicy.default,u={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,m,p,g)=>{const{frag:y,keyInfo:v}=p,E=ta(v.decryptdata);if(!y.decryptdata||v!==this.keyIdToKeyInfo[E])return a(this.createKeyLoadError(y,V.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),g));v.decryptdata.key=y.decryptdata.key=new Uint8Array(f.data),y.keyLoader=null,v.loader=null,o({frag:y,keyInfo:v})},onError:(f,m,p,g)=>{this.resetLoader(m),a(this.createKeyLoadError(t,V.KEY_LOAD_ERROR,new Error(`HTTP Error ${f.code} loading key ${f.text}`),p,Le({url:c.url,data:void 0},f)))},onTimeout:(f,m,p)=>{this.resetLoader(m),a(this.createKeyLoadError(t,V.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),p))},onAbort:(f,m,p)=>{this.resetLoader(m),a(this.createKeyLoadError(t,V.INTERNAL_ABORTED,new Error("key loading aborted"),p))}};r.load(c,u,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:n}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null);const o=ta(i.decryptdata)||n;delete this.keyIdToKeyInfo[o],r&&r.destroy()}}function ta(s){if(s.keyFormat!==nt.FAIRPLAY){const e=s.keyId;if(e)return at(e)}return s.uri}function Wu(s){const{type:e}=s;switch(e){case Se.AUDIO_TRACK:return se.AUDIO;case Se.SUBTITLE_TRACK:return se.SUBTITLE;default:return se.MAIN}}function ia(s,e){let t=s.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class T4{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(S.MANIFEST_LOADING,this.onManifestLoading,this),e.on(S.LEVEL_LOADING,this.onLevelLoading,this),e.on(S.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(S.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(S.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(S.MANIFEST_LOADING,this.onManifestLoading,this),e.off(S.LEVEL_LOADING,this.onLevelLoading,this),e.off(S.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(S.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(S.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,n=t.loader,r=i||n,o=new r(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Se.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:n,pathwayId:r,url:o,deliveryDirectives:a,levelInfo:c}=t;this.load({id:i,level:n,pathwayId:r,responseType:"text",type:Se.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:c})}onAudioTrackLoading(e,t){const{id:i,groupId:n,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:Se.AUDIO_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:n,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:Se.SUBTITLE_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[Se.LEVEL];if(i){const n=i.context;n&&!t.levels.some(r=>r===n.levelOrTrack)&&(i.abort(),delete this.loaders[Se.LEVEL])}}load(e){var t;const i=this.hls.config;let n=this.getInternalLoader(e);if(n){const l=this.hls.logger,u=n.context;if(u&&u.levelOrTrack===e.levelOrTrack&&(u.url===e.url||u.deliveryDirectives&&!e.deliveryDirectives)){u.url===e.url?l.log(`[playlist-loader]: ignore ${e.url} ongoing request`):l.log(`[playlist-loader]: ignore ${e.url} in favor of ${u.url}`);return}l.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),n.abort()}let r;if(e.type===Se.MANIFEST?r=i.manifestLoadPolicy.default:r=De({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),ie((t=e.deliveryDirectives)==null?void 0:t.part)){let l;if(e.type===Se.LEVEL&&e.level!==null?l=this.hls.levels[e.level].details:e.type===Se.AUDIO_TRACK&&e.id!==null?l=this.hls.audioTracks[e.id].details:e.type===Se.SUBTITLE_TRACK&&e.id!==null&&(l=this.hls.subtitleTracks[e.id].details),l){const u=l.partTarget,h=l.targetduration;if(u&&h){const f=Math.max(u*3,h*.8)*1e3;r=De({},r,{maxTimeToFirstByteMs:Math.min(f,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(f,r.maxTimeToFirstByteMs)})}}}const o=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(l,u,h,f)=>{const m=this.getInternalLoader(h);this.resetInternalLoader(h.type);const p=l.data;u.parsing.start=performance.now(),zt.isMediaPlaylist(p)||h.type!==Se.MANIFEST?this.handleTrackOrLevelPlaylist(l,u,h,f||null,m):this.handleMasterPlaylist(l,u,h,f)},onError:(l,u,h,f)=>{this.handleNetworkError(u,h,!1,l,f)},onTimeout:(l,u,h)=>{this.handleNetworkError(u,h,!0,void 0,l)}};n.load(e,a,c)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,n){const r=this.hls,o=e.data,a=ia(e,i),c=zt.parseMasterPlaylist(o,a);if(c.playlistParsingError){t.parsing.end=performance.now(),this.handleManifestParsingError(e,i,c.playlistParsingError,n,t);return}const{contentSteering:l,levels:u,sessionData:h,sessionKeys:f,startTimeOffset:m,variableList:p}=c;this.variableList=p,u.forEach(E=>{const{unknownCodecs:x}=E;if(x){const{preferManagedMediaSource:T}=this.hls.config;let{audioCodec:A,videoCodec:C}=E;for(let b=x.length;b--;){const R=x[b];hs(R,"audio",T)?(E.audioCodec=A=A?`${A},${R}`:R,Dn.audio[A.substring(0,4)]=2,x.splice(b,1)):hs(R,"video",T)&&(E.videoCodec=C=C?`${C},${R}`:R,Dn.video[C.substring(0,4)]=2,x.splice(b,1))}}});const{AUDIO:g=[],SUBTITLES:y,"CLOSED-CAPTIONS":v}=zt.parseMasterPlaylistMedia(o,a,c);g.length&&!g.some(x=>!x.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),g.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Ue({}),bitrate:0,url:""})),r.trigger(S.MANIFEST_LOADED,{levels:u,audioTracks:g,subtitles:y,captions:v,contentSteering:l,url:a,stats:t,networkDetails:n,sessionData:h,sessionKeys:f,startTimeOffset:m,variableList:p})}handleTrackOrLevelPlaylist(e,t,i,n,r){const o=this.hls,{id:a,level:c,type:l}=i,u=ia(e,i),h=ie(c)?c:ie(a)?a:0,f=Wu(i),m=zt.parseLevelPlaylist(e.data,u,h,f,0,this.variableList);if(l===Se.MANIFEST){const p={attrs:new Ue({}),bitrate:0,details:m,name:"",url:u};m.requestScheduled=t.loading.start+s0(m,0),o.trigger(S.MANIFEST_LOADED,{levels:[p],audioTracks:[],url:u,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=m,this.handlePlaylistLoaded(m,e,t,i,n,r)}handleManifestParsingError(e,t,i,n,r){this.hls.trigger(S.ERROR,{type:ae.NETWORK_ERROR,details:V.MANIFEST_PARSING_ERROR,fatal:t.type===Se.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:n,stats:r})}handleNetworkError(e,t,i=!1,n,r){let o=`A network ${i?"timeout":"error"+(n?" (status "+n.code+")":"")} occurred while loading ${e.type}`;e.type===Se.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===Se.AUDIO_TRACK||e.type===Se.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let c=V.UNKNOWN,l=!1;const u=this.getInternalLoader(e);switch(e.type){case Se.MANIFEST:c=i?V.MANIFEST_LOAD_TIMEOUT:V.MANIFEST_LOAD_ERROR,l=!0;break;case Se.LEVEL:c=i?V.LEVEL_LOAD_TIMEOUT:V.LEVEL_LOAD_ERROR,l=!1;break;case Se.AUDIO_TRACK:c=i?V.AUDIO_TRACK_LOAD_TIMEOUT:V.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case Se.SUBTITLE_TRACK:c=i?V.SUBTITLE_TRACK_LOAD_TIMEOUT:V.SUBTITLE_LOAD_ERROR,l=!1;break}u&&this.resetInternalLoader(e.type);const h={type:ae.NETWORK_ERROR,details:c,fatal:l,url:e.url,loader:u,context:e,error:a,networkDetails:t,stats:r};if(n){const f=t?.url||e.url;h.response=Le({url:f,data:void 0},n)}this.hls.trigger(S.ERROR,h)}handlePlaylistLoaded(e,t,i,n,r,o){const a=this.hls,{type:c,level:l,levelOrTrack:u,id:h,groupId:f,deliveryDirectives:m}=n,p=ia(t,n),g=Wu(n);let y=typeof n.level=="number"&&g===se.MAIN?l:void 0;const v=e.playlistParsingError;if(v){if(this.hls.logger.warn(`${v} ${e.url}`),!a.config.ignorePlaylistParsingErrors){a.trigger(S.ERROR,{type:ae.NETWORK_ERROR,details:V.LEVEL_PARSING_ERROR,fatal:!1,url:p,error:v,reason:v.message,response:t,context:n,level:y,parent:g,networkDetails:r,stats:i});return}e.playlistParsingError=null}if(!e.fragments.length){const E=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(S.ERROR,{type:ae.NETWORK_ERROR,details:V.LEVEL_EMPTY_ERROR,fatal:!1,url:p,error:E,reason:E.message,response:t,context:n,level:y,parent:g,networkDetails:r,stats:i});return}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),c){case Se.MANIFEST:case Se.LEVEL:if(y){if(!u)y=0;else if(u!==a.levels[y]){const E=a.levels.indexOf(u);E>-1&&(y=E)}}a.trigger(S.LEVEL_LOADED,{details:e,levelInfo:u||a.levels[0],level:y||0,id:h||0,stats:i,networkDetails:r,deliveryDirectives:m,withoutMultiVariant:c===Se.MANIFEST});break;case Se.AUDIO_TRACK:a.trigger(S.AUDIO_TRACK_LOADED,{details:e,track:u,id:h||0,groupId:f||"",stats:i,networkDetails:r,deliveryDirectives:m});break;case Se.SUBTITLE_TRACK:a.trigger(S.SUBTITLE_TRACK_LOADED,{details:e,track:u,id:h||0,groupId:f||"",stats:i,networkDetails:r,deliveryDirectives:m});break}}}class ci{static get version(){return fs}static isMSESupported(){return ic()}static isSupported(){return fm()}static getMediaSource(){return mi()}static get Events(){return S}static get MetadataSchema(){return xt}static get ErrorTypes(){return ae}static get ErrorDetails(){return V}static get DefaultConfig(){return ci.defaultConfig?ci.defaultConfig:a4}static set DefaultConfig(e){ci.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Kl,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=V2(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=c4(ci.DefaultConfig,e,t);this.userConfig=e,i.progressive&&u4(i,t);const{abrController:n,bufferController:r,capLevelController:o,errorController:a,fpsController:c}=i,l=new a(this),u=this.abrController=new n(this),h=new Oy(this),f=i.interstitialsController,m=f?this.interstitialsController=new f(this,ci):null,p=this.bufferController=new r(this,h),g=this.capLevelController=new o(this),y=new c(this),v=new T4(this),E=i.contentSteeringController,x=E?new E(this):null,T=this.levelController=new v4(this,x),A=new g4(this),C=new S4(this.config,this.logger),b=this.streamController=new A4(this,h,C),R=this.gapController=new m4(this,h);g.setStreamController(b),y.setStreamController(b);const I=[v,T,b];m&&I.splice(1,0,m),x&&I.splice(1,0,x),this.networkControllers=I;const w=[u,p,R,g,y,A,h];this.audioTrackController=this.createController(i.audioTrackController,I);const M=i.audioStreamController;M&&I.push(this.audioStreamController=new M(this,h,C)),this.subtitleTrackController=this.createController(i.subtitleTrackController,I);const P=i.subtitleStreamController;P&&I.push(this.subtititleStreamController=new P(this,h,C)),this.createController(i.timelineController,w),C.emeController=this.emeController=this.createController(i.emeController,w),this.cmcdController=this.createController(i.cmcdController,w),this.latencyController=this.createController(y4,w),this.coreComponents=w,I.push(l);const O=l.onErrorOut;typeof O=="function"&&this.on(S.ERROR,O,l),this.on(S.MANIFEST_LOADED,v.onManifestLoaded,v)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,n){this._emitter.off(e,t,i,n)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const n=e===S.ERROR;this.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.INTERNAL_EXCEPTION,fatal:n,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(S.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const r=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(S.ERROR,{type:ae.OTHER_ERROR,details:V.ATTACH_MEDIA_ERROR,fatal:!0,error:r});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,n=t?e:{media:i};this._media=i,this.trigger(S.MEDIA_ATTACHING,n)}detachMedia(){this.logger.log("detachMedia"),this.trigger(S.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(S.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,n=this._url=Dl.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${n}`),t&&i&&(i!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(S.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),!(!this.started||!this.networkControllers));i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[se.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[se.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[se.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e?.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=vx()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){Ty(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let n=0;n<i;n++)if(e[n].maxBitrate>=t)return n;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let n;if(t===-1&&e!=null&&e.length?n=e.length-1:n=t,i)for(let r=n;r--;){const o=e[r].attrs["HDCP-LEVEL"];if(o&&o<=i)return r}return n}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const i=$f(t);return zf(e,i,navigator.mediaCapabilities)}}ci.defaultConfig=void 0;const b4=Object.freeze(Object.defineProperty({__proto__:null,AbrController:Hf,AttrList:Ue,AudioStreamController:L0,AudioTrackController:M0,BasePlaylistController:io,BaseSegment:Bl,BaseStreamController:eo,BufferController:B0,CMCDController:V0,CapLevelController:no,ChunkMetadata:Zr,ContentSteeringController:j0,Cues:um,DateRange:zl,EMEController:Xi,ErrorActionFlags:vt,ErrorController:Xf,ErrorDetails:V,ErrorTypes:ae,Events:S,FPSController:X0,FetchLoader:al,Fragment:Tr,Hls:ci,HlsSkip:rs,HlsUrlParameters:Wa,KeySystemFormats:nt,KeySystems:ze,Level:Bn,LevelDetails:Jf,LevelKey:di,LoadStats:Jr,M3U8Parser:zt,MetadataSchema:xt,NetworkErrorAction:qe,Part:If,PlaylistLevelType:se,SubtitleStreamController:Z0,SubtitleTrackController:J0,TimelineController:lm,XhrLoader:tc,default:ci,fetchSupported:hm,getMediaSource:mi,isMSESupported:ic,isSupported:fm,requestMediaKeySystemAccess:Hl},Symbol.toStringTag,{value:"Module"}));var Pr={exports:{}},C4=Pr.exports,Xu;function R4(){return Xu||(Xu=1,(function(s,e){(function(t,i){s.exports=i()})(C4,function(){var t=function(){function i(m){return o.appendChild(m.dom),m}function n(m){for(var p=0;p<o.children.length;p++)o.children[p].style.display=p===m?"block":"none";r=m}var r=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(m){m.preventDefault(),n(++r%o.children.length)},!1);var a=(performance||Date).now(),c=a,l=0,u=i(new t.Panel("FPS","#0ff","#002")),h=i(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new t.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:o,addPanel:i,showPanel:n,begin:function(){a=(performance||Date).now()},end:function(){l++;var m=(performance||Date).now();if(h.update(m-a,200),m>c+1e3&&(u.update(1e3*l/(m-c),100),c=m,l=0,f)){var p=performance.memory;f.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return m},update:function(){a=this.end()},domElement:o,setMode:n}};return t.Panel=function(i,n,r){var o=1/0,a=0,c=Math.round,l=c(window.devicePixelRatio||1),u=80*l,h=48*l,f=3*l,m=2*l,p=3*l,g=15*l,y=74*l,v=30*l,E=document.createElement("canvas");E.width=u,E.height=h,E.style.cssText="width:80px;height:48px";var x=E.getContext("2d");return x.font="bold "+9*l+"px Helvetica,Arial,sans-serif",x.textBaseline="top",x.fillStyle=r,x.fillRect(0,0,u,h),x.fillStyle=n,x.fillText(i,f,m),x.fillRect(p,g,y,v),x.fillStyle=r,x.globalAlpha=.9,x.fillRect(p,g,y,v),{dom:E,update:function(T,A){o=Math.min(o,T),a=Math.max(a,T),x.fillStyle=r,x.globalAlpha=1,x.fillRect(0,0,u,g),x.fillStyle=n,x.fillText(c(T)+" "+i+" ("+c(o)+"-"+c(a)+")",f,m),x.drawImage(E,p+l,g,y-l,v,p,g,y-l,v),x.fillRect(p+y-l,g,l,v),x.fillStyle=r,x.globalAlpha=.9,x.fillRect(p+y-l,g,l,c((1-T/A)*v))}}},t})})(Pr)),Pr.exports}var w4=R4();const I4=$g(w4);class _4{constructor(e,t,i){this.name=e,this.fg=t,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg;break}return e.addColorStop(0,t),e.addColorStop(1,i),e}initializeCanvas(){this.context&&(this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.fg,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,i,n,r=0){if(!this.context||!this.gradient)return;const o=Math.min(1/0,e),a=Math.max(i,e);n=Math.max(n,t),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${e.toFixed(r)} ${this.name} (${o.toFixed(r)}-${parseFloat(a.toFixed(r))})`,this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT);const c=this.GRAPH_HEIGHT-(1-t/n)*this.GRAPH_HEIGHT;c>0&&(this.context.globalAlpha=1,this.context.fillStyle=this.gradient,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y+this.GRAPH_HEIGHT-c,this.PR,c))}}const mm=class Sn{constructor({trackGPU:e=!1,logsPerSecond:t=30,samplesLog:i=60,samplesGraph:n=10,precision:r=2,minimal:o=!1,horizontal:a=!0,mode:c=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frames=0,this.renderCount=0,this.isRunningCPUProfiling=!1,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.totalFps=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.handleClick=l=>{l.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel,0),this.resizePanel(this.msPanel,1),this.gpuPanel&&this.resizePanel(this.gpuPanel,2),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute,3)},this.mode=c,this.horizontal=a,this.minimal=o,this.trackGPU=e,this.samplesLog=i,this.samplesGraph=n,this.precision=r,this.logsPerSecond=t,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTime=this.beginTime,this.prevCpuTime=this.beginTime,this.fpsPanel=this.addPanel(new Sn.Panel("FPS","#0ff","#002"),0),this.msPanel=this.addPanel(new Sn.Panel("CPU","#0f0","#020"),1),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(e){if(!e){console.error('Stats: The "canvas" parameter is undefined.');return}this.handleThreeRenderer(e)||await this.handleWebGPURenderer(e)||this.initializeWebGL(e)}handleThreeRenderer(e){return e.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(e){return e.isWebGPURenderer?(this.trackGPU&&(e.backend.trackTimestamp=!0,await e.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=e.info,!0):!1}initializeWebGPUPanels(){this.gpuPanel=this.addPanel(new Sn.Panel("GPU","#ff0","#220"),2),this.gpuPanelCompute=this.addPanel(new Sn.Panel("CPT","#e1e1e1","#212121"),3)}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else if(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas){if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new Sn.Panel("GPU","#ff0","#220"),2)))}begin(){this.isRunningCPUProfiling||this.beginProfiling("cpu-started"),!(!this.gl||!this.ext)&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null)}update(){this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp,this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu)}resetCounters(){this.renderCount=0,this.totalCpuDuration===0&&this.beginProfiling("cpu-started"),this.totalCpuDuration=0,this.totalFps=0,this.beginTime=this.endInternal()}resizePanel(e,t){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=t*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=t*e.HEIGHT/e.PR+"px"))}addPanel(e,t){return e.canvas&&(this.dom.appendChild(e.canvas),this.resizePanel(e,t)),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){const i=this.dom.children[t];i.style.display=t===e?"block":"none"}this.mode=e}processGpuQueries(){!this.gl||!this.ext||(this.totalGpuDuration=0,this.gpuQueries.forEach((e,t)=>{if(this.gl){const i=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT_AVAILABLE),n=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!n){const o=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=o,this.gl.deleteQuery(e.query),this.gpuQueries.splice(t,1)}}}))}endInternal(){this.frames++;const e=(performance||Date).now(),t=e-this.prevTime;if(e>=this.prevCpuTime+1e3/this.logsPerSecond){const i=Math.round(this.frames*1e3/t);this.addToAverage(i,this.averageFps),this.updatePanel(this.fpsPanel,this.averageFps,0),this.updatePanel(this.msPanel,this.averageCpu,this.precision),this.updatePanel(this.gpuPanel,this.averageGpu,this.precision),this.gpuPanelCompute&&this.updatePanel(this.gpuPanelCompute,this.averageGpuCompute),this.frames=0,this.prevCpuTime=e,this.prevTime=e}return e}addToAverage(e,t){t.logs.push(e),t.logs.length>this.samplesLog&&t.logs.shift(),t.graph.push(e),t.graph.length>this.samplesGraph&&t.graph.shift()}beginProfiling(e){window.performance&&(window.performance.mark(e),this.isRunningCPUProfiling=!0)}endProfiling(e,t,i){if(window.performance&&t&&this.isRunningCPUProfiling){window.performance.mark(t);const n=performance.measure(i,e,t);this.totalCpuDuration+=n.duration,this.isRunningCPUProfiling=!1}}updatePanel(e,t,i=2){if(t.logs.length>0){let n=0,r=.01;for(let c=0;c<t.logs.length;c++)n+=t.logs[c],t.logs[c]>r&&(r=t.logs[c]);let o=0,a=.01;for(let c=0;c<t.graph.length;c++)o+=t.graph[c],t.graph[c]>a&&(a=t.graph[c]);e&&e.update(n/Math.min(t.logs.length,this.samplesLog),o/Math.min(t.graph.length,this.samplesGraph),r,a,i)}}get domElement(){return this.dom}patchThreeRenderer(e){const t=e.render,i=this;e.render=function(n,r){i.begin(),t.call(this,n,r),i.end()},this.threeRendererPatched=!0}};mm.Panel=_4;let L4=mm;function na(s,e,t,i){return new(t||(t=Promise))((function(n,r){function o(l){try{c(i.next(l))}catch(u){r(u)}}function a(l){try{c(i.throw(l))}catch(u){r(u)}}function c(l){var u;l.done?n(l.value):(u=l.value,u instanceof t?u:new t((function(h){h(u)}))).then(o,a)}c((i=i.apply(s,[])).next())}))}const P4=["geforce 320m","geforce 8600","geforce 8600m gt","geforce 8800 gs","geforce 8800 gt","geforce 9400","geforce 9400m g","geforce 9400m","geforce 9600m gt","geforce 9600m","geforce fx go5200","geforce gt 120","geforce gt 130","geforce gt 330m","geforce gtx 285","google swiftshader","intel g41","intel g45","intel gma 4500mhd","intel gma x3100","intel hd 3000","intel q45","legacy","mali-2","mali-3","mali-4","quadro fx 1500","quadro fx 4","quadro fx 5","radeon hd 2400","radeon hd 2600","radeon hd 4670","radeon hd 4850","radeon hd 4870","radeon hd 5670","radeon hd 5750","radeon hd 6290","radeon hd 6300","radeon hd 6310","radeon hd 6320","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 6770m","radeon hd 6970m","sgx 543","sgx543"];function Yu(s){return s=s.toLowerCase().replace(/.*angle ?\((.+)\)(?: on vulkan [0-9.]+)?$/i,"$1").replace(/\s(\d{1,2}gb|direct3d.+$)|\(r\)| \([^)]+\)$/g,"").replace(/(?:vulkan|opengl) \d+\.\d+(?:\.\d+)?(?: \((.*)\))?/,"$1")}const pm=typeof window>"u",Yt=(()=>{if(pm)return;const{userAgent:s,platform:e,maxTouchPoints:t}=window.navigator,i=/(iphone|ipod|ipad)/i.test(s),n=e==="iPad"||e==="MacIntel"&&t>0&&!window.MSStream;return{isIpad:n,isMobile:/android/i.test(s)||i||n,isSafari12:/Version\/12.+Safari/.test(s),isFirefox:/Firefox/.test(s)}})();function M4(s,e,t){if(!t)return[e];const i=(function(l){const u=`
    precision highp float;
    attribute vec3 aPosition;
    varying float vvv;
    void main() {
      vvv = 0.31622776601683794;
      gl_Position = vec4(aPosition, 1.0);
    }
  `,h=`
    precision highp float;
    varying float vvv;
    void main() {
      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vvv;
      enc = fract(enc);
      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
      gl_FragColor = enc;
    }
  `,f=l.createShader(35633),m=l.createShader(35632),p=l.createProgram();if(!(m&&f&&p))return;l.shaderSource(f,u),l.shaderSource(m,h),l.compileShader(f),l.compileShader(m),l.attachShader(p,f),l.attachShader(p,m),l.linkProgram(p),l.detachShader(p,f),l.detachShader(p,m),l.deleteShader(f),l.deleteShader(m),l.useProgram(p);const g=l.createBuffer();l.bindBuffer(34962,g),l.bufferData(34962,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),35044);const y=l.getAttribLocation(p,"aPosition");l.vertexAttribPointer(y,3,5126,!1,0,0),l.enableVertexAttribArray(y),l.clearColor(1,1,1,1),l.clear(16384),l.viewport(0,0,1,1),l.drawArrays(4,0,3);const v=new Uint8Array(4);return l.readPixels(0,0,1,1,6408,5121,v),l.deleteProgram(p),l.deleteBuffer(g),v.join("")})(s),n="801621810",r="8016218135",o="80162181161",a=Yt?.isIpad?[["a7",o,12],["a8",r,15],["a8x",r,15],["a9",r,15],["a9x",r,15],["a10",r,15],["a10x",r,15],["a12",n,15],["a12x",n,15],["a12z",n,15],["a14",n,15],["a15",n,15],["m1",n,15],["m2",n,15]]:[["a7",o,12],["a8",r,12],["a9",r,15],["a10",r,15],["a11",n,15],["a12",n,15],["a13",n,15],["a14",n,15],["a15",n,15],["a16",n,15],["a17",n,15]];let c;return i==="80162181255"?c=a.filter((([,,l])=>l>=14)):(c=a.filter((([,l])=>l===i)),c.length||(c=a)),c.map((([l])=>`apple ${l} gpu`))}let Qu=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}};const sa=[],Ju=[];function D4(s,e){if(s===e)return 0;const t=s;s.length>e.length&&(s=e,e=t);let i=s.length,n=e.length;for(;i>0&&s.charCodeAt(~-i)===e.charCodeAt(~-n);)i--,n--;let r,o=0;for(;o<i&&s.charCodeAt(o)===e.charCodeAt(o);)o++;if(i-=o,n-=o,i===0)return n;let a,c,l=0,u=0,h=0;for(;u<i;)Ju[u]=s.charCodeAt(o+u),sa[u]=++u;for(;h<n;)for(r=e.charCodeAt(o+h),a=h++,l=h,u=0;u<i;u++)c=r===Ju[u]?a:a+1,a=sa[u],l=sa[u]=a>l?c>l?l+1:c:c>a?a+1:c;return l}function B4(s){return s!=null}const F4=({mobileTiers:s=[0,15,30,60],desktopTiers:e=[0,15,30,60],override:t={},glContext:i,failIfMajorPerformanceCaveat:n=!1,benchmarksURL:r="https://unpkg.com/detect-gpu@5.0.70/dist/benchmarks"}={})=>na(void 0,void 0,void 0,(function*(){const o={};if(pm)return{tier:0,type:"SSR"};const{isIpad:a=!!Yt?.isIpad,isMobile:c=!!Yt?.isMobile,screenSize:l=window.screen,loadBenchmarks:u=(A=>na(void 0,void 0,void 0,(function*(){const C=yield fetch(`${r}/${A}`).then((b=>b.json()));if(parseInt(C.shift().split(".")[0],10)<4)throw new Qu("Detect GPU benchmark data is out of date. Please update to version 4x");return C})))}=t;let{renderer:h}=t;const f=(A,C,b,R,I)=>({device:I,fps:R,gpu:b,isMobile:c,tier:A,type:C});let m,p="";if(h)h=Yu(h),m=[h];else{const A=i||(function(b,R=!1){const I={alpha:!1,antialias:!1,depth:!1,failIfMajorPerformanceCaveat:R,powerPreference:"high-performance",stencil:!1};b&&delete I.powerPreference;const w=window.document.createElement("canvas"),M=w.getContext("webgl",I)||w.getContext("experimental-webgl",I);return M??void 0})(Yt?.isSafari12,n);if(!A)return f(0,"WEBGL_UNSUPPORTED");const C=Yt?.isFirefox?null:A.getExtension("WEBGL_debug_renderer_info");if(h=C?A.getParameter(C.UNMASKED_RENDERER_WEBGL):A.getParameter(A.RENDERER),!h)return f(1,"FALLBACK");p=h,h=Yu(h),m=(function(b,R,I){return R==="apple gpu"?M4(b,R,I):[R]})(A,h,c)}const g=(yield Promise.all(m.map((function(A){var C;return na(this,void 0,void 0,(function*(){const b=(j=>{const L=c?["adreno","apple","mali-t","mali","nvidia","powervr","samsung"]:["intel","apple","amd","radeon","nvidia","geforce","adreno"];for(const X of L)if(j.includes(X))return X})(A);if(!b)return;const R=`${c?"m":"d"}-${b}${a?"-ipad":""}.json`,I=o[R]=(C=o[R])!==null&&C!==void 0?C:u(R);let w;try{w=yield I}catch(j){if(j instanceof Qu)throw j;return}const M=(function(j){var L;const X=(j=j.replace(/\([^)]+\)/,"")).match(/\d+/)||j.match(/(\W|^)([A-Za-z]{1,3})(\W|$)/g);return(L=X?.join("").replace(/\W|amd/g,""))!==null&&L!==void 0?L:""})(A);let P=w.filter((([,j])=>j===M));P.length||(P=w.filter((([j])=>j.includes(A))));const O=P.length;if(O===0)return;const z=A.split(/[.,()\[\]/\s]/g).sort().filter(((j,L,X)=>L===0||j!==X[L-1])).join(" ");let D,[F,,,,k]=O>1?P.map((j=>[j,D4(z,j[2])])).sort((([,j],[,L])=>j-L))[0][0]:P[0],$=Number.MAX_VALUE;const{devicePixelRatio:U}=window,N=l.width*U*l.height*U;for(const j of k){const[L,X]=j,Q=L*X,ne=Math.abs(N-Q);ne<$&&($=ne,D=j)}if(!D)return;const[,,B,G]=D;return[$,B,F,G]}))})))).filter(B4).sort((([A=Number.MAX_VALUE,C],[b=Number.MAX_VALUE,R])=>A===b?C-R:A-b));if(!g.length){const A=P4.find((C=>h.includes(C)));return A?f(0,"BLOCKLISTED",A):f(1,"FALLBACK",`${h} (${p})`)}const[,y,v,E]=g[0];if(y===-1)return f(0,"BLOCKLISTED",v,y,E);const x=c?s:e;let T=0;for(let A=0;A<x.length;A++)y>=x[A]&&(T=A);return f(T,"BENCHMARK",v,y,E)})),xs=new _,nc=new _,k4=new _,qu=new de;function O4(s,e,t){const i=xs.setFromMatrixPosition(s.matrixWorld);i.project(e);const n=t.width/2,r=t.height/2;return[i.x*n+n,-(i.y*r)+r]}function N4(s,e){const t=xs.setFromMatrixPosition(s.matrixWorld),i=nc.setFromMatrixPosition(e.matrixWorld),n=t.sub(i),r=e.getWorldDirection(k4);return n.angleTo(r)>Math.PI/2}function U4(s,e,t,i){const n=xs.setFromMatrixPosition(s.matrixWorld),r=n.clone();r.project(e),qu.set(r.x,r.y),t.setFromCamera(qu,e);const o=t.intersectObjects(i,!0);if(o.length){const a=o[0].distance;return n.distanceTo(t.ray.origin)<a}return!0}function z4(s,e){if(e instanceof rt)return e.zoom;if(e instanceof He){const t=xs.setFromMatrixPosition(s.matrixWorld),i=nc.setFromMatrixPosition(e.matrixWorld),n=e.fov*Math.PI/180,r=t.distanceTo(i);return 1/(2*Math.tan(n/2)*r)}else return 1}function G4(s,e,t){if(e instanceof He||e instanceof rt){const i=xs.setFromMatrixPosition(s.matrixWorld),n=nc.setFromMatrixPosition(e.matrixWorld),r=i.distanceTo(n),o=(t[1]-t[0])/(e.far-e.near),a=t[1]-o*e.far;return Math.round(o*r+a)}}const ul=s=>Math.abs(s)<1e-10?0:s;function gm(s,e,t=""){let i="matrix3d(";for(let n=0;n!==16;n++)i+=ul(e[n]*s.elements[n])+(n!==15?",":")");return t+i}const $4=(s=>e=>gm(e,s))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),H4=(s=>(e,t)=>gm(e,s(t),"translate(-50%,-50%)"))(s=>[1/s,1/s,1/s,1,-1/s,-1/s,-1/s,-1,1/s,1/s,1/s,1,1,1,1,1]);function K4(s){return s&&typeof s=="object"&&"current"in s}const Es=d.forwardRef(({children:s,eps:e=.001,style:t,className:i,prepend:n,center:r,fullscreen:o,portal:a,distanceFactor:c,sprite:l=!1,transform:u=!1,occlude:h,onOcclude:f,castShadow:m,receiveShadow:p,material:g,geometry:y,zIndexRange:v=[16777271,0],calculatePosition:E=O4,as:x="div",wrapperClass:T,pointerEvents:A="auto",...C},b)=>{const{gl:R,camera:I,scene:w,size:M,raycaster:P,events:O,viewport:z}=H(),[D]=d.useState(()=>document.createElement(x)),F=d.useRef(null),k=d.useRef(null),$=d.useRef(0),U=d.useRef([0,0]),N=d.useRef(null),B=d.useRef(null),G=a?.current||O.connected||R.domElement.parentNode,j=d.useRef(null),L=d.useRef(!1),X=d.useMemo(()=>h&&h!=="blending"||Array.isArray(h)&&h.length&&K4(h[0]),[h]);d.useLayoutEffect(()=>{const ce=R.domElement;h&&h==="blending"?(ce.style.zIndex=`${Math.floor(v[0]/2)}`,ce.style.position="absolute",ce.style.pointerEvents="none"):(ce.style.zIndex=null,ce.style.position=null,ce.style.pointerEvents=null)},[h]),d.useLayoutEffect(()=>{if(k.current){const ce=F.current=xl.createRoot(D);if(w.updateMatrixWorld(),u)D.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const Ee=E(k.current,I,M);D.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${Ee[0]}px,${Ee[1]}px,0);transform-origin:0 0;`}return G&&(n?G.prepend(D):G.appendChild(D)),()=>{G&&G.removeChild(D),ce.unmount()}}},[G,u]),d.useLayoutEffect(()=>{T&&(D.className=T)},[T]);const Q=d.useMemo(()=>u?{position:"absolute",top:0,left:0,width:M.width,height:M.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:r?"translate3d(-50%,-50%,0)":"none",...o&&{top:-M.height/2,left:-M.width/2,width:M.width,height:M.height},...t},[t,r,o,M,u]),ne=d.useMemo(()=>({position:"absolute",pointerEvents:A}),[A]);d.useLayoutEffect(()=>{if(L.current=!1,u){var ce;(ce=F.current)==null||ce.render(d.createElement("div",{ref:N,style:Q},d.createElement("div",{ref:B,style:ne},d.createElement("div",{ref:b,className:i,style:t,children:s}))))}else{var Ee;(Ee=F.current)==null||Ee.render(d.createElement("div",{ref:b,style:Q,className:i,children:s}))}});const he=d.useRef(!0);ee(ce=>{if(k.current){I.updateMatrixWorld(),k.current.updateWorldMatrix(!0,!1);const Ee=u?U.current:E(k.current,I,M);if(u||Math.abs($.current-I.zoom)>e||Math.abs(U.current[0]-Ee[0])>e||Math.abs(U.current[1]-Ee[1])>e){const ct=N4(k.current,I);let ut=!1;X&&(Array.isArray(h)?ut=h.map(Ce=>Ce.current):h!=="blending"&&(ut=[w]));const St=he.current;if(ut){const Ce=U4(k.current,I,P,ut);he.current=Ce&&!ct}else he.current=!ct;St!==he.current&&(f?f(!he.current):D.style.display=he.current?"block":"none");const $t=Math.floor(v[0]/2),Te=h?X?[v[0],$t]:[$t-1,0]:v;if(D.style.zIndex=`${G4(k.current,I,Te)}`,u){const[Ce,Xe]=[M.width/2,M.height/2],Tt=I.projectionMatrix.elements[5]*Xe,{isOrthographicCamera:st,top:Ht,left:ge,bottom:be,right:Me}=I,Oe=$4(I.matrixWorldInverse),We=st?`scale(${Tt})translate(${ul(-(Me+ge)/2)}px,${ul((Ht+be)/2)}px)`:`translateZ(${Tt}px)`;let Ge=k.current.matrixWorld;l&&(Ge=I.matrixWorldInverse.clone().transpose().copyPosition(Ge).scale(k.current.scale),Ge.elements[3]=Ge.elements[7]=Ge.elements[11]=0,Ge.elements[15]=1),D.style.width=M.width+"px",D.style.height=M.height+"px",D.style.perspective=st?"":`${Tt}px`,N.current&&B.current&&(N.current.style.transform=`${We}${Oe}translate(${Ce}px,${Xe}px)`,B.current.style.transform=H4(Ge,1/((c||10)/400)))}else{const Ce=c===void 0?1:z4(k.current,I)*c;D.style.transform=`translate3d(${Ee[0]}px,${Ee[1]}px,0) scale(${Ce})`}U.current=Ee,$.current=I.zoom}}if(!X&&j.current&&!L.current)if(u){if(N.current){const Ee=N.current.children[0];if(Ee!=null&&Ee.clientWidth&&Ee!=null&&Ee.clientHeight){const{isOrthographicCamera:ct}=I;if(ct||y)C.scale&&(Array.isArray(C.scale)?C.scale instanceof _?j.current.scale.copy(C.scale.clone().divideScalar(1)):j.current.scale.set(1/C.scale[0],1/C.scale[1],1/C.scale[2]):j.current.scale.setScalar(1/C.scale));else{const ut=(c||10)/400,St=Ee.clientWidth*ut,$t=Ee.clientHeight*ut;j.current.scale.set(St,$t,1)}L.current=!0}}}else{const Ee=D.children[0];if(Ee!=null&&Ee.clientWidth&&Ee!=null&&Ee.clientHeight){const ct=1/z.factor,ut=Ee.clientWidth*ct,St=Ee.clientHeight*ct;j.current.scale.set(ut,St,1),L.current=!0}j.current.lookAt(ce.camera.position)}});const xe=d.useMemo(()=>({vertexShader:u?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[u]);return d.createElement("group",Z({},C,{ref:k}),h&&!X&&d.createElement("mesh",{castShadow:m,receiveShadow:p,ref:j},y||d.createElement("planeGeometry",null),g||d.createElement("shaderMaterial",{side:dt,vertexShader:xe.vertexShader,fragmentShader:xe.fragmentShader})))});function V4({onChanged:s,portal:e,preventDefault:t=!0,scroll:i=!0,keyCode:n=9}){const r=d.useRef(0),o=H(l=>l.setEvents),a=H(l=>l.get),c=H(l=>l.gl);return d.useEffect(()=>{var l;let u=[],h;const f=a().events.filter,m=(l=e?.current)!==null&&l!==void 0?l:c.domElement.parentNode,p=()=>m&&s&&s(u,Math.round(r.current)%u.length);o({filter:(x,T)=>{let A=[...x];(A.length!==u.length||!u.every(C=>A.map(b=>b.object.uuid).includes(C.object.uuid)))&&(r.current=0,u=A,p()),f&&(A=f(A,T));for(let C=0;C<Math.round(r.current)%A.length;C++){const b=A.shift();A=[...A,b]}return A}});const g=x=>{var T,A;r.current=x(r.current),(T=a().events.handlers)==null||T.onPointerCancel(void 0),(A=a().events.handlers)==null||A.onPointerMove(h),p()},y=x=>{(x.keyCode||x.which)===n&&(t&&x.preventDefault(),u.length>1&&g(T=>T+1))},v=x=>{t&&x.preventDefault();let T=0;x||(x=window.event),x.wheelDelta?T=x.wheelDelta/120:x.detail&&(T=-x.detail/3),u.length>1&&g(A=>Math.abs(A-T))},E=x=>h=x;return document.addEventListener("pointermove",E,{passive:!0}),i&&document.addEventListener("wheel",v),n!==void 0&&document.addEventListener("keydown",y),()=>{o({filter:f}),n!==void 0&&document.removeEventListener("keydown",y),i&&document.removeEventListener("wheel",v),document.removeEventListener("pointermove",E)}},[c,a,o,t,i,n]),null}function j4(s,e="pointer",t="auto",i=document.body){d.useEffect(()=>{if(s)return i.style.cursor=e,()=>void(i.style.cursor=t)},[s])}const W4=s=>s;function X4(s,e=W4){const t=Mt.useSyncExternalStore(s.subscribe,Mt.useCallback(()=>e(s.getState()),[s,e]),Mt.useCallback(()=>e(s.getInitialState()),[s,e]));return Mt.useDebugValue(t),t}const Zu=s=>{const e=v1(s),t=i=>X4(e,i);return Object.assign(t,e),t},ym=(s=>s?Zu(s):Zu);let Hn=0;const sc=ym(s=>(Ms.onStart=(e,t,i)=>{s({active:!0,item:e,loaded:t,total:i,progress:(t-Hn)/(i-Hn)*100})},Ms.onLoad=()=>{s({active:!1})},Ms.onError=e=>s(t=>({errors:[...t.errors,e]})),Ms.onProgress=(e,t,i)=>{t===i&&(Hn=i),s({active:!0,item:e,loaded:t,total:i,progress:(t-Hn)/(i-Hn)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}));function Y4({children:s}){const e=sc();return d.createElement(d.Fragment,null,s?.(e))}const Q4=s=>`Loading ${s.toFixed(2)}%`;function J4({containerStyles:s,innerStyles:e,barStyles:t,dataStyles:i,dataInterpolation:n=Q4,initialState:r=o=>o}){const{active:o,progress:a}=sc(),c=d.useRef(0),l=d.useRef(0),u=d.useRef(null),[h,f]=d.useState(r(o));d.useEffect(()=>{let p;return o!==h&&(p=setTimeout(()=>f(o),300)),()=>clearTimeout(p)},[h,o]);const m=d.useCallback(()=>{u.current&&(c.current+=(a-c.current)/2,(c.current>.95*a||a===100)&&(c.current=a),u.current.innerText=n(c.current),c.current<a&&(l.current=requestAnimationFrame(m)))},[n,a]);return d.useEffect(()=>(m(),()=>cancelAnimationFrame(l.current)),[m]),h?d.createElement("div",{style:{...Qs.container,opacity:o?1:0,...s}},d.createElement("div",null,d.createElement("div",{style:{...Qs.inner,...e}},d.createElement("div",{style:{...Qs.bar,transform:`scaleX(${a/100})`,...t}}),d.createElement("span",{ref:u,style:{...Qs.data,...i}})))):null}const Qs={container:{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"#171717",display:"flex",alignItems:"center",justifyContent:"center",transition:"opacity 300ms ease",zIndex:1e3},inner:{width:100,height:3,background:"#272727",textAlign:"center"},bar:{height:3,width:"100%",background:"white",transition:"transform 200ms",transformOrigin:"left center"},data:{display:"inline-block",position:"relative",fontVariantNumeric:"tabular-nums",marginTop:"0.8em",color:"#f0f0f0",fontSize:"0.6em",fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, Roboto, Ubuntu, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',whiteSpace:"nowrap"}};function vm(s,e={},t,i){const n=Mt.useMemo(()=>new H1(s),[]);if(n.applyHandlers(s,i),n.applyConfig(e,t),Mt.useEffect(n.effect.bind(n)),Mt.useEffect(()=>n.clean.bind(n),[]),e.target===void 0)return n.bind.bind(n)}function hT(s,e){return gf(yf),vm({drag:s},e||{},"drag")}function q4(s){return s.forEach(gf),function(t,i){const{handlers:n,nativeHandlers:r,config:o}=O1(t,i||{});return vm(n,o,void 0,r)}}function xm(s,e){return q4([yf,N1,U1,z1,G1,$1])(s,e||{})}const ra=new _,eh=new de,$i=new _,Js=new _,Kn=new _,th=new vi,Z4=d.forwardRef(({autoTransform:s=!0,matrix:e,axisLock:t,dragLimits:i,onHover:n,onDragStart:r,onDrag:o,onDragEnd:a,children:c,dragConfig:l,...u},h)=>{const f=H(x=>x.controls),{camera:m,size:p,raycaster:g,invalidate:y}=H(),v=d.useRef(null),E=xm({onHover:({hovering:x})=>n&&n(x??!1),onDragStart:({event:x})=>{f&&(f.enabled=!1);const{point:T}=x;v.current.matrix.decompose(ra,new ue,new _),$i.copy(T),Js.copy($i).sub(ra),r&&r(ra),y()},onDrag:({xy:[x,T],intentional:A})=>{if(!A)return;const C=(x-p.left)/p.width*2-1,b=-((T-p.top)/p.height)*2+1;if(eh.set(C,b),g.setFromCamera(eh,m),!t)m.getWorldDirection(Kn).negate();else switch(t){case"x":Kn.set(1,0,0);break;case"y":Kn.set(0,1,0);break;case"z":Kn.set(0,0,1);break}th.setFromNormalAndCoplanarPoint(Kn,$i),g.ray.intersectPlane(th,$i);const R=v.current.matrix.clone(),I=v.current.matrixWorld.clone(),w=new _($i.x-Js.x,$i.y-Js.y,$i.z-Js.z);if(i&&(w.x=i[0]?Math.max(Math.min(w.x,i[0][1]),i[0][0]):w.x,w.y=i[1]?Math.max(Math.min(w.y,i[1][1]),i[1][0]):w.y,w.z=i[2]?Math.max(Math.min(w.z,i[2][1]),i[2][0]):w.z),s){v.current.matrix.setPosition(w);const M=v.current.matrix.clone().multiply(R.invert()),P=v.current.matrix.clone().multiply(I.invert());o&&o(v.current.matrix,M,v.current.matrixWorld,P)}else{const M=new re().copy(v.current.matrix);M.setPosition(w);const P=M.clone().multiply(R.invert()),O=M.clone().multiply(I.invert());o&&o(M,P,v.current.matrixWorld,O)}y()},onDragEnd:()=>{f&&(f.enabled=!0),a&&a(),y()}},{drag:{filterTaps:!0,threshold:1,...typeof l=="object"?l:{}}});return d.useImperativeHandle(h,()=>v.current,[]),d.useLayoutEffect(()=>{e&&(v.current.matrix=e)},[e]),d.createElement("group",Z({ref:v},E(),{matrix:e,matrixAutoUpdate:!1},u),c)}),rc=d.createContext(null);function oc(){return d.useContext(rc)}function eE({eps:s=1e-5,enabled:e=!0,infinite:t,horizontal:i,pages:n=1,distance:r=1,damping:o=.25,maxSpeed:a=1/0,prepend:c=!1,style:l={},children:u}){const{get:h,setEvents:f,gl:m,size:p,invalidate:g,events:y}=H(),[v]=d.useState(()=>document.createElement("div")),[E]=d.useState(()=>document.createElement("div")),[x]=d.useState(()=>document.createElement("div")),T=m.domElement.parentNode,A=d.useRef(0),C=d.useMemo(()=>({el:v,eps:s,fill:E,fixed:x,horizontal:i,damping:o,offset:0,delta:0,scroll:A,pages:n,range(I,w,M=0){const P=I-M,O=P+w+M*2;return this.offset<P?0:this.offset>O?1:(this.offset-P)/(O-P)},curve(I,w,M=0){return Math.sin(this.range(I,w,M)*Math.PI)},visible(I,w,M=0){const P=I-M,O=P+w+M*2;return this.offset>=P&&this.offset<=O}}),[s,o,i,n]);d.useEffect(()=>{v.style.position="absolute",v.style.width="100%",v.style.height="100%",v.style[i?"overflowX":"overflowY"]="auto",v.style[i?"overflowY":"overflowX"]="hidden",v.style.top="0px",v.style.left="0px";for(const w in l)v.style[w]=l[w];x.style.position="sticky",x.style.top="0px",x.style.left="0px",x.style.width="100%",x.style.height="100%",x.style.overflow="hidden",v.appendChild(x),E.style.height=i?"100%":`${n*r*100}%`,E.style.width=i?`${n*r*100}%`:"100%",E.style.pointerEvents="none",v.appendChild(E),c?T.prepend(v):T.appendChild(v),v[i?"scrollLeft":"scrollTop"]=1;const R=y.connected||m.domElement;requestAnimationFrame(()=>y.connect==null?void 0:y.connect(v));const I=h().events.compute;return f({compute(w,M){const{left:P,top:O}=T.getBoundingClientRect(),z=w.clientX-P,D=w.clientY-O;M.pointer.set(z/M.size.width*2-1,-(D/M.size.height)*2+1),M.raycaster.setFromCamera(M.pointer,M.camera)}}),()=>{T.removeChild(v),f({compute:I}),y.connect==null||y.connect(R)}},[n,r,i,v,E,x,T]),d.useEffect(()=>{if(y.connected===v){const R=p[i?"width":"height"],I=v[i?"scrollWidth":"scrollHeight"],w=I-R;let M=0,P=!0,O=!0;const z=()=>{if(!(!e||O)&&(g(),M=v[i?"scrollLeft":"scrollTop"],A.current=M/w,t)){if(!P){if(M>=w){const F=1-C.offset;v[i?"scrollLeft":"scrollTop"]=1,A.current=C.offset=-F,P=!0}else if(M<=0){const F=1+C.offset;v[i?"scrollLeft":"scrollTop"]=I,A.current=C.offset=F,P=!0}}P&&setTimeout(()=>P=!1,40)}};v.addEventListener("scroll",z,{passive:!0}),requestAnimationFrame(()=>O=!1);const D=F=>v.scrollLeft+=F.deltaY/2;return i&&v.addEventListener("wheel",D,{passive:!0}),()=>{v.removeEventListener("scroll",z),i&&v.removeEventListener("wheel",D)}}},[v,y,p,t,C,g,i,e]);let b=0;return ee((R,I)=>{b=C.offset,Mi.damp(C,"offset",A.current,o,I,a,void 0,s),Mi.damp(C,"delta",Math.abs(b-C.offset),o,I,a,void 0,s),C.delta>s&&g()}),d.createElement(rc.Provider,{value:C},u)}const tE=d.forwardRef(({children:s},e)=>{const t=d.useRef(null);d.useImperativeHandle(e,()=>t.current,[]);const i=oc(),{width:n,height:r}=H(o=>o.viewport);return ee(()=>{t.current.position.x=i.horizontal?-n*(i.pages-1)*i.offset:0,t.current.position.y=i.horizontal?0:r*(i.pages-1)*i.offset}),d.createElement("group",{ref:t},s)}),iE=d.forwardRef(({children:s,style:e,...t},i)=>{const n=oc(),r=d.useRef(null);d.useImperativeHandle(i,()=>r.current,[]);const{width:o,height:a}=H(u=>u.size),c=d.useContext(us),l=d.useMemo(()=>xl.createRoot(n.fixed),[n.fixed]);return ee(()=>{n.delta>n.eps&&(r.current.style.transform=`translate3d(${n.horizontal?-o*(n.pages-1)*n.offset:0}px,${n.horizontal?0:a*(n.pages-1)*-n.offset}px,0)`)}),l.render(d.createElement("div",Z({ref:r,style:{...e,position:"absolute",top:0,left:0,willChange:"transform"}},t),d.createElement(rc.Provider,{value:n},d.createElement(us.Provider,{value:c},s)))),null}),nE=d.forwardRef(({html:s,...e},t)=>{const i=s?iE:tE;return d.createElement(i,Z({ref:t},e))});function sE({enabled:s=!0,snap:e,global:t,domElement:i,cursor:n=!0,children:r,speed:o=1,rotation:a=[0,0,0],zoom:c=1,polar:l=[0,Math.PI/2],azimuth:u=[-1/0,1/0],damping:h=.25}){const f=H(C=>C.events),m=H(C=>C.gl),p=i||f.connected||m.domElement,{size:g}=H(),y=d.useMemo(()=>[a[0]+l[0],a[0]+l[1]],[a[0],l[0],l[1]]),v=d.useMemo(()=>[a[1]+u[0],a[1]+u[1]],[a[1],u[0],u[1]]),E=d.useMemo(()=>[me.clamp(a[0],...y),me.clamp(a[1],...v),a[2]],[a[0],a[1],a[2],y,v]);d.useEffect(()=>{if(t&&n&&s)return p.style.cursor="grab",m.domElement.style.cursor="",()=>{p.style.cursor="default",m.domElement.style.cursor="default"}},[t,n,p,s]);const[x]=d.useState({scale:1,rotation:E,damping:h}),T=d.useRef(null);ee((C,b)=>{Mi.damp3(T.current.scale,x.scale,x.damping,b),Mi.dampE(T.current.rotation,x.rotation,x.damping,b)});const A=xm({onHover:({last:C})=>{n&&!t&&s&&(p.style.cursor=C?"auto":"grab")},onDrag:({down:C,delta:[b,R],memo:[I,w]=x.rotation||E})=>s?(n&&(p.style.cursor=C?"grabbing":"grab"),b=me.clamp(w+b/g.width*Math.PI*o,...v),R=me.clamp(I+R/g.height*Math.PI*o,...y),x.scale=C&&R>y[1]/2?c:1,x.rotation=e&&!C?E:[R,b,0],x.damping=e&&!C&&typeof e!="boolean"?e:h,[R,b]):[R,b]},{target:t?p:void 0});return d.createElement("group",Z({ref:T},A?.()),r)}const rE=s=>(e,t,i)=>{const n=i.subscribe;return i.subscribe=((o,a,c)=>{let l=o;if(a){const u=c?.equalityFn||Object.is;let h=o(i.getState());l=f=>{const m=o(f);if(!u(h,m)){const p=h;a(h=m,p)}},c?.fireImmediately&&a(h,h)}return n(l)}),s(e,t,i)},oE=rE,Em=d.createContext(null);function aE({map:s,children:e,onChange:t,domElement:i}){const n=s.map(c=>c.name+c.keys).join("-"),r=d.useMemo(()=>ym(oE(()=>s.reduce((c,l)=>({...c,[l.name]:!1}),{}))),[n]),o=d.useMemo(()=>[r.subscribe,r.getState,r],[n]),a=r.setState;return d.useEffect(()=>{const l=s.map(({name:m,keys:p,up:g})=>({keys:p,up:g,fn:y=>{a({[m]:y}),t&&t(m,y,o[1]())}})).reduce((m,{keys:p,fn:g,up:y=!0})=>(p.forEach(v=>m[v]={fn:g,pressed:!1,up:y}),m),{}),u=({key:m,code:p})=>{const g=l[m]||l[p];if(!g)return;const{fn:y,pressed:v,up:E}=g;g.pressed=!0,(E||!v)&&y(!0)},h=({key:m,code:p})=>{const g=l[m]||l[p];if(!g)return;const{fn:y,up:v}=g;g.pressed=!1,v&&y(!1)},f=i||window;return f.addEventListener("keydown",u,{passive:!0}),f.addEventListener("keyup",h,{passive:!0}),()=>{f.removeEventListener("keydown",u),f.removeEventListener("keyup",h)}},[i,n]),d.createElement(Em.Provider,{value:o,children:e})}function lE(s){const[e,t,i]=d.useContext(Em);return s?i(s):[e,t]}const ih=s=>Symbol.iterator in s,nh=s=>"entries"in s,sh=(s,e)=>{const t=s instanceof Map?s:new Map(s.entries()),i=e instanceof Map?e:new Map(e.entries());if(t.size!==i.size)return!1;for(const[n,r]of t)if(!i.has(n)||!Object.is(r,i.get(n)))return!1;return!0},cE=(s,e)=>{const t=s[Symbol.iterator](),i=e[Symbol.iterator]();let n=t.next(),r=i.next();for(;!n.done&&!r.done;){if(!Object.is(n.value,r.value))return!1;n=t.next(),r=i.next()}return!!n.done&&!!r.done};function uE(s,e){return Object.is(s,e)?!0:typeof s!="object"||s===null||typeof e!="object"||e===null||Object.getPrototypeOf(s)!==Object.getPrototypeOf(e)?!1:ih(s)&&ih(e)?nh(s)&&nh(e)?sh(s,e):cE(s,e):sh({entries:()=>Object.entries(s)},{entries:()=>Object.entries(e)})}const Am=d.createContext([]);function hE({box:s,multiple:e,children:t,onChange:i,onChangePointerUp:n,border:r="1px solid #55aaff",backgroundColor:o="rgba(75, 160, 255, 0.1)",filter:a=l=>l,...c}){const[l,u]=d.useState(!1),{setEvents:h,camera:f,raycaster:m,gl:p,controls:g,size:y,get:v}=H(),[E,x]=d.useState(!1),[T,A]=d.useReducer((I,{object:w,shift:M})=>w===void 0?[]:Array.isArray(w)?w:M?I.includes(w)?I.filter(P=>P!==w):[w,...I]:I[0]===w?[]:[w],[]);d.useEffect(()=>{l?i?.(T):n?.(T)},[T,l]);const C=d.useCallback(I=>{I.stopPropagation(),A({object:a([I.object])[0],shift:e&&I.shiftKey})},[]),b=d.useCallback(I=>!E&&A({}),[E]),R=d.useRef(null);return d.useEffect(()=>{if(!s||!e)return;const I=new K1(f,R.current),w=document.createElement("div");w.style.pointerEvents="none",w.style.border=r,w.style.backgroundColor=o,w.style.position="fixed";const M=new de,P=new de,O=new de,z=v().events.enabled,D=g?.enabled;let F=!1;function k(X,Q){const{offsetX:ne,offsetY:he}=X,{width:xe,height:ce}=y;Q.set(ne/xe*2-1,-(he/ce)*2+1)}function $(X){var Q;g&&(g.enabled=!1),h({enabled:!1}),u(F=!0),(Q=p.domElement.parentElement)==null||Q.appendChild(w),w.style.left=`${X.clientX}px`,w.style.top=`${X.clientY}px`,w.style.width="0px",w.style.height="0px",M.x=X.clientX,M.y=X.clientY}function U(X){O.x=Math.max(M.x,X.clientX),O.y=Math.max(M.y,X.clientY),P.x=Math.min(M.x,X.clientX),P.y=Math.min(M.y,X.clientY),w.style.left=`${P.x}px`,w.style.top=`${P.y}px`,w.style.width=`${O.x-P.x}px`,w.style.height=`${O.y-P.y}px`}function N(){if(F){var X;g&&(g.enabled=D),h({enabled:z}),u(F=!1),(X=w.parentElement)==null||X.removeChild(w)}}function B(X){X.shiftKey&&($(X),k(X,I.startPoint))}let G=[];function j(X){if(F){U(X),k(X,I.endPoint);const Q=I.select().sort(ne=>ne.uuid).filter(ne=>ne.isMesh);uE(Q,G)||(G=Q,A({object:a(Q)}))}}function L(X){F&&N()}return document.addEventListener("pointerdown",B,{passive:!0}),document.addEventListener("pointermove",j,{passive:!0,capture:!0}),document.addEventListener("pointerup",L,{passive:!0}),()=>{document.removeEventListener("pointerdown",B),document.removeEventListener("pointermove",j,!0),document.removeEventListener("pointerup",L)}},[y.width,y.height,m,f,g,p]),d.createElement("group",Z({ref:R,onClick:C,onPointerOver:()=>x(!0),onPointerOut:()=>x(!1),onPointerMissed:b},c),d.createElement(Am.Provider,{value:T},t))}function dE(){return d.useContext(Am)}const Sm=d.forwardRef(function({children:e,follow:t=!0,lockX:i=!1,lockY:n=!1,lockZ:r=!1,...o},a){const c=d.useRef(null),l=d.useRef(null),u=new ue;return ee(({camera:h})=>{if(!t||!l.current)return;const f=c.current.rotation.clone();l.current.updateMatrix(),l.current.updateWorldMatrix(!1,!1),l.current.getWorldQuaternion(u),h.getWorldQuaternion(c.current.quaternion).premultiply(u.invert()),i&&(c.current.rotation.x=f.x),n&&(c.current.rotation.y=f.y),r&&(c.current.rotation.z=f.z)}),d.useImperativeHandle(a,()=>l.current,[]),d.createElement("group",Z({ref:l},o),d.createElement("group",{ref:c},e))}),fE=d.forwardRef(({children:s,depth:e=-1,...t},i)=>{const n=d.useRef(null);return d.useImperativeHandle(i,()=>n.current,[]),ee(({camera:r})=>{n.current.quaternion.copy(r.quaternion),n.current.position.copy(r.position)}),d.createElement("group",Z({ref:n},t),d.createElement("group",{"position-z":-e},s))}),mE=new _,pE=new _,gE=new _,yE=(s,e,t)=>{const i=t.width/2,n=t.height/2;e.updateMatrixWorld(!1);const r=s.project(e);return r.x=r.x*i+i,r.y=-(r.y*n)+n,r},vE=(s,e,t,i=1)=>{const n=mE.set(s.x/t.width*2-1,-(s.y/t.height)*2+1,i);return n.unproject(e),n},ro=(s,e,t,i)=>{const n=yE(gE.copy(s),t,i);let r=0;for(let o=0;o<2;++o){const a=pE.copy(n).setComponent(o,n.getComponent(o)+e),c=vE(a,t,i,a.z);r=Math.max(r,s.distanceTo(c))}return r},xE=new _,EE=d.forwardRef(({scale:s=1,...e},t)=>{const i=d.useRef(null);return d.useImperativeHandle(t,()=>i.current,[]),ee(n=>{const r=i.current;if(!r)return;const o=ro(r.getWorldPosition(xE),s,n.camera,n.size);r.scale.setScalar(o*s)}),d.createElement("object3D",Z({ref:i},e))}),AE=new _,SE=d.forwardRef(function({start:e=[0,0,0],end:t=[0,0,0],mid:i,segments:n=20,...r},o){const a=d.useRef(null);d.useImperativeHandle(o,()=>a.current);const[c]=d.useState(()=>new Vd(void 0,void 0,void 0)),l=d.useCallback((h,f,m,p=20)=>(h instanceof _?c.v0.copy(h):c.v0.set(...h),f instanceof _?c.v2.copy(f):c.v2.set(...f),m instanceof _?c.v1.copy(m):Array.isArray(m)?c.v1.set(...m):c.v1.copy(c.v0.clone().add(c.v2.clone().sub(c.v0)).add(AE.set(0,c.v0.y-c.v2.y,0))),c.getPoints(p)),[]);d.useLayoutEffect(()=>{a.current.setPoints=(h,f,m)=>{const p=l(h,f,m);a.current.geometry&&a.current.geometry.setPositions(p.map(g=>g.toArray()).flat())}},[]);const u=d.useMemo(()=>l(e,t,i,n),[e,t,i,n]);return d.createElement(ei,Z({ref:a,points:u},r))}),TE=d.forwardRef(function({start:e,end:t,midA:i,midB:n,segments:r=20,...o},a){const c=d.useMemo(()=>{const l=e instanceof _?e:new _(...e),u=t instanceof _?t:new _(...t),h=i instanceof _?i:new _(...i),f=n instanceof _?n:new _(...n);return new Kg(l,h,f,u).getPoints(r)},[e,t,i,n,r]);return d.createElement(ei,Z({ref:a,points:c},o))}),bE=d.forwardRef(function({points:e,closed:t=!1,curveType:i="centripetal",tension:n=.5,segments:r=20,vertexColors:o,...a},c){const l=d.useMemo(()=>{const f=e.map(m=>m instanceof _?m:new _(...m));return new jd(f,t,i,n)},[e,t,i,n]),u=d.useMemo(()=>l.getPoints(r),[l,r]),h=d.useMemo(()=>{if(!o||o.length<2)return;if(o.length===r+1)return o;const f=o.map(g=>g instanceof we?g:new we(...g));t&&f.push(f[0].clone());const m=[f[0]],p=r/(f.length-1);for(let g=1;g<r;g++){const y=g%p/p,v=Math.floor(g/p);m.push(f[v].clone().lerp(f[v+1],y))}return m.push(f[f.length-1]),m},[o,r]);return d.createElement(ei,Z({ref:c,points:u,vertexColors:h},a))}),CE=d.forwardRef(({url:s,distance:e=1,loop:t=!0,autoplay:i,...n},r)=>{const o=d.useRef(null);d.useImperativeHandle(r,()=>o.current,[]);const a=H(({camera:u})=>u),[c]=d.useState(()=>new Vg),l=je(jg,s);return d.useEffect(()=>{const u=o.current;u&&(u.setBuffer(l),u.setRefDistance(e),u.setLoop(t),i&&!u.isPlaying&&u.play())},[l,a,e,t]),d.useEffect(()=>{const u=o.current;return a.add(c),()=>{a.remove(c),u&&(u.isPlaying&&u.stop(),u.source&&u.source._connected&&u.disconnect())}},[]),d.createElement("positionalAudio",Z({ref:o,args:[c]},n))}),RE=d.forwardRef(({sdfGlyphSize:s=64,anchorX:e="center",anchorY:t="middle",font:i,fontSize:n=1,children:r,characters:o,onSync:a,...c},l)=>{const u=H(({invalidate:p})=>p),[h]=d.useState(()=>new V1),[f,m]=d.useMemo(()=>{const p=[];let g="";return d.Children.forEach(r,y=>{typeof y=="string"||typeof y=="number"?g+=y:p.push(y)}),[p,g]},[r]);return Gt(()=>new Promise(p=>j1({font:i,characters:o},p)),["troika-text",i,o]),d.useLayoutEffect(()=>void h.sync(()=>{u(),a&&a(h)})),d.useEffect(()=>()=>h.dispose(),[h]),d.createElement("primitive",Z({object:h,ref:l,font:i,text:m,anchorX:e,anchorY:t,fontSize:n,sdfGlyphSize:s},c),f)}),wE=()=>{try{var s=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&s.getContext("webgl2"))}catch{return!1}},IE=d.forwardRef(({children:s,multisamping:e=8,renderIndex:t=1,disableRender:i,disableGamma:n,disableRenderPass:r,depthBuffer:o=!0,stencilBuffer:a=!1,anisotropy:c=1,colorSpace:l,type:u,...h},f)=>{d.useMemo(()=>ft({EffectComposer:Y1,RenderPass:X1,ShaderPass:W1}),[]);const m=d.useRef(null);d.useImperativeHandle(f,()=>m.current,[]);const{scene:p,camera:g,gl:y,size:v,viewport:E}=H(),[x]=d.useState(()=>{const A=new Ze(v.width,v.height,{type:u||tn,format:Sl,depthBuffer:o,stencilBuffer:a,anisotropy:c});return u===Wg&&l!=null&&(A.texture.colorSpace=l),A.samples=e,A});d.useEffect(()=>{var A,C;(A=m.current)==null||A.setSize(v.width,v.height),(C=m.current)==null||C.setPixelRatio(E.dpr)},[y,v,E.dpr]),ee(()=>{var A;i||(A=m.current)==null||A.render()},t);const T=[];return r||T.push(d.createElement("renderPass",{key:"renderpass",attach:`passes-${T.length}`,args:[p,g]})),n||T.push(d.createElement("shaderPass",{attach:`passes-${T.length}`,key:"gammapass",args:[Q1]})),d.Children.forEach(s,A=>{A&&T.push(d.cloneElement(A,{key:T.length,attach:`passes-${T.length}`}))}),d.createElement("effectComposer",Z({ref:m,args:[y,x]},h),T)});let hl=(function(s){return s.Linear="linear",s.Radial="radial",s})({});function _E({stops:s,colors:e,size:t=1024,width:i=16,type:n=hl.Linear,innerCircleRadius:r=0,outerCircleRadius:o="auto",...a}){const c=H(u=>u.gl),l=d.useMemo(()=>{const u=document.createElement("canvas"),h=u.getContext("2d");u.width=i,u.height=t;let f;if(n===hl.Linear)f=h.createLinearGradient(0,0,0,t);else{const g=u.width/2,y=u.height/2,v=o!=="auto"?Math.abs(Number(o)):Math.sqrt(g**2+y**2);f=h.createRadialGradient(g,y,Math.abs(r),g,y,v)}const m=new we;let p=s.length;for(;p--;)f.addColorStop(s[p],m.set(e[p]).getStyle());return h.save(),h.fillStyle=f,h.fillRect(0,0,i,t),h.restore(),u},[s]);return d.createElement("canvasTexture",Z({colorSpace:c.outputColorSpace,args:[l],attach:"map"},a))}const In=s=>s===Object(s)&&!Array.isArray(s)&&typeof s!="function";function Oi(s,e){const t=H(r=>r.gl),i=je(Yi,In(s)?Object.values(s):s);return d.useLayoutEffect(()=>{e?.(i)},[e]),d.useEffect(()=>{if("initTexture"in t){let r=[];Array.isArray(i)?r=i:i instanceof Pn?r=[i]:In(i)&&(r=Object.values(i)),r.forEach(o=>{o instanceof Pn&&t.initTexture(o)})}},[t,i]),d.useMemo(()=>{if(In(s)){const r={};let o=0;for(const a in s)r[a]=i[o++];return r}else return i},[s,i])}Oi.preload=s=>je.preload(Yi,s);Oi.clear=s=>je.clear(Yi,s);const LE=({children:s,input:e,onLoad:t})=>{const i=Oi(e,t);return d.createElement(d.Fragment,null,s?.(i))},rh=xi({color:new we("white"),scale:new de(1,1),imageBounds:new de(1,1),resolution:1024,map:null,zoom:1,radius:0,grayscale:0,opacity:1},`
  varying vec2 vUv;
  varying vec2 vPos;
  void main() {
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
    vUv = uv;
    vPos = position.xy;
  }
`,`
  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44
  varying vec2 vUv;
  varying vec2 vPos;
  uniform vec2 scale;
  uniform vec2 imageBounds;
  uniform float resolution;
  uniform vec3 color;
  uniform sampler2D map;
  uniform float radius;
  uniform float zoom;
  uniform float grayscale;
  uniform float opacity;
  const vec3 luma = vec3(.299, 0.587, 0.114);
  vec4 toGrayscale(vec4 color, float intensity) {
    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);
  }
  vec2 aspect(vec2 size) {
    return size / min(size.x, size.y);
  }
  
  const float PI = 3.14159265;
    
  // from https://iquilezles.org/articles/distfunctions
  float udRoundBox( vec2 p, vec2 b, float r ) {
    return length(max(abs(p)-b+r,0.0))-r;
  }

  void main() {
    vec2 s = aspect(scale);
    vec2 i = aspect(imageBounds);
    float rs = s.x / s.y;
    float ri = i.x / i.y;
    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);
    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;
    vec2 uv = vUv * s / new + offset;
    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);

    vec2 res = vec2(scale * resolution);
    vec2 halfRes = 0.5 * res;
    float b = udRoundBox(vUv.xy * res - halfRes, halfRes, resolution * radius);    
	  vec3 a = mix(vec3(1.0,0.0,0.0), vec3(0.0,0.0,0.0), smoothstep(0.0, 1.0, b));
    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, opacity * a), grayscale);
    
    #include <tonemapping_fragment>
    #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
  }
`),Tm=d.forwardRef(({children:s,color:e,segments:t=1,scale:i=1,zoom:n=1,grayscale:r=0,opacity:o=1,radius:a=0,texture:c,toneMapped:l,transparent:u,side:h,...f},m)=>{ft({ImageMaterial:rh});const p=d.useRef(null),g=H(x=>x.size),y=Array.isArray(i)?[i[0],i[1]]:[i,i],v=[c.image.width,c.image.height],E=Math.max(g.width,g.height);return d.useImperativeHandle(m,()=>p.current,[]),d.useLayoutEffect(()=>{p.current.geometry.parameters&&p.current.material.scale.set(y[0]*p.current.geometry.parameters.width,y[1]*p.current.geometry.parameters.height)},[y[0],y[1]]),d.createElement("mesh",Z({ref:p,scale:Array.isArray(i)?[...i,1]:i},f),d.createElement("planeGeometry",{args:[1,1,t,t]}),d.createElement("imageMaterial",{color:e,map:c,zoom:n,grayscale:r,opacity:o,scale:y,imageBounds:v,resolution:E,radius:a,toneMapped:l,transparent:u,side:h,key:rh.key}),s)}),PE=d.forwardRef(({url:s,...e},t)=>{const i=Oi(s);return d.createElement(Tm,Z({},e,{texture:i,ref:t}))}),ME=d.forwardRef(({url:s,...e},t)=>d.createElement(Tm,Z({},e,{ref:t}))),DE=d.forwardRef((s,e)=>{if(s.url)return d.createElement(PE,Z({},s,{ref:e}));if(s.texture)return d.createElement(ME,Z({},s,{ref:e}));throw new Error("<Image /> requires a url or texture")}),oh=xi({screenspace:!1,color:new we("black"),opacity:1,thickness:.05,size:new de},`#include <common>
   #include <morphtarget_pars_vertex>
   #include <skinning_pars_vertex>
   #include <clipping_planes_pars_vertex>
   uniform float thickness;
   uniform bool screenspace;
   uniform vec2 size;
   void main() {
     #if defined (USE_SKINNING)
	     #include <beginnormal_vertex>
       #include <morphnormal_vertex>
       #include <skinbase_vertex>
       #include <skinnormal_vertex>
       #include <defaultnormal_vertex>
     #endif
     #include <begin_vertex>
	   #include <morphtarget_vertex>
	   #include <skinning_vertex>
     #include <project_vertex>
     #include <clipping_planes_vertex>
     vec4 tNormal = vec4(normal, 0.0);
     vec4 tPosition = vec4(transformed, 1.0);
     #ifdef USE_INSTANCING
       tNormal = instanceMatrix * tNormal;
       tPosition = instanceMatrix * tPosition;
     #endif
     if (screenspace) {
       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;
       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); 
     } else {
       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;
       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;
       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;
       clipPosition.xy += offset;
       gl_Position = clipPosition;
     }
   }`,`uniform vec3 color;
   uniform float opacity;
   #include <clipping_planes_pars_fragment>
   void main(){
     #include <clipping_planes_fragment>
     gl_FragColor = vec4(color, opacity);
     #include <tonemapping_fragment>
     #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`);function BE({color:s="black",opacity:e=1,transparent:t=!1,screenspace:i=!1,toneMapped:n=!0,polygonOffset:r=!1,polygonOffsetFactor:o=0,renderOrder:a=0,thickness:c=.05,angle:l=Math.PI,clippingPlanes:u,...h}){const f=d.useRef(null),[m]=d.useState(()=>new oh({side:Wd})),{gl:p}=H(),g=p.getDrawingBufferSize(new de);d.useMemo(()=>ft({OutlinesMaterial:oh}),[]);const y=d.useRef(0),v=d.useRef(null);return d.useLayoutEffect(()=>{const E=f.current;if(!E)return;const x=E.parent;if(x&&x.geometry&&(y.current!==l||v.current!==x.geometry)){var T;y.current=l,v.current=x.geometry;let A=(T=E.children)==null?void 0:T[0];A&&(l&&A.geometry.dispose(),E.remove(A)),x.skeleton?(A=new Xg,A.material=m,A.bind(x.skeleton,x.bindMatrix),E.add(A)):x.isInstancedMesh?(A=new Xd(x.geometry,m,x.count),A.instanceMatrix=x.instanceMatrix,E.add(A)):(A=new oe,A.material=m,E.add(A)),A.geometry=l?Kd(x.geometry,l):x.geometry,A.morphTargetInfluences=x.morphTargetInfluences,A.morphTargetDictionary=x.morphTargetDictionary}}),d.useLayoutEffect(()=>{const E=f.current;if(!E)return;const x=E.children[0];if(x){x.renderOrder=a;const T=E.parent;ui(x,{morphTargetInfluences:T.morphTargetInfluences,morphTargetDictionary:T.morphTargetDictionary}),ui(x.material,{transparent:t,thickness:c,color:s,opacity:e,size:g,screenspace:i,toneMapped:n,polygonOffset:r,polygonOffsetFactor:o,clippingPlanes:u,clipping:u&&u.length>0})}}),d.useEffect(()=>()=>{const E=f.current;if(!E)return;const x=E.children[0];x&&(l&&x.geometry.dispose(),E.remove(x))},[]),d.createElement("group",Z({ref:f},h))}const bm={width:.2,length:1,decay:1,local:!1,stride:0,interval:1},FE=(s,e=1)=>(s.set(s.subarray(e)),s.fill(-1/0,-e),s);function Cm(s,e){const{length:t,local:i,decay:n,interval:r,stride:o}={...bm,...e},a=d.useRef(null),[c]=d.useState(()=>new _);d.useLayoutEffect(()=>{s&&(a.current=Float32Array.from({length:t*10*3},(h,f)=>s.position.getComponent(f%3)))},[t,s]);const l=d.useRef(new _),u=d.useRef(0);return ee(()=>{if(s&&a.current){if(u.current===0){let h;i?h=s.position:(s.getWorldPosition(c),h=c);const f=1*n;for(let m=0;m<f;m++)h.distanceTo(l.current)<o||(FE(a.current,3),a.current.set(h.toArray(),a.current.length-3));l.current.copy(h)}u.current++,u.current=u.current%r}}),a}const kE=d.forwardRef((s,e)=>{const{children:t}=s,{width:i,length:n,decay:r,local:o,stride:a,interval:c}={...bm,...s},{color:l="hotpink",attenuation:u,target:h}=s,f=H(T=>T.size),m=H(T=>T.scene),p=d.useRef(null),[g,y]=d.useState(null),v=Cm(g,{length:n,decay:r,local:o,stride:a,interval:c});d.useEffect(()=>{const T=h?.current||p.current.children.find(A=>A instanceof Ve);T&&y(T)},[v,h]);const E=d.useMemo(()=>new vf,[]),x=d.useMemo(()=>{var T,A;const C=new xf({lineWidth:.1*i,color:l,sizeAttenuation:1,resolution:new de(f.width,f.height)});let b;if(t)if(Array.isArray(t))b=t.find(R=>{const I=R;return typeof I.type=="string"&&I.type==="meshLineMaterial"});else{const R=t;typeof R.type=="string"&&R.type==="meshLineMaterial"&&(b=R)}return typeof((T=b)==null?void 0:T.props)=="object"&&((A=b)==null?void 0:A.props)!==null&&C.setValues(b.props),C},[i,l,f,t]);return d.useEffect(()=>{x.uniforms.resolution.value.set(f.width,f.height)},[f]),ee(()=>{v.current&&E.setPoints(v.current,u)}),d.createElement("group",null,Ei(d.createElement("mesh",{ref:e,geometry:E,material:x}),m),d.createElement("group",{ref:p},t))});function Rm(s,e=16,t,i,n){const[r,o]=d.useState(()=>{const a=Array.from({length:e},()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]).flat();return new Ga(Float32Array.from(a),16)});return d.useLayoutEffect(()=>{if(typeof s.current>"u")return;const a=new J1(s.current);i&&a.setWeightAttribute(i),a.build();const c=new _,l=new _,u=new we,h=new Ve;s.current.updateMatrixWorld(!0);for(let f=0;f<e;f++)a.sample(c,l,u),typeof t=="function"?t({dummy:h,sampledMesh:s.current,position:c,normal:l,color:u},f):h.position.copy(c),h.updateMatrix(),n!=null&&n.current&&n.current.setMatrixAt(f,h.matrix),h.matrix.toArray(r.array,f*16);n!=null&&n.current&&(n.current.instanceMatrix.needsUpdate=!0),r.needsUpdate=!0,o(new Ga(r.array,r.itemSize).copy(r))},[s,n,i,e,t]),r}function OE({children:s,weight:e,transform:t,instances:i,mesh:n,count:r=16,...o}){const a=d.useRef(null),c=d.useRef(null),l=d.useRef(null);return d.useLayoutEffect(()=>{var u,h;c.current=(u=i?.current)!==null&&u!==void 0?u:a.current.children.find(f=>f.hasOwnProperty("instanceMatrix")),l.current=(h=n?.current)!==null&&h!==void 0?h:a.current.children.find(f=>f.type==="Mesh")},[s,n?.current,i?.current]),Rm(l,r,t,e,c),d.createElement("group",Z({ref:a},o),s)}const NE=({compute:s,name:e,...t})=>{const[i]=d.useState(()=>new fi(new Float32Array(0),1)),n=d.useRef(null);return d.useLayoutEffect(()=>{if(n.current){var r;const o=(r=n.current.parent)!==null&&r!==void 0?r:n.current.__r3f.parent.object,a=s(o);n.current.copy(a)}},[s]),d.createElement("primitive",Z({ref:n,object:i,attach:`attributes-${e}`},t))};function UE(s,{keys:e=["near","far","color","distance","decay","penumbra","angle","intensity","skeleton","visible","castShadow","receiveShadow","morphTargetDictionary","morphTargetInfluences","name","geometry","material","position","rotation","scale","up","userData","bindMode","bindMatrix","bindMatrixInverse","skeleton"],deep:t,inject:i,castShadow:n,receiveShadow:r}){let o={};for(const a of e)o[a]=s[a];return t&&(o.geometry&&t!=="materialsOnly"&&(o.geometry=o.geometry.clone()),o.material&&t!=="geometriesOnly"&&(o.material=o.material.clone())),i&&(typeof i=="function"?o={...o,children:i(s)}:d.isValidElement(i)?o={...o,children:i}:o={...o,...i}),s instanceof oe&&(n&&(o.castShadow=!0),r&&(o.receiveShadow=!0)),o}const ys=d.forwardRef(({isChild:s=!1,object:e,children:t,deep:i,castShadow:n,receiveShadow:r,inject:o,keys:a,...c},l)=>{const u={keys:a,deep:i,inject:o,castShadow:n,receiveShadow:r};if(e=d.useMemo(()=>{if(s===!1&&!Array.isArray(e)){let p=!1;if(e.traverse(g=>{g.isSkinnedMesh&&(p=!0)}),p)return q1.clone(e)}return e},[e,s]),Array.isArray(e))return d.createElement("group",Z({},c,{ref:l}),e.map(p=>d.createElement(ys,Z({key:p.uuid,object:p},u))),t);const{children:h,...f}=UE(e,u),m=e.type[0].toLowerCase()+e.type.slice(1);return d.createElement(m,Z({},f,c,{ref:l}),e.children.map(p=>p.type==="Bone"?d.createElement("primitive",Z({key:p.uuid,object:p},u)):d.createElement(ys,Z({key:p.uuid,object:p},u,{isChild:!0}))),t,h)}),ac=d.createContext(null),zE=d.forwardRef(({resolution:s=28,maxPolyCount:e=1e4,enableUvs:t=!1,enableColors:i=!1,children:n,...r},o)=>{const a=d.useRef(null);d.useImperativeHandle(o,()=>a.current,[]);const c=d.useMemo(()=>new Z1(s,null,t,i,e),[s,e,t,i]),l=d.useMemo(()=>({getParent:()=>a}),[]);return ee(()=>{c.update(),c.reset()},-1),d.createElement(d.Fragment,null,d.createElement("primitive",Z({object:c,ref:a},r),d.createElement(ac.Provider,{value:l},n)))}),GE=d.forwardRef(({strength:s=.5,subtract:e=12,color:t,...i},n)=>{const{getParent:r}=d.useContext(ac),o=d.useMemo(()=>r(),[r]),a=d.useRef(null);d.useImperativeHandle(n,()=>a.current,[]);const c=new _;return ee(l=>{!o.current||!a.current||(a.current.getWorldPosition(c),o.current.addBall(.5+c.x*.5,.5+c.y*.5,.5+c.z*.5,s,e,t))}),d.createElement("group",Z({ref:a},i))}),$E=d.forwardRef(({planeType:s="x",strength:e=.5,subtract:t=12,...i},n)=>{const{getParent:r}=d.useContext(ac),o=d.useMemo(()=>r(),[r]),a=d.useRef(null);d.useImperativeHandle(n,()=>a.current,[]);const c=d.useMemo(()=>s==="x"?"addPlaneX":s==="y"?"addPlaneY":"addPlaneZ",[s]);return ee(()=>{!o.current||!a.current||o.current[c](e,t)}),d.createElement("group",Z({ref:a},i))});function HE(s){return Array.isArray(s)}function oa(s=[0,0,0]){return HE(s)?s:s instanceof _||s instanceof pi?[s.x,s.y,s.z]:[s,s,s]}const KE=d.forwardRef(function({debug:e,depthTest:t=!1,polygonOffsetFactor:i=-10,map:n,mesh:r,children:o,position:a,rotation:c,scale:l,...u},h){const f=d.useRef(null);d.useImperativeHandle(h,()=>f.current);const m=d.useRef(null),p=d.useRef({position:new _,rotation:new pi,scale:new _(1,1,1)});return d.useLayoutEffect(()=>{const g=r?.current||f.current.parent,y=f.current;if(!(g instanceof oe))throw new Error('Decal must have a Mesh as parent or specify its "mesh" prop');if(g){ui(p.current,{position:a,scale:l});const v=g.matrixWorld.clone();if(g.matrixWorld.identity(),!c||typeof c=="number"){const E=new Ve;E.position.copy(p.current.position);const x=g.geometry.attributes.position.array;g.geometry.attributes.normal===void 0&&g.geometry.computeVertexNormals();const T=g.geometry.attributes.normal.array;let A=1/0,C=new _;const b=E.position.x,R=E.position.y,I=E.position.z,w=x.length;let M=-1;for(let P=0;P<w;P+=3){const O=x[P],z=x[P+1],D=x[P+2],F=O-b,k=z-R,$=D-I,U=F*F+k*k+$*$;U<A&&(A=U,M=P)}C.fromArray(T,M),E.lookAt(E.position.clone().add(C)),E.rotateZ(Math.PI),E.rotateY(Math.PI),typeof c=="number"&&E.rotateZ(c),ui(p.current,{rotation:E.rotation})}else ui(p.current,{rotation:c});return m.current&&ui(m.current,p.current),y.geometry=new e2(g,p.current.position,p.current.rotation,p.current.scale),g.matrixWorld=v,()=>{y.geometry.dispose()}}},[r,...oa(a),...oa(l),...oa(c)]),d.useLayoutEffect(()=>{m.current&&m.current.traverse(g=>g.raycast=()=>null)},[e]),d.createElement("mesh",Z({ref:f,"material-transparent":!0,"material-polygonOffset":!0,"material-polygonOffsetFactor":i,"material-depthTest":t,"material-map":n},u),o,e&&d.createElement("mesh",{ref:m},d.createElement("boxGeometry",null),d.createElement("meshNormalMaterial",{wireframe:!0}),d.createElement("axesHelper",null)))}),VE=d.forwardRef(function({src:e,skipFill:t,skipStrokes:i,fillMaterial:n,strokeMaterial:r,fillMeshProps:o,strokeMeshProps:a,...c},l){const u=je(Po,e.startsWith("<svg")?`data:image/svg+xml;utf8,${e}`:e),h=d.useMemo(()=>i?[]:u.paths.map(m=>{var p;return((p=m.userData)==null?void 0:p.style.stroke)===void 0||m.userData.style.stroke==="none"?null:m.subPaths.map(g=>Po.pointsToStroke(g.getPoints(),m.userData.style))}),[u,i]);d.useEffect(()=>()=>h.forEach(m=>m&&m.map(p=>p.dispose())),[h]);let f=0;return d.createElement("object3D",Z({ref:l},c),d.createElement("object3D",{scale:[1,-1,1]},u.paths.map((m,p)=>{var g,y;return d.createElement(d.Fragment,{key:p},!t&&((g=m.userData)==null?void 0:g.style.fill)!==void 0&&m.userData.style.fill!=="none"&&Po.createShapes(m).map((v,E)=>d.createElement("mesh",Z({key:E},o,{renderOrder:f++}),d.createElement("shapeGeometry",{args:[v]}),d.createElement("meshBasicMaterial",Z({color:m.userData.style.fill,opacity:m.userData.style.fillOpacity,transparent:!0,side:dt,depthWrite:!1},n)))),!i&&((y=m.userData)==null?void 0:y.style.stroke)!==void 0&&m.userData.style.stroke!=="none"&&m.subPaths.map((v,E)=>d.createElement("mesh",Z({key:E,geometry:h[p][E]},a,{renderOrder:f++}),d.createElement("meshBasicMaterial",Z({color:m.userData.style.stroke,opacity:m.userData.style.strokeOpacity,transparent:!0,side:dt,depthWrite:!1},r)))))})))});let qs=null,wm="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function Im(s=!0,e=!0,t){return i=>{t&&t(i),s&&(qs||(qs=new t2),qs.setDecoderPath(typeof s=="string"?s:wm),i.setDRACOLoader(qs)),e&&i.setMeshoptDecoder(typeof Do=="function"?Do():Do)}}const As=(s,e,t,i)=>je(Il,s,Im(e,t,i));As.preload=(s,e,t,i)=>je.preload(Il,s,Im(e,t,i));As.clear=s=>je.clear(Il,s);As.setDecoderPath=s=>{wm=s};const jE=d.forwardRef(({src:s,useDraco:e,useMeshOpt:t,extendLoader:i,...n},r)=>{const{scene:o}=As(s,e,t,i);return d.createElement(ys,Z({ref:r},n,{object:o}))});function WE({renderIndex:s=1,bgColor:e="black",fgColor:t="white",characters:i=" .:-+*=%@#",invert:n=!0,color:r=!1,resolution:o=.15}){const{size:a,gl:c,scene:l,camera:u}=H(),h=d.useMemo(()=>{const f=new i2(c,i,{invert:n,color:r,resolution:o});return f.domElement.style.position="absolute",f.domElement.style.top="0px",f.domElement.style.left="0px",f.domElement.style.pointerEvents="none",f},[i,n,r,o]);return d.useLayoutEffect(()=>{h.domElement.style.color=t,h.domElement.style.backgroundColor=e},[t,e]),d.useEffect(()=>(c.domElement.style.opacity="0",c.domElement.parentNode.appendChild(h.domElement),()=>{c.domElement.style.opacity="1",c.domElement.parentNode.removeChild(h.domElement)}),[h]),d.useEffect(()=>{h.setSize(a.width,a.height)},[h,a]),ee(f=>{h.render(l,u)},s),d.createElement(d.Fragment,null)}const ah=xi({alphaTest:0,viewport:new de(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},`
    precision highp sampler2D;
    precision highp usampler2D;
    out vec4 vColor;
    out vec3 vPosition;
    uniform vec2 resolution;
    uniform vec2 viewport;
    uniform float focal;
    attribute uint splatIndex;
    uniform sampler2D centerAndScaleTexture;
    uniform usampler2D covAndColorTexture;    

    vec2 unpackInt16(in uint value) {
      int v = int(value);
      int v0 = v >> 16;
      int v1 = (v & 0xFFFF);
      if((v & 0x8000) != 0)
        v1 |= 0xFFFF0000;
      return vec2(float(v1), float(v0));
    }

    void main () {
      ivec2 texSize = textureSize(centerAndScaleTexture, 0);
      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));
      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);
      vec4 center = vec4(centerAndScaleData.xyz, 1);
      vec4 camspace = modelViewMatrix * center;
      vec4 pos2d = projectionMatrix * camspace;

      float bounds = 1.2 * pos2d.w;
      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds
        || pos2d.y < -bounds || pos2d.y > bounds) {
        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);
        return;
      }

      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);
      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;
      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;
      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;
      mat3 Vrk = mat3(
        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,
        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,
        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y
      );

      mat3 J = mat3(
        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),
        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),
        0., 0., 0.
      );

      mat3 W = transpose(mat3(modelViewMatrix));
      mat3 T = W * J;
      mat3 cov = transpose(T) * Vrk * T;
      vec2 vCenter = vec2(pos2d) / pos2d.w;
      float diagonal1 = cov[0][0] + 0.3;
      float offDiagonal = cov[0][1];
      float diagonal2 = cov[1][1] + 0.3;
      float mid = 0.5 * (diagonal1 + diagonal2);
      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
      float lambda1 = mid + radius;
      float lambda2 = max(mid - radius, 0.1);
      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);
      uint colorUint = covAndColorData.w;
      vColor = vec4(
        float(colorUint & uint(0xFF)) / 255.0,
        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,
        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,
        float(colorUint >> uint(24)) / 255.0
      );
      vPosition = position;

      gl_Position = vec4(
        vCenter 
          + position.x * v2 / viewport * 2.0 
          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);
    }
    `,`
    #include <alphatest_pars_fragment>
    #include <alphahash_pars_fragment>
    in vec4 vColor;
    in vec3 vPosition;
    void main () {
      float A = -dot(vPosition.xy, vPosition.xy);
      if (A < -4.0) discard;
      float B = exp(A) * vColor.a;
      vec4 diffuseColor = vec4(vColor.rgb, B);
      #include <alphatest_fragment>
      #include <alphahash_fragment>
      gl_FragColor = diffuseColor;
      #include <tonemapping_fragment>
      #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `);function XE(s){let e=null,t=0;function i(n,r=!1){const o=e.length/16,a=-1e-4;let c=-1/0,l=1/0;const u=new Float32Array(o),h=new Int32Array(u.buffer),f=new Int32Array(o);let m=0;for(let E=0;E<o;E++){const x=n[0]*e[E*16+12]+n[1]*e[E*16+13]+n[2]*e[E*16+14]+n[3];(r||x<0&&e[E*16+15]>a*x)&&(u[m]=x,f[m]=E,m++,x>c&&(c=x),x<l&&(l=x))}const p=(256*256-1)/(c-l),g=new Uint32Array(256*256);for(let E=0;E<m;E++)h[E]=(u[E]-l)*p|0,g[h[E]]++;const y=new Uint32Array(256*256);for(let E=1;E<256*256;E++)y[E]=y[E-1]+g[E-1];const v=new Uint32Array(m);for(let E=0;E<m;E++)v[y[h[E]]++]=f[E];return v}s.onmessage=n=>{if(n.data.method=="push"){t===0&&(e=new Float32Array(n.data.length));const r=new Float32Array(n.data.matrices);e.set(r,t),t+=r.length}else if(n.data.method=="sort"&&e!==null){const r=i(new Float32Array(n.data.view),n.data.hashed);s.postMessage({indices:r,key:n.data.key},[r.buffer])}}}class YE extends qg{constructor(...e){super(...e),this.gl=null,this.chunkSize=25e3}load(e,t,i,n){const r={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",XE.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(o,a,c)=>qE(a,r,o,c),connect:o=>ZE(r,o),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:i};QE(r).then(t).catch(o=>{n?.(o),r.manager.itemError(r.url)})}}async function QE(s){s.manager.itemStart(s.url);const e=await fetch(s.url);if(e.body===null)throw"Failed to fetch file";let t=e.headers.get("Content-Length");const i=t?parseInt(t):void 0;if(i==null)throw"Failed to get content length";s.stream=e.body.getReader(),s.totalDownloadBytes=i,s.numVertices=Math.floor(s.totalDownloadBytes/s.rowLength);const n=s.gl.getContext();let r=n.getParameter(n.MAX_TEXTURE_SIZE);return s.maxVertexes=r*r,s.numVertices>s.maxVertexes&&(s.numVertices=s.maxVertexes),s.bufferTextureWidth=r,s.bufferTextureHeight=Math.floor((s.numVertices-1)/r)+1,s.centerAndScaleData=new Float32Array(s.bufferTextureWidth*s.bufferTextureHeight*4),s.covAndColorData=new Uint32Array(s.bufferTextureWidth*s.bufferTextureHeight*4),s.centerAndScaleTexture=new Ic(s.centerAndScaleData,s.bufferTextureWidth,s.bufferTextureHeight,Sl,Ar),s.centerAndScaleTexture.needsUpdate=!0,s.covAndColorTexture=new Ic(s.covAndColorData,s.bufferTextureWidth,s.bufferTextureHeight,Zg,e1),s.covAndColorTexture.internalFormat="RGBA32UI",s.covAndColorTexture.needsUpdate=!0,s}async function JE(s){s.loading=!0;let e=0,t=0;const i=[];let n=0;const r=s.totalDownloadBytes!==0;for(;;)try{const{value:o,done:a}=await s.stream.read();if(a)break;if(e+=o.length,s.totalDownloadBytes!=null){const l=e/s.totalDownloadBytes*100;if(s.onProgress&&l-n>1){const u=new ProgressEvent("progress",{lengthComputable:r,loaded:e,total:s.totalDownloadBytes});s.onProgress(u),n=l}}i.push(o);const c=e-t;if(s.totalDownloadBytes!=null&&c>s.rowLength*s.chunkSize){let l=Math.floor(c/s.rowLength);const u=new Uint8Array(c);let h=0;for(const p of i)u.set(p,h),h+=p.length;if(i.length=0,c>l*s.rowLength){const p=new Uint8Array(c-l*s.rowLength);p.set(u.subarray(c-p.length,c),0),i.push(p)}const f=new Uint8Array(l*s.rowLength);f.set(u.subarray(0,f.byteLength),0);const m=lh(s,f.buffer,l);if(s.worker.postMessage({method:"push",src:s.url,length:s.numVertices*16,matrices:m.buffer},[m.buffer]),t+=l*s.rowLength,s.onProgress){const p=new ProgressEvent("progress",{lengthComputable:r,loaded:s.totalDownloadBytes,total:s.totalDownloadBytes});s.onProgress(p)}}}catch(o){console.error(o);break}if(e-t>0){let o=new Uint8Array(i.reduce((u,h)=>u+h.length,0)),a=0;for(const u of i)o.set(u,a),a+=u.length;let c=Math.floor(o.byteLength/s.rowLength);const l=lh(s,o.buffer,c);s.worker.postMessage({method:"push",src:s.url,length:c*16,matrices:l.buffer},[l.buffer])}s.loaded=!0,s.manager.itemEnd(s.url)}function qE(s,e,t,i){if(s.updateMatrixWorld(),e.gl.getCurrentViewport(t.viewport),t.material.viewport.x=t.viewport.z,t.material.viewport.y=t.viewport.w,t.material.focal=t.viewport.w/2*Math.abs(s.projectionMatrix.elements[5]),t.ready){if(i&&t.sorted)return;t.ready=!1;const n=new Float32Array([t.modelViewMatrix.elements[2],-t.modelViewMatrix.elements[6],t.modelViewMatrix.elements[10],t.modelViewMatrix.elements[14]]);e.worker.postMessage({method:"sort",src:e.url,key:t.uuid,view:n.buffer,hashed:i},[n.buffer]),i&&e.loaded&&(t.sorted=!0)}}function ZE(s,e){s.loading||JE(s),e.ready=!1,e.pm=new re,e.vm1=new re,e.vm2=new re,e.viewport=new Qi;let t=new Uint32Array(s.bufferTextureWidth*s.bufferTextureHeight);const i=new Ga(t,1,!1);i.setUsage(hi);const n=e.geometry=new t1,r=new Float32Array(18),o=new fi(r,3);n.setAttribute("position",o),o.setXYZ(2,-2,2,0),o.setXYZ(1,2,2,0),o.setXYZ(0,-2,-2,0),o.setXYZ(5,-2,-2,0),o.setXYZ(4,2,2,0),o.setXYZ(3,2,-2,0),o.needsUpdate=!0,n.setAttribute("splatIndex",i),n.instanceCount=1;function a(l){if(e&&l.data.key===e.uuid){let u=new Uint32Array(l.data.indices);n.attributes.splatIndex.set(u),n.attributes.splatIndex.needsUpdate=!0,n.instanceCount=u.length,e.ready=!0}}s.worker.addEventListener("message",a);async function c(){for(;;){const l=s.gl.properties.get(s.centerAndScaleTexture),u=s.gl.properties.get(s.covAndColorTexture);if(l!=null&&l.__webglTexture&&u!=null&&u.__webglTexture&&s.loadedVertexCount>0)break;await new Promise(h=>setTimeout(h,10))}e.ready=!0}return c(),()=>s.worker.removeEventListener("message",a)}function lh(s,e,t){const i=s.gl.getContext();if(s.loadedVertexCount+t>s.maxVertexes&&(t=s.maxVertexes-s.loadedVertexCount),t<=0)throw"Failed to parse file";const n=new Uint8Array(e),r=new Float32Array(e),o=new Float32Array(t*16),a=new Uint8Array(s.covAndColorData.buffer),c=new Int16Array(s.covAndColorData.buffer);for(let l=0;l<t;l++){const u=new ue(-(n[32*l+28+1]-128)/128,(n[32*l+28+2]-128)/128,(n[32*l+28+3]-128)/128,-(n[32*l+28+0]-128)/128);u.invert();const h=new _(r[8*l+0],r[8*l+1],-r[8*l+2]),f=new _(r[8*l+3+0],r[8*l+3+1],r[8*l+3+2]),m=new re;m.makeRotationFromQuaternion(u),m.transpose(),m.scale(f);const p=m.clone();m.transpose(),m.premultiply(p),m.setPosition(h);const g=[0,1,2,5,6,10];let y=0;for(let x=0;x<g.length;x++)Math.abs(m.elements[g[x]])>y&&(y=Math.abs(m.elements[g[x]]));let v=s.loadedVertexCount*4+l*4;s.centerAndScaleData[v+0]=h.x,s.centerAndScaleData[v+1]=-h.y,s.centerAndScaleData[v+2]=h.z,s.centerAndScaleData[v+3]=y/32767,v=s.loadedVertexCount*8+l*4*2;for(let x=0;x<g.length;x++)c[v+x]=m.elements[g[x]]*32767/y;v=s.loadedVertexCount*16+(l*4+3)*4;const E=new we(n[32*l+24+0]/255,n[32*l+24+1]/255,n[32*l+24+2]/255);E.convertSRGBToLinear(),a[v+0]=E.r*255,a[v+1]=E.g*255,a[v+2]=E.b*255,a[v+3]=n[32*l+24+3],m.elements[15]=Math.max(f.x,f.y,f.z)*n[32*l+24+3]/255;for(let x=0;x<16;x++)o[l*16+x]=m.elements[x]}for(;t>0;){let l=0,u=0;const h=s.loadedVertexCount%s.bufferTextureWidth,f=Math.floor(s.loadedVertexCount/s.bufferTextureWidth);s.loadedVertexCount%s.bufferTextureWidth!=0?(l=Math.min(s.bufferTextureWidth,h+t)-h,u=1):Math.floor(t/s.bufferTextureWidth)>0?(l=s.bufferTextureWidth,u=Math.floor(t/s.bufferTextureWidth)):(l=t%s.bufferTextureWidth,u=1);const m=s.gl.properties.get(s.centerAndScaleTexture);i.bindTexture(i.TEXTURE_2D,m.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,l,u,i.RGBA,i.FLOAT,s.centerAndScaleData,s.loadedVertexCount*4);const p=s.gl.properties.get(s.covAndColorTexture);i.bindTexture(i.TEXTURE_2D,p.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,l,u,i.RGBA_INTEGER,i.UNSIGNED_INT,s.covAndColorData,s.loadedVertexCount*4),s.gl.resetState(),s.loadedVertexCount+=l*u,t-=l*u}return o}function e5({src:s,toneMapped:e=!1,alphaTest:t=0,alphaHash:i=!1,chunkSize:n=25e3,...r}){ft({SplatMaterial:ah});const o=d.useRef(null),a=H(u=>u.gl),c=H(u=>u.camera),l=je(YE,s,u=>{u.gl=a,u.chunkSize=n});return d.useLayoutEffect(()=>l.connect(o.current),[s]),ee(()=>l.update(o.current,c,i)),d.createElement("mesh",Z({ref:o,frustumCulled:!1},r),d.createElement("splatMaterial",{key:`${s}/${t}/${i}${ah.key}`,transparent:!i,depthTest:!0,alphaTest:i?0:t,centerAndScaleTexture:l.centerAndScaleTexture,covAndColorTexture:l.covAndColorTexture,depthWrite:i?!0:t>0,blending:i?Qg:Jg,blendSrcAlpha:Yg,alphaHash:!!i,toneMapped:e}))}const t5=s=>typeof s=="function",_m=d.forwardRef(({envMap:s,resolution:e=256,frames:t=1/0,children:i,makeDefault:n,...r},o)=>{const a=H(({set:y})=>y),c=H(({camera:y})=>y),l=H(({size:y})=>y),u=d.useRef(null);d.useImperativeHandle(o,()=>u.current,[]);const h=d.useRef(null),f=Di(e);d.useLayoutEffect(()=>{r.manual||u.current.updateProjectionMatrix()},[l,r]),d.useLayoutEffect(()=>{u.current.updateProjectionMatrix()}),d.useLayoutEffect(()=>{if(n){const y=c;return a(()=>({camera:u.current})),()=>a(()=>({camera:y}))}},[u,n,a]);let m=0,p=null;const g=t5(i);return ee(y=>{g&&(t===1/0||m<t)&&(h.current.visible=!1,y.gl.setRenderTarget(f),p=y.scene.background,s&&(y.scene.background=s),y.gl.render(y.scene,u.current),y.scene.background=p,y.gl.setRenderTarget(null),h.current.visible=!0,m++)}),d.createElement(d.Fragment,null,d.createElement("orthographicCamera",Z({left:l.width/-2,right:l.width/2,top:l.height/2,bottom:l.height/-2,ref:u},r),!g&&i),d.createElement("group",{ref:h},g&&i(f.texture)))}),i5=s=>typeof s=="function",n5=d.forwardRef(({envMap:s,resolution:e=256,frames:t=1/0,makeDefault:i,children:n,...r},o)=>{const a=H(({set:y})=>y),c=H(({camera:y})=>y),l=H(({size:y})=>y),u=d.useRef(null);d.useImperativeHandle(o,()=>u.current,[]);const h=d.useRef(null),f=Di(e);d.useLayoutEffect(()=>{r.manual||(u.current.aspect=l.width/l.height)},[l,r]),d.useLayoutEffect(()=>{u.current.updateProjectionMatrix()});let m=0,p=null;const g=i5(n);return ee(y=>{g&&(t===1/0||m<t)&&(h.current.visible=!1,y.gl.setRenderTarget(f),p=y.scene.background,s&&(y.scene.background=s),y.gl.render(y.scene,u.current),y.scene.background=p,y.gl.setRenderTarget(null),h.current.visible=!0,m++)}),d.useLayoutEffect(()=>{if(i){const y=c;return a(()=>({camera:u.current})),()=>a(()=>({camera:y}))}},[u,i,a]),d.createElement(d.Fragment,null,d.createElement("perspectiveCamera",Z({ref:u},r),!g&&n),d.createElement("group",{ref:h},g&&n(f.texture)))});function Lm({resolution:s=256,near:e=.1,far:t=1e3,envMap:i,fog:n}={}){const r=H(({gl:f})=>f),o=H(({scene:f})=>f),a=d.useMemo(()=>{const f=new Tl(s);return f.texture.type=tn,f},[s]);d.useEffect(()=>()=>{a.dispose()},[a]);const c=d.useMemo(()=>new Yd(e,t,a),[e,t,a]);let l,u;const h=d.useCallback(()=>{l=o.fog,u=o.background,o.background=i||u,o.fog=n||l,c.update(r,o),o.fog=l,o.background=u},[r,o,c]);return{fbo:a,camera:c,update:h}}function s5({children:s,frames:e=1/0,resolution:t,near:i,far:n,envMap:r,fog:o,...a}){const c=d.useRef(null),{fbo:l,camera:u,update:h}=Lm({resolution:t,near:i,far:n,envMap:r,fog:o});let f=0;return ee(()=>{c.current&&(e===1/0||f<e)&&(c.current.visible=!1,h(),c.current.visible=!0,f++)}),d.createElement("group",a,d.createElement("primitive",{object:u}),d.createElement("group",{ref:c},s?.(l.texture)))}const r5=d.forwardRef((s,e)=>{const{camera:t,onChange:i,makeDefault:n,...r}=s,o=H(f=>f.camera),a=H(f=>f.invalidate),c=H(f=>f.get),l=H(f=>f.set),u=t||o,h=d.useMemo(()=>new w2(u),[u]);return d.useEffect(()=>{const f=m=>{a(),i&&i(m)};return h==null||h.addEventListener==null||h.addEventListener("change",f),()=>h==null||h.removeEventListener==null?void 0:h.removeEventListener("change",f)},[i,h,a]),ee(()=>h?.update(),-1),d.useEffect(()=>{const f=h;return f?.connect(),()=>f?.dispose()},[h]),d.useEffect(()=>{if(n){const f=c().controls;return l({controls:h}),()=>l({controls:f})}},[n,h]),h?d.createElement("primitive",Z({ref:e,object:h},r)):null}),o5=d.forwardRef(({domElement:s,...e},t)=>{const{onChange:i,makeDefault:n,...r}=e,o=H(p=>p.invalidate),a=H(p=>p.camera),c=H(p=>p.gl),l=H(p=>p.events),u=H(p=>p.get),h=H(p=>p.set),f=s||l.connected||c.domElement,m=d.useMemo(()=>new k2(a),[a]);return d.useEffect(()=>(m.connect(f),()=>void m.dispose()),[f,m,o]),d.useEffect(()=>{const p=g=>{o(),i&&i(g)};return m.addEventListener==null||m.addEventListener("change",p),()=>m.removeEventListener==null?void 0:m.removeEventListener("change",p)},[i,o]),d.useEffect(()=>{if(n){const p=u().controls;return h({controls:m}),()=>h({controls:p})}},[n,m]),ee((p,g)=>m.update(g)),d.createElement("primitive",Z({ref:t,object:m,args:[a,f]},r))}),a5=d.forwardRef((s={enableDamping:!0},e)=>{const{domElement:t,camera:i,makeDefault:n,onChange:r,onStart:o,onEnd:a,...c}=s,l=H(E=>E.invalidate),u=H(E=>E.camera),h=H(E=>E.gl),f=H(E=>E.events),m=H(E=>E.set),p=H(E=>E.get),g=t||f.connected||h.domElement,y=i||u,v=d.useMemo(()=>new n2(y),[y]);return d.useEffect(()=>{v.connect(g);const E=x=>{l(),r&&r(x)};return v.addEventListener("change",E),o&&v.addEventListener("start",o),a&&v.addEventListener("end",a),()=>{v.dispose(),v.removeEventListener("change",E),o&&v.removeEventListener("start",o),a&&v.removeEventListener("end",a)}},[r,o,a,v,l,g]),d.useEffect(()=>{if(n){const E=p().controls;return m({controls:v}),()=>m({controls:E})}},[n,v]),ee(()=>v.update(),-1),d.createElement("primitive",Z({ref:e,object:v,enableDamping:!0},c))}),l5=d.forwardRef(({makeDefault:s,camera:e,regress:t,domElement:i,enableDamping:n=!0,keyEvents:r=!1,onChange:o,onStart:a,onEnd:c,...l},u)=>{const h=H(C=>C.invalidate),f=H(C=>C.camera),m=H(C=>C.gl),p=H(C=>C.events),g=H(C=>C.setEvents),y=H(C=>C.set),v=H(C=>C.get),E=H(C=>C.performance),x=e||f,T=i||p.connected||m.domElement,A=d.useMemo(()=>new s2(x),[x]);return ee(()=>{A.enabled&&A.update()},-1),d.useEffect(()=>(r&&A.connect(r===!0?T:r),A.connect(T),()=>void A.dispose()),[r,T,t,A,h]),d.useEffect(()=>{const C=I=>{h(),t&&E.regress(),o&&o(I)},b=I=>{a&&a(I)},R=I=>{c&&c(I)};return A.addEventListener("change",C),A.addEventListener("start",b),A.addEventListener("end",R),()=>{A.removeEventListener("start",b),A.removeEventListener("end",R),A.removeEventListener("change",C)}},[o,a,c,A,h,g]),d.useEffect(()=>{if(s){const C=v().controls;return y({controls:A}),()=>y({controls:C})}},[s,A]),d.createElement("primitive",Z({ref:u,object:A,enableDamping:n},l))}),c5=d.forwardRef(({makeDefault:s,camera:e,domElement:t,regress:i,onChange:n,onStart:r,onEnd:o,...a},c)=>{const{invalidate:l,camera:u,gl:h,events:f,set:m,get:p,performance:g,viewport:y}=H(),v=e||u,E=t||f.connected||h.domElement,x=d.useMemo(()=>new L2(v),[v]);return ee(()=>{x.enabled&&x.update()},-1),d.useEffect(()=>(x.connect(E),()=>void x.dispose()),[E,i,x,l]),d.useEffect(()=>{const T=A=>{l(),i&&g.regress(),n&&n(A)};return x.addEventListener("change",T),r&&x.addEventListener("start",r),o&&x.addEventListener("end",o),()=>{r&&x.removeEventListener("start",r),o&&x.removeEventListener("end",o),x.removeEventListener("change",T)}},[n,r,o,x,l]),d.useEffect(()=>{x.handleResize()},[y]),d.useEffect(()=>{if(s){const T=p().controls;return m({controls:x}),()=>m({controls:T})}},[s,x]),d.createElement("primitive",Z({ref:c,object:x},a))}),u5=d.forwardRef(({camera:s,makeDefault:e,regress:t,domElement:i,onChange:n,onStart:r,onEnd:o,...a},c)=>{const l=H(x=>x.invalidate),u=H(x=>x.camera),h=H(x=>x.gl),f=H(x=>x.events),m=H(x=>x.set),p=H(x=>x.get),g=H(x=>x.performance),y=s||u,v=i||f.connected||h.domElement,E=d.useMemo(()=>new D2(y),[y]);return ee(()=>{E.enabled&&E.update()},-1),d.useEffect(()=>(E.connect(v),()=>void E.dispose()),[v,t,E,l]),d.useEffect(()=>{const x=T=>{l(),t&&g.regress(),n&&n(T)};return E.addEventListener("change",x),r&&E.addEventListener("start",r),o&&E.addEventListener("end",o),()=>{E.removeEventListener("change",x),r&&E.removeEventListener("start",r),o&&E.removeEventListener("end",o)}},[n,r,o]),d.useEffect(()=>{if(e){const x=p().controls;return m({controls:E}),()=>m({controls:x})}},[e,E]),d.createElement("primitive",Z({ref:c,object:E},a))}),h5=d.forwardRef(({children:s,domElement:e,onChange:t,onMouseDown:i,onMouseUp:n,onObjectChange:r,object:o,makeDefault:a,camera:c,enabled:l,axis:u,mode:h,translationSnap:f,rotationSnap:m,scaleSnap:p,space:g,size:y,showX:v,showY:E,showZ:x,...T},A)=>{const C=H(B=>B.controls),b=H(B=>B.gl),R=H(B=>B.events),I=H(B=>B.camera),w=H(B=>B.invalidate),M=H(B=>B.get),P=H(B=>B.set),O=c||I,z=e||R.connected||b.domElement,D=d.useMemo(()=>new g2(O,z),[O,z]),F=d.useRef(null);d.useLayoutEffect(()=>(o?D.attach(o instanceof Ve?o:o.current):F.current instanceof Ve&&D.attach(F.current),()=>void D.detach()),[o,s,D]),d.useEffect(()=>{if(C){const B=G=>C.enabled=!G.value;return D.addEventListener("dragging-changed",B),()=>D.removeEventListener("dragging-changed",B)}},[D,C]);const k=d.useRef(void 0),$=d.useRef(void 0),U=d.useRef(void 0),N=d.useRef(void 0);return d.useLayoutEffect(()=>void(k.current=t),[t]),d.useLayoutEffect(()=>void($.current=i),[i]),d.useLayoutEffect(()=>void(U.current=n),[n]),d.useLayoutEffect(()=>void(N.current=r),[r]),d.useEffect(()=>{const B=X=>{w(),k.current==null||k.current(X)},G=X=>$.current==null?void 0:$.current(X),j=X=>U.current==null?void 0:U.current(X),L=X=>N.current==null?void 0:N.current(X);return D.addEventListener("change",B),D.addEventListener("mouseDown",G),D.addEventListener("mouseUp",j),D.addEventListener("objectChange",L),()=>{D.removeEventListener("change",B),D.removeEventListener("mouseDown",G),D.removeEventListener("mouseUp",j),D.removeEventListener("objectChange",L)}},[w,D]),d.useEffect(()=>{if(a){const B=M().controls;return P({controls:D}),()=>P({controls:B})}},[a,D]),d.createElement(d.Fragment,null,d.createElement("primitive",{ref:A,object:D,enabled:l,axis:u,mode:h,translationSnap:f,rotationSnap:m,scaleSnap:p,space:g,size:y,showX:v,showY:E,showZ:x}),d.createElement("group",Z({ref:F},T),s))}),d5=d.forwardRef(({domElement:s,selector:e,onChange:t,onLock:i,onUnlock:n,enabled:r=!0,makeDefault:o,...a},c)=>{const{camera:l,...u}=a,h=H(A=>A.setEvents),f=H(A=>A.gl),m=H(A=>A.camera),p=H(A=>A.invalidate),g=H(A=>A.events),y=H(A=>A.get),v=H(A=>A.set),E=l||m,x=s||g.connected||f.domElement,T=d.useMemo(()=>new b2(E),[E]);return d.useEffect(()=>{if(r){T.connect(x);const A=y().events.compute;return h({compute(C,b){const R=b.size.width/2,I=b.size.height/2;b.pointer.set(R/b.size.width*2-1,-(I/b.size.height)*2+1),b.raycaster.setFromCamera(b.pointer,b.camera)}}),()=>{T.disconnect(),h({compute:A})}}},[r,T]),d.useEffect(()=>{const A=R=>{p(),t&&t(R)};T.addEventListener("change",A),i&&T.addEventListener("lock",i),n&&T.addEventListener("unlock",n);const C=()=>T.lock(),b=e?Array.from(document.querySelectorAll(e)):[document];return b.forEach(R=>R&&R.addEventListener("click",C)),()=>{T.removeEventListener("change",A),i&&T.removeEventListener("lock",i),n&&T.removeEventListener("unlock",n),b.forEach(R=>R?R.removeEventListener("click",C):void 0)}},[t,i,n,e,T,p]),d.useEffect(()=>{if(o){const A=y().controls;return v({controls:T}),()=>v({controls:A})}},[o,T]),d.createElement("primitive",Z({ref:c,object:T},u))}),f5=d.forwardRef(({domElement:s,makeDefault:e,...t},i)=>{const n=H(h=>h.camera),r=H(h=>h.gl),o=H(h=>h.events),a=H(h=>h.get),c=H(h=>h.set),l=s||o.connected||r.domElement,[u]=d.useState(()=>new f2(n,l));return d.useEffect(()=>{if(e){const h=a().controls;return c({controls:u}),()=>c({controls:h})}},[e,u]),ee((h,f)=>{u.update(f)},-1),u?d.createElement("primitive",Z({ref:i,object:u},t)):null}),m5=d.forwardRef((s,e)=>{const{impl:t,camera:i,domElement:n,makeDefault:r,onControlStart:o,onControl:a,onControlEnd:c,onTransitionStart:l,onUpdate:u,onWake:h,onRest:f,onSleep:m,onStart:p,onEnd:g,onChange:y,regress:v,...E}=s,x=t??Ef;d.useMemo(()=>{const D={Box3:gi,MathUtils:{clamp:me.clamp},Matrix4:re,Quaternion:ue,Raycaster:Fi,Sphere:yi,Spherical:El,Vector2:de,Vector3:_,Vector4:Qi};x.install({THREE:D}),ft({CameraControlsImpl:x})},[x]);const T=H(D=>D.camera),A=H(D=>D.gl),C=H(D=>D.invalidate),b=H(D=>D.events),R=H(D=>D.setEvents),I=H(D=>D.set),w=H(D=>D.get),M=H(D=>D.performance),P=i||T,O=n||b.connected||A.domElement,z=d.useMemo(()=>new x(P),[x,P]);return ee((D,F)=>{z.update(F)},-1),d.useEffect(()=>(z.connect(O),()=>void z.disconnect()),[O,z]),d.useEffect(()=>{function D(){C(),v&&M.regress()}const F=L=>{D(),o?.(L),p?.(L)},k=L=>{D(),a?.(L),y?.(L)},$=L=>{c?.(L),g?.(L)},U=L=>{D(),l?.(L),y?.(L)},N=L=>{D(),u?.(L),y?.(L)},B=L=>{D(),h?.(L),y?.(L)},G=L=>{f?.(L)},j=L=>{m?.(L)};return z.addEventListener("controlstart",F),z.addEventListener("control",k),z.addEventListener("controlend",$),z.addEventListener("transitionstart",U),z.addEventListener("update",N),z.addEventListener("wake",B),z.addEventListener("rest",G),z.addEventListener("sleep",j),()=>{z.removeEventListener("controlstart",F),z.removeEventListener("control",k),z.removeEventListener("controlend",$),z.removeEventListener("transitionstart",U),z.removeEventListener("update",N),z.removeEventListener("wake",B),z.removeEventListener("rest",G),z.removeEventListener("sleep",j)}},[z,C,R,v,M,o,a,c,l,u,h,f,m,y,p,g]),d.useEffect(()=>{if(r){const D=w().controls;return I({controls:z}),()=>I({controls:D})}},[r,z]),d.createElement("primitive",Z({ref:e,object:z},E))}),p5=s=>s?.current instanceof Ve,Pm=d.createContext(null);function Mm(){const s=d.useContext(Pm);if(!s)throw new Error("useMotion hook must be used in a MotionPathControls component.");return s}function g5({points:s=50,color:e="black"}){const{path:t}=Mm(),[i,n]=d.useState([]),r=d.useMemo(()=>new On({color:e}),[e]),o=d.useMemo(()=>new Yr(.025,16,16),[]),a=d.useRef([]);return d.useEffect(()=>{t.curves!==a.current&&(n(t.getPoints(s)),a.current=t.curves)}),i.map((c,l)=>d.createElement("mesh",{key:l,material:r,geometry:o,position:[c.x,c.y,c.z]}))}const y5=d.forwardRef(({children:s,curves:e=[],debug:t=!1,debugColor:i="black",object:n,focus:r,loop:o=!0,offset:a=void 0,smooth:c=!1,eps:l=1e-5,damping:u=.1,focusDamping:h=.1,maxSpeed:f=1/0,...m},p)=>{const{camera:g}=H(),y=d.useRef(null),v=d.useRef(a??0),E=d.useMemo(()=>new i1,[]),x=d.useMemo(()=>({focus:r,object:n?.current instanceof Ve?n:{current:g},path:E,current:v.current,offset:v.current,point:new _,tangent:new _,next:new _}),[r,n]),T=x1(y);d.useLayoutEffect(()=>{const C=T.current;E.curves=[];const b=e.length>0?e:C.children.map(R=>R.object);for(let R=0;R<b.length;R++)E.add(b[R]);if(c){const R=E.getPoints(typeof c=="number"?c:1),I=new jd(R);E.curves=[I]}E.updateArcLengths()}),d.useImperativeHandle(p,()=>Object.assign(y.current,{motion:x}),[x]),d.useLayoutEffect(()=>{v.current=Ds.repeat(v.current,1)},[a]);const A=d.useMemo(()=>new _,[]);return ee((C,b)=>{const R=x.offset;if(Mi.damp(v,"current",a!==void 0?a:x.current,u,b,f,void 0,l),x.offset=o?Ds.repeat(v.current,1):Ds.clamp(v.current,0,1),E.getCurveLengths().length>0){E.getPointAt(x.offset,x.point),E.getTangentAt(x.offset,x.tangent).normalize(),E.getPointAt(Ds.repeat(v.current-(R-x.offset),1),x.next);const I=n?.current instanceof Ve?n.current:g;I.position.copy(x.point),r&&Mi.dampLookAt(I,p5(r)?r.current.getWorldPosition(A):r,h,b,f,void 0,l)}}),d.createElement("group",Z({ref:y},m),d.createElement(Pm.Provider,{value:x},s,t&&d.createElement(g5,{color:i})))});function v5({defaultScene:s,defaultCamera:e,renderPriority:t=1}){const{gl:i,scene:n,camera:r}=H();let o;return ee(()=>{o=i.autoClear,t===1&&(i.autoClear=!0,i.render(s,e)),i.autoClear=!1,i.clearDepth(),i.render(n,r),i.autoClear=o},t),d.createElement("group",{onPointerOver:()=>null})}function Dm({children:s,renderPriority:e=1}){const{scene:t,camera:i}=H(),[n]=d.useState(()=>new nn);return d.createElement(d.Fragment,null,Ei(d.createElement(d.Fragment,null,s,d.createElement(v5,{defaultScene:t,defaultCamera:i,renderPriority:e})),n,{events:{priority:e+1}}))}const Bm=d.createContext({}),oo=()=>d.useContext(Bm),x5=2*Math.PI,aa=new Ve,ch=new re,[hn,la]=[new ue,new ue],uh=new _,hh=new _,E5=s=>"minPolarAngle"in s,dh=s=>"getTarget"in s,A5=({alignment:s="bottom-right",margin:e=[80,80],renderPriority:t=1,onUpdate:i,onTarget:n,children:r})=>{const o=H(C=>C.size),a=H(C=>C.camera),c=H(C=>C.controls),l=H(C=>C.invalidate),u=d.useRef(null),h=d.useRef(null),f=d.useRef(!1),m=d.useRef(0),p=d.useRef(new _(0,0,0)),g=d.useRef(new _(0,0,0));d.useEffect(()=>{g.current.copy(a.up),aa.up.copy(a.up)},[a]);const y=d.useCallback(C=>{f.current=!0,(c||n)&&(p.current=n?.()||(dh(c)?c.getTarget(p.current):c?.target)),m.current=a.position.distanceTo(uh),hn.copy(a.quaternion),hh.copy(C).multiplyScalar(m.current).add(uh),aa.lookAt(hh),la.copy(aa.quaternion),l()},[c,a,n,l]);ee((C,b)=>{if(h.current&&u.current){var R;if(f.current)if(hn.angleTo(la)<.01)f.current=!1,E5(c)&&a.up.copy(g.current);else{const I=b*x5;hn.rotateTowards(la,I),a.position.set(0,0,1).applyQuaternion(hn).multiplyScalar(m.current).add(p.current),a.up.set(0,1,0).applyQuaternion(hn).normalize(),a.quaternion.copy(hn),dh(c)&&c.setPosition(a.position.x,a.position.y,a.position.z),i?i():c&&c.update(b),l()}ch.copy(a.matrix).invert(),(R=u.current)==null||R.quaternion.setFromRotationMatrix(ch)}});const v=d.useMemo(()=>({tweenCamera:y}),[y]),[E,x]=e,T=s.endsWith("-center")?0:s.endsWith("-left")?-o.width/2+E:o.width/2-E,A=s.startsWith("center-")?0:s.startsWith("top-")?o.height/2-x:-o.height/2+x;return d.createElement(Dm,{renderPriority:t},d.createElement(Bm.Provider,{value:v},d.createElement(_m,{makeDefault:!0,ref:h,position:[0,0,200]}),d.createElement("group",{ref:u,position:[T,A,0]},r)))},ns={bg:"#f0f0f0",hover:"#999",text:"black",stroke:"black"},S5=["Right","Left","Top","Bottom","Front","Back"],Fm=s=>new _(...s).multiplyScalar(.38),T5=[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].map(Fm),b5=[.25,.25,.25],km=[[1,1,0],[1,0,1],[1,0,-1],[1,-1,0],[0,1,1],[0,1,-1],[0,-1,1],[0,-1,-1],[-1,1,0],[-1,0,1],[-1,0,-1],[-1,-1,0]].map(Fm),C5=km.map(s=>s.toArray().map(e=>e==0?.5:.25)),R5=({hover:s,index:e,font:t="20px Inter var, Arial, sans-serif",faces:i=S5,color:n=ns.bg,hoverColor:r=ns.hover,textColor:o=ns.text,strokeColor:a=ns.stroke,opacity:c=1})=>{const l=H(h=>h.gl),u=d.useMemo(()=>{const h=document.createElement("canvas");h.width=128,h.height=128;const f=h.getContext("2d");return f.fillStyle=n,f.fillRect(0,0,h.width,h.height),f.strokeStyle=a,f.strokeRect(0,0,h.width,h.height),f.font=t,f.textAlign="center",f.fillStyle=o,f.fillText(i[e].toUpperCase(),64,76),new Qd(h)},[e,i,t,n,o,a]);return d.createElement("meshBasicMaterial",{map:u,"map-anisotropy":l.capabilities.getMaxAnisotropy()||1,attach:`material-${e}`,color:s?r:"white",transparent:!0,opacity:c})},w5=s=>{const{tweenCamera:e}=oo(),[t,i]=d.useState(null),n=a=>{a.stopPropagation(),i(null)},r=a=>{a.stopPropagation(),e(a.face.normal)},o=a=>{a.stopPropagation(),i(Math.floor(a.faceIndex/2))};return d.createElement("mesh",{onPointerOut:n,onPointerMove:o,onClick:s.onClick||r},[...Array(6)].map((a,c)=>d.createElement(R5,Z({key:c,index:c,hover:t===c},s))),d.createElement("boxGeometry",null))},fh=({onClick:s,dimensions:e,position:t,hoverColor:i=ns.hover})=>{const{tweenCamera:n}=oo(),[r,o]=d.useState(!1),a=u=>{u.stopPropagation(),o(!1)},c=u=>{u.stopPropagation(),o(!0)},l=u=>{u.stopPropagation(),n(t)};return d.createElement("mesh",{scale:1.01,position:t,onPointerOver:c,onPointerOut:a,onClick:s||l},d.createElement("meshBasicMaterial",{color:r?i:"white",transparent:!0,opacity:.6,visible:r}),d.createElement("boxGeometry",{args:e}))},I5=s=>d.createElement("group",{scale:[60,60,60]},d.createElement(w5,s),km.map((e,t)=>d.createElement(fh,Z({key:t,position:e,dimensions:C5[t]},s))),T5.map((e,t)=>d.createElement(fh,Z({key:t,position:e,dimensions:b5},s))));function ca({scale:s=[.8,.05,.05],color:e,rotation:t}){return d.createElement("group",{rotation:t},d.createElement("mesh",{position:[.4,0,0]},d.createElement("boxGeometry",{args:s}),d.createElement("meshBasicMaterial",{color:e,toneMapped:!1})))}function dn({onClick:s,font:e,disabled:t,arcStyle:i,label:n,labelColor:r,axisHeadScale:o=1,...a}){const c=H(g=>g.gl),l=d.useMemo(()=>{const g=document.createElement("canvas");g.width=64,g.height=64;const y=g.getContext("2d");return y.beginPath(),y.arc(32,32,16,0,2*Math.PI),y.closePath(),y.fillStyle=i,y.fill(),n&&(y.font=e,y.textAlign="center",y.fillStyle=r,y.fillText(n,32,41)),new Qd(g)},[i,n,r,e]),[u,h]=d.useState(!1),f=(n?1:.75)*(u?1.2:1)*o,m=g=>{g.stopPropagation(),h(!0)},p=g=>{g.stopPropagation(),h(!1)};return d.createElement("sprite",Z({scale:f,onPointerOver:t?void 0:m,onPointerOut:t?void 0:s||p},a),d.createElement("spriteMaterial",{map:l,"map-anisotropy":c.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:n?1:.75,toneMapped:!1}))}const _5=({hideNegativeAxes:s,hideAxisHeads:e,disabled:t,font:i="18px Inter var, Arial, sans-serif",axisColors:n=["#ff2060","#20df80","#2080ff"],axisHeadScale:r=1,axisScale:o,labels:a=["X","Y","Z"],labelColor:c="#000",onClick:l,...u})=>{const[h,f,m]=n,{tweenCamera:p}=oo(),g={font:i,disabled:t,labelColor:c,onClick:l,axisHeadScale:r,onPointerDown:t?void 0:y=>{p(y.object.position),y.stopPropagation()}};return d.createElement("group",Z({scale:40},u),d.createElement(ca,{color:h,rotation:[0,0,0],scale:o}),d.createElement(ca,{color:f,rotation:[0,0,Math.PI/2],scale:o}),d.createElement(ca,{color:m,rotation:[0,-Math.PI/2,0],scale:o}),!e&&d.createElement(d.Fragment,null,d.createElement(dn,Z({arcStyle:h,position:[1,0,0],label:a[0]},g)),d.createElement(dn,Z({arcStyle:f,position:[0,1,0],label:a[1]},g)),d.createElement(dn,Z({arcStyle:m,position:[0,0,1],label:a[2]},g)),!s&&d.createElement(d.Fragment,null,d.createElement(dn,Z({arcStyle:h,position:[-1,0,0]},g)),d.createElement(dn,Z({arcStyle:f,position:[0,-1,0]},g)),d.createElement(dn,Z({arcStyle:m,position:[0,0,-1]},g)))))},L5=xi({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new we,sectionColor:new we,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new _,worldPlanePosition:new _},`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform vec3 worldPlanePosition;
    uniform float fadeDistance;
    uniform bool infiniteGrid;
    uniform bool followCamera;

    void main() {
      localPosition = position.xzy;
      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;
      
      worldPosition = modelMatrix * vec4(localPosition, 1.0);
      if (followCamera) {
        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);
        localPosition = (inverse(modelMatrix) * worldPosition).xyz;
      }

      gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
  `,`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform float cellSize;
    uniform float sectionSize;
    uniform vec3 cellColor;
    uniform vec3 sectionColor;
    uniform float fadeDistance;
    uniform float fadeStrength;
    uniform float fadeFrom;
    uniform float cellThickness;
    uniform float sectionThickness;

    float getGrid(float size, float thickness) {
      vec2 r = localPosition.xz / size;
      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
      float line = min(grid.x, grid.y) + 1.0 - thickness;
      return 1.0 - min(line, 1.0);
    }

    void main() {
      float g1 = getGrid(cellSize, cellThickness);
      float g2 = getGrid(sectionSize, sectionThickness);

      vec3 from = worldCamProjPosition*vec3(fadeFrom);
      float dist = distance(from, worldPosition.xyz);
      float d = 1.0 - min(dist / fadeDistance, 1.0);
      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));

      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));
      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);
      if (gl_FragColor.a <= 0.0) discard;

      #include <tonemapping_fragment>
      #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `),P5=d.forwardRef(({args:s,cellColor:e="#000000",sectionColor:t="#2080ff",cellSize:i=.5,sectionSize:n=1,followCamera:r=!1,infiniteGrid:o=!1,fadeDistance:a=100,fadeStrength:c=1,fadeFrom:l=1,cellThickness:u=.5,sectionThickness:h=1,side:f=Wd,...m},p)=>{ft({GridMaterial:L5});const g=d.useRef(null);d.useImperativeHandle(p,()=>g.current,[]);const y=new vi,v=new _(0,1,0),E=new _(0,0,0);ee(A=>{y.setFromNormalAndCoplanarPoint(v,E).applyMatrix4(g.current.matrixWorld);const C=g.current.material,b=C.uniforms.worldCamProjPosition,R=C.uniforms.worldPlanePosition;y.projectPoint(A.camera.position,b.value),R.value.set(0,0,0).applyMatrix4(g.current.matrixWorld)});const x={cellSize:i,sectionSize:n,cellColor:e,sectionColor:t,cellThickness:u,sectionThickness:h},T={fadeDistance:a,fadeStrength:c,fadeFrom:l,infiniteGrid:o,followCamera:r};return d.createElement("mesh",Z({ref:g,frustumCulled:!1},m),d.createElement("gridMaterial",Z({transparent:!0,"extensions-derivatives":!0,side:f},x,T)),d.createElement("planeGeometry",{args:s}))});function lc(s,{path:e}){const[t]=je(Jd,[s],i=>i.setPath(e));return t}lc.preload=(s,{path:e})=>je.preload(Jd,[s],t=>t.setPath(e));function M5({children:s,files:e,...t}){const i=lc(e,{...t});return d.createElement(d.Fragment,null,s?.(i))}function ao(s){return je(_l,s)}ao.preload=s=>je.preload(_l,s);ao.clear=s=>je.clear(_l,s);function D5({path:s,...e}){const i=ao(s).children[0];return d.createElement(ys,Z({},e,{object:i}))}const Om="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master";function lo(s,e=`${Om}/basis/`){const t=H(n=>n.gl),i=je(Ll,In(s)?Object.values(s):s,n=>{n.detectSupport(t),n.setTranscoderPath(e)});if(d.useEffect(()=>{(Array.isArray(i)?i:[i]).forEach(t.initTexture)},[t,i]),In(s)){const n=Object.keys(s),r={};return n.forEach(o=>Object.assign(r,{[o]:i[n.indexOf(o)]})),r}else return i}lo.preload=(s,e=`${Om}/basis/`)=>je.preload(Ll,s,t=>{t.setTranscoderPath(e)});lo.clear=s=>je.clear(Ll,s);const B5=({children:s,input:e,basisPath:t})=>{const i=lo(e,t);return d.createElement(d.Fragment,null,s?.(i))},F5=((s,e)=>typeof window<"u"&&typeof((s=window.document)==null?void 0:s.createElement)=="function"&&typeof((e=window.navigator)==null?void 0:e.userAgent)=="string")();let ua=null;async function k5(...s){var e;(e=ua)!==null&&e!==void 0||(ua=await Ml(()=>Promise.resolve().then(()=>b4),void 0));const t=ua.default;return t.isSupported()?new t(...s):null}function Nm(s,{unsuspend:e="loadedmetadata",start:t=!0,hls:i={},crossOrigin:n="anonymous",muted:r=!0,loop:o=!0,playsInline:a=!0,onVideoFrame:c,...l}={}){const u=H(p=>p.gl),h=d.useRef(null),f=Gt(()=>new Promise(async p=>{let g,y;typeof s=="string"?g=s:y=s;const v=Object.assign(document.createElement("video"),{src:g,srcObject:y,crossOrigin:n,loop:o,muted:r,playsInline:a,...l});if(g&&F5&&g.endsWith(".m3u8")){const x=h.current=await k5(i);x&&(x.on(S.MEDIA_ATTACHED,()=>void x.loadSource(g)),x.attachMedia(v))}const E=new qd(v);E.colorSpace=u.outputColorSpace,v.addEventListener(e,()=>p(E))}),[s]),m=f.source.data;return O5(m,c),d.useEffect(()=>(t&&f.image.play(),()=>{h.current&&(h.current.destroy(),h.current=null)}),[f,t]),f}const co=d.forwardRef(({children:s,src:e,...t},i)=>{const n=Nm(e,t);return d.useEffect(()=>()=>void n.dispose(),[n]),d.useImperativeHandle(i,()=>n,[n]),d.createElement(d.Fragment,null,s?.(n))}),O5=(s,e)=>{d.useEffect(()=>{if(!e||!s.requestVideoFrameCallback)return;let t;const i=(...n)=>{e(...n),t=s.requestVideoFrameCallback(i)};return s.requestVideoFrameCallback(i),()=>s.cancelVideoFrameCallback(t)},[s,e])},cs=(s,e)=>{if(Array.isArray(s))return s[0];{const t=e??Object.keys(s)[0];return s[t][0]}},Um=s=>{for(let e=3;e<s.length;e+=4)if(s[e]!==0)return!1;return!0};function uo(s,e,t,i,n,r){const o=d.useRef(H(P=>P.viewport)),a=d.useRef(null),c=d.useRef(0),l=.1,u=d.useRef(s),h=d.useRef(e),f=d.useRef(t),[m,p]=d.useState(null),[g,y]=d.useState(new Pn),v=d.useMemo(()=>new Yi,[]),[E,x]=d.useState(null),T=d.useCallback((P,O,z)=>{const D=O*(o.current.aspect>P/O?o.current.width/P:o.current.height/O),k=P*(o.current.aspect>P/O?o.current.width/P:o.current.height/O)*z,$=D*z,U=1;let N=Math.min(U,k),B=Math.min(U,$);return k>U&&(N=U,B=$/k*U),new _(N,B,1)},[]),A=d.useCallback((P,O)=>{if(P.image){const z=document.createElement("canvas"),D=z.getContext("2d",r);if(!D)throw new Error("Failed to get 2d context");z.width=P.image.width,z.height=P.image.height,D.drawImage(P.image,0,0);const F=P.image.width,k=P.image.height,$=Math.round(Math.sqrt(O*(F/k))),U=Math.round(O/$),N=F/$,B=k/U,G=[];for(let j=0;j<U;j++)for(let L=0;L<$;L++){if(j*$+L>=O){G.push({row:j,col:L});continue}const Q=D.getImageData(L*N,j*B,N,B).data;Um(Q)&&G.push({row:j,col:L})}return{rows:U,columns:$,frameWidth:N,frameHeight:B,emptyFrames:G}}else return{rows:0,columns:0,frameWidth:0,frameHeight:0,emptyFrames:[]}},[r]),C=d.useCallback(P=>{const O=z=>{let D=null;for(const k of z){const{w:$,h:U}=k.frame,N=$*U;(!D||N>D.area)&&(D={w:$,h:U,area:N})}return z.map(k=>{const{w:$,h:U}=k.frame,N=$*U,B=D?N===D.area?1:Math.sqrt(N/D.area):1;return{...k,scaleRatio:B}})};if(Array.isArray(P))return O(P);{const z={};for(const D in P)z[D]=O(P[D]);return z}},[]),b=d.useCallback(()=>{const P={},O=a.current,z=f.current;if(O)if(z&&Array.isArray(O.frames)){for(let D=0;D<z.length;D++){P[z[D]]=[];for(const F of O.frames){const k=F.frame,$=F.sourceSize.w,U=F.sourceSize.h;typeof F.filename=="string"&&F.filename.toLowerCase().indexOf(z[D].toLowerCase())!==-1&&P[z[D]].push({...F,frame:k,sourceSize:{w:$,h:U}})}}for(const D in P){const F=C(P[D]);Array.isArray(F)&&(P[D]=F)}return P}else if(z&&typeof O.frames=="object"){for(let D=0;D<z.length;D++){P[z[D]]=[];for(const F in O.frames){const k=O.frames[F],$=k.frame,U=k.sourceSize.w,N=k.sourceSize.h;typeof F=="string"&&F.toLowerCase().indexOf(z[D].toLowerCase())!==-1&&P[z[D]].push({...k,frame:$,sourceSize:{w:U,h:N}})}}for(const D in P){const F=C(P[D]);Array.isArray(F)&&(P[D]=F)}return P}else{let D=[];return O!=null&&O.frames&&(Array.isArray(O.frames)?D=O.frames.map(F=>({...F,x:F.frame.x,y:F.frame.y,w:F.frame.w,h:F.frame.h})):D=Object.values(O.frames).flat().map(F=>({...F,x:F.frame.x,y:F.frame.y,w:F.frame.w,h:F.frame.h}))),C(D)}return[]},[C,a]),R=d.useCallback((P,O)=>{let z=new _(1,1,1);if(P===null){if(O&&i){const D=O.image.width,F=O.image.height;c.current=i;const{rows:k,columns:$,frameWidth:U,frameHeight:N,emptyFrames:B}=A(O,i),G={frames:[],meta:{version:"1.0",size:{w:D,h:F},rows:k,columns:$,frameWidth:U,frameHeight:N,scale:"1"}};for(let j=0;j<k;j++)for(let L=0;L<$;L++)(B??[]).some(Q=>Q.row===j&&Q.col===L)||Array.isArray(G.frames)&&G.frames.push({frame:{x:L*U,y:j*N,w:U,h:N},scaleRatio:1,rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:U,h:N},sourceSize:{w:U,h:N}});z=T(U,N,l),a.current=G}a.current&&a.current.frames&&(a.current.frames=C(a.current.frames))}else if(O){a.current=P,a.current.frames=b(),c.current=Array.isArray(P.frames)?P.frames.length:Object.keys(P.frames).length;const{w:D,h:F}=cs(P.frames).sourceSize;z=T(D,F,l)}p(a.current),"encoding"in O?O.encoding=3001:"colorSpace"in O&&(O.colorSpace=Zd),y(O),x({spriteTexture:O,spriteData:a.current,aspect:z})},[A,i,b,T,C]),I=d.useCallback((P,O,z)=>{const D=fetch(P).then(k=>k.json()),F=new Promise(k=>{v.load(O,k)});Promise.all([D,F]).then(k=>{z(k[0],k[1])})},[v]),w=d.useCallback(P=>{if(!P&&!u.current)throw new Error("Either textureUrl or input must be provided");const O=P??u.current;if(!O)throw new Error("A valid texture URL must be provided");v.load(O,z=>R(null,z))},[v,R]),M=d.useCallback((P,O)=>{O&&P?I(O,P,R):w(P)},[I,w,R]);return d.useLayoutEffect(()=>{h.current&&u.current?I(h.current,u.current,R):u.current&&w();const P=u.current;return()=>{P&&je.clear(Yi,P)}},[I,w,R]),d.useLayoutEffect(()=>{n?.(g,m??null)},[g,m,n]),{spriteObj:E,loadJsonAndTexture:M}}uo.preload=s=>je.preload(Yi,s);uo.clear=s=>je.clear(Yi,s);function N5(s,e=[],t){const[i,n]=d.useState();return d.useLayoutEffect(()=>{const r=s();return n(r),()=>void 0},e),i}function U5({showPanel:s=0,className:e,parent:t}){const i=N5(()=>new I4,[]);return d.useEffect(()=>{if(i){const n=t&&t.current||document.body;i.showPanel(s),n?.appendChild(i.dom);const r=(e??"").split(" ").filter(c=>c);r.length&&i.dom.classList.add(...r);const o=Qr(()=>i.begin()),a=Cl(()=>i.end());return()=>{r.length&&i.dom.classList.remove(...r),n?.removeChild(i.dom),o(),a()}}},[t,i,e,s]),null}const z5=d.forwardRef(function({className:e,parent:t,id:i,clearStatsGlStyle:n,...r},o){const a=H(l=>l.gl),c=d.useMemo(()=>{const l=new L4({...r});return l.init(a),l},[a]);return d.useImperativeHandle(o,()=>c.domElement,[c]),d.useEffect(()=>{if(c){const l=t&&t.current||document.body;l?.appendChild(c.domElement),c.domElement.querySelectorAll("canvas").forEach(f=>{f.style.removeProperty("position")}),i&&(c.domElement.id=i),n&&c.domElement.removeAttribute("style"),c.domElement.removeAttribute("style");const u=(e??"").split(" ").filter(f=>f);u.length&&c.domElement.classList.add(...u);const h=Cl(()=>c.update());return()=>{u.length&&c.domElement.classList.remove(...u),l?.removeChild(c.domElement),h()}}},[t,c,e,i,n]),null});function G5({size:s=256,frames:e=1/0}={}){const t=H(u=>u.viewport.dpr),{width:i,height:n}=H(u=>u.size),r=s||i*t,o=s||n*t,a=d.useMemo(()=>{const u=new bl(r,o);return u.format=ef,u.type=tf,{depthTexture:u}},[r,o]);let c=0;const l=Di(r,o,a);return ee(u=>{(e===1/0||c<e)&&(u.gl.setRenderTarget(l),u.gl.render(u.scene,u.camera),u.gl.setRenderTarget(null),c++)}),l.depthTexture}function $5(s,e,t=1){const i=H(o=>o.viewport),n=e*(i.aspect>s/e?i.width/s:i.height/e);return[s*(i.aspect>s/e?i.width/s:i.height/e)*t,n*t,1]}function H5(s,e){const t=H(n=>n.pointer),[i]=d.useState(()=>{const n=new Fi;return e&&ui(n,e),function(r,o){n.setFromCamera(t,s instanceof nf?s:s.current);const a=this.constructor.prototype.raycast.bind(this);a&&a(n,o)}});return i}const zm=s=>Gt(()=>F4(s),["useDetectGPU"]);function K5({children:s,...e}){const t=zm(e);return d.createElement(d.Fragment,null,s?.(t))}const mh=s=>s.isMesh;function V5(s,e){e={strategy:Pl,verbose:!1,setBoundingBox:!0,maxDepth:40,maxLeafTris:10,indirect:!1,...e},d.useEffect(()=>{if(s.current){s.current.raycast=Af;const t=s.current.geometry;return t.computeBoundsTree=Sf,t.disposeBoundsTree=Tf,t.computeBoundsTree(e),()=>{t.boundsTree&&t.disposeBoundsTree()}}},[s,JSON.stringify(e)])}const j5=d.forwardRef(({enabled:s=!0,firstHitOnly:e=!1,children:t,strategy:i=Pl,verbose:n=!1,setBoundingBox:r=!0,maxDepth:o=40,maxLeafTris:a=10,indirect:c=!1,...l},u)=>{const h=d.useRef(null),f=H(m=>m.raycaster);return d.useImperativeHandle(u,()=>h.current,[]),d.useEffect(()=>{if(s){const m={strategy:i,verbose:n,setBoundingBox:r,maxDepth:o,maxLeafTris:a,indirect:c},p=h.current;return f.firstHitOnly=e,p.traverse(g=>{mh(g)&&!g.geometry.boundsTree&&g.raycast===oe.prototype.raycast&&(g.raycast=Af,g.geometry.computeBoundsTree=Sf,g.geometry.disposeBoundsTree=Tf,g.geometry.computeBoundsTree(m))}),()=>{delete f.firstHitOnly,p.traverse(g=>{mh(g)&&g.geometry.boundsTree&&(g.geometry.disposeBoundsTree(),g.raycast=oe.prototype.raycast)})}}},[]),d.createElement("group",Z({ref:h},l),t)});function W5(...s){const e=d.useRef([]);return e.current=s.map(t=>d.useContext(t)),d.useMemo(()=>({children:t})=>s.reduceRight((i,n,r)=>d.createElement(n.Provider,{value:e.current[r],children:i}),t),[])}function X5(s,e){const t=d.useRef(null),[i]=d.useState(()=>e?e instanceof Ve?{current:e}:e:t),[n]=d.useState(()=>new n1(void 0));d.useLayoutEffect(()=>{e&&(i.current=e instanceof Ve?e:e.current),n._root=i.current});const r=d.useRef({}),o=d.useMemo(()=>{const a={};return s.forEach(c=>Object.defineProperty(a,c.name,{enumerable:!0,get(){if(i.current)return r.current[c.name]||(r.current[c.name]=n.clipAction(c,i.current))},configurable:!0})),{ref:i,clips:s,actions:a,names:s.map(c=>c.name),mixer:n}},[s]);return ee((a,c)=>n.update(c)),d.useEffect(()=>{const a=i.current;return()=>{r.current={},n.stopAllAction(),Object.values(o.actions).forEach(c=>{a&&n.uncacheAction(c,a)})}},[s]),o}function Gm(s){const e=d.useRef(null),t=d.useRef(!1),i=d.useRef(!1),n=d.useRef(s);return d.useLayoutEffect(()=>void(n.current=s),[s]),d.useEffect(()=>{const r=e.current;if(r){const o=Qr(()=>(t.current=!1,!0)),a=r.onBeforeRender;r.onBeforeRender=()=>t.current=!0;const c=Cl(()=>(t.current!==i.current&&(n.current==null||n.current(i.current=t.current)),!0));return()=>{r.onBeforeRender=a,o(),c()}}},[]),e}const Y5=`
#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )
  vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );
  #ifdef BOX_PROJECTED_ENV_MAP
    vWorldPosition = worldPosition.xyz;
  #endif
#endif
`,Q5=`
#ifdef BOX_PROJECTED_ENV_MAP
  uniform vec3 envMapSize;
  uniform vec3 envMapPosition;
  varying vec3 vWorldPosition;
    
  vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {
    vec3 nDir = normalize( v );
    vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbminmax;
    rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
    rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
    rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;
    float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
    vec3 boxIntersection = vWorldPosition + nDir * correction;    
    return boxIntersection - cubePos;
  }
#endif
`,J5=`
#ifdef BOX_PROJECTED_ENV_MAP
  worldNormal = parallaxCorrectNormal( worldNormal, envMapSize, envMapPosition );
#endif
`,q5=`
#ifdef BOX_PROJECTED_ENV_MAP
  reflectVec = parallaxCorrectNormal( reflectVec, envMapSize, envMapPosition );
#endif
`;function Z5(s,e,t){s.defines.BOX_PROJECTED_ENV_MAP=!0,s.uniforms.envMapPosition={value:e},s.uniforms.envMapSize={value:t},s.vertexShader=`
  varying vec3 vWorldPosition;
  ${s.vertexShader.replace("#include <worldpos_vertex>",Y5)}`,s.fragmentShader=`
    ${Q5}
    ${s.fragmentShader.replace("#include <envmap_physical_pars_fragment>",ts.envmap_physical_pars_fragment).replace("vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );",`vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
         ${J5}
         `).replace("reflectVec = inverseTransformDirection( reflectVec, viewMatrix );",`reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
         ${q5}
        `)}`}function e6(s=new _,e=new _){const[t]=d.useState(()=>({position:new _,size:new _}));ui(t,{position:s,size:e});const i=d.useRef(null),n=d.useMemo(()=>({ref:i,onBeforeCompile:r=>Z5(r,t.position,t.size),customProgramCacheKey:()=>JSON.stringify(t.position.toArray())+JSON.stringify(t.size.toArray())}),[...t.position.toArray(),...t.size.toArray()]);return d.useLayoutEffect(()=>void(i.current.needsUpdate=!0),[t]),n}const ph=new gi,Zs=new _,t6=({anchor:s,...e})=>{const t=d.useRef(null),i=d.useRef(null);return d.useEffect(()=>{var n;(n=t.current)!=null&&(n=n.parent)!=null&&n.parent&&(i.current=t.current.parent,t.current.parent.parent.add(t.current))},[]),ee(()=>{i.current&&(ph.setFromObject(i.current),ph.getSize(Zs),t.current.position.set(i.current.position.x+Zs.x*(Array.isArray(s)?s[0]:s.x)/2,i.current.position.y+Zs.y*(Array.isArray(s)?s[1]:s.y)/2,i.current.position.z+Zs.z*(Array.isArray(s)?s[2]:s.z)/2))}),d.createElement("group",Z({ref:t},e))};function i6(s,e,t=.9){return e*t+s*(1-t)}const n6=s=>Math.sqrt(1-Math.pow(s-1,2));class s6{constructor({size:e=256,maxAge:t=750,radius:i=.3,intensity:n=.2,interpolate:r=0,smoothing:o=0,minForce:a=.3,blend:c="screen",ease:l=n6}={}){this.size=e,this.maxAge=t,this.radius=i,this.intensity=n,this.ease=l,this.interpolate=r,this.smoothing=o,this.minForce=a,this.blend=c,this.trail=[],this.force=0,this.initTexture()}initTexture(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=this.size;const e=this.canvas.getContext("2d");if(e===null)throw new Error("2D not available");this.ctx=e,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.texture=new Pn(this.canvas),this.canvas.id="touchTexture",this.canvas.style.width=this.canvas.style.height=`${this.canvas.width}px`}update(e){this.clear(),this.trail.forEach((t,i)=>{t.age+=e*1e3,t.age>this.maxAge&&this.trail.splice(i,1)}),this.trail.length||(this.force=0),this.trail.forEach(t=>{this.drawTouch(t)}),this.texture.needsUpdate=!0}clear(){this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}addTouch(e){const t=this.trail[this.trail.length-1];if(t){const i=t.x-e.x,n=t.y-e.y,r=i*i+n*n,o=Math.max(this.minForce,Math.min(r*1e4,1));if(this.force=i6(o,this.force,this.smoothing),this.interpolate){const a=Math.ceil(r/Math.pow(this.radius*.5/this.interpolate,2));if(a>1)for(let c=1;c<a;c++)this.trail.push({x:t.x-i/a*c,y:t.y-n/a*c,age:0,force:o})}}this.trail.push({x:e.x,y:e.y,age:0,force:this.force})}drawTouch(e){const t={x:e.x*this.size,y:(1-e.y)*this.size};let i=1;e.age<this.maxAge*.3?i=this.ease(e.age/(this.maxAge*.3)):i=this.ease(1-(e.age-this.maxAge*.3)/(this.maxAge*.7)),i*=e.force,this.ctx.globalCompositeOperation=this.blend;const n=this.size*this.radius*i,r=this.ctx.createRadialGradient(t.x,t.y,Math.max(0,n*.25),t.x,t.y,Math.max(0,n));r.addColorStop(0,`rgba(255, 255, 255, ${this.intensity})`),r.addColorStop(1,"rgba(0, 0, 0, 0.0)"),this.ctx.beginPath(),this.ctx.fillStyle=r,this.ctx.arc(t.x,t.y,Math.max(0,n),0,Math.PI*2),this.ctx.fill()}}function $m(s={}){const{size:e,maxAge:t,radius:i,intensity:n,interpolate:r,smoothing:o,minForce:a,blend:c,ease:l}=s,u=d.useMemo(()=>new s6(s),[e,t,i,n,r,o,a,c,l]);ee((f,m)=>void u.update(m));const h=d.useCallback(f=>u.addTouch(f.uv),[u]);return[u.texture,h]}const r6=({children:s,...e})=>{const t=$m(e);return d.createElement(d.Fragment,null,s?.(t))},o6=d.forwardRef(({font:s,color:e="#cbcbcb",bevelSize:t=.04,debug:i=!1,children:n,...r},o)=>{const[a,c]=d.useState(0),l=d.useCallback((f=1)=>c(a+f),[a]),u=d.useCallback((f=1)=>c(a-f),[a]),h=d.useMemo(()=>({incr:l,decr:u}),[l,u]);return d.useImperativeHandle(o,()=>h,[h]),d.createElement("group",r,d.createElement(d.Suspense,{fallback:null},d.createElement(Rl,{top:!0,cacheKey:JSON.stringify({counter:a,font:s})},d.createElement(cf,{bevelEnabled:!0,bevelSize:t,font:s},i?d.createElement("meshNormalMaterial",{wireframe:!0}):d.createElement("meshStandardMaterial",{color:e}),a))),n)}),Hm=d.createContext(null);function a6(){return d.useContext(Hm)}function l6(s){return s!==null&&"meta"in s&&"frames"in s}const gh=new Qt(1,1),c6=d.forwardRef(({startFrame:s=0,endFrame:e,fps:t=30,frameName:i="",textureDataURL:n,textureImageURL:r,loop:o=!1,numberOfFrames:a=1,autoPlay:c=!0,animationNames:l,onStart:u,onEnd:h,onLoopEnd:f,onFrame:m,play:p,pause:g=!1,flipX:y=!1,alphaTest:v=0,children:E,asSprite:x=!1,offset:T,playBackwards:A=!1,resetOnEnd:C=!1,maxItems:b=1,instanceItems:R=[[0,0,0]],spriteDataset:I,canvasRenderingContext2DSettings:w,roundFramePosition:M=!1,meshProps:P={},...O},z)=>{const D=d.useRef(new Al),F=d.useRef(null),k=d.useRef(null),$=d.useRef(null),U=d.useRef(window.performance.now()),N=d.useRef(s),B=d.useRef(i),G=t>0?1e3/t:0,[j,L]=d.useState(new Pn),X=d.useRef(0),[Q,ne]=d.useState(new _(1,1,1)),he=y?-1:1,xe=d.useRef(g),ce=d.useRef(T),Ee=d.useRef(!1),{spriteObj:ct,loadJsonAndTexture:ut}=uo(null,null,l,a,void 0,w),St=d.useRef(i),$t=d.useCallback((ge,be)=>{if(be===null)a&&(X.current=a,A&&(N.current=a-1),F.current=be);else{var Me,Oe;F.current=be,F.current&&Array.isArray(F.current.frames)?X.current=F.current.frames.length:F.current&&typeof F.current=="object"&&St.current?X.current=F.current.frames[St.current].length:X.current=0,A&&(N.current=X.current-1);const{w:We,h:Ge}=cs((Me=(Oe=F.current)==null?void 0:Oe.frames)!==null&&Me!==void 0?Me:[],St.current).sourceSize,Si=Xe(We,Ge);ne(Si),k.current&&(k.current.map=ge)}L(ge)},[a,A]),Te=d.useCallback(()=>{if(!F.current)return;const{meta:{size:ge},frames:be}=F.current,{w:Me,h:Oe}=Array.isArray(be)?be[0].sourceSize:i?be[i]?be[i][0].sourceSize:{w:0,h:0}:{w:0,h:0};k.current&&k.current.map&&(k.current.map.wrapS=k.current.map.wrapT=Mn,k.current.map.center.set(0,0),k.current.map.repeat.set(1*he/(ge.w/Me),1/(ge.h/Oe)));const Ge=1/((ge.h-1)/Oe);k.current&&k.current.map&&(k.current.map.offset.x=0,k.current.map.offset.y=1-Ge),u&&u({currentFrameName:i??"",currentFrame:N.current})},[he,i,u]),Ce=d.useMemo(()=>({current:ce.current,offset:ce.current,imageUrl:r,hasEnded:!1,ref:z}),[r,z]);d.useImperativeHandle(z,()=>D.current,[]),d.useLayoutEffect(()=>{ce.current=T},[T]);const Xe=(ge,be)=>{var Me;const Oe=new _,We=be/ge;return Oe.set(1,We,1),(Me=$.current)==null||Me.scale.copy(Oe),Oe};d.useEffect(()=>{if(I){var ge;$t(I==null||(ge=I.spriteTexture)==null?void 0:ge.clone(),I.spriteData)}else r&&n&&ut(r,n)},[ut,I,n,r,$t]),d.useEffect(()=>{if(ct){var ge;$t(ct==null||(ge=ct.spriteTexture)==null?void 0:ge.clone(),ct?.spriteData)}},[ct,$t]),d.useEffect(()=>{if(Ce.hasEnded=!1,F.current&&A===!0){var ge;N.current=((ge=F.current.frames.length)!==null&&ge!==void 0?ge:0)-1}else N.current=0},[A,Ce]),d.useLayoutEffect(()=>{Te()},[j,y,Te]),d.useEffect(()=>{c&&(xe.current=!1)},[c]),d.useLayoutEffect(()=>{if(B.current!==i&&i&&(N.current=0,B.current=i,Ce.hasEnded=!1,G<=0&&(N.current=e||s||0),F.current)){const{w:ge,h:be}=cs(F.current.frames,i).sourceSize,Me=Xe(ge,be);ne(Me)}},[i,G,Ce,e,s]);const Tt=()=>{if(!l6(F.current))return;const{meta:{size:ge},frames:be}=F.current,{w:Me,h:Oe}=cs(be,i).sourceSize,We=Array.isArray(be)?be:i?be[i]:[],Ge=e||We.length-1;var Si=T===void 0?Ce.current:T;if(G<=0){N.current=e||s||0,st(Me,Oe,ge,We);return}const Ti=window.performance.now(),bi=Ti-U.current;if(!(bi<=G)){var ni=A?N.current<0:N.current>Ge,Ls=A?N.current===Ge:N.current===0,bo=A?N.current<0:N.current>=Ge;if(ni){if(N.current=o?s??0:0,A&&(N.current=Ge),o?f?.({currentFrameName:i??"",currentFrame:N.current}):(h?.({currentFrameName:i??"",currentFrame:N.current}),Ce.hasEnded=!C,C&&(xe.current=!0)),!o)return}else Ls&&u?.({currentFrameName:i??"",currentFrame:N.current});Si!==void 0&&bo?Ee.current===!1&&(h?.({currentFrameName:i??"",currentFrame:N.current}),Ee.current=!0):Ee.current=!1,!(bi<=G)&&(U.current=Ti-bi%G,st(Me,Oe,ge,We))}},st=(ge,be,Me,Oe)=>{var We=T===void 0?Ce.current:T;const Ge=N.current;let Si=0,Ti=0;Xe(ge,be);const bi=M?Math.round((Me.w-1)/ge):(Me.w-1)/ge,ni=M?Math.round((Me.h-1)/be):(Me.h-1)/be;if(!Oe[Ge])return;const{frame:{x:Ls,y:bo},sourceSize:{w:Cc,h:Fg}}=Oe[Ge],Rc=1/bi,wc=1/ni;if(k.current&&k.current.map&&(Si=he>0?Rc*(Ls/Cc):Rc*(Ls/Cc)-k.current.map.repeat.x,Ti=Math.abs(1-wc)-wc*(bo/Fg),k.current.map.offset.x=Si,k.current.map.offset.y=Ti),We!=null){let Gn=Math.floor(We*Oe.length);Gn=Math.max(0,Math.min(Gn,Oe.length-1)),isNaN(Gn)&&(Gn=0),N.current=Gn}else A?N.current-=1:N.current+=1};ee((ge,be)=>{var Me,Oe;!((Me=F.current)!=null&&Me.frames)||!((Oe=k.current)!=null&&Oe.map)||xe.current||!Ce.hasEnded&&(c||p)&&(Tt(),m?.({currentFrameName:B.current,currentFrame:N.current}))});function Ht(ge=new _(1,1,1),be=1){if(typeof be=="number")return ge.multiplyScalar(be);if(Array.isArray(be))return ge.multiply(new _(...be));if(be instanceof _)return ge.multiply(be)}return d.createElement("group",Z({},O,{ref:D,scale:Ht(Q,O.scale)}),d.createElement(Hm.Provider,{value:Ce},x&&d.createElement(Sm,null,d.createElement("mesh",Z({ref:$,scale:1,geometry:gh},P),d.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:dt,ref:k,map:j,transparent:!0,alphaTest:v??0}))),!x&&d.createElement(uf,Z({geometry:gh,limit:b??1},P),d.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:dt,ref:k,map:j,transparent:!0,alphaTest:v??0}),(R??[0]).map((ge,be)=>d.createElement(hf,Z({key:be,ref:R?.length===1?$:null,position:ge,scale:1},P)))),E))}),u6=d.forwardRef(({children:s,curve:e},t)=>{const[i]=d.useState(()=>new nn),[n,r]=d.useState(),o=d.useRef(null);return d.useLayoutEffect(()=>{o.current=new r2(i.children[0]),r(o.current.object3D)},[s]),d.useEffect(()=>{var a;e&&((a=o.current)==null||a.updateCurve(0,e))},[e]),d.useImperativeHandle(t,()=>o.current),d.createElement(d.Fragment,null,Ei(s,i),n&&d.createElement("primitive",{object:n}))});var h6=`#define GLSLIFY 1
vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`;class d6 extends s1{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._distort={value:.4},this._radius={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.radius=this._radius,e.uniforms.distort=this._distort,e.vertexShader=`
      uniform float time;
      uniform float radius;
      uniform float distort;
      ${h6}
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`
        float updateTime = time / 50.0;
        float noise = snoise(vec3(position / 2.0 + updateTime * 5.0));
        vec3 transformed = vec3(position * (noise * pow(distort, 2.0) + radius));
        `)}get time(){return this._time.value}set time(e){this._time.value=e}get distort(){return this._distort.value}set distort(e){this._distort.value=e}get radius(){return this._radius.value}set radius(e){this._radius.value=e}}const f6=d.forwardRef(({speed:s=1,...e},t)=>{const[i]=d.useState(()=>new d6);return ee(n=>i&&(i.time=n.clock.elapsedTime*s)),d.createElement("primitive",Z({object:i,ref:t,attach:"material"},e))});class m6 extends sf{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._factor={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.factor=this._factor,e.vertexShader=`
      uniform float time;
      uniform float factor;
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`float theta = sin( time + position.y ) / 2.0 * factor;
        float c = cos( theta );
        float s = sin( theta );
        mat3 m = mat3( c, 0, s, 0, 1, 0, -s, 0, c );
        vec3 transformed = vec3( position ) * m;
        vNormal = vNormal * m;`)}get time(){return this._time.value}set time(e){this._time.value=e}get factor(){return this._factor.value}set factor(e){this._factor.value=e}}const p6=d.forwardRef(({speed:s=1,...e},t)=>{const[i]=d.useState(()=>new m6);return ee(n=>i&&(i.time=n.clock.elapsedTime*s)),d.createElement("primitive",Z({object:i,ref:t,attach:"material"},e))});class g6 extends Ut{constructor(e=new de){super({uniforms:{inputBuffer:new bt(null),depthBuffer:new bt(null),resolution:new bt(new de),texelSize:new bt(new de),halfTexelSize:new bt(new de),kernel:new bt(0),scale:new bt(1),cameraNear:new bt(0),cameraFar:new bt(1),minDepthThreshold:new bt(0),maxDepthThreshold:new bt(1),depthScale:new bt(0),depthToBlurRatioBias:new bt(.25)},fragmentShader:`#include <common>
        #include <dithering_pars_fragment>      
        uniform sampler2D inputBuffer;
        uniform sampler2D depthBuffer;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          float depthFactor = 0.0;
          
          #ifdef USE_DEPTH
            vec4 depth = texture2D(depthBuffer, vUv);
            depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
            depthFactor *= depthScale;
            depthFactor = max(0.0, min(1.0, depthFactor + 0.25));
          #endif
          
          vec4 sum = texture2D(inputBuffer, mix(vUv0, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv1, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv2, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv3, vUv, depthFactor));
          gl_FragColor = sum * 0.25 ;

          #include <dithering_fragment>
          #include <tonemapping_fragment>
          #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
        }`,vertexShader:`uniform vec2 texelSize;
        uniform vec2 halfTexelSize;
        uniform float kernel;
        uniform float scale;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          vec2 uv = position.xy * 0.5 + 0.5;
          vUv = uv;

          vec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;
          vUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);
          vUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);
          vUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);
          vUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);

          gl_Position = vec4(position.xy, 1.0, 1.0);
        }`,blending:r1,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernel=new Float32Array([0,1,2,2,3])}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class y6{constructor({gl:e,resolution:t,width:i=500,height:n=500,minDepthThreshold:r=0,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:c=.25}){this.renderToScreen=!1,this.renderTargetA=new Ze(t,t,{minFilter:Ji,magFilter:Ji,stencilBuffer:!1,depthBuffer:!1,type:tn}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new g6,this.convolutionMaterial.setTexelSize(1/i,1/n),this.convolutionMaterial.setResolution(new de(i,n)),this.scene=new nn,this.camera=new nf,this.convolutionMaterial.uniforms.minDepthThreshold.value=r,this.convolutionMaterial.uniforms.maxDepthThreshold.value=o,this.convolutionMaterial.uniforms.depthScale.value=a,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=c,this.convolutionMaterial.defines.USE_DEPTH=a>0;const l=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),u=new Float32Array([0,0,2,0,0,2]),h=new Zt;h.setAttribute("position",new fi(l,3)),h.setAttribute("uv",new fi(u,2)),this.screen=new oe(h,this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,i){const n=this.scene,r=this.camera,o=this.renderTargetA,a=this.renderTargetB;let c=this.convolutionMaterial,l=c.uniforms;l.depthBuffer.value=t.depthTexture;const u=c.kernel;let h=t,f,m,p;for(m=0,p=u.length-1;m<p;++m)f=(m&1)===0?o:a,l.kernel.value=u[m],l.inputBuffer.value=h.texture,e.setRenderTarget(f),e.render(n,r),h=f;l.kernel.value=u[m],l.inputBuffer.value=h.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(n,r)}}let v6=class extends sf{constructor(e={}){super(e),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._blurStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(e)}onBeforeCompile(e){var t;(t=e.defines)!=null&&t.USE_UV||(e.defines.USE_UV=""),e.uniforms.hasBlur=this._hasBlur,e.uniforms.tDiffuse=this._tDiffuse,e.uniforms.tDepth=this._tDepth,e.uniforms.distortionMap=this._distortionMap,e.uniforms.tDiffuseBlur=this._tDiffuseBlur,e.uniforms.textureMatrix=this._textureMatrix,e.uniforms.mirror=this._mirror,e.uniforms.mixBlur=this._mixBlur,e.uniforms.mixStrength=this._blurStrength,e.uniforms.minDepthThreshold=this._minDepthThreshold,e.uniforms.maxDepthThreshold=this._maxDepthThreshold,e.uniforms.depthScale=this._depthScale,e.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,e.uniforms.distortion=this._distortion,e.uniforms.mixContrast=this._mixContrast,e.vertexShader=`
        uniform mat4 textureMatrix;
        varying vec4 my_vUv;
      ${e.vertexShader}`,e.vertexShader=e.vertexShader.replace("#include <project_vertex>",`#include <project_vertex>
        my_vUv = textureMatrix * vec4( position, 1.0 );
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );`),e.fragmentShader=`
        uniform sampler2D tDiffuse;
        uniform sampler2D tDiffuseBlur;
        uniform sampler2D tDepth;
        uniform sampler2D distortionMap;
        uniform float distortion;
        uniform float cameraNear;
			  uniform float cameraFar;
        uniform bool hasBlur;
        uniform float mixBlur;
        uniform float mirror;
        uniform float mixStrength;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float mixContrast;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec4 my_vUv;
        ${e.fragmentShader}`,e.fragmentShader=e.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>

      float distortionFactor = 0.0;
      #ifdef USE_DISTORTION
        distortionFactor = texture2D(distortionMap, vUv).r * distortion;
      #endif

      vec4 new_vUv = my_vUv;
      new_vUv.x += distortionFactor;
      new_vUv.y += distortionFactor;

      vec4 base = texture2DProj(tDiffuse, new_vUv);
      vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);

      vec4 merge = base;

      #ifdef USE_NORMALMAP
        vec2 normal_uv = vec2(0.0);
        vec4 normalColor = texture2D(normalMap, vUv * normalScale);
        vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );
        vec3 coord = new_vUv.xyz / new_vUv.w;
        normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;
        vec4 base_normal = texture2D(tDiffuse, normal_uv);
        vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);
        merge = base_normal;
        blur = blur_normal;
      #endif

      float depthFactor = 0.0001;
      float blurFactor = 0.0;

      #ifdef USE_DEPTH
        vec4 depth = texture2DProj(tDepth, new_vUv);
        depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
        depthFactor *= depthScale;
        depthFactor = max(0.0001, min(1.0, depthFactor));

        #ifdef USE_BLUR
          blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);
          merge = merge * min(1.0, depthFactor + 0.5);
        #else
          merge = merge * depthFactor;
        #endif

      #endif

      float reflectorRoughnessFactor = roughness;
      #ifdef USE_ROUGHNESSMAP
        vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );
        reflectorRoughnessFactor *= reflectorTexelRoughness.g;
      #endif

      #ifdef USE_BLUR
        blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);
        merge = mix(merge, blur, blurFactor);
      #endif

      vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);
      newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;
      newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;
      newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;

      diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);
      `)}get tDiffuse(){return this._tDiffuse.value}set tDiffuse(e){this._tDiffuse.value=e}get tDepth(){return this._tDepth.value}set tDepth(e){this._tDepth.value=e}get distortionMap(){return this._distortionMap.value}set distortionMap(e){this._distortionMap.value=e}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(e){this._tDiffuseBlur.value=e}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(e){this._textureMatrix.value=e}get hasBlur(){return this._hasBlur.value}set hasBlur(e){this._hasBlur.value=e}get mirror(){return this._mirror.value}set mirror(e){this._mirror.value=e}get mixBlur(){return this._mixBlur.value}set mixBlur(e){this._mixBlur.value=e}get mixStrength(){return this._blurStrength.value}set mixStrength(e){this._blurStrength.value=e}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(e){this._minDepthThreshold.value=e}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(e){this._maxDepthThreshold.value=e}get depthScale(){return this._depthScale.value}set depthScale(e){this._depthScale.value=e}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(e){this._depthToBlurRatioBias.value=e}get distortion(){return this._distortion.value}set distortion(e){this._distortion.value=e}get mixContrast(){return this._mixContrast.value}set mixContrast(e){this._mixContrast.value=e}};const x6=d.forwardRef(({mixBlur:s=0,mixStrength:e=1,resolution:t=256,blur:i=[0,0],minDepthThreshold:n=.9,maxDepthThreshold:r=1,depthScale:o=0,depthToBlurRatioBias:a=.25,mirror:c=0,distortion:l=1,mixContrast:u=1,distortionMap:h,reflectorOffset:f=0,...m},p)=>{ft({MeshReflectorMaterialImpl:v6});const g=H(({gl:j})=>j),y=H(({camera:j})=>j),v=H(({scene:j})=>j);i=Array.isArray(i)?i:[i,i];const E=i[0]+i[1]>0,x=i[0],T=i[1],A=d.useRef(null);d.useImperativeHandle(p,()=>A.current,[]);const[C]=d.useState(()=>new vi),[b]=d.useState(()=>new _),[R]=d.useState(()=>new _),[I]=d.useState(()=>new _),[w]=d.useState(()=>new re),[M]=d.useState(()=>new _(0,0,-1)),[P]=d.useState(()=>new Qi),[O]=d.useState(()=>new _),[z]=d.useState(()=>new _),[D]=d.useState(()=>new Qi),[F]=d.useState(()=>new re),[k]=d.useState(()=>new He),$=d.useCallback(()=>{var j;const L=A.current.parent||((j=A.current)==null||(j=j.__r3f.parent)==null?void 0:j.object);if(!L||(R.setFromMatrixPosition(L.matrixWorld),I.setFromMatrixPosition(y.matrixWorld),w.extractRotation(L.matrixWorld),b.set(0,0,1),b.applyMatrix4(w),R.addScaledVector(b,f),O.subVectors(R,I),O.dot(b)>0))return;O.reflect(b).negate(),O.add(R),w.extractRotation(y.matrixWorld),M.set(0,0,-1),M.applyMatrix4(w),M.add(I),z.subVectors(R,M),z.reflect(b).negate(),z.add(R),k.position.copy(O),k.up.set(0,1,0),k.up.applyMatrix4(w),k.up.reflect(b),k.lookAt(z),k.far=y.far,k.updateMatrixWorld(),k.projectionMatrix.copy(y.projectionMatrix),F.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),F.multiply(k.projectionMatrix),F.multiply(k.matrixWorldInverse),F.multiply(L.matrixWorld),C.setFromNormalAndCoplanarPoint(b,R),C.applyMatrix4(k.matrixWorldInverse),P.set(C.normal.x,C.normal.y,C.normal.z,C.constant);const X=k.projectionMatrix;D.x=(Math.sign(P.x)+X.elements[8])/X.elements[0],D.y=(Math.sign(P.y)+X.elements[9])/X.elements[5],D.z=-1,D.w=(1+X.elements[10])/X.elements[14],P.multiplyScalar(2/P.dot(D)),X.elements[2]=P.x,X.elements[6]=P.y,X.elements[10]=P.z+1,X.elements[14]=P.w},[y,f]),[U,N,B,G]=d.useMemo(()=>{const j={minFilter:Ji,magFilter:Ji,type:tn},L=new Ze(t,t,j);L.depthBuffer=!0,L.depthTexture=new bl(t,t),L.depthTexture.format=ef,L.depthTexture.type=tf;const X=new Ze(t,t,j),Q=new y6({gl:g,resolution:t,width:x,height:T,minDepthThreshold:n,maxDepthThreshold:r,depthScale:o,depthToBlurRatioBias:a}),ne={mirror:c,textureMatrix:F,mixBlur:s,tDiffuse:L.texture,tDepth:L.depthTexture,tDiffuseBlur:X.texture,hasBlur:E,mixStrength:e,minDepthThreshold:n,maxDepthThreshold:r,depthScale:o,depthToBlurRatioBias:a,distortion:l,distortionMap:h,mixContrast:u,"defines-USE_BLUR":E?"":void 0,"defines-USE_DEPTH":o>0?"":void 0,"defines-USE_DISTORTION":h?"":void 0};return[L,X,Q,ne]},[g,x,T,F,t,c,E,s,e,n,r,o,a,l,h,u]);return ee(()=>{var j;const L=A.current.parent||((j=A.current)==null||(j=j.__r3f.parent)==null?void 0:j.object);if(!L)return;L.visible=!1;const X=g.xr.enabled,Q=g.shadowMap.autoUpdate;$(),g.xr.enabled=!1,g.shadowMap.autoUpdate=!1,g.setRenderTarget(U),g.state.buffers.depth.setMask(!0),g.autoClear||g.clear(),g.render(v,k),E&&B.render(g,U,N),g.xr.enabled=X,g.shadowMap.autoUpdate=Q,L.visible=!0,g.setRenderTarget(null)}),d.createElement("meshReflectorMaterialImpl",Z({attach:"material",key:"key"+G["defines-USE_BLUR"]+G["defines-USE_DEPTH"]+G["defines-USE_DISTORTION"],ref:A},G,m))}),E6=xi({envMap:null,bounces:3,ior:2.4,correctMips:!0,aberrationStrength:.01,fresnel:0,bvh:new bf,color:new we("white"),opacity:1,resolution:new de,viewMatrixInverse:new re,projectionMatrixInverse:new re},`
  uniform mat4 viewMatrixInverse;

  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_vertex>

  void main() {
    #include <color_vertex>

    vec4 transformedNormal = vec4(normal, 0.0);
    vec4 transformedPosition = vec4(position, 1.0);
    #ifdef USE_INSTANCING
      transformedNormal = instanceMatrix * transformedNormal;
      transformedPosition = instanceMatrix * transformedPosition;
    #endif

    #ifdef USE_INSTANCING
      vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);
    #else
      vModelMatrixInverse = inverse(modelMatrix);
    #endif

    vWorldPosition = (modelMatrix * transformedPosition).xyz;
    vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;
  }`,`
  #define ENVMAP_TYPE_CUBE_UV
  precision highp isampler2D;
  precision highp usampler2D;
  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    uniform samplerCube envMap;
  #else
    uniform sampler2D envMap;
  #endif

  uniform float bounces;
  ${o2}
  ${a2}
  uniform BVH bvh;
  uniform float ior;
  uniform bool correctMips;
  uniform vec2 resolution;
  uniform float fresnel;
  uniform mat4 modelMatrix;
  uniform mat4 projectionMatrixInverse;
  uniform mat4 viewMatrixInverse;
  uniform float aberrationStrength;
  uniform vec3 color;
  uniform float opacity;

  float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {
    return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );
  }

  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {
    vec3 rayOrigin = ro;
    vec3 rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = vWorldPosition + rayDirection * 0.001;
    rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;
    rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);
    for(float i = 0.0; i < bounces; i++) {
      uvec4 faceIndices = uvec4( 0u );
      vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );
      vec3 barycoord = vec3( 0.0 );
      float side = 1.0;
      float dist = 0.0;
      bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );
      vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);
      vec3 tempDir = refract(rayDirection, faceNormal, ior);
      if (length(tempDir) != 0.0) {
        rayDirection = tempDir;
        break;
      }
      rayDirection = reflect(rayDirection, faceNormal);
      rayOrigin = hitPos + rayDirection * 0.01;
    }
    rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);
    return rayDirection;
  }

  #include <common>
  #include <cube_uv_reflection_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));
    }
  #else
    vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      vec2 uvv = equirectUv( rayDirection );
      vec2 smoothUv = equirectUv( directionCamPerfect );
      return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));
    }
  #endif

  void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;
    directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;
    directionCamPerfect = normalize(directionCamPerfect);
    vec3 normal = vNormal;
    vec3 rayOrigin = cameraPosition;
    vec3 rayDirection = normalize(vWorldPosition - cameraPosition);

    vec4 diffuseColor = vec4(color, opacity);
    #include <color_fragment>

    #ifdef CHROMATIC_ABERRATIONS
      vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      #ifdef FAST_CHROMA
        vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));
        vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));
      #else
        vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);
        vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);
      #endif
      float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;
      float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;
      float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;
      diffuseColor.rgb *= vec3(finalColorR, finalColorG, finalColorB);
    #else
      rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      diffuseColor.rgb *= textureGradient(envMap, rayDirection, directionCamPerfect).rgb;
    #endif

    vec3 viewDirection = normalize(vWorldPosition - cameraPosition);
    float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;
    gl_FragColor = vec4(mix(diffuseColor.rgb, vec3(1.0), nFresnel), diffuseColor.a);

    #include <tonemapping_fragment>
    #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
  }`),A6=s=>s&&s.isCubeTexture;function S6({aberrationStrength:s=0,fastChroma:e=!0,envMap:t,...i}){ft({MeshRefractionMaterial:E6});const n=d.useRef(null),{size:r}=H(),o=d.useMemo(()=>{var a,c;const l={},u=A6(t),f=((a=u?(c=t.image[0])==null?void 0:c.width:t.image.width)!==null&&a!==void 0?a:1024)/4,m=Math.floor(Math.log2(f)),p=Math.pow(2,m),g=3*Math.max(p,112),y=4*p;return u&&(l.ENVMAP_TYPE_CUBEM=""),l.CUBEUV_TEXEL_WIDTH=`${1/g}`,l.CUBEUV_TEXEL_HEIGHT=`${1/y}`,l.CUBEUV_MAX_MIP=`${m}.0`,s>0&&(l.CHROMATIC_ABERRATIONS=""),e&&(l.FAST_CHROMA=""),l},[s,e]);return d.useLayoutEffect(()=>{var a;const c=(a=n.current)==null||(a=a.__r3f)==null||(a=a.parent)==null||(a=a.object)==null?void 0:a.geometry;c&&(n.current.bvh=new bf,n.current.bvh.updateFrom(new l2(c.clone().toNonIndexed(),{strategy:Pl})))},[]),ee(({camera:a})=>{n.current.viewMatrixInverse=a.matrixWorld,n.current.projectionMatrixInverse=a.projectionMatrixInverse}),d.createElement("meshRefractionMaterial",Z({key:JSON.stringify(o),defines:o,ref:n,resolution:[r.width,r.height],aberrationStrength:s,envMap:t},i))}const T6=d.forwardRef((s,e)=>(ft({DiscardMaterialImpl:df}),d.createElement("discardMaterialImpl",Z({ref:e},s))));function b6(s){const e=d.useRef(null);return d.useLayoutEffect(()=>{const t=e.current.parent,i=t?.geometry;if(i){const n=t.material;t.material=e.current.__r3f.children.map(o=>o.object);const r=[...i.groups];return i.clearGroups(),t.material.forEach((o,a)=>{a<t.material.length-1&&(o.depthWrite=!1),i.addGroup(0,1/0,a)}),()=>{t.material=n,i.groups=r}}}),d.createElement("group",Z({ref:e},s))}const ha=pt>=154?"opaque_fragment":"output_fragment";class Km extends o1{constructor(e){super(e),this.onBeforeCompile=(t,i)=>{const{isWebGL2:n}=i.capabilities;t.fragmentShader=t.fragmentShader.replace(`#include <${ha}>`,`
        ${n?`#include <${ha}>`:`#extension GL_OES_standard_derivatives : enable
#include <${ha}>`}
      vec2 cxy = 2.0 * gl_PointCoord - 1.0;
      float r = dot(cxy, cxy);
      float delta = fwidth(r);     
      float mask = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);
      gl_FragColor = vec4(gl_FragColor.rgb, mask * gl_FragColor.a );
      #include <tonemapping_fragment>
      #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
      `)}}}const C6=d.forwardRef((s,e)=>{const[t]=d.useState(()=>new Km(null));return d.createElement("primitive",Z({},s,{object:t,ref:e,attach:"material"}))}),R6=({focus:s=0,size:e=25,samples:t=10}={})=>`
#define PENUMBRA_FILTER_SIZE float(${e})
#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))
vec3 randRGB(vec2 uv) {
  return vec3(
    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),
    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),
    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)
  );
}

vec3 lowPassRandRGB(vec2 uv) {
  // 3x3 convolution (average)
  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9
  vec3 result = vec3(0);
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));
  result *= 0.111111111; // 1.0 / 9.0
  return result;
}
vec3 highPassRandRGB(vec2 uv) {
  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal
  // hp(x) = x - lp(x)
  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;
}


vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {
  const float goldenAngle = 2.399963f; // radians
  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));
  float theta = float(sampleIndex) * goldenAngle + angle;
  float sine = sin(theta);
  float cosine = cos(theta);
  return vec2(cosine, sine) * r;
}
float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
  return (zReceiver - zBlocker) / zBlocker;
}
float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float blockerDepthSum = float(${s});
  float blockers = 0.0;

  int j = 0;
  vec2 offset = vec2(0.);
  float depth = 0.;

  #pragma unroll_loop_start
  for(int i = 0; i < ${t}; i ++) {
    offset = (vogelDiskSample(j, ${t}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;
    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));
    if (depth < compare) {
      blockerDepthSum += depth;
      blockers++;
    }
    j++;
  }
  #pragma unroll_loop_end

  if (blockers > 0.0) {
    return blockerDepthSum / blockers;
  }
  return -1.0;
}

        
float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float shadow = 0.0f;
  int j = 0;
  vec2 vogelSample = vec2(0.0);
  vec2 offset = vec2(0.0);
  #pragma unroll_loop_start
  for (int i = 0; i < ${t}; i++) {
    vogelSample = vogelDiskSample(j, ${t}, angle) * texelSize;
    offset = vogelSample * (1.0 + filterRadius * float(${e}));
    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );
    j++;
  }
  #pragma unroll_loop_end
  return shadow * 1.0 / ${t}.0;
}

float PCSS (sampler2D shadowMap, vec4 coords) {
  vec2 uv = coords.xy;
  float zReceiver = coords.z; // Assumed to be eye-space z in this code
  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;
  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);
  if (avgBlockerDepth == -1.0) {
    return 1.0;
  }
  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);
  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);
}`;function yh(s,e,t){e.traverse(i=>{i.material&&(s.properties.remove(i.material),i.material.dispose==null||i.material.dispose())}),s.info.programs.length=0,s.compile(e,t)}function w6({focus:s=0,samples:e=10,size:t=25}){const i=H(o=>o.gl),n=H(o=>o.scene),r=H(o=>o.camera);return d.useEffect(()=>{const o=ts.shadowmap_pars_fragment;return ts.shadowmap_pars_fragment=ts.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
`+R6({size:t,samples:e,focus:s})).replace("#if defined( SHADOWMAP_TYPE_PCF )",`
return PCSS(shadowMap, shadowCoord);
#if defined( SHADOWMAP_TYPE_PCF )`),yh(i,n,r),()=>{ts.shadowmap_pars_fragment=o,yh(i,n,r)}},[s,t,e]),null}function tt(s,e){const t=s+"Geometry";return d.forwardRef(({args:i,children:n,...r},o)=>{const a=d.useRef(null);return d.useImperativeHandle(o,()=>a.current),d.useLayoutEffect(()=>void e?.(a.current)),d.createElement("mesh",Z({ref:a},r),d.createElement(t,{attach:"geometry",args:i}),n)})}const I6=tt("box"),_6=tt("circle"),L6=tt("cone"),P6=tt("cylinder"),M6=tt("sphere"),D6=tt("plane"),B6=tt("tube"),F6=tt("torus"),k6=tt("torusKnot"),O6=tt("tetrahedron"),N6=tt("ring"),U6=tt("polyhedron"),z6=tt("icosahedron"),G6=tt("octahedron"),$6=tt("dodecahedron"),H6=tt("extrude"),K6=tt("lathe"),V6=tt("capsule"),j6=tt("shape",({geometry:s})=>{const e=s.attributes.position,t=new gi().setFromBufferAttribute(e),i=new _;t.getSize(i);const n=[];let r=0,o=0,a=0,c=0;for(let l=0;l<e.count;l++)r=e.getX(l),o=e.getY(l),a=(r-t.min.x)/i.x,c=(o-t.min.y)/i.y,n.push(a,c);s.setAttribute("uv",new Er(n,2))}),jt=1e-5;function W6(s,e,t){const i=new rf,n=t-jt;return i.absarc(jt,jt,jt,-Math.PI/2,-Math.PI,!0),i.absarc(jt,e-n*2,jt,Math.PI,Math.PI/2,!0),i.absarc(s-n*2,e-n*2,jt,Math.PI/2,0,!0),i.absarc(s-n*2,jt,jt,0,-Math.PI/2,!0),i}const X6=d.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:n=.05,steps:r=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:c=.4,children:l,...u},h){return d.createElement("mesh",Z({ref:h},u),d.createElement(Vm,{args:[e,t,i],radius:n,steps:r,smoothness:o,bevelSegments:a,creaseAngle:c}),l)}),Vm=d.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:n=.05,steps:r=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:c=.4,...l},u){const h=d.useMemo(()=>W6(e,t,n),[e,t,n]),f=d.useMemo(()=>({depth:i-n*2,bevelEnabled:!0,bevelSegments:a*2,steps:r,bevelSize:n-jt,bevelThickness:n,curveSegments:o}),[i,n,o,a,r]),m=d.useRef(null);return d.useLayoutEffect(()=>{m.current&&(m.current.center(),Kd(m.current,c))},[h,f,c]),d.useImperativeHandle(u,()=>m.current),d.createElement("extrudeGeometry",Z({ref:m,args:[h,f]},l))});function Y6(){const s=new Zt,e=new Float32Array([-1,-1,3,-1,-1,3]);return s.boundingSphere=new yi,s.boundingSphere.set(new _,1/0),s.setAttribute("position",new fi(e,2)),s}const Q6=d.forwardRef(function({children:e,...t},i){const n=d.useMemo(Y6,[]);return d.createElement("mesh",Z({ref:i,geometry:n,frustumCulled:!1},t),e)}),J6=d.forwardRef(({children:s,width:e,height:t,depth:i,box3:n,precise:r=!0,...o},a)=>{const c=d.useRef(null),l=d.useRef(null),u=d.useRef(null);return d.useLayoutEffect(()=>{l.current.matrixWorld.identity();let h=n||new gi().setFromObject(u.current,r);const f=h.max.x-h.min.x,m=h.max.y-h.min.y,p=h.max.z-h.min.z;let g=Math.max(f,m,p);e&&(g=f),t&&(g=m),i&&(g=p),l.current.scale.setScalar(1/g)},[e,t,i,n,r]),d.useImperativeHandle(a,()=>c.current,[]),d.createElement("group",Z({ref:c},o),d.createElement("group",{ref:l},d.createElement("group",{ref:u},s)))});var Pt=(function(s){return s[s.NONE=0]="NONE",s[s.START=1]="START",s[s.ACTIVE=2]="ACTIVE",s})(Pt||{});const fn=s=>s&&s.isOrthographicCamera,q6=s=>s&&s.isBox3,Z6=s=>1-Math.exp(-5*s)+.007*s,jm=d.createContext(null);function Wm({children:s,maxDuration:e=1,margin:t=1.2,observe:i,fit:n,clip:r,interpolateFunc:o=Z6,onFit:a}){const c=d.useRef(null),{camera:l,size:u,invalidate:h}=H(),f=H(A=>A.controls),m=d.useRef(a);m.current=a;const p=d.useRef({camPos:new _,camRot:new ue,camZoom:1}),g=d.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),y=d.useRef(Pt.NONE),v=d.useRef(0),[E]=d.useState(()=>new gi),x=d.useMemo(()=>{function A(){const C=E.getSize(new _),b=E.getCenter(new _),R=Math.max(C.x,C.y,C.z),I=fn(l)?R*4:R/(2*Math.atan(Math.PI*l.fov/360)),w=fn(l)?R*4:I/l.aspect,M=t*Math.max(I,w);return{box:E,size:C,center:b,distance:M}}return{getSize:A,refresh(C){if(q6(C))E.copy(C);else{const b=C||c.current;if(!b)return this;b.updateWorldMatrix(!0,!0),E.setFromObject(b)}if(E.isEmpty()){const b=l.position.length()||10;E.setFromCenterAndSize(new _,new _(b,b,b))}return p.current.camPos.copy(l.position),p.current.camRot.copy(l.quaternion),fn(l)&&(p.current.camZoom=l.zoom),g.current.camPos=void 0,g.current.camRot=void 0,g.current.camZoom=void 0,g.current.camUp=void 0,g.current.target=void 0,this},reset(){const{center:C,distance:b}=A(),R=l.position.clone().sub(C).normalize();g.current.camPos=C.clone().addScaledVector(R,b),g.current.target=C.clone();const I=new re().lookAt(g.current.camPos,g.current.target,l.up);return g.current.camRot=new ue().setFromRotationMatrix(I),y.current=Pt.START,v.current=0,this},moveTo(C){return g.current.camPos=Array.isArray(C)?new _(...C):C.clone(),y.current=Pt.START,v.current=0,this},lookAt({target:C,up:b}){g.current.target=Array.isArray(C)?new _(...C):C.clone(),b?g.current.camUp=Array.isArray(b)?new _(...b):b.clone():g.current.camUp=l.up.clone();const R=new re().lookAt(g.current.camPos||l.position,g.current.target,g.current.camUp);return g.current.camRot=new ue().setFromRotationMatrix(R),y.current=Pt.START,v.current=0,this},to({position:C,target:b}){return this.moveTo(C).lookAt({target:b})},fit(){if(!fn(l))return this.reset();let C=0,b=0;const R=[new _(E.min.x,E.min.y,E.min.z),new _(E.min.x,E.max.y,E.min.z),new _(E.min.x,E.min.y,E.max.z),new _(E.min.x,E.max.y,E.max.z),new _(E.max.x,E.max.y,E.max.z),new _(E.max.x,E.max.y,E.min.z),new _(E.max.x,E.min.y,E.max.z),new _(E.max.x,E.min.y,E.min.z)],I=g.current.camPos||l.position,w=g.current.target||f?.target,M=g.current.camUp||l.up,P=w?new re().lookAt(I,w,M).setPosition(I).invert():l.matrixWorldInverse;for(const D of R)D.applyMatrix4(P),C=Math.max(C,Math.abs(D.y)),b=Math.max(b,Math.abs(D.x));C*=2,b*=2;const O=(l.top-l.bottom)/C,z=(l.right-l.left)/b;return g.current.camZoom=Math.min(O,z)/t,y.current=Pt.START,v.current=0,m.current&&m.current(this.getSize()),this},clip(){const{distance:C}=A();return l.near=C/100,l.far=C*100,l.updateProjectionMatrix(),f&&(f.maxDistance=C*10,f.update()),h(),this}}},[E,l,f,t,h]);d.useLayoutEffect(()=>{if(f){const A=()=>{if(f&&g.current.target&&y.current!==Pt.NONE){const C=new _().setFromMatrixColumn(l.matrix,2),b=p.current.camPos.distanceTo(f.target),R=(g.current.camPos||p.current.camPos).distanceTo(g.current.target),I=(1-v.current)*b+v.current*R;f.target.copy(l.position).addScaledVector(C,-I),f.update()}y.current=Pt.NONE};return f.addEventListener("start",A),()=>f.removeEventListener("start",A)}},[f]);const T=d.useRef(0);return d.useLayoutEffect(()=>{(i||T.current++===0)&&(x.refresh(),n&&x.reset().fit(),r&&x.clip())},[u,r,n,i,l,f]),ee((A,C)=>{if(y.current===Pt.START)y.current=Pt.ACTIVE,h();else if(y.current===Pt.ACTIVE){if(v.current+=C/e,v.current>=1)g.current.camPos&&l.position.copy(g.current.camPos),g.current.camRot&&l.quaternion.copy(g.current.camRot),g.current.camUp&&l.up.copy(g.current.camUp),g.current.camZoom&&fn(l)&&(l.zoom=g.current.camZoom),l.updateMatrixWorld(),l.updateProjectionMatrix(),f&&g.current.target&&(f.target.copy(g.current.target),f.update()),y.current=Pt.NONE;else{const b=o(v.current);g.current.camPos&&l.position.lerpVectors(p.current.camPos,g.current.camPos,b),g.current.camRot&&l.quaternion.slerpQuaternions(p.current.camRot,g.current.camRot,b),g.current.camUp&&l.up.set(0,1,0).applyQuaternion(l.quaternion),g.current.camZoom&&fn(l)&&(l.zoom=(1-b)*p.current.camZoom+b*g.current.camZoom),l.updateMatrixWorld(),l.updateProjectionMatrix()}h()}}),d.createElement("group",{ref:c},d.createElement(jm.Provider,{value:x},s))}function Xm(){return d.useContext(jm)}const e8=d.forwardRef(({intensity:s=1,decay:e,decayRate:t=.65,maxYaw:i=.1,maxPitch:n=.1,maxRoll:r=.1,yawFrequency:o=.1,pitchFrequency:a=.1,rollFrequency:c=.1},l)=>{const u=H(E=>E.camera),h=H(E=>E.controls),f=d.useRef(s),m=d.useRef(u.rotation.clone()),[p]=d.useState(()=>new Mo),[g]=d.useState(()=>new Mo),[y]=d.useState(()=>new Mo),v=()=>{(f.current<0||f.current>1)&&(f.current=f.current<0?0:1)};return d.useImperativeHandle(l,()=>({getIntensity:()=>f.current,setIntensity:E=>{f.current=E,v()}}),[]),d.useEffect(()=>{if(h){const E=()=>void(m.current=u.rotation.clone());return h.addEventListener("change",E),E(),()=>void h.removeEventListener("change",E)}},[u,h]),ee((E,x)=>{const T=Math.pow(f.current,2),A=i*T*p.noise(E.clock.elapsedTime*o,1),C=n*T*g.noise(E.clock.elapsedTime*a,1),b=r*T*y.noise(E.clock.elapsedTime*c,1);u.rotation.set(m.current.x+C,m.current.y+A,m.current.z+b),e&&f.current>0&&(f.current-=t*x,v())}),null}),t8=d.forwardRef(({children:s,enabled:e=!0,speed:t=1,rotationIntensity:i=1,floatIntensity:n=1,floatingRange:r=[-.1,.1],autoInvalidate:o=!1,...a},c)=>{const l=d.useRef(null);d.useImperativeHandle(c,()=>l.current,[]);const u=d.useRef(Math.random()*1e4);return ee(h=>{var f,m;if(!e||t===0)return;o&&h.invalidate();const p=u.current+h.clock.elapsedTime;l.current.rotation.x=Math.cos(p/4*t)/8*i,l.current.rotation.y=Math.sin(p/4*t)/8*i,l.current.rotation.z=Math.sin(p/4*t)/20*i;let g=Math.sin(p/4*t)/10;g=me.mapLinear(g,-.1,.1,(f=r?.[0])!==null&&f!==void 0?f:-.1,(m=r?.[1])!==null&&m!==void 0?m:.1),l.current.position.y=g*n,l.current.updateMatrix()}),d.createElement("group",a,d.createElement("group",{ref:l,matrixAutoUpdate:!1},s))});function i8(s){return s.isLight}function n8(s){return!!s.geometry}const cc=d.createContext(null),s8=xi({color:new we,blend:2,alphaTest:.75,opacity:0,map:null},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vUv = uv;
   }`,`varying vec2 vUv;
   uniform sampler2D map;
   uniform vec3 color;
   uniform float opacity;
   uniform float alphaTest;
   uniform float blend;
   void main() {
     vec4 sampledDiffuseColor = texture2D(map, vUv);
     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);
     #include <tonemapping_fragment>
     #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),Ym=d.forwardRef(({children:s,temporal:e,frames:t=40,limit:i=1/0,blend:n=20,scale:r=10,opacity:o=1,alphaTest:a=.75,color:c="black",colorBlend:l=2,resolution:u=1024,toneMapped:h=!0,...f},m)=>{ft({SoftShadowMaterial:s8});const p=H(C=>C.gl),g=H(C=>C.scene),y=H(C=>C.camera),v=H(C=>C.invalidate),E=d.useRef(null),x=d.useRef(null),[T]=d.useState(()=>new r8(p,g,u));d.useLayoutEffect(()=>{T.configure(E.current)},[]);const A=d.useMemo(()=>({lights:new Map,temporal:!!e,frames:Math.max(2,t),blend:Math.max(2,t===1/0?n:t),count:0,getMesh:()=>E.current,reset:()=>{T.clear();const C=E.current.material;C.opacity=0,C.alphaTest=0,A.count=0},update:(C=1)=>{const b=E.current.material;A.temporal?(b.opacity=Math.min(o,b.opacity+o/A.blend),b.alphaTest=Math.min(a,b.alphaTest+a/A.blend)):(b.opacity=o,b.alphaTest=a),x.current.visible=!0,T.prepare();for(let R=0;R<C;R++)A.lights.forEach(I=>I.update()),T.update(y,A.blend);x.current.visible=!1,T.finish()}}),[T,y,g,e,t,n,o,a]);return d.useLayoutEffect(()=>{A.reset(),!A.temporal&&A.frames!==1/0&&A.update(A.blend)}),d.useImperativeHandle(m,()=>A,[A]),ee(()=>{(A.temporal||A.frames===1/0)&&A.count<A.frames&&A.count<i&&(v(),A.update(),A.count++)}),d.createElement("group",f,d.createElement("group",{traverse:()=>null,ref:x},d.createElement(cc.Provider,{value:A},s)),d.createElement("mesh",{receiveShadow:!0,ref:E,scale:r,rotation:[-Math.PI/2,0,0]},d.createElement("planeGeometry",null),d.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:h,color:c,blend:l,map:T.progressiveLightMap2.texture})))}),Qm=d.forwardRef(({castShadow:s=!0,bias:e=.001,mapSize:t=512,size:i=5,near:n=.5,far:r=500,frames:o=1,position:a=[0,0,0],radius:c=1,amount:l=8,intensity:u=pt>=155?Math.PI:1,ambient:h=.5,...f},m)=>{const p=d.useRef(null),g=new _(...a).length(),y=d.useContext(cc),v=d.useCallback(()=>{let x;if(p.current)for(let T=0;T<p.current.children.length;T++)if(x=p.current.children[T],Math.random()>h)x.position.set(a[0]+me.randFloatSpread(c),a[1]+me.randFloatSpread(c),a[2]+me.randFloatSpread(c));else{let A=Math.acos(2*Math.random()-1)-Math.PI/2,C=2*Math.PI*Math.random();x.position.set(Math.cos(A)*Math.cos(C)*g,Math.abs(Math.cos(A)*Math.sin(C)*g),Math.sin(A)*g)}},[c,h,g,...a]),E=d.useMemo(()=>({update:v}),[v]);return d.useImperativeHandle(m,()=>E,[E]),d.useLayoutEffect(()=>{var x;const T=p.current;return y&&((x=y.lights)==null||x.set(T.uuid,E)),()=>{var A;return void(y==null||(A=y.lights)==null?void 0:A.delete(T.uuid))}},[y,E]),d.createElement("group",Z({ref:p},f),Array.from({length:l},(x,T)=>d.createElement("directionalLight",{key:T,castShadow:s,"shadow-bias":e,"shadow-mapSize":[t,t],intensity:u/l},d.createElement("orthographicCamera",{attach:"shadow-camera",args:[-i,i,i,-i,n,r]}))))});class r8{constructor(e,t,i=1024){this.renderer=e,this.res=i,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new we,this.clearAlpha=0;const n={type:tn,magFilter:ht,minFilter:ht};this.progressiveLightMap1=new Ze(this.res,this.res,n),this.progressiveLightMap2=new Ze(this.res,this.res,n),this.discardMat=new df,this.targetMat=new of({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=r=>{r.vertexShader=`varying vec2 vUv;
`+r.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const o=r.fragmentShader.indexOf("void main() {");r.fragmentShader=`varying vec2 vUv;
`+r.fragmentShader.slice(0,o)+`uniform sampler2D previousShadowMap;
	uniform float averagingWindow;
`+r.fragmentShader.slice(o-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv).rgb;
        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);
      }`,r.uniforms.previousShadowMap=this.previousShadowMap,r.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse(e=>{n8(e)?this.meshes.push({object:e,material:e.material}):i8(e)&&this.lights.push({object:e,intensity:e.intensity})})}prepare(){this.lights.forEach(e=>e.object.intensity=0),this.meshes.forEach(e=>e.object.material=this.discardMat)}finish(){this.lights.forEach(e=>e.object.intensity=e.intensity),this.meshes.forEach(e=>e.object.material=e.material)}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;const i=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,n=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,r=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(i),this.previousShadowMap.value=n.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=r}}const o8={rembrandt:{main:[1,2,1],fill:[-2,-.5,-2]},portrait:{main:[-1,2,.5],fill:[-1,.5,-1.5]},upfront:{main:[0,2,1],fill:[-1,.5,-1.5]},soft:{main:[-2,4,4],fill:[-1,.5,-1.5]}};function a8({radius:s,adjustCamera:e}){const t=Xm();return d.useEffect(()=>{e&&t.refresh().clip().fit()},[s,e]),null}function l8({children:s,center:e,adjustCamera:t=!0,intensity:i=.5,shadows:n="contact",environment:r="city",preset:o="rembrandt",...a}){var c,l,u,h,f,m,p,g;const y=typeof o=="string"?o8[o]:o,[{radius:v,height:E},x]=d.useState({radius:0,width:0,height:0,depth:0}),T=(c=n?.bias)!==null&&c!==void 0?c:-1e-4,A=(l=n?.normalBias)!==null&&l!==void 0?l:0,C=(u=n?.size)!==null&&u!==void 0?u:1024,b=(h=n?.offset)!==null&&h!==void 0?h:0,R=n==="contact"||n?.type==="contact",I=n==="accumulative"||n?.type==="accumulative",w={...typeof n=="object"?n:{}},M=r?typeof r=="string"?{preset:r}:r:null,P=d.useCallback(O=>{const{width:z,height:D,depth:F,boundingSphere:k}=O;x({radius:k.radius,width:z,height:D,depth:F}),e!=null&&e.onCentered&&e.onCentered(O)},[]);return d.createElement(d.Fragment,null,d.createElement("ambientLight",{intensity:i/3}),d.createElement("spotLight",{penumbra:1,position:[y.main[0]*v,y.main[1]*v,y.main[2]*v],intensity:i*2,castShadow:!!n,"shadow-bias":T,"shadow-normalBias":A,"shadow-mapSize":C}),d.createElement("pointLight",{position:[y.fill[0]*v,y.fill[1]*v,y.fill[2]*v],intensity:i}),d.createElement(Wm,Z({fit:!!t,clip:!!t,margin:Number(t),observe:!0},a),d.createElement(a8,{radius:v,adjustCamera:t}),d.createElement(Rl,Z({},e,{position:[0,b/2,0],onCentered:P}),s)),d.createElement("group",{position:[0,-E/2-b/2,0]},R&&d.createElement(ff,Z({scale:v*4,far:v,blur:2},w)),I&&d.createElement(Ym,Z({temporal:!0,frames:100,alphaTest:.9,toneMapped:!0,scale:v*4},w),d.createElement(Qm,{amount:(f=w.amount)!==null&&f!==void 0?f:8,radius:(m=w.radius)!==null&&m!==void 0?m:v,ambient:(p=w.ambient)!==null&&p!==void 0?p:.5,intensity:(g=w.intensity)!==null&&g!==void 0?g:1,position:[y.main[0]*v,y.main[1]*v,y.main[2]*v],size:v*4,bias:-T,mapSize:C}))),r&&d.createElement(mf,M))}const c8=s=>s===0?0:Math.pow(2,10*s-10);function u8({children:s,floor:e=.25,segments:t=20,receiveShadow:i,...n}){const r=d.useRef(null);return d.useLayoutEffect(()=>{let o=0;const a=t/t/2,c=r.current.attributes.position;for(let l=0;l<t+1;l++)for(let u=0;u<t+1;u++)c.setXYZ(o++,l/t-a+(l===0?-e:0),u/t-a,c8(l/t));c.needsUpdate=!0,r.current.computeVertexNormals()},[t,e]),d.createElement("group",n,d.createElement("mesh",{receiveShadow:i,rotation:[-Math.PI/2,0,Math.PI/2]},d.createElement("planeGeometry",{ref:r,args:[1,1,t,t]}),s))}const h8=d.forwardRef(({fog:s=!1,renderOrder:e,depthWrite:t=!1,colorStop:i=0,color:n="black",opacity:r=.5,...o},a)=>{const c=d.useMemo(()=>{const l=document.createElement("canvas");l.width=128,l.height=128;const u=l.getContext("2d"),h=u.createRadialGradient(l.width/2,l.height/2,0,l.width/2,l.height/2,l.width/2);return h.addColorStop(i,new we(n).getStyle()),h.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=h,u.fillRect(0,0,l.width,l.height),l},[n,i]);return d.createElement("mesh",Z({renderOrder:e,ref:a,"rotation-x":-Math.PI/2},o),d.createElement("planeGeometry",null),d.createElement("meshBasicMaterial",{transparent:!0,opacity:r,fog:s,depthWrite:t,side:dt},d.createElement("canvasTexture",{attach:"map",args:[c]})))});class d8 extends Ut{constructor(){super({uniforms:{depth:{value:null},opacity:{value:1},attenuation:{value:2.5},anglePower:{value:12},spotPosition:{value:new _(0,0,0)},lightColor:{value:new we("white")},cameraNear:{value:0},cameraFar:{value:1},resolution:{value:new de(0,0)}},transparent:!0,depthWrite:!1,vertexShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;
        uniform vec3 spotPosition;
        uniform float attenuation;

        #include <common>
        #include <logdepthbuf_pars_vertex>

        void main() {
          // compute intensity
          vNormal = normalize(normalMatrix * normal);
          vec4 worldPosition = modelMatrix * vec4(position, 1);
          vec4 viewPosition = viewMatrix * worldPosition;
          vViewZ = viewPosition.z;

          vIntensity = 1.0 - saturate(distance(worldPosition.xyz, spotPosition) / attenuation);

          gl_Position = projectionMatrix * viewPosition;

          #include <logdepthbuf_vertex>
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;

        uniform vec3 lightColor;
        uniform float anglePower;
        uniform sampler2D depth;
        uniform vec2 resolution;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float opacity;

        #include <packing>
        #include <logdepthbuf_pars_fragment>

        float readDepth(sampler2D depthSampler, vec2 uv) {
          float fragCoordZ = texture(depthSampler, uv).r;

          // https://github.com/mrdoob/three.js/issues/23072
          #ifdef USE_LOGDEPTHBUF
            float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));
          #else
            float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
          #endif

          return viewZ;
        }

        void main() {
          #include <logdepthbuf_fragment>

          vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));
          float angleIntensity = pow(dot(normal, vec3(0, 0, 1)), anglePower);
          float intensity = vIntensity * angleIntensity;

          // fades when z is close to sampled depth, meaning the cone is intersecting existing geometry
          bool isSoft = resolution[0] > 0.0 && resolution[1] > 0.0;
          if (isSoft) {
            vec2 uv = gl_FragCoord.xy / resolution;
            intensity *= smoothstep(0.0, 1.0, vViewZ - readDepth(depth, uv));
          }

          gl_FragColor = vec4(lightColor, intensity * opacity);

          #include <tonemapping_fragment>
          #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}}var f8=`#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}`;const m8=s=>s?.isSpotLight;function p8({opacity:s=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:r=5,angle:o=.15,attenuation:a=5,anglePower:c=5}){const l=d.useRef(null),u=H(y=>y.size),h=H(y=>y.camera),f=H(y=>y.viewport.dpr),[m]=d.useState(()=>new d8),[p]=d.useState(()=>new _);e=e===void 0?.1:e,t=t===void 0?o*7:t,ee(()=>{m.uniforms.spotPosition.value.copy(l.current.getWorldPosition(p)),l.current.lookAt(l.current.parent.target.getWorldPosition(p))});const g=d.useMemo(()=>{const y=new wt(e,t,r,128,64,!0);return y.applyMatrix4(new re().makeTranslation(0,-r/2,0)),y.applyMatrix4(new re().makeRotationX(-Math.PI/2)),y},[r,e,t]);return d.createElement(d.Fragment,null,d.createElement("mesh",{ref:l,geometry:g,raycast:()=>null},d.createElement("primitive",{object:m,attach:"material","uniforms-opacity-value":s,"uniforms-lightColor-value":n,"uniforms-attenuation-value":a,"uniforms-anglePower-value":c,"uniforms-depth-value":i,"uniforms-cameraNear-value":h.near,"uniforms-cameraFar-value":h.far,"uniforms-resolution-value":i?[u.width*f,u.height*f]:[0,0]})))}function Jm(s,e,t,i,n){const[[r,o]]=d.useState(()=>[new _,new _]);d.useLayoutEffect(()=>{if(m8(s.current))s.current.shadow.mapSize.set(t,i),s.current.shadow.needsUpdate=!0;else throw new Error("SpotlightShadow must be a child of a SpotLight")},[s,t,i]),ee(()=>{if(!s.current)return;const a=s.current.position,c=s.current.target.position;o.copy(c).sub(a);var l=o.length();o.normalize().multiplyScalar(l*n),r.copy(a).add(o),e.current.position.copy(r),e.current.lookAt(s.current.target.position)})}function g8({distance:s=.4,alphaTest:e=.5,map:t,shader:i=f8,width:n=512,height:r=512,scale:o=1,children:a,...c}){const l=d.useRef(null),u=c.spotlightRef,h=c.debug;Jm(u,l,n,r,s);const f=d.useMemo(()=>new Ze(n,r,{format:Sl,stencilBuffer:!1}),[n,r]),m=d.useRef({uShadowMap:{value:t},uTime:{value:0}});d.useEffect(()=>void(m.current.uShadowMap.value=t),[t]);const p=d.useMemo(()=>new Vi(new Ut({uniforms:m.current,vertexShader:`
          varying vec2 vUv;

          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
          `,fragmentShader:i})),[i]);return d.useEffect(()=>()=>{p.material.dispose(),p.dispose()},[p]),d.useEffect(()=>()=>f.dispose(),[f]),ee(({gl:g},y)=>{m.current.uTime.value+=y,g.setRenderTarget(f),p.render(g),g.setRenderTarget(null)}),d.createElement(d.Fragment,null,d.createElement("mesh",{ref:l,scale:o,castShadow:!0},d.createElement("planeGeometry",null),d.createElement("meshBasicMaterial",{transparent:!0,side:dt,alphaTest:e,alphaMap:f.texture,"alphaMap-wrapS":Mn,"alphaMap-wrapT":Mn,opacity:h?1:0},a)))}function y8({distance:s=.4,alphaTest:e=.5,map:t,width:i=512,height:n=512,scale:r,children:o,...a}){const c=d.useRef(null),l=a.spotlightRef,u=a.debug;return Jm(l,c,i,n,s),d.createElement(d.Fragment,null,d.createElement("mesh",{ref:c,scale:r,castShadow:!0},d.createElement("planeGeometry",null),d.createElement("meshBasicMaterial",{transparent:!0,side:dt,alphaTest:e,alphaMap:t,"alphaMap-wrapS":Mn,"alphaMap-wrapT":Mn,opacity:u?1:0},o)))}function v8(s){return s.shader?d.createElement(g8,s):d.createElement(y8,s)}const x8=d.forwardRef(({opacity:s=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:r=5,angle:o=.15,attenuation:a=5,anglePower:c=5,volumetric:l=!0,debug:u=!1,children:h,...f},m)=>{const p=d.useRef(null);return d.useImperativeHandle(m,()=>p.current,[]),d.createElement("group",null,u&&p.current&&d.createElement("spotLightHelper",{args:[p.current]}),d.createElement("spotLight",Z({ref:p,angle:o,color:n,distance:r,castShadow:!0},f),l&&d.createElement(p8,{debug:u,opacity:s,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n,distance:r,angle:o,attenuation:a,anglePower:c})),h&&d.cloneElement(h,{spotlightRef:p,debug:u}))});function qm(s,e,t=new _){const i=Math.PI*(s-.5),n=2*Math.PI*(e-.5);return t.x=Math.cos(n),t.y=Math.sin(i),t.z=Math.sin(n),t}const E8=d.forwardRef(({inclination:s=.6,azimuth:e=.1,distance:t=1e3,mieCoefficient:i=.005,mieDirectionalG:n=.8,rayleigh:r=.5,turbidity:o=10,sunPosition:a=qm(s,e),...c},l)=>{const u=d.useMemo(()=>new _().setScalar(t),[t]),[h]=d.useState(()=>new c2);return d.createElement("primitive",Z({object:h,ref:l,"material-uniforms-mieCoefficient-value":i,"material-uniforms-mieDirectionalG-value":n,"material-uniforms-rayleigh-value":r,"material-uniforms-sunPosition-value":a,"material-uniforms-turbidity-value":o,scale:u},c))});class A8 extends Ut{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:`
      uniform float time;
      attribute float size;
      varying vec3 vColor;
      void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);
        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));
        gl_Position = projectionMatrix * mvPosition;
      }`,fragmentShader:`
      uniform sampler2D pointTexture;
      uniform float fade;
      varying vec3 vColor;
      void main() {
        float opacity = 1.0;
        if (fade == 1.0) {
          float d = distance(gl_PointCoord, vec2(0.5, 0.5));
          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));
        }
        gl_FragColor = vec4(vColor, opacity);

        #include <tonemapping_fragment>
	      #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
      }`})}}const S8=s=>new _().setFromSpherical(new El(s,Math.acos(1-Math.random()*2),Math.random()*2*Math.PI)),T8=d.forwardRef(({radius:s=100,depth:e=50,count:t=5e3,saturation:i=0,factor:n=4,fade:r=!1,speed:o=1},a)=>{const c=d.useRef(null),[l,u,h]=d.useMemo(()=>{const m=[],p=[],g=Array.from({length:t},()=>(.5+.5*Math.random())*n),y=new we;let v=s+e;const E=e/t;for(let x=0;x<t;x++)v-=E*Math.random(),m.push(...S8(v).toArray()),y.setHSL(x/t,i,.9),p.push(y.r,y.g,y.b);return[new Float32Array(m),new Float32Array(p),new Float32Array(g)]},[t,e,n,s,i]);ee(m=>c.current&&(c.current.uniforms.time.value=m.clock.elapsedTime*o));const[f]=d.useState(()=>new A8);return d.createElement("points",{ref:a},d.createElement("bufferGeometry",null,d.createElement("bufferAttribute",{attach:"attributes-position",args:[l,3]}),d.createElement("bufferAttribute",{attach:"attributes-color",args:[u,3]}),d.createElement("bufferAttribute",{attach:"attributes-size",args:[h,1]})),d.createElement("primitive",{ref:c,object:f,attach:"material",blending:a1,"uniforms-fade-value":r,depthWrite:!1,transparent:!0,vertexColors:!0}))}),b8="https://rawcdn.githack.com/pmndrs/drei-assets/9225a9f1fbd449d9411125c2f419b843d0308c9f/cloud.png",vh=new re,er=new _,tr=new ue,xh=new _,Eh=new ue,Vn=new _,uc=d.createContext(null),Zm=d.forwardRef(({children:s,material:e=of,texture:t=b8,range:i,limit:n=200,frustumCulled:r,...o},a)=>{var c,l;const u=d.useMemo(()=>class extends e{constructor(){super();const R=parseInt(l1.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=I=>{I.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+I.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),I.fragmentShader=`varying float vOpacity;
              `+I.fragmentShader.replace(`#include <${R}>`,`#include <${R}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}},[e]);ft({CloudMaterial:u});const h=d.useRef(null),f=d.useRef([]),m=d.useMemo(()=>new Float32Array(Array.from({length:n},()=>1)),[n]),p=d.useMemo(()=>new Float32Array(Array.from({length:n},()=>[1,1,1]).flat()),[n]),g=Oi(t);let y=0,v=0,E;const x=new ue,T=new _(0,0,1),A=new _;ee((R,I)=>{for(y=R.clock.elapsedTime,vh.copy(h.current.matrixWorld).invert(),R.camera.matrixWorld.decompose(xh,Eh,Vn),v=0;v<f.current.length;v++)E=f.current[v],E.ref.current.matrixWorld.decompose(er,tr,Vn),er.add(A.copy(E.position).applyQuaternion(tr).multiply(Vn)),tr.copy(Eh).multiply(x.setFromAxisAngle(T,E.rotation+=I*E.rotationFactor)),Vn.multiplyScalar(E.volume+(1+Math.sin(y*E.density*E.speed))/2*E.growth),E.matrix.compose(er,tr,Vn).premultiply(vh),E.dist=er.distanceTo(xh);for(f.current.sort((w,M)=>M.dist-w.dist),v=0;v<f.current.length;v++)E=f.current[v],m[v]=E.opacity*(E.dist<E.fade-1?E.dist/E.fade:1),h.current.setMatrixAt(v,E.matrix),h.current.setColorAt(v,E.color);h.current.geometry.attributes.cloudOpacity.needsUpdate=!0,h.current.instanceMatrix.needsUpdate=!0,h.current.instanceColor&&(h.current.instanceColor.needsUpdate=!0)}),d.useLayoutEffect(()=>{const R=Math.min(n,i!==void 0?i:n,f.current.length);h.current.count=R,Lo(h.current.instanceMatrix,{start:0,count:R*16}),h.current.instanceColor&&Lo(h.current.instanceColor,{start:0,count:R*3}),Lo(h.current.geometry.attributes.cloudOpacity,{start:0,count:R})});let C=[(c=g.image.width)!==null&&c!==void 0?c:1,(l=g.image.height)!==null&&l!==void 0?l:1];const b=Math.max(C[0],C[1]);return C=[C[0]/b,C[1]/b],d.createElement("group",Z({ref:a},o),d.createElement(uc.Provider,{value:f},s,d.createElement("instancedMesh",{matrixAutoUpdate:!1,ref:h,args:[null,null,n],frustumCulled:r},d.createElement("instancedBufferAttribute",{usage:hi,attach:"instanceColor",args:[p,3]}),d.createElement("planeGeometry",{args:[...C]},d.createElement("instancedBufferAttribute",{usage:hi,attach:"attributes-cloudOpacity",args:[m,1]})),d.createElement("cloudMaterial",{key:e.name,map:g,transparent:!0,depthWrite:!1}))))}),dl=d.forwardRef(({opacity:s=1,speed:e=0,bounds:t=[5,1,1],segments:i=20,color:n="#ffffff",fade:r=10,volume:o=6,smallestVolume:a=.25,distribute:c=null,growth:l=4,concentrate:u="inside",seed:h=Math.random(),...f},m)=>{function p(){const x=Math.sin(h++)*1e4;return x-Math.floor(x)}const g=d.useContext(uc),y=d.useRef(null),v=d.useId(),E=d.useMemo(()=>[...new Array(i)].map((x,T)=>({segments:i,bounds:new _(1,1,1),position:new _,uuid:v,index:T,ref:y,dist:0,matrix:new re,color:new we,rotation:T*(Math.PI/i)})),[i,v]);return d.useLayoutEffect(()=>{E.forEach((x,T)=>{ui(x,{volume:o,color:n,speed:e,growth:l,opacity:s,fade:r,bounds:t,density:Math.max(.5,p()),rotationFactor:Math.max(.2,.5*p())*e});const A=c?.(x,T);if(A||i>1){var C;x.position.copy(x.bounds).multiply((C=A?.point)!==null&&C!==void 0?C:{x:p()*2-1,y:p()*2-1,z:p()*2-1})}const b=Math.abs(x.position.x),R=Math.abs(x.position.y),I=Math.abs(x.position.z),w=Math.max(b,R,I);x.length=1,b===w&&(x.length-=b/x.bounds.x),R===w&&(x.length-=R/x.bounds.y),I===w&&(x.length-=I/x.bounds.z),x.volume=(A?.volume!==void 0?A.volume:Math.max(Math.max(0,a),u==="random"?p():u==="inside"?x.length:1-x.length))*o})},[u,t,r,n,s,l,o,h,i,e]),d.useLayoutEffect(()=>{const x=E;return g.current=[...g.current,...x],()=>{g.current=g.current.filter(T=>T.uuid!==v)}},[E]),d.useImperativeHandle(m,()=>y.current,[]),d.createElement("group",Z({ref:y},f))}),C8=d.forwardRef((s,e)=>d.useContext(uc)?d.createElement(dl,Z({ref:e},s)):d.createElement(Zm,null,d.createElement(dl,Z({ref:e},s))));class R8 extends Ut{constructor(){super({uniforms:{time:{value:0},pixelRatio:{value:1}},vertexShader:`
        uniform float pixelRatio;
        uniform float time;
        attribute float size;  
        attribute float speed;  
        attribute float opacity;
        attribute vec3 noise;
        attribute vec3 color;
        varying vec3 vColor;
        varying float vOpacity;

        void main() {
          vec4 modelPosition = modelMatrix * vec4(position, 1.0);
          modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;
          modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;
          modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;
          vec4 viewPosition = viewMatrix * modelPosition;
          vec4 projectionPostion = projectionMatrix * viewPosition;
          gl_Position = projectionPostion;
          gl_PointSize = size * 25. * pixelRatio;
          gl_PointSize *= (1.0 / - viewPosition.z);
          vColor = color;
          vOpacity = opacity;
        }
      `,fragmentShader:`
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
          float distanceToCenter = distance(gl_PointCoord, vec2(0.5));
          float strength = 0.05 / distanceToCenter - 0.1;
          gl_FragColor = vec4(vColor, strength * vOpacity);
          #include <tonemapping_fragment>
          #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}get pixelRatio(){return this.uniforms.pixelRatio.value}set pixelRatio(e){this.uniforms.pixelRatio.value=e}}const ep=s=>s&&s.constructor===Float32Array,w8=s=>[s.r,s.g,s.b],tp=s=>s instanceof de||s instanceof _||s instanceof Qi,ip=s=>Array.isArray(s)?s:tp(s)?s.toArray():[s,s,s];function jn(s,e,t){return d.useMemo(()=>{if(e!==void 0){if(ep(e))return e;if(e instanceof we){const i=Array.from({length:s*3},()=>w8(e)).flat();return Float32Array.from(i)}else if(tp(e)||Array.isArray(e)){const i=Array.from({length:s*3},()=>ip(e)).flat();return Float32Array.from(i)}return Float32Array.from({length:s},()=>e)}return Float32Array.from({length:s},t)},[e])}const I8=d.forwardRef(({noise:s=1,count:e=100,speed:t=1,opacity:i=1,scale:n=1,size:r,color:o,children:a,...c},l)=>{d.useMemo(()=>ft({SparklesImplMaterial:R8}),[]);const u=d.useRef(null),h=H(x=>x.viewport.dpr),f=ip(n),m=d.useMemo(()=>Float32Array.from(Array.from({length:e},()=>f.map(me.randFloatSpread)).flat()),[e,...f]),p=jn(e,r,Math.random),g=jn(e,i),y=jn(e,t),v=jn(e*3,s),E=jn(o===void 0?e*3:e,ep(o)?o:new we(o),()=>1);return ee(x=>{u.current&&u.current.material&&(u.current.material.time=x.clock.elapsedTime)}),d.useImperativeHandle(l,()=>u.current,[]),d.createElement("points",Z({key:`particle-${e}-${JSON.stringify(n)}`},c,{ref:u}),d.createElement("bufferGeometry",null,d.createElement("bufferAttribute",{attach:"attributes-position",args:[m,3]}),d.createElement("bufferAttribute",{attach:"attributes-size",args:[p,1]}),d.createElement("bufferAttribute",{attach:"attributes-opacity",args:[g,1]}),d.createElement("bufferAttribute",{attach:"attributes-speed",args:[y,1]}),d.createElement("bufferAttribute",{attach:"attributes-color",args:[E,3]}),d.createElement("bufferAttribute",{attach:"attributes-noise",args:[v,3]})),a||d.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:h,depthWrite:!1}))});function _8(s){switch(s){case 64:return"-64px";case 128:return"-128px";case 256:return"-256px";case 512:return"-512px";default:return""}}const L8="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/matcaps.json",P8="https://rawcdn.githack.com/emmelleppi/matcaps/9b36ccaaf0a24881a39062d05566c9e92be4aa0d";function np(s=0,e=1024,t){const i=Gt(()=>fetch(L8).then(u=>u.json()),["matcapList"]),n=i[0],r=d.useMemo(()=>Object.keys(i).length,[]),a=`${d.useMemo(()=>typeof s=="string"?s:typeof s=="number"?i[s]:null,[s])||n}${_8(e)}.png`,c=`${P8}/${e}/${a}`;return[Oi(c,t),c,r]}const M8=({children:s,id:e,format:t,onLoad:i})=>{const n=np(e,t,i);return d.createElement(d.Fragment,null,s?.(n))},D8="https://rawcdn.githack.com/pmndrs/drei-assets/7a3104997e1576f83472829815b00880d88b32fb",B8="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/normals/normals.json";function sp(s=0,e={},t){const{repeat:i=[1,1],anisotropy:n=1,offset:r=[0,0]}=e,o=Gt(()=>fetch(B8).then(f=>f.json()),["normalsList"]),a=d.useMemo(()=>Object.keys(o).length,[]),c=o[0],l=o[s]||c,u=`${D8}/normals/${l}`,h=Oi(u,t);return d.useLayoutEffect(()=>{h&&(h.wrapS=h.wrapT=Mn,h.repeat=new de(i[0],i[1]),h.offset=new de(r[0],r[1]),h.anisotropy=n)},[h,n,i,r]),[h,u,a]}const F8=({children:s,id:e,onLoad:t,...i})=>{const n=sp(e,i,t);return d.createElement(d.Fragment,null,s?.(n))},Pi={uniforms:{strokeOpacity:1,fillOpacity:.25,fillMix:0,thickness:.05,colorBackfaces:!1,dashInvert:!0,dash:!1,dashRepeats:4,dashLength:.5,squeeze:!1,squeezeMin:.2,squeezeMax:1,stroke:new we("#ff0000"),backfaceStroke:new we("#0000ff"),fill:new we("#00ff00")},vertex:`
	  attribute vec3 barycentric;
	
		varying vec3 v_edges_Barycentric;
		varying vec3 v_edges_Position;

		void initWireframe() {
			v_edges_Barycentric = barycentric;
			v_edges_Position = position.xyz;
		}
	  `,fragment:`
		#ifndef PI
	  	#define PI 3.1415926535897932384626433832795
		#endif
  
	  varying vec3 v_edges_Barycentric;
	  varying vec3 v_edges_Position;
  
	  uniform float strokeOpacity;
	  uniform float fillOpacity;
	  uniform float fillMix;
	  uniform float thickness;
	  uniform bool colorBackfaces;
  
	  // Dash
	  uniform bool dashInvert;
	  uniform bool dash;
	  uniform bool dashOnly;
	  uniform float dashRepeats;
	  uniform float dashLength;
  
	  // Squeeze
	  uniform bool squeeze;
	  uniform float squeezeMin;
	  uniform float squeezeMax;
  
	  // Colors
	  uniform vec3 stroke;
	  uniform vec3 backfaceStroke;
	  uniform vec3 fill;
  
	  // This is like
	  float wireframe_aastep(float threshold, float dist) {
		  float afwidth = fwidth(dist) * 0.5;
		  return smoothstep(threshold - afwidth, threshold + afwidth, dist);
	  }
  
	  float wireframe_map(float value, float min1, float max1, float min2, float max2) {
		  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
	  }
  
	  float getWireframe() {
			vec3 barycentric = v_edges_Barycentric;
		
			// Distance from center of each triangle to its edges.
			float d = min(min(barycentric.x, barycentric.y), barycentric.z);

			// for dashed rendering, we can use this to get the 0 .. 1 value of the line length
			float positionAlong = max(barycentric.x, barycentric.y);
			if (barycentric.y < barycentric.x && barycentric.y < barycentric.z) {
				positionAlong = 1.0 - positionAlong;
			}

			// the thickness of the stroke
			float computedThickness = wireframe_map(thickness, 0.0, 1.0, 0.0, 0.34);

			// if we want to shrink the thickness toward the center of the line segment
			if (squeeze) {
				computedThickness *= mix(squeezeMin, squeezeMax, (1.0 - sin(positionAlong * PI)));
			}

			// Create dash pattern
			if (dash) {
				// here we offset the stroke position depending on whether it
				// should overlap or not
				float offset = 1.0 / dashRepeats * dashLength / 2.0;
				if (!dashInvert) {
					offset += 1.0 / dashRepeats / 2.0;
				}

				// if we should animate the dash or not
				// if (dashAnimate) {
				// 	offset += time * 0.22;
				// }

				// create the repeating dash pattern
				float pattern = fract((positionAlong + offset) * dashRepeats);
				computedThickness *= 1.0 - wireframe_aastep(dashLength, pattern);
			}

			// compute the anti-aliased stroke edge  
			float edge = 1.0 - wireframe_aastep(computedThickness, d);

			return edge;
	  }
	  `},k8=xi(Pi.uniforms,Pi.vertex+`
  	void main() {
		initWireframe();
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
	}
  `,Pi.fragment+`
  void main () {
		// Compute color

		float edge = getWireframe();
		vec4 colorStroke = vec4(stroke, edge);

		#ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		#endif
    
		vec4 colorFill = vec4(fill, fillOpacity);
		vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		gl_FragColor = outColor;
	}
  `);function O8(s,e){s.onBeforeCompile=t=>{t.uniforms={...t.uniforms,...e},t.vertexShader=t.vertexShader.replace("void main() {",`
		  ${Pi.vertex}
		  void main() {
			initWireframe();
		`),t.fragmentShader=t.fragmentShader.replace("void main() {",`
		  ${Pi.fragment}
		  void main() {
		`),t.fragmentShader=t.fragmentShader.replace("#include <color_fragment>",`
		  #include <color_fragment>
			  float edge = getWireframe();
		  vec4 colorStroke = vec4(stroke, edge);
		  #ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		  #endif
		  vec4 colorFill = vec4(mix(diffuseColor.rgb, fill, fillMix), mix(diffuseColor.a, fillOpacity, fillMix));
		  vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		  diffuseColor.rgb = outColor.rgb;
		  diffuseColor.a *= outColor.a;
		`)},s.side=dt,s.transparent=!0}function N8(s,e){d.useEffect(()=>{var t;return void(s.fillOpacity.value=(t=e.fillOpacity)!==null&&t!==void 0?t:s.fillOpacity.value)},[e.fillOpacity]),d.useEffect(()=>{var t;return void(s.fillMix.value=(t=e.fillMix)!==null&&t!==void 0?t:s.fillMix.value)},[e.fillMix]),d.useEffect(()=>{var t;return void(s.strokeOpacity.value=(t=e.strokeOpacity)!==null&&t!==void 0?t:s.strokeOpacity.value)},[e.strokeOpacity]),d.useEffect(()=>{var t;return void(s.thickness.value=(t=e.thickness)!==null&&t!==void 0?t:s.thickness.value)},[e.thickness]),d.useEffect(()=>void(s.colorBackfaces.value=!!e.colorBackfaces),[e.colorBackfaces]),d.useEffect(()=>void(s.dash.value=!!e.dash),[e.dash]),d.useEffect(()=>void(s.dashInvert.value=!!e.dashInvert),[e.dashInvert]),d.useEffect(()=>{var t;return void(s.dashRepeats.value=(t=e.dashRepeats)!==null&&t!==void 0?t:s.dashRepeats.value)},[e.dashRepeats]),d.useEffect(()=>{var t;return void(s.dashLength.value=(t=e.dashLength)!==null&&t!==void 0?t:s.dashLength.value)},[e.dashLength]),d.useEffect(()=>void(s.squeeze.value=!!e.squeeze),[e.squeeze]),d.useEffect(()=>{var t;return void(s.squeezeMin.value=(t=e.squeezeMin)!==null&&t!==void 0?t:s.squeezeMin.value)},[e.squeezeMin]),d.useEffect(()=>{var t;return void(s.squeezeMax.value=(t=e.squeezeMax)!==null&&t!==void 0?t:s.squeezeMax.value)},[e.squeezeMax]),d.useEffect(()=>void(s.stroke.value=e.stroke?new we(e.stroke):s.stroke.value),[e.stroke]),d.useEffect(()=>void(s.fill.value=e.fill?new we(e.fill):s.fill.value),[e.fill]),d.useEffect(()=>void(s.backfaceStroke.value=e.backfaceStroke?new we(e.backfaceStroke):s.backfaceStroke.value),[e.backfaceStroke])}function U8(s){return!!(s!=null&&s.geometry)}function z8(s){return!!(s!=null&&s.isBufferGeometry)}function G8(s){return!!(s!=null&&s.current)}function Ah(s){return s?.current!==void 0}function Sh(s){return s.type==="WireframeGeometry"}function $8(){const s={};for(const e in Pi.uniforms)s[e]={value:Pi.uniforms[e]};return s}function H8(s,e){const i=s.getAttribute("position").count,n=[];for(let r=0;r<i;r++){const o=r%2===0,a=e?1:0;o?n.push(0,0,1,0,1,0,1,0,a):n.push(0,1,0,0,0,1,1,0,a)}return new fi(Float32Array.from(n),3)}function rp(s){const e=G8(s)?s.current:s;if(z8(e))return e;{if(Sh(e))throw new Error("Wireframe: WireframeGeometry is not supported.");const t=e.parent;if(U8(t)){if(Sh(t.geometry))throw new Error("Wireframe: WireframeGeometry is not supported.");return t.geometry}}}function op(s,e){if(s.index){console.warn("Wireframe: Requires non-indexed geometry, converting to non-indexed geometry.");const i=s.toNonIndexed();s.copy(i),s.setIndex(null)}const t=H8(s,e);s.setAttribute("barycentric",t)}function K8({geometry:s,simplify:e=!1,...t}){ft({MeshWireframeMaterial:k8});const[i,n]=d.useState(null);d.useLayoutEffect(()=>{const o=rp(s);if(!o)throw new Error("Wireframe: geometry prop must be a BufferGeometry or a ref to a BufferGeometry.");op(o,e),Ah(s)&&n(o)},[e,s]);const r=Ah(s)?i:s;return d.createElement(d.Fragment,null,r&&d.createElement("mesh",{geometry:r},d.createElement("meshWireframeMaterial",Z({attach:"material",transparent:!0,side:dt,polygonOffset:!0,polygonOffsetFactor:-4},t,{extensions:{derivatives:!0,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1}}))))}function V8({simplify:s=!1,...e}){const t=d.useRef(null),i=d.useMemo(()=>$8(),[Pi.uniforms]);return N8(i,e),d.useLayoutEffect(()=>{const n=rp(t);if(!n)throw new Error("Wireframe: Must be a child of a Mesh, Line or Points object or specify a geometry prop.");const r=n.clone();return op(n,s),()=>{n.copy(r),r.dispose()}},[s]),d.useLayoutEffect(()=>{const n=t.current.parent,r=n.material.clone();return O8(n.material,i),()=>{n.material.dispose(),n.material=r}},[]),d.createElement("object3D",{ref:t})}function j8({geometry:s,...e}){return s?d.createElement(K8,Z({geometry:s},e)):d.createElement(V8,e)}function W8({opacity:s,alphaMap:e}){const t=d.useRef(null),i=d.useRef(null),n=d.useRef({value:1}),r=d.useRef({value:null}),o=d.useRef({value:!1});return d.useLayoutEffect(()=>{t.current.onBeforeCompile=i.current.onBeforeCompile=a=>{const c=a.fragmentShader.indexOf("void main");let l="",u,h=c;for(;u!==`
`&&h<c+100;)u=a.fragmentShader.charAt(h),l+=u,h++;l=l.trim(),a.vertexShader=a.vertexShader.replace("void main() {",`
        varying vec2 custom_vUv;

        void main() {
          custom_vUv = uv;
          
        `),a.fragmentShader=a.fragmentShader.replace(l,`
          uniform float uShadowOpacity;
          uniform sampler2D uAlphaMap;
          uniform bool uHasAlphaMap;

          varying vec2 custom_vUv;
  
          float bayerDither2x2( vec2 v ) {
            return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );
          }
    
          float bayerDither4x4( vec2 v ) {
            vec2 P1 = mod( v, 2.0 );
            vec2 P2 = mod( floor( 0.5  * v ), 2.0 );
            return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );
          }
  
          void main() {
            float alpha = 
              uHasAlphaMap ? 
                uShadowOpacity * texture2D(uAlphaMap, custom_vUv).x
              : uShadowOpacity;

            if( ( bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) ) ) / 16.0 >= alpha ) discard;
            
          `),a.uniforms.uShadowOpacity=n.current,a.uniforms.uAlphaMap=r.current,a.uniforms.uHasAlphaMap=o.current}},[]),ee(()=>{var a;const c=(a=t.current.__r3f)==null||(a=a.parent)==null?void 0:a.object;if(c){const l=c.material;l&&(n.current.value=s??l.opacity,e===!1?(r.current.value=null,o.current.value=!1):(r.current.value=e||l.alphaMap,o.current.value=!!r.current.value))}}),d.createElement(d.Fragment,null,d.createElement("meshDepthMaterial",{ref:t,attach:"customDepthMaterial",depthPacking:c1}),d.createElement("meshDistanceMaterial",{ref:i,attach:"customDistanceMaterial"}))}const Th=new re,da=new qi,bh=new yi,X8=new _;class ap extends Al{constructor(){super(),this.size=0,this.color=new we("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){var i,n;const r=this.instance.current;if(!r||!r.geometry)return;const o=r.userData.instances.indexOf(this.instanceKey);if(o===-1||o>r.geometry.drawRange.count)return;const a=(i=(n=e.params.Points)==null?void 0:n.threshold)!==null&&i!==void 0?i:1;if(bh.set(this.getWorldPosition(X8),a),e.ray.intersectsSphere(bh)===!1)return;Th.copy(r.matrixWorld).invert(),da.copy(e.ray).applyMatrix4(Th);const c=a/((this.scale.x+this.scale.y+this.scale.z)/3),l=c*c,u=da.distanceSqToPoint(this.position);if(u<l){const h=new _;da.closestPointToPoint(this.position,h),h.applyMatrix4(this.matrixWorld);const f=e.ray.origin.distanceTo(h);if(f<e.near||f>e.far)return;t.push({distance:f,distanceToRay:Math.sqrt(u),point:h,index:o,face:null,object:this})}}}let Hi,Wn;const lp=d.createContext(null),Ch=new re,Rh=new _,Y8=d.forwardRef(({children:s,range:e,limit:t=1e3,...i},n)=>{const r=d.useRef(null);d.useImperativeHandle(n,()=>r.current,[]);const[o,a]=d.useState([]),[[c,l,u]]=d.useState(()=>[new Float32Array(t*3),Float32Array.from({length:t*3},()=>1),Float32Array.from({length:t},()=>1)]);d.useEffect(()=>{r.current.geometry.attributes.position.needsUpdate=!0}),ee(()=>{for(r.current.updateMatrix(),r.current.updateMatrixWorld(),Ch.copy(r.current.matrixWorld).invert(),r.current.geometry.drawRange.count=Math.min(t,e!==void 0?e:t,o.length),Hi=0;Hi<o.length;Hi++)Wn=o[Hi].current,Wn.getWorldPosition(Rh).applyMatrix4(Ch),Rh.toArray(c,Hi*3),r.current.geometry.attributes.position.needsUpdate=!0,Wn.matrixWorldNeedsUpdate=!0,Wn.color.toArray(l,Hi*3),r.current.geometry.attributes.color.needsUpdate=!0,u.set([Wn.size],Hi),r.current.geometry.attributes.size.needsUpdate=!0});const h=d.useMemo(()=>({getParent:()=>r,subscribe:f=>(a(m=>[...m,f]),()=>a(m=>m.filter(p=>p.current!==f.current)))}),[]);return d.createElement("points",Z({userData:{instances:o},matrixAutoUpdate:!1,ref:r,raycast:()=>null},i),d.createElement("bufferGeometry",null,d.createElement("bufferAttribute",{attach:"attributes-position",args:[c,3],usage:hi}),d.createElement("bufferAttribute",{attach:"attributes-color",args:[l,3],usage:hi}),d.createElement("bufferAttribute",{attach:"attributes-size",args:[u,1],usage:hi})),d.createElement(lp.Provider,{value:h},s))}),Q8=d.forwardRef(({children:s,...e},t)=>{d.useMemo(()=>ft({PositionPoint:ap}),[]);const i=d.useRef(null);d.useImperativeHandle(t,()=>i.current,[]);const{subscribe:n,getParent:r}=d.useContext(lp);return d.useLayoutEffect(()=>n(i),[]),d.createElement("positionPoint",Z({instance:r(),instanceKey:i,ref:i},e),s)}),cp=d.forwardRef(({children:s,positions:e,colors:t,sizes:i,stride:n=3,...r},o)=>{const a=d.useRef(null);return d.useImperativeHandle(o,()=>a.current,[]),ee(()=>{const c=a.current.geometry.attributes;c.position.needsUpdate=!0,t&&(c.color.needsUpdate=!0),i&&(c.size.needsUpdate=!0)}),d.createElement("points",Z({ref:a},r),d.createElement("bufferGeometry",null,d.createElement("bufferAttribute",{attach:"attributes-position",args:[e,n],usage:hi}),t&&d.createElement("bufferAttribute",{attach:"attributes-color",args:[t,n],count:t.length/n,usage:hi}),i&&d.createElement("bufferAttribute",{attach:"attributes-size",args:[i,1],count:i.length/n,usage:hi})),s)}),J8=d.forwardRef((s,e)=>s.positions instanceof Float32Array?d.createElement(cp,Z({},s,{ref:e})):d.createElement(Y8,Z({},s,{ref:e}))),up=d.createContext(null),q8=d.forwardRef((s,e)=>{d.useMemo(()=>ft({SegmentObject:hp}),[]);const{limit:t=1e3,lineWidth:i=1,children:n,...r}=s,[o,a]=d.useState([]),[c]=d.useState(()=>new Ug),[l]=d.useState(()=>new zg),[u]=d.useState(()=>new Gg),[h]=d.useState(()=>new de(512,512)),[f]=d.useState(()=>Array(t*6).fill(0)),[m]=d.useState(()=>Array(t*6).fill(0)),p=d.useMemo(()=>({subscribe:g=>(a(y=>[...y,g]),()=>a(y=>y.filter(v=>v.current!==g.current)))}),[]);return ee(()=>{for(let y=0;y<t;y++){var g;const v=(g=o[y])==null?void 0:g.current;v&&(f[y*6+0]=v.start.x,f[y*6+1]=v.start.y,f[y*6+2]=v.start.z,f[y*6+3]=v.end.x,f[y*6+4]=v.end.y,f[y*6+5]=v.end.z,m[y*6+0]=v.color.r,m[y*6+1]=v.color.g,m[y*6+2]=v.color.b,m[y*6+3]=v.color.r,m[y*6+4]=v.color.g,m[y*6+5]=v.color.b)}u.setColors(m),u.setPositions(f),c.computeLineDistances()}),d.createElement("primitive",{object:c,ref:e},d.createElement("primitive",{object:u,attach:"geometry"}),d.createElement("primitive",Z({object:l,attach:"material",vertexColors:!0,resolution:h,linewidth:i},r)),d.createElement(up.Provider,{value:p},n))});class hp{constructor(){this.color=new we("white"),this.start=new _(0,0,0),this.end=new _(0,0,0)}}const wh=s=>s instanceof _?s:new _(...typeof s=="number"?[s,s,s]:s),Z8=d.forwardRef(({color:s,start:e,end:t},i)=>{const n=d.useContext(up);if(!n)throw"Segment must used inside Segments component.";const r=d.useRef(null);return d.useImperativeHandle(i,()=>r.current,[]),d.useLayoutEffect(()=>n.subscribe(r),[]),d.createElement("segmentObject",{ref:r,color:s,start:wh(e),end:wh(t)})}),e9=d.forwardRef(({children:s,hysteresis:e=0,distances:t,...i},n)=>{const r=d.useRef(null);return d.useImperativeHandle(n,()=>r.current,[]),d.useLayoutEffect(()=>{const{current:o}=r;o.levels.length=0,o.children.forEach((a,c)=>o.levels.push({object:a,hysteresis:e,distance:t[c]}))}),ee(o=>{var a;return(a=r.current)==null?void 0:a.update(o.camera)}),d.createElement("lOD",Z({ref:r},i),s)});function t9({all:s,scene:e,camera:t}){const i=H(({gl:o})=>o),n=H(({camera:o})=>o),r=H(({scene:o})=>o);return d.useLayoutEffect(()=>{const o=[];s&&(e||r).traverse(l=>{l.visible===!1&&(o.push(l),l.visible=!0)}),i.compile(e||r,t||n);const a=new Tl(128);new Yd(.01,1e5,a).update(i,e||r),a.dispose(),o.forEach(l=>l.visible=!1)},[]),null}function i9(){const s=H(e=>e.gl);return d.useEffect(()=>(s.shadowMap.autoUpdate=!1,s.shadowMap.needsUpdate=!0,()=>{s.shadowMap.autoUpdate=s.shadowMap.needsUpdate=!0}),[s.shadowMap]),null}const Ih=new re,_h=new qi,fa=new yi,ma=new _;function n9(s,e){const t=this.geometry,i=this.material,n=this.matrixWorld;i!==void 0&&(t.boundingSphere===null&&t.computeBoundingSphere(),fa.copy(t.boundingSphere),fa.applyMatrix4(n),s.ray.intersectsSphere(fa)!==!1&&(Ih.copy(n).invert(),_h.copy(s.ray).applyMatrix4(Ih),!(t.boundingBox!==null&&_h.intersectBox(t.boundingBox,ma)===null)&&e.push({distance:ma.distanceTo(s.ray.origin),point:ma.clone(),object:this})))}function s9({pixelated:s}){const e=H(o=>o.gl),t=H(o=>o.internal.active),i=H(o=>o.performance.current),n=H(o=>o.viewport.initialDpr),r=H(o=>o.setDpr);return d.useEffect(()=>{const o=e.domElement;return()=>{t&&r(n),s&&o&&(o.style.imageRendering="auto")}},[]),d.useEffect(()=>{r(i*n),s&&e.domElement&&(e.domElement.style.imageRendering=i===1?"auto":"pixelated")},[i]),null}function r9(){const s=H(i=>i.get),e=H(i=>i.setEvents),t=H(i=>i.performance.current);return d.useEffect(()=>{const i=s().events.enabled;return()=>e({enabled:i})},[]),d.useEffect(()=>e({enabled:t===1}),[t]),null}const dp=d.createContext(null);function o9({iterations:s=10,ms:e=250,threshold:t=.75,step:i=.1,factor:n=.5,flipflops:r=1/0,bounds:o=f=>f>100?[60,100]:[40,60],onIncline:a,onDecline:c,onChange:l,onFallback:u,children:h}){const f=Math.pow(10,0),[m,p]=d.useState(()=>({fps:0,index:0,factor:n,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:y=>{const v=Symbol();return m.subscriptions.set(v,y.current),()=>void m.subscriptions.delete(v)}}));let g=0;return ee(()=>{const{frames:y,averages:v}=m;if(!m.fallback&&v.length<s){y.push(performance.now());const E=y[y.length-1]-y[0];if(E>=e){if(m.fps=Math.round(y.length/E*1e3*f)/f,m.refreshrate=Math.max(m.refreshrate,m.fps),v[m.index++%s]=m.fps,v.length===s){const[x,T]=o(m.refreshrate),A=v.filter(b=>b>=T),C=v.filter(b=>b<x);A.length>s*t&&(m.factor=Math.min(1,m.factor+i),m.flipped++,a&&a(m),m.subscriptions.forEach(b=>b.onIncline&&b.onIncline(m))),C.length>s*t&&(m.factor=Math.max(0,m.factor-i),m.flipped++,c&&c(m),m.subscriptions.forEach(b=>b.onDecline&&b.onDecline(m))),g!==m.factor&&(g=m.factor,l&&l(m),m.subscriptions.forEach(b=>b.onChange&&b.onChange(m))),m.flipped>r&&!m.fallback&&(m.fallback=!0,u&&u(m),m.subscriptions.forEach(b=>b.onFallback&&b.onFallback(m))),m.averages=[]}m.frames=[]}}}),d.createElement(dp.Provider,{value:m},h)}function a9({onIncline:s,onDecline:e,onChange:t,onFallback:i}){const n=d.useContext(dp),r=d.useRef({onIncline:s,onDecline:e,onChange:t,onFallback:i});d.useLayoutEffect(()=>{r.current.onIncline=s,r.current.onDecline=e,r.current.onChange=t,r.current.onFallback=i},[s,e,t,i]),d.useLayoutEffect(()=>n.subscribe(r),[n])}const fp=d.forwardRef(({children:s,compute:e,width:t,height:i,samples:n=8,renderPriority:r=0,eventPriority:o=0,frames:a=1/0,stencilBuffer:c=!1,depthBuffer:l=!0,generateMipmaps:u=!1,...h},f)=>{const{size:m,viewport:p}=H(),g=Di((t||m.width)*p.dpr,(i||m.height)*p.dpr,{samples:n,stencilBuffer:c,depthBuffer:l,generateMipmaps:u}),[y]=d.useState(()=>new nn),v=d.useCallback((E,x,T)=>{var A,C;let b=(A=g.texture)==null||(A=A.__r3f.parent)==null?void 0:A.object;for(;b&&!(b instanceof Ve);){var R;b=(R=b.__r3f.parent)==null?void 0:R.object}if(!b)return!1;T.raycaster.camera||T.events.compute(E,T,(C=T.previousRoot)==null?void 0:C.getState());const[I]=T.raycaster.intersectObject(b);if(!I)return!1;const w=I.uv;if(!w)return!1;x.raycaster.setFromCamera(x.pointer.set(w.x*2-1,w.y*2-1),x.camera)},[]);return d.useImperativeHandle(f,()=>g.texture,[g]),d.createElement(d.Fragment,null,Ei(d.createElement(l9,{renderPriority:r,frames:a,fbo:g},s,d.createElement("group",{onPointerOver:()=>null})),y,{events:{compute:e||v,priority:o}}),d.createElement("primitive",Z({object:g.texture},h)))});function l9({frames:s,renderPriority:e,children:t,fbo:i}){let n=0,r,o,a,c;return ee(l=>{(s===1/0||n<s)&&(r=l.gl.autoClear,o=l.gl.xr.enabled,a=l.gl.getRenderTarget(),c=l.gl.xr.isPresenting,l.gl.autoClear=!0,l.gl.xr.enabled=!1,l.gl.xr.isPresenting=!1,l.gl.setRenderTarget(i),l.gl.render(l.scene,l.camera),l.gl.setRenderTarget(a),l.gl.autoClear=r,l.gl.xr.enabled=o,l.gl.xr.isPresenting=c,n++)},e),d.createElement(d.Fragment,null,t)}const mp=d.forwardRef(({children:s,compute:e,renderPriority:t=-1,eventPriority:i=0,frames:n=1/0,stencilBuffer:r=!1,depthBuffer:o=!0,generateMipmaps:a=!1,resolution:c=896,near:l=.1,far:u=1e3,flip:h=!1,position:f,rotation:m,scale:p,quaternion:g,matrix:y,matrixAutoUpdate:v,...E},x)=>{const{size:T,viewport:A}=H(),C=d.useRef(null),b=d.useMemo(()=>{const I=new Tl(Math.max((c||T.width)*A.dpr,(c||T.height)*A.dpr),{stencilBuffer:r,depthBuffer:o,generateMipmaps:a});return I.texture.isRenderTargetTexture=!h,I.texture.flipY=!0,I.texture.type=tn,I},[c,h]);d.useEffect(()=>()=>b.dispose(),[b]);const[R]=d.useState(()=>new nn);return d.useImperativeHandle(x,()=>({scene:R,fbo:b,camera:C.current}),[b]),d.createElement(d.Fragment,null,Ei(d.createElement(c9,{renderPriority:t,frames:n,camera:C},s,d.createElement("group",{onPointerOver:()=>null})),R,{events:{compute:e,priority:i}}),d.createElement("primitive",Z({object:b.texture},E)),d.createElement("cubeCamera",{ref:C,args:[l,u,b],position:f,rotation:m,scale:p,quaternion:g,matrix:y,matrixAutoUpdate:v}))});function c9({frames:s,renderPriority:e,children:t,camera:i}){let n=0;return ee(r=>{(s===1/0||n<s)&&(i.current.update(r.gl,r.scene),n++)},e),d.createElement(d.Fragment,null,t)}const u9=d.forwardRef(({id:s=1,colorWrite:e=!1,depthWrite:t=!1,...i},n)=>{const r=d.useRef(null),o=d.useMemo(()=>({colorWrite:e,depthWrite:t,stencilWrite:!0,stencilRef:s,stencilFunc:u1,stencilFail:wo,stencilZFail:wo,stencilZPass:wo}),[s,e,t]);return d.useLayoutEffect(()=>{Object.assign(r.current.material,o)}),d.useImperativeHandle(n,()=>r.current,[]),d.createElement("mesh",Z({ref:r,renderOrder:-s},i))});function h9(s,e=!1){return{stencilWrite:!0,stencilRef:s,stencilFunc:e?h1:d1,stencilFail:Io,stencilZFail:Io,stencilZPass:Io}}function d9({renderPriority:s=1,zoom:e=0,segments:t=64,children:i,resolution:n=896,...r}){const o=d.useRef(null),a=d.useRef(null),{width:c,height:l}=H(y=>y.size),[u]=d.useState(()=>new rt);d.useLayoutEffect(()=>{u.position.set(0,0,100),u.zoom=100,u.left=c/-2,u.right=c/2,u.top=l/2,u.bottom=l/-2,u.updateProjectionMatrix()},[c,l]);const h=Math.sqrt(c*c+l*l)/100*(.5+e/2),f=new _,m=new yi(new _,h),p=new f1,g=d.useCallback((y,v,E)=>{if(v.pointer.set(y.offsetX/v.size.width*2-1,-(y.offsetY/v.size.height)*2+1),v.raycaster.setFromCamera(v.pointer,u),v.raycaster.ray.intersectSphere(m,f))f.normalize();else return;p.getNormalMatrix(a.current.camera.matrixWorld),a.current.camera.getWorldPosition(v.raycaster.ray.origin),v.raycaster.ray.direction.set(0,0,1).reflect(f),v.raycaster.ray.direction.x*=-1,v.raycaster.ray.direction.applyNormalMatrix(p).multiplyScalar(-1)},[]);return ee(y=>{s&&y.gl.render(o.current,u)},s),d.createElement(d.Fragment,null,d.createElement("mesh",Z({ref:o},r,{scale:h}),d.createElement("sphereGeometry",{args:[1,t,t]}),d.createElement("meshBasicMaterial",null,d.createElement(mp,{compute:g,attach:"envMap",flip:!0,resolution:n,ref:a},i,d.createElement(f9,{api:a})))))}function f9({api:s}){const e=new _,t=new ue,i=new _,n=new pi(0,Math.PI,0);return ee(r=>{r.camera.matrixWorld.decompose(e,t,i),s.current.camera.position.copy(e),s.current.camera.quaternion.setFromEuler(n).premultiply(t)}),null}const m9=xi({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new de},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),p9=d.forwardRef(({children:s,events:e=void 0,blur:t=0,eventPriority:i=0,renderPriority:n=0,worldUnits:r=!1,resolution:o=512,...a},c)=>{ft({PortalMaterialImpl:m9});const l=d.useRef(null),{scene:u,gl:h,size:f,viewport:m,setEvents:p}=H(),g=Di(o,o),[y,v]=d.useState(0);ee(()=>{const C=l.current.blend>0?Math.max(1,n):0;y!==C&&v(C)}),d.useEffect(()=>{e!==void 0&&p({enabled:!e})},[e]);const[E,x]=d.useState(!0),T=Gm(x);d.useLayoutEffect(()=>{var C;T.current=(C=l.current)==null||(C=C.__r3f.parent)==null?void 0:C.object},[]),d.useLayoutEffect(()=>{if(T.current&&t&&l.current.sdf===null){const C=new oe(T.current.geometry,new On),b=new gi().setFromBufferAttribute(C.geometry.attributes.position),R=new rt(b.min.x*(1+2/o),b.max.x*(1+2/o),b.max.y*(1+2/o),b.min.y*(1+2/o),.1,1e3);R.position.set(0,0,1),R.lookAt(0,0,0),h.setRenderTarget(g),h.render(C,R);const w=y9(o,o,h)(g.texture),M=new Float32Array(o*o);h.readRenderTargetPixels(w,0,0,o,o,M);let P=1/0;for(let O=0;O<M.length;O++)M[O]<P&&(P=M[O]);P=-P,l.current.size=P,l.current.sdf=w.texture,h.setRenderTarget(null)}},[o,t]),d.useImperativeHandle(c,()=>l.current);const A=d.useCallback((C,b,R)=>{var I;if(!T.current)return!1;if(b.pointer.set(C.offsetX/b.size.width*2-1,-(C.offsetY/b.size.height)*2+1),b.raycaster.setFromCamera(b.pointer,b.camera),((I=l.current)==null?void 0:I.blend)===0){const[w]=b.raycaster.intersectObject(T.current);if(!w)return b.raycaster.camera=void 0,!1}},[]);return d.createElement("portalMaterialImpl",Z({ref:l,blur:t,blend:0,resolution:[f.width*m.dpr,f.height*m.dpr],attach:"material"},a),d.createElement(fp,{attach:"map",frames:E?1/0:0,eventPriority:i,renderPriority:n,compute:A},s,d.createElement(g9,{events:e,rootScene:u,priority:y,material:l,worldUnits:r})))});function g9({events:s=void 0,rootScene:e,material:t,priority:i,worldUnits:n}){const r=H(h=>h.scene),o=H(h=>h.setEvents),a=Di(),c=Di();d.useLayoutEffect(()=>{r.matrixAutoUpdate=!1},[]),d.useEffect(()=>{s!==void 0&&o({enabled:s})},[s]);const[l,u]=d.useMemo(()=>{const h={value:0};return[new Vi(new Ut({uniforms:{a:{value:a.texture},b:{value:c.texture},blend:h},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
          }`,fragmentShader:`
          uniform sampler2D a;
          uniform sampler2D b;
          uniform float blend;
          varying vec2 vUv;
          #include <packing>
          void main() {
            vec4 ta = texture2D(a, vUv);
            vec4 tb = texture2D(b, vUv);
            gl_FragColor = mix(tb, ta, blend);
            #include <tonemapping_fragment>
            #include <${pt>=154?"colorspace_fragment":"encodings_fragment"}>
          }`})),h]},[]);return ee(h=>{var f;let m=t==null||(f=t.current)==null||(f=f.__r3f.parent)==null?void 0:f.object;if(m){if(n)r.matrixWorld.identity();else{var p;i&&((p=t.current)==null?void 0:p.blend)===1&&m.updateWorldMatrix(!0,!1),r.matrixWorld.copy(m.matrixWorld)}if(i){var g,y,v;((g=t.current)==null?void 0:g.blend)>0&&((y=t.current)==null?void 0:y.blend)<1?(u.value=t.current.blend,h.gl.setRenderTarget(a),h.gl.render(r,h.camera),h.gl.setRenderTarget(c),h.gl.render(e,h.camera),h.gl.setRenderTarget(null),l.render(h.gl)):((v=t.current)==null?void 0:v.blend)===1&&h.gl.render(r,h.camera)}}},i),d.createElement(d.Fragment,null)}const y9=(s,e,t)=>{let i=new Ze(s,e,{minFilter:m1,magFilter:Ji,type:Ar,format:_o,generateMipmaps:!0}),n=new Ze(s,e,{minFilter:ht,magFilter:ht}),r=new Ze(s,e,{minFilter:ht,magFilter:ht}),o=new Ze(s,e,{minFilter:ht,magFilter:ht}),a=new Ze(s,e,{minFilter:ht,magFilter:ht}),c=new Ze(s,e,{minFilter:ht,magFilter:ht,type:Ar,format:_o}),l=new Ze(s,e,{minFilter:ht,magFilter:ht,type:Ar,format:_o});const u=new Vi(new Ut({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));
        }`})),h=new Vi(new Ut({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));
        }`})),f=new Vi(new Ut({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform float offset;
        uniform float level;
        uniform float maxSteps;
        #include <packing>
        void main() {
          float closestDist = 9999999.9;
          vec2 closestPos = vec2(0.0);
          for (float x = -1.0; x <= 1.0; x += 1.0) {
            for (float y = -1.0; y <= 1.0; y += 1.0) {
              vec2 voffset = vUv;
              voffset += vec2(x, y) * vec2(${1/s}, ${1/e}) * offset;
              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));
              float dist = distance(pos.xy, vUv);
              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {
                closestDist = dist;
                closestPos = pos;
              }
            }
          }
          gl_FragColor = pack2HalfToRGBA(closestPos);
        }`})),m=new Vi(new Ut({uniforms:{tex:{value:null},size:{value:new de(s,e)}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform vec2 size;
        #include <packing>
        void main() {
          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);
        }`})),p=new Vi(new Ut({uniforms:{inside:{value:l.texture},outside:{value:c.texture},tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D inside;
        uniform sampler2D outside;
        uniform sampler2D tex;
        #include <packing>
        void main() {
          float i = texture2D(inside, vUv).x;
          float o =texture2D(outside, vUv).x;
          if (texture2D(tex, vUv).x == 0.0) {
            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);
          } else {
            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);
          }
        }`}));return g=>{let y=i;g.minFilter=ht,g.magFilter=ht,u.material.uniforms.tex.value=g,t.setRenderTarget(n),u.render(t);const v=Math.ceil(Math.log(Math.max(s,e))/Math.log(2));let E=n,x=null;for(let T=0;T<v;T++){const A=Math.pow(2,v-T-1);x=E===n?o:n,f.material.uniforms.level.value=T,f.material.uniforms.maxSteps.value=v,f.material.uniforms.offset.value=A,f.material.uniforms.tex.value=E.texture,t.setRenderTarget(x),f.render(t),E=x}t.setRenderTarget(c),m.material.uniforms.tex.value=x.texture,m.render(t),h.material.uniforms.tex.value=g,t.setRenderTarget(r),h.render(t),E=r;for(let T=0;T<v;T++){const A=Math.pow(2,v-T-1);x=E===r?a:r,f.material.uniforms.level.value=T,f.material.uniforms.maxSteps.value=v,f.material.uniforms.offset.value=A,f.material.uniforms.tex.value=E.texture,t.setRenderTarget(x),f.render(t),E=x}return t.setRenderTarget(l),m.material.uniforms.tex.value=x.texture,m.render(t),t.setRenderTarget(y),p.material.uniforms.tex.value=g,p.render(t),t.setRenderTarget(null),y}},v9={},Lh=s=>{let e;const t=new Set,i=(u,h)=>{const f=typeof u=="function"?u(e):u;if(!Object.is(f,e)){const m=e;e=h??(typeof f!="object"||f===null)?f:Object.assign({},e,f),t.forEach(p=>p(e,m))}},n=()=>e,c={setState:i,getState:n,getInitialState:()=>l,subscribe:u=>(t.add(u),()=>t.delete(u)),destroy:()=>{(v9?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},l=e=s(i,n,c);return c},pp=s=>s?Lh(s):Lh,gp={},{useDebugValue:x9}=Mt,{useSyncExternalStoreWithSelector:E9}=E1;let Ph=!1;const A9=s=>s;function ho(s,e=A9,t){(gp?"production":void 0)!=="production"&&t&&!Ph&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Ph=!0);const i=E9(s.subscribe,s.getState,s.getServerState||s.getInitialState,e,t);return x9(i),i}const Mh=s=>{(gp?"production":void 0)!=="production"&&typeof s!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof s=="function"?pp(s):s,t=(i,n)=>ho(e,i,n);return Object.assign(t,e),t},yp=s=>s?Mh(s):Mh;var Dh,Bh;const Fh=typeof window<"u"&&((Dh=window.document)!=null&&Dh.createElement||((Bh=window.navigator)==null?void 0:Bh.product)==="ReactNative")?Mt.useLayoutEffect:Mt.useEffect;function vp(){const s=yp(e=>({current:new Array,version:0,set:e}));return{In:({children:e})=>{const t=s(n=>n.set),i=s(n=>n.version);return Fh(()=>{t(n=>({version:n.version+1}))},[]),Fh(()=>(t(({current:n})=>({current:[...n,e]})),()=>t(({current:n})=>({current:n.filter(r=>r!==e)}))),[e,i]),null},Out:()=>{const e=s(t=>t.current);return Mt.createElement(Mt.Fragment,null,e)}}}const S9=s=>s&&s.isOrthographicCamera,kh=new we,xp=vp();function pa(s,e){const{right:t,top:i,left:n,bottom:r,width:o,height:a}=e,c=e.bottom<0||i>s.height||t<0||e.left>s.width,u=s.top+s.height-r,h=n-s.left;return{position:{width:o,height:a,left:h,top:i,bottom:u,right:t},isOffscreen:c}}function ga(s,{left:e,bottom:t,width:i,height:n}){let r;const o=i/n;return S9(s.camera)?s.camera.manual?s.camera.updateProjectionMatrix():(s.camera.left!==i/-2||s.camera.right!==i/2||s.camera.top!==n/2||s.camera.bottom!==n/-2)&&(Object.assign(s.camera,{left:i/-2,right:i/2,top:n/2,bottom:n/-2}),s.camera.updateProjectionMatrix()):s.camera.aspect!==o&&(s.camera.aspect=o,s.camera.updateProjectionMatrix()),r=s.gl.autoClear,s.gl.autoClear=!1,s.gl.setViewport(e,t,i,n),s.gl.setScissor(e,t,i,n),s.gl.setScissorTest(!0),r}function ya(s,e){s.gl.setScissorTest(!1),s.gl.autoClear=e}function Oh(s){s.gl.getClearColor(kh),s.gl.setClearColor(kh,s.gl.getClearAlpha()),s.gl.clear(!0,!0)}function T9({visible:s=!0,canvasSize:e,scene:t,index:i,children:n,frames:r,rect:o,track:a}){const c=H(),[l,u]=d.useState(!1);let h=0;return ee(f=>{if(r===1/0||h<=r){var m;a&&(o.current=(m=a.current)==null?void 0:m.getBoundingClientRect()),h++}if(o.current){const{position:p,isOffscreen:g}=pa(e,o.current);if(l!==g&&u(g),s&&!l&&o.current){const y=ga(f,p);f.gl.render(n?f.scene:t,f.camera),ya(f,y)}}},i),d.useLayoutEffect(()=>{const f=o.current;if(f&&(!s||!l)){const{position:m}=pa(e,f),p=ga(c,m);Oh(c),ya(c,p)}},[s,l]),d.useEffect(()=>{if(!a)return;const f=o.current,m=c.get().events.connected;return c.setEvents({connected:a.current}),()=>{if(f){const{position:p}=pa(e,f),g=ga(c,p);Oh(c),ya(c,g)}c.setEvents({connected:m})}},[a]),d.createElement(d.Fragment,null,n,d.createElement("group",{onPointerOver:()=>null}))}const Ep=d.forwardRef(({track:s,visible:e=!0,index:t=1,id:i,style:n,className:r,frames:o=1/0,children:a,...c},l)=>{var u,h,f,m;const p=d.useRef(null),{size:g,scene:y}=H(),[v]=d.useState(()=>new nn),[E,x]=d.useReducer(()=>!0,!1),T=d.useCallback((A,C)=>{if(p.current&&s&&s.current&&A.target===s.current){const{width:b,height:R,left:I,top:w}=p.current,M=A.clientX-I,P=A.clientY-w;C.pointer.set(M/b*2-1,-(P/R)*2+1),C.raycaster.setFromCamera(C.pointer,C.camera)}},[p,s]);return d.useEffect(()=>{var A;s&&(p.current=(A=s.current)==null?void 0:A.getBoundingClientRect()),x()},[s]),d.createElement("group",Z({ref:l},c),E&&Ei(d.createElement(T9,{visible:e,canvasSize:g,frames:o,scene:y,track:s,rect:p,index:t},a),v,{events:{compute:T,priority:t},size:{width:(u=p.current)==null?void 0:u.width,height:(h=p.current)==null?void 0:h.height,top:(f=p.current)==null?void 0:f.top,left:(m=p.current)==null?void 0:m.left}}))}),b9=d.forwardRef(({as:s="div",id:e,visible:t,className:i,style:n,index:r=1,track:o,frames:a=1/0,children:c,...l},u)=>{const h=d.useId(),f=d.useRef(null);return d.useImperativeHandle(u,()=>f.current),d.createElement(d.Fragment,null,d.createElement(s,Z({ref:f,id:e,className:i,style:n},l)),d.createElement(xp.In,null,d.createElement(Ep,{visible:t,key:h,track:f,frames:a,index:r},c)))}),C9=(()=>{const s=d.forwardRef((e,t)=>d.useContext(us)?d.createElement(Ep,Z({ref:t},e)):d.createElement(b9,Z({ref:t},e)));return s.Port=()=>d.createElement(xp.Out,null),s})(),Ss=d.createContext(null),ir=new _,Nh=new _,R9=(s,e,t,i)=>{const n=e.dot(e),r=e.dot(s)-e.dot(t),o=e.dot(i);return o===0?-r/n:(ir.copy(i).multiplyScalar(n/o).sub(e),Nh.copy(i).multiplyScalar(r/o).add(t).sub(s),-ir.dot(Nh)/ir.dot(ir))},w9=new _(0,1,0),Uh=new re,va=({direction:s,axis:e})=>{const{translation:t,translationLimits:i,annotations:n,annotationsClass:r,depthTest:o,scale:a,lineWidth:c,fixed:l,axisColors:u,hoveredColor:h,opacity:f,renderOrder:m,onDragStart:p,onDrag:g,onDragEnd:y,userData:v}=d.useContext(Ss),E=H($=>$.controls),x=d.useRef(null),T=d.useRef(null),A=d.useRef(null),C=d.useRef(0),[b,R]=d.useState(!1),I=d.useCallback($=>{n&&(x.current.innerText=`${t.current[e].toFixed(2)}`,x.current.style.display="block"),$.stopPropagation();const U=new re().extractRotation(T.current.matrixWorld),N=$.point.clone(),B=new _().setFromMatrixPosition(T.current.matrixWorld),G=s.clone().applyMatrix4(U).normalize();A.current={clickPoint:N,dir:G},C.current=t.current[e],p({component:"Arrow",axis:e,origin:B,directions:[G]}),E&&(E.enabled=!1),$.target.setPointerCapture($.pointerId)},[n,s,E,p,t,e]),w=d.useCallback($=>{if($.stopPropagation(),b||R(!0),A.current){const{clickPoint:U,dir:N}=A.current,[B,G]=i?.[e]||[void 0,void 0];let j=R9(U,N,$.ray.origin,$.ray.direction);B!==void 0&&(j=Math.max(j,B-C.current)),G!==void 0&&(j=Math.min(j,G-C.current)),t.current[e]=C.current+j,n&&(x.current.innerText=`${t.current[e].toFixed(2)}`),Uh.makeTranslation(N.x*j,N.y*j,N.z*j),g(Uh)}},[n,g,b,t,i,e]),M=d.useCallback($=>{n&&(x.current.style.display="none"),$.stopPropagation(),A.current=null,y(),E&&(E.enabled=!0),$.target.releasePointerCapture($.pointerId)},[n,E,y]),P=d.useCallback($=>{$.stopPropagation(),R(!1)},[]),{cylinderLength:O,coneWidth:z,coneLength:D,matrixL:F}=d.useMemo(()=>{const $=l?c/a*1.6:a/20,U=l?.2:a/5,N=l?1-U:a-U,B=new ue().setFromUnitVectors(w9,s.clone().normalize()),G=new re().makeRotationFromQuaternion(B);return{cylinderLength:N,coneWidth:$,coneLength:U,matrixL:G}},[s,a,c,l]),k=b?h:u[e];return d.createElement("group",{ref:T},d.createElement("group",{matrix:F,matrixAutoUpdate:!1,onPointerDown:I,onPointerMove:w,onPointerUp:M,onPointerOut:P},n&&d.createElement(Es,{position:[0,-D,0]},d.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:r,ref:x})),d.createElement("mesh",{visible:!1,position:[0,(O+D)/2,0],userData:v},d.createElement("cylinderGeometry",{args:[z*1.4,z*1.4,O+D,8,1]})),d.createElement(ei,{transparent:!0,raycast:()=>null,depthTest:o,points:[0,0,0,0,O,0],lineWidth:c,side:dt,color:k,opacity:f,polygonOffset:!0,renderOrder:m,polygonOffsetFactor:-10,fog:!1}),d.createElement("mesh",{raycast:()=>null,position:[0,O+D/2,0],renderOrder:m},d.createElement("coneGeometry",{args:[z,D,24,1]}),d.createElement("meshBasicMaterial",{transparent:!0,depthTest:o,color:k,opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},xa=new _,Ea=new _,Aa=s=>s*180/Math.PI,I9=s=>s*Math.PI/180,_9=(s,e,t,i,n)=>{xa.copy(s).sub(t),Ea.copy(e).sub(t);const r=i.dot(i),o=n.dot(n),a=xa.dot(i)/r,c=xa.dot(n)/o,l=Ea.dot(i)/r,u=Ea.dot(n)/o,h=Math.atan2(c,a);return Math.atan2(u,l)-h},L9=(s,e)=>{let t=Math.floor(s/e);return t=t<0?t+1:t,s-t*e},zh=s=>{let e=L9(s,2*Math.PI);return Math.abs(e)<1e-6?0:(e<0&&(e+=2*Math.PI),e)},nr=new re,Gh=new _,sr=new qi,Sa=new _,Ta=({dir1:s,dir2:e,axis:t})=>{const{rotationLimits:i,annotations:n,annotationsClass:r,depthTest:o,scale:a,lineWidth:c,fixed:l,axisColors:u,hoveredColor:h,renderOrder:f,opacity:m,onDragStart:p,onDrag:g,onDragEnd:y,userData:v}=d.useContext(Ss),E=H(k=>k.controls),x=d.useRef(null),T=d.useRef(null),A=d.useRef(0),C=d.useRef(0),b=d.useRef(null),[R,I]=d.useState(!1),w=d.useCallback(k=>{n&&(x.current.innerText=`${Aa(C.current).toFixed(0)}`,x.current.style.display="block"),k.stopPropagation();const $=k.point.clone(),U=new _().setFromMatrixPosition(T.current.matrixWorld),N=new _().setFromMatrixColumn(T.current.matrixWorld,0).normalize(),B=new _().setFromMatrixColumn(T.current.matrixWorld,1).normalize(),G=new _().setFromMatrixColumn(T.current.matrixWorld,2).normalize(),j=new vi().setFromNormalAndCoplanarPoint(G,U);b.current={clickPoint:$,origin:U,e1:N,e2:B,normal:G,plane:j},p({component:"Rotator",axis:t,origin:U,directions:[N,B,G]}),E&&(E.enabled=!1),k.target.setPointerCapture(k.pointerId)},[n,E,p,t]),M=d.useCallback(k=>{if(k.stopPropagation(),R||I(!0),b.current){const{clickPoint:$,origin:U,e1:N,e2:B,normal:G,plane:j}=b.current,[L,X]=i?.[t]||[void 0,void 0];sr.copy(k.ray),sr.intersectPlane(j,Sa),sr.direction.negate(),sr.intersectPlane(j,Sa);let Q=_9($,Sa,U,N,B),ne=Aa(Q);k.shiftKey&&(ne=Math.round(ne/10)*10,Q=I9(ne)),L!==void 0&&X!==void 0&&X-L<2*Math.PI?(Q=zh(Q),Q=Q>Math.PI?Q-2*Math.PI:Q,Q=me.clamp(Q,L-A.current,X-A.current),C.current=A.current+Q):(C.current=zh(A.current+Q),C.current=C.current>Math.PI?C.current-2*Math.PI:C.current),n&&(ne=Aa(C.current),x.current.innerText=`${ne.toFixed(0)}`),nr.makeRotationAxis(G,Q),Gh.copy(U).applyMatrix4(nr).sub(U).negate(),nr.setPosition(Gh),g(nr)}},[n,g,R,i,t]),P=d.useCallback(k=>{n&&(x.current.style.display="none"),k.stopPropagation(),A.current=C.current,b.current=null,y(),E&&(E.enabled=!0),k.target.releasePointerCapture(k.pointerId)},[n,E,y]),O=d.useCallback(k=>{k.stopPropagation(),I(!1)},[]),z=d.useMemo(()=>{const k=s.clone().normalize(),$=e.clone().normalize();return new re().makeBasis(k,$,k.clone().cross($))},[s,e]),D=l?.65:a*.65,F=d.useMemo(()=>{const $=[];for(let U=0;U<=32;U++){const N=U*(Math.PI/2)/32;$.push(new _(Math.cos(N)*D,Math.sin(N)*D,0))}return $},[D]);return d.createElement("group",{ref:T,onPointerDown:w,onPointerMove:M,onPointerUp:P,onPointerOut:O,matrix:z,matrixAutoUpdate:!1},n&&d.createElement(Es,{position:[D,D,0]},d.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:r,ref:x})),d.createElement(ei,{points:F,lineWidth:c*4,visible:!1,userData:v}),d.createElement(ei,{transparent:!0,raycast:()=>null,depthTest:o,points:F,lineWidth:c,side:dt,color:R?h:u[t],opacity:m,polygonOffset:!0,polygonOffsetFactor:-10,renderOrder:f,fog:!1}))},P9=(s,e,t)=>{const i=Math.abs(s.x)>=Math.abs(s.y)&&Math.abs(s.x)>=Math.abs(s.z)?0:Math.abs(s.y)>=Math.abs(s.x)&&Math.abs(s.y)>=Math.abs(s.z)?1:2,n=[0,1,2].sort((p,g)=>Math.abs(e.getComponent(g))-Math.abs(e.getComponent(p))),r=i===n[0]?n[1]:n[0],o=s.getComponent(i),a=s.getComponent(r),c=e.getComponent(i),l=e.getComponent(r),u=t.getComponent(i),f=(t.getComponent(r)-u*(a/o))/(l-c*(a/o));return[(u-f*c)/o,f]},rr=new qi,or=new _,$h=new re,ba=({dir1:s,dir2:e,axis:t})=>{const{translation:i,translationLimits:n,annotations:r,annotationsClass:o,depthTest:a,scale:c,lineWidth:l,fixed:u,axisColors:h,hoveredColor:f,opacity:m,renderOrder:p,onDragStart:g,onDrag:y,onDragEnd:v,userData:E}=d.useContext(Ss),x=H(N=>N.controls),T=d.useRef(null),A=d.useRef(null),C=d.useRef(null),b=d.useRef(0),R=d.useRef(0),[I,w]=d.useState(!1),M=d.useCallback(N=>{r&&(T.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`,T.current.style.display="block"),N.stopPropagation();const B=N.point.clone(),G=new _().setFromMatrixPosition(A.current.matrixWorld),j=new _().setFromMatrixColumn(A.current.matrixWorld,0).normalize(),L=new _().setFromMatrixColumn(A.current.matrixWorld,1).normalize(),X=new _().setFromMatrixColumn(A.current.matrixWorld,2).normalize(),Q=new vi().setFromNormalAndCoplanarPoint(X,G);C.current={clickPoint:B,e1:j,e2:L,plane:Q},b.current=i.current[(t+1)%3],R.current=i.current[(t+2)%3],g({component:"Slider",axis:t,origin:G,directions:[j,L,X]}),x&&(x.enabled=!1),N.target.setPointerCapture(N.pointerId)},[r,x,g,t]),P=d.useCallback(N=>{if(N.stopPropagation(),I||w(!0),C.current){const{clickPoint:B,e1:G,e2:j,plane:L}=C.current,[X,Q]=n?.[(t+1)%3]||[void 0,void 0],[ne,he]=n?.[(t+2)%3]||[void 0,void 0];rr.copy(N.ray),rr.intersectPlane(L,or),rr.direction.negate(),rr.intersectPlane(L,or),or.sub(B);let[xe,ce]=P9(G,j,or);X!==void 0&&(xe=Math.max(xe,X-b.current)),Q!==void 0&&(xe=Math.min(xe,Q-b.current)),ne!==void 0&&(ce=Math.max(ce,ne-R.current)),he!==void 0&&(ce=Math.min(ce,he-R.current)),i.current[(t+1)%3]=b.current+xe,i.current[(t+2)%3]=R.current+ce,r&&(T.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`),$h.makeTranslation(xe*G.x+ce*j.x,xe*G.y+ce*j.y,xe*G.z+ce*j.z),y($h)}},[r,y,I,i,n,t]),O=d.useCallback(N=>{r&&(T.current.style.display="none"),N.stopPropagation(),C.current=null,v(),x&&(x.enabled=!0),N.target.releasePointerCapture(N.pointerId)},[r,x,v]),z=d.useCallback(N=>{N.stopPropagation(),w(!1)},[]),D=d.useMemo(()=>{const N=s.clone().normalize(),B=e.clone().normalize();return new re().makeBasis(N,B,N.clone().cross(B))},[s,e]),F=u?1/7:c/7,k=u?.225:c*.225,$=I?f:h[t],U=d.useMemo(()=>[new _(0,0,0),new _(0,k,0),new _(k,k,0),new _(k,0,0),new _(0,0,0)],[k]);return d.createElement("group",{ref:A,matrix:D,matrixAutoUpdate:!1},r&&d.createElement(Es,{position:[0,0,0]},d.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:o,ref:T})),d.createElement("group",{position:[F*1.7,F*1.7,0]},d.createElement("mesh",{visible:!0,onPointerDown:M,onPointerMove:P,onPointerUp:O,onPointerOut:z,scale:k,userData:E,renderOrder:p},d.createElement("planeGeometry",null),d.createElement("meshBasicMaterial",{transparent:!0,depthTest:a,color:$,polygonOffset:!0,polygonOffsetFactor:-10,side:dt,fog:!1})),d.createElement(ei,{position:[-k/2,-k/2,0],transparent:!0,depthTest:a,points:U,lineWidth:l,color:$,opacity:m,polygonOffset:!0,polygonOffsetFactor:-10,userData:E,fog:!1,renderOrder:p})))},ss=new _,Hh=new _,M9=(s,e,t,i)=>{const n=e.dot(e),r=e.dot(s)-e.dot(t),o=e.dot(i);return o===0?-r/n:(ss.copy(i).multiplyScalar(n/o).sub(e),Hh.copy(i).multiplyScalar(r/o).add(t).sub(s),-ss.dot(Hh)/ss.dot(ss))},D9=new _(0,1,0),Xn=new _,Kh=new re,Ca=({direction:s,axis:e})=>{const{scaleLimits:t,annotations:i,annotationsClass:n,depthTest:r,scale:o,lineWidth:a,fixed:c,axisColors:l,hoveredColor:u,opacity:h,renderOrder:f,onDragStart:m,onDrag:p,onDragEnd:g,userData:y}=d.useContext(Ss),v=H(U=>U.size),E=H(U=>U.controls),x=d.useRef(null),T=d.useRef(null),A=d.useRef(null),C=d.useRef(1),b=d.useRef(1),R=d.useRef(null),[I,w]=d.useState(!1),M=c?1.2:1.2*o,P=d.useCallback(U=>{i&&(x.current.innerText=`${b.current.toFixed(2)}`,x.current.style.display="block"),U.stopPropagation();const N=new re().extractRotation(T.current.matrixWorld),B=U.point.clone(),G=new _().setFromMatrixPosition(T.current.matrixWorld),j=s.clone().applyMatrix4(N).normalize(),L=T.current.matrixWorld.clone(),X=L.clone().invert(),Q=c?1/ro(T.current.getWorldPosition(ss),o,U.camera,v):1;R.current={clickPoint:B,dir:j,mPLG:L,mPLGInv:X,offsetMultiplier:Q},m({component:"Sphere",axis:e,origin:G,directions:[j]}),E&&(E.enabled=!1),U.target.setPointerCapture(U.pointerId)},[i,E,s,m,e,c,o,v]),O=d.useCallback(U=>{if(U.stopPropagation(),I||w(!0),R.current){const{clickPoint:N,dir:B,mPLG:G,mPLGInv:j,offsetMultiplier:L}=R.current,[X,Q]=t?.[e]||[1e-5,void 0],he=M9(N,B,U.ray.origin,U.ray.direction)*L,xe=c?he:he/o;let ce=Math.pow(2,xe*.2);U.shiftKey&&(ce=Math.round(ce*10)/10),ce=Math.max(ce,X/C.current),Q!==void 0&&(ce=Math.min(ce,Q/C.current)),b.current=C.current*ce,A.current.position.set(0,M+he,0),i&&(x.current.innerText=`${b.current.toFixed(2)}`),Xn.set(1,1,1),Xn.setComponent(e,ce),Kh.makeScale(Xn.x,Xn.y,Xn.z).premultiply(G).multiply(j),p(Kh)}},[i,M,p,I,t,e]),z=d.useCallback(U=>{i&&(x.current.style.display="none"),U.stopPropagation(),C.current=b.current,R.current=null,A.current.position.set(0,M,0),g(),E&&(E.enabled=!0),U.target.releasePointerCapture(U.pointerId)},[i,E,g,M]),D=d.useCallback(U=>{U.stopPropagation(),w(!1)},[]),{radius:F,matrixL:k}=d.useMemo(()=>{const U=c?a/o*1.8:o/22.5,N=new ue().setFromUnitVectors(D9,s.clone().normalize()),B=new re().makeRotationFromQuaternion(N);return{radius:U,matrixL:B}},[s,o,a,c]),$=I?u:l[e];return d.createElement("group",{ref:T},d.createElement("group",{matrix:k,matrixAutoUpdate:!1,onPointerDown:P,onPointerMove:O,onPointerUp:z,onPointerOut:D},i&&d.createElement(Es,{position:[0,M/2,0]},d.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:n,ref:x})),d.createElement("mesh",{ref:A,position:[0,M,0],renderOrder:f,userData:y},d.createElement("sphereGeometry",{args:[F,12,12]}),d.createElement("meshBasicMaterial",{transparent:!0,depthTest:r,color:$,opacity:h,polygonOffset:!0,polygonOffsetFactor:-10}))))},Vh=new re,jh=new re,Wh=new re,ar=new re,Ra=new re,mn=new re,Xh=new re,Yh=new re,Qh=new re,pn=new gi,wa=new gi,Jh=new _,qh=new _,Zh=new _,ed=new _,Yn=new _,gn=new _(1,0,0),yn=new _(0,1,0),vn=new _(0,0,1),B9=d.forwardRef(({enabled:s=!0,matrix:e,onDragStart:t,onDrag:i,onDragEnd:n,autoTransform:r=!0,anchor:o,disableAxes:a=!1,disableSliders:c=!1,disableRotations:l=!1,disableScaling:u=!1,activeAxes:h=[!0,!0,!0],offset:f=[0,0,0],rotation:m=[0,0,0],scale:p=1,lineWidth:g=4,fixed:y=!1,translationLimits:v,rotationLimits:E,scaleLimits:x,depthTest:T=!0,renderOrder:A=500,axisColors:C=["#ff2060","#20df80","#2080ff"],hoveredColor:b="#ffff40",annotations:R=!1,annotationsClass:I,opacity:w=1,visible:M=!0,userData:P,children:O,...z},D)=>{const F=H(Q=>Q.invalidate),k=d.useRef(null),$=d.useRef(null),U=d.useRef(null),N=d.useRef(null),B=d.useRef([0,0,0]),G=d.useRef(new _(1,1,1)),j=d.useRef(new _(1,1,1));d.useLayoutEffect(()=>{o&&(N.current.updateWorldMatrix(!0,!0),ar.copy(N.current.matrixWorld).invert(),pn.makeEmpty(),N.current.traverse(Q=>{Q.geometry&&(Q.geometry.boundingBox||Q.geometry.computeBoundingBox(),mn.copy(Q.matrixWorld).premultiply(ar),wa.copy(Q.geometry.boundingBox),wa.applyMatrix4(mn),pn.union(wa))}),Jh.copy(pn.max).add(pn.min).multiplyScalar(.5),qh.copy(pn.max).sub(pn.min).multiplyScalar(.5),Zh.copy(qh).multiply(new _(...o)).add(Jh),ed.set(...f).add(Zh),U.current.position.copy(ed),F())});const L=d.useMemo(()=>({onDragStart:Q=>{Vh.copy($.current.matrix),jh.copy($.current.matrixWorld),t&&t(Q),F()},onDrag:Q=>{Wh.copy(k.current.matrixWorld),ar.copy(Wh).invert(),Ra.copy(jh).premultiply(Q),mn.copy(Ra).premultiply(ar),Xh.copy(Vh).invert(),Yh.copy(mn).multiply(Xh),r&&$.current.matrix.copy(mn),i&&i(mn,Yh,Ra,Q),F()},onDragEnd:()=>{n&&n(),F()},translation:B,translationLimits:v,rotationLimits:E,axisColors:C,hoveredColor:b,opacity:w,scale:p,lineWidth:g,fixed:y,depthTest:T,renderOrder:A,userData:P,annotations:R,annotationsClass:I}),[t,i,n,B,v,E,x,T,p,g,y,...C,b,w,P,r,R,I]),X=new _;return ee(Q=>{if(y){const ne=ro(U.current.getWorldPosition(X),p,Q.camera,Q.size);G.current.setScalar(ne)}e&&e instanceof re&&($.current.matrix=e),$.current.updateWorldMatrix(!0,!0),Qh.makeRotationFromEuler(U.current.rotation).setPosition(U.current.position).premultiply($.current.matrixWorld),j.current.setFromMatrixScale(Qh),Yn.copy(G.current).divide(j.current),(Math.abs(U.current.scale.x-Yn.x)>1e-4||Math.abs(U.current.scale.y-Yn.y)>1e-4||Math.abs(U.current.scale.z-Yn.z)>1e-4)&&(U.current.scale.copy(Yn),Q.invalidate())}),d.useImperativeHandle(D,()=>$.current,[]),d.createElement(Ss.Provider,{value:L},d.createElement("group",{ref:k},d.createElement("group",Z({ref:$,matrix:e,matrixAutoUpdate:!1},z),d.createElement("group",{visible:M,ref:U,position:f,rotation:m},s&&d.createElement(d.Fragment,null,!a&&h[0]&&d.createElement(va,{axis:0,direction:gn}),!a&&h[1]&&d.createElement(va,{axis:1,direction:yn}),!a&&h[2]&&d.createElement(va,{axis:2,direction:vn}),!c&&h[0]&&h[1]&&d.createElement(ba,{axis:2,dir1:gn,dir2:yn}),!c&&h[0]&&h[2]&&d.createElement(ba,{axis:1,dir1:vn,dir2:gn}),!c&&h[2]&&h[1]&&d.createElement(ba,{axis:0,dir1:yn,dir2:vn}),!l&&h[0]&&h[1]&&d.createElement(Ta,{axis:2,dir1:gn,dir2:yn}),!l&&h[0]&&h[2]&&d.createElement(Ta,{axis:1,dir1:vn,dir2:gn}),!l&&h[2]&&h[1]&&d.createElement(Ta,{axis:0,dir1:yn,dir2:vn}),!u&&h[0]&&d.createElement(Ca,{axis:0,direction:gn}),!u&&h[1]&&d.createElement(Ca,{axis:1,direction:yn}),!u&&h[2]&&d.createElement(Ca,{axis:2,direction:vn}))),d.createElement("group",{ref:N},O))))}),F9=d.forwardRef(({options:s={video:!0},...e},t)=>{const i=Gt(()=>navigator.mediaDevices.getDisplayMedia(s),[]);return d.useEffect(()=>()=>{i?.getTracks().forEach(n=>n.stop()),wl([])},[i]),d.createElement(co,Z({ref:t},e,{src:i}))}),Ap=d.forwardRef(({constraints:s={audio:!1,video:{facingMode:"user"}},...e},t)=>{const i=Gt(()=>navigator.mediaDevices.getUserMedia(s),[]);return d.useEffect(()=>()=>{i?.getTracks().forEach(n=>n.stop()),wl([])},[i]),d.createElement(co,Z({ref:t},e,{src:i}))}),k9=new _(0,0,-1),O9=(function(){const s=new _,e=new _,t=new _,i=new _,n=new _;return function(r,o,a,c){return s.copy(r),e.copy(o),t.copy(a),i.copy(e).sub(s),n.copy(t).sub(s),c.crossVectors(n,i).normalize()}})();function N9(s,e){return s.clone().add(e).multiplyScalar(.5)}const Sp=d.forwardRef(({points:s=Mr.SAMPLE_FACELANDMARKER_RESULT.faceLandmarks[0],face:e,facialTransformationMatrix:t,faceBlendshapes:i,offset:n,offsetScalar:r=80,width:o,height:a,depth:c=1,verticalTri:l=[159,386,152],origin:u,eyes:h=!0,eyesAsOrigin:f=!1,debug:m=!1,children:p,...g},y)=>{var v;e&&(s=e.keypoints,console.warn("Facemesh `face` prop is deprecated: use `points` instead"));const E=d.useRef(null),x=d.useRef(null),T=d.useRef(null),A=d.useRef(null),C=d.useRef(null),b=d.useRef(null),R=d.useRef(null),[I]=d.useState(()=>new _),[w]=d.useState(()=>new Ve),[M]=d.useState(()=>new ue),[P]=d.useState(()=>new _),{invalidate:O}=H();d.useEffect(()=>{var U;(U=C.current)==null||U.geometry.setIndex(Mr.TRIANGULATION)},[]);const[z]=d.useState(()=>new _);d.useEffect(()=>{var U,N;const B=(U=C.current)==null?void 0:U.geometry;if(!B)return;if(B.setFromPoints(s),B.setDrawRange(0,Mr.TRIANGULATION.length),t)if(w.matrix.fromArray(t.data),w.matrix.decompose(w.position,w.quaternion,w.scale),w.rotation.y*=-1,w.rotation.z*=-1,M.setFromEuler(w.rotation),n){var G;w.position.y*=-1,w.position.z*=-1,(G=E.current)==null||G.position.copy(w.position.divideScalar(r))}else{var j;(j=E.current)==null||j.position.set(0,0,0)}else O9(s[l[0]],s[l[1]],s[l[2]],I),M.setFromUnitVectors(k9,I);const L=M.clone().invert();if(B.computeBoundingBox(),m&&O(),B.center(),B.applyQuaternion(L),(N=A.current)==null||N.setRotationFromQuaternion(M),h){if(!i)console.warn("Facemesh `eyes` option only works if `faceBlendshapes` is provided: skipping.");else if(b.current&&R.current&&T.current)if(f){const X=b.current._computeSphere(B),Q=R.current._computeSphere(B);u=N9(X.center,Q.center).negate(),b.current._update(B,i,X),R.current._update(B,i,Q)}else b.current._update(B,i),R.current._update(B,i)}if(T.current){if(u!==void 0)if(typeof u=="number"){const X=B.getAttribute("position");P.set(-X.getX(u),-X.getY(u),-X.getZ(u))}else u.isVector3&&P.copy(u);else P.setScalar(0);T.current.position.copy(P)}if(x.current){let X=1;(o||a||c)&&(B.boundingBox.getSize(z),o&&(X=o/z.x),a&&(X=a/z.y),c&&(X=c/z.z)),x.current.scale.setScalar(X!==1?X:1)}B.computeVertexNormals(),B.attributes.position.needsUpdate=!0},[s,t,i,w,n,r,o,a,c,l,u,h,m,O,I,M,z,P]);const D=d.useMemo(()=>({outerRef:A,meshRef:C,eyeRightRef:b,eyeLeftRef:R}),[]);d.useImperativeHandle(y,()=>D,[D]);const[F]=d.useState(()=>new _),k=(v=C.current)==null?void 0:v.geometry.boundingBox,$=k?.getSize(F).z||1;return d.createElement("group",g,d.createElement("group",{ref:E},d.createElement("group",{ref:A},d.createElement("group",{ref:x},m?d.createElement(d.Fragment,null,d.createElement("axesHelper",{args:[$]}),d.createElement(ei,{points:[[0,0,0],[0,0,-$]],color:65535})):null,d.createElement("group",{ref:T},h&&i&&d.createElement("group",{name:"eyes"},d.createElement(fl,{side:"left",ref:b,debug:m}),d.createElement(fl,{side:"right",ref:R,debug:m})),d.createElement("mesh",{ref:C,name:"face"},p,m?d.createElement(d.Fragment,null,k&&d.createElement("box3Helper",{args:[k]})):null))))))}),Tn={contourLandmarks:{right:[33,133,159,145,153],left:[263,362,386,374,380]},blendshapes:{right:[14,16,18,12],left:[13,15,17,11]},color:{right:"red",left:"#00ff00"},fov:{horizontal:100,vertical:90}},fl=d.forwardRef(({side:s,debug:e=!0},t)=>{const i=d.useRef(null),n=d.useRef(null),[r]=d.useState(()=>new yi),o=d.useCallback(h=>{const f=h.getAttribute("position"),p=Tn.contourLandmarks[s].map(g=>new _(f.getX(g),f.getY(g),f.getZ(g)));return r.center.set(0,0,0),p.forEach(g=>r.center.add(g)),r.center.divideScalar(p.length),r.radius=p[0].sub(p[1]).length()/2,r},[r,s]),[a]=d.useState(()=>new pi),c=d.useCallback((h,f,m)=>{if(i.current){var p;(p=m)!==null&&p!==void 0||(m=o(h)),i.current.position.copy(m.center),i.current.scale.setScalar(m.radius)}if(f&&n.current){const g=Tn.blendshapes[s],y=f.categories[g[0]].score,v=f.categories[g[1]].score,E=f.categories[g[2]].score,x=f.categories[g[3]].score,T=Tn.fov.horizontal*me.DEG2RAD,A=Tn.fov.vertical*me.DEG2RAD,C=T*.5*(x-E),b=A*.5*(y-v)*(s==="left"?1:-1);a.set(C,b,0),n.current.setRotationFromEuler(a)}},[o,s,a]),l=d.useMemo(()=>({eyeMeshRef:i,irisDirRef:n,_computeSphere:o,_update:c}),[o,c]);d.useImperativeHandle(t,()=>l,[l]);const u=Tn.color[s];return d.createElement("group",null,d.createElement("group",{ref:i},e&&d.createElement("axesHelper",null),d.createElement("group",{ref:n},d.createElement(d.Fragment,null,e&&d.createElement(ei,{points:[[0,0,0],[0,0,-2]],lineWidth:1,color:u})))))}),Mr={TRIANGULATION:[127,34,139,11,0,37,232,231,120,72,37,39,128,121,47,232,121,128,104,69,67,175,171,148,157,154,155,118,50,101,73,39,40,9,151,108,48,115,131,194,204,211,74,40,185,80,42,183,40,92,186,230,229,118,202,212,214,83,18,17,76,61,146,160,29,30,56,157,173,106,204,194,135,214,192,203,165,98,21,71,68,51,45,4,144,24,23,77,146,91,205,50,187,201,200,18,91,106,182,90,91,181,85,84,17,206,203,36,148,171,140,92,40,39,193,189,244,159,158,28,247,246,161,236,3,196,54,68,104,193,168,8,117,228,31,189,193,55,98,97,99,126,47,100,166,79,218,155,154,26,209,49,131,135,136,150,47,126,217,223,52,53,45,51,134,211,170,140,67,69,108,43,106,91,230,119,120,226,130,247,63,53,52,238,20,242,46,70,156,78,62,96,46,53,63,143,34,227,173,155,133,123,117,111,44,125,19,236,134,51,216,206,205,154,153,22,39,37,167,200,201,208,36,142,100,57,212,202,20,60,99,28,158,157,35,226,113,160,159,27,204,202,210,113,225,46,43,202,204,62,76,77,137,123,116,41,38,72,203,129,142,64,98,240,49,102,64,41,73,74,212,216,207,42,74,184,169,170,211,170,149,176,105,66,69,122,6,168,123,147,187,96,77,90,65,55,107,89,90,180,101,100,120,63,105,104,93,137,227,15,86,85,129,102,49,14,87,86,55,8,9,100,47,121,145,23,22,88,89,179,6,122,196,88,95,96,138,172,136,215,58,172,115,48,219,42,80,81,195,3,51,43,146,61,171,175,199,81,82,38,53,46,225,144,163,110,246,33,7,52,65,66,229,228,117,34,127,234,107,108,69,109,108,151,48,64,235,62,78,191,129,209,126,111,35,143,163,161,246,117,123,50,222,65,52,19,125,141,221,55,65,3,195,197,25,7,33,220,237,44,70,71,139,122,193,245,247,130,33,71,21,162,153,158,159,170,169,150,188,174,196,216,186,92,144,160,161,2,97,167,141,125,241,164,167,37,72,38,12,145,159,160,38,82,13,63,68,71,226,35,111,158,153,154,101,50,205,206,92,165,209,198,217,165,167,97,220,115,218,133,112,243,239,238,241,214,135,169,190,173,133,171,208,32,125,44,237,86,87,178,85,86,179,84,85,180,83,84,181,201,83,182,137,93,132,76,62,183,61,76,184,57,61,185,212,57,186,214,207,187,34,143,156,79,239,237,123,137,177,44,1,4,201,194,32,64,102,129,213,215,138,59,166,219,242,99,97,2,94,141,75,59,235,24,110,228,25,130,226,23,24,229,22,23,230,26,22,231,112,26,232,189,190,243,221,56,190,28,56,221,27,28,222,29,27,223,30,29,224,247,30,225,238,79,20,166,59,75,60,75,240,147,177,215,20,79,166,187,147,213,112,233,244,233,128,245,128,114,188,114,217,174,131,115,220,217,198,236,198,131,134,177,132,58,143,35,124,110,163,7,228,110,25,356,389,368,11,302,267,452,350,349,302,303,269,357,343,277,452,453,357,333,332,297,175,152,377,384,398,382,347,348,330,303,304,270,9,336,337,278,279,360,418,262,431,304,408,409,310,415,407,270,409,410,450,348,347,422,430,434,313,314,17,306,307,375,387,388,260,286,414,398,335,406,418,364,367,416,423,358,327,251,284,298,281,5,4,373,374,253,307,320,321,425,427,411,421,313,18,321,405,406,320,404,405,315,16,17,426,425,266,377,400,369,322,391,269,417,465,464,386,257,258,466,260,388,456,399,419,284,332,333,417,285,8,346,340,261,413,441,285,327,460,328,355,371,329,392,439,438,382,341,256,429,420,360,364,394,379,277,343,437,443,444,283,275,440,363,431,262,369,297,338,337,273,375,321,450,451,349,446,342,467,293,334,282,458,461,462,276,353,383,308,324,325,276,300,293,372,345,447,382,398,362,352,345,340,274,1,19,456,248,281,436,427,425,381,256,252,269,391,393,200,199,428,266,330,329,287,273,422,250,462,328,258,286,384,265,353,342,387,259,257,424,431,430,342,353,276,273,335,424,292,325,307,366,447,345,271,303,302,423,266,371,294,455,460,279,278,294,271,272,304,432,434,427,272,407,408,394,430,431,395,369,400,334,333,299,351,417,168,352,280,411,325,319,320,295,296,336,319,403,404,330,348,349,293,298,333,323,454,447,15,16,315,358,429,279,14,15,316,285,336,9,329,349,350,374,380,252,318,402,403,6,197,419,318,319,325,367,364,365,435,367,397,344,438,439,272,271,311,195,5,281,273,287,291,396,428,199,311,271,268,283,444,445,373,254,339,263,466,249,282,334,296,449,347,346,264,447,454,336,296,299,338,10,151,278,439,455,292,407,415,358,371,355,340,345,372,390,249,466,346,347,280,442,443,282,19,94,370,441,442,295,248,419,197,263,255,359,440,275,274,300,383,368,351,412,465,263,467,466,301,368,389,380,374,386,395,378,379,412,351,419,436,426,322,373,390,388,2,164,393,370,462,461,164,0,267,302,11,12,374,373,387,268,12,13,293,300,301,446,261,340,385,384,381,330,266,425,426,423,391,429,355,437,391,327,326,440,457,438,341,382,362,459,457,461,434,430,394,414,463,362,396,369,262,354,461,457,316,403,402,315,404,403,314,405,404,313,406,405,421,418,406,366,401,361,306,408,407,291,409,408,287,410,409,432,436,410,434,416,411,264,368,383,309,438,457,352,376,401,274,275,4,421,428,262,294,327,358,433,416,367,289,455,439,462,370,326,2,326,370,305,460,455,254,449,448,255,261,446,253,450,449,252,451,450,256,452,451,341,453,452,413,464,463,441,413,414,258,442,441,257,443,442,259,444,443,260,445,444,467,342,445,459,458,250,289,392,290,290,328,460,376,433,435,250,290,392,411,416,433,341,463,464,453,464,465,357,465,412,343,412,399,360,363,440,437,399,456,420,456,363,401,435,288,372,383,353,339,255,249,448,261,255,133,243,190,133,155,112,33,246,247,33,130,25,398,384,286,362,398,414,362,463,341,263,359,467,263,249,255,466,467,260,75,60,166,238,239,79,162,127,139,72,11,37,121,232,120,73,72,39,114,128,47,233,232,128,103,104,67,152,175,148,173,157,155,119,118,101,74,73,40,107,9,108,49,48,131,32,194,211,184,74,185,191,80,183,185,40,186,119,230,118,210,202,214,84,83,17,77,76,146,161,160,30,190,56,173,182,106,194,138,135,192,129,203,98,54,21,68,5,51,4,145,144,23,90,77,91,207,205,187,83,201,18,181,91,182,180,90,181,16,85,17,205,206,36,176,148,140,165,92,39,245,193,244,27,159,28,30,247,161,174,236,196,103,54,104,55,193,8,111,117,31,221,189,55,240,98,99,142,126,100,219,166,218,112,155,26,198,209,131,169,135,150,114,47,217,224,223,53,220,45,134,32,211,140,109,67,108,146,43,91,231,230,120,113,226,247,105,63,52,241,238,242,124,46,156,95,78,96,70,46,63,116,143,227,116,123,111,1,44,19,3,236,51,207,216,205,26,154,22,165,39,167,199,200,208,101,36,100,43,57,202,242,20,99,56,28,157,124,35,113,29,160,27,211,204,210,124,113,46,106,43,204,96,62,77,227,137,116,73,41,72,36,203,142,235,64,240,48,49,64,42,41,74,214,212,207,183,42,184,210,169,211,140,170,176,104,105,69,193,122,168,50,123,187,89,96,90,66,65,107,179,89,180,119,101,120,68,63,104,234,93,227,16,15,85,209,129,49,15,14,86,107,55,9,120,100,121,153,145,22,178,88,179,197,6,196,89,88,96,135,138,136,138,215,172,218,115,219,41,42,81,5,195,51,57,43,61,208,171,199,41,81,38,224,53,225,24,144,110,105,52,66,118,229,117,227,34,234,66,107,69,10,109,151,219,48,235,183,62,191,142,129,126,116,111,143,7,163,246,118,117,50,223,222,52,94,19,141,222,221,65,196,3,197,45,220,44,156,70,139,188,122,245,139,71,162,145,153,159,149,170,150,122,188,196,206,216,92,163,144,161,164,2,167,242,141,241,0,164,37,11,72,12,144,145,160,12,38,13,70,63,71,31,226,111,157,158,154,36,101,205,203,206,165,126,209,217,98,165,97,237,220,218,237,239,241,210,214,169,140,171,32,241,125,237,179,86,178,180,85,179,181,84,180,182,83,181,194,201,182,177,137,132,184,76,183,185,61,184,186,57,185,216,212,186,192,214,187,139,34,156,218,79,237,147,123,177,45,44,4,208,201,32,98,64,129,192,213,138,235,59,219,141,242,97,97,2,141,240,75,235,229,24,228,31,25,226,230,23,229,231,22,230,232,26,231,233,112,232,244,189,243,189,221,190,222,28,221,223,27,222,224,29,223,225,30,224,113,247,225,99,60,240,213,147,215,60,20,166,192,187,213,243,112,244,244,233,245,245,128,188,188,114,174,134,131,220,174,217,236,236,198,134,215,177,58,156,143,124,25,110,7,31,228,25,264,356,368,0,11,267,451,452,349,267,302,269,350,357,277,350,452,357,299,333,297,396,175,377,381,384,382,280,347,330,269,303,270,151,9,337,344,278,360,424,418,431,270,304,409,272,310,407,322,270,410,449,450,347,432,422,434,18,313,17,291,306,375,259,387,260,424,335,418,434,364,416,391,423,327,301,251,298,275,281,4,254,373,253,375,307,321,280,425,411,200,421,18,335,321,406,321,320,405,314,315,17,423,426,266,396,377,369,270,322,269,413,417,464,385,386,258,248,456,419,298,284,333,168,417,8,448,346,261,417,413,285,326,327,328,277,355,329,309,392,438,381,382,256,279,429,360,365,364,379,355,277,437,282,443,283,281,275,363,395,431,369,299,297,337,335,273,321,348,450,349,359,446,467,283,293,282,250,458,462,300,276,383,292,308,325,283,276,293,264,372,447,346,352,340,354,274,19,363,456,281,426,436,425,380,381,252,267,269,393,421,200,428,371,266,329,432,287,422,290,250,328,385,258,384,446,265,342,386,387,257,422,424,430,445,342,276,422,273,424,306,292,307,352,366,345,268,271,302,358,423,371,327,294,460,331,279,294,303,271,304,436,432,427,304,272,408,395,394,431,378,395,400,296,334,299,6,351,168,376,352,411,307,325,320,285,295,336,320,319,404,329,330,349,334,293,333,366,323,447,316,15,315,331,358,279,317,14,316,8,285,9,277,329,350,253,374,252,319,318,403,351,6,419,324,318,325,397,367,365,288,435,397,278,344,439,310,272,311,248,195,281,375,273,291,175,396,199,312,311,268,276,283,445,390,373,339,295,282,296,448,449,346,356,264,454,337,336,299,337,338,151,294,278,455,308,292,415,429,358,355,265,340,372,388,390,466,352,346,280,295,442,282,354,19,370,285,441,295,195,248,197,457,440,274,301,300,368,417,351,465,251,301,389,385,380,386,394,395,379,399,412,419,410,436,322,387,373,388,326,2,393,354,370,461,393,164,267,268,302,12,386,374,387,312,268,13,298,293,301,265,446,340,380,385,381,280,330,425,322,426,391,420,429,437,393,391,326,344,440,438,458,459,461,364,434,394,428,396,262,274,354,457,317,316,402,316,315,403,315,314,404,314,313,405,313,421,406,323,366,361,292,306,407,306,291,408,291,287,409,287,432,410,427,434,411,372,264,383,459,309,457,366,352,401,1,274,4,418,421,262,331,294,358,435,433,367,392,289,439,328,462,326,94,2,370,289,305,455,339,254,448,359,255,446,254,253,449,253,252,450,252,256,451,256,341,452,414,413,463,286,441,414,286,258,441,258,257,442,257,259,443,259,260,444,260,467,445,309,459,250,305,289,290,305,290,460,401,376,435,309,250,392,376,411,433,453,341,464,357,453,465,343,357,412,437,343,399,344,360,440,420,437,456,360,420,363,361,401,288,265,372,353,390,339,249,339,448,255],SAMPLE_FACE:{keypoints:[{x:356.2804412841797,y:295.1960563659668,z:-23.786449432373047,name:"lips"},{x:354.8859405517578,y:264.69520568847656,z:-36.718435287475586},{x:355.2180862426758,y:275.3360366821289,z:-21.183712482452393},{x:347.349853515625,y:242.4400234222412,z:-25.093655586242676},{x:354.40135955810547,y:256.67933464050293,z:-38.23572635650635},{x:353.7689971923828,y:247.54886627197266,z:-34.5475435256958},{x:352.1288299560547,y:227.34312057495117,z:-13.095386028289795},{x:303.5013198852539,y:234.67002868652344,z:12.500141859054565,name:"rightEye"},{x:351.09378814697266,y:211.87547206878662,z:-6.413471698760986},{x:350.7115936279297,y:202.1251630783081,z:-6.413471698760986},{x:348.33667755126953,y:168.7741756439209,z:6.483500003814697,name:"faceOval"},{x:356.4806365966797,y:299.2995357513428,z:-23.144519329071045},{x:356.5511703491211,y:302.66146659851074,z:-21.020312309265137},{x:356.6239547729492,y:304.1536331176758,z:-18.137459754943848,name:"lips"},{x:356.5807342529297,y:305.1840591430664,z:-18.767719268798828,name:"lips"},{x:356.8241500854492,y:308.25711250305176,z:-20.16829490661621},{x:357.113037109375,y:312.26277351379395,z:-22.10575819015503},{x:357.34962463378906,y:317.1123218536377,z:-21.837315559387207,name:"lips"},{x:357.6658630371094,y:325.51036834716797,z:-16.27002477645874},{x:355.0201416015625,y:269.36279296875,z:-33.73054027557373},{x:348.5237503051758,y:270.33411026000977,z:-24.93025302886963},{x:279.97331619262695,y:213.24176788330078,z:47.759642601013184,name:"faceOval"},{x:322.66529083251953,y:238.5027265548706,z:5.535193085670471},{x:316.0983657836914,y:239.94489669799805,z:5.777376294136047},{x:309.9431610107422,y:240.24518966674805,z:7.510589361190796},{x:301.31994247436523,y:237.86138534545898,z:13.118728399276733},{x:328.14266204833984,y:235.80496788024902,z:6.646900177001953},{x:313.7326431274414,y:222.11161136627197,z:3.9887237548828125},{x:320.45196533203125,y:221.87729358673096,z:4.601476192474365},{x:307.35679626464844,y:223.63793849945068,z:5.932023525238037},{x:303.0031204223633,y:226.3743782043457,z:8.479321002960205},{x:296.80023193359375,y:242.94299125671387,z:15.931552648544312},{x:332.2352981567383,y:340.77341079711914,z:-10.165848731994629},{x:301.38587951660156,y:233.46447944641113,z:14.764405488967896,name:"rightEye"},{x:279.0147018432617,y:244.37155723571777,z:45.77549457550049},{x:289.60548400878906,y:239.1807460784912,z:23.191204071044922},{x:320.32257080078125,y:267.1292781829834,z:-4.954537749290466},{x:347.64583587646484,y:294.4955062866211,z:-23.062820434570312,name:"lips"},{x:349.28138732910156,y:303.1095886230469,z:-20.238323211669922},{x:338.9453125,y:298.19186210632324,z:-19.456336498260498,name:"lips"},{x:333.36788177490234,y:302.6706790924072,z:-14.776077270507812,name:"lips"},{x:342.89188385009766,y:304.3561363220215,z:-17.752301692962646},{x:337.7375030517578,y:306.0098361968994,z:-13.410515785217285},{x:325.6159210205078,y:316.22995376586914,z:-6.681914925575256},{x:349.0104675292969,y:264.9818515777588,z:-36.274919509887695},{x:347.7138900756836,y:257.5664806365967,z:-37.67549514770508},{x:291.79357528686523,y:218.88171672821045,z:11.578094959259033,name:"rightEyebrow"},{x:332.2689437866211,y:247.56946563720703,z:-3.3730539679527283},{x:332.0074462890625,y:267.1201229095459,z:-19.969879388809204},{x:331.27952575683594,y:263.6967658996582,z:-17.47218608856201},{x:301.04373931884766,y:269.56552505493164,z:3.61815482378006},{x:347.4863815307617,y:249.0706443786621,z:-32.633421421051025},{x:307.26118087768555,y:208.2646894454956,z:1.1591226607561111,name:"rightEyebrow"},{x:297.91919708251953,y:212.22604751586914,z:5.914516448974609,name:"rightEyebrow"},{x:285.1651382446289,y:197.98450469970703,z:36.391637325286865,name:"faceOval"},{x:337.04097747802734,y:211.25229835510254,z:-4.548954665660858},{x:326.5912628173828,y:223.16698551177979,z:6.670243740081787},{x:320.05664825439453,y:309.5834255218506,z:-4.055835008621216},{x:289.6866226196289,y:314.617395401001,z:53.875489234924316,name:"faceOval"},{x:337.4256896972656,y:270.8755302429199,z:-17.67060160636902},{x:343.69922637939453,y:273.0000400543213,z:-18.756048679351807},{x:327.4242401123047,y:309.22399520874023,z:-4.703601002693176,name:"lips"},{x:330.37220001220703,y:308.3323001861572,z:-6.442649960517883},{x:293.87027740478516,y:207.7961826324463,z:9.821539521217346,name:"rightEyebrow"},{x:332.11437225341797,y:271.22812271118164,z:-16.64351224899292},{x:320.1197814941406,y:207.40366458892822,z:-2.48164564371109,name:"rightEyebrow"},{x:318.59575271606445,y:201.07443809509277,z:-3.110446035861969,name:"rightEyebrow"},{x:310.72303771972656,y:175.75075149536133,z:13.328815698623657,name:"faceOval"},{x:289.67578887939453,y:202.29835510253906,z:21.370456218719482},{x:315.30879974365234,y:187.35260009765625,z:5.0304025411605835},{x:287.8936767578125,y:216.54793739318848,z:17.81065821647644,name:"rightEyebrow"},{x:283.9391899108887,y:215.01142501831055,z:32.04984903335571},{x:348.35330963134766,y:299.4155788421631,z:-22.47924566268921},{x:341.1790466308594,y:301.8221855163574,z:-18.977805376052856},{x:335.69713592529297,y:304.4266891479492,z:-14.682706594467163},{x:339.4615173339844,y:272.3654365539551,z:-16.38674020767212},{x:328.99600982666016,y:308.86685371398926,z:-5.616893768310547},{x:332.00313568115234,y:309.1875743865967,z:-10.335084199905396},{x:331.0068130493164,y:307.9274368286133,z:-6.681914925575256,name:"lips"},{x:341.13792419433594,y:266.4876937866211,z:-26.56425952911377},{x:339.02950286865234,y:305.6663703918457,z:-12.33674168586731,name:"lips"},{x:344.22935485839844,y:304.9452781677246,z:-15.161235332489014,name:"lips"},{x:350.1844024658203,y:304.374303817749,z:-17.5305438041687,name:"lips"},{x:348.52630615234375,y:325.9562301635742,z:-16.164982318878174},{x:348.6581802368164,y:317.1624183654785,z:-21.510512828826904,name:"lips"},{x:348.9766311645508,y:312.1923065185547,z:-21.708929538726807},{x:349.2427444458008,y:308.0660820007324,z:-19.643079042434692},{x:349.67491149902344,y:305.42747497558594,z:-18.16080331802368,name:"lips"},{x:337.95589447021484,y:306.6535949707031,z:-12.803598642349243,name:"lips"},{x:337.06878662109375,y:307.63169288635254,z:-14.274203777313232},{x:335.77449798583984,y:309.8449516296387,z:-15.698124170303345},{x:334.6099090576172,y:312.7997016906738,z:-14.764405488967896,name:"lips"},{x:327.2330856323242,y:293.80866050720215,z:-11.864047050476074},{x:280.97679138183594,y:279.79928970336914,z:68.90834331512451,name:"faceOval"},{x:355.13843536376953,y:271.7875671386719,z:-25.350427627563477},{x:334.7235870361328,y:307.4656391143799,z:-9.302158951759338,name:"lips"},{x:333.5293960571289,y:307.89782524108887,z:-10.200862884521484},{x:346.29688262939453,y:276.4256286621094,z:-19.748122692108154},{x:335.16246795654297,y:276.22097969055176,z:-12.313398122787476},{x:345.09132385253906,y:274.7082996368408,z:-19.304605722427368},{x:325.4267883300781,y:252.95130729675293,z:-1.6661019623279572},{x:315.347843170166,y:259.05200958251953,z:-.25604281574487686},{x:330.44933319091797,y:267.7570152282715,z:-14.017432928085327},{x:294.96768951416016,y:185.26001930236816,z:23.903164863586426,name:"faceOval"},{x:299.63531494140625,y:192.7913761138916,z:12.640198469161987},{x:304.5452117919922,y:202.4142837524414,z:3.244667649269104,name:"rightEyebrow"},{x:331.6915512084961,y:320.0467872619629,z:-10.632705688476562},{x:334.5911407470703,y:201.27566814422607,z:-6.133356094360352,name:"rightEyebrow"},{x:331.4815902709961,y:185.44180870056152,z:.6627205014228821},{x:328.05816650390625,y:170.8385467529297,z:7.358860373497009,name:"faceOval"},{x:304.49764251708984,y:239.76297855377197,z:10.387605428695679},{x:290.6382179260254,y:248.85257720947266,z:19.03616428375244},{x:331.5682601928711,y:233.20727348327637,z:7.837390303611755},{x:295.5115509033203,y:228.9834451675415,z:14.41426157951355},{x:336.94332122802734,y:241.8259334564209,z:-5.27842104434967},{x:336.2792205810547,y:262.7049922943115,z:-26.12074375152588},{x:284.4102478027344,y:255.3262710571289,z:25.467140674591064},{x:295.1420593261719,y:253.02655220031738,z:12.430112361907959},{x:303.5196113586426,y:254.20703887939453,z:6.139191389083862},{x:315.73450088500977,y:251.64799690246582,z:3.3788898587226868},{x:324.69661712646484,y:247.56494522094727,z:2.3328344523906708},{x:331.57970428466797,y:243.02241325378418,z:1.1423448473215103},{x:345.6210708618164,y:229.9976634979248,z:-10.825285911560059},{x:286.26644134521484,y:270.37991523742676,z:21.708929538726807},{x:290.2525520324707,y:228.4921360015869,z:17.71728754043579},{x:351.65367126464844,y:269.3400764465332,z:-33.450424671173096},{x:333.1378936767578,y:253.88388633728027,z:-7.230473756790161},{x:277.8318977355957,y:246.95331573486328,z:68.20805549621582,name:"faceOval"},{x:336.6680908203125,y:238.10003757476807,z:.7688578963279724},{x:329.95800018310547,y:269.18323516845703,z:-7.207130789756775},{x:299.17491912841797,y:234.13324356079102,z:15.95489501953125},{x:335.61729431152344,y:258.71752738952637,z:-23.016133308410645},{x:284.1079330444336,y:297.0343494415283,z:63.25934886932373,name:"faceOval"},{x:331.44542694091797,y:230.6892442703247,z:9.92658257484436,name:"rightEye"},{x:341.41536712646484,y:253.01264762878418,z:-29.038610458374023},{x:303.5472869873047,y:327.5896739959717,z:16.725212335586548},{x:304.7756576538086,y:337.4389457702637,z:27.38126277923584,name:"faceOval"},{x:280.80501556396484,y:275.32050132751465,z:45.0752067565918},{x:295.43582916259766,y:318.4501647949219,z:26.2608003616333},{x:281.4303207397461,y:228.7355661392212,z:40.94350814819336},{x:331.2549591064453,y:349.4216537475586,z:-7.376367449760437},{x:352.4247741699219,y:271.7330074310303,z:-24.953596591949463},{x:327.5672912597656,y:260.41900634765625,z:-5.456410646438599},{x:284.5432472229004,y:241.7647933959961,z:29.668869972229004},{x:310,y:235.66174507141113,z:8.502663969993591,name:"rightEye"},{x:315.7071113586426,y:235.7572603225708,z:6.938687562942505,name:"rightEye"},{x:330.41088104248047,y:311.04143142700195,z:-9.325502514839172,name:"lips"},{x:288.5377502441406,y:285.31983375549316,z:21.837315559387207},{x:344.55039978027344,y:359.4300842285156,z:-6.705257892608643,name:"faceOval"},{x:323.41880798339844,y:351.67362213134766,z:7.802375555038452,name:"faceOval"},{x:314.64088439941406,y:346.11894607543945,z:16.36339783668518,name:"faceOval"},{x:349.4945526123047,y:184.8434829711914,z:-.21847527474164963},{x:359.24694061279297,y:359.8348903656006,z:-8.403456211090088,name:"faceOval"},{x:321.26182556152344,y:234.64492321014404,z:6.90950870513916,name:"rightEye"},{x:326.318359375,y:232.90250301361084,z:8.029969334602356,name:"rightEye"},{x:329.6211624145508,y:231.6195774078369,z:9.722331762313843,name:"rightEye"},{x:285.9398078918457,y:228.2351303100586,z:24.650139808654785},{x:325.79288482666016,y:227.88007736206055,z:7.469738721847534,name:"rightEye"},{x:320.1699447631836,y:227.5934886932373,z:6.168370842933655,name:"rightEye"},{x:314.85408782958984,y:227.85282611846924,z:6.2675780057907104,name:"rightEye"},{x:309.3084907531738,y:229.1516876220703,z:7.7031683921813965,name:"rightEye"},{x:305.5621337890625,y:230.92366218566895,z:9.722331762313843,name:"rightEye"},{x:277.8681945800781,y:228.5354232788086,z:59.71122741699219,name:"faceOval"},{x:306.1444664001465,y:235.1954698562622,z:10.603528022766113,name:"rightEye"},{x:355.4478454589844,y:281.96210861206055,z:-20.565123558044434},{x:333.02661895751953,y:288.0105400085449,z:-14.72939133644104},{x:337.15728759765625,y:269.2059516906738,z:-19.8414945602417},{x:345.9898376464844,y:283.5453128814697,z:-20.4834246635437},{x:351.48963928222656,y:219.98916149139404,z:-7.0378947257995605},{x:312.39574432373047,y:336.50628089904785,z:8.671900033950806},{x:321.32152557373047,y:343.1755256652832,z:.9067271649837494},{x:343.78379821777344,y:353.2975959777832,z:-14.355905055999756},{x:296.8791389465332,y:327.91497230529785,z:41.01353645324707,name:"faceOval"},{x:329.6939468383789,y:229.27897453308105,z:8.934508562088013,name:"rightEye"},{x:341.6905212402344,y:241.4073657989502,z:-14.589333534240723},{x:359.03079986572266,y:353.48859786987305,z:-15.803166627883911},{x:333.1861877441406,y:356.43213272094727,z:-1.0234417766332626,name:"faceOval"},{x:283.97483825683594,y:291.4318656921387,z:41.94725513458252},{x:343.33770751953125,y:305.830135345459,z:-15.756480693817139,name:"lips"},{x:342.40283966064453,y:307.7453899383545,z:-17.4021577835083},{x:341.53621673583984,y:311.0595703125,z:-19.047834873199463},{x:340.9107208251953,y:315.4837703704834,z:-18.5576331615448,name:"lips"},{x:339.1478729248047,y:323.42233657836914,z:-14.367576837539673},{x:333.3201599121094,y:307.4406337738037,z:-9.617288708686829},{x:331.2411117553711,y:306.9811820983887,z:-9.669809937477112},{x:329.23255920410156,y:306.0508346557617,z:-9.582273960113525,name:"lips"},{x:322.4586486816406,y:301.33323669433594,z:-7.720675468444824},{x:297.1712112426758,y:286.9552803039551,z:8.240055441856384},{x:341.3060760498047,y:235.4432201385498,z:-7.504753470420837},{x:336.9318389892578,y:224.3451976776123,z:5.829898118972778},{x:332.65323638916016,y:226.70403957366943,z:8.105834126472473},{x:334.67357635498047,y:306.4397621154785,z:-8.981193900108337,name:"lips"},{x:297.4601936340332,y:306.29210472106934,z:15.476365089416504},{x:342.9119110107422,y:222.37077713012695,z:-2.754466235637665},{x:335.4629898071289,y:332.20250129699707,z:-11.823196411132812},{x:353.2412338256836,y:240.56339263916016,z:-27.147831916809082},{x:346.3080596923828,y:236.41446590423584,z:-18.452589511871338},{x:352.6475143432617,y:234.1420555114746,z:-19.748122692108154},{x:337.3209762573242,y:253.39937210083008,z:-16.024924516677856},{x:358.6122131347656,y:344.90861892700195,z:-18.592647314071655},{x:358.1117248535156,y:334.64990615844727,z:-17.49552845954895},{x:346.4450454711914,y:335.0321102142334,z:-16.32838249206543},{x:319.17640686035156,y:320.2833938598633,z:-3.276764452457428},{x:325.2540588378906,y:276.2369728088379,z:-6.460157036781311},{x:326.7214584350586,y:327.3939514160156,z:-7.417217493057251},{x:310.7190132141113,y:277.2265148162842,z:-3.5452082753181458},{x:319.78355407714844,y:284.8238182067871,z:-6.4543211460113525},{x:305.773983001709,y:290.83580017089844,z:.06907138042151928},{x:344.4001770019531,y:344.85408782958984,z:-16.946970224380493},{x:333.1879425048828,y:258.74256134033203,z:-11.90489649772644},{x:313.80598068237305,y:327.08919525146484,z:2.2277912497520447},{x:322.9637908935547,y:334.6819496154785,z:-3.3643004298210144},{x:313.4055519104004,y:311.2166690826416,z:-1.1175429821014404},{x:291.0865783691406,y:298.2831001281738,z:22.467575073242188},{x:305.6580924987793,y:313.3707904815674,z:5.561453700065613},{x:288.23760986328125,y:305.9941864013672,z:36.765122413635254},{x:315.10692596435547,y:296.26991271972656,z:-4.604393839836121},{x:337.50518798828125,y:247.5944423675537,z:-10.597691535949707},{x:338.8450622558594,y:265.47778129577637,z:-27.778091430664062},{x:334.25254821777344,y:269.0671920776367,z:-20.938611030578613},{x:341.64512634277344,y:259.6387195587158,z:-32.189905643463135},{x:331.44081115722656,y:219.0976095199585,z:4.207563698291779},{x:320.56339263916016,y:216.49658203125,z:2.930997312068939},{x:311.21912002563477,y:216.57853603363037,z:2.9674705862998962},{x:303.46256256103516,y:218.54614734649658,z:5.357203483581543},{x:297.99999237060547,y:222.505202293396,z:9.325502514839172},{x:294.93839263916016,y:236.39654159545898,z:18.534289598464966},{x:278.87489318847656,y:259.7095584869385,z:45.68212032318115},{x:300.3782653808594,y:245.38593292236328,z:12.278382778167725},{x:307.06348419189453,y:246.36857986450195,z:8.164191246032715},{x:315.5229187011719,y:245.3949737548828,z:5.503097176551819},{x:323.71395111083984,y:242.75178909301758,z:4.6335723996162415},{x:330.2785873413086,y:239.34658527374268,z:4.937030673027039},{x:334.6982192993164,y:236.0460376739502,z:4.823233783245087},{x:279.3412208557129,y:263.5196113586426,z:70.91583728790283,name:"faceOval"},{x:334.65972900390625,y:271.6648578643799,z:-17.775644063949585},{x:342.05677032470703,y:246.99846267700195,z:-20.84523916244507},{x:344.0357971191406,y:264.5701503753662,z:-32.936880588531494},{x:348.25531005859375,y:268.6645030975342,z:-30.695960521697998},{x:344.12227630615234,y:266.34212493896484,z:-29.808926582336426},{x:337.12318420410156,y:274.2556858062744,z:-15.768152475357056},{x:349.49047088623047,y:269.071683883667,z:-32.51670837402344},{x:350.1683044433594,y:271.4691352844238,z:-24.93025302886963},{x:333.9634704589844,y:230.56639194488525,z:8.89949381351471},{x:338.2147979736328,y:231.4807891845703,z:4.6715047955513},{x:340.4712677001953,y:231.74463272094727,z:-.34996166825294495},{x:303.28975677490234,y:232.24980354309082,z:11.916568279266357,name:"rightEye"},{x:299.4649124145508,y:229.53842639923096,z:12.325069904327393},{x:359.09618377685547,y:241.77349090576172,z:-24.650139808654785},{x:399.46216583251953,y:229.89503860473633,z:15.919880867004395,name:"leftEye"},{x:361.38919830322266,y:269.6129894256592,z:-24.510080814361572},{x:416.9973373413086,y:206.0895538330078,z:53.26857566833496,name:"faceOval"},{x:381.32179260253906,y:235.5476474761963,z:7.6214683055877686},{x:387.8068542480469,y:236.25958442687988,z:8.345099091529846},{x:393.95751953125,y:235.8660364151001,z:10.475142002105713},{x:401.84600830078125,y:232.77019500732422,z:16.760226488113403},{x:375.70568084716797,y:233.48456382751465,z:8.234220147132874},{x:388.17752838134766,y:218.94717693328857,z:6.810300946235657},{x:381.64928436279297,y:219.2656660079956,z:6.711093783378601},{x:394.4760513305664,y:219.66821193695068,z:9.173773527145386},{x:398.8843536376953,y:221.8837022781372,z:12.03328251838684},{x:406.5454864501953,y:237.12156772613525,z:19.7131085395813},{x:383.87447357177734,y:337.6932907104492,z:-8.631049990653992},{x:401.2682342529297,y:228.5916566848755,z:18.359217643737793,name:"leftEye"},{x:422.0449447631836,y:236.73934936523438,z:51.16771221160889},{x:412.69153594970703,y:232.80198097229004,z:27.52131938934326},{x:387.3497772216797,y:263.298397064209,z:-2.8609684109687805},{x:364.5124053955078,y:293.39221000671387,z:-22.397546768188477,name:"lips"},{x:363.62987518310547,y:302.1291446685791,z:-19.643079042434692},{x:373.2334518432617,y:295.8647060394287,z:-18.125789165496826,name:"lips"},{x:378.83365631103516,y:299.5177745819092,z:-13.153743743896484,name:"lips"},{x:369.91477966308594,y:302.5704002380371,z:-16.65518283843994},{x:374.9167251586914,y:303.5416603088379,z:-11.963253021240234},{x:387.58888244628906,y:312.2716999053955,z:-4.680258631706238},{x:360.6635284423828,y:264.31986808776855,z:-35.94811677932739},{x:361.04564666748047,y:256.8225860595703,z:-37.278664112091064},{x:408.3855438232422,y:213.52088928222656,z:15.756480693817139,name:"leftEyebrow"},{x:373.2946014404297,y:245.38101196289062,z:-1.9316278398036957},{x:376.83860778808594,y:264.3721103668213,z:-18.510947227478027},{x:376.9546127319336,y:261.0010528564453,z:-15.989909172058105},{x:406.1498260498047,y:263.5030174255371,z:7.072908878326416},{x:360.07205963134766,y:248.3631706237793,z:-32.16656446456909},{x:393.11119079589844,y:205.10473251342773,z:3.7786373496055603,name:"leftEyebrow"},{x:402.12791442871094,y:207.89000988006592,z:9.383859634399414,name:"leftEyebrow"},{x:410.8693313598633,y:191.6182279586792,z:41.27030849456787,name:"faceOval"},{x:364.9509811401367,y:210.40483474731445,z:-3.758212625980377},{x:375.94444274902344,y:221.1331844329834,z:8.368442058563232},{x:392.1904754638672,y:305.0360298156738,z:-1.752179116010666},{x:419.50225830078125,y:307.25592613220215,z:58.96425247192383,name:"faceOval"},{x:372.0027160644531,y:268.7212657928467,z:-16.631840467453003},{x:366.1614227294922,y:271.6237449645996,z:-18.219159841537476},{x:385.00938415527344,y:305.3863334655762,z:-2.567722797393799},{x:381.99771881103516,y:304.9723720550537,z:-4.575215280056},{x:405.078125,y:203.21216583251953,z:13.713973760604858,name:"leftEyebrow"},{x:377.13207244873047,y:268.4710121154785,z:-15.266278982162476},{x:380.9713363647461,y:205.36980628967285,z:-.7250899076461792,name:"leftEyebrow"},{x:381.7788314819336,y:198.9268398284912,z:-1.184653863310814,name:"leftEyebrow"},{x:385.5204772949219,y:172.1484375,z:16.04826807975769,name:"faceOval"},{x:407.94189453125,y:196.76236152648926,z:25.723915100097656},{x:383.03890228271484,y:184.5157527923584,z:7.393874526023865},{x:411.61781311035156,y:210.79241752624512,z:22.315845489501953,name:"leftEyebrow"},{x:414.30870056152344,y:208.4643030166626,z:37.021894454956055},{x:364.28722381591797,y:298.35777282714844,z:-21.86065673828125},{x:371.3682556152344,y:299.78848457336426,z:-17.834001779556274},{x:376.88201904296875,y:301.6696071624756,z:-13.153743743896484},{x:370.2193832397461,y:270.49095153808594,z:-15.569736957550049},{x:383.5081100463867,y:305.2726364135742,z:-3.673594295978546},{x:380.73760986328125,y:305.96869468688965,z:-8.660228252410889},{x:381.2334442138672,y:304.63574409484863,z:-4.820316135883331,name:"lips"},{x:368.1698989868164,y:264.8884963989258,z:-25.653886795043945},{x:373.5087203979492,y:303.4233856201172,z:-10.95950722694397,name:"lips"},{x:368.4544372558594,y:303.29601287841797,z:-14.169161319732666,name:"lips"},{x:362.76554107666016,y:303.5735607147217,z:-16.911956071853638,name:"lips"},{x:366.60980224609375,y:324.8870658874512,z:-15.616422891616821},{x:365.7067108154297,y:315.95678329467773,z:-20.903596878051758,name:"lips"},{x:365.0083923339844,y:311.2232208251953,z:-21.066999435424805},{x:364.1508102416992,y:307.0583438873291,z:-18.907777070999146},{x:363.37512969970703,y:304.5721435546875,z:-17.42550015449524,name:"lips"},{x:374.580078125,y:304.3059539794922,z:-11.40302300453186,name:"lips"},{x:375.55362701416016,y:305.0998020172119,z:-12.861957550048828},{x:377.2437286376953,y:307.1674346923828,z:-14.215847253799438},{x:378.68587493896484,y:309.9015712738037,z:-13.223772048950195,name:"lips"},{x:383.8992691040039,y:290.29629707336426,z:-9.97326910495758},{x:423.3871841430664,y:271.91688537597656,z:74.37058925628662,name:"faceOval"},{x:377.68043518066406,y:304.62209701538086,z:-7.603961229324341,name:"lips"},{x:379.00428771972656,y:304.9314594268799,z:-8.57852816581726},{x:364.00279998779297,y:275.2813911437988,z:-19.25792098045349},{x:374.68231201171875,y:273.82555961608887,z:-11.28047227859497},{x:365.0354766845703,y:273.4548568725586,z:-18.791062831878662},{x:380.61901092529297,y:249.8848056793213,z:.15501167625188828},{x:391.14158630371094,y:254.7934627532959,z:2.0906515419483185},{x:378.1761169433594,y:264.9612236022949,z:-12.605184316635132},{x:400.9540557861328,y:179.99592304229736,z:27.82477855682373,name:"faceOval"},{x:398.0038833618164,y:188.50656509399414,z:16.094952821731567},{x:394.8717498779297,y:199.0359592437744,z:6.226727366447449,name:"leftEyebrow"},{x:382.10926055908203,y:316.83926582336426,z:-8.946179747581482},{x:366.51588439941406,y:200.32583713531494,z:-5.24632453918457,name:"leftEyebrow"},{x:367.4893569946289,y:183.87210845947266,z:1.9039081037044525},{x:368.6243438720703,y:168.8127565383911,z:8.736093044281006,name:"faceOval"},{x:398.96175384521484,y:234.9675178527832,z:13.713973760604858},{x:412.9645538330078,y:242.23042488098145,z:23.272905349731445},{x:372.05257415771484,y:231.41919136047363,z:9.226294755935669},{x:406.0722351074219,y:223.58965873718262,z:18.370890617370605},{x:368.27442169189453,y:240.2039337158203,z:-4.166713654994965},{x:372.3575210571289,y:260.66442489624023,z:-24.976940155029297},{x:419.2244338989258,y:247.9079246520996,z:30.299127101898193},{x:409.43885803222656,y:246.60913467407227,z:16.398411989212036},{x:401.69139862060547,y:248.76328468322754,z:9.395531415939331},{x:389.7608184814453,y:247.56915092468262,z:5.841569304466248},{x:380.5461883544922,y:244.55984115600586,z:4.263003468513489},{x:373.25817108154297,y:240.80214500427246,z:2.5356262922286987},{x:358.77086639404297,y:229.35615062713623,z:-10.387605428695679},{x:419.5793914794922,y:262.8478717803955,z:26.5175724029541},{x:410.8808898925781,y:222.51372814178467,z:22.199130058288574},{x:358.45714569091797,y:268.91467094421387,z:-33.17030906677246},{x:373.4129333496094,y:251.6385841369629,z:-5.771540403366089},{x:422.5408172607422,y:239.23919677734375,z:74.04378890991211,name:"faceOval"},{x:367.8171920776367,y:236.58040523529053,z:1.820748895406723},{x:378.51959228515625,y:266.2532329559326,z:-5.74819803237915},{x:403.3472442626953,y:229.05112266540527,z:19.689764976501465},{x:372.34840393066406,y:256.6451168060303,z:-21.872329711914062},{x:422.54566192626953,y:289.1587829589844,z:68.67491245269775,name:"faceOval"},{x:371.9297409057617,y:228.90116214752197,z:11.432201862335205,name:"leftEye"},{x:366.21360778808594,y:251.6158962249756,z:-28.19826364517212},{x:409.1571807861328,y:321.3156223297119,z:20.2266526222229},{x:408.52943420410156,y:331.44238471984863,z:31.09278917312622,name:"faceOval"},{x:424.2788314819336,y:267.1992301940918,z:50.467424392700195},{x:415.60352325439453,y:311.6528606414795,z:30.579242706298828},{x:418.12793731689453,y:221.59927368164062,z:46.26569747924805},{x:385.68286895751953,y:346.0184955596924,z:-5.70151150226593},{x:357.82936096191406,y:271.3758373260498,z:-24.836881160736084},{x:379.588623046875,y:257.5071716308594,z:-3.755294680595398},{x:417.4592590332031,y:234.71948146820068,z:34.5475435256958},{x:393.4684371948242,y:231.58967971801758,z:11.408859491348267,name:"leftEye"},{x:387.8864288330078,y:232.14245796203613,z:9.51808214187622,name:"leftEye"},{x:382.4981689453125,y:307.5654888153076,z:-7.522260546684265,name:"lips"},{x:419.00169372558594,y:277.8332805633545,z:26.424202919006348},{x:373.62953186035156,y:357.6375102996826,z:-5.75986921787262,name:"faceOval"},{x:392.8708267211914,y:347.72446632385254,z:10.154176950454712,name:"faceOval"},{x:400.3953552246094,y:341.0005187988281,z:19.39797878265381,name:"faceOval"},{x:382.25440979003906,y:231.66935920715332,z:8.998700976371765,name:"leftEye"},{x:377.14550018310547,y:230.4228687286377,z:9.804032444953918,name:"leftEye"},{x:373.8358688354492,y:229.64950561523438,z:11.292144060134888,name:"leftEye"},{x:414.5794677734375,y:221.67891025543213,z:29.412097930908203},{x:377.00672149658203,y:225.66201210021973,z:9.360517263412476,name:"leftEye"},{x:382.29530334472656,y:224.8431158065796,z:8.32175612449646,name:"leftEye"},{x:387.5133514404297,y:224.49507236480713,z:8.917000889778137,name:"leftEye"},{x:393.15906524658203,y:225.24795055389404,z:10.737749338150024,name:"leftEye"},{x:397.05554962158203,y:226.55359268188477,z:13.002015352249146,name:"leftEye"},{x:420.5299377441406,y:221.014666557312,z:65.40690422058105,name:"faceOval"},{x:397.06920623779297,y:230.6661558151245,z:13.807345628738403,name:"leftEye"},{x:377.94647216796875,y:285.1647090911865,z:-13.305472135543823},{x:372.1118927001953,y:267.1267318725586,z:-18.83774757385254},{x:364.9968719482422,y:282.24411964416504,z:-19.818150997161865},{x:401.973876953125,y:331.20131492614746,z:11.566424369812012},{x:394.3083190917969,y:338.86693954467773,z:3.142542541027069},{x:373.9820861816406,y:351.4504623413086,z:-13.50388765335083},{x:414.3888854980469,y:321.24735832214355,z:45.51872253417969,name:"faceOval"},{x:373.44234466552734,y:227.33163356781006,z:10.626870393753052,name:"leftEye"},{x:364.0731430053711,y:240.31539916992188,z:-13.807345628738403},{x:384.2658233642578,y:353.3793067932129,z:.7385850697755814,name:"faceOval"},{x:423.20526123046875,y:283.5176181793213,z:47.152724266052246},{x:369.42798614501953,y:304.0898895263672,z:-14.647691249847412,name:"lips"},{x:370.63812255859375,y:305.90051651000977,z:-16.211668252944946},{x:371.91192626953125,y:309.0167713165283,z:-17.84567356109619},{x:373.0583953857422,y:313.3545398712158,z:-17.378815412521362,name:"lips"},{x:375.39905548095703,y:321.09289169311523,z:-13.118728399276733},{x:379.2567825317383,y:304.3582534790039,z:-7.924926280975342},{x:381.18797302246094,y:303.7031364440918,z:-7.843226194381714},{x:383.0918502807617,y:302.4884605407715,z:-7.6506465673446655,name:"lips"},{x:389.09461975097656,y:297.1475315093994,z:-5.5497825145721436},{x:411.6408920288086,y:280.24898529052734,z:12.02161192893982},{x:363.3110809326172,y:234.27620887756348,z:-6.775286793708801},{x:366.0474395751953,y:223.29872131347656,z:6.827808618545532},{x:370.34427642822266,y:225.1457118988037,z:9.558931589126587},{x:377.5371551513672,y:303.60079765319824,z:-7.358860373497009,name:"lips"},{x:412.9557800292969,y:299.53579902648926,z:19.39797878265381},{x:360.0810241699219,y:221.72012329101562,z:-2.153385728597641},{x:379.82784271240234,y:329.47723388671875,z:-10.48097848892212},{x:359.08477783203125,y:235.7911491394043,z:-18.079102039337158},{x:369.6688461303711,y:251.5407943725586,z:-14.962821006774902},{x:369.5555114746094,y:333.5307312011719,z:-15.67478060722351},{x:394.0193176269531,y:315.6973171234131,z:-.9920747578144073},{x:383.78997802734375,y:272.7268695831299,z:-4.689012169837952},{x:387.67765045166016,y:323.6722755432129,z:-5.640236139297485},{x:397.8769302368164,y:272.1331214904785,z:-.9395531564950943},{x:389.87476348876953,y:280.5630111694336,z:-4.29218202829361},{x:403.83888244628906,y:285.1167869567871,z:3.0229100584983826},{x:372.5467300415039,y:343.1070327758789,z:-16.153310537338257},{x:374.1112518310547,y:256.3721466064453,z:-10.574349164962769},{x:399.73785400390625,y:321.77515983581543,z:4.849494695663452},{x:392.03365325927734,y:330.56447982788086,z:-1.3407598435878754},{x:398.59134674072266,y:305.93902587890625,z:1.517290621995926},{x:417.95997619628906,y:290.9716987609863,z:26.89105987548828},{x:406.04541778564453,y:307.35154151916504,z:8.666064143180847},{x:420.75328826904297,y:298.40752601623535,z:41.78385257720947},{x:395.4522705078125,y:291.4153575897217,z:-2.1752697229385376},{x:368.6452102661133,y:245.8882999420166,z:-9.453888535499573},{x:370.34900665283203,y:263.56690406799316,z:-26.75100326538086},{x:374.98477935791016,y:266.6126346588135,z:-19.77146625518799},{x:366.99840545654297,y:258.12140464782715,z:-31.372904777526855},{x:371.00616455078125,y:217.63479709625244,z:5.60522198677063},{x:381.30577087402344,y:214.14087295532227,z:4.983716309070587},{x:390.1496124267578,y:213.38221549987793,z:5.593550801277161},{x:397.7696990966797,y:214.3659782409668,z:8.57852816581726},{x:403.1652069091797,y:217.65509605407715,z:13.013685941696167},{x:407.3551940917969,y:230.72525024414062,z:22.444231510162354},{x:424.0876770019531,y:251.7839241027832,z:51.16771221160889},{x:403.50196838378906,y:239.88757610321045,z:15.803166627883911},{x:397.31719970703125,y:241.49806022644043,z:11.233787536621094},{x:388.99425506591797,y:241.4366912841797,z:7.948269248008728},{x:380.7804489135742,y:239.78078842163086,z:6.600214838981628},{x:374.01336669921875,y:237.11946487426758,z:6.349278092384338},{x:369.39125061035156,y:234.35351371765137,z:5.987462401390076},{x:422.9730987548828,y:255.76455116271973,z:76.61150932312012,name:"faceOval"},{x:374.73915100097656,y:269.24214363098145,z:-16.608498096466064},{x:364.61681365966797,y:245.71088790893555,z:-20.02823829650879},{x:365.3834533691406,y:263.34174156188965,z:-32.32996463775635},{x:361.58252716064453,y:267.8273677825928,z:-30.345816612243652},{x:365.37208557128906,y:265.0249671936035,z:-29.178667068481445},{x:372.72605895996094,y:272.05135345458984,z:-14.834434986114502},{x:360.48614501953125,y:268.34827423095703,z:-32.189905643463135},{x:359.9516296386719,y:270.8049201965332,z:-24.650139808654785},{x:369.5049285888672,y:229.01945114135742,z:10.107489824295044},{x:365.5447769165039,y:230.24096488952637,z:5.593550801277161},{x:363.50669860839844,y:230.6208372116089,z:.43622106313705444},{x:399.3529510498047,y:227.65677452087402,z:15.35965085029602,name:"leftEye"},{x:402.5693130493164,y:224.60190296173096,z:15.931552648544312}],box:{xMin:277.8318977355957,yMin:168.7741756439209,xMax:424.2788314819336,yMax:359.8348903656006,width:146.4469337463379,height:191.0607147216797}},SAMPLE_FACELANDMARKER_RESULT:{faceLandmarks:[[{x:.5760777592658997,y:.8639070391654968,z:-.030997956171631813},{x:.572094738483429,y:.7886289358139038,z:-.07189624011516571},{x:.5723551511764526,y:.8075382709503174,z:-.03578168898820877},{x:.5548420548439026,y:.7188365459442139,z:-.057787876576185226},{x:.5706077814102173,y:.7674974799156189,z:-.07740399986505508},{x:.5681378245353699,y:.7387768030166626,z:-.07356284558773041},{x:.5621535181999207,y:.6681165099143982,z:-.04189874976873398},{x:.46613582968711853,y:.6679812073707581,z:.011289681307971478},{x:.5579932928085327,y:.6174106597900391,z:-.03502821549773216},{x:.5563451647758484,y:.5905600190162659,z:-.03928658738732338},{x:.5487832427024841,y:.4900572597980499,z:-.029898937791585922},{x:.5765544176101685,y:.8692144751548767,z:-.02831427752971649},{x:.5771114230155945,y:.873644232749939,z:-.02345779910683632},{x:.5771905779838562,y:.877016007900238,z:-.016658689826726913},{x:.5778058767318726,y:.8770116567611694,z:-.014505492523312569},{x:.5783766508102417,y:.8835000991821289,z:-.015996402129530907},{x:.5792440176010132,y:.8913810849189758,z:-.01924579218029976},{x:.5796768069267273,y:.8996334671974182,z:-.018261712044477463},{x:.5817288160324097,y:.9255813956260681,z:-.007126849144697189},{x:.5726592540740967,y:.7992473244667053,z:-.0643521398305893},{x:.5579419136047363,y:.7996989488601685,z:-.04566684365272522},{x:.4216199815273285,y:.5958762764930725,z:.06776496022939682},{x:.5052269697189331,y:.6796539425849915,z:-.0010737782577052712},{x:.49243026971817017,y:.6838865876197815,z:-.0005227324436418712},{x:.4796970784664154,y:.6856290102005005,z:.002684245817363262},{x:.4618356227874756,y:.6764569878578186,z:.013439622707664967},{x:.5160380601882935,y:.6737282276153564,z:-17607348127057776e-21},{x:.48070961236953735,y:.6255870461463928,z:-.008339674212038517},{x:.49719780683517456,y:.6256808042526245,z:-.008027955889701843},{x:.46674346923828125,y:.6317623853683472,z:-.004460199736058712},{x:.4582492709159851,y:.641118049621582,z:.0011905613355338573},{x:.45408669114112854,y:.6911458969116211,z:.020514748990535736},{x:.535312294960022,y:.9619986414909363,z:.012499462813138962},{x:.4608460068702698,y:.6628725528717041,z:.01517564244568348},{x:.4206731915473938,y:.6828458309173584,z:.07848648726940155},{x:.4390624463558197,y:.6796106696128845,z:.03283142298460007},{x:.5029968619346619,y:.7701570391654968,z:-.009734481573104858},{x:.5595027208328247,y:.8607323169708252,z:-.030043255537748337},{x:.5621269941329956,y:.8738374710083008,z:-.021709579974412918},{x:.5451499819755554,y:.865527331829071,z:-.022014077752828598},{x:.5351184010505676,y:.8705098032951355,z:-.011602800339460373},{x:.5495014190673828,y:.8744956254959106,z:-.016490943729877472},{x:.5395170450210571,y:.8759440779685974,z:-.007333362940698862},{x:.5183624029159546,y:.8959754705429077,z:.010520773939788342},{x:.5604349374771118,y:.7895449995994568,z:-.07082037627696991},{x:.557381272315979,y:.7687489986419678,z:-.07590588927268982},{x:.4432901442050934,y:.6308897733688354,z:.0027153254486620426},{x:.5258325338363647,y:.7151225805282593,z:-.014676518738269806},{x:.5271827578544617,y:.7833116054534912,z:-.037643320858478546},{x:.5257382988929749,y:.7717816233634949,z:-.03401920944452286},{x:.46516409516334534,y:.7705106735229492,z:.0065747760236263275},{x:.5558893084526062,y:.7420997619628906,z:-.0694495290517807},{x:.4720408320426941,y:.6066038608551025,z:-.021204356104135513},{x:.45432573556900024,y:.6158540844917297,z:-.011054684408009052},{x:.4305151402950287,y:.5608053803443909,z:.0396830290555954},{x:.5310865640640259,y:.6157484650611877,z:-.03081176057457924},{x:.5114666223526001,y:.6329749226570129,z:-.00335998204536736},{x:.506435751914978,y:.8786543607711792,z:.012980876490473747},{x:.4480472207069397,y:.8640613555908203,z:.12569651007652283},{x:.5372058153152466,y:.7942581176757812,z:-.03168361634016037},{x:.5488379597663879,y:.8001630306243896,z:-.03280917927622795},{x:.5213388204574585,y:.8794381618499756,z:.011892606504261494},{x:.5242055654525757,y:.8789222240447998,z:.008370225317776203},{x:.4477175176143646,y:.6039950251579285,z:-.0050799972377717495},{x:.526964008808136,y:.7916748523712158,z:-.02968614175915718},{x:.4971255660057068,y:.6050706505775452,z:-.028175678104162216},{x:.4938119053840637,y:.5882453918457031,z:-.03210941329598427},{x:.4757143557071686,y:.5094879865646362,z:-.01300730835646391},{x:.43947282433509827,y:.5816648006439209,z:.01415177434682846},{x:.485664039850235,y:.5477864146232605,z:-.023685332387685776},{x:.43635931611061096,y:.6226438283920288,z:.013606148771941662},{x:.42910251021385193,y:.6102726459503174,z:.03926564007997513},{x:.5605402588844299,y:.8680099248886108,z:-.027318159118294716},{x:.5474816560745239,y:.8702861070632935,z:-.019686367362737656},{x:.5373021364212036,y:.8728838562965393,z:-.010484928265213966},{x:.540735125541687,y:.7979167103767395,z:-.029073253273963928},{x:.5228585004806519,y:.87913578748703,z:.009915109723806381},{x:.530497670173645,y:.8815253973007202,z:.0020524784922599792},{x:.5259912610054016,y:.8790552616119385,z:.007895970717072487},{x:.5433906316757202,y:.7882310748100281,z:-.05121905356645584},{x:.541388213634491,y:.8777219653129578,z:-.00466804439201951},{x:.5515822172164917,y:.8767023086547852,z:-.010475946590304375},{x:.5637003779411316,y:.877059817314148,z:-.015273625031113625},{x:.5640299320220947,y:.9263423085212708,z:-.00658724969252944},{x:.5642300248146057,y:.8993074893951416,z:-.017653480172157288},{x:.5637336373329163,y:.8910360932350159,z:-.01852807030081749},{x:.5637134313583374,y:.8837276697158813,z:-.01482592523097992},{x:.564205527305603,y:.8768964409828186,z:-.01331155002117157},{x:.5419867634773254,y:.8778373599052429,z:-.0037720394320786},{x:.5404468774795532,y:.880696177482605,z:-.005610354244709015},{x:.5392338633537292,y:.8845721483230591,z:-.007352025713771582},{x:.538469672203064,y:.8891173601150513,z:-.005154991988092661},{x:.5189250111579895,y:.8452741503715515,z:-.009755070321261883},{x:.4258975088596344,y:.7662280797958374,z:.1387351155281067},{x:.5725725293159485,y:.8041572570800781,z:-.04583907872438431},{x:.5342061519622803,y:.8785833120346069,z:.002659974154084921},{x:.5324031114578247,y:.8804071545600891,z:.0017832003068178892},{x:.5538818836212158,y:.8078407645225525,z:-.03254539892077446},{x:.5325431823730469,y:.8026832938194275,z:-.019140373915433884},{x:.5514076948165894,y:.8043903112411499,z:-.03313535451889038},{x:.5131856203079224,y:.7284771800041199,z:-.009399853646755219},{x:.49331504106521606,y:.7443980574607849,z:-.005225230939686298},{x:.5239617824554443,y:.7807451486587524,z:-.025881027802824974},{x:.4473606050014496,y:.5315827131271362,z:.011164786294102669},{x:.45718759298324585,y:.5604941248893738,z:-.005943301599472761},{x:.4670005738735199,y:.5909327268600464,z:-.019681761041283607},{x:.5311570167541504,y:.9076261520385742,z:.00389476353302598},{x:.5249923467636108,y:.5893563628196716,z:-.037981919944286346},{x:.5166932344436646,y:.5429551005363464,z:-.03319704160094261},{x:.5085030198097229,y:.49676206707954407,z:-.02691275253891945},{x:.4687720239162445,y:.6834565997123718,z:.008113506250083447},{x:.4426414966583252,y:.7069531679153442,z:.028577271848917007},{x:.5230373740196228,y:.6675713658332825,z:.001773772411979735},{x:.4481240212917328,y:.6527872085571289,z:.012414850294589996},{x:.5339856743812561,y:.7012367844581604,z:-.020220188423991203},{x:.5347223281860352,y:.7761190533638,z:-.05141595005989075},{x:.4315067231655121,y:.7211957573890686,z:.04381405934691429},{x:.45203351974487305,y:.7206180095672607,z:.017288070172071457},{x:.46892452239990234,y:.7265436053276062,z:.005602988880127668},{x:.49314674735069275,y:.7202282547950745,z:-.0006408205372281373},{x:.5104925632476807,y:.7091827392578125,z:-.00362918758764863},{x:.5232142210006714,y:.698553740978241,z:-.00787867046892643},{x:.5497883558273315,y:.6743605136871338,z:-.036349106580019},{x:.43658503890037537,y:.7627100348472595,z:.042555369436740875},{x:.4397648870944977,y:.6528646349906921,z:.017956094816327095},{x:.5653332471847534,y:.7992802858352661,z:-.06365057826042175},{x:.5285563468933105,y:.736810564994812,z:-.018836988136172295},{x:.4180678725242615,y:.6792560815811157,z:.12284679710865021},{x:.5328429937362671,y:.6865872144699097,z:-.010484723374247551},{x:.5230283141136169,y:.7809416055679321,z:-.011922398582100868},{x:.4551771283149719,y:.6650775074958801,z:.01774493046104908},{x:.5337203741073608,y:.7618928551673889,z:-.04697106033563614},{x:.43463975191116333,y:.8133478164672852,z:.1354849934577942},{x:.5225707292556763,y:.6605283617973328,z:.004980515688657761},{x:.5441933870315552,y:.7497199773788452,z:-.06091512367129326},{x:.4774007797241211,y:.9159183502197266,z:.059622734785079956},{x:.48068761825561523,y:.9364941716194153,z:.08404944837093353},{x:.4268292486667633,y:.7657528519630432,z:.09051097184419632},{x:.46051913499832153,y:.8880485892295837,z:.0738474428653717},{x:.4243420660495758,y:.6434382200241089,z:.06230505183339119},{x:.5342157483100891,y:.9835634231567383,z:.021662971004843712},{x:.5668109655380249,y:.8042187094688416,z:-.044937074184417725},{x:.5176341533660889,y:.7530587315559387,z:-.012967454269528389},{x:.430206298828125,y:.6835605502128601,z:.04612284153699875},{x:.4794231951236725,y:.6732114553451538,z:.003970044665038586},{x:.49073347449302673,y:.6722435355186462,z:.0008692514384165406},{x:.5294116139411926,y:.884677529335022,z:.004413890186697245},{x:.4430122375488281,y:.80235356092453,z:.04987282305955887},{x:.5603825449943542,y:1.0092442035675049,z:.026417359709739685},{x:.5186598300933838,y:.9828659892082214,z:.0513598807156086},{x:.5010536909103394,y:.9640932679176331,z:.06591596454381943},{x:.5524769425392151,y:.539441704750061,z:-.035816047340631485},{x:.5879997611045837,y:1.0091472864151,z:.02285068854689598},{x:.5016193985939026,y:.6684437990188599,z:.00028415941051207483},{x:.511952817440033,y:.6642197370529175,z:.0021144719794392586},{x:.5194343328475952,y:.6623469591140747,z:.004674181342124939},{x:.4321230351924896,y:.6496355533599854,z:.03124697133898735},{x:.508686363697052,y:.6479565501213074,z:-.00044765998609364033},{x:.4963986277580261,y:.6431032419204712,z:-.0032507688738405704},{x:.4845542013645172,y:.6430778503417969,z:-.002903624437749386},{x:.4733612537384033,y:.647506833076477,z:.00023347247042693198},{x:.4668654501438141,y:.653346598148346,z:.004762572236359119},{x:.41815051436424255,y:.633708119392395,z:.09809435904026031},{x:.47159942984580994,y:.6711485385894775,z:.007849935442209244},{x:.5734396576881409,y:.8256140351295471,z:-.03155219927430153},{x:.5306524038314819,y:.8337990641593933,z:-.018351426348090172},{x:.5371729135513306,y:.7910830974578857,z:-.037286680191755295},{x:.5549534559249878,y:.8275275826454163,z:-.030664825811982155},{x:.5597432255744934,y:.6418541669845581,z:-.03318847343325615},{x:.4958484172821045,y:.9429569244384766,z:.048340678215026855},{x:.5140507817268372,y:.9634028077125549,z:.03589847311377525},{x:.5587693452835083,y:.9951097369194031,z:.00908728688955307},{x:.46411189436912537,y:.9051855206489563,z:.10601935535669327},{x:.5181609392166138,y:.6554316878318787,z:.002546071307733655},{x:.5436590909957886,y:.7085841298103333,z:-.03844436630606651},{x:.5872187614440918,y:.9960382580757141,z:.0063423276878893375},{x:.5379653573036194,y:.9989125728607178,z:.03636329993605614},{x:.4350326955318451,y:.8088565468788147,z:.09147704392671585},{x:.5523084998130798,y:.8773422837257385,z:-.009068487212061882},{x:.5510149598121643,y:.8816931843757629,z:-.011043853126466274},{x:.5503793954849243,y:.88776695728302,z:-.01348799467086792},{x:.5501549243927002,y:.8954370617866516,z:-.012142189778387547},{x:.546072781085968,y:.9192524552345276,z:-.003157563041895628},{x:.5314661860466003,y:.8771666884422302,z:.0005075141089037061},{x:.5293324589729309,y:.8762547969818115,z:.00039177737198770046},{x:.5275698900222778,y:.8750609755516052,z:47732755774632096e-21},{x:.5104271173477173,y:.8607332110404968,z:.0012934643309563398},{x:.45938700437545776,y:.8134918212890625,z:.023569690063595772},{x:.5418947339057922,y:.6864100694656372,z:-.027333909645676613},{x:.531914234161377,y:.6456130743026733,z:-.005434140563011169},{x:.523697018623352,y:.647885262966156,z:-.0002466466394253075},{x:.5338191390037537,y:.8783687353134155,z:.002268768846988678},{x:.46226605772972107,y:.8610277771949768,z:.04718952998518944},{x:.5434442758560181,y:.6456181406974792,z:-.02327350154519081},{x:.5399754643440247,y:.940219521522522,z:.005075343884527683},{x:.5661457777023315,y:.71457839012146,z:-.06242101639509201},{x:.5523148775100708,y:.6974870562553406,z:-.04863070324063301},{x:.5639959573745728,y:.6923378109931946,z:-.05180761218070984},{x:.5367592573165894,y:.7423217296600342,z:-.03623027727007866},{x:.5853689908981323,y:.9752064943313599,z:-.002361974213272333},{x:.5835235118865967,y:.9493685960769653,z:-.003941743168979883},{x:.5615018606185913,y:.949194610118866,z:-.0015953965485095978},{x:.5068561434745789,y:.9048219323158264,z:.01862684078514576},{x:.5134067535400391,y:.7971825003623962,z:-.008485661819577217},{x:.5223897099494934,y:.925589919090271,z:.01249657291918993},{x:.48500555753707886,y:.7959478497505188,z:-.0032065745908766985},{x:.5037734508514404,y:.8184596300125122,z:-.004932103678584099},{x:.4766361117362976,y:.828806459903717,z:.01027688942849636},{x:.5589827299118042,y:.974656343460083,z:.0009666886180639267},{x:.5294582843780518,y:.7541216611862183,z:-.025603046640753746},{x:.4973002076148987,y:.9208990931510925,z:.031931452453136444},{x:.5163551568984985,y:.9432790875434875,z:.024321340024471283},{x:.49399662017822266,y:.8814862370491028,z:.018687399104237556},{x:.44948166608810425,y:.836137592792511,z:.05702034756541252},{x:.47898444533348083,y:.8836610913276672,z:.03150695189833641},{x:.4454479217529297,y:.8499438166618347,z:.08868525922298431},{x:.49572959542274475,y:.8452823758125305,z:.0036111653316766024},{x:.5362502336502075,y:.7222585678100586,z:-.027912352234125137},{x:.5393770337104797,y:.7850722074508667,z:-.05415399745106697},{x:.531399667263031,y:.7898418307304382,z:-.03883346915245056},{x:.5451627373695374,y:.7717036604881287,z:-.06480253487825394},{x:.5206395983695984,y:.6287745833396912,z:-.010521138086915016},{x:.4974782466888428,y:.6191938519477844,z:-.014098240062594414},{x:.4774145185947418,y:.6193130612373352,z:-.013643337413668633},{x:.4616098403930664,y:.6259890198707581,z:-.008448202162981033},{x:.4516478478908539,y:.6368461847305298,z:9050309745362028e-20},{x:.4485096037387848,y:.6719120740890503,z:.022984720766544342},{x:.42177659273147583,y:.7240667343139648,z:.08511673659086227},{x:.4616215229034424,y:.6988231539726257,z:.014238474890589714},{x:.4755798876285553,y:.7034608721733093,z:.00625590980052948},{x:.4924992024898529,y:.7005885243415833,z:.0009391739731654525},{x:.5082254409790039,y:.693384051322937,z:-.0009464038303121924},{x:.5203112959861755,y:.6849707961082458,z:-.0022114769089967012},{x:.52867591381073,y:.6779075860977173,z:-.002962538506835699},{x:.4213953912258148,y:.7219811677932739,z:.1350894570350647},{x:.5320829749107361,y:.794858992099762,z:-.03181503340601921},{x:.5452795028686523,y:.7286570072174072,z:-.04771539941430092},{x:.5496407747268677,y:.7866933345794678,z:-.06452003121376038},{x:.557040274143219,y:.7962084412574768,z:-.05837344378232956},{x:.549176812171936,y:.7895247936248779,z:-.057761140167713165},{x:.5362890362739563,y:.8005836606025696,z:-.026903774589300156},{x:.560200035572052,y:.7983731031417847,z:-.06172555685043335},{x:.5616944432258606,y:.8022753596305847,z:-.045200999826192856},{x:.5273328423500061,y:.6611284017562866,z:.0029021520167589188},{x:.534850537776947,y:.6660012006759644,z:-.005215510260313749},{x:.5394860506057739,y:.6701375246047974,z:-.014931917190551758},{x:.4634307324886322,y:.658291757106781,z:.009295716881752014},{x:.4538393020629883,y:.6519932150840759,z:.00930330716073513},{x:.5776031613349915,y:.7159298658370972,z:-.057365912944078445},{x:.6504855155944824,y:.6461779475212097,z:.014184834435582161},{x:.5860154032707214,y:.7962266206741333,z:-.04522843658924103},{x:.6842049360275269,y:.5631637573242188,z:.07207967340946198},{x:.6152560710906982,y:.6674962639808655,z:.0007529259892180562},{x:.6280948519706726,y:.6684326529502869,z:.0016892586136236787},{x:.6408625245094299,y:.6663892269134521,z:.005331226624548435},{x:.6557814478874207,y:.6534678936004639,z:.01646413467824459},{x:.6035663485527039,y:.6639701724052429,z:.0013799630105495453},{x:.6329053044319153,y:.608010470867157,z:-.006195899099111557},{x:.6167260408401489,y:.6117533445358276,z:-.006319951266050339},{x:.6471013426780701,y:.6112449765205383,z:-.0017843559617176652},{x:.6560901999473572,y:.6185776591300964,z:.004047257360070944},{x:.6666946411132812,y:.6651176810264587,z:.023647578433156013},{x:.6311345100402832,y:.9495396018028259,z:.014004078693687916},{x:.6544655561447144,y:.6397901773452759,z:.01809609681367874},{x:.6965808868408203,y:.6482675075531006,z:.08304904401302338},{x:.679817259311676,y:.650188148021698,z:.03632688894867897},{x:.6336516737937927,y:.7541458010673523,z:-.007742783520370722},{x:.5921701192855835,y:.8567668199539185,z:-.029399123042821884},{x:.591663658618927,y:.870215654373169,z:-.02103729173541069},{x:.6068367958068848,y:.8584195375442505,z:-.020668085664510727},{x:.6176617741584778,y:.860965371131897,z:-.009790095500648022},{x:.6040634512901306,y:.8686612844467163,z:-.015289564616978168},{x:.6143736839294434,y:.8671170473098755,z:-.005712216719985008},{x:.6373105049133301,y:.8815656900405884,z:.012672550976276398},{x:.5832505822181702,y:.7866312861442566,z:-.07051534950733185},{x:.5836675763130188,y:.7658692598342896,z:-.07566110789775848},{x:.6709531545639038,y:.604898989200592,z:.005951565690338612},{x:.6029891967773438,y:.705652117729187,z:-.013388276100158691},{x:.6131622195243835,y:.7728396058082581,z:-.036248479038476944},{x:.6123163104057312,y:.7612020373344421,z:-.03264721855521202},{x:.6696187853813171,y:.744706928730011,z:.009673702530562878},{x:.5803102254867554,y:.7385968565940857,z:-.0689152330160141},{x:.6404349207878113,y:.5877999663352966,z:-.01929756999015808},{x:.6588467955589294,y:.5929454565048218,z:-.008487257175147533},{x:.6720337867736816,y:.530631422996521,z:.043437421321868896},{x:.584305465221405,y:.6099005341529846,z:-.030301367864012718},{x:.6034283638000488,y:.6217452883720398,z:-.001970183802768588},{x:.6460927724838257,y:.8608663082122803,z:.015541625209152699},{x:.6957815289497375,y:.8326103091239929,z:.13015234470367432},{x:.6043362617492676,y:.7861682772636414,z:-.030476901680231094},{x:.594293475151062,y:.7942103147506714,z:-.032218821346759796},{x:.6324057579040527,y:.8665139675140381,z:.014255806803703308},{x:.6296147704124451,y:.8667733669281006,z:.010388285852968693},{x:.663644552230835,y:.5798642635345459,z:-.0022301070857793093},{x:.6140630841255188,y:.7809288501739502,z:-.02835679054260254},{x:.615908145904541,y:.5921698212623596,z:-.026804860681295395},{x:.617181122303009,y:.5748661756515503,z:-.03060605563223362},{x:.6222207546234131,y:.49137672781944275,z:-.011151673272252083},{x:.6669357419013977,y:.5541607141494751,z:.017466170713305473},{x:.6182981729507446,y:.5320425629615784,z:-.021793590858578682},{x:.6760554313659668,y:.595052182674408,z:.017115700989961624},{x:.6801463961601257,y:.5800720453262329,z:.043127160519361496},{x:.5922210812568665,y:.8644017577171326,z:-.02662893570959568},{x:.6054555177688599,y:.8637874722480774,z:-.018363753333687782},{x:.6161889433860779,y:.8641164898872375,z:-.008808949030935764},{x:.6017249822616577,y:.7901403307914734,z:-.028126630932092667},{x:.631446123123169,y:.8664817810058594,z:.012112865224480629},{x:.6249198913574219,y:.8716511130332947,z:.003882825840264559},{x:.6281915903091431,y:.867301881313324,z:.009891441091895103},{x:.5986843109130859,y:.7813931703567505,z:-.050227612257003784},{x:.6126407384872437,y:.869275689125061,z:-.0031255714129656553},{x:.6027271151542664,y:.8711842894554138,z:-.009324162267148495},{x:.59088134765625,y:.8742044568061829,z:-.014608660712838173},{x:.5984604358673096,y:.9216185212135315,z:-.005981989670544863},{x:.5950398445129395,y:.8964707255363464,z:-.01703473925590515},{x:.5941568613052368,y:.8882410526275635,z:-.017784785479307175},{x:.5928806662559509,y:.8803883194923401,z:-.014153128489851952},{x:.5909661054611206,y:.8748103976249695,z:-.012609979137778282},{x:.6128016710281372,y:.8702545762062073,z:-.0022550546564161777},{x:.6150846481323242,y:.8726804256439209,z:-.00414019962772727},{x:.6173093914985657,y:.8770190477371216,z:-.005970994010567665},{x:.619335412979126,y:.8814800977706909,z:-.0036864024586975574},{x:.6292637586593628,y:.8314558267593384,z:-.007714875973761082},{x:.702275276184082,y:.7320667505264282,z:.1433621346950531},{x:.6204835176467896,y:.8689177632331848,z:.0044869170524179935},{x:.6223508715629578,y:.8704851269721985,z:.00352082890458405},{x:.590448260307312,y:.8029727935791016,z:-.03200828656554222},{x:.6097423434257507,y:.7933741211891174,z:-.018042555078864098},{x:.59229576587677,y:.7993767261505127,z:-.032564569264650345},{x:.6171364188194275,y:.7153720259666443,z:-.007672437466681004},{x:.6389747858047485,y:.726390540599823,z:-.002999067772179842},{x:.6151940226554871,y:.769412100315094,z:-.024427521973848343},{x:.6526776552200317,y:.505868136882782,z:.01412637997418642},{x:.6475822329521179,y:.5375454425811768,z:-.0033899128902703524},{x:.6433356404304504,y:.5714520215988159,z:-.017428796738386154},{x:.626949667930603,y:.8962116837501526,z:.005602736957371235},{x:.5868416428565979,y:.5829002261161804,z:-.03727729618549347},{x:.5877229571342468,y:.5345035791397095,z:-.032396964728832245},{x:.5887066125869751,y:.48655083775520325,z:-.025856535881757736},{x:.6507197618484497,y:.6612282991409302,z:.011114613153040409},{x:.6803066730499268,y:.677992045879364,z:.032125361263751984},{x:.5963194370269775,y:.6598632335662842,z:.002976928371936083},{x:.667536199092865,y:.6274255514144897,z:.015618261881172657},{x:.5930740833282471,y:.6940041780471802,z:-.019217798486351967},{x:.6053346395492554,y:.7676517963409424,z:-.050308309495449066},{x:.6934473514556885,y:.6884298920631409,z:.04794462397694588},{x:.6738007664680481,y:.6934011578559875,z:.020697161555290222},{x:.6588084697723389,y:.7033141851425171,z:.008462334051728249},{x:.6346072554588318,y:.7029502391815186,z:.001542167621664703},{x:.6157816648483276,y:.6966525912284851,z:-.002009218093007803},{x:.6015574336051941,y:.688928484916687,z:-.006588225718587637},{x:.5746836066246033,y:.6711069345474243,z:-.03597589209675789},{x:.6947521567344666,y:.7309479117393494,z:.046707939356565475},{x:.6759101152420044,y:.6249120831489563,z:.021654341369867325},{x:.5794773101806641,y:.7971615195274353,z:-.06339326500892639},{x:.6041849851608276,y:.727514922618866,z:-.017512541264295578},{x:.6968844532966614,y:.6440950036048889,z:.12727996706962585},{x:.5910853147506714,y:.679325520992279,z:-.009497715160250664},{x:.6157375574111938,y:.7695677280426025,z:-.010624290443956852},{x:.6606494784355164,y:.6410489678382874,z:.0208158977329731},{x:.6040687561035156,y:.7531470656394958,z:-.045887019485235214},{x:.7012156248092651,y:.780247151851654,z:.14028730988502502},{x:.595149576663971,y:.6527782678604126,z:.006308757700026035},{x:.5925500392913818,y:.7436665892601013,z:-.060151755809783936},{x:.6780198812484741,y:.8905693888664246,z:.0626060739159584},{x:.676746666431427,y:.9113880395889282,z:.08726003766059875},{x:.7030686140060425,y:.7312687635421753,z:.09529774636030197},{x:.688987135887146,y:.8588417172431946,z:.07752864807844162},{x:.6883691549301147,y:.6109960675239563,z:.06669612973928452},{x:.6358906030654907,y:.9702065587043762,z:.023120900616049767},{x:.5781539678573608,y:.8023634552955627,z:-.044763918966054916},{x:.6170316934585571,y:.7408350706100464,z:-.011375460773706436},{x:.688542366027832,y:.6516284346580505,z:.050206027925014496},{x:.6385149359703064,y:.6540714502334595,z:.006462941411882639},{x:.6279382109642029,y:.6563615798950195,z:.003062846139073372},{x:.6268895268440247,y:.8736732006072998,z:.00627936702221632},{x:.6944946050643921,y:.7709181308746338,z:.053824134171009064},{x:.614617109298706,y:1.0022112131118774,z:.02719894051551819},{x:.6493719220161438,y:.9665167927742004,z:.053563784807920456},{x:.6624587178230286,y:.943530797958374,z:.068605437874794},{x:.6162528991699219,y:.6558693051338196,z:.002187855076044798},{x:.6058168411254883,y:.654328465461731,z:.0036193584091961384},{x:.5987918972969055,y:.6536934971809387,z:.006134530063718557},{x:.6831037402153015,y:.6195642948150635,z:.03511790186166763},{x:.6062582731246948,y:.6356398463249207,z:.001280312892049551},{x:.6174948811531067,y:.62776118516922,z:-.0013642468256875873},{x:.6297246217727661,y:.6253792643547058,z:-.0007034156005829573},{x:.6407091617584229,y:.627578616142273,z:.0028144705574959517},{x:.6479622721672058,y:.6322650909423828,z:.00750273372977972},{x:.6915091276168823,y:.5990704298019409,z:.10270945727825165},{x:.6457163095474243,y:.6504453420639038,z:.010696077719330788},{x:.6164222955703735,y:.8231936097145081,z:-.016772059723734856},{x:.6042401194572449,y:.7830976843833923,z:-.03630910441279411},{x:.5922216773033142,y:.8228387236595154,z:-.029992375522851944},{x:.6646111011505127,y:.92097008228302,z:.050967294722795486},{x:.651232898235321,y:.9460107088088989,z:.038000158965587616},{x:.6140977144241333,y:.9882472157478333,z:.009882091544568539},{x:.6870781183242798,y:.8768675327301025,z:.10980932414531708},{x:.5986856818199158,y:.6456438899040222,z:.003999010659754276},{x:.585981547832489,y:.7034481763839722,z:-.0377722829580307},{x:.6342031359672546,y:.9867448806762695,z:.03786521404981613},{x:.7013950943946838,y:.776049017906189,z:.09598205983638763},{x:.6030206680297852,y:.8719133138656616,z:-.007931148633360863},{x:.6050592064857483,y:.8767156004905701,z:-.009791925549507141},{x:.6073468923568726,y:.8831382393836975,z:-.012361008673906326},{x:.6087977290153503,y:.890143632888794,z:-.01098148338496685},{x:.6147705316543579,y:.9110084772109985,z:-.0018823575228452682},{x:.622577965259552,y:.8670604825019836,z:.002609190298244357},{x:.6241236329078674,y:.8651344180107117,z:.0025534380692988634},{x:.6257084608078003,y:.8638408184051514,z:.0023300074972212315},{x:.639931321144104,y:.8449671268463135,z:.0038123116828501225},{x:.6810906529426575,y:.7856625318527222,z:.02717764675617218},{x:.583532452583313,y:.6811994910240173,z:-.026588857173919678},{x:.5855660438537598,y:.6393819451332092,z:-.004512844607234001},{x:.5932201743125916,y:.6398029327392578,z:.0008020466193556786},{x:.6200879812240601,y:.8683351874351501,z:.00417016725987196},{x:.6842559576034546,y:.8330534100532532,z:.050836317241191864},{x:.5754412412643433,y:.6418221592903137,z:-.022838059812784195},{x:.6232790350914001,y:.9295297265052795,z:.006339520215988159},{x:.5764067769050598,y:.694546639919281,z:-.04825803264975548},{x:.59778892993927,y:.7343927621841431,z:-.035004377365112305},{x:.6042810678482056,y:.9441440105438232,z:-.0010970570147037506},{x:.6496372222900391,y:.8869078159332275,z:.021036235615611076},{x:.6274012327194214,y:.7830310463905334,z:-.006658440921455622},{x:.637792706489563,y:.9104999899864197,z:.014290250837802887},{x:.6549934148788452,y:.7748609185218811,z:-.0006672973395325243},{x:.6404005289077759,y:.801220715045929,z:-.0026642554439604282},{x:.6671456694602966,y:.8045546412467957,z:.013180811889469624},{x:.6107483506202698,y:.9680658578872681,z:.001778992242179811},{x:.6060343980789185,y:.744587242603302,z:-.024382334202528},{x:.6602751612663269,y:.8998945355415344,z:.0344940721988678},{x:.6463775038719177,y:.9262562394142151,z:.02617623284459114},{x:.6579852104187012,y:.8602304458618164,z:.021586716175079346},{x:.6926165223121643,y:.8053340315818787,z:.061075080186128616},{x:.6724731922149658,y:.8594399690628052,z:.03457934781908989},{x:.6975721716880798,y:.8183245062828064,z:.09300774335861206},{x:.6512877941131592,y:.8258221745491028,z:.006324059329926968},{x:.594887375831604,y:.7148372530937195,z:-.026898479089140892},{x:.6017440557479858,y:.7773507833480835,z:-.05312420800328255},{x:.6096571683883667,y:.7806998491287231,z:-.037646256387233734},{x:.5952993035316467,y:.7654367685317993,z:-.06398405134677887},{x:.5950021147727966,y:.6201304793357849,z:-.009297547861933708},{x:.6165438890457153,y:.6052900552749634,z:-.012455573305487633},{x:.6362661719322205,y:.6015968918800354,z:-.011649220250546932},{x:.6522727608680725,y:.6046400666236877,z:-.005903332494199276},{x:.6625409722328186,y:.6128141283988953,z:.0030042496509850025},{x:.6688099503517151,y:.6457712054252625,z:.026322703808546066},{x:.7013440728187561,y:.6893666386604309,z:.08984331786632538},{x:.6608623266220093,y:.6749406456947327,z:.0172116681933403},{x:.6482325196266174,y:.6823726296424866,z:.008881398476660252},{x:.6313265562057495,y:.6842025518417358,z:.0031308617908507586},{x:.6147016286849976,y:.6809731721878052,z:.0007630771724507213},{x:.6018834114074707,y:.6755372285842896,z:-.0008834321051836014},{x:.5925027132034302,y:.670681357383728,z:-.001968748401850462},{x:.700127363204956,y:.6871103644371033,z:.13980500400066376},{x:.6095665693283081,y:.7853189706802368,z:-.03074747882783413},{x:.5880423784255981,y:.7229287028312683,z:-.04691500961780548},{x:.5930182337760925,y:.7811514139175415,z:-.06398335844278336},{x:.5867722034454346,y:.7922660112380981,z:-.05794971063733101},{x:.5933279991149902,y:.7842848896980286,z:-.05714067071676254},{x:.6063535809516907,y:.7920218706130981,z:-.02590685710310936},{x:.5839452743530273,y:.794978141784668,z:-.0615212507545948},{x:.5828126072883606,y:.8000800013542175,z:-.0449722595512867},{x:.5909603834152222,y:.6541213393211365,z:.003991890233010054},{x:.5852181911468506,y:.6602938771247864,z:-.004428438376635313},{x:.5825737714767456,y:.6651063561439514,z:-.014345290139317513},{x:.6517343521118164,y:.6362385153770447,z:.012151890434324741},{x:.6615052819252014,y:.6281577944755554,z:.0123682152479887},{x:.4856873154640198,y:.6568945646286011,z:.000720038078725338},{x:.49988406896591187,y:.6547410488128662,z:.0006949726957827806},{x:.48438939452171326,y:.6392973065376282,z:.000705525919329375},{x:.47143134474754333,y:.6589511632919312,z:.0006980331381782889},{x:.48704618215560913,y:.6752797961235046,z:.0006921177846379578},{x:.6243702173233032,y:.640461802482605,z:-6592126737814397e-20},{x:.6390967965126038,y:.6385173797607422,z:-.00016105435497593135},{x:.6230536699295044,y:.6224825382232666,z:-.00016136496560648084},{x:.6095397472381592,y:.641917884349823,z:-.0001803556369850412},{x:.6250996589660645,y:.6586247682571411,z:-.0001785515050869435}]],faceBlendshapes:[{categories:[{index:0,score:5187174338061595e-21,categoryName:"_neutral",displayName:""},{index:1,score:.24521504342556,categoryName:"browDownLeft",displayName:""},{index:2,score:.1987743377685547,categoryName:"browDownRight",displayName:""},{index:3,score:.013400448486208916,categoryName:"browInnerUp",displayName:""},{index:4,score:.012361560948193073,categoryName:"browOuterUpLeft",displayName:""},{index:5,score:.019305096939206123,categoryName:"browOuterUpRight",displayName:""},{index:6,score:28426356948330067e-21,categoryName:"cheekPuff",displayName:""},{index:7,score:34500112633395474e-23,categoryName:"cheekSquintLeft",displayName:""},{index:8,score:483789051486383e-21,categoryName:"cheekSquintRight",displayName:""},{index:9,score:.07650448381900787,categoryName:"eyeBlinkLeft",displayName:""},{index:10,score:.05070012807846069,categoryName:"eyeBlinkRight",displayName:""},{index:11,score:.13978900015354156,categoryName:"eyeLookDownLeft",displayName:""},{index:12,score:.14198613166809082,categoryName:"eyeLookDownRight",displayName:""},{index:13,score:.2177766114473343,categoryName:"eyeLookInLeft",displayName:""},{index:14,score:.014739357866346836,categoryName:"eyeLookInRight",displayName:""},{index:15,score:.02361512929201126,categoryName:"eyeLookOutLeft",displayName:""},{index:16,score:.19679604470729828,categoryName:"eyeLookOutRight",displayName:""},{index:17,score:.04874616861343384,categoryName:"eyeLookUpLeft",displayName:""},{index:18,score:.049392376095056534,categoryName:"eyeLookUpRight",displayName:""},{index:19,score:.34944331645965576,categoryName:"eyeSquintLeft",displayName:""},{index:20,score:.2939716875553131,categoryName:"eyeSquintRight",displayName:""},{index:21,score:.005955042317509651,categoryName:"eyeWideLeft",displayName:""},{index:22,score:.006776117719709873,categoryName:"eyeWideRight",displayName:""},{index:23,score:16942436559475027e-21,categoryName:"jawForward",displayName:""},{index:24,score:.0045165494084358215,categoryName:"jawLeft",displayName:""},{index:25,score:.07803940027952194,categoryName:"jawOpen",displayName:""},{index:26,score:2090057751047425e-20,categoryName:"jawRight",displayName:""},{index:27,score:.06032035872340202,categoryName:"mouthClose",displayName:""},{index:28,score:.00228882092051208,categoryName:"mouthDimpleLeft",displayName:""},{index:29,score:.00781762320548296,categoryName:"mouthDimpleRight",displayName:""},{index:30,score:.0017093931091949344,categoryName:"mouthFrownLeft",displayName:""},{index:31,score:.0019319106359034777,categoryName:"mouthFrownRight",displayName:""},{index:32,score:8485237776767462e-20,categoryName:"mouthFunnel",displayName:""},{index:33,score:.0009051355300471187,categoryName:"mouthLeft",displayName:""},{index:34,score:.0003630454302765429,categoryName:"mouthLowerDownLeft",displayName:""},{index:35,score:.00017601238505449146,categoryName:"mouthLowerDownRight",displayName:""},{index:36,score:.12865161895751953,categoryName:"mouthPressLeft",displayName:""},{index:37,score:.20137207210063934,categoryName:"mouthPressRight",displayName:""},{index:38,score:.0022203284315764904,categoryName:"mouthPucker",displayName:""},{index:39,score:.0009096377179957926,categoryName:"mouthRight",displayName:""},{index:40,score:.34189721941947937,categoryName:"mouthRollLower",displayName:""},{index:41,score:.11409689486026764,categoryName:"mouthRollUpper",displayName:""},{index:42,score:.17172536253929138,categoryName:"mouthShrugLower",displayName:""},{index:43,score:.004038424696773291,categoryName:"mouthShrugUpper",displayName:""},{index:44,score:.00023205230536404997,categoryName:"mouthSmileLeft",displayName:""},{index:45,score:.00019313619122840464,categoryName:"mouthSmileRight",displayName:""},{index:46,score:.0018571305554360151,categoryName:"mouthStretchLeft",displayName:""},{index:47,score:.0023813238367438316,categoryName:"mouthStretchRight",displayName:""},{index:48,score:24323100660694763e-21,categoryName:"mouthUpperUpLeft",displayName:""},{index:49,score:3161552012898028e-20,categoryName:"mouthUpperUpRight",displayName:""},{index:50,score:108198406678639e-21,categoryName:"noseSneerLeft",displayName:""},{index:51,score:12652527630052646e-22,categoryName:"noseSneerRight",displayName:""}],headIndex:-1,headName:""}],facialTransformationMatrixes:[{rows:4,columns:4,data:[.9947517514228821,.10230544209480286,.0013679931871592999,0,-.10230997204780579,.9947447776794434,.003816320328041911,0,-.000970348424743861,-.0039362297393381596,.9999914169311523,0,2.8888821601867676,-7.808934211730957,-30.52109146118164,1]}]}},Tp=d.createContext({}),ml={basePath:"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm",options:{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},runningMode:"VIDEO",outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}},U9=d.forwardRef(({basePath:s=ml.basePath,options:e=ml.options,children:t},i)=>{const n=JSON.stringify(e),r=Gt(async()=>{const{FilesetResolver:o,FaceLandmarker:a}=await Ml(async()=>{const{FilesetResolver:l,FaceLandmarker:u}=await import("./chunk-DX0dWqEa.js");return{FilesetResolver:l,FaceLandmarker:u}},[]),c=await o.forVisionTasks(s);return a.createFromOptions(c,e)},[s,n]);return d.useEffect(()=>()=>{r?.close(),wl([s,n])},[r,s,n]),d.useImperativeHandle(i,()=>r,[r]),d.createElement(Tp.Provider,{value:r},t)});function bp(){return d.useContext(Tp)}function td(s,e){return s.clone().add(e).multiplyScalar(.5)}function xn(s,e,t){const i=s.localToWorld(e);return t.worldToLocal(i)}const Cp=d.createContext({}),z9=d.forwardRef(({camera:s,videoTexture:e={start:!0},manualDetect:t=!1,faceLandmarkerResult:i,manualUpdate:n=!1,makeDefault:r,smoothTime:o=.25,offset:a=!0,offsetScalar:c=80,eyes:l=!1,eyesAsOrigin:u=!0,depth:h=.15,debug:f=!1,facemesh:m},p)=>{var g,y;const v=H(Q=>Q.scene),E=H(Q=>Q.camera),x=H(Q=>Q.set),T=H(Q=>Q.get),A=s||E,C=d.useRef(null),[b]=d.useState(()=>new Ve),[R]=d.useState(()=>new _),[I]=d.useState(()=>new _),[w]=d.useState(()=>new _),[M]=d.useState(()=>new _),P=d.useCallback(()=>{b.parent=A.parent;const Q=C.current;if(Q){const{outerRef:ne,eyeRightRef:he,eyeLeftRef:xe}=Q;if(he.current&&xe.current){const{irisDirRef:ce}=he.current,{irisDirRef:Ee}=xe.current;ce.current&&Ee.current&&ne.current&&(R.copy(xn(ce.current,new _(0,0,0),ne.current)),I.copy(xn(Ee.current,new _(0,0,0),ne.current)),b.position.copy(xn(ne.current,td(R,I),A.parent||v)),w.copy(xn(ce.current,new _(0,0,1),ne.current)),M.copy(xn(Ee.current,new _(0,0,1),ne.current)),b.lookAt(ne.current.localToWorld(td(w,M))))}else ne.current&&(b.position.copy(xn(ne.current,new _(0,0,0),A.parent||v)),b.lookAt(ne.current.localToWorld(new _(0,0,1))))}return b},[A,I,M,R,w,v,b]),[O]=d.useState(()=>new Ve),z=d.useCallback(function(Q,ne){if(A){var he;(he=ne)!==null&&he!==void 0||(ne=P()),o>0?(Mi.damp3(O.position,ne.position,o,Q,void 0,void 0,1e-9),Mi.dampE(O.rotation,ne.rotation,o,Q,void 0,void 0,1e-9)):(O.position.copy(ne.position),O.rotation.copy(ne.rotation)),A.position.copy(O.position),A.rotation.copy(O.rotation)}},[A,P,o,O.position,O.rotation]);ee((Q,ne)=>{n||z(ne)});const D=d.useRef(null),[F,k]=d.useState(),$=bp(),U=d.useCallback((Q,ne)=>{const he=D.current;if(!he)return;const xe=he.source.data,ce=$?.detectForVideo(xe,Q);k(ce)},[$]),N=d.useMemo(()=>Object.assign(Object.create(p1.prototype),{computeTarget:P,update:z,facemeshApiRef:C}),[P,z]);d.useImperativeHandle(p,()=>N,[N]),d.useEffect(()=>{if(r){const Q=T().controls;return x({controls:N}),()=>x({controls:Q})}},[r,N,T,x]);const B=i??F,G=B?.faceLandmarks[0],j=B==null||(g=B.facialTransformationMatrixes)==null?void 0:g[0],L=B==null||(y=B.faceBlendshapes)==null?void 0:y[0],X={onVideoFrame:U,...e};return d.createElement(Cp.Provider,{value:N},!t&&d.createElement(d.Suspense,{fallback:null},"src"in X?d.createElement(co,Z({ref:D},X)):d.createElement(Ap,Z({ref:D},X))),d.createElement(Sp,Z({ref:C,children:d.createElement("meshNormalMaterial",{side:dt})},m,{points:G,depth:h,facialTransformationMatrix:j,faceBlendshapes:L,eyes:l,eyesAsOrigin:u,offset:a,offsetScalar:c,debug:f,"rotation-z":Math.PI,visible:f})))}),G9=()=>d.useContext(Cp),fT=Object.freeze(Object.defineProperty({__proto__:null,AccumulativeShadows:Ym,AdaptiveDpr:s9,AdaptiveEvents:r9,ArcballControls:u5,AsciiRenderer:WE,BBAnchor:t6,Backdrop:u8,BakeShadows:i9,Billboard:Sm,Bounds:Wm,Box:I6,Bvh:j5,CameraControls:m5,CameraControlsImpl:Ef,CameraShake:e8,Capsule:V6,CatmullRomLine:bE,Caustics:A1,Center:Rl,Circle:_6,Clone:ys,Cloud:C8,CloudInstance:dl,Clouds:Zm,ComputedAttribute:NE,Cone:L6,ContactShadows:ff,CubeCamera:s5,CubeTexture:M5,CubicBezierLine:TE,CurveModifier:u6,CycleRaycast:V4,Cylinder:P6,Decal:KE,Detailed:e9,DetectGPU:K5,DeviceOrientationControls:r5,Dodecahedron:$6,DragControls:Z4,Edges:S1,Effects:IE,Environment:mf,EnvironmentCube:T1,EnvironmentMap:b1,EnvironmentPortal:C1,Example:o6,Extrude:H6,FaceControls:z9,FaceLandmarker:U9,FaceLandmarkerDefaults:ml,Facemesh:Sp,FacemeshDatas:Mr,FacemeshEye:fl,FacemeshEyeDefaults:Tn,Fbo:R1,Fbx:D5,FirstPersonControls:f5,Fisheye:d9,Float:t8,FlyControls:o5,GizmoHelper:A5,GizmoViewcube:I5,GizmoViewport:_5,Gltf:jE,GradientTexture:_E,GradientType:hl,Grid:P5,Helper:w1,Html:Es,Hud:Dm,Icosahedron:z6,Image:DE,Instance:hf,InstancedAttribute:I1,Instances:uf,IsObject:In,KeyboardControls:aE,Ktx2:B5,Lathe:K6,Lightformer:_1,Line:ei,Loader:J4,MapControls:a5,MarchingCube:GE,MarchingCubes:zE,MarchingPlane:$E,Mask:u9,MatcapTexture:M8,Merged:L1,MeshDiscardMaterial:T6,MeshDistortMaterial:f6,MeshPortalMaterial:p9,MeshReflectorMaterial:x6,MeshRefractionMaterial:S6,MeshTransmissionMaterial:P1,MeshWobbleMaterial:p6,MotionPathControls:y5,MultiMaterial:b6,NormalTexture:F8,Octahedron:G6,OrbitControls:l5,OrthographicCamera:_m,Outlines:BE,PerformanceMonitor:o9,PerspectiveCamera:n5,PivotControls:B9,Plane:D6,Point:Q8,PointMaterial:C6,PointMaterialImpl:Km,PointerLockControls:d5,Points:J8,PointsBuffer:cp,Polyhedron:U6,PositionMesh:M1,PositionPoint:ap,PositionalAudio:CE,Preload:t9,PresentationControls:sE,Progress:Y4,QuadraticBezierLine:SE,RandomizedLight:Qm,RenderCubeTexture:mp,RenderTexture:fp,Resize:J6,Ring:N6,RoundedBox:X6,RoundedBoxGeometry:Vm,Sampler:OE,ScreenQuad:Q6,ScreenSizer:EE,ScreenSpace:fE,ScreenVideoTexture:F9,Scroll:nE,ScrollControls:eE,Segment:Z8,SegmentObject:hp,Segments:q8,Select:hE,Shadow:h8,ShadowAlpha:W8,Shape:j6,Sky:E8,SoftShadows:w6,Sparkles:I8,Sphere:M6,Splat:e5,SpotLight:x8,SpotLightShadow:v8,SpriteAnimator:c6,Stage:l8,Stars:T8,Stats:U5,StatsGl:z5,Svg:VE,Tetrahedron:O6,Text:RE,Text3D:cf,Texture:LE,Torus:F6,TorusKnot:k6,TrackballControls:c5,Trail:kE,TrailTexture:r6,TransformControls:h5,Tube:B6,VideoTexture:co,View:C9,WebcamVideoTexture:Ap,Wireframe:j8,accumulativeContext:cc,calcPosFromAngles:qm,calculateScaleFactor:ro,checkIfFrameIsEmpty:Um,createInstances:D1,getFirstFrame:cs,isWebGL2Available:wE,meshBounds:n9,shaderMaterial:xi,useAnimations:X5,useAspect:$5,useBVH:V5,useBounds:Xm,useBoxProjectedEnv:e6,useCamera:H5,useContextBridge:W5,useCubeCamera:Lm,useCubeTexture:lc,useCursor:j4,useDepthBuffer:G5,useDetectGPU:zm,useEnvironment:B1,useFBO:Di,useFBX:ao,useFaceControls:G9,useFaceLandmarker:bp,useFont:F1,useGLTF:As,useGizmoContext:oo,useHelper:k1,useIntersect:Gm,useKTX2:lo,useKeyboardControls:lE,useMask:h9,useMatcapTexture:np,useMotion:Mm,useNormalTexture:sp,usePerformanceMonitor:a9,useProgress:sc,useScroll:oc,useSelect:dE,useSpriteAnimator:a6,useSpriteLoader:uo,useSurfaceSampler:Rm,useTexture:Oi,useTrail:Cm,useTrailTexture:$m,useVideoTexture:Nm},Symbol.toStringTag,{value:"Module"})),$9=.05,id=.1;function Rp(s,e,t){const i=e.gamepad;if(i==null)return;const n=t.components;for(const r in n){let o=s[r];o==null&&(s[r]=o={});const{gamepadIndices:a}=n[r];let c=!1,l=!1;if(a.button!=null&&a.button<i.buttons.length){const u=i.buttons[a.button];o.button=Sr(u.value,0,1),c||=u.pressed||o.button===1,l||=u.touched||o.button>$9}a.xAxis!=null&&a.xAxis<i.axes.length&&(o.xAxis=Sr(i.axes[a.xAxis],-1,1),l||=Math.abs(o.xAxis)>id),a.yAxis!=null&&a.yAxis<i.axes.length&&(o.yAxis=Sr(i.axes[a.yAxis],-1,1),l||=Math.abs(o.yAxis)>id),o.state=c?"pressed":l?"touched":"default"}}function H9(s){return{data:new Float32Array(s.size*16)}}function K9(s,e,t,i,n){const r=i.getReferenceSpace();r==null||e==null||e.session.visibilityState==="visible-blurred"||e.session.visibilityState==="hidden"||V9(e,r,t,s.data)}const Ia=new re,_a=new re;function V9(s,e,t,i){if(!s.fillPoses(t.values(),e,i))return!1;Ia.fromArray(i,0),Ia.invert();for(let r=0;r<i.length;r+=16)_a.fromArray(i,r),_a.premultiply(Ia),_a.toArray(i,r);return!0}const j9="generic-hand";function W9(s,e){const t=e?.baseAssetPath??qp,i=e?.defaultXRHandProfileId??j9;return new URL(`${i}/${s}.glb`,t).href}function X9({scene:s}){const e=u2(s),t=e.getObjectByProperty("type","SkinnedMesh");if(t==null)throw new Error("missing SkinnedMesh in loaded XRHand model");return t.frustumCulled=!1,e}function Y9(s,e){s.renderOrder=e?.renderOrder??0,s.traverse(t=>{t instanceof oe&&t.material instanceof af&&(t.material.colorWrite=e?.colorWrite??!0)})}function Q9(s,e,t,i,n){return{id:s,isPrimary:n,type:"hand",inputSource:e,pose:H9(e.hand),assetPath:W9(e.handedness,t),events:i}}function J9({inputSource:s,pose:e},t,i){K9(e,t,s.hand,i,s.handedness)}const q9=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"];function Z9(s,e,t){const i=new Float32Array(s.size*16),n=q9.map(r=>{const o=e.getObjectByName(r);if(o==null)throw new Error(`missing joint "${r}" in hand model`);return o.matrixAutoUpdate=!1,o});return r=>{const o=typeof t=="function"?t():t;if(r==null||o==null)return;r.fillPoses(s.values(),o,i);const a=n.length;for(let c=0;c<a;c++)n[c].matrix.fromArray(i,c*16)}}function wp(s){return s!=null&&typeof s=="object"&&"inputSource"in s}function eA(s,e){const t=i=>e.push(i);return s.addEventListener("selectstart",t),s.addEventListener("selectend",t),s.addEventListener("select",t),s.addEventListener("squeeze",t),s.addEventListener("squeezestart",t),s.addEventListener("squeezeend",t),()=>{s.removeEventListener("selectstart",t),s.removeEventListener("selectend",t),s.removeEventListener("select",t),s.removeEventListener("squeeze",t),s.removeEventListener("squeezestart",t),s.removeEventListener("squeezeend",t)}}let tA=0;function iA(s,e){const t=new Map,i=new Zp(e),n=new Map;return(r,o,a)=>{if(a==="remove-all"){for(const l of t.values())l();return o}const c=[...o];for(const{added:l,isPrimary:u,removed:h}of a){if(h!=null)for(const f of h){const m=c.findIndex(({inputSource:p,isPrimary:g})=>g===u&&p===f);m!==-1&&(c.splice(m,1),t.get(f)?.(),t.delete(f))}if(l!=null)for(const f of l){const m=[];let p=eA(r,m);const g=`${f.handedness}-${f.hand?"hand":"nohand"}-${f.targetRayMode}-${f.profiles.join(",")}`;let y;if((y=n.get(g))==null&&n.set(g,y=`${tA++}`),f.hand!=null)c.push(Q9(y,f,e,m,u));else switch(f.targetRayMode){case"gaze":c.push({id:y,isPrimary:u,type:"gaze",inputSource:f,events:m});break;case"screen":c.push({id:y,isPrimary:u,type:"screenInput",inputSource:f,events:m});break;case"transient-pointer":c.push({id:y,isPrimary:u,type:"transientPointer",inputSource:f,events:m});break;case"tracked-pointer":let v=!1;const E=p;p=()=>{E(),v=!0};const x=GS(y,f,i,m,u);x instanceof Promise?x.then(T=>!v&&s(T)).catch(console.error):c.push(x);break}t.set(f,p)}}return c}}function nA(s,e){const t=(i,n)=>{n!=null&&i.visibilityState===n.visibilityState||e(i.visibilityState==="visible")};return t(s.getState()),s.subscribe(t)}class sA extends On{constructor(){super({transparent:!0,toneMapped:!1,depthWrite:!1})}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=`varying vec2 vLocalPosition;
`+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <color_vertex>",`#include <color_vertex>
        vLocalPosition = position.xy * 2.0;`),e.fragmentShader=`varying vec2 vLocalPosition;
`+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>",`#include <color_fragment>
          float value = max(0.0, 1.0 - sqrt(dot(vLocalPosition, vLocalPosition)));
          diffuseColor.a = diffuseColor.a * value * value;`)}}const rA=new _(0,0,1),nd=new ue,La=new _;function oA(s,e,t,i,n){const r=i.getIntersection();if(r==null||!i.getEnabled()||r.object.isVoidObject===!0||!Ip(s)){e.visible=!1;return}e.visible=!0;const o=typeof n.color=="function"?n.color(i):n.color;Array.isArray(o)?t.color.set(...o):t.color.set(o??"white"),t.opacity=typeof n.opacity=="function"?n.opacity(i):n.opacity??.4,e.position.copy(r.pointOnFace),e.scale.setScalar(n.size??.1);const a=r.normal??r.face?.normal;a!=null&&(nd.setFromUnitVectors(rA,a),r.object.getWorldQuaternion(e.quaternion),e.quaternion.multiply(nd),La.set(0,0,n.cursorOffset??.01),La.applyQuaternion(e.quaternion),e.position.add(La)),e.updateMatrix()}function Ip({visible:s,parent:e}){return s?e==null?!0:Ip(e):!1}class aA extends On{constructor(){super({transparent:!0,toneMapped:!1})}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=`varying float vFade;
`+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <color_vertex>",`#include <color_vertex>
            vFade = position.z + 0.5;`),e.fragmentShader=`varying float vFade;
`+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>",`#include <color_fragment>
              diffuseColor.a *= vFade;`)}}function lA(s,e,t,i){const n=t.getIntersection();if(!t.getEnabled()||n==null){s.visible=!1;return}s.visible=!0;const r=typeof i.color=="function"?i.color(t):i.color;Array.isArray(r)?e.color.set(...r):e.color.set(r??"white"),e.opacity=typeof i.opacity=="function"?i.opacity(t):i.opacity??.4;const o=Math.min(i.maxLength??1,n.distance);s.position.z=-o/2;const a=i.size??.005;s.scale.set(a,a,o),s.updateMatrix()}function cA(s,e,t,i){const n=r=>{e!="all"&&r.inputSource!=e||i(r)};return s.addEventListener(t,n),()=>s.removeEventListener(t,n)}function uA(s,e,t,i,n,r={}){const o=h=>{h.inputSource===t&&s.down(Object.assign(h,{button:r.button??0}))},a=h=>{h.inputSource===t&&s.up(Object.assign(h,{button:r.button??0}))},c=`${i}start`,l=`${i}end`,u=n.length;for(let h=0;h<u;h++){const f=n[h];switch(f.type){case c:o(f);break;case l:a(f);break}}return e.addEventListener(c,o),e.addEventListener(l,a),()=>{e.removeEventListener(c,o),e.removeEventListener(l,a)}}function _p(s){return s.getButtonsDown().size>0?.6:Pp(s.getIntersection()?.distance??1/0,.07,0,.2,.4)}function vs(s){return s.getButtonsDown().size>0?.6:.4}function Lp(s){return Pp(s.getIntersection()?.distance??1/0,.1,.03,.2,.6)}function Pp(s,e,t,i,n){return i+Math.max(0,Math.min(1,(s-e)/(t-e)))*(n-i)}function hA(s,e){return(t,i)=>{if(s===e)return t.identity(),!0;const n=typeof e=="function"?e():e;if(n==null)return!1;const r=i?.getPose(s,n);return r==null?!1:(t.fromArray(r.transform.matrix),!0)}}function fo(s,e,t,i){s.updateWorldMatrix(!0,!1),i?.copy(s.matrix);const n=Mp(s.parent,s,i);return n??(i!=null&&dA(s,e,i),t)}function dA(s,e,t){if(s.updateWorldMatrix(!0,!1),e==null){t.copy(s.matrixWorld);return}e.updateWorldMatrix(!0,!1),t.copy(e.matrixWorld).invert().multiply(s.matrixWorld)}function Mp(s,e,t){if(s!=null)return s.xrSpace!=null?(t?.copy(s.matrixWorld).invert().multiply(e.matrixWorld),s.xrSpace):Mp(s.parent,e,t)}class fA{nativeEvent;NONE=0;CAPTURING_PHASE=1;AT_TARGET=2;BUBBLING_PHASE=3;relatedTarget=null;get altKey(){return this.getFromNative("altKey",!1)}get button(){return this.getFromNative("button",0)}get buttons(){return this.getFromNative("buttons",0)}get clientX(){return this.getFromNative("clientX",0)}get clientY(){return this.getFromNative("clientY",0)}get ctrlKey(){return this.getFromNative("ctrlKey",!1)}get layerX(){return this.getFromNative("layerX",0)}get layerY(){return this.getFromNative("layerY",0)}get metaKey(){return this.getFromNative("metaKey",!1)}get movementX(){return this.getFromNative("movementX",0)}get movementY(){return this.getFromNative("movementY",0)}get offsetX(){return this.getFromNative("offsetX",0)}get offsetY(){return this.getFromNative("offsetY",0)}get pageX(){return this.getFromNative("pageX",0)}get pageY(){return this.getFromNative("pageY",0)}get screenX(){return this.getFromNative("screenX",0)}get screenY(){return this.getFromNative("screenY",0)}get shiftKey(){return this.getFromNative("shiftKey",!1)}get x(){return this.getFromNative("x",0)}get y(){return this.getFromNative("y",0)}get detail(){return this.getFromNative("detail",0)}get view(){return this.getFromNative("view",null)}get which(){return this.getFromNative("which",0)}get cancelBubble(){return this.getFromNative("cancelBubble",!1)}get composed(){return this.getFromNative("composed",!1)}get eventPhase(){return this.getFromNative("eventPhase",0)}get isTrusted(){return this.getFromNative("isTrusted",!1)}get returnValue(){return this.getFromNative("returnValue",!1)}get timeStamp(){return this.getFromNative("timeStamp",0)}get cancelable(){return this.getFromNative("cancelable",!1)}get defaultPrevented(){return this.getFromNative("defaultPrevented",!1)}constructor(e){this.nativeEvent=e}getFromNative(e,t){return e in this.nativeEvent?this.nativeEvent[e]:t}}const Pa=new _;class ot extends fA{type;bubbles;internalPointer;intersection;camera;currentObject;object;propagationState;get pointerId(){return this.internalPointer.id}get pointerType(){return this.internalPointer.type}get pointerState(){return this.internalPointer.state}get distance(){return this.intersection.distance}get distanceToRay(){return this.intersection.distanceToRay}get point(){return this.intersection.point}get index(){return this.intersection.index}get face(){return this.intersection.face}get faceIndex(){return this.intersection.faceIndex}get uv(){return this.intersection.uv}get uv1(){return this.intersection.uv1}get normal(){return this.intersection.normal}get instanceId(){return this.intersection.instanceId}get pointOnLine(){return this.intersection.pointOnLine}get batchId(){return this.intersection.batchId}get pointerPosition(){return this.intersection.pointerPosition}get pointerQuaternion(){return this.intersection.pointerQuaternion}get pointOnFace(){return this.intersection.pointOnFace}get localPoint(){return this.intersection.localPoint}get details(){return this.intersection.details}get target(){return this.object}get currentTarget(){return this.currentObject}get eventObject(){return this.currentObject}get srcElement(){return this.currentObject}_pointer;get pointer(){return this._pointer==null&&(Pa.copy(this.intersection.point).project(this.camera),this._pointer=new de(Pa.x,Pa.y)),this._pointer}_ray;get ray(){if(this._ray!=null)return this._ray;switch(this.intersection.details.type){case"screen-ray":case"ray":case"sphere":return this._ray=new qi(this.intersection.pointerPosition,new _(0,0,-1).applyQuaternion(this.intersection.pointerQuaternion));case"lines":return this._ray=new qi(this.intersection.details.line.start,this.intersection.details.line.end.clone().sub(this.intersection.details.line.start).normalize())}}_intersections=[];get intersections(){return this._intersections==null&&(this._intersections=[{...this.intersection,eventObject:this.currentObject}]),this._intersections}_unprojectedPoint;get unprojectedPoint(){if(this._unprojectedPoint==null){const e=this.pointer;this._unprojectedPoint=new _(e.x,e.y,0).unproject(this.camera)}return this._unprojectedPoint}get stopped(){return this.propagationState.stoppedImmediate||this.propagationState.stopped}get stoppedImmediate(){return this.propagationState.stoppedImmediate}get delta(){throw new Error("not supported")}constructor(e,t,i,n,r,o,a=r.object,c=a,l={stopped:!t,stoppedImmediate:!1}){super(i),this.type=e,this.bubbles=t,this.internalPointer=n,this.intersection=r,this.camera=o,this.currentObject=a,this.object=c,this.propagationState=l}stopPropagation(){this.propagationState.stopped=!0}stopImmediatePropagation(){this.propagationState.stoppedImmediate=!0}retarget(e){return new ot(this.type,this.bubbles,this.nativeEvent,this.internalPointer,this.intersection,this.camera,e,this.target,this.propagationState)}}class Kr extends ot{get deltaX(){return this.nativeEvent.deltaX}get deltaY(){return this.nativeEvent.deltaY}get deltaZ(){return this.nativeEvent.deltaZ}constructor(e,t,i,n,r,o){super("wheel",!0,e,t,i,n,r,o)}retarget(e){return new Kr(this.nativeEvent,this.internalPointer,this.intersection,this.camera,e,this.target)}}function yt(s){Dp(s,s.currentObject)}function Dp(s,e){if(e==null)return;const t=pA(e,s.type);if(t!=null&&t.length>0){const i=s.retarget(e),n=t.length;for(let r=0;r<n&&!i.stoppedImmediate;r++)t[r](i)}s.stopped||Dp(s,e.parent)}const Bp={click:"onClick",contextmenu:"onContextMenu",dblclick:"onDoubleClick",pointercancel:"onPointerCancel",pointerdown:"onPointerDown",pointerenter:"onPointerEnter",pointerleave:"onPointerLeave",pointermove:"onPointerMove",pointerout:"onPointerOut",pointerover:"onPointerOver",pointerup:"onPointerUp",wheel:"onWheel"},mA=Object.keys(Bp);function pA(s,e){if(s._listeners!=null&&e in s._listeners)return s._listeners[e];let t;if(s.isVoidObject&&e==="click"&&s.parent?.__r3f!=null&&(t=s.parent.__r3f.root.getState().onPointerMissed),s.__r3f!=null&&(t=s.__r3f.handlers[Bp[e]]),t!=null)return[t]}const gA=1e10,yA=new Yr(gA),sd=new Map;function Fp(s){let e=sd.get(s);return e==null&&(e=new oe(yA),e.isVoidObject=!0,e.parent=s,e.pointerEventsOrder=-1/0,sd.set(s,e)),e}function mo(s,e,t){const i=e.normal??e.face?.normal;return i==null?!1:(s.setFromNormalAndCoplanarPoint(i,e.localPoint),s.applyMatrix4(t),!0)}function vA(s,e,t){if(e==="none"||e==="listener"&&!s)return!1;if(t==="all")return!0;if(typeof t=="function")return({id:r,type:o,state:a})=>t(r,o,a);let i,n;return"deny"in t?(n=!0,i=t.deny):(n=!1,i=t.allow),Array.isArray(i)?r=>rd(i.includes(r.type),n):r=>rd(i===r.type,n)}function rd(s,e){return e?!s:s}function hc(s,e,t,i=!1,n,r,o){const a=i||xA(s,e),c=e.pointerEvents??n,l=c??e.defaultPointerEvents??"listener",u=e.pointerEventsType??r??"all",h=e.pointerEventsOrder??o??0,f=vA(a,l,u),m=t.length;if(m===1)(f===!0||typeof f=="function"&&f(t[0]))&&Ma(t[0],e,l,u,h);else if(f===!0)for(let y=0;y<m;y++)Ma(t[y],e,l,u,h);else if(typeof f=="function")for(let y=0;y<m;y++){const v=t[y];f(v)&&Ma(v,e,l,u,h)}if(e.children.length===0||e.intersectChildren===!1)return;const p=e.interactableDescendants??e.children,g=p.length;for(let y=0;y<g;y++)hc(s,p[y],t,a,c,u,h)}function xA(s,e){if(e.ancestorsHaveListeners||s==="pointer"&&e.ancestorsHavePointerListeners||s==="wheel"&&e.ancestorsHaveWheelListeners||e.__r3f!=null&&e.__r3f?.eventCount>0&&(s==="wheel"&&e.__r3f.handlers.onWheel!=null||s==="pointer"&&Object.keys(e.__r3f.handlers).some(n=>n!="onWheel")))return!0;if(e._listeners==null)return!1;if(s==="wheel"){const n=e._listeners.wheel;return n!=null&&n.length>0}const t=Object.entries(e._listeners),i=t.length;for(let n=0;n<i;n++){const r=t[n];if(r[0]!=="wheel"&&mA.includes(r[0])&&r[1]!=null&&r[1].length>0)return!0}return!1}function Ma({intersector:s,options:e},t,i,n,r){e.filter?.(t,i,n,r)!==!1&&s.executeIntersection(t,r)}function po(s,e,{customSort:t=EA}={},i){let n,r,o;const a=s.length;for(let c=0;c<a;c++){const l=s[c];if(i?.(l)===!1)continue;const u=e?.[c];(n==null||t(l,u,n,r)<0)&&(o=c,n=l,r=u)}return o}function EA(s,e=0,t,i=0){return e!=i?i-e:s.distance-t.distance}const od=1e7;function dc(s,e,t,i,n,r=0){const o=e.direction.clone().multiplyScalar(od),a=od;return{distance:a+r,object:Fp(s),point:o,normal:e.origin.clone().sub(o).normalize(),details:t(o,a),pointerPosition:i,pointerQuaternion:n,pointOnFace:o,localPoint:o}}function Vr(s,e,t){for(;t>0;)s.push(e),--t}const Da=Symbol("buttonsDownTime"),AA=Symbol("buttonsClickTime");globalThis.pointerEventspointerMap??=new Map;Ve.prototype.setPointerCapture=function(s){fc(s)?.setCapture(this)};Ve.prototype.releasePointerCapture=function(s){const e=fc(s);e==null||!e.hasCaptured(this)||e.setCapture(void 0)};Ve.prototype.hasPointerCapture=function(s){return fc(s)?.hasCaptured(this)??!1};function fc(s){return globalThis.pointerEventspointerMap?.get(s)}class Un{id;type;state;intersector;getCamera;onMoveCommited;parentSetPointerCapture;parentReleasePointerCapture;options;prevIntersection;intersection;prevEnabled=!0;enabled=!0;wheelIntersection;pointerEntered=[];pointerEnteredHelper=[];pointerCapture;buttonsDownTime=new Map;buttonsDown=new Set;wasMoved=!1;onFirstMove=[];constructor(e,t,i,n,r,o,a,c,l={}){this.id=e,this.type=t,this.state=i,this.intersector=n,this.getCamera=r,this.onMoveCommited=o,this.parentSetPointerCapture=a,this.parentReleasePointerCapture=c,this.options=l,globalThis.pointerEventspointerMap?.set(e,this)}getPointerCapture(){return this.pointerCapture}hasCaptured(e){return this.pointerCapture?.object===e}setCapture(e){this.pointerCapture?.object!==e&&(this.pointerCapture!=null&&(this.parentReleasePointerCapture?.(),this.pointerCapture=void 0),e!=null&&this.intersection!=null&&(this.pointerCapture={object:e,intersection:this.intersection},this.parentSetPointerCapture?.()))}getButtonsDown(){return this.buttonsDown}getIntersection(){return this.intersection}getEnabled(){return this.enabled}setEnabled(e,t,i=!0){this.enabled!==e&&(!e&&this.pointerCapture!=null&&(this.parentReleasePointerCapture?.(),this.pointerCapture=void 0),this.enabled=e,i&&this.commit(t,!1))}computeIntersection(e,t,i){return this.pointerCapture!=null?this.intersector.intersectPointerCapture(this.pointerCapture,i):(this.intersector.startIntersection(i),hc(e,t,[this]),this.intersector.finalizeIntersection(t))}setIntersection(e){this.intersection=e}commit(e,t){const i=this.getCamera(),n=this.prevEnabled?this.prevIntersection:void 0,r=this.enabled?this.intersection:void 0;n!=null&&n.object!=r?.object&&yt(new ot("pointerout",!0,e,this,n,i));const o=this.pointerEntered;this.pointerEntered=[],this.pointerEnteredHelper.length=0,kp(r?.object,this.pointerEntered,o,this.pointerEnteredHelper);const a=o.length;for(let c=0;c<a;c++){const l=o[c];yt(new ot("pointerleave",!1,e,this,n,i,l))}r!=null&&n?.object!=r.object&&yt(new ot("pointerover",!0,e,this,r,i));for(let c=this.pointerEnteredHelper.length-1;c>=0;c--){const l=this.pointerEnteredHelper[c];yt(new ot("pointerenter",!1,e,this,r,i,l))}if(t&&r!=null&&yt(new ot("pointermove",!0,e,this,r,i)),this.prevIntersection=this.intersection,this.prevEnabled=this.enabled,!this.wasMoved&&this.intersector.isReady()){this.wasMoved=!0;const c=this.onFirstMove.length;for(let l=0;l<c;l++)this.onFirstMove[l](i);this.onFirstMove.length=0}this.onMoveCommited?.(this)}move(e,t){this.intersection=this.computeIntersection("pointer",e,t),this.commit(t,!0)}over(e,t){this.wasMoved||(this.intersection=this.computeIntersection("pointer",e,t),this.commit(t,!1))}emitMove(e){this.intersection!=null&&yt(new ot("pointermove",!0,e,this,this.intersection,this.getCamera()))}down(e){if(this.buttonsDown.add(e.button),!this.enabled)return;if(!this.wasMoved){this.onFirstMove.push(this.down.bind(this,e));return}if(this.intersection==null)return;yt(new ot("pointerdown",!0,e,this,this.intersection,this.getCamera()));const{object:t}=this.intersection;t[Da]??=new Map,t[Da].set(e.button,e.timeStamp),this.buttonsDownTime.set(e.button,e.timeStamp)}up(e){if(this.buttonsDown.delete(e.button),!this.enabled)return;if(!this.wasMoved){this.onFirstMove.push(this.up.bind(this,e));return}if(this.intersection==null)return;const{clickThesholdMs:t,contextMenuButton:i=2,dblClickThresholdMs:n=500,clickThresholdMs:r=t??300}=this.options;this.pointerCapture=void 0;const o=SA(this.buttonsDownTime,this.intersection.object[Da],e.button,e.timeStamp,r),a=this.getCamera();if(o&&e.button===i&&yt(new ot("contextmenu",!0,e,this,this.intersection,a)),yt(new ot("pointerup",!0,e,this,this.intersection,a)),!o||e.button===i)return;yt(new ot("click",!0,e,this,this.intersection,a));const{object:c}=this.intersection,l=c[AA]??=new Map,u=l.get(e.button);if(u==null||e.timeStamp-u>n){l.set(e.button,e.timeStamp);return}yt(new ot("dblclick",!0,e,this,this.intersection,a)),l.delete(e.button)}cancel(e){if(this.enabled){if(!this.wasMoved){this.onFirstMove.push(this.cancel.bind(this,e));return}this.intersection!=null&&yt(new ot("pointercancel",!0,e,this,this.intersection,this.getCamera()))}}wheel(e,t,i=!1){if(!this.enabled)return;if(!this.wasMoved&&i){this.onFirstMove.push(this.wheel.bind(this,e,t,i));return}i||(this.wheelIntersection=this.computeIntersection("wheel",e,t));const n=i?this.intersection:this.wheelIntersection;n!=null&&yt(new Kr(t,this,n,this.getCamera()))}emitWheel(e,t=!1){if(!this.enabled)return;if(!this.wasMoved&&t){this.onFirstMove.push(this.emitWheel.bind(this,e,t));return}const i=t?this.intersection:this.wheelIntersection;i!=null&&yt(new Kr(e,this,i,this.getCamera()))}exit(e){this.wasMoved&&(this.pointerCapture!=null&&(this.parentReleasePointerCapture?.(),this.pointerCapture=void 0),this.intersection=void 0,this.commit(e,!1)),this.onFirstMove.length=0,this.wasMoved=!1}}function kp(s,e,t,i){if(s==null)return;const n=t.indexOf(s);n!=-1?t.splice(n,1):i.push(s),e.push(s),kp(s.parent,e,t,i)}function SA(s,e,t,i,n){if(e==null)return!1;const r=e.get(t);return!(r==null||i-r>n||r!=s.get(t))}function go(s){return s.transformReady===!1?!1:s.parent==null?(s.matrixWorld.copy(s.matrix),!0):go(s.parent)?(s.matrixWorld.multiplyMatrices(s.parent.matrixWorld,s.matrix),!0):!1}const Qn=new lf,Ba=new lf,ad=new de,ld=new de,cd=new de,Fa=new _,TA=new re,lr=new _;function Ts(s,e,t){lr.copy(e).applyMatrix4(TA.copy(t.matrixWorld).invert());const i=t.geometry.attributes.uv;if(i==null||!(i instanceof fi))return!1;let n;return bA(t,(r,o,a)=>{t.getVertexPosition(r,Qn.a),t.getVertexPosition(o,Qn.b),t.getVertexPosition(a,Qn.c);const c=Qn.closestPointToPoint(lr,Fa).distanceTo(lr);n!=null&&c>=n||(n=c,Ba.copy(Qn),ad.fromBufferAttribute(i,r),ld.fromBufferAttribute(i,o),cd.fromBufferAttribute(i,a))}),n==null?!1:(Ba.closestPointToPoint(lr,Fa),Ba.getInterpolation(Fa,ad,ld,cd,s),!0)}function bA(s,e){const t=s.geometry.drawRange;if(s.geometry.index!=null){const o=s.geometry.index,a=Math.max(0,t.start),c=Math.min(o.count,t.start+t.count);for(let l=a;l<c;l+=3)e(o.getX(l),o.getX(l+1),o.getX(l+2));return}const i=s.geometry.attributes.position;if(i==null)return;const n=Math.max(0,t.start),r=Math.min(i.count,t.start+t.count);for(let o=n;o<r;o+=3)e(o,o+1,o+2)}const CA=new re,ka=new $a,RA=new _,ud=new vi,wA=new qi,hd=new de,dd=[new _(0,0,0),new _(0,0,1)];class IA{space;options;raycasters=[];fromMatrixWorld=new re;ready;intersects=[];pointerEventsOrders=[];raycasterIndices=[];constructor(e,t){this.space=e,this.options=t}isReady(){return this.ready??this.prepareTransformation()}prepareTransformation(){const e=this.space.current;return e==null?this.ready=!1:(this.ready=go(e),this.ready?(this.fromMatrixWorld.copy(e.matrixWorld),!0):!1)}intersectPointerCapture({intersection:e,object:t}){const i=e.details;if(i.type!="lines")throw new Error(`unable to process a pointer capture of type "${e.details.type}" with a lines intersector`);if(!this.prepareTransformation())return e;const n=this.options.linePoints??dd;ka.set(n[i.lineIndex],n[i.lineIndex+1]).applyMatrix4(this.fromMatrixWorld);const r=ka.at(i.distanceOnLine/ka.distance(),new _);e.object.updateWorldMatrix(!0,!1),mo(ud,e,e.object.matrixWorld);const o=wA.intersectPlane(ud,new _)??r,a=new _,c=new ue;this.fromMatrixWorld.decompose(a,c,RA);let l=e.uv;return e.object instanceof oe&&Ts(hd,r,e.object)&&(l=hd.clone()),{...e,object:t,uv:l,pointOnFace:o,point:r,pointerPosition:a,pointerQuaternion:c}}startIntersection(){if(!this.prepareTransformation())return;const e=this.options.linePoints??dd,t=e.length-1;for(let i=0;i<t;i++){const n=e[i],r=e[i+1],o=this.raycasters[i]??(this.raycasters[i]=new Fi);o.ray.origin.copy(n).applyMatrix4(this.fromMatrixWorld),o.ray.direction.copy(r).applyMatrix4(this.fromMatrixWorld),o.ray.direction.sub(o.ray.origin);const a=o.ray.direction.length();o.ray.direction.divideScalar(a),o.far=a}this.raycasters.length=t}executeIntersection(e,t){if(!this.isReady())return;const i=this.intersects.length,n=this.raycasters.length;for(let r=0;r<n;r++){const o=this.raycasters[r],a=this.intersects.length;e.raycast(o,this.intersects),Vr(this.raycasterIndices,r,this.intersects.length-a)}Vr(this.pointerEventsOrders,t,this.intersects.length-i)}finalizeIntersection(e){const t=new _().setFromMatrixPosition(this.fromMatrixWorld),i=new ue().setFromRotationMatrix(this.fromMatrixWorld),n=po(this.intersects,this.pointerEventsOrders,this.options),r=n==null?void 0:this.intersects[n],o=n==null?void 0:this.raycasterIndices[n];if(this.intersects.length=0,this.raycasterIndices.length=0,this.pointerEventsOrders.length=0,r==null||o==null){const l=this.raycasters.length-1,u=this.raycasters.reduce((f,m,p)=>p===l?f:f+m.far,0),h=this.raycasters[l];return dc(e,h.ray,(f,m)=>({line:new $a(h.ray.origin.clone(),f),lineIndex:this.raycasters.length-1,distanceOnLine:m,type:"lines"}),t,i,u)}let a=r.distance;for(let l=0;l<o;l++)a+=this.raycasters[l].far;r.object.updateWorldMatrix(!0,!1);const c=this.raycasters[o];return Object.assign(r,{details:{lineIndex:o,distanceOnLine:r.distance,type:"lines",line:new $a(c.ray.origin.clone(),c.ray.direction.clone().multiplyScalar(c.far).add(c.ray.origin))},distance:a,pointerPosition:t,pointerQuaternion:i,pointOnFace:r.point,localPoint:r.point.clone().applyMatrix4(CA.copy(r.object.matrixWorld).invert())})}}const pl=new re,gl=new _,_A=new _(0,0,-1),fd=new vi,jr=new de;class LA{space;options;raycaster=new Fi;raycasterQuaternion=new ue;worldScale=0;ready;intersects=[];pointerEventsOrders=[];constructor(e,t){this.space=e,this.options=t}isReady(){return this.ready??this.prepareTransformation()}prepareTransformation(){const e=this.space.current;return e==null?this.ready=!1:(this.ready=go(e),this.ready?(e.matrixWorld.decompose(this.raycaster.ray.origin,this.raycasterQuaternion,gl),this.worldScale=gl.x,this.raycaster.ray.direction.copy(this.options?.direction??_A).applyQuaternion(this.raycasterQuaternion),!0):!1)}intersectPointerCapture({intersection:e,object:t}){if(e.details.type!="ray")throw new Error(`unable to process a pointer capture of type "${e.details.type}" with a ray intersector`);if(!this.prepareTransformation())return e;e.object.updateWorldMatrix(!0,!1),mo(fd,e,e.object.matrixWorld);const{ray:i}=this.raycaster,n=i.intersectPlane(fd,new _)??e.point,r=i.direction.clone().multiplyScalar(e.pointerPosition.distanceTo(e.point)).add(i.origin);let o=e.uv;return e.object instanceof oe&&Ts(jr,r,e.object)&&(o=jr.clone()),{...e,uv:o,object:t,pointOnFace:n,point:r,pointerPosition:i.origin.clone(),pointerQuaternion:this.raycasterQuaternion.clone()}}startIntersection(){this.prepareTransformation()}executeIntersection(e,t){if(!this.isReady())return;const i=this.intersects.length;e.raycast(this.raycaster,this.intersects),Vr(this.pointerEventsOrders,t,this.intersects.length-i)}finalizeIntersection(e){const t=this.raycaster.ray.origin.clone(),i=this.raycasterQuaternion.clone();let n;if(this.options.minDistance!=null){const a=this.options.minDistance/this.worldScale;n=c=>c.distance>=a}const r=po(this.intersects,this.pointerEventsOrders,this.options,n),o=r==null?void 0:this.intersects[r];return this.intersects.length=0,this.pointerEventsOrders.length=0,o==null?dc(e,this.raycaster.ray,()=>({type:"ray"}),t,i):(o.object.updateWorldMatrix(!0,!1),Object.assign(o,{details:{type:"ray"},pointerPosition:t,pointerQuaternion:i,pointOnFace:o.point,localPoint:o.point.clone().applyMatrix4(pl.copy(o.object.matrixWorld).invert())}))}}const PA=new _;class MA{prepareTransformation;options;raycaster=new Fi;cameraQuaternion=new ue;fromPosition=new _;fromQuaternion=new ue;coords=new de;viewPlane=new vi;intersects=[];pointerEventsOrders=[];constructor(e,t){this.prepareTransformation=e,this.options=t}isReady(){return!0}intersectPointerCapture({intersection:e,object:t},i){const n=e.details;if(n.type!="screen-ray")throw new Error(`unable to process a pointer capture of type "${e.details.type}" with a camera ray intersector`);if(!this.startIntersection(i))return e;this.viewPlane.constant-=n.distanceViewPlane;const r=this.raycaster.ray.intersectPlane(this.viewPlane,new _);if(r==null)return e;e.object.updateWorldMatrix(!0,!1),mo(this.viewPlane,e,e.object.matrixWorld);let o=e.uv;return e.object instanceof oe&&Ts(jr,r,e.object)&&(o=jr.clone()),{...e,details:{...n,direction:this.raycaster.ray.direction.clone(),screenPoint:this.coords.clone()},uv:o,object:t,point:r,pointOnFace:r,pointerPosition:this.raycaster.ray.origin.clone(),pointerQuaternion:this.cameraQuaternion.clone()}}startIntersection(e){const t=this.prepareTransformation(e,this.coords);return t==null?!1:(t.updateWorldMatrix(!0,!1),t.matrixWorld.decompose(this.fromPosition,this.fromQuaternion,gl),this.raycaster.setFromCamera(this.coords,t),this.viewPlane.setFromNormalAndCoplanarPoint(t.getWorldDirection(PA),this.raycaster.ray.origin),!0)}executeIntersection(e,t){const i=this.intersects.length;e.raycast(this.raycaster,this.intersects),Vr(this.pointerEventsOrders,t,this.intersects.length-i)}finalizeIntersection(e){const t=this.fromPosition.clone(),i=this.cameraQuaternion.clone(),n=this.raycaster.ray.direction.clone(),r=po(this.intersects,this.pointerEventsOrders,this.options),o=r==null?void 0:this.intersects[r];return this.intersects.length=0,this.pointerEventsOrders.length=0,o==null?dc(e,this.raycaster.ray,(a,c)=>({type:"screen-ray",distanceViewPlane:c,screenPoint:this.coords.clone(),direction:n}),t,i):(o.object.updateWorldMatrix(!0,!1),pl.copy(o.object.matrixWorld).invert(),Object.assign(o,{details:{type:"screen-ray",distanceViewPlane:this.viewPlane.distanceToPoint(o.point),screenPoint:this.coords.clone(),direction:n},pointOnFace:o.point,pointerPosition:t,pointerQuaternion:i,localPoint:o.point.clone().applyMatrix4(pl)}))}}const DA=new _,Wr=new de;class Op{space;getSphereRadius;options;fromPosition=new _;fromQuaternion=new ue;collisionSphere=new yi;ready;intersects=[];constructor(e,t,i){this.space=e,this.getSphereRadius=t,this.options=i}isReady(){return this.ready??this.prepareTransformation()}prepareTransformation(){const e=this.space.current;return e==null?this.ready=!1:(this.ready=go(e),this.ready?(e.matrixWorld.decompose(this.fromPosition,this.fromQuaternion,DA),!0):!1)}intersectPointerCapture({intersection:e,object:t}){if(e.details.type!="sphere")throw new Error(`unable to process a pointer capture of type "${e.details.type}" with a sphere intersector`);if(!this.prepareTransformation())return e;md.copy(e.point).sub(e.pointerPosition),pd.copy(e.pointerQuaternion).invert().multiply(this.fromQuaternion);const i=md.clone().applyQuaternion(pd).add(this.fromPosition);e.object.updateWorldMatrix(!0,!1),mo(gd,e,e.object.matrixWorld);const n=gd.projectPoint(this.fromPosition,new _);let r=e.uv;return e.object instanceof oe&&Ts(Wr,i,e.object)&&(r=Wr.clone()),{details:{type:"sphere"},uv:r,distance:i.distanceTo(n),pointerPosition:this.fromPosition.clone(),pointerQuaternion:this.fromQuaternion.clone(),object:t,point:i,pointOnFace:n,face:e.face,localPoint:e.localPoint}}startIntersection(){this.prepareTransformation()&&(this.collisionSphere.center.copy(this.fromPosition),this.collisionSphere.radius=this.getSphereRadius())}executeIntersection(e){this.isReady()&&BA(this.collisionSphere,e,this.intersects)}finalizeIntersection(e){const t=this.fromPosition.clone(),i=this.fromQuaternion.clone(),n=po(this.intersects,void 0,this.options),r=n==null?void 0:this.intersects[n];return this.intersects.length=0,r==null?{details:{type:"sphere"},distance:0,point:t,object:Fp(e),pointerPosition:t,pointerQuaternion:i,pointOnFace:t,localPoint:t}:(r.object.updateWorldMatrix(!0,!1),Object.assign(r,{details:{type:"sphere"},pointOnFace:r.point,pointerPosition:this.fromPosition.clone(),pointerQuaternion:this.fromQuaternion.clone(),localPoint:r.point.clone().applyMatrix4(Xr.copy(r.object.matrixWorld).invert())}))}}const cr=new re;function BA(s,e,t){if(e.updateWorldMatrix(!0,!1),e.spherecast!=null){e.spherecast(s,t);return}if(e instanceof Xd){e.geometry.boundingSphere==null&&e.geometry.computeBoundingSphere(),e.geometry.boundingBox==null&&e.geometry.computeBoundingBox();for(let n=0;n<e.count;n++){if(e.getMatrixAt(n,cr),cr.premultiply(e.matrixWorld),!yd(s,e,cr))continue;const r=xd(s,e,cr,n);r!=null&&t.push(r)}}if(!(e instanceof oe)||!yd(s,e,e.matrixWorld))return;Xr.copy(e.matrixWorld).invert();const i=xd(s,e,e.matrixWorld);i!=null&&t.push(i)}const md=new _,pd=new ue,gd=new vi,_n=new yi;function yd(s,{geometry:e},t){return e.boundingSphere==null&&e.computeBoundingSphere(),_n.copy(e.boundingSphere).applyMatrix4(t),_n.center.distanceToSquared(s.center)<(s.radius+_n.radius)**2}const ur=new _,Oa=new _,vd=new _,FA=new _(1e-4,1e-4,1e-4),Xr=new re;function xd(s,e,t,i){Xr.copy(t).invert(),_n.copy(s).applyMatrix4(Xr);const{geometry:n}=e;n.boundingBox==null&&n.computeBoundingBox(),n.boundingBox.getSize(Oa),n.boundingBox.getCenter(vd),n.boundingBox.clampPoint(_n.center,ur),ur.applyMatrix4(t);const r=ur.distanceToSquared(s.center);if(r>s.radius*s.radius)return;Oa.max(FA);const o=_n.center.clone().sub(vd);o.divide(Oa),kA(o);const a=ur.clone();let c;return Ts(Wr,a,e)&&(c=Wr.clone()),{distance:Math.sqrt(r),face:{a:0,b:0,c:0,materialIndex:0,normal:o},uv:c,normal:o,point:a,instanceId:i,object:e}}function kA(s){const e=Math.abs(s.x),t=Math.abs(s.y),i=Math.abs(s.z);if(e>=t&&e>=i){s.set(s.x<0?-1:1,0,0);return}if(t>=e&&t>=i){s.set(0,s.y<0?-1:1,0);return}s.set(0,0,s.z<0?-1:1)}function OA(s,e,t,i={},n="grab"){return new Un(bs(),n,t,new Op(e,()=>i.radius??.07,i),s,void 0,void 0,void 0,i)}function NA(s,e,t,i={},n="ray"){return new Un(bs(),n,t,new LA(e,i),s,void 0,void 0,void 0,i)}function UA(s,e,t,i={},n="lines"){return new Un(bs(),n,t,new IA(e,i),s,void 0,void 0,void 0,i)}function zA(s,e,t,i={},n="touch"){return new Un(bs(),n,t,new Op(e,()=>i.hoverRadius??.1,i),s,GA(i),void 0,void 0,i)}function GA(s){let e=!1;return t=>{if(!t.getEnabled())return;const i=t.getIntersection(),n=$A(i,s.downRadius??.03);if(n===e)return;const r={timeStamp:performance.now(),button:s.button??0};n?t.down(r):t.up(r),e=n}}function $A(s,e){return s==null?!1:s.distance<=e}let HA=23412;function bs(){return HA++}function KA(s,e,t){if(!(e instanceof globalThis.MouseEvent))return t.set(0,0);const{width:i,height:n,top:r,left:o}=s.getBoundingClientRect(),a=e.clientX-o,c=e.clientY-r;return t.set(a/i*2-1,-(c/n)*2+1)}function VA(s,e,t,i){return Np(s,typeof e=="function"?e:()=>e,t,KA.bind(null,s),s.setPointerCapture.bind(s),n=>{s.hasPointerCapture(n)&&s.releasePointerCapture(n)},{pointerTypePrefix:"screen-",...i})}function jA(s,e){return!(s instanceof ot)||s.uv==null?e.set(0,0):e.copy(s.uv).multiplyScalar(2).addScalar(-1)}function WA(s,e,t,i){return Np(s,e,t,jA,s.setPointerCapture.bind(s),s.releasePointerCapture.bind(s),i)}function Np(s,e,t,i,n,r,o={}){const a=o?.forwardPointerCapture??!0,c=new Map,l=o.pointerTypePrefix??"forward-",u=(R,I)=>{let w=c.get(R.pointerId);return w!=null||(w=new Un(bs(),`${l}${R.pointerType}`,R.pointerState,new MA((M,P)=>(i(M,P),e()),o),e,void 0,a?n.bind(null,R.pointerId):void 0,a?r.bind(null,R.pointerId):void 0,o),I!="move"&&I!="wheel"&&(w.setIntersection(w.computeIntersection("pointer",t,R)),w.commit(R,!1)),c.set(R.pointerId,w)),w},h=new Map,f=new Map,m=[],p=[],g=(R,I,w)=>{switch(R){case"move":w.move(t,I);return;case"over":w.move(t,I);return;case"wheel":w.wheel(t,I);return;case"cancel":w.cancel(I);return;case"down":if(!Ed(I))return;w.down(I);return;case"up":if(!Ed(I))return;w.up(I);return;case"exit":f.delete(w),h.delete(w),w.exit(I);return}},y=(R,I)=>{const w=u(I,R);R==="move"&&f.set(w,I),R==="wheel"&&h.set(w,I),o.batchEvents??!0?p.push({type:R,event:I}):g(R,I,w)},v=y.bind(null,"move"),E=y.bind(null,"over"),x=y.bind(null,"cancel"),T=y.bind(null,"down"),A=y.bind(null,"up"),C=y.bind(null,"wheel"),b=y.bind(null,"exit");return s.addEventListener("pointermove",v),s.addEventListener("pointerover",E),s.addEventListener("pointercancel",x),s.addEventListener("pointerdown",T),s.addEventListener("pointerup",A),s.addEventListener("wheel",C),s.addEventListener("pointerleave",b),{destroy(){s.removeEventListener("pointermove",v),s.removeEventListener("pointerover",E),s.removeEventListener("pointercancel",x),s.removeEventListener("pointerdown",T),s.removeEventListener("pointerup",A),s.removeEventListener("wheel",C),s.removeEventListener("pointerleave",b),f.clear(),h.clear()},update(){const R=p.length;for(let I=0;I<R;I++){const{type:w,event:M}=p[I],P=u(M,w);if(w==="move"&&(m.push(P),f.get(P)!=M)){P.emitMove(M);continue}if(w==="wheel"&&h.get(P)!=M){P.emitWheel(M);continue}g(w,M,P)}if(p.length=0,o.intersectEveryFrame??!1)for(const[I,w]of f.entries())m.includes(I)||I.move(t,w);m.length=0}}}function Ed(s){return s.button!=null}let Up=class yl{enableMultiplePointers;pointers=[];isDefaults=[];enabled=!0;activePointer;nonCapturedPointers=[];constructor(e){this.enableMultiplePointers=e}register(e,t=!1){return this.pointers.push(e),this.isDefaults.push(t),this.unregister.bind(this,e)}unregister(e){const t=this.pointers.indexOf(e);t!==-1&&(this.isDefaults.splice(t,1),this.pointers.splice(t,1))}startIntersection(e,t){const i=this.pointers.length;let n=!1;for(let r=0;r<i;r++){const o=this.pointers[r];if(o instanceof yl){o.startIntersection(e,t);continue}const a=o.getPointerCapture();if(a!=null){n=!0,o.setIntersection(o.intersector.intersectPointerCapture(a,t));continue}e.push(o),o.intersector.startIntersection(t)}return n}getIntersection(){return this.activePointer?.getIntersection()}getPointerCapture(){return this.activePointer?.getPointerCapture()}computeActivePointer(){let e;this.activePointer=void 0;const t=this.pointers.length;for(let i=0;i<t;i++){const n=this.pointers[i];n instanceof yl&&n.computeActivePointer();const r=n.getIntersection(),o=n.getPointerCapture()!=null?-1/0:r?.object.isVoidObject?1/0:r?.distance??1/0,a=this.isDefaults[i];(e==null||a&&o===e||o<e)&&(this.activePointer=n,e=o)}}commit(e,t,i=!0){if(this.enableMultiplePointers){const r=this.pointers.length;for(let o=0;o<r;o++)this.pointers[o].commit(e,t);return}i&&this.computeActivePointer();const n=this.pointers.length;for(let r=0;r<n;r++){const o=this.pointers[r];o.setEnabled(o===this.activePointer,e,!1),o.commit(e,t,!1)}}move(e,t){if(!this.enabled)return;if(this.nonCapturedPointers.length=0,!this.startIntersection(this.nonCapturedPointers,t)||this.enableMultiplePointers){hc("pointer",e,this.nonCapturedPointers);const n=this.nonCapturedPointers.length;for(let r=0;r<n;r++){const o=this.nonCapturedPointers[r];o.setIntersection(o.intersector.finalizeIntersection(e))}}this.commit(t,!0)}setEnabled(e,t){this.enabled=e;const i=this.pointers.length;for(let n=0;n<i;n++){const r=this.pointers[n];r.setEnabled(e&&(this.enableMultiplePointers||r==this.activePointer),t)}}};const Na=new _,Ad=new _,Sd=new _,Td=new ue;function XA(s,e,t,i){return e.getWorldQuaternion(Td),Ad.copy(t).applyQuaternion(Td),e.getWorldPosition(Sd),s.getWorldPosition(Na),Na.sub(Sd),Na.angleTo(Ad)<i/2}function zp(){return navigator.userAgent.includes("Macintosh")&&navigator.xr!=null}function Gp(s,e,{anchors:t=!0,handTracking:i=!zp(),layers:n=!0,meshDetection:r=!0,planeDetection:o=!0,customSessionInit:a,depthSensing:c=!1,hitTest:l=!0,domOverlay:u=!0,bodyTracking:h=!1,bounded:f}={}){if(a!=null)return a;const m=f==null?["local-floor"]:f?["bounded-floor"]:["unbounded","local-floor"],p=[];u instanceof Element&&(u=!0),oi(t,"anchors",m,p),oi(i,"hand-tracking",m,p),oi(n,"layers",m,p),oi(r,"mesh-detection",m,p),oi(o,"plane-detection",m,p),oi(c,"depth-sensing",m,p),oi(u,"dom-overlay",m,p),oi(l,"hit-test",m,p),oi(h,"body-tracking",m,p);const g={requiredFeatures:m,optionalFeatures:p};return e!=null&&(g.domOverlay={root:e}),c&&Object.assign(g,{depthSensing:{usagePreference:["gpu-optimized"],dataFormatPreference:[]}}),g}function oi(s,e,t,i){if(s!==!1){if(s===!0){i.push(e);return}t.push(e)}}function Ln(s,e,t){return typeof s=="function"?s:(typeof s=="object"&&(e!=null&&YA(s,e)?s=s[e]:"default"in s&&(s=s.default)),s===!1?!1:s===!0?t:s??t)}function YA(s,e){return e in s}const $p={session:void 0,mediaBinding:void 0,originReferenceSpace:void 0,visibilityState:void 0,mode:null,frameRate:void 0,inputSourceStates:[],detectedMeshes:[],detectedPlanes:[],layerEntries:[]};async function bd(s,e,t){if(typeof navigator>"u")return!1;const[i,n]=await Promise.all([navigator.xr?.isSessionSupported("immersive-vr").catch(o=>(console.error(o),!1)),navigator.xr?.isSessionSupported("immersive-ar").catch(o=>(console.error(o),!1))]);if(n||i)return!1;const{emulate:r}=await Ml(async()=>{const{emulate:o}=await import("./chunk-Hzh-wOeE.js");return{emulate:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]));return t&&window.alert("emulator started"),s.setState({emulator:r(e===!0?"metaQuest3":e)}),!0}const Ua=new _,hr=new _;function QA(s){const e=typeof HTMLElement>"u"?void 0:s?.domOverlay instanceof HTMLElement?s.domOverlay:document.createElement("div"),t=pp(()=>({...$p,controller:s?.controller,hand:s?.hand,gaze:s?.gaze,screenInput:s?.screenInput,transientPointer:s?.transientPointer,domOverlayRoot:e})),i=t.subscribe(({session:m},{session:p})=>{p!=null&&m==null&&h!=null&&dr(h,s,e).catch(console.error)}),n=s?.emulate??"metaQuest3";let r;if(typeof window<"u"&&n!=!1){const m=(typeof n=="object"?n.inject:void 0)??{hostname:"localhost"};(m===!0||typeof m!="boolean"&&window.location.hostname===m.hostname)&&bd(t,n,!1).then(g=>{!g||h==null||dr(h,s,e)});const p=g=>{g.altKey&&g.metaKey&&g.code==="KeyE"&&bd(t,n,!0).then(y=>{!y||h==null||dr(h,s,e)})};window.addEventListener("keydown",p),r=()=>window.removeEventListener("keydown",p)}let o;if(e!=null){if(e.parentNode==null){const m=g=>{e.style.display=g.session!=null?"block":"none"},p=t.subscribe(m);m(t.getState()),document.body.appendChild(e),o=()=>{e.remove(),p()}}document.body.append(e)}const a=iA(m=>t.setState({inputSourceStates:[...t.getState().inputSourceStates,m]}),s),c=ZA(t,a,s?.secondaryInputSources??!1),l=qA(s?.enterGrantedSession,m=>fr(e,m,s,h)),u=[];let h;const f=()=>{t.setState(c(h.getSession()))};return Object.assign(t,{addLayerEntry(m){t.getState().session!=null&&t.setState({layerEntries:[...t.getState().layerEntries,m]})},removeLayerEntry(m){t.getState().session!=null&&t.setState({layerEntries:t.getState().layerEntries.filter(p=>p!=m)})},requestFrame(){return new Promise(m=>u.push(m))},setWebXRManager(m){if(h===m)return;h?.removeEventListener("sessionstart",f),h=m,h.addEventListener("sessionstart",f);const{foveation:p,bounded:g}=s??{};h.setReferenceSpaceType(g?"bounded-floor":"local-floor"),p!=null&&h.setFoveation(p),dr(h,s,e).catch(console.error)},setFrameRate(m){const{session:p}=t.getState();p!=null&&Hp(p,m)},setHand(m,p){if(p==null){t.setState({hand:m});return}const g=t.getState().hand,y={};typeof g=="object"&&Object.assign(y,g),Object.assign(y,{default:Ln(g,void 0,{}),[p]:m}),t.setState({hand:y})},setController(m,p){if(p==null){t.setState({controller:m});return}const g=t.getState().controller,y={};typeof g=="object"&&Object.assign(y,g),Object.assign(y,{default:Ln(g,void 0,{}),[p]:m}),t.setState({controller:y})},setTransientPointer(m,p){if(p==null){t.setState({transientPointer:m});return}const g=t.getState().transientPointer,y={};typeof g=="object"&&Object.assign(y,g),Object.assign(y,{default:Ln(g,void 0,{}),[p]:m}),t.setState({transientPointer:y})},setGaze(m){t.setState({gaze:m})},setScreenInput(m){t.setState({screenInput:m})},destroy(){h?.removeEventListener("sessionstart",f),r?.(),o?.(),l?.(),i(),c(void 0)},enterXR:m=>fr(e,m,s,h),enterAR:()=>fr(e,"immersive-ar",s,h),enterVR:()=>fr(e,"immersive-vr",s,h),onBeforeFrame(m,p,g){let y;const v=h?.getReferenceSpace()??void 0,E=t.getState(),x=p.parent??m;if(E.origin!=x&&(y??={},y.origin=x),v!=E.originReferenceSpace&&(y??={},y.originReferenceSpace=v),x.xrSpace=v,E.origin!=x&&E.origin!=null&&(E.origin.xrSpace=void 0),g!=null&&(h!=null&&eS(t,g,h),E.body!=g.body&&(y??={},y.body=g.body)),y!=null&&t.setState(y),g!=null){const T=u.length;for(let A=0;A<T;A++)u[A](g);u.length=0}},onBeforeRender(){const{session:m,layerEntries:p}=t.getState();if(m==null||h==null)return;const g=h.getCamera();g.aspect=g.projectionMatrix.elements[5]/g.projectionMatrix.elements[0];const y=m?.renderState.layers;if(y==null)return;g.getWorldPosition(Ua),p.sort((x,T)=>{const A=x.renderOrder-T.renderOrder;if(A!==0)return A;x.object3D.getWorldPosition(hr);const C=hr.distanceToSquared(Ua);return T.object3D.getWorldPosition(hr),hr.distanceToSquared(Ua)-C});let v=!1;const E=p.map(({layer:x},T)=>(x!=y[T]&&(v=!0),x));v&&(E.push(h.getBaseLayer()),m.updateRenderState({layers:E}))}})}async function dr(s,e,t){const i=e?.offerSession??!0;if(navigator.xr?.offerSession==null||i===!1)return;let n;i===!0?n=await navigator.xr.isSessionSupported("immersive-ar")??!1?"immersive-ar":"immersive-vr":n=i;const r=await navigator.xr.offerSession(n,Gp(n,t,e));Kp(r,s,e)}async function Hp(s,e){if(e===!1)return;const{supportedFrameRates:t}=s;if(t==null||t.length===0)return;if(typeof e=="function"){const n=e(t);if(n===!1)return;await s.updateTargetFrameRate(n);return}const i=e==="high"?1:e==="mid"?.5:0;await s.updateTargetFrameRate(t[Math.ceil((t.length-1)*i)])}async function fr(s,e,t,i){if(typeof navigator>"u"||navigator.xr==null)return Promise.reject(new Error("WebXR not supported"));if(i==null)return Promise.reject(new Error("not connected to three.js. You either might be missing the <XR> component or the canvas is not yet loaded?"));const n=await navigator.xr.requestSession(e,Gp(e,s,t));return await Kp(n,i,t),n}async function Kp(s,e,t){await Promise.all([Hp(s,t?.frameRate??"high"),JA(e,s,t)])}async function JA(s,e,t){if(s==null)return;const i=XRWebGLLayer.getNativeFramebufferScaleFactor(e);let n=t?.frameBufferScaling;typeof n=="function"&&(n=n(i)),typeof n=="string"&&(n=n==="high"?i:n==="mid"?1:.5),n!=null&&s?.setFramebufferScaleFactor(n),await s?.setSession(e)}const Cd=["immersive-ar","immersive-vr","inline"];function qA(s=Cd,e){if(typeof navigator>"u"||s===!1)return;s===!0&&(s=Cd);const t=async()=>{for(const i of s)await navigator.xr?.isSessionSupported(i)&&e(i)};return navigator.xr?.addEventListener("sessiongranted",t),()=>navigator.xr?.removeEventListener("sessiongranted",t)}function ZA(s,e,t){let i;return n=>{if(i?.(),n==null)return{};const r=[];let o;const a=()=>{o=void 0,s.setState({inputSourceStates:e(n,s.getState().inputSourceStates,r)}),r.length=0},c=(g,y)=>{r.push({isPrimary:g,added:y.added,removed:y.removed}),o==null&&(t?o=setTimeout(a,100):a())},l=c.bind(null,!0);n.addEventListener("inputsourceschange",l);let u;if(t){const g=c.bind(null,!1);n.addEventListener("trackedsourceschange",g),u=()=>n.removeEventListener("trackedsourceschange",g)}const h=()=>s.setState({frameRate:n.frameRate,visibilityState:n.visibilityState});n.addEventListener("frameratechange",h),n.addEventListener("visibilitychange",h);const f=()=>{i?.(),i=void 0,s.setState({emulator:s.getState().emulator,...$p})};n.addEventListener("end",f);const m=[{isPrimary:!0,added:n.inputSources}];t&&m.push({isPrimary:!1,added:n.trackedSources});const p=e(n,[],m);return i=()=>{u?.(),clearTimeout(o),e(n,s.getState().inputSourceStates,"remove-all"),n.removeEventListener("end",f),n.removeEventListener("frameratechange",h),n.removeEventListener("visibilitychange",h),n.removeEventListener("inputsourceschange",l)},{inputSourceStates:p,frameRate:n.frameRate,visibilityState:n.visibilityState,detectedMeshes:[],detectedPlanes:[],mode:n.environmentBlendMode==="opaque"?"immersive-vr":"immersive-ar",session:n,mediaBinding:typeof XRMediaBinding>"u"?void 0:new XRMediaBinding(n)}}}function eS(s,e,t){const i=t.getReferenceSpace(),{detectedMeshes:n,detectedPlanes:r,session:o,inputSourceStates:a}=s.getState();if(i==null||o==null)return;const c=Rd(r,e.detectedPlanes),l=Rd(n,e.detectedMeshes);(r!=c||n!=l)&&s.setState({detectedPlanes:c,detectedMeshes:l});const u=a.length;for(let h=0;h<u;h++){const f=a[h];switch(f.type){case"controller":$S(f);break;case"hand":J9(f,e,t);break}}}const tS=[];function Rd(s,e){return e==null?tS:s!=null&&iS(e,s)?s:Array.from(e)}function iS(s,e){if(s.size!=e.length)return!1;for(const t of e)if(!s.has(t))return!1;return!0}new wi;new Qt;async function Vp(s,e=US){const{scene:t}=await e.loadAsync(s.assetPath);return t.clone(!0)}function nS(s,e){s.renderOrder=e?.renderOrder??0,s.traverse(t=>{t instanceof oe&&t.material instanceof af&&(t.material.colorWrite=e?.colorWrite??!0)})}function sS(s,e,t){const i=[];for(const n in e.components){const r=e.components[n];let o=t[n];o==null&&(t[n]=o={state:"default"}),i.push(...Object.values(r.visualResponses).map(a=>rS(s,o,a)))}return()=>{const n=i.length;for(let r=0;r<n;r++)i[r]()}}function rS(s,e,t){const i=s.getObjectByName(t.valueNodeName);if(e.object=i,i==null)return()=>{};if(t.valueNodeProperty==="visibility")return()=>i.visible=t.states.includes(e.state);const n=s.getObjectByName(t.minNodeName),r=s.getObjectByName(t.maxNodeName);return n==null||r==null?()=>{}:()=>{const o=oS(e,t);i.quaternion.slerpQuaternions(n.quaternion,r.quaternion,o),i.position.lerpVectors(n.position,r.position,o),i.updateMatrix()}}function oS(s,{componentProperty:e,states:t}){const i=t.includes(s.state);switch(e){case"xAxis":return i?wd(s).x:.5;case"yAxis":return i?wd(s).y:.5;case"button":return i?s.button??0:0;case"state":return i?1:0}}const Jn=new de;function wd({xAxis:s=0,yAxis:e=0}){if(Jn.lengthSq()>1){const i=Math.atan2(e,s);Jn.set(Math.cos(i),Math.sin(i))}else Jn.set(s,e);return Jn.multiplyScalar(.5).addScalar(.5),Jn}function Id(s,e){if(e!=null&&e.createdAt!=null&&e.createdAt>=s.lastChangedTime)return e;const t=new Zt;return t.setIndex(new fi(s.indices,1)),t.setAttribute("position",new fi(s.vertices,3)),Object.assign(t,{creationTime:s.lastChangedTime})}function _d(s,e){return e!=null&&e.createdAt!=null&&e.createdAt>=s.lastChangedTime?e:Object.assign(aS(s.polygon),{createdAt:s.lastChangedTime})}const qn=new g1,mr=new de;function aS(s){if(s.length===0)return new Zt;const e=new rf,t=s.map(({x:n,z:r})=>new de(n,r));qn.setFromPoints(t),qn.getSize(mr);for(const n of t)n.sub(qn.min),n.divide(mr);e.setFromPoints(t);const i=new y1(e);return i.scale(mr.x,mr.y,1),i.translate(qn.min.x,qn.min.y,0),i.rotateX(Math.PI/2),i}function Li(s,e=1){if(s!=null)return{x:ji(s.x),y:ji(s.y),z:ji(s.z),w:"w"in s?ji(s.w,e):e}}function ji(s,e=0){return isNaN(s)?e:s}const mc=60/180*Math.PI,jp=60/180*Math.PI,Wp=-30/180*Math.PI,Xp=30/180*Math.PI;function lS(s,e,t,i,n,r,o){return s instanceof HTMLVideoElement?cS(s,e,t,n,r,o):uS(s,e.origin,t,i,n,r,o)}function cS(s,e,t,i,{invertStereo:n,layout:r,shape:o="quad"},a={}){const c=fo(i,e.origin,t,kn),l=pc(kn,en),u={invertStereo:n,layout:r,space:c,transform:l};yc(o,u,a.centralAngle,en);const h=`create${Yp(o)}Layer`,f=e.mediaBinding?.[h](s,u);if(f!=null)return gc(f,a),f}function uS(s,e,t,i,n,{shape:r="quad",...o},a={}){const c=fo(n,e,t,kn),l=pc(kn,en),u={...o,isStatic:!(s instanceof Ze),textureType:"texture",viewPixelWidth:o.layout==="stereo-left-right"?s.width/2:s.width,viewPixelHeight:o.layout==="stereo-top-bottom"?s.height/2:s.height,space:c,transform:l};yc(r,u,a.centralAngle,en);const h=`create${Yp(r)}Layer`,f=i.getBinding()?.[h](u);if(f!=null)return gc(f,a),f}const kn=new re,Ld=new _,Pd=new ue,en=new _;function pc(s,e=en){return s.decompose(Ld,Pd,e),e.x=ji(e.x),e.y=ji(e.y),e.z=ji(e.z),new XRRigidTransform(Li(Ld),Li(Pd))}const hS=64/Math.PI;function za(s){return Math.ceil(s*hS)}function dS(s,e,t,i){if(t!=null&&i!=null){const n=s.xr.getBinding().getSubImage(t.layer,i);s.setRenderTargetTextures(e,n.colorTexture)}s.setRenderTarget(e)}function fS(s,e){switch(s){case"cylinder":const t=e.centralAngle??mc;return new wt(1,1,1,za(t),1,!0,Math.PI-t/2,t).scale(-1,1,1);case"equirect":{const i=e.centralHorizontalAngle??jp,n=e.upperVerticalAngle??Xp,r=e.lowerVerticalAngle??Wp,o=n-r;return new Yr(1,za(i),za(o),-Math.PI/2-i/2,i,Math.PI/2-n,o).scale(-1,1,1)}case"quad":return new Qt}}function Yp(s){return`${s[0].toUpperCase()}${s.slice(1)}`}function gc(s,e={}){if(s.chromaticAberrationCorrection=e.chromaticAberrationCorrection,s.quality=e.quality??"default",s.blendTextureSourceAlpha=e.blendTextureSourceAlpha??!1,s instanceof XRCylinderLayer){s.centralAngle=e?.centralAngle??mc;return}s instanceof XREquirectLayer&&(s.centralHorizontalAngle=e?.centralHorizontalAngle??jp,s.lowerVerticalAngle=e?.lowerVerticalAngle??Wp,s.upperVerticalAngle=e?.upperVerticalAngle??Xp)}function mS(s,e,t,i){let n=!1;const r=async()=>{const o=await e.requestFrame();n||yS(s,t,o,i)};return t.addEventListener("redraw",r),r(),()=>{n=!0,t.removeEventListener("redraw",r)}}async function pS(s){if(s instanceof HTMLImageElement&&!s.complete&&await new Promise(e=>{const t=()=>{e(),s.removeEventListener("load",t)};s.addEventListener("load",t)}),s instanceof HTMLVideoElement&&s.readyState<1)return new Promise(e=>{const t=()=>{e(),s.removeEventListener("loadedmetadata",t)};s.addEventListener("loadedmetadata",t)})}function gS(s){if(s instanceof Ze)return s.texture;const e=s instanceof HTMLVideoElement?new qd(s):new Pn(s);return e.colorSpace=Zd,e.needsUpdate=!0,e}function yS(s,e,t,i){const n=s.getContext(),r=s.xr.getBinding().getSubImage(e,t);s.state.bindTexture(n.TEXTURE_2D,r.colorTexture),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!0),n.texSubImage2D(n.TEXTURE_2D,0,0,0,i.width,i.height,n.RGBA,n.UNSIGNED_BYTE,i)}function vS(s,e,t,i){s.originReferenceSpace!=null&&(e.space=fo(i,s.origin,s.originReferenceSpace,kn),e.transform=pc(kn,en),yc(xS(e),e,t,en))}function yc(s,e,t,i){if(s==="cylinder"){const r=(i.x+i.z)/2,o=r*(t??mc);e.radius=r,e.aspectRatio=i.y===0?1:o/i.y}else s==="quad"?(e.width=i.x/2,e.height=i.y/2):e.radius=(i.x+i.y+i.z)/3}function xS(s){return s instanceof XRCylinderLayer?"cylinder":s instanceof XREquirectLayer?"equirect":"quad"}function Qp(s,e,t){return new Ze(s*t,e*t,{minFilter:Ji,magFilter:Ji,type:tn,depthTexture:new bl(s,e)})}function ES(s,e,t){s.traverse(n=>n.userData.teleportTarget=!0);const i=n=>{if("point"in n&&n.point instanceof _){const r=typeof e=="function"?e():e,o=new _().setFromMatrixPosition(r.matrix).negate().setComponent(1,0).add(n.point);t(o,n)}};return s.addEventListener("pointerup",i),()=>{s.traverse(n=>n.userData.teleportTarget=!1),s.removeEventListener("pointerup",i)}}const Zn=new pi(0,0,0,"YXZ"),pr=new ue;function AS(s,e,t){s.updateWorldMatrix(!0,!1),s.matrixWorld.decompose(e.position,pr,e.scale),Zn.setFromQuaternion(pr),Zn.z=0,Zn.x=Sr(Zn.x-10*Math.PI/180,-Math.PI/2,1.1*Math.PI/4),pr.setFromEuler(Zn),e.quaternion.slerp(pr,t/100)}function SS(s){return s.userData.teleportTarget===!0}function TS(s={}){return(e,t,i,n)=>!(!SS(e)||s.filter!=null&&!s.filter(e,t,i,n))}function bS(){return new Vd(new _(0,0,0),new _(0,0,-8),new _(0,-20,-15)).getPoints(20)}let CS=class extends oe{multiplier;lineLengths;options={};constructor(e){const t=new vf,i=new Float32Array(e.length*3);for(let o=0;o<e.length;o++)e[o].toArray(i,o*3);t.setPoints(i);const n=(e.length*3-3)/(e.length*3-1),r=new xf({lineWidth:.1,resolution:void 0,visibility:n});super(t,r),this.material.transparent=!0,this.multiplier=n,this.material=r,this.lineLengths=e.slice(0,-1).map((o,a)=>o.distanceTo(e[a+1]))}update(e){const t=e.getEnabled(),i=e.getIntersection();if(!t||e.getButtonsDown().size===0||i==null){this.visible=!1;return}if(this.visible=!0,i.details.type!="lines"){this.material.visibility=this.multiplier;return}const{distanceOnLine:n,lineIndex:r}=i.details,o=this.lineLengths[r];this.material.visibility=this.multiplier*(r+n/o)/this.lineLengths.length;const{color:a="white",opacity:c=.4,size:l=.01}=this.options;this.material.lineWidth=l,this.material.opacity=typeof c=="function"?c(e):c;const u=typeof a=="function"?a(e):a;Array.isArray(u)?this.material.color.set(...u):this.material.color.set(u)}};const Md=new re,gr=new _,RS=new _,Dd=new ue;async function vc(s,e,t,i=["point","plane","mesh"]){typeof t=="string"&&(t=await e.requestReferenceSpace(t));const n=Array.isArray(i)?i:[i];let r,o,a;const c=s.getState();if(t instanceof XRSpace)r={space:t,entityTypes:n},a=c.origin;else{const u=fo(t,c.origin,c.originReferenceSpace,Md);if(u==null)return;Md.decompose(gr,Dd,RS);const h=Li(gr);gr.set(0,0,-1).applyQuaternion(Dd);const f=new XRRay(h,Li(gr,0));a=t,r={space:u,offsetRay:f,entityTypes:n},o=u}const l=await e?.requestHitTestSource?.(r);if(l!=null)return{source:l,getWorldMatrix:wS.bind(null,s,o,a)}}async function Jp(s,e,t){const i=s.getState().session;if(i==null)return;const n=await vc(s,i,e,t);if(n==null)return;const{source:r,getWorldMatrix:o}=n,c=(await s.requestFrame()).getHitTestResults?.(r)??[];if(r.cancel(),c!=null)return{results:c,getWorldMatrix:o}}function wS(s,e,t,i,n){if(e??=s.getState().originReferenceSpace,e==null)return!1;const r=n.getPose(e);return r==null?!1:(i.fromArray(r.transform.matrix),t!=null&&(t.updateWorldMatrix(!0,!1),i.premultiply(t.matrixWorld)),!0)}const IS=new _(1,1,1),_S=new _(0,0,0),LS=new ue,Bd=new re,Fd=new re,yr=new ue,vr=new _,PS=new _;async function xc(s,e){if(e.relativeTo==="hit-test-result")return e.hitTestResult.createAnchor?.(new XRRigidTransform(Li(e.offsetPosition),Li(e.offsetQuaternion)));let t,i;if(e.relativeTo==="world"){t=e.frame??await s.requestFrame();const{origin:n,originReferenceSpace:r}=s.getState();if(r==null)return;i=r;const{worldPosition:o,worldQuaternion:a}=e;n!=null?(n.updateWorldMatrix(!0,!1),Bd.copy(n.matrixWorld).invert(),Fd.compose(o,a,IS).multiply(Bd),Fd.decompose(vr,yr,PS)):(vr.copy(o),yr.copy(a))}else{t=e.frame??await s.requestFrame(),i=e.space;const{offsetPosition:n,offsetQuaternion:r}=e;vr.copy(n??_S),yr.copy(r??LS)}return t.createAnchor?.(new XRRigidTransform(Li(vr),Li(yr)),i)}const MS=2,DS=2,BS=45,kd=.5,Od="xr-standard-thumbstick",En=new _,Nd=new ue,FS=new pi,kS=new _,OS=new _;function NS(){let s=!0;return(e,t,i,n,r={},o={},a="left",...c)=>{const{inputSourceStates:l}=t.getState(),u=a==="left"?"right":"left",h=l.find(x=>Ud(x,a)),f=l.find(x=>Ud(x,u));if(h==null||f==null)return;const m=h.gamepad[Od],p=m?.xAxis??0,g=m?.yAxis??0,y=f.gamepad[Od]?.xAxis??0;let v;o!==!1&&(o===!0&&(o={}),o.type==="smooth"?Math.abs(y)>(o.deadZone??kd)&&(v=(y<0?-1:1)*n*(o.speed??DS)):Math.abs(y)<(o.deadZone??kd)?s=!0:s&&(s=!1,v=(y>0?-1:1)*me.degToRad(o.degrees??BS)));const E=p!=0||g!=0;if(r!==!1&&E){r===!0&&(r={});const{speed:x=MS}=r;En.set(p*x,0,g*x),i.matrixWorld.decompose(kS,Nd,OS),En.applyQuaternion(Nd),v&&En.applyEuler(FS.set(0,v,0,"YXZ"))}if(!(!E&&v==null)){if(typeof e=="function"){e(En,v??0,...c);return}e!=null&&(e.position.x+=En.x*n,e.position.z+=En.z*n,e.rotation.y+=v??0)}}}function Ud(s,e){return s.type==="controller"&&s.inputSource.handedness===e}const US=new Cf,qp="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/";function vl(s,...e){let t=s();for(const i of e)t instanceof Promise?t=t.then(i):t=i(t);return t}const zS="generic-trigger";class Zp{baseAssetPath;defaultProfileId;profilesListCache;profileCacheMap=new Map;constructor(e){this.baseAssetPath=e?.baseAssetPath??qp,this.defaultProfileId=e?.defaultControllerProfileId??zS}load(e,t){return vl(()=>this.loadProfile(e),i=>{for(const n in i.layouts)if(n.includes(t))return i.layouts[n];throw new Error(`No matching layout for "${t}", in profile ${i.profileId} with layouts ${Object.keys(i.layouts).join(", ")}.`)})}loadAsync=this.load;loadProfile(e){return vl(()=>this.profilesListCache??zd(new URL("profilesList.json",this.baseAssetPath).href).then(t=>this.profilesListCache=t),t=>{const i=e.length;let n;for(let r=0;r<i&&(n=t[e[r]],n==null);r++);if(n??=t[this.defaultProfileId],n==null)throw new Error(`no matching profile found for profiles "${e.join(", ")}" in profile list ${JSON.stringify(t)}`);return this.loadProfileFromPath(n.path)})}loadProfileFromPath(e){const t=this.profileCacheMap.get(e);if(t!=null)return t;const i=new URL(e,this.baseAssetPath).href;return zd(i).then(n=>{for(const r in n.layouts){const o=n.layouts[r];o!=null&&(o.assetPath=new URL(o.assetPath,i).href)}return this.profileCacheMap.set(e,n),n})}}async function zd(s){let e=await fetch(s);return e.ok?e.json():Promise.reject(new Error(e.statusText))}function GS(s,e,t,i,n){return vl(()=>t.load(e.profiles,e.handedness),r=>{const o={};return Rp(o,e,r),{id:s,isPrimary:n,events:i,type:"controller",inputSource:e,gamepad:o,layout:r}})}function $S({gamepad:s,inputSource:e,layout:t}){Rp(s,e,t)}const yo=d.createContext(void 0),Ni=d.createContext(void 0),Cs=d.createContext(void 0),Ec=d.createContext(void 0);function Rs(s,e){if(Object.is(s,e))return!0;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return!1;if(s instanceof Map&&e instanceof Map){if(s.size!==e.size)return!1;for(const[i,n]of s)if(!Object.is(n,e.get(i)))return!1;return!0}if(s instanceof Set&&e instanceof Set){if(s.size!==e.size)return!1;for(const i of s)if(!e.has(i))return!1;return!0}const t=Object.keys(s);if(t.length!==Object.keys(e).length)return!1;for(const i of t)if(!Object.prototype.hasOwnProperty.call(e,i)||!Object.is(s[i],e[i]))return!1;return!0}const HS=d.forwardRef(({id:s,children:e,onPress:t,onRelease:i},n)=>{const r=At("controller"),[o,a]=d.useState(void 0);if(d.useImperativeHandle(n,()=>o,[o]),eg(r,s,c=>c==="pressed"?t?.():i?.()),ee(()=>a(r.gamepad[s]?.object)),o!=null)return Ei(e,o)});function eg(s,e,t){const i=d.useRef(void 0);ee(()=>{const n=s?.gamepad[e]?.state;n!=null&&n!=i.current&&t(n),i.current=n})}const tg=Symbol("loadXRControllerModel"),ig=d.forwardRef((s,e)=>{const t=At("controller"),i=Gt(Vp,[t.layout,void 0,tg]);nS(i,s),t.object=i,d.useImperativeHandle(e,()=>i,[i]);const n=d.useMemo(()=>sS(i,t.layout,t.gamepad),[i,t.layout,t.gamepad]);return ee(n),Y.jsx(Ft,{space:"grip-space",children:Y.jsx("primitive",{object:i})})}),KS=Symbol("loadXRControllerLayout");function VS(s,e,{baseAssetPath:t,defaultControllerProfileId:i}={}){const n=d.useMemo(()=>new Zp({baseAssetPath:t,defaultControllerProfileId:i}),[t,i]);return Gt(()=>{const r=n.loadAsync(s,e);return r instanceof Promise?r:Promise.resolve(r)},[KS,e,...s])}function jS(s){return Gt(Vp,[s,void 0,tg])}const ng=d.forwardRef((s,e)=>{const t=At("hand"),i=je(Cf,t.assetPath),n=d.useMemo(()=>X9(i),[i]);Y9(n,s),t.object=n,d.useImperativeHandle(e,()=>n,[n]);const r=To(),o=d.useMemo(()=>Z9(t.inputSource.hand,n,r),[t.inputSource,n,r]);return ee((a,c,l)=>o(l)),Y.jsx("primitive",{object:n})}),WS=d.forwardRef(({joint:s,children:e},t)=>Y.jsx(Ft,{ref:t,space:s,children:e}));function Ac({children:s}){const e=d.useMemo(()=>new Up(!1),[]);return Is(e),Y.jsx(Ec.Provider,{value:e,children:s})}function vo(s){for(const e of Object.keys(s))delete s[e]}function sg(s,e,t,i){const n=d.useMemo(()=>({}),[]);vo(n),Object.assign(n,t);const r=ki(),o=d.useMemo(()=>OA(()=>r.getState().camera,s,e,n,i),[r,s,e,n,i]);return Is(o,t?.makeDefault),o}function rg(s,e,t,i){const n=d.useMemo(()=>({}),[]);vo(n),Object.assign(n,t);const r=ki(),o=d.useMemo(()=>NA(()=>r.getState().camera,s,e,n,i),[r,s,e,n,i]);return Is(o,t?.makeDefault),o}function og(s,e,t,i){const n=d.useMemo(()=>({}),[]);vo(n),Object.assign(n,t);const r=ki(),o=d.useMemo(()=>UA(()=>r.getState().camera,s,e,n,i),[r,s,e,n,i]);return Is(o,t?.makeDefault),o}function ag(s,e,t,i){const n=d.useMemo(()=>({}),[]);vo(n),Object.assign(n,t);const r=ki(),o=d.useMemo(()=>zA(()=>r.getState().camera,s,e,n,i),[r,s,e,n,i]);return Is(o,t?.makeDefault),o}const lg=d.forwardRef((s,e)=>{const t=d.useMemo(()=>{const n=s.materialClass??aA;return new n},[s.materialClass]),i=d.useRef(null);return d.useImperativeHandle(e,()=>i.current,[]),ee(()=>i.current!=null&&lA(i.current,t,s.pointer,s)),Y.jsx("mesh",{matrixAutoUpdate:!1,renderOrder:s.renderOrder??2,ref:i,material:t,children:Y.jsx("boxGeometry",{})})}),ws=d.forwardRef((s,e)=>{const t=d.useMemo(()=>{const o=s.materialClass??sA;return new o},[s.materialClass]),i=d.useRef(null),n=d.useRef(null);d.useImperativeHandle(e,()=>i.current,[]),ee(()=>i.current!=null&&n.current!=null&&oA(n.current,i.current,t,s.pointer,s));const r=H(o=>o.scene);return Y.jsxs(Y.Fragment,{children:[Y.jsx("group",{ref:n}),Ei(Y.jsx("mesh",{renderOrder:s.renderOrder??1,ref:i,matrixAutoUpdate:!1,material:t,children:Y.jsx("planeGeometry",{})}),r)]})});function xo(s,e,t,i){const n=Ie(r=>r.session);d.useEffect(()=>{if(n!=null)return uA(s,n,e,t,i)},[t,e,s,n,i])}function Is(s,e=!1){const t=d.useContext(Ec);if(t==null)throw new Error("xr pointers can only be used inside the XR component");d.useEffect(()=>{const i=t.register(s,e);return()=>{i()}},[t,s,e]),d.useEffect(()=>{if(s instanceof Un)return()=>s.exit({timeStamp:performance.now()})},[s])}function XS({children:s,onTeleport:e}){const t=d.useRef(null),i=d.useRef(e);i.current=e;const n=ki();return d.useEffect(()=>{if(t.current!=null)return ES(t.current,()=>n.getState().camera,(r,o)=>i.current?.(r,o))},[n]),Y.jsx("group",{pointerEventsType:{allow:"teleport"},ref:t,children:s})}const cg=d.forwardRef(({pointer:s,linePoints:e,...t},i)=>{const n=d.useMemo(()=>new CS(e),[e]);return d.useImperativeHandle(i,()=>n,[n]),n.options=t,ee(()=>n.update(s)),Y.jsx("primitive",{object:n})});function ug(s,e,t){const i=d.useContext(Ni);if(i==null)throw new Error("DefaultXRInputSourceGrabPointer can only be used inside a XRInputSource");const n=d.useRef(null),r=sg(n,i,t);xo(r,i.inputSource,s,i.events);const o=t.cursorModel;return Y.jsx(Ft,{ref:n,space:e,children:o!==!1&&Y.jsx(ws,{pointer:r,opacity:_p,...lt(o)})})}const hg=ug.bind(null,"select","index-finger-tip"),dg=ug.bind(null,"squeeze","grip-space");function zn(s){const e=At(),t=d.useRef(null),i=rg(t,e,s);xo(i,e.inputSource,"select",e.events);const n=s.rayModel,r=s.cursorModel;return Y.jsxs(Ft,{ref:t,space:"target-ray-space",children:[n!==!1&&Y.jsx(lg,{pointer:i,opacity:vs,...lt(n)}),r!==!1&&Y.jsx(ws,{pointer:i,opacity:vs,...lt(r)})]})}function fg(s){const e=At("hand"),t=d.useRef(null),i=ag(t,e,s),n=s.cursorModel;return Y.jsx(Ft,{ref:t,space:e.inputSource.hand.get("index-finger-tip"),children:n!==!1&&Y.jsx(ws,{pointer:i,opacity:Lp,...lt(n)})})}function mg(s){const e=s.model,t=s.grabPointer,i=s.rayPointer,n=s.teleportPointer??!1;return Y.jsxs(Y.Fragment,{children:[e!==!1&&Y.jsx(d.Suspense,{children:Y.jsx(ig,{...lt(e)})}),Y.jsxs(Ac,{children:[t!==!1&&Y.jsx(dg,{...lt(t)}),i!==!1&&Y.jsx(zn,{makeDefault:!0,minDistance:.2,...lt(i)}),n!==!1&&Y.jsx(Sc,{...lt(n)})]})]})}function pg(s){const e=s.model,t=s.grabPointer,i=s.rayPointer,n=s.touchPointer,r=s.teleportPointer??!1,o=i===!1?!1:lt(i)?.rayModel;return Y.jsxs(Y.Fragment,{children:[e!==!1&&Y.jsx(d.Suspense,{children:Y.jsx(ng,{...lt(e)})}),Y.jsxs(Ac,{children:[t!==!1&&Y.jsx(hg,{...lt(t)}),n!==!1&&Y.jsx(fg,{...lt(n)}),i!==!1&&Y.jsx(zn,{makeDefault:!0,minDistance:.2,...lt(i),rayModel:o===!1?!1:{maxLength:.2,...lt(o)}}),r!==!1&&Y.jsx(Sc,{...lt(r)})]})]})}function gg(s){return Y.jsx(zn,{...s,rayModel:!1})}function yg(s){return Y.jsx(zn,{...s,rayModel:!1})}function vg(s){return Y.jsx(zn,{...s,cursorModel:!1,rayModel:!1})}function Sc(s){const e=d.useContext(Ni);if(e==null)throw new Error("DefaultXRInputSourceRayPointer can only be used inside a XRInputSource");const t=d.useRef(null),i=d.useRef(null),n=d.useMemo(()=>bS(),[]),r=og(i,e,{...s,linePoints:n,filter:TS(s)},"teleport");xo(r,e.inputSource,"select",e.events);const o=s.rayModel,a=s.cursorModel,c=H(u=>u.scene),l=d.useRef(null);return ee((u,h)=>{l.current!=null&&(l.current.visible=r.getEnabled()&&r.getButtonsDown().size>0);const f=i.current,m=t.current;f==null||m==null||AS(m,f,h*1e3)}),Y.jsxs(Y.Fragment,{children:[Y.jsx(Ft,{ref:t,space:"target-ray-space"}),Ei(Y.jsxs("group",{ref:i,children:[o!==!1&&Y.jsx(cg,{linePoints:n,pointer:r,opacity:vs,...lt(o)}),a!==!1&&Y.jsx(ws,{ref:l,pointer:r,opacity:vs,...lt(a)})]}),c)]})}function lt(s){if(s!==!0)return s}function YS(s,e){let t,i;if(e==null){const[n,r]=d.useState(!1);t=r,i=n}else t=e;return d.useEffect(()=>{const{current:n}=s;if(n==null)return;const r=new Set,o=c=>{r.size===0&&t(!0,c),r.add(c.pointerId)},a=c=>{r.delete(c.pointerId),r.size===0&&t(!1,c)};return n.addEventListener("pointerenter",o),n.addEventListener("pointerleave",a),()=>{n.removeEventListener("pointerenter",o),n.removeEventListener("pointerleave",a)}},[s,t]),i}function Eo(){return Ie(s=>s.visibilityState)}function QS(){return Ie(s=>s.session?.initiateRoomCapture?.bind(s.session))}function _s(s,e){const t=d.useRef(e);t.current=e;const[i,n]=d.useMemo(()=>{let r;return[o=>{let a=!1;return typeof navigator>"u"||navigator.xr==null?(r=!1,()=>{}):(navigator.xr.isSessionSupported(s).then(c=>{r=c,!a&&o()}).catch(c=>{a||t.current?.(c)}),()=>a=!0)},()=>r]},[s]);return d.useSyncExternalStore(i,n)}const JS=_s;function Tc(s){return Ie(({session:e})=>e?.enabledFeatures?.includes(s)??!1)}const qS=Tc;let ZS=0;const Gd=new Map;function Ao(s){let e=Gd.get(s);return e==null&&Gd.set(s,e=ZS++),e}function e7({children:s}){const e=Ie(o=>o.originReferenceSpace),t=Ie(o=>o.origin),i=Eo()==="visible",n=ki(),r=d.useMemo(()=>Object.assign({},n,{getState(){return{...n.getState(),scene:t}}}),[t,n]);return t==null||e==null?null:Y.jsx(Y.Fragment,{children:pf.createPortal(Y.jsx(us.Provider,{value:n,children:Y.jsxs(Cs.Provider,{value:e,children:[Y.jsxs("group",{matrixAutoUpdate:!1,visible:i,children:[Y.jsx(t7,{}),Y.jsx(i7,{}),Y.jsx(n7,{}),Y.jsx(s7,{}),Y.jsx(r7,{})]}),s]})}),r,null)})}function t7(){const s=Ie(t=>t.inputSourceStates.filter(i=>i.type==="controller"),Rs);let e=Ie(t=>t.controller);return e===!1?null:Y.jsx(Y.Fragment,{children:s.map(t=>{const i=Ln(e,t.inputSource.handedness,{});return i===!1?null:Y.jsx(Ni.Provider,{value:t,children:Y.jsx(Ft,{space:"target-ray-space",children:Y.jsx(d.Suspense,{children:typeof i=="function"?Y.jsx(i,{}):Y.jsx(mg,{...i})})})},t.id)})})}function i7(){const s=Ie(t=>t.inputSourceStates.filter(i=>i.type==="hand"),Rs),e=Ie(t=>t.hand);return e===!1?null:Y.jsx(Y.Fragment,{children:s.map(t=>{const i=Ln(e,t.inputSource.handedness,{});return i===!1?null:Y.jsx(Ni.Provider,{value:t,children:Y.jsx(Ft,{space:"target-ray-space",children:Y.jsx(d.Suspense,{children:typeof i=="function"?Y.jsx(i,{}):Y.jsx(pg,{...i})})})},Ao(t))})})}function n7(){const s=Ie(t=>t.inputSourceStates.filter(i=>i.type==="transientPointer"),Rs),e=Ie(t=>t.transientPointer);return e===!1?null:Y.jsx(Y.Fragment,{children:s.map(t=>{const i=Ln(e,t.inputSource.handedness,{});return i===!1?null:Y.jsx(Ni.Provider,{value:t,children:Y.jsx(Ft,{space:"target-ray-space",children:Y.jsx(d.Suspense,{children:typeof i=="function"?Y.jsx(i,{}):Y.jsx(gg,{...i})})})},Ao(t))})})}function s7(){const s=Ie(t=>t.inputSourceStates.filter(i=>i.type==="gaze"),Rs),e=Ie(t=>t.gaze);return e===!1?null:Y.jsx(Y.Fragment,{children:s.map(t=>Y.jsx(Ni.Provider,{value:t,children:Y.jsx(Ft,{space:"target-ray-space",children:Y.jsx(d.Suspense,{children:typeof e=="function"?Y.jsx(e,{}):Y.jsx(yg,{...xg(e)})})})},Ao(t)))})}function r7(){const s=Ie(t=>t.inputSourceStates.filter(i=>i.type==="screenInput"),Rs),e=Ie(t=>t.screenInput);return e===!1?null:Y.jsx(Y.Fragment,{children:s.map(t=>Y.jsx(Ni.Provider,{value:t,children:Y.jsx(Ft,{space:"target-ray-space",children:Y.jsx(d.Suspense,{children:typeof e=="function"?Y.jsx(e,{}):Y.jsx(vg,{...xg(e)})})})},Ao(t)))})}function xg(s){if(s!==!0)return s}function Eg(s){return QA(s)}function o7({children:s,store:e}){e.setWebXRManager(H(i=>i.gl.xr));const t=ki();return d.useEffect(()=>{let i;return e.subscribe((n,r)=>{if(n.session!==r.session){if(n.session!=null){const{camera:o,gl:a}=t.getState();i=o,t.setState({camera:a.xr.getCamera()});return}i!=null&&t.setState({camera:i})}})},[t,e]),ee((i,n,r)=>e.onBeforeFrame(i.scene,i.camera,r),-1e3),ee(()=>e.onBeforeRender()),Y.jsx(yo.Provider,{value:e,children:Y.jsxs(Ag,{children:[Y.jsx(e7,{}),s]})})}function a7({children:s}){const e=d.useMemo(()=>Eg(),[]);return Y.jsx(yo.Provider,{value:e,children:s})}function Ag({children:s}){const e=Ai(),t=d.useMemo(()=>new Up(!0),[]);return d.useEffect(()=>nA(e,i=>t.setEnabled(i,{timeStamp:performance.now()})),[e,t]),ee(i=>t.move(i.scene,{timeStamp:performance.now()}),-50),Y.jsx(Ec.Provider,{value:t,children:s})}function Ai(){const s=d.useContext(yo);if(s==null)throw new Error("XR features can only be used inside the <XR> component");return s}function l7(){return d.useContext(yo)}function Ie(s=t=>t,e){return ho(Ai(),s,e)}function c7(){return Ie(s=>s.inputSourceStates)}function So(s,e){return Ie(t=>t.inputSourceStates.find(i=>i.type===s&&(e==null||i.inputSource.handedness===e)))}function At(s){const e=d.useContext(Ni);if(e==null)throw new Error("useXRInputSourceStateContext() can only be used inside the xr store config");if(s!=null&&e.type!=s)throw new Error(`useXRInputSourceStateContext(${s}) can not be used inside a component for input type "${e.type}"`);return e}function u7(s,e,t,i){const n=Ie(r=>r.session);d.useEffect(()=>{if(!(n==null||s==null))return cA(n,s,e,t)},[e,s,n,...i])}const Ft=d.forwardRef(({space:s,children:e},t)=>{const i=d.useRef(null),n=typeof s=="string"?To(s):s;d.useImperativeHandle(t,()=>i.current,[]),Tg(i,n);const r=d.useCallback(o=>{o!=null&&(o.transformReady=!1,o.visible=!1),i.current=o},[]);return Y.jsx("group",{xrSpace:n,matrixAutoUpdate:!1,ref:r,children:n&&Y.jsx(Cs.Provider,{value:n,children:e})})});function To(s){switch(s){case"grip-space":return At().inputSource.gripSpace;case"target-ray-space":return At().inputSource.targetRaySpace;case"wrist":case"thumb-metacarpal":case"thumb-phalanx-proximal":case"thumb-phalanx-distal":case"thumb-tip":case"index-finger-metacarpal":case"index-finger-phalanx-proximal":case"index-finger-phalanx-intermediate":case"index-finger-phalanx-distal":case"index-finger-tip":case"middle-finger-metacarpal":case"middle-finger-phalanx-proximal":case"middle-finger-phalanx-intermediate":case"middle-finger-phalanx-distal":case"middle-finger-tip":case"ring-finger-metacarpal":case"ring-finger-phalanx-proximal":case"ring-finger-phalanx-intermediate":case"ring-finger-phalanx-distal":case"ring-finger-tip":case"pinky-finger-metacarpal":case"pinky-finger-phalanx-proximal":case"pinky-finger-phalanx-intermediate":case"pinky-finger-phalanx-distal":case"pinky-finger-tip":return At("hand").inputSource.hand.get(s);case"root":case"hips":case"spine-lower":case"spine-middle":case"spine-upper":case"chest":case"neck":case"head":case"left-shoulder":case"left-scapula":case"left-arm-upper":case"left-arm-lower":case"left-hand-wrist-twist":case"right-shoulder":case"right-scapula":case"right-arm-upper":case"right-arm-lower":case"right-hand-wrist-twist":case"left-hand-palm":case"left-hand-wrist":case"left-hand-thumb-metacarpal":case"left-hand-thumb-phalanx-proximal":case"left-hand-thumb-phalanx-distal":case"left-hand-thumb-tip":case"left-hand-index-metacarpal":case"left-hand-index-phalanx-proximal":case"left-hand-index-phalanx-intermediate":case"left-hand-index-phalanx-distal":case"left-hand-index-tip":case"left-hand-middle-metacarpal":case"left-hand-middle-phalanx-proximal":case"left-hand-middle-phalanx-intermediate":case"left-hand-middle-phalanx-distal":case"left-hand-middle-tip":case"left-hand-ring-metacarpal":case"left-hand-ring-phalanx-proximal":case"left-hand-ring-phalanx-intermediate":case"left-hand-ring-phalanx-distal":case"left-hand-ring-tip":case"left-hand-little-metacarpal":case"left-hand-little-phalanx-proximal":case"left-hand-little-phalanx-intermediate":case"left-hand-little-phalanx-distal":case"left-hand-little-tip":case"right-hand-palm":case"right-hand-wrist":case"right-hand-thumb-metacarpal":case"right-hand-thumb-phalanx-proximal":case"right-hand-thumb-phalanx-distal":case"right-hand-thumb-tip":case"right-hand-index-metacarpal":case"right-hand-index-phalanx-proximal":case"right-hand-index-phalanx-intermediate":case"right-hand-index-phalanx-distal":case"right-hand-index-tip":case"right-hand-middle-metacarpal":case"right-hand-middle-phalanx-proximal":case"right-hand-middle-phalanx-intermediate":case"right-hand-middle-phalanx-distal":case"right-hand-middle-tip":case"right-hand-ring-metacarpal":case"right-hand-ring-phalanx-proximal":case"right-hand-ring-phalanx-intermediate":case"right-hand-ring-phalanx-distal":case"right-hand-ring-tip":case"right-hand-little-metacarpal":case"right-hand-little-phalanx-proximal":case"right-hand-little-phalanx-intermediate":case"right-hand-little-phalanx-distal":case"right-hand-little-tip":case"left-upper-leg":case"left-lower-leg":case"left-foot-ankle-twist":case"left-foot-ankle":case"left-foot-subtalar":case"left-foot-transverse":case"left-foot-ball":case"right-upper-leg":case"right-lower-leg":case"right-foot-ankle-twist":case"right-foot-ankle":case"right-foot-subtalar":case"right-foot-transverse":case"right-foot-ball":return Ie(n=>n.body)?.get(s)}if(s==null){const n=d.useContext(Cs);if(n==null)throw new Error("XR objects must be placed inside the XROrigin");return n}const[e,t]=d.useState(void 0),i=Ie(n=>n.session);return d.useEffect(()=>{if(i==null)return;let n=!1;return i.requestReferenceSpace(s).then(r=>{n||t(r)}),()=>void(n=!0)},[i,s]),e}function Sg(s){const e=d.useContext(Cs),t=Ie(i=>e??i.originReferenceSpace);return d.useMemo(()=>s==null||t==null?void 0:hA(s,t),[s,t])}function Tg(s,e,t){const i=Sg(e);ee((n,r,o)=>{s.current!=null&&(s.current.visible=s.current.transformReady=i?.(s.current.matrix,o)??!1),t?.(n,r,o)},-100)}const h7=d.forwardRef(({mesh:s,...e},t)=>{const i=bg(s);return Y.jsx("mesh",{ref:t,geometry:i,...e})});function d7(s){const e=Ie(t=>t.detectedMeshes);return d.useMemo(()=>s==null?e:e.filter(t=>t.semanticLabel===s),[e,s])}function bg(s,e=!0){const[t,i]=d.useState(Id(s,void 0));return ee(()=>i(n=>Id(s,n))),d.useEffect(()=>{if(e)return()=>t.dispose()},[t]),t}const f7=d.forwardRef(({plane:s,...e},t)=>{const i=Cg(s);return Y.jsx("mesh",{ref:t,geometry:i,...e})});function m7(s){const e=Ie(t=>t.detectedPlanes);return d.useMemo(()=>s==null?e:e.filter(t=>t.semanticLabel===s),[e,s])}function Cg(s,e=!0){const[t,i]=d.useState(_d(s,void 0));return ee(()=>i(n=>_d(s,n))),d.useEffect(()=>{if(e)return()=>t.dispose()},[t]),t}function Rg(s,e,t,i){const n=H(r=>r.camera);ee(()=>{s.current!=null&&e(XA(n,s.current,t,i))})}function p7({children:s,direction:e,angle:t=Math.PI/2}){const i=d.useRef(null);return Rg(i,n=>{i.current!=null&&(i.current.visible=n)},e,t),Y.jsx("group",{ref:i,children:s})}function g7({children:s,direction:e,angle:t=Math.PI/2}){const i=d.useRef(null),[n,r]=d.useState(!1);return Rg(i,r,e,t),Y.jsx("group",{ref:i,children:n?s:null})}function wg(s,e){const t=Ie(i=>i.mode);return e!=null?Array.isArray(e)?!e.includes(t):e!=t:s!=null?Array.isArray(s)?s.includes(t):s===t:t!==null}function y7({children:s,allow:e,deny:t}){const i=wg(e,t);return Y.jsx("group",{visible:i,children:s})}function v7({children:s,allow:e,deny:t}){return wg(e,t)?Y.jsx(Y.Fragment,{children:s}):null}function x7({children:s,mode:e}){const t=_s(e);return Y.jsx("group",{visible:t,children:s})}function E7({children:s,mode:e}){return _s(e)?Y.jsx(Y.Fragment,{children:s}):null}function A7({children:s}){const e=Eo();return Y.jsx("group",{visible:e==null||e==="visible",children:s})}function S7({children:s}){const e=Eo();return e!="visible"&&e!=null?null:Y.jsx(Y.Fragment,{children:s})}const T7=d.forwardRef(({children:s,disabled:e,...t},i)=>{const n=H(a=>a.gl.xr.getCamera()),r=d.useRef(null),o=Ie(a=>a.originReferenceSpace);return d.useImperativeHandle(i,()=>r.current,[]),d.useEffect(()=>{const a=r.current;if(!(a==null||e))return a.add(n),()=>void a.remove(n)},[e,n]),Y.jsx("group",{ref:r,...t,children:Y.jsx(Cs.Provider,{value:o,children:s})})});function b7(s,e){const[t,i]=d.useState();return _g(s,e,i),t}function Ig(s,e,t){const i=d.useRef(void 0);_g(e,t,d.useCallback(n=>i.current=n,[])),ee((n,r,o)=>{s==null||o==null||i.current==null||s(o.getHitTestResults(i.current.source),i.current.getWorldMatrix)})}function _g(s,e,t){const i=Ai(),n=ho(i,r=>r.session);d.useEffect(()=>{if(n==null)return;let r,o=!1;const a=s instanceof XRSpace||typeof s=="string"?s:s?.current;if(a!=null)return vc(i,n,a,e).then(c=>{o||(r=c,t(c))}),()=>{t(void 0),o=!0,r?.source.cancel()}},[n,i,s,e,t])}function C7(){const s=Ai();return d.useCallback((e,t)=>{const i=e instanceof XRSpace||typeof e=="string"?e:e.current;if(i!=null)return Jp(s,i,t)},[s])}const R7=d.forwardRef(({trackableType:s,onResults:e,space:t,...i},n)=>{const r=d.useRef(null);return d.useImperativeHandle(n,()=>r.current),Ig(e,t??r,s),Y.jsx("group",{...i,ref:r})});function w7(){const s=Ai();return d.useMemo(()=>xc.bind(null,s),[s])}function I7(){const[s,e]=d.useState(void 0),t=d.useRef(()=>{}),i=Ai(),n=d.useCallback(async r=>{t.current?.(),t.current=void 0;let o=!1;t.current=()=>o=!0;const a=await xc(i,r);if(o){a?.delete();return}return t.current=()=>a?.delete(),e(a),a},[i]);return d.useEffect(()=>()=>void t.current?.(),[]),[s,n]}const _7=d.forwardRef((s,e)=>{const t=Ie(r=>r.domOverlayRoot),{In:i,Out:n}=d.useMemo(vp,[]);return d.useEffect(()=>{if(t==null)return;const r=xl.createRoot(t);return r.render(Y.jsx(n,{})),()=>r.unmount()},[t,n]),Y.jsx(i,{children:Y.jsx("div",{...s,ref:e})})}),L7=d.forwardRef(function({src:e,pixelWidth:t=1024,pixelHeight:i=1024,dpr:n=1,renderPriority:r=0,children:o,customRender:a,...c},l){const[u,h]=d.useState(!1),f=d.useRef(null),m=d.useRef(void 0),p=d.useRef(void 0);d.useEffect(()=>{h(!1);let E=!1;return pS(e).then(()=>!E&&h(!0)),()=>void(E=!0)},[e]);const g=Tc("layers"),y=d.useMemo(()=>fS(c.shape??"quad",{centralAngle:c.centralAngle,centralHorizontalAngle:c.centralHorizontalAngle,lowerVerticalAngle:c.lowerVerticalAngle,upperVerticalAngle:c.upperVerticalAngle}),[c.centralAngle,c.centralHorizontalAngle,c.lowerVerticalAngle,c.shape,c.upperVerticalAngle]),v=Dg(t,i,n);return P7(v,f,[u,g]),d.useImperativeHandle(l,()=>f.current,[u,g]),u?Y.jsxs(Y.Fragment,{children:[e==null&&Y.jsx(M7,{customRender:a,store:v,renderPriority:r,renderTargetRef:m,layerEntryRef:g?p:void 0,children:o}),g?Y.jsx(Lg,{renderTargetRef:m,layerEntryRef:p,pixelWidth:t,pixelHeight:i,dpr:n,ref:f,...c,src:e,geometry:y}):Y.jsx(Pg,{renderTargetRef:m,ref:f,...c,src:e,pixelWidth:t,pixelHeight:i,dpr:n,geometry:y})]}):null}),Lg=d.forwardRef(({src:s,shape:e,colorFormat:t,depthFormat:i,layout:n,mipLevels:r,renderOrder:o=0,blendTextureSourceAlpha:a,centralAngle:c,centralHorizontalAngle:l,chromaticAberrationCorrection:u,lowerVerticalAngle:h,quality:f,upperVerticalAngle:m,invertStereo:p,pixelWidth:g,pixelHeight:y,dpr:v,renderTargetRef:E,layerEntryRef:x,...T},A)=>{const C=d.useRef(null),b=H(O=>O.gl),R=Ai(),I={blendTextureSourceAlpha:a,centralAngle:c,centralHorizontalAngle:l,chromaticAberrationCorrection:u,lowerVerticalAngle:h,quality:f,upperVerticalAngle:m},w=d.useRef(I);w.current=I;const M=d.useRef(o);M.current=o;const P=Ie(O=>O.originReferenceSpace);return d.useEffect(()=>{if(C.current==null||P==null)return;const O=s??(E.current=Qp(g,y,v)),z=lS(O,R.getState(),P,b.xr,C.current,{colorFormat:t,depthFormat:i,invertStereo:p,layout:n,mipLevels:r,shape:e},w.current);if(z==null)return;const D=x.current={layer:z,renderOrder:M.current,object3D:C.current};if(R.addLayerEntry(D),O instanceof HTMLVideoElement||O instanceof Ze)return()=>{R.removeLayerEntry(D),z.destroy()};const F=mS(b,R,z,O);return()=>{R.removeLayerEntry(D),F(),z.destroy()}},[P,t,i,p,x,n,r,y,g,v,E,b,e,s,R]),x.current!=null&&(x.current.renderOrder=o),x.current!=null&&gc(x.current.layer,w.current),ee(()=>{x.current==null||C.current==null||vS(R.getState(),x.current.layer,w.current.centralAngle,C.current)}),d.useImperativeHandle(A,()=>C.current,[]),Y.jsx("mesh",{...T,renderOrder:-1/0,ref:C,children:Y.jsx("meshBasicMaterial",{colorWrite:!1})})}),Pg=d.forwardRef(({src:s,renderTargetRef:e,dpr:t,renderOrder:i,pixelWidth:n,pixelHeight:r,...o},a)=>{const c=d.useRef(null);return d.useEffect(()=>{if(c.current==null)return;const l=s??(e.current=Qp(n,r,t)),u=gS(l);return c.current.map=u,c.current.needsUpdate=!0,()=>{if(l instanceof Ze){l.dispose();return}u.dispose()}},[s,n,r,t,e]),Y.jsx("mesh",{ref:a,...o,children:Y.jsx("meshBasicMaterial",{ref:c,toneMapped:!1})})});function P7(s,e,t){d.useEffect(()=>{const{current:i}=e;if(i==null)return;let n;const r=(a,c)=>{if(a.camera===c?.camera&&a.scene===c.scene)return;n?.();const{destroy:l,update:u}=WA(i,()=>a.camera,a.scene),h=Qr(u);n=()=>{l(),h()}};r(s.getState());const o=s.subscribe(r);return()=>{o(),n?.()}},[s,e,...t])}const Mg=["set","get","setSize","setFrameloop","setDpr","events","invalidate","advance","size","viewport"];function Dg(s,e,t){const i=ki(),n=d.useMemo(()=>{let r=i.getState();const o=new He(50,1,.1,1e3);o.position.set(0,0,5);const a=new de;let c={events:{enabled:!1,priority:0},size:{width:1,height:1,left:0,top:0},camera:o,scene:new nn,raycaster:new Fi,pointer:a,mouse:a,previousRoot:i};const l=yp((u,h)=>{const f=()=>{const p={};for(const g in r)Mg.includes(g)||(p[g]=r[g]);return Object.assign(p,c,{events:{...r.events,...c.events},viewport:Object.assign({},r.viewport,r.viewport.getCurrentViewport(o,new _,c.size))})},m=()=>u(f());return{...r,set(p){typeof p=="function"&&(p=p(h())),Object.assign(c,p),m()},setPreviousState(p){r=p,m()},get:h,setEvents(){},...f()}});return Object.assign(l,{setState(u){l.getState().set(u)}})},[i]);return d.useEffect(()=>i.subscribe(n.getState().setPreviousState),[i,n]),d.useEffect(()=>{const r={factor:1,distance:0,dpr:t,initialDpr:t,left:0,top:0,getCurrentViewport:()=>r,width:s,height:e,aspect:s/e};n.setState({size:{width:s,height:e,top:0,left:0},viewport:r})},[s,e,t,n,i]),n}const es=new Qi;function $d(s){return this.getViewport(es),s.x=es.z-es.x,s.y=es.w-es.y,s}const Hd=new Qi;function M7({renderPriority:s,children:e,layerEntryRef:t,renderTargetRef:i,store:n,customRender:r}){d.useEffect(()=>{const f=(m,p)=>{const{size:g,camera:y}=m;y instanceof rt?(y.left=g.width/-2,y.right=g.width/2,y.top=g.height/2,y.bottom=g.height/-2):y.aspect=g.width/g.height,(g!==p?.size||y!==p.camera)&&(y.updateProjectionMatrix(),y.updateMatrixWorld())};return f(n.getState()),n.subscribe(f)},[n]);let o,a,c,l,u,h;return ee((f,m,p)=>{if(i.current==null||t!=null&&(t.current==null||p==null))return;const g=n.getState(),{gl:y,scene:v,camera:E}=g;o=y.autoClear,a=y.xr.enabled,c=y.xr.isPresenting,l=y.getRenderTarget(),h=y.getSize,u=y.getDrawingBufferSize,y.getViewport(Hd),y.autoClear=!0,y.xr.enabled=!1,y.xr.isPresenting=!1;const x=i.current;y.setViewport(0,0,x.width,x.height),y.getSize=$d,y.getDrawingBufferSize=$d,dS(y,x,t?.current,p),r!=null?r(x,g,m,p):y.render(v,E),y.setRenderTarget(l),y.setViewport(Hd),y.autoClear=o,y.xr.enabled=a,y.xr.isPresenting=c,y.getSize=h,y.getDrawingBufferSize=u},s),Y.jsx(Y.Fragment,{children:pf.createPortal(Y.jsx(us.Provider,{value:n,children:e}),n,null)})}function D7(s,e={},t={},i="left"){const n=Ai(),r=d.useMemo(()=>NS(),[]);ee((o,a,c)=>r(typeof s=="function"?s:s.current,n,o.camera,a,e,t,i,a,o,c))}function B7({batchEvents:s,clickThesholdMs:e,clickThresholdMs:t,contextMenuButton:i,customSort:n,dblClickThresholdMs:r,filter:o,forwardPointerCapture:a,intersectEveryFrame:c,pointerTypePrefix:l}){const u=H(p=>p.gl.domElement),h=H(p=>p.frameloop==="always"),f=H(p=>p.camera),m=H(p=>p.scene);return d.useEffect(()=>{const{destroy:p,update:g}=VA(u,()=>f,m,{batchEvents:s??h,clickThesholdMs:e,clickThresholdMs:t,contextMenuButton:i,customSort:n,dblClickThresholdMs:r,filter:o,forwardPointerCapture:a,intersectEveryFrame:c,pointerTypePrefix:l}),y=Qr(g);return()=>{y(),p()}},[u,f,m,h,s,t,e,i,n,r,o,a,c,l]),null}const F7=()=>({enabled:!1,priority:0}),bc=d.forwardRef(({store:s,mode:e,onError:t,children:i,...n},r)=>{const o=ho(s,c=>c.session),a=_s(e,t);return Y.jsx("button",{ref:r,...n,onClick:()=>o!=null?o.end():s.enterXR(e).catch(t),children:typeof i=="function"?i(a?o!=null?"entered":"exited":"unsupported"):i})}),k7=d.forwardRef((s,e)=>Y.jsx(bc,{ref:e,mode:"immersive-ar",...s})),O7=d.forwardRef((s,e)=>Y.jsx(bc,{ref:e,mode:"immersive-vr",...s})),N7={onBlur:"pointerleave",onHover:"pointerenter",onMove:"pointermove",onSelect:{type:"click",filter:s=>s.pointerType==="ray"},onSelectEnd:{type:"pointerup",filter:s=>s.pointerType==="ray"},onSelectStart:{type:"pointerdown",filter:s=>s.pointerType==="ray"},onSqueeze:{type:"click",filter:s=>s.pointerType==="grab"},onSqueezeEnd:{type:"pointerup",filter:s=>s.pointerType==="grab"},onSqueezeStart:{type:"pointerdown",filter:s=>s.pointerType==="grab"}};function Wt(s,e,t){const i=d.useRef(t);i.current=t,d.useEffect(()=>{const{current:n}=s;if(n==null)return;const r=N7[e],o=typeof r=="string"?c=>i.current?.({intersection:c,intersections:[c],target:c.pointerState}):c=>{c instanceof ot&&!r.filter(c)||i.current?.({intersection:c,intersections:[c],target:c.pointerState})},a=typeof r=="string"?r:r.type;return n.addEventListener(a,o),()=>n.removeEventListener(a,o)},[s,e])}function U7(s,e,{handedness:t}={}){const i=Ie(r=>r.session),n=d.useRef(e);n.current=e,d.useEffect(()=>{if(i==null)return;const r=o=>{n.current?.({type:o.type,data:o.inputSource})};return i.addEventListener(s,r),()=>i.removeEventListener(s,r)},[i,t,s])}function z7(s){return s==null?At("transientPointer"):So("transientPointer",s)}function G7(){return At("gaze")}function $7(){return At("screenInput")}function H7(s){return s==null?At("hand"):So("hand",s)}function K7(s){return s==null?At("controller"):So("controller",s)}const V7=To,Bg=d.forwardRef(({onHover:s,onBlur:e,onSelectStart:t,onSelectEnd:i,onSelect:n,onSqueezeStart:r,onSqueezeEnd:o,onSqueeze:a,onMove:c,children:l},u)=>{const h=d.useRef(null);return d.useImperativeHandle(u,()=>h.current),Wt(h,"onHover",s),Wt(h,"onBlur",e),Wt(h,"onSelectStart",t),Wt(h,"onSelectEnd",i),Wt(h,"onSelect",n),Wt(h,"onSqueezeStart",r),Wt(h,"onSqueezeEnd",o),Wt(h,"onSqueeze",a),Wt(h,"onMove",c),Y.jsx("group",{ref:h,children:l})}),j7=d.forwardRef(function({onSelectStart:e,onSelectEnd:t,children:i,...n},r){const o=d.useRef(void 0),a=d.useRef(null),c=d.useMemo(()=>new re,[]);return d.useImperativeHandle(r,()=>a.current),ee(()=>{const l=o.current,u=a.current;!u||!l||(u.applyMatrix4(c),l.updateWorldMatrix(!0,!1),u.applyMatrix4(l.matrixWorld),u.updateMatrixWorld(),c.copy(l.matrixWorld).invert())}),Y.jsx(Bg,{ref:a,onSelectStart:l=>{wp(l.target)&&(l.target.type==="controller"||l.target.type==="hand")&&l.target.object!=null&&(o.current=l.target.object,l.target.object.updateWorldMatrix(!0,!1),c.copy(l.target.object.matrixWorld).invert(),e?.(l))},onSelectEnd:l=>{l.target.controller===o.current&&(o.current=void 0),t?.(l)},...n,children:i})}),pT=Object.freeze(Object.defineProperty({__proto__:null,ARButton:k7,CombinedPointer:Ac,DefaultXRController:mg,DefaultXRControllerGrabPointer:dg,DefaultXRGaze:yg,DefaultXRHand:pg,DefaultXRHandGrabPointer:hg,DefaultXRHandTouchPointer:fg,DefaultXRInputSourceRayPointer:zn,DefaultXRInputSourceTeleportPointer:Sc,DefaultXRScreenInput:vg,DefaultXRTransientPointer:gg,FallbackXRLayerImplementation:Pg,IfFacingCamera:g7,IfInSessionMode:v7,IfSessionModeSupported:E7,IfSessionVisible:S7,Interactive:Bg,NotInXR:a7,PointerCursorModel:ws,PointerEvents:B7,PointerRayModel:lg,RayGrab:j7,RootCombinedPointer:Ag,ShowIfFacingCamera:p7,ShowIfInSessionMode:y7,ShowIfSessionModeSupported:x7,ShowIfSessionVisible:A7,TeleportPointerRayModel:cg,TeleportTarget:XS,UNSAFE_useXRStore:l7,VRButton:O7,XR:o7,XRButton:bc,XRControllerComponent:HS,XRControllerModel:ig,XRDomOverlay:_7,XRHandJoint:WS,XRHandModel:ng,XRHitTest:R7,XRLayer:L7,XRLayerImplementation:Lg,XRMeshModel:h7,XROrigin:T7,XRPlaneModel:f7,XRSpace:Ft,createXRHitTestSource:vc,createXRStore:Eg,defaultGrabPointerOpacity:_p,defaultRayPointerOpacity:vs,defaultTouchPointerOpacity:Lp,isAppleVisionPro:zp,isXRInputSourceState:wp,noEvents:F7,privateKeys:Mg,requestXRAnchor:xc,requestXRHitTest:Jp,useApplyXRSpaceMatrix:Tg,useGetXRSpaceMatrix:Sg,useGrabPointer:sg,useHover:YS,useInitRoomCapture:QS,useInteraction:Wt,useLayerStore:Dg,useLinesPointer:og,useLoadXRControllerLayout:VS,useLoadXRControllerModel:jS,usePointerXRInputSourceEvents:xo,useRayPointer:rg,useRequestXRAnchor:w7,useSessionFeatureEnabled:qS,useSessionModeSupported:JS,useTouchPointer:ag,useXR:Ie,useXRAnchor:I7,useXRControllerButtonEvent:eg,useXRControllerLocomotion:D7,useXRControllerState:K7,useXREvent:U7,useXRGazeState:G7,useXRHandState:H7,useXRHitTest:Ig,useXRHitTestSource:b7,useXRInputSourceEvent:u7,useXRInputSourceState:So,useXRInputSourceStateContext:At,useXRInputSourceStates:c7,useXRMeshGeometry:bg,useXRMeshes:d7,useXRPlaneGeometry:Cg,useXRPlanes:m7,useXRReferenceSpace:V7,useXRRequestHitTest:C7,useXRScreenInputState:$7,useXRSessionFeatureEnabled:Tc,useXRSessionModeSupported:_s,useXRSessionVisibilityState:Eo,useXRSpace:To,useXRStore:Ai,useXRTransientPointerState:z7},Symbol.toStringTag,{value:"Module"}));export{fT as D,pT as X,eT as Z,hT as u};
