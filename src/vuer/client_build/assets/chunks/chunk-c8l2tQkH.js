import{r as m}from"./chunk-BXpv_n6G.js";import{ae as T}from"./chunk-DFvmYzjA.js";import"./chunk-M1wq5mON.js";/* empty css              */import"./chunk-BXl3LOEh.js";var E=Object.defineProperty,$=(r,e,o)=>e in r?E(r,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[e]=o,w=(r,e,o)=>$(r,typeof e!="symbol"?e+"":e,o),v=(r=>(r.Popup="popup",r.Redirect="redirect",r))(v||{});const g="vuer_token",p="vuer_callback_url";function S(r,e){return async(o,t)=>{try{const n=await fetch(new URL(o,r),{...e,...t,headers:{...e?.headers,...t?.headers}}),a=await n.json().catch(()=>null);return n.ok?{data:a,error:null}:{data:null,error:{message:a?.message||n.statusText||`HTTP ${n.status}`,status:n.status,statusText:n.statusText,data:a}}}catch(n){return{data:null,error:{message:n instanceof Error?n.message:"Network error"}}}}}function k(r){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",o=new Uint8Array(r);if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues is not available. This library requires a browser environment.");return crypto.getRandomValues(o),Array.from(o).map(t=>e[t%e.length]).join("")}async function U(r){if(typeof crypto>"u"||!crypto.subtle)throw new Error("crypto.subtle is not available. This library requires a secure context (HTTPS).");const e=new TextEncoder().encode(r),o=await crypto.subtle.digest("SHA-256",e),t=Array.from(new Uint8Array(o));return window.btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}const b=r=>{const e=(window.screen.width-500)/2,o=(window.screen.height-600)/2,t=window.open(r,"vuer-auth-popup",`width=500,height=600,top=${o},left=${e}`);return t?new Promise((n,a)=>{const c=setTimeout(()=>{t?.close(),window.removeEventListener("message",l),a(new Error("Authentication timeout. Please try again."))},3e5),l=i=>{if(i.origin!==window.location.origin){console.warn(`Rejected message from untrusted origin: ${i.origin}`);return}if(i.data.type==="AUTH_TOKEN"){clearTimeout(c);const u=i.data.token;n(u),t?.close(),window.removeEventListener("message",l)}else i.data.type==="AUTH_ERROR"&&(clearTimeout(c),t?.close(),window.removeEventListener("message",l),a(new Error(i.data.error||"Failed to retrieve token")))};window.addEventListener("message",l);const h=setInterval(()=>{t.closed&&(clearInterval(h),clearTimeout(c),window.removeEventListener("message",l),a(new Error("Authentication cancelled by user")))},1e3)}):Promise.reject(new Error("Failed to open popup window. Please allow popups for this site."))};class P{constructor(e={}){w(this,"config"),w(this,"$fetch"),w(this,"authToken",null),this.config={baseURL:e.baseURL??"/",clientId:e.clientId||"",redirectUri:e.redirectUri??"/",fetchOptions:e.fetchOptions||{}},this.$fetch=S(this.config.baseURL,this.config.fetchOptions)}get token(){if(!this.authToken)try{const e=localStorage.getItem(g);this.authToken=e?JSON.parse(e):null}catch(e){console.error("Failed to parse stored token:",e),localStorage.removeItem(g),this.authToken=null}return this.authToken}set token(e){if(this.authToken=e,e)try{localStorage.setItem(g,JSON.stringify(e))}catch(o){console.error("Failed to store token in localStorage:",o)}else localStorage.removeItem(g)}async signIn(e){try{const o=k(32),t=k(64),n=await U(t);sessionStorage.setItem("pkce_state",o),sessionStorage.setItem("pkce_verifier",t),sessionStorage.setItem(p,e.callbackUrl);const a=new URLSearchParams([["state",o],["response_type","code"],["code_challenge_method","S256"],["code_challenge",n],["redirect_uri",`${window.location.origin}${this.config.redirectUri}`],["scope","openid profile email offline_access"],["client_id",this.config.clientId]]),c=`${this.config.baseURL}/api/auth/oauth2/authorize?${a.toString()}`;return e.authMode===v.Popup?await b(c):(window.location.href=c,null)}catch(o){throw console.error("Sign in failed:",o),o instanceof Error?o:new Error("Sign in failed")}}async getToken(e,o){const t=sessionStorage.getItem("pkce_state"),n=sessionStorage.getItem("pkce_verifier"),a=sessionStorage.getItem(p);if(!t)throw new Error("Missing PKCE state. Please restart the authentication flow.");if(o!==t)throw new Error("Invalid OAuth state: state parameter does not match. Possible CSRF attack.");if(!n)throw new Error("Missing PKCE verifier. Please restart the authentication flow.");const{data:c,error:l}=await this.$fetch("/api/auth/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:this.config.clientId,redirect_uri:`${window.location.origin}${this.config.redirectUri}`,grant_type:"authorization_code",code_verifier:n,code:e})}),h=!!window.opener||window!==window.parent;if(!l&&c){const i=c.token_type;c.token_type=`${i.charAt(0).toUpperCase()}${i.slice(1)}`,this.token=c,sessionStorage.removeItem("pkce_state"),sessionStorage.removeItem("pkce_verifier"),h?window.opener.postMessage({type:"AUTH_TOKEN",token:c},window.location.origin):window.location.href=a??"/"}else{const i=l?.message||"Failed to retrieve token";if(console.error("Token exchange failed:",i),h)window.opener.postMessage({type:"AUTH_ERROR",error:i},window.location.origin);else throw new Error(`Token exchange failed: ${i}`)}}async refreshToken(){var e;if(!((e=this.token)!=null&&e.refresh_token))throw new Error("No refresh token available. Please sign in again.");const{data:o,error:t}=await this.$fetch("/api/auth/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams([["grant_type","refresh_token"],["refresh_token",this.token.refresh_token],["client_id",this.config.clientId]])});if(t)return console.error("Token refresh failed:",t.message),this.token=null,null;if(o){const n=o.token_type;return o.token_type=`${n.charAt(0).toUpperCase()}${n.slice(1)}`,this.token=o,o}return null}signOut(e){try{localStorage.removeItem(g),sessionStorage.removeItem("pkce_state"),sessionStorage.removeItem("pkce_verifier"),sessionStorage.removeItem(p),this.authToken=null}catch(o){console.error("Error during sign out:",o)}finally{window.location.href=e??"/"}}async getUserinfo(){var e;if(!((e=this.token)!=null&&e.access_token))throw new Error("No access token available. Please sign in first.");const{data:o,error:t}=await this.$fetch("/api/auth/oauth2/userinfo",{headers:{authorization:`${this.token.token_type} ${this.token.access_token}`}});if(t)throw t.status===401&&(console.warn("Access token expired or invalid"),this.token=null),new Error(`Failed to get user info: ${t.message}`);return o}getConfig(){return this.config}authFetch(e,o){var t,n;if(!((t=this.token)!=null&&t.access_token))throw new Error("No access token available. Please sign in first.");return fetch(new URL(e,this.config.baseURL),{...this.config.fetchOptions,...o,headers:{...(n=this.config.fetchOptions)==null?void 0:n.headers,authorization:`${this.token.token_type} ${this.token.access_token}`,...o?.headers}})}}const y={data:null,isPending:!0,isRefetching:!1,error:null},I=()=>T(r=>({...y,setUser:e=>r({data:e,isPending:!1,isRefetching:!1,error:null}),setLoading:e=>r({isPending:e}),setRefetching:e=>r({isRefetching:e}),setError:e=>r({error:e,isPending:!1,isRefetching:!1}),reset:()=>r(y)}));function R(r){const e=new P(r),o=I();return{signIn:t=>e.signIn(t),signOut:t=>e.signOut(t),getToken:(t,n)=>e.getToken(t,n),getUserinfo:()=>e.getUserinfo(),refreshToken:()=>e.refreshToken(),token:()=>e.token,$fetch:(t,n)=>e.authFetch(t,n),$store:o}}function O(r){return function(e){var o;const t=((o=e?.query)==null?void 0:o.enabled)!==!1,n=r.$store(s=>s.data),a=r.$store(s=>s.isPending),c=r.$store(s=>s.isRefetching),l=r.$store(s=>s.error),h=r.$store(s=>s.setUser),i=r.$store(s=>s.setLoading),u=r.$store(s=>s.setRefetching),f=r.$store(s=>s.setError);m.useEffect(()=>{t&&(async()=>{try{i(!0);const s=await r.getUserinfo();h(s)}catch(s){const d=s instanceof Error?s:new Error("Failed to fetch user info");console.error("Failed to fetch user info:",d),f(d)}finally{i(!1)}})()},[t,i,h,f]);const _=m.useCallback(async()=>{try{u(!0),f(null);const s=await r.getUserinfo();h(s)}catch(s){const d=s instanceof Error?s:new Error("Failed to refetch user info");console.error("Failed to refetch user info:",d),f(d)}finally{u(!1)}},[u,h,f]);return{data:n,isPending:a,isRefetching:c,error:l,refetch:_}}}function A(r){return function(){const e=r.$store(t=>t.data),o=r.$store(t=>t.isPending);return{user:e,isAuthenticated:!!e,isPending:o,signIn:r.signIn,signOut:r.signOut}}}function H(r){const e=R(r),o=O(e),t=A(e);return{...e,useUserinfo:o,useAuth:t}}export{v as AuthMode,H as createAuthClient};
