import{r as x,j as w,$ as De}from"./chunk-Bxh3mmdk.js";import{cd as fr,e7 as dr,e8 as be,e9 as Ar,ea as Ve,aq as Er,i as pr,eb as Z,ec as We,ed as Tr,bB as Fr,by as Cr,ee as Fe,y as zr,z as Ir,ef as Gr,eg as fe,eh as Pr,dJ as xr,ei as Br,ej as qr,ek as Nr,el as Or,em as Dr,c5 as Ue,aC as Ur,aR as $r,aE as Lr,bD as Hr,en as Jr}from"./chunk-BcIzroif.js";import Vr from"./chunk-CFrbAlhN.js";import{f as we,l as D,n as pe,Q as xe,u as ae,cu as Wr,O as Kr,X as qe,a0 as hr,b as Ne,w as Xr,a5 as Qr,Z as $e,cL as Yr,a2 as _r,x as Zr,D as gr,an as ke,d as Se,cj as oe,au as Re,R as Ae,c7 as se,aH as le,am as ie,bO as et,L as yr,c5 as wr,B as rt}from"./chunk-CfPHAf7B.js";import"./chunk-liTnN7pR.js";/* empty css              */import"./chunk-BXl3LOEh.js";import"./chunk-BryG31u9.js";import"./chunk-BY7XLEYA.js";import"./chunk-DK86WuFI.js";import"./chunk-CvLG4DX1.js";import"./chunk-DwlDFfQQ.js";import"./chunk-XNusesNe.js";import"./chunk-Dc0d9LZe.js";import"./chunk-CkhHjPPW.js";function P(e,r,t){const n=e.BYTES_PER_ELEMENT||e.byteLength/e.length,l=e.byteOffset+r*n,i=Math.min(t,e.length);return new e.constructor(e.buffer,l,i)}function re(e,r){const t=P(e,r*3,3);return[t[0],t[2],-t[1]]}function kn(e,r,t){r[t*3]=e[0],r[t*3+1]=-e[2],r[t*3+2]=-e[1]}function je(e,r){const t=P(e,r*4,4);return[t[1],t[3],-t[2],t[0]]}function Sn(e,r,t){r[t*4]=e[3],r[t*4+1]=e[0],r[t*4+2]=-e[2],r[t*4+3]=-e[1]}function Rn(e,r){const t=P(e,r*9,9);return[t[0],t[3],t[6],t[2],t[5],t[8],-t[1],-t[4],-t[7]]}function tt(e,r,t){const n=r[3*t]-e[3*t],l=r[3*t+2]-e[3*t+2],i=r[3*t+1]-e[3*t+1],o=Math.atan2(l,n),s=Math.atan2(Math.sqrt(n*n+l*l),i);return[o,s,0]}function*ye(e,r,t=1){if(typeof r>"u"&&(r=e,e=0),!(t>0&&e>=r||t<0&&e<=r))for(let n=e;t>0?n<r:n>r;n+=t)yield n}function vr(e){var r;return((r=e.split("/").pop())==null?void 0:r.split("?")[0].split("#")[0])||""}function Oe(e){try{const r=new URL(e);if(r.protocol==="http:"||r.protocol==="https:"){const t=r.pathname.split("/").slice(0,-1);return t.length>1?t.join("/"):"/"}else if(r.protocol==="file:"){const t=r.pathname.split("/").slice(0,-1);return decodeURI(t.join("/"))}else throw new Error("Invalid URL provided: unsupported protocol")}catch{const r=e.replace(/\/+$/,"").split("/");return r.length<=1?"":r.slice(0,-1).join("/")}}function br(...e){return e.filter(r=>r).map((r,t)=>t===0?r.replace(/\/+$/,""):r.replace(/^\/+/,"")).join("/")}async function nt(e,r,t){const n=await fetch(r),l=t.split("/");let i="";for(let s=0;s<l.length-1;s++)i+=l[s],e.analyzePath(i).exists||e.mkdir(i),i+="/";if(t.endsWith(".urdf")){const s=await n.text(),d=at(s);e.writeFile(t,d);return}const o=new Uint8Array(await n.arrayBuffer());e.writeFile(t,o)}function at(e){const r=new DOMParser().parseFromString(e,"application/xml");let t=0;function n(l,i){return t++,`${l}.${i.join(".")}.${t}`}return Array.from(r.getElementsByTagName("link")).forEach((l,i)=>{const o=[String(i+1)];Array.from(l.getElementsByTagName("visual")).forEach((s,d)=>{const y=[...o,String(d)];s.hasAttribute("name")||s.setAttribute("name",n("visual",y)),Array.from(s.getElementsByTagName("geometry")).forEach((p,c)=>{const f=[...y,String(c)];p.hasAttribute("name")||p.setAttribute("name",n("geom",f))})}),Array.from(l.getElementsByTagName("collision")).forEach((s,d)=>{const y=[...o,String(d)];s.hasAttribute("name")||s.setAttribute("name",n("collision",y)),Array.from(s.getElementsByTagName("geometry")).forEach((p,c)=>{const f=[...y,String(c)];p.hasAttribute("name")||p.setAttribute("name",n("geom",f))})})}),new XMLSerializer().serializeToString(r)}async function ot(e,r,t,n){let l={};l=Array.isArray(t)?Object.fromEntries([r,...t].map(i=>[Oe(i)+"/"+vr(i),i])):t||{},await Promise.all(Object.keys(l).map(async i=>{const o=l[i];try{await nt(e,o,br(n,i))}catch(s){console.error(`Error downloading asset at ${o}:`,s)}})),console.info(`file download complete for ${t?.length||Object.keys(l).length} assets.`)}const Mr=x.createContext(null),st=({children:e})=>{const[r,t]=x.useState(null);return x.useEffect(()=>{let n=!0;return Vr().then(l=>{n&&t(l)}),()=>{n=!1,console.info("removing MuJoCo module!"),t(null)}},[]),r?w.jsx(Mr.Provider,{value:r,children:e}):null},me=()=>{const e=De.useContext(Mr);return e||(console.warn("mujoco has not been initialized. Make sure that you are using MuJoCoProvider, because useMuJoCo must be used within it.",e),null)},jr=x.createContext(null);function Ke({src:e,workDir:r="/workspace",assets:t=null,children:n,...l}){var i;const o=me(),s=x.useRef(!1),[d,y]=x.useState(null);let p;Array.isArray(t)?p=e+","+t?.join(","):p=e+","+((i=Object.values(t||{}))==null?void 0:i.join(",")),x.useEffect(()=>{console.log("shall I download?"),!s.current&&o!=null&&o.FS&&(s.current=!0,console.log("I am downloading."),ot(o.FS,e,t,r).then(()=>{const f=br(r,Oe(e),vr(e));f&&(console.log("I have downloaded."),y(f),s.current=!1)}))},[o?.FS,e,r,t,p]);const c=x.useMemo(()=>{var f,M;if(console.log("triggered useMemo",s.current,d,p),s.current)return{sim:null,dt:null,model:null,state:null,mujoco:o};if(!(o!=null&&o.FS)||!d)return{sim:null,dt:null,model:null,state:null,mujoco:o};const v=Oe(d);o.FS.chdir(v),console.log("creating a new MuJoCo instance",p);const a=new o.Model(d),_=new o.State(a),u=new o.Simulation(a,_),m=(M=(f=a?.getOptions)==null?void 0:f.call(a))==null?void 0:M.timestep;return{sim:u,model:a,dt:m,state:_,mujoco:o}},[d,p,s.current]);return!c.mujoco||!c.sim?null:w.jsx(jr.Provider,{value:c,children:n})}const Y=()=>{const e=De.useContext(jr);return(!e.sim||!e.model)&&console.warn(`
    MuJoCo has not been initialized.
    Make sure that you are using MuJoCoProvider, because
    useMuJoCo must be used within a MuJoCoProvider.
    `),e};function Xe(e,r,t=null){if(!t&&e.length!==r.length)return!1;for(let n=0;n<Math.min(t||e.length,r.length);n++)if(e[n]!==r[n])return!1;return!0}const lt=e=>`#${e.map(r=>Math.round(r*255).toString(16).padStart(2,"0")).join("")}`,it=({n:e,ambient:r})=>{const{mjtLightType:t}=me(),{sim:n,model:l}=Y(),i=x.useRef(null);return ae(()=>{var o;const s=(o=i.current)==null?void 0:o.children;s&&n.light_xpos.length&&n.light_xdir.length&&s.forEach((d,y)=>{if(!("isLight"in d))return;const p=d,c=re(n.light_xpos,y),f=tt(n.light_xpos,n.light_xdir,y);p&&(Xe(p.position.toArray(),c)?(p.position.set(...c),p.rotation.set(...f)):Xe([...p.rotation],f)&&p.rotation.set(...f))})}),w.jsx("group",{ref:i,children:Array.from(ye(0,e)).map((o,s)=>{const d=Array.from(l.light_diffuse.slice(3*s,3*s+3)),y=lt(d),p=l.light_castshadow[s]?{castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-25,"shadow-camera-right":25,"shadow-camera-top":25,"shadow-camera-bottom":-25}:{};return l.light_type[s]==t.mjLIGHT_DIRECTIONAL?w.jsx(qr,{_key:`mj-directional-light-${s}`,intensity:1,color:y,...p},s):w.jsx(Nr,{_key:`mj-spot-light-${s}`,intensity:1,color:y,decay:l.light_attenuation[3*s],penumbra:.5,...p},s)})},"lighting-gorup")},ut=/^(left|right)-(index|middle|ring|pinky)-finger-(tip|phalanx-distal|phalanx-intermediate|phalanx-proximal)$/,ct=/^(left|right)-thumb-(tip|phalanx-distal|phalanx-proximal)$/,mt=/^(left|right)-wrist$/,ft=({id:e,mocapId:r,mocap_pos:t,mocap_quat:n,names:l,onSiteMove:i,showFrame:o=!0,markerScale:s=.1,gizmoScale:d,handleSize:y,handleWireframe:p})=>{const c=re(t,r[e]),f=je(n,r[e]),M=l[r[e]];console.log("mocap site",e,r[e],c,f,M);const[v,a]=x.useMemo(()=>[new D(...c),new xe(...f)],[c,f]),_=x.useMemo(()=>{const j=new pe;return j.compose(new D(...c),new xe(...f),new D(1,1,1)),j},[c,f]),u=x.useCallback(j=>{v.setFromMatrixPosition(j),a.setFromRotationMatrix(j);const S=r[e]*3;t[S]=v.x,t[S+1]=-v.z,t[S+2]=v.y;const T=r[e]*4;n[T]=a.w,n[T+1]=a.x,n[T+2]=-a.z,n[T+3]=a.y,i?.({site_id:e})},[i,t,n,r,e,v,a]),m=x.useCallback(({world:j})=>u(j),[u]),g=xr(({mode:j})=>j),h=g==="immersive-ar"||g==="immersive-vr",b=M.endsWith("-relative"),A=b?M.replace("-relative",""):M,k=A.match(ut),R=A.match(ct),C=A.match(mt);let F=null,I=null;if(k){const[,j,S,T]=k;I=`${S}-finger-${T}`,F=j}else if(R){const[,j,S]=R;I=`thumb-${S}`,F=j}else if(C){const[,j]=C;I="wrist",F=j}return I&&F?w.jsx(Or,{jointName:I,position:c,quaternion:f,hand:F,markerScale:.2*s,relativeTracking:b,onMove:m,showFrame:!0}):h?w.jsx(Dr,{position:c,quaternion:f,showFrame:!0,onMove:m,markerScale:s,handleSize:y,wireframe:p}):w.jsx(dr,{matrix:_,annotations:!0,onDrag:u,scale:d||s,lineWidth:5,disableScaling:!0,visible:!o,depthTest:!1},e)},kr=({n:e,mocapId:r,mocap_pos:t,mocap_quat:n,names:l,showFrame:i,onMove:o,gizmoScale:s,markerScale:d=1,handleWireframe:y=!1,handleSize:p=.1})=>{const{showMocapFrame:c}=Z("Render",{showMocapFrame:{value:i}},[i]),f=x.useMemo(()=>new Set,[]),M=x.useCallback(v=>{f.add(v.site_id),setTimeout(()=>{if(!f.size){console.log(kr.name,"async timeout with no dirty mocap");return}const a=[...f];f.clear(),o({mocap_ids:a})},0)},[f,o]);return w.jsx("group",{children:Array.from(ye(0,e)).filter(v=>r[v]>=0).map(v=>w.jsx(ft,{id:v,_key:`mocap-${v}`,mocapId:r,mocap_pos:t,mocap_quat:n,gizmoScale:s,markerScale:d,handleSize:p,handleWireframe:y,names:l,showFrame:c,onSiteMove:M},`mocap-${v}`))},"mocap-group")};function dt({model:e,skinId:r,...t}){const n=e.skin_matid[r],{mjtTextureRole:l}=me(),i=e.mat_texid[n*l.mjNTEXROLE.value+l.mjTEXROLE_RGB.value],{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Se().setRGB(e.skin_rgba[r*4],e.skin_rgba[r*4+1],e.skin_rgba[r*4+2],oe),M=e.geom_rgba[r*4+3];if(n!=-1&&(f=f.setRGB(e.mat_rgba[n*4],e.mat_rgba[n*4+1],e.mat_rgba[n*4+2],oe),M=e.mat_rgba[n*4+3],i!=-1)){const v=e.tex_width[i],a=e.tex_height[i],_=e.tex_adr[i],u=e.tex_data,m=new Uint8Array(v*a*4);for(let h=0;h<v*a;h++)m[h*4]=u[_+h*3],m[h*4+1]=u[_+(h*3+1)],m[h*4+2]=u[_+(h*3+2)],m[h*4+3]=255;if(e.tex_colorspace[i]==1)for(let h=0;h<m.length;h+=4)for(let b=0;b<3;b++){const A=m[h+b]/255;m[h+b]=Math.pow(A,1/2.2)*255}c=new Re(m,v,a,Ae);const g=e.tex_type[i];switch(g){case 0:c.wrapS=ie,c.wrapT=ie,e.mat_texuniform[n]==1?(console.log("Texture repeat on skin error"),console.assert(!1)):c.repeat.set(e.mat_texrepeat[n*2],e.mat_texrepeat[n*2+1]);break;case 1:c.wrapS=le,c.wrapT=le;break;case 2:c.wrapS=se,c.wrapT=se;break;default:console.warn(`Unsupported texture type: ${g}`)}c.needsUpdate=!0}return{color:f,alpha:M,texture:c}},[r]),{mode:y,wireframe:p}=Z("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:n!=-1?e.mat_specular[n]:void 0,reflectivity:n!=-1?e.mat_reflectance[n]:void 0,roughness:n!=-1?1-e.mat_shininess[n]:void 0,metalness:n!=-1?.4:void 0,map:d,wireframe:p,...t})}function pt(e){return new Float32Array([-e[0],-e[1],-e[2],e[3]])}function xt(e,r){return new Float32Array([e[3]*r[0]+e[0]*r[3]+e[1]*r[2]-e[2]*r[1],e[3]*r[1]-e[0]*r[2]+e[1]*r[3]+e[2]*r[0],e[3]*r[2]+e[0]*r[1]-e[1]*r[0]+e[2]*r[3],e[3]*r[3]-e[0]*r[0]-e[1]*r[1]-e[2]*r[2]])}function ht(e){const r=e[0],t=e[1],n=e[2],l=e[3],i=r+r,o=t+t,s=n+n,d=r*i,y=r*o,p=r*s,c=t*o,f=t*s,M=n*s,v=l*i,a=l*o,_=l*s;return new Float32Array([1-(c+M),y+_,p-a,y-_,1-(d+M),f+v,p+a,f-v,1-(d+c)])}function Qe(e,r){return new Float32Array([e[0]*r[0]+e[1]*r[1]+e[2]*r[2],e[3]*r[0]+e[4]*r[1]+e[5]*r[2],e[6]*r[0]+e[7]*r[1]+e[8]*r[2]])}function _t(e,r,t){!e.skin_scenevert||e.skin_scenevert.length!==3*e.nskinvert?e.skin_scenevert=new Float32Array(3*e.nskinvert):e.skin_scenevert.fill(0),!e.skin_normal||e.skin_normal.length!==3*e.nskinvert?e.skin_normal=new Float32Array(3*e.nskinvert):e.skin_normal.fill(0);const n=e.skin_vertadr[t],l=e.skin_scenevert;for(let s=e.skin_boneadr[t];s<e.skin_boneadr[t]+e.skin_bonenum[t];s++){let d=P(e.skin_bonebindpos,3*s,3),y=P(e.skin_bonebindquat,4*s,4),p=e.skin_bonebodyid[s],c=P(r.xquat,4*p,4),f=pt(y),M=xt(c,f),v=ht(M),a=Qe(v,d);for(let _=0;_<3;_++)a[_]=r.xpos[3*p+_]-a[_];for(let _=e.skin_bonevertadr[s];_<e.skin_bonevertadr[s]+e.skin_bonevertnum[s];_++){let u=e.skin_bonevertid[_],m=e.skin_bonevertweight[_],g=P(e.skin_vert,3*(u+n),3),h=Qe(v,g);for(let b=0;b<3;b++)h[b]+=a[b];for(let b=0;b<3;b++)l[3*(u+n)+b]+=m*h[b]}}for(let s=e.skin_faceadr[t];s<e.skin_faceadr[t]+e.skin_facenum[t];s++){let d=e.skin_face[3*s],y=e.skin_face[3*s+1],p=e.skin_face[3*s+2],c=new Float32Array(3),f=new Float32Array(3);for(let v=0;v<3;v++)c[v]=l[3*(y+n)+v]-l[3*(d+n)+v],f[v]=l[3*(p+n)+v]-l[3*(d+n)+v];let M=new Float32Array(3);M[0]=c[1]*f[2]-c[2]*f[1],M[1]=c[2]*f[0]-c[0]*f[2],M[2]=c[0]*f[1]-c[1]*f[0];for(let v=0;v<3;v++)e.skin_normal[3*(d+n)+v]+=M[v],e.skin_normal[3*(y+n)+v]+=M[v],e.skin_normal[3*(p+n)+v]+=M[v]}for(let s=n;s<n+e.skin_vertnum[t];s++){let d=P(e.skin_normal,3*s,3),y=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]),p=1/Math.max(1e-6,y);for(let c=0;c<3;c++)e.skin_normal[3*s+c]*=p}if(e.skin_inflate){let s=e.skin_inflate[t];for(let d=n;d<n+e.skin_vertnum[t];d++)for(let y=0;y<3;y++)l[3*d+y]+=s*e.skin_normal[3*d+y]}let i=l;for(let s=0;s<i.length;s+=3){const d=i[s+1];i[s+1]=i[s+2],i[s+2]=-d}let o=e.skin_normal;for(let s=0;s<o.length;s+=3){const d=o[s+1];o[s+1]=o[s+2],o[s+2]=-d}return{face_vertices:i,normal:o}}function gt({model:e,simulation:r,skinId:t,...n}){const l=x.useRef(null),i=x.useMemo(()=>Uint32Array.from(P(e.skin_face,3*e.skin_faceadr[t],3*e.skin_facenum[t])),[e]),o=x.useMemo(()=>{let s;return e.skin_texcoordadr[t]>=0&&(s=P(e.skin_texcoord,2*e.skin_texcoordadr[t],2*e.skin_vertnum[t])),s},[e]);return ae(()=>{const s=l.current;if(!s)return;const{face_vertices:d,normal:y}=_t(e,r,t);try{s.attributes.position.array.set(d),s.attributes.position.needsUpdate=!0}catch{s.setAttribute("position",new ke(new Float32Array(d.length),3))}try{s.attributes.normal.array.set(y),s.attributes.normal.needsUpdate=!0}catch{s.setAttribute("normal",new ke(new Float32Array(y.length),3))}}),w.jsxs("bufferGeometry",{ref:l,...n,children:[i!=null&&i.length?w.jsx("bufferAttribute",{attach:"index",array:i,count:i.length,itemSize:1}):null,o!=null&&o.length?w.jsx("bufferAttribute",{attach:"attributes-uv",array:o,count:o.length/2,itemSize:2}):null]})}function yt({model:e,simulation:r,skinId:t,...n}){return w.jsxs("mesh",{receiveShadow:!0,castShadow:!0,frustumCulled:!1,...n,children:[w.jsx(gt,{attach:"geometry",model:e,simulation:r,skinId:t}),w.jsx(dt,{attach:"material",model:e,skinId:t,...n})]})}function wt(e,r=!1){const t=e[0].index!==null,n=new Set(Object.keys(e[0].attributes)),l=new Set(Object.keys(e[0].morphAttributes)),i={},o={},s=e[0].morphTargetsRelative,d=new rt;let y=0;for(let p=0;p<e.length;++p){const c=e[p];let f=0;if(t!==(c.index!==null))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const M in c.attributes){if(!n.has(M))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+'. All geometries must have compatible attributes; make sure "'+M+'" attribute exists among all geometries, or in none of them.'),null;i[M]===void 0&&(i[M]=[]),i[M].push(c.attributes[M]),f++}if(f!==n.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". Make sure all geometries have the same number of attributes."),null;if(s!==c.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const M in c.morphAttributes){if(!l.has(M))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+".  .morphAttributes must be consistent throughout all geometries."),null;o[M]===void 0&&(o[M]=[]),o[M].push(c.morphAttributes[M])}if(r){let M;if(t)M=c.index.count;else if(c.attributes.position!==void 0)M=c.attributes.position.count;else return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". The geometry must have either an index or a position attribute"),null;d.addGroup(y,M,p),y+=M}}if(t){let p=0;const c=[];for(let f=0;f<e.length;++f){const M=e[f].index;for(let v=0;v<M.count;++v)c.push(M.getX(v)+p);p+=e[f].attributes.position.count}d.setIndex(c)}for(const p in i){const c=Ye(i[p]);if(!c)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+p+" attribute."),null;d.setAttribute(p,c)}for(const p in o){const c=o[p][0].length;if(c===0)break;d.morphAttributes=d.morphAttributes||{},d.morphAttributes[p]=[];for(let f=0;f<c;++f){const M=[];for(let a=0;a<o[p].length;++a)M.push(o[p][a][f]);const v=Ye(M);if(!v)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+p+" morphAttribute."),null;d.morphAttributes[p].push(v)}}return d}function Ye(e){let r,t,n,l=-1,i=0;for(let y=0;y<e.length;++y){const p=e[y];if(r===void 0&&(r=p.array.constructor),r!==p.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(t===void 0&&(t=p.itemSize),t!==p.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(n===void 0&&(n=p.normalized),n!==p.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(l===-1&&(l=p.gpuType),l!==p.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;i+=p.count*t}const o=new r(i),s=new ke(o,t,n);let d=0;for(let y=0;y<e.length;++y){const p=e[y];if(p.isInterleavedBufferAttribute){const c=d/t;for(let f=0,M=p.count;f<M;f++)for(let v=0;v<t;v++){const a=p.getComponent(f,v);s.setComponent(f+c,v,a)}}else o.set(p.array,d);d+=p.count*t}return l!==void 0&&(s.gpuType=l),s}var Ze=typeof Float32Array<"u"?Float32Array:Array;function vt(){var e=new Ze(3);return Ze!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ge(e,r,t){return e[0]=r[0]+t[0],e[1]=r[1]+t[1],e[2]=r[2]+t[2],e}function Ce(e,r,t){return e[0]=r[0]-t[0],e[1]=r[1]-t[1],e[2]=r[2]-t[2],e}function bt(e,r){return e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e}function ze(e,r){var t=r[0],n=r[1],l=r[2],i=t*t+n*n+l*l;return i>0&&(i=1/Math.sqrt(i)),e[0]=r[0]*i,e[1]=r[1]*i,e[2]=r[2]*i,e}function er(e,r,t){var n=r[0],l=r[1],i=r[2],o=t[0],s=t[1],d=t[2];return e[0]=l*d-i*s,e[1]=i*o-n*d,e[2]=n*s-l*o,e}function Ie(e,r,t,n){var l=[],i=[];return l[0]=r[0]-t[0],l[1]=r[1]-t[1],l[2]=r[2]-t[2],i[0]=l[0],i[1]=l[1]*Math.cos(n)-l[2]*Math.sin(n),i[2]=l[1]*Math.sin(n)+l[2]*Math.cos(n),e[0]=i[0]+t[0],e[1]=i[1]+t[1],e[2]=i[2]+t[2],e}(function(){var e=vt();return function(r,t,n,l,i,o){var s,d;for(t||(t=3),n||(n=0),l?d=Math.min(l*t+n,r.length):d=r.length,s=n;s<d;s+=t)e[0]=r[s],e[1]=r[s+1],e[2]=r[s+2],i(e,e,o),r[s]=e[0],r[s+1]=e[1],r[s+2]=e[2];return r}})();function Mt({model:e,flexId:r,...t}){const n=e.flex_matid[r],{mjtTextureRole:l}=me(),i=e.mat_texid[n*l.mjNTEXROLE.value+l.mjTEXROLE_RGB.value],{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Se().setRGB(e.flex_rgba[r*4],e.flex_rgba[r*4+1],e.flex_rgba[r*4+2],oe),M=e.geom_rgba[r*4+3];if(n!=-1&&(f=f.setRGB(e.mat_rgba[n*4],e.mat_rgba[n*4+1],e.mat_rgba[n*4+2],oe),M=e.mat_rgba[n*4+3],i!=-1)){const v=e.tex_width[i],a=e.tex_height[i],_=e.tex_adr[i],u=e.tex_data,m=new Uint8Array(v*a*4);for(let h=0;h<v*a;h++)m[h*4]=u[_+h*3],m[h*4+1]=u[_+(h*3+1)],m[h*4+2]=u[_+(h*3+2)],m[h*4+3]=255;if(e.tex_colorspace[i]==1)for(let h=0;h<m.length;h+=4)for(let b=0;b<3;b++){const A=m[h+b]/255;m[h+b]=Math.pow(A,1/2.2)*255}c=new Re(m,v,a,Ae);const g=e.tex_type[i];switch(g){case 0:c.wrapS=ie,c.wrapT=ie,e.mat_texuniform[n]==1?(console.log("Texture repeat for flex error"),console.assert(!1)):c.repeat.set(e.mat_texrepeat[n*2],e.mat_texrepeat[n*2+1]);break;case 1:c.wrapS=le,c.wrapT=le;break;case 2:c.wrapS=se,c.wrapT=se;break;default:console.warn(`Unsupported texture type: ${g}`)}c.needsUpdate=!0}return{color:f,alpha:M,texture:c}},[r]),{mode:y,wireframe:p}=Z("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:n!=-1?e.mat_specular[n]:void 0,reflectivity:n!=-1?e.mat_reflectance[n]:void 0,roughness:n!=-1?1-e.mat_shininess[n]:void 0,metalness:n!=-1?.4:void 0,map:d,wireframe:p,...t})}function Ge(e){for(let r=0;r<e.nflex;r++)r==0?e.flex_faceadr[r]=0:e.flex_faceadr[r]=e.flex_faceadr[r-1]+e.flex_facenum[r-1]}function Me(e){let r=0;for(let t=0;t<e.nflex;t++)r+=e.flex_facenum[t];return r}function rr(e,r){if(e.flex_dim[r]==0)e.flex_facenum[r]=0;else if(e.flex_dim[r]==2)e.flex_facenum[r]=2*e.flex_shellnum[r]+2*e.flex_elemnum[r];else{let t=0,n=0,l=1;for(;l!==0;){l=0;for(let i=0;i<e.flex_elemnum[r];i++)e.flex_elemlayer[e.flex_elemadr[r]+i]===n&&l++;t=Math.max(t,l),n++}e.flex_facenum[r]=Math.max(e.flex_shellnum[r],4*t)}}function jt({model:e,simulation:r,flexId:t,smoothShading:n=!0,...l}){const i=x.useRef(null);let o=e.flex_dim[t];const s=e.flex_texcoordadr[t]>=0?P(e.flex_texcoord,2*e.flex_texcoordadr[t],2*e.nflextexcoord):void 0;if(o===1){const a=x.useRef(null),_=x.useMemo(()=>new _r(e.flex_radius[t]),[e.flex_radius[t]]),u=x.useMemo(()=>new $e(e.flex_radius[t],e.flex_radius[t]),[e.flex_radius[t]]);return ae(()=>{const m=[];for(let h=0;h<e.flex_vertnum[t];h++){const b=3*(e.flex_vertadr[t]+h),A=r.flexvert_xpos[b],k=r.flexvert_xpos[b+2],R=-r.flexvert_xpos[b+1];_.clone().applyMatrix4(new pe().makeTranslation(A,k,R))}for(let h=0;h<e.flex_edgenum[t];h++){const b=e.flex_edgeadr[t]+h,A=e.flex_edge[2*b],k=e.flex_edge[2*b+1],R=3*(e.flex_vertadr[t]+A),C=3*(e.flex_vertadr[t]+k),F=new D(r.flexvert_xpos[R],r.flexvert_xpos[R+2],-r.flexvert_xpos[R+1]),I=new D(r.flexvert_xpos[C],r.flexvert_xpos[C+2],-r.flexvert_xpos[C+1]),j=new D().subVectors(I,F),S=j.length(),T=new D().addVectors(F,I).multiplyScalar(.5);j.normalize();const z=new xe().setFromUnitVectors(new D(0,1,0),j),q=new pe().makeScale(1,S,1),E=new pe().makeRotationFromQuaternion(z),N=new pe().makeTranslation(T.x,T.y,T.z).multiply(E).multiply(q),G=u.clone();G.applyMatrix4(N),m.push(G)}const g=wt(m,!1);a.current&&(a.current.copy(g),a.current.computeVertexNormals())}),w.jsx("bufferGeometry",{ref:a,attach:"geometry",...l})}const d=x.useMemo(()=>{e.flex_facenum||(e.flex_facenum=new Int32Array(e.nflex)),e.flex_facenum[t]==0&&rr(e,t),e.flex_faceused||(e.flex_faceused=new Int32Array(e.nflex));let a=e.flex_facenum[t],_=new Int32Array(3*a),u=0;if(n)if(o==2){for(let m=0;m<e.flex_elemnum[t];m++){const g=P(e.flex_elemtexcoord,e.flex_elemdataadr[t]+m*(o+1),3);_[3*u]=g[0],_[3*u+1]=g[1],_[3*u+2]=g[2],u++,_[3*u]=g[0],_[3*u+1]=g[2],_[3*u+2]=g[1],u++}for(let m=0;m<e.flex_shellnum[t];m++){const g=P(e.flex_shell,e.flex_shelldataadr[t]+m*o,3);_[3*u]=g[0],_[3*u+1]=g[1],_[3*u+2]=g[1],u++,_[3*u]=g[1],_[3*u+1]=g[0],_[3*u+2]=g[0],u++}}else for(let m=0;m<e.flex_shellnum[t];m++){const g=P(e.flex_shell,e.flex_shelldataadr[t]+m*o,3);_[3*u]=g[0],_[3*u+1]=g[1],_[3*u+2]=g[2],u++}else for(let m=0;m<e.flex_elemnum[t];m++)if(o===2||e.flex_elemlayer[e.flex_elemadr[t]+m]==0)if(o==2){const g=P(e.flex_elemtexcoord,e.flex_elemdataadr[t]+m*(o+1),3);_[3*u]=g[0],_[3*u+1]=g[1],_[3*u+2]=g[2],u++,_[3*u]=g[0],_[3*u+1]=g[2],_[3*u+2]=g[1],u++}else{const g=P(e.flex_elemtexcoord,e.flex_elemdataadr[t]+m*(o+1),4);_[3*u]=g[0],_[3*u+1]=g[1],_[3*u+2]=g[2],u++,_[3*u]=g[0],_[3*u+1]=g[2],_[3*u+2]=g[3],u++,_[3*u]=g[0],_[3*u+1]=g[3],_[3*u+2]=g[1],u++,_[3*u]=g[1],_[3*u+1]=g[3],_[3*u+2]=g[2],u++}return e.flex_faceused[t]=u,e.flex_faceused[t]>e.flex_facenum[t]&&(console.log("Too many flex faces"),console.log(e.flex_faceused[t],e.flex_facenum[t])),_},[t]),y=x.useMemo(()=>{if(e.flex_facenum||(e.flex_facenum=new Int32Array(e.nflex)),e.flex_facenum[t]==0&&rr(e,t),!e.flex_scenetexcoord){let m=Me(e);e.flex_scenetexcoord=new Float32Array(6*m)}e.flex_faceadr||(e.flex_faceadr=new Int32Array(e.nflex),Ge(e));let a=e.flex_facenum[t],_=e.flex_texcoordadr[t]>=0?P(e.flex_scenetexcoord,6*e.flex_faceadr[t],6*a):void 0;if(!s)return _;let u=d.length/3;for(let m=0;m<u;m++)for(let g=0;g<3;g++){const h=d[m*3+g];_[m*6+g*2]=s[h*2],_[m*6+g*2+1]=s[h*2+1]}return _},[t,d[0]]);let p=new Float32Array(3),c=new Float32Array(3),f=new Float32Array(3);function M(a,_,u,m){if(a.flex_faceadr||(a.flex_faceadr=new Int32Array(a.nflex),Ge(a)),a.flex_faceused||(a.flex_faceused=new Int32Array(a.nflex)),!a.flex_face){let C=Me(a);a.flex_face=new Float32Array(9*C)}if(!a.flex_normal){let C=Me(a);a.flex_normal=new Float32Array(9*C)}const g=a.flex_radius[u],h=a.flex_facenum[u];let b=P(_.flexvert_xpos,3*a.flex_vertadr[u],3*a.flex_vertnum[u]),A=P(a.flex_face,9*a.flex_faceadr[u],9*h),k=P(a.flex_normal,9*a.flex_faceadr[u],9*h);function R(C,F,I,j){const S=P(b,3*F,3),T=P(b,3*I,3),z=P(b,3*j,3);for(let G=0;G<3;G++)p[G]=T[G]-S[G],c[G]=z[G]-S[G];f[0]=p[1]*c[2]-p[2]*c[1],f[1]=p[2]*c[0]-p[0]*c[2],f[2]=p[0]*c[1]-p[1]*c[0];const q=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]);q>0&&(f[0]/=q,f[1]/=q,f[2]/=q);const E=9*C;for(let G=0;G<3;G++)A[E+G]=S[G]+f[G]*g,A[E+3+G]=T[G]+f[G]*g,A[E+6+G]=z[G]+f[G]*g;for(let G=0;G<3;G++)k[E+G]=f[G],k[E+3+G]=f[G],k[E+6+G]=f[G];let N=A[E+1];A[E+1]=A[E+2],A[E+2]=-N,N=A[E+4],A[E+4]=A[E+5],A[E+5]=-N,N=A[E+7],A[E+7]=A[E+8],A[E+8]=-N,N=k[E+1],k[E+1]=k[E+2],k[E+2]=-N,N=k[E+4],k[E+4]=k[E+5],k[E+5]=-N,N=k[E+7],k[E+7]=k[E+8],k[E+8]=-N}for(let C=0;C<h;C++)R(C,m[3*C],m[3*C+1],m[3*C+2]);return{face_vertices:A,normal:k,vertices:b}}function v(a,_,u){if(a.vert_normal?a.vert_normal.fill(0):a.vert_normal=new Float32Array(3*a.flex_vertnum[u]),a.flex_faceadr||(a.flex_faceadr=new Int32Array(a.nflex),Ge(a)),a.flex_faceused||(a.flex_faceused=new Int32Array(a.nflex)),!a.flex_face){let j=Me(a);a.flex_face=new Float32Array(9*j)}if(!a.flex_normal){let j=Me(a);a.flex_normal=new Float32Array(9*j)}let m=a.flex_dim[u],g=P(_.flexvert_xpos,3*a.flex_vertadr[u],3*a.flex_vertnum[u]),h=P(a.flex_face,9*a.flex_faceadr[u],9*a.flex_facenum[u]),b=P(a.flex_normal,9*a.flex_faceadr[u],9*a.flex_facenum[u]),A=a.flex_flatskin[u],k=a.flex_radius[u];function R(j,S,T){const z=P(g,3*j,3),q=P(g,3*S,3),E=P(g,3*T,3);Ce(p,q,z),Ce(c,E,z),er(f,p,c),ze(f,f)}function C(j,S,T,z,q){const E=q>0?1:-1;if(A){R(S,T,z);for(let N=0;N<3;N++)b[9*j+3*N]=E*f[0],b[9*j+3*N+1]=E*f[2],b[9*j+3*N+2]=-E*f[1]}else b[9*j]=E*a.vert_normal[3*S],b[9*j+1]=E*a.vert_normal[3*S+2],b[9*j+2]=-E*a.vert_normal[3*S+1],b[9*j+3]=E*a.vert_normal[3*T],b[9*j+4]=E*a.vert_normal[3*T+2],b[9*j+5]=-E*a.vert_normal[3*T+1],b[9*j+6]=E*a.vert_normal[3*z],b[9*j+7]=E*a.vert_normal[3*z+2],b[9*j+8]=-E*a.vert_normal[3*z+1];h[9*j]=g[3*S]+q*a.vert_normal[3*S],h[9*j+1]=g[3*S+2]+q*a.vert_normal[3*S+2],h[9*j+2]=-g[3*S+1]-q*a.vert_normal[3*S+1],h[9*j+3]=g[3*T]+q*a.vert_normal[3*T],h[9*j+4]=g[3*T+2]+q*a.vert_normal[3*T+2],h[9*j+5]=-g[3*T+1]-q*a.vert_normal[3*T+1],h[9*j+6]=g[3*z]+q*a.vert_normal[3*z],h[9*j+7]=g[3*z+2]+q*a.vert_normal[3*z+2],h[9*j+8]=-g[3*z+1]-q*a.vert_normal[3*z+1]}function F(j,S,T,z){const q=P(g,3*S,3),E=P(g,3*T,3);Ce(p,E,q),er(f,p,a.vert_normal.subarray(3*T,3*T+3)),ze(f,f),z<0&&bt(f,f);const N=P(b,9*j,3),G=P(b,9*j+3,3),ue=P(b,9*j+6,3);Ie(N,f,[0,0,0],Math.PI/2),Ie(G,f,[0,0,0],Math.PI/2),Ie(ue,f,[0,0,0],Math.PI/2),h[9*j]=g[3*S]+z*a.vert_normal[3*S],h[9*j+1]=g[3*S+2]+z*a.vert_normal[3*S+2],h[9*j+2]=-g[3*S+1]-z*a.vert_normal[3*S+1],h[9*j+3]=g[3*T]+-z*a.vert_normal[3*T],h[9*j+4]=g[3*T+2]+-z*a.vert_normal[3*T+2],h[9*j+5]=-g[3*T+1]- -z*a.vert_normal[3*T+1],h[9*j+6]=g[3*T]+z*a.vert_normal[3*T],h[9*j+7]=g[3*T+2]+z*a.vert_normal[3*T+2],h[9*j+8]=-g[3*T+1]-z*a.vert_normal[3*T+1]}if(m===2)for(let j=0;j<a.flex_elemnum[u];j++){const S=P(a.flex_elem,a.flex_elemdataadr[u]+j*(m+1),3),T=S[0],z=S[1],q=S[2];R(T,z,q);const E=P(a.vert_normal,3*T,3),N=P(a.vert_normal,3*z,3),G=P(a.vert_normal,3*q,3);ge(E,E,f),ge(N,N,f),ge(G,G,f)}else for(let j=0;j<a.flex_shellnum[u];j++){const S=P(a.flex_shell,a.flex_shelldataadr[u]+j*m,3),T=S[0],z=S[1],q=S[2];R(T,z,q);const E=P(a.vert_normal,3*T,3),N=P(a.vert_normal,3*z,3),G=P(a.vert_normal,3*q,3);ge(E,E,f),ge(N,N,f),ge(G,G,f)}for(let j=0;j<a.flex_vertnum[u];j++){const S=P(a.vert_normal,3*j,3);ze(S,S)}let I=0;if(m===2)for(let j=0;j<a.flex_elemnum[u];j++){const S=P(a.flex_elem,a.flex_elemdataadr[u]+j*(m+1),3);C(I,S[0],S[1],S[2],k),I++,C(I,S[0],S[2],S[1],-k),I++}else for(let j=0;j<a.flex_shellnum[u];j++){const S=P(a.flex_shell,a.flex_shelldataadr[u]+j*m,3);C(I,S[0],S[1],S[2],k),I++}if(m==2)for(let j=0;j<a.flex_shellnum[u];j++){const S=P(a.flex_shell,a.flex_shelldataadr[u]+j*m,3);F(I,S[0],S[1],k),I++,F(I,S[1],S[0],-k),I++}return a.flex_faceused[u]=I,a.flex_faceused[u]>a.flex_facenum[u]&&(console.log("Too many flex faces"),console.log(a.flex_faceused[u],a.flex_facenum[u])),{face_vertices:h,normal:b}}return ae(()=>{const a=i.current;if(!a)return;const{face_vertices:_,normal:u}=n?v(e,r,t):M(e,r,t,d);try{a.attributes.position.array.set(_),a.attributes.position.needsUpdate=!0}catch{a.setAttribute("position",new ke(_,3))}try{a.attributes.normal.array.set(u),a.attributes.normal.needsUpdate=!0}catch{a.setAttribute("normal",new ke(u,3))}}),w.jsxs("bufferGeometry",{ref:i,...l,children:[y?w.jsx("bufferAttribute",{attach:"attributes-uv",array:y,count:y.length/2,itemSize:2}):null,"// TODO : Fix this"]})}function kt({model:e,simulation:r,flexId:t,...n}){return w.jsxs("mesh",{receiveShadow:!0,castShadow:!0,frustumCulled:!1,...n,children:[w.jsx(jt,{attach:"geometry",model:e,simulation:r,flexId:t}),w.jsx(Mt,{attach:"material",model:e,flexId:t,...n})]})}function tr({size:e,model:r,g:t,texId:n,children:l,...i}){const o=r.geom_dataid[t],s=x.useMemo(()=>{const M=r.mesh_vertnum[o],v=r.mesh_facenum[o],a=P(r.mesh_face,r.mesh_faceadr[o]*3,v*3),_=P(r.mesh_vert,r.mesh_vertadr[o]*3,M*3),u=P(r.mesh_normal,r.mesh_normaladr[o]*3,r.mesh_normalnum[o]*3),m=P(r.mesh_facetexcoord,r.mesh_faceadr[o]*3,v*3),g=P(r.mesh_facenormal,r.mesh_faceadr[o]*3,v*3),h=new Float32Array(M*3),b=new Float32Array(M*2),A=new Float32Array(M*3),k=P(r.mesh_texcoord,r.mesh_texcoordadr[o]*2,r.mesh_texcoordnum[o]*2);for(let R=0;R<v;R++)for(let C=0;C<3;C++){const F=R*3+C,I=a[F],j=m[F],S=g[F];h[I*3]=_[I*3],h[I*3+1]=_[I*3+2],h[I*3+2]=-_[I*3+1],A[I*3]=u[S*3],A[I*3+1]=u[S*3+2],A[I*3+2]=-u[S*3+1],b[I*2]=k[j*2],b[I*2+1]=k[j*2+1]}return{faces:Uint32Array.from(a),vertices:h,normals:A,uvs:b}},[t,o]),{faces:d,vertices:y,normals:p,uvs:c}=s||{},f=x.useRef(null);return x.useLayoutEffect(()=>{var M;(M=f.current)==null||M.computeVertexNormals()},[]),w.jsxs("mesh",{...i,children:[w.jsxs("bufferGeometry",{ref:f,children:[d!=null&&d.length?w.jsx("bufferAttribute",{attach:"index",array:d,count:d.length,itemSize:1}):null,y!=null&&y.length?w.jsx("bufferAttribute",{attach:"attributes-position",array:y,count:y.length/3,itemSize:3}):null,p!=null&&p.length?w.jsx("bufferAttribute",{attach:"attributes-normal",array:p,count:p.length/3,itemSize:3}):null,c!=null&&c.length?w.jsx("bufferAttribute",{attach:"attributes-uv",array:c,count:c.length/2,itemSize:2}):null]}),l]})}const St=({dataId:e,...r})=>{const t=x.useRef(null),{model:n}=Y(),l=e,{nrow:i,ncol:o,data:s,size:d}=x.useMemo(()=>{const c=n.hfield_nrow[l],f=n.hfield_ncol[l],M=n.hfield_adr[l],v=c*f,a=n.hfield_data.subarray(M,M+v),_=n.hfield_size.subarray(l*4,l*4+4);return{nrow:c,ncol:f,data:a,size:_}},[n,l]),y=x.useMemo(()=>{const c=new hr(d[0]*2,d[1]*2,o-1,i-1);for(let f=0;f<c.attributes.position.count;f++){const M=f%o,v=Math.floor(f/o),a=s[v*o+M]*d[2],_=c.attributes.position.getX(f),u=c.attributes.position.getY(f);c.attributes.position.setXYZ(f,_,a,u)}return c.computeVertexNormals(),c},[i,o,s,d]),p=x.useMemo(()=>new et({color:"#5577aa"}),[]);return w.jsx("mesh",{ref:t,geometry:y,material:p,...r})},Ee={0:Ct,1:St,2:Rt,3:Et,4:At,5:Tt,6:Ft,7:tr,8:tr,"*":zt};function Rt({size:e,model:r,g:t,textId:n,...l}){return w.jsx(Ue,{args:[e[0]],...l})}function At({size:e,model:r,g:t,textId:n,...l}){return w.jsx(Ue,{args:[e[0]],scale:[1,e[2]/e[0],e[1]/e[0]],...l})}function Et({size:e,model:r,g:t,textId:n,...l}){return w.jsx(Lr,{args:[e[0],e[1]*2,20,20],...l})}function Tt({size:e,model:r,g:t,textId:n,...l}){return w.jsx($r,{args:[e[0],e[0],e[1]*2],...l})}function Ft({size:e,model:r,g:t,textId:n,...l}){return w.jsx(Ur,{args:[e[0]*2,e[2]*2,e[1]*2],...l})}function Ct({size:e,model:r,g:t,textId:n,...l}){const i=x.useRef(null);x.useLayoutEffect(()=>{var s;const d=i.current.geometry;return(s=d.rotateX)==null||s.call(d,Math.PI/2),()=>{var y;(y=d.rotateX)==null||y.call(d,-Math.PI/2)}},[]);const o=x.useMemo(()=>{if(Math.min(...e)<=0){let s=100/(e[2]||1);return[100,100,Math.max(s,1)]}else{let s=e[0]*2,d=e[1]*2;return[s,d,s/e[2],d/e[2]]}},[e]);return w.jsx(Hr,{ref:i,args:o,...l})}function zt({size:e,model:r,g:t,textId:n,...l}){return w.jsx(Ue,{args:[1],...l})}function It({model:e,g:r,matId:t,texId:n,...l}){const{mjtGeom:i}=me(),{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Se().setRGB(e.geom_rgba[r*4],e.geom_rgba[r*4+1],e.geom_rgba[r*4+2],oe),M=e.geom_rgba[r*4+3];if(t!=-1&&(f=f.setRGB(e.mat_rgba[t*4],e.mat_rgba[t*4+1],e.mat_rgba[t*4+2],oe),M=e.mat_rgba[t*4+3],n!=-1)){let v=e.geom_size[r*3],a=e.geom_size[r*3+1],_=e.geom_size[r*3+2];e.geom_type[r]===i.mjGEOM_PLANE.value&&(v<=0||a<=0||_<=0)&&(v=100,a=100);const u=e.tex_width[n],m=e.tex_height[n],g=e.tex_adr[n],h=e.tex_data,b=new Uint8Array(u*m*4);for(let k=0;k<u*m;k++)b[k*4]=h[g+k*3],b[k*4+1]=h[g+(k*3+1)],b[k*4+2]=h[g+(k*3+2)],b[k*4+3]=255;if(e.tex_colorspace[n]==1)for(let k=0;k<b.length;k+=4)for(let R=0;R<3;R++){const C=b[k+R]/255;b[k+R]=Math.pow(C,1/2.2)*255}c=new Re(b,u,m,Ae),c.magFilter=yr,c.minFilter=wr,c.generateMipmaps=!0;const A=e.tex_type[n];switch(A){case 0:c.wrapS=ie,c.wrapT=ie,e.mat_texuniform[t]==1?c.repeat.set(v*e.mat_texrepeat[t*2],a*e.mat_texrepeat[t*2+1]):c.repeat.set(e.mat_texrepeat[t*2],e.mat_texrepeat[t*2+1]);break;case 1:c.wrapS=le,c.wrapT=le;break;case 2:c.wrapS=se,c.wrapT=se;break;default:console.warn(`Unsupported texture type: ${A}`)}c.needsUpdate=!0}return{color:f,alpha:M,texture:c}},[r,t,n]),{mode:y,wireframe:p}=Z("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1},[]);return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:t!=-1?e.mat_specular[t]:void 0,reflectivity:t!=-1?e.mat_reflectance[t]:void 0,roughness:t!=-1?1-e.mat_shininess[t]:void 0,metalness:t!=-1?.4:void 0,map:d,wireframe:p,...l})}function Gt(e,r){return[r[e*3],r[e*3+1],r[e*3+2]]}function Pt({size:e,type:r,index:t,children:n,...l}){const i=Ee[r]||Ee["*"],{mjtTextureRole:o}=me(),{model:s}=Y(),d=s.geom_matid[t],y=s.mat_texid[d*o.mjNTEXROLE.value+o.mjTEXROLE_RGB.value];return w.jsxs(i,{castShadow:!0,receiveShadow:!0,size:e,model:s,g:t,texId:y,depthWrite:!0,depthTest:!0,frustumCulled:!0,...l,children:[w.jsx(It,{attach:"material",model:s,g:t,matId:d,texId:y,side:gr}),n]})}function Bt({model:e,g:r,matId:t,texId:n,...l}){const{mjtGeom:i}=me(),{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Se().setRGB(e.site_rgba[r*4],e.site_rgba[r*4+1],e.site_rgba[r*4+2],oe),M=e.site_rgba[r*4+3];if(t!=-1&&(f=f.setRGB(e.mat_rgba[t*4],e.mat_rgba[t*4+1],e.mat_rgba[t*4+2],oe),M=e.mat_rgba[t*4+3],n!=-1)){let v=e.site_size[r*3],a=e.site_size[r*3+1],_=e.site_size[r*3+2];e.site_type[r]===i.mjGEOM_PLANE.value&&(v<=0||a<=0||_<=0)&&(v=100,a=100);const u=e.tex_width[n],m=e.tex_height[n],g=e.tex_adr[n],h=e.tex_data,b=new Uint8Array(u*m*4);for(let k=0;k<u*m;k++)b[k*4]=h[g+k*3],b[k*4+1]=h[g+(k*3+1)],b[k*4+2]=h[g+(k*3+2)],b[k*4+3]=255;if(e.tex_colorspace[n]==1)for(let k=0;k<b.length;k+=4)for(let R=0;R<3;R++){const C=b[k+R]/255;b[k+R]=Math.pow(C,1/2.2)*255}c=new Re(b,u,m,Ae),c.magFilter=yr,c.minFilter=wr;const A=e.tex_type[n];switch(A){case 0:c.wrapS=ie,c.wrapT=ie,e.mat_texuniform[t]==1?c.repeat.set(v*e.mat_texrepeat[t*2],a*e.mat_texrepeat[t*2+1]):c.repeat.set(e.mat_texrepeat[t*2],e.mat_texrepeat[t*2+1]);break;case 1:c.wrapS=le,c.wrapT=le;break;case 2:c.wrapS=se,c.wrapT=se;break;default:console.warn(`Unsupported texture type: ${A}`)}c.needsUpdate=!0}return{color:f,alpha:M,texture:c}},[r,t,n]),{mode:y,wireframe:p}=Z("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshStandardMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,roughness:t!=-1?1-e.mat_shininess[t]:void 0,metalness:t!=-1?.4:void 0,map:d,wireframe:p,...l})}function qt(e,r){return[r[e*3],r[e*3+1],r[e*3+2]]}function nr({size:e,type:r,index:t,children:n,...l}){const i=Ee[r]||Ee["*"],{mjtTextureRole:o}=me(),{model:s}=Y(),d=s.site_matid[t],y=s.mat_texid[d*o.mjNTEXROLE.value+o.mjTEXROLE_RGB.value];return w.jsxs(i,{castShadow:!0,receiveShadow:!0,size:e,model:s,g:t,texId:y,...l,children:[w.jsx(Bt,{attach:"material",model:s,g:t,matId:d,texId:y,side:gr}),n]})}const Pe=new Set;function Te(){const{sim:e,model:r}=Y()||{},t=x.useCallback(o=>(Pe.add(o),()=>{Pe.delete(o)}),[]),n=x.useCallback(()=>{if(e&&r)for(let o=0;o<e.qfrc_applied.length;o++)e.qfrc_applied[o]=0;Pe.forEach(o=>o())},[e,r]),l=o=>new D(o.x,-o.z,o.y),i=x.useCallback(({pullPos:o,anchorPos:s,scale:d=10,bodyId:y})=>{if(!e||!r)return;const p=re(e.xpos,y),c=new D(...p),f=o.clone().sub(c),M=(r.body_mass[y]||1)*d,v=f.multiplyScalar(M),a=l(v),_=l(s||c);e.applyForce(a.x,a.y,a.z,0,0,0,_.x,_.y,_.z,y)},[e,r]);return[t,n,i]}const Sr=x.createContext(null);function ar({dragForceScale:e=1,showArrow:r=!0,showForceText:t=!0,arrowColor:n=16711680,arrowOpacity:l=.5,enabled:i=!0,onDragStart:o,onDragEnd:s,onVisualizationUpdate:d,children:y}){const{gl:p,scene:c,camera:f,controls:M,raycaster:v}=we(),{sim:a,model:_}=Y()||{},[u]=Te(),m=xr(B=>B.mode),g=m==="immersive-ar"||m==="immersive-vr",h=x.useRef(!1),b=x.useRef(null),A=x.useRef(null),k=x.useRef(null),R=x.useRef(!1),C=x.useRef(0),F=x.useRef(null),I=x.useRef(null),j=x.useRef(new D),S=x.useRef(new D),T=x.useRef(new D),z=x.useRef(null),q=x.useRef(null),E=x.useRef(null),N=x.useRef(!0),G=x.useRef(null),ue=x.useRef(null),[he,H]=x.useState(!1),[X,Q]=x.useState(""),$=x.useRef(null);x.useEffect(()=>{if(!r)return;const B=new Qr,U=new $e(.005,.005,1,32),K=new qe({color:n,transparent:!0,opacity:l}),V=new Ne(U,K);q.current=V,V.position.set(0,.5,0);const ee=new Yr(.02,.05,32),ne=new qe({color:n,transparent:!0,opacity:l}),de=new Ne(ee,ne);return E.current=de,de.position.set(0,1,0),B.add(V),B.add(de),B.visible=!1,c.add(B),z.current=B,()=>{z.current&&(c.remove(z.current),z.current=null),q.current=null,E.current=null}},[c,r,n,l]);const W=B=>{var U;if(!i||!a||!_||!g&&!B.altKey||F.current!==null)return;F.current=B.pointerId,(U=B.target)==null||U.setPointerCapture(B.pointerId);const K=B.point,V=B.object,ee=B.eventObject,ne=ee.userData.bodyId;!V||!(V instanceof Zr)||ne<=0||(M&&"enabled"in M&&(N.current=M.enabled,M.enabled=!1),R.current=!0,h.current=!0,C.current=B.distance,b.current=ee,A.current=V,k.current=ne,j.current.copy(V.worldToLocal(K.clone())),S.current.copy(K),T.current.copy(K),z.current&&(z.current.position.copy(K),z.current.visible=!0),o?.(ne),I.current=u(ve))},_e=B=>{if(!h.current||!A.current||F.current!==B.pointerId)return;const U=B.ray.origin.clone();U.addScaledVector(B.ray.direction,C.current),T.current.copy(U),L()},O=B=>{var U;F.current===B.pointerId&&(F.current=null,(U=B.target)==null||U.releasePointerCapture(B.pointerId),R.current=!1,h.current=!1,b.current=null,A.current=null,k.current=null,G.current=null,ue.current=null,M&&"enabled"in M&&(M.enabled=N.current),z.current&&(z.current.visible=!1),$.current&&($.current.visible=!1),I.current&&(I.current(),I.current=null),s?.())},L=()=>{if(!A.current||!z.current||!q.current||!E.current)return;z.current.position.copy(S.current);const B=T.current.clone().sub(S.current),U=B.length(),K=B.clone().normalize();d?.({currentWorldPoint:T.current.clone(),worldHitPoint:S.current.clone(),length:U,direction:B.clone(),normalizedDirection:K.clone()});const V=q.current,ee=E.current;V&&(V.scale.set(1,U,1),V.position.set(0,U/2,0)),ee&&ee.position.set(0,U,0),z.current.setRotationFromQuaternion(new xe().setFromUnitVectors(new D(0,1,0),K)),$.current&&($.current.position.copy(T.current),$.current.visible=!0)},ce=x.useCallback(()=>{if(!A.current||!a||!_||!h.current||!k.current)return;const B=k.current,U=_.body_mass[B]||1,K=T.current.clone().sub(S.current);let V=U*100*e;const ee=K.multiplyScalar(V),ne=J(ee),de=J(S.current);G.current=ne,ue.current=B,a.applyForce(ne.x,ne.y,ne.z,0,0,0,de.x,de.y,de.z,B)},[A,a,_,e,h]),J=B=>new D(B.x,-B.z,B.y),te=x.useCallback(()=>{if(a&&_&&!(!h.current||!A.current||!k.current)){if(b.current){const B=k.current,U=re(a.xpos,B),K=je(a.xquat,B);b.current.position.set(...U),b.current.quaternion.set(...K),b.current.updateWorldMatrix(!0,!0)}S.current.copy(j.current),A.current.localToWorld(S.current)}},[a,_,h,A,j,S]),ve=x.useCallback(()=>{if(!(!h.current||!A.current)&&(te(),ce(),L(),G.current)){const B=G.current,U=B.x.toFixed(2),K=B.y.toFixed(2),V=B.z.toFixed(2),ee=`|F|: ${B.length().toFixed(2)} N
Fx: ${U}
Fy: ${K}
Fz: ${V}`;Q(ee),H(!0),$.current&&$.current.quaternion.copy(f.quaternion)}},[te,ce,L,f]);ae(()=>{h.current||(H(!1),Q(""))});const Je=x.useMemo(()=>({dragging:h,selectedPhysicsObject:A,computeForce:te,applyForce:ce,updateForce:ve,startDragVr:W,updateDragVr:_e,endDragVr:O}),[h,A,te,ce,ve]);return w.jsxs(Sr.Provider,{value:Je,children:[y,t&&w.jsx(fr,{ref:$,position:[0,0,0],fontSize:.05,color:"white",anchorX:"center",anchorY:"middle",visible:he,"material-depthTest":!1,"material-depthWrite":!1,renderOrder:999,children:X})]})}const Le=()=>x.useContext(Sr),Nt=({model:e,sim:r,visible:t,showSites:n,showSiteFrame:l,siteFrameScale:i=.01})=>{const o=x.useRef(null),{startDragVr:s,updateDragVr:d,endDragVr:y}=Le(),{showSiteFrame:p,showSites:c,siteFrameScale:f}=Z("Render.Sites",{showSites:{value:n},showSiteFrame:{value:l},siteFrameScale:{value:i,min:.001,max:.1,step:1e-4}},[n,l]);return ae(()=>{var M,v;(v=(M=o?.current)==null?void 0:M.children)==null||v.forEach((a,_)=>{const u=re(r.xpos,_),m=je(r.xquat,_);a.position.set(...u),a.quaternion.set(...m)})}),w.jsx("group",{ref:o,children:e?.nbody&&Array.from(ye(0,e.nbody)).map((M,v)=>{const a=e.body_geomadr[v],_=a+e.body_geomnum[v],u=Array.from(e.site_bodyid).map((m,g)=>m===v?g:-1).filter(m=>m>=0);return w.jsxs("group",{ref:o,userData:{isDraggable:!0,bodyId:v},onPointerDown:s,onPointerMove:d,onPointerUp:y,children:[Array.from(ye(a,_)).map(m=>{const g=Gt(m,e.geom_size),h=e.geom_type[m],b=re(e.geom_pos,m),A=je(e.geom_quat,m),k=e.geom_group[m],R=e.geom_dataid[m];if(t?.includes(k))return w.jsx(Pt,{size:g,type:h,index:m,dataId:R,position:b,quaternion:A},m)}),c&&u.length>=0&&u.map(m=>{const g=qt(m,e.site_size),h=e.site_type[m],b=re(e.site_pos,m),A=je(e.site_quat,m);return p?w.jsx(nr,{type:h,size:g,index:m,position:b,quaternion:A,children:w.jsx(Br,{scale:f},"frame-"+m)},m):w.jsx(nr,{type:h,size:g,index:m,position:b,quaternion:A},m)})]},v)})},"robot")};function or({model:e,tendonId:r,...t}){const n=e.tendon_matid[r],{mjtTextureRole:l}=me(),i=e.mat_texid[n*l.mjNTEXROLE.value+l.mjTEXROLE_RGB.value],{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Se().setRGB(e.tendon_rgba[r*4],e.tendon_rgba[r*4+1],e.tendon_rgba[r*4+2],oe),M=e.tendon_rgba[r*4+3];if(n!=-1&&(f=f.setRGB(e.mat_rgba[n*4],e.mat_rgba[n*4+1],e.mat_rgba[n*4+2],oe),M=e.mat_rgba[n*4+3],i!=-1)){const v=e.tex_width[i],a=e.tex_height[i],_=e.tex_adr[i],u=e.tex_data,m=new Uint8Array(v*a*4);for(let h=0;h<v*a;h++)m[h*4]=u[_+h*3],m[h*4+1]=u[_+(h*3+1)],m[h*4+2]=u[_+(h*3+2)],m[h*4+3]=255;if(e.tex_colorspace[i]==1)for(let h=0;h<m.length;h+=4)for(let b=0;b<3;b++){const A=m[h+b]/255;m[h+b]=Math.pow(A,1/2.2)*255}c=new Re(m,v,a,Ae);const g=e.tex_type[i];switch(g){case 0:c.wrapS=ie,c.wrapT=ie,c.repeat.set(e.mat_texrepeat[n*2],e.mat_texrepeat[n*2+1]);break;case 1:c.wrapS=le,c.wrapT=le;break;case 2:c.wrapS=se,c.wrapT=se;break;default:console.warn(`Unsupported texture type: ${g}`)}c.needsUpdate=!0}return{color:f,alpha:M,texture:c}},[r]),{mode:y,wireframe:p}=Z("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:n!=-1?e.mat_specular[n]:void 0,reflectivity:n!=-1?e.mat_reflectance[n]:void 0,roughness:n!=-1?1-e.mat_shininess[n]:void 0,metalness:n!=-1?.4:void 0,map:d,wireframe:p,...t})}function Ot({model:e,sim:r}){const t=x.useMemo(()=>new $e(1,1,1),[]),n=x.useMemo(()=>new _r(1,8,8),[]);return w.jsx(w.Fragment,{children:Array.from({length:e.ntendon}).map((l,i)=>w.jsx(Dt,{model:e,sim:r,tendonId:i,cylinderGeometry:t,sphereGeometry:n},i))})}function Dt({model:e,sim:r,tendonId:t,cylinderGeometry:n,sphereGeometry:l}){const i=x.useRef(null),o=x.useRef(null),s=x.useMemo(()=>new pe,[]),d=x.useMemo(()=>new D,[]),y=x.useMemo(()=>new D,[]),p=x.useMemo(()=>new D,[]),c=x.useMemo(()=>new D,[]),f=x.useMemo(()=>new xe,[]),M=x.useMemo(()=>new xe,[]);return ae(()=>{if(!i.current||!o.current)return;let v=0;const a=r.ten_wrapadr[t],_=e.tendon_width[t];for(let u=a;u<a+r.ten_wrapnum[t]-1;u++){d.fromArray(re(r.wrap_xpos,u)),y.fromArray(re(r.wrap_xpos,u+1));const m=d.lengthSq()>1e-4,g=y.lengthSq()>1e-4;if(m&&(c.set(_,_,_),s.compose(d,M,c),o.current.setMatrixAt(v,s)),g&&(c.set(_,_,_),s.compose(y,M,c),o.current.setMatrixAt(v+1,s)),m&&g){p.addVectors(d,y).multiplyScalar(.5);const h=y.clone().sub(d).normalize();f.setFromUnitVectors(new D(0,1,0),h);const b=d.distanceTo(y);c.set(_,b,_),s.compose(p,f,c),i.current.setMatrixAt(v,s),v++}}i.current.count=v,o.current.count=v>0?v+1:0,i.current.visible=!0,o.current.visible=!0,i.current.instanceMatrix.needsUpdate=!0,o.current.instanceMatrix.needsUpdate=!0}),w.jsxs("group",{children:[w.jsx("instancedMesh",{ref:i,args:[n,void 0,256],castShadow:!0,receiveShadow:!0,frustumCulled:!1,children:w.jsx(or,{model:e,tendonId:t})}),w.jsx("instancedMesh",{ref:o,args:[l,void 0,256],castShadow:!0,receiveShadow:!0,frustumCulled:!1,children:w.jsx(or,{model:e,tendonId:t})})]})}function He(e,r){const t={};return r.split(" ").forEach(n=>{e!=null&&e[n]&&(t[n]=Array.from(e[n]))}),t}const sr=x.forwardRef(({_key:e="",frameKeys:r,visible:t,onLoad:n,useLights:l=!0,useMocap:i=!0,showMocapFrame:o=!0,showSites:s=!0,showSiteFrame:d=!0,onMocapMove:y,mocapMarkerScale:p=.1,mocapGizmoScale:c,mocapHandleSize:f=.1,mocapHandleWireframe:M=!1,children:v,...a},_)=>{const{sim:u,model:m,state:g,mujoco:h}=Y()||{};function b(C,F){const I=new TextDecoder("utf-8"),j=C.name_bodyadr[F],S=C.names.indexOf(0,j);return I.decode(C.names.subarray(j,S))}const A=x.useMemo(()=>{if(!m||!m.body_mocapid)return[];const C=[];for(let F=0;F<m.nbody;F++){const I=m.body_mocapid[F];I>=0&&(C[I]=b(m,F))}return C},[m]);x.useEffect(()=>{const C=()=>{u?.resetData(),u?.forward()};_&&(_.current={sim:u,model:m,state:g,mujoco:h,reset:C})},[_,u,m,g,h]);const k=De.useRef(null),R=a||{};return x.useEffect(()=>{u&&R.qpos&&u.qpos.set(R.qpos),u&&R.qvel&&u.qvel.set(R.qvel)},[u,R.qpos,R.qvel]),x.useEffect(()=>{u&&R.act&&u.act.set(R.act)},[u,R.act]),x.useEffect(()=>{u&&R.ctrl&&u.ctrl.set(R.ctrl)},[u,R.ctrl]),x.useEffect(()=>{u&&R.mocap_pos&&u.mocap_pos.set(R.mocap_pos),u&&R.mocap_quat&&u.mocap_quat.set(R.mocap_quat)},[u,R.mocap_pos,R.mocap_quat]),x.useEffect(()=>{u&&u.forward()},[u,R.qpos,R.qvel,R.act,R.ctrl,R.mocap_pos,R.mocap_quat]),x.useEffect(()=>{if(!m||!u||!n)return;const C=He(u,r);n(C)},[m,u]),!u||!m?null:w.jsxs(w.Fragment,{children:[w.jsx("group",{ref:k,children:w.jsx(Nt,{model:m,sim:u,visible:t,showSites:s,showSiteFrame:d})},"robot"),m?.nskin&&Array.from(ye(0,m.nskin)).map((C,F)=>w.jsx(yt,{name:`skin-${F}`,model:m,simulation:u,skinId:F},`skin-${F}`)),m?.nflex&&Array.from(ye(0,m.nflex)).map((C,F)=>w.jsx(kt,{name:`Flex-${F}`,model:m,simulation:u,flexId:F,smoothShading:!0},`flex-${F}`)),m?.ntendon&&w.jsx(Ot,{model:m,sim:u}),l&&w.jsx(it,{n:m.nlight,ambient:m.light_ambient}),i&&w.jsx(kr,{n:m.nbody,mocapId:m.body_mocapid,mocap_pos:u.mocap_pos,mocap_quat:u.mocap_quat,onMove:y,names:A,showFrame:o,markerScale:p,gizmoScale:c,handleSize:f,handleWireframe:M}),v]})});function Ut(e){const[r,t]=x.useState(e),n=x.useRef(r);return[r,l=>{const i=l instanceof Function?l(n.current):l;n.current=i,t(i)},n]}function $t(e){if(!(e!=null&&e.length))return[];const r=new Set(e.sort());return Array.from(r)}const lr=({visible:e=[0,1,2],onChange:r})=>{const{model:t}=Y()||{},n=$t(Object.values(t.geom_group)),l=Z("Render.Groups",Object.fromEntries(n.map(i=>{let o=!1;return e!=null&&e.includes(i)&&(o=!0),[`${i}`,{value:o,label:`geom group ${i}`}]})),[n.join(",")]);return x.useEffect(()=>{const i=n.filter((o,s)=>typeof l[`${o}`]>"u"||!!l[`${o}`]);r?.({visible:i})},[l]),null};function Lt(e,r,t=[]){const n=x.useRef(null),l=x.useRef(e),i=x.useRef(performance.now()),o=x.useRef(null);return x.useEffect(()=>{o.current=r},[r]),x.useEffect(()=>{l.current=e},[e]),x.useEffect(()=>{i.current=performance.now()},[typeof r=="number",r<=0]),x.useEffect(()=>{const s=()=>{if(o.current<=0){i.current=performance.now();return}const d=performance.now(),y=d-i.current;i.current=d,l!=null&&l.current&&l.current(y)};if(o.current>0){const d=setInterval(s,o.current);return n.current=d,()=>clearInterval(d)}},[r,e,...t]),n}function Rr(e){const r=x.useRef(e);return x.useEffect(()=>{r.current=e},[e]),r}function Ht(e){return[...e].reduce((r,t)=>r+Math.abs(t),0)/e.length}function ir({fps:e=60,speed:r=1,pause:t=!1,pauseThreshold:n=.001,timeoutRef:l,timeoutSteps:i=5,onFrame:o,onStep:s,onTimeout:d,frameKeys:y="name time qpos mocap_pos mocap_quat site_xpos geom_xpos sensordata"}){const{sim:p,model:c,dt:f}=Y(),M=we(k=>k.invalidate),{updateForce:v,dragging:a}=Le(),[_,u]=Te();x.useEffect(()=>{if(!(!p||!c))return _(v)},[p,c]);const m=Rr(t),g=x.useMemo(()=>1/e/r,[e,r]),h=x.useRef(0),b=x.useRef(0),A=x.useCallback(k=>{if(!(!c||!p||!r)){if(k>1500){console.warn(`${k}ms has elapsed. If this persists, something is wrong. Skipping simulation.`),h.current=0,b.current=0;return}if(!m.current){for(h.current+=k*r;b.current<g;)p.step(),u(),b.current+=f;if(b.current,b.current%=g,b.current&&M(),Ht(p.qvel||[])<n&&!a.current?(l.current-=1,l.current||d==null||d(!0)):l.current=i,o){const R=He(p,y);o(R,b.current)}}}},[p,c,f,g,e,r,t,o,s,m,n,l,i,a,u,M,y,d]);return Lt(A,1e3*g,[A]),null}function ur({fps:e=60,speed:r=1,frameKeys:t="",onFrame:n,uplink:l,downlink:i}){const{sim:o,model:s,dt:d}=Y(),y=we(a=>a.invalidate),{updateForce:p}=Le(),[c,f]=Te();x.useEffect(()=>{if(!(!o||!s))return c(p)},[o,s]);const M=x.useMemo(()=>{if(!d)return 1;const a=1/e/r;return Math.max(1,Math.floor(a/d))},[d,e,r]),v=x.useCallback(({key:a,rtype:_,data:{act:u,ctrl:m,sim_steps:g,xfrc_applied:h,qfrc_applied:b,xfrc:A,xfrc_bodyId:k}})=>{if(!o||!s)return;if(u&&u.length>0&&o.act.set(u),m&&m.length>0&&o.ctrl.set(m),h&&h.length>0&&o.xfrc_applied.set(h),b&&b.length>0&&o.qfrc_applied.set(b),typeof A<"u"&&typeof k<"u"){const C=re(o.xpos,k),F=[...A,0,0,0,0,0,0].slice(0,6);o.applyForce(...F,...C,k)}const R=g??M;for(let C=0;C<R;C++)o.step(),f();if(R===0&&o.forward(),R&&y(),n){const C=He(o,t);n(C,d),l?.publish({ts:Date.now(),etype:_||"MJ_STEP_RESPONSE",value:{dt:R*d,keyFrame:C}})}},[o,s,l,M,d,y,f,t,n]);return x.useEffect(()=>{if(i)return i.subscribe("MJ_STEP",v)},[i,v]),null}function Jt(e){let r=e.length;for(let t=0;t<e.length;t++)r=(r<<5)-r+e[t],r|=0;return r}function Vt(e,r=[]){const[t,n]=x.useState(e);return x.useEffect(()=>n(e),r),[t,n]}const Wt=[0,1,2],Kt=({_ref:e,_key:r="mujoco-default",src:t="",assets:n=[],workDir:l="/workspace",selfProvide:i=!0,timeout:o,threshold:s=.001,fps:d=60,speed:y=1,pause:p=!1,frameKeys:c="name time qpos mocap_pos mocap_quat site_xpos geom_xpos sensordata",visible:f=Wt,useDrag:M=!0,unpauseOnDrag:v=!0,dragForceScale:a=1,showDragArrow:_=!0,showDragForceText:u=!0,useLights:m=!0,useMocap:g=!0,mocapGizmoScale:h,mocapHandleSize:b,mocapMarkerScale:A,mocapHandleWireframe:k,children:R,...C})=>{const{uplink:F,downlink:I}=pr(),[j,S,T]=Ut(p),z=zr(),q=Ir(),E=we(J=>J.invalidate),{fps:N,speed:G,paused:ue,recording:he}=q||{paused:!1},H=x.useCallback(J=>{F?.publish({ts:Date.now(),etype:"ON_MUJOCO_LOAD",value:{keyFrame:J}})},[F]),X=x.useCallback((J,te)=>F?.publish({ts:Date.now(),etype:"ON_MUJOCO_FRAME",value:{dt:te,keyFrame:J}}),[E,F]);x.useEffect(()=>{const J=({ts:Je,value:B})=>{var U;z&&z!=null&&z.isRecording&&z?.addKeyFrame(Pr([{key:r,tag:"MuJoCo",...B?.keyFrame}],"children",((U=B?.keyFrame)==null?void 0:U.time)||Date.now()))},te=F.subscribe("ON_MUJOCO_FRAME",J),ve=F.subscribe("ON_MUJOCO_STEPPING",J);return()=>{te(),ve()}},[z,F,r]);const Q=x.useCallback((J,te)=>F?.publish({ts:Date.now(),etype:"ON_MUJOCO_STEPPING",value:{dt:te,keyFrame:J},silent:!0}),[E,F]),$=Jt(f),[W,_e]=Vt({visible:f},[$]),O=Rr(o),L=x.useCallback(()=>{O.current=o,v&&S?.(!1)},[v,S]),ce=x.useCallback(J=>{O.current=o,T.current&&S(!1)},[T,S]);return i?w.jsx(st,{children:w.jsx(Ke,{src:t,assets:n,workDir:l,children:w.jsxs(ar,{enabled:M,onDragStart:L,dragForceScale:a,showArrow:_,showForceText:u,children:[w.jsxs(sr,{_key:r,frameKeys:c,onLoad:H,...W,useLights:m,useMocap:g,onMocapMove:ce,mocapGizmoScale:h,mocapHandleSize:b,mocapMarkerScale:A,mocapHandleWireframe:k,...C,children:[R,w.jsx(lr,{...W,onChange:_e},`gctrl-${r}`)]},r),w.jsx(ir,{fps:d||N,speed:y||G,pause:j,timeoutRef:O,timeoutSteps:o,frameKeys:c,onFrame:X,onTimeout:S}),w.jsx(ur,{fps:d,speed:y,frameKeys:c,onFrame:Q,uplink:F,downlink:I})]})})},r):w.jsx(Ke,{src:t,assets:n,workDir:l,children:w.jsxs(ar,{enabled:M,onDragStart:L,children:[w.jsxs(sr,{_key:r,frameKeys:c,onLoad:H,...W,useLights:m,useMocap:g,onMocapMove:ce,mocapGizmoScale:h,mocapHandleSize:b,mocapMarkerScale:A,mocapHandleWireframe:k,...C,children:[R,w.jsx(lr,{...W,onChange:_e},`gctrl-${r}`)]},r),w.jsx(ir,{fps:d||N,speed:y||G,pause:j,timeoutRef:O,timeoutSteps:o,frameKeys:c,onFrame:X,onTimeout:S}),w.jsx(ur,{fps:d,speed:y,frameKeys:c,onFrame:Q,uplink:F,downlink:I})]})})};function Xt(e,r,t){return e=Math.max(r,e),e=Math.min(t,e),e}const Qt=({ctrlId:e=-1,offset:r=.01,low:t=.01,high:n=1,cond:l="right-squeeze",value:i="right:thumb-tip,right:index-finger-tip",scale:o=1})=>{const{sim:s,model:d}=Y()||{};ae(()=>{var y,p,c;if(!be.leftLandmarks&&!be.rightLandmarks)return;const[f,M]=i.split(","),[v,a]=f.split(":"),[_,u]=M.split(":"),m=(y=be[`${v}Landmarks`])==null?void 0:y[a],g=(p=be[`${_}Landmarks`])==null?void 0:p[u];if(!m||!g)return;const[h,b]=l.split("-");if(!((c=be)!=null&&c[h][b]))return;const A=Ar(Ve(m),Ve(g))-r,k=Xt(A*o,t,n),R=[...s.ctrl];e=(R.length+e)%R.length,R[e]=k,s.ctrl.set(R)})};function Yt(e,r,t){return e=Math.max(r,e),e=Math.min(t,e),e}const Zt=({ctrlId:e=-1,offset:r=0,low:t=0,high:n=.2,cond:l="right-trigger",scale:i=1})=>{const{sim:o}=Y()||{};return ae(()=>{if(!o||!Fe.left&&!Fe.right)return;const[s,d]=l.split("-"),y=Fe[s];if(!y)return;const p=1-y[`${d}Value`]-r,c=Yt(p*i,t,n),f=[...o.ctrl];e=(f.length+e)%f.length,f[e]=c,o.ctrl.set(f)}),null},en=(e=!1)=>{const[r,t,n]=x.useMemo(()=>{if(e)return[null,null,null];const l=new Kr(-1,1,1,-1,0,1),i=new qe,o=new hr(2,2),s=new Ne(o,i),d=new Xr;return d.add(s),[d,i,l]},[]);return x.useCallback(({renderer:l,texture:i})=>{var o;t&&(t.map!==i&&((o=t.map)==null||o.dispose(),t.map=i,t.needsUpdate=!0),l.setRenderTarget(null),l.render(r,n))},[e])};async function rn({renderer:e,quality:r}){const t=e.getContext(),n=e.domElement.width,l=e.domElement.height,i=new Uint8Array(n*l*4);return t.readPixels(0,0,n,l,t.RGBA,t.UNSIGNED_BYTE,i),await(await e.domElement.convertToBlob({quality:r,type:"image/jpeg"})).arrayBuffer().then(o=>new Uint8Array(o))}function tn({_ref:e,_key:r,hide:t,width:n=640,height:l=480,matrix:i,fov:o=60,top:s=1,bottom:d=-1,left:y=-1,right:p=1,near:c=.1,far:f=20,renderDepth:M=!1,distanceToCamera:v=.5,ctype:a="perspective",scale:_=10,fps:u=30,downsample:m=2,quality:g=1,showCameraFrustum:h=!0,movable:b=!0,movableScale:A=1,children:k=[],...R}){var C;const F=x.useRef(null),I=x.useRef(null),j=x.useRef(null),{size:S,camera:T,scene:z}=we(),q=window.devicePixelRatio||1,E=Er(n*q,l*q,M?{depthBuffer:!0}:{}),{sendMsg:N,downlink:G,uplink:ue}=pr(),he=x.useCallback(()=>{if(!j.current||!F.current)return;const O=F.current,L=j.current;O.matrix.copy(L.matrix),O.matrix.decompose(O.position,O.quaternion,O.scale),O.rotation.setFromQuaternion(O.quaternion),N({ts:Date.now(),etype:"CAMERA_MOVE",key:r,value:{matrix:O.matrix.toArray()}})},[j.current,F.current,N]),H=Z(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",{showCameraFrustum:{value:h,label:"ShowFrustum"},camType:{value:a,options:["perspective","orthographic"]}}),X=Z(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",{near:{value:c,min:.001,step:.05},far:{value:f,min:.1,step:.1},scale:{value:_,min:.1,step:.1}},[c,f]),Q=Z(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",H.camType==="perspective"?{fov:{value:o,min:0,max:170},aspect:{value:n/l,min:.1,max:10}}:{},[H.camType,o,n,l]),$=Z(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",H.camType==="orthographic"?{top:{value:s,min:-10,step:.1},bottom:{value:d,min:-10,step:.1},left:{value:y,min:-10,step:.1},right:{value:p,min:-10,step:.1}}:{},[H.camType,s,d,y,p]),W=x.useMemo(()=>{const O=new Wr({canvas:new OffscreenCanvas(n/m,l/m),antialias:!1,precision:"highp",preserveDrawingBuffer:!0,depth:!0});return O.autoClear=!1,O.setPixelRatio(q),O},[q,l,n,m]);x.useEffect(()=>{let O;H.camType==="perspective"?O=Q.aspect:O=($.right-$.left)/($.top-$.bottom),F.current.aspect=O,F.current.updateProjectionMatrix(),W.setSize(Math.floor(O*l/m),Math.floor(l/m),!1),W.setPixelRatio(q),E.setSize(O*l*q,l*q)},[q,l,n,m,Q.aspect,$.top,$.bottom,$.left,$.right,H.camType]),x.useLayoutEffect(()=>{if(!F.current||!i||i.length!==16)return;const O=F.current;O.matrix.fromArray(i),O.matrix.decompose(O.position,O.quaternion,O.scale),O.rotation.setFromQuaternion(O.quaternion);const L=b?j?.current:I?.current;L&&(L.matrix.fromArray(i),L.matrix.decompose(L.position,L.quaternion,L.scale),L.rotation.setFromQuaternion(L.quaternion))},[i,(C=F.current)==null?void 0:C.uuid]);const _e=en();return x.useEffect(()=>{if(G)return G.subscribe("MJ_RENDER",async({key:O,rtype:L,data:{quality:ce=1}})=>{if(!F.current||O!==r)return;W.setRenderTarget(E),W.render(z,F.current);const J={ts:Date.now(),etype:L||"MJ_RENDER_RESPONSE",key:O,value:{dpr:q,width:n,height:l}};_e({renderer:W,texture:E.texture}),J.value.frame=await rn({renderer:W,quality:ce}),N(J)})},[N,G,ue,m,W,W.domElement,E]),t?null:w.jsxs(w.Fragment,{children:[H.showCameraFrustum&&!b?w.jsx(We,{_ref:I,...Q,...X,showFocalPlane:!1,...R,children:k}):null,H.showCameraFrustum&&b?w.jsxs(Tr,{_ref:j,onMove:he,matrix:i,scale:A,...R,children:[w.jsx(We,{_ref:I,scale:1/A,...Q,...X,showFocalPlane:!1}),k]}):null,H.camType==="perspective"?w.jsx(Fr,{ref:F,near:X.near,far:X.far,...Q,...R}):null,H.camType==="orthographic"?w.jsx(Cr,{ref:F,near:X.near,far:X.far,...$,...R}):null]})}function nn(e){const r=x.useMemo(()=>new D,[]),t=Array.isArray(e)?e[0]:e.x,n=Array.isArray(e)?e[1]:e.y,l=Array.isArray(e)?e[2]:e.z;x.useMemo(()=>{Array.isArray(e)?r.set(e[0],e[1],e[2]):r.copy(e)},[r,t,n,l]);const i=x.useCallback(o=>{Array.isArray(o)?r.set(o[0],o[1],o[2]):r.copy(o)},[r]);return[r,i]}const cr=e=>new D(e.x,-e.z,e.y),an=({_key:e,bodyId:r,enabled:t=!0,scale:n=20,forceDestination:l=[1,1,1],showForceVector:i=!1,showForceText:o=!1,showPivotControls:s=!0})=>{let d;try{d=Y()}catch(T){return console.warn("AnchorActuator: Error accessing MuJoCo context:",T),null}if(!d)return console.warn("AnchorActuator: Must be used within MuJoCoProvider"),null;const{sim:y,model:p}=d,{camera:c}=we(),[f]=Te(),[M,v]=nn(l),[a,_]=x.useState(new D),[u,m]=x.useState(new D),[g,h]=x.useState(!1),[b,A]=x.useState(""),k=x.useRef(null),R=x.useCallback(()=>{if(!t||!y||!p||r<=0||r>=p.nbody)return;const T=re(y.xpos,r),z=new D(...T),q=M.clone().sub(z).multiplyScalar(n),E=cr(q),N=cr(z);if(y.applyForce(E.x,E.y,E.z,0,0,0,N.x,N.y,N.z,r),i||o){const G=new D(N.x,N.z,-N.y),ue=G.clone().add(new D(E.x,E.z,-E.y).multiplyScalar(.01));if(i&&(_(G),m(ue)),o){const he=E.x.toFixed(2),H=E.y.toFixed(2),X=E.z.toFixed(2),Q=`|F|: ${E.length().toFixed(2)} N
Fx: ${he}
Fy: ${H}
Fz: ${X}`;A(Q),h(!0)}}},[t,y,p,r,M,n,i,o]),C=x.useMemo(()=>{const T=new pe;return T.makeTranslation(M.x,M.y,M.z),T},[M]),F=T=>{const z=new D;z.setFromMatrixPosition(T),v(z)};x.useEffect(()=>{if(!(!t||!y||!p))return f(R)},[t,y,p,R,f]);const I=x.useMemo(()=>{const T=u.clone().sub(a);return T.length()>0?T.normalize():new D(0,1,0)},[a.x,a.y,a.z,u.x,u.y,u.z]),j=x.useMemo(()=>u.distanceTo(a),[a.x,a.y,a.z,u.x,u.y,u.z]),S=x.useMemo(()=>{const T=new xe;return T.setFromUnitVectors(new D(0,1,0),I),T},[I]);return ae(()=>{k.current&&g&&k.current.quaternion.copy(c.quaternion)}),w.jsxs(w.Fragment,{children:[i&&j>0&&w.jsxs("group",{position:a,quaternion:S,children:[w.jsxs("mesh",{position:[0,j/2,0],children:[w.jsx("cylinderGeometry",{args:[.005,.005,j,8]}),w.jsx("meshBasicMaterial",{color:"red",transparent:!0,opacity:.7})]}),w.jsxs("mesh",{position:[0,j,0],children:[w.jsx("coneGeometry",{args:[.02,.05,8]}),w.jsx("meshBasicMaterial",{color:"red",transparent:!0,opacity:.7})]})]}),o&&w.jsx(fr,{ref:k,position:u,fontSize:.05,color:"white",anchorX:"center",anchorY:"middle",visible:g,"material-depthTest":!1,"material-depthWrite":!1,renderOrder:999,children:b}),s&&w.jsx(dr,{matrix:C,onDrag:F,scale:.5,lineWidth:2,annotations:!0,depthTest:!1})]})},mr="0.0.96",Be="@vuer-ai/vuer",on="7df789b";function sn({className:e,packageName:r,packageFullName:t,versionText:n,linkable:l=!0,gitHash:i}){const o=t&&n?`https://www.npmjs.com/package/${t}/v/${n.replace("v","")}`:void 0;return w.jsxs("div",{className:`rounded-uk-xs rounded-r-uk-xs text-uk-sm bg-icon-withbg inline-flex items-center ${e||""}`,style:l?{cursor:"pointer"}:void 0,children:[(r||n)&&w.jsxs("div",{className:"rounded-uk-xs inline-flex items-center overflow-hidden",children:[r&&w.jsx("span",{className:"pl-sm pr-xs py-xxxs bg-brand-primary text-text-withbg text-uk-xs",style:{backgroundColor:"var(--color-brand-primary, var(--brand-primary))",color:"white",textShadow:"0 1px 2px rgba(0, 0, 0, 0.3), inset 0 -1px 0 rgba(255, 255, 255, 0.1)"},children:r}),n&&w.jsx("a",{href:l&&o?o:void 0,className:["pl-xs pr-sm py-xxxs rounded-r-uk-xs","bg-alt-primary","text-text-secondary","text-text-primary text-uk-xs",l&&"hover:text-brand-primary"].join(" "),style:{textShadow:"0 1px 1px rgba(0, 0, 0, 0.2), inset 0 -1px 0 rgba(255, 255, 255, 0.05)"},onClick:l?void 0:s=>s.preventDefault(),children:n})]}),i&&i!=="unknown"&&w.jsxs("a",{href:l?`https://github.com/vuer-ai/mujoco-ts/commit/${i}`:void 0,className:"px-md rounded-uk-ssx font-number-input text-text-tertiary text-uk-xs ml-[0px] bg-transparent py-[0px]",onClick:l?void 0:s=>s.preventDefault(),children:[w.jsx(Gr,{className:"mr-[2px] inline-block size-2"}),i]})]})}function ln({className:e,package:r=!1,prefix:t=!1,linkable:n=!1,version:l=!1,hash:i=!1}){const o=Be.split("/").pop()||Be,s=l?t?`v${mr}`:mr:void 0;return w.jsx(sn,{className:e,packageName:r?o:void 0,packageFullName:Be,versionText:s,linkable:n,gitHash:i?on:void 0})}const An="name time qpos qvel act ctrl mocap_pos mocap_quat site_xpos site_xmat geom_xpos geom_xmat sensordata qfrc_applied xfrc_applied",un=(e=!1)=>{if(fe.MuJoCo){if(console.warn("MuJoCo already registered:"),!e)return;console.info("Force reload MuJoCo module.")}fe.MuJoCo=Kt,fe.HandActuator=Qt,fe.MotionControllerActuator=Zt,fe.MjCameraView=tn,fe.AnchorActuator=an,fe.MjBadge=ln,console.info("vuer-mujoco registered:",fe)};Jr["@vuer-ai/mujoco-ts"]=un;export{An as ALL_KEYFRAME_KEYS,an as AnchorActuator,on as GIT_HASH,Qt as HandActuator,ln as MjBadge,tn as MjCameraView,Zt as MotionControllerActuator,Kt as MuJoCo,sr as MuJoCoModel,Mr as MuJoCoModuleContext,st as MuJoCoModuleProvider,Ke as MuJoCoProvider,mr as PACKAGE_VERSION,sn as PackageBadge,tt as dir2Euler,un as entrypoint,re as getPosition,je as getQuaternion,Rn as getRotMatrix,ye as range,kn as setPosition,Sn as setQuaternion,P as subArray,Lt as useInterval,Y as useMuJoCo,me as useMuJoCoModule,Ut as useStateRef,Rr as useValueRef,nn as useVec3State};
