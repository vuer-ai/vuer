import{r as x,j as w,P as Le}from"./chunk-CbEqrEPI.js";import{f as ve,l as B,M as pe,Q as xe,as as oe,at as xr,au as hr,av as ke,aw as Fr,ax as Xe,ay as zr,az as _r,aA as ee,aB as Cr,aC as Qe,aD as Ir,aE as Pr,aF as qr,aG as Ie,aH as Nr,aI as Or,aJ as Dr,aK as de,a9 as Gr,al as Be,aL as gr,s as Ue,aM as Br,aN as Ur,aO as yr,ak as $r,am as He,aP as Lr,aQ as Hr,aq as wr,aR as Jr,aS as Vr,O as Wr,y as vr,a2 as Se,k as Ae,aT as se,w as Ee,K as Re,aU as le,aV as ie,aW as ue,aX as Kr,aY as Xr,aZ as Je,a_ as Qr,a$ as Yr,b0 as Zr,_ as et,b1 as rt,b2 as br,b3 as kr,t as tt,b4 as at}from"./chunk-DDHYV_Nw.js";import nt from"./chunk-wSzcG2rU.js";import"./chunk-tuBEHo31.js";/* empty css              */import"./chunk-BXl3LOEh.js";function N(e,r,t){const a=e.BYTES_PER_ELEMENT||e.byteLength/e.length,l=e.byteOffset+r*a,u=Math.min(t,e.length);return new e.constructor(e.buffer,l,u)}function te(e,r){const t=N(e,r*3,3);return[t[0],t[2],-t[1]]}function ga(e,r,t){r[t*3]=e[0],r[t*3+1]=-e[2],r[t*3+2]=-e[1]}function je(e,r){const t=N(e,r*4,4);return[t[1],t[3],-t[2],t[0]]}function ya(e,r,t){r[t*4]=e[3],r[t*4+1]=e[0],r[t*4+2]=-e[2],r[t*4+3]=-e[1]}function wa(e,r){const t=N(e,r*9,9);return[t[0],t[3],t[6],t[2],t[5],t[8],-t[1],-t[4],-t[7]]}function ot(e,r,t){const a=r[3*t]-e[3*t],l=r[3*t+2]-e[3*t+2],u=r[3*t+1]-e[3*t+1],o=Math.atan2(l,a),s=Math.atan2(Math.sqrt(a*a+l*l),u);return[o,s,0]}function*we(e,r,t=1){if(typeof r>"u"&&(r=e,e=0),!(t>0&&e>=r||t<0&&e<=r))for(let a=e;t>0?a<r:a>r;a+=t)yield a}function Mr(e){var r;return((r=e.split("/").pop())==null?void 0:r.split("?")[0].split("#")[0])||""}function $e(e){try{const r=new URL(e);if(r.protocol==="http:"||r.protocol==="https:"){const t=r.pathname.split("/").slice(0,-1);return t.length>1?t.join("/"):"/"}else if(r.protocol==="file:"){const t=r.pathname.split("/").slice(0,-1);return decodeURI(t.join("/"))}else throw new Error("Invalid URL provided: unsupported protocol")}catch{const r=e.replace(/\/+$/,"").split("/");return r.length<=1?"":r.slice(0,-1).join("/")}}function jr(...e){return e.filter(r=>r).map((r,t)=>t===0?r.replace(/\/+$/,""):r.replace(/^\/+/,"")).join("/")}async function st(e,r,t){const a=await fetch(r),l=t.split("/");let u="";for(let s=0;s<l.length-1;s++)u+=l[s],e.analyzePath(u).exists||e.mkdir(u),u+="/";if(t.endsWith(".urdf")){const s=await a.text(),d=lt(s);e.writeFile(t,d);return}const o=new Uint8Array(await a.arrayBuffer());e.writeFile(t,o)}function lt(e){const r=new DOMParser().parseFromString(e,"application/xml");let t=0;function a(l,u){return t++,`${l}.${u.join(".")}.${t}`}return Array.from(r.getElementsByTagName("link")).forEach((l,u)=>{const o=[String(u+1)];Array.from(l.getElementsByTagName("visual")).forEach((s,d)=>{const y=[...o,String(d)];s.hasAttribute("name")||s.setAttribute("name",a("visual",y)),Array.from(s.getElementsByTagName("geometry")).forEach((p,c)=>{const f=[...y,String(c)];p.hasAttribute("name")||p.setAttribute("name",a("geom",f))})}),Array.from(l.getElementsByTagName("collision")).forEach((s,d)=>{const y=[...o,String(d)];s.hasAttribute("name")||s.setAttribute("name",a("collision",y)),Array.from(s.getElementsByTagName("geometry")).forEach((p,c)=>{const f=[...y,String(c)];p.hasAttribute("name")||p.setAttribute("name",a("geom",f))})})}),new XMLSerializer().serializeToString(r)}async function it(e,r,t,a){let l={};l=Array.isArray(t)?Object.fromEntries([r,...t].map(u=>[$e(u)+"/"+Mr(u),u])):t||{},await Promise.all(Object.keys(l).map(async u=>{const o=l[u];try{await st(e,o,jr(a,u))}catch(s){console.error(`Error downloading asset at ${o}:`,s)}})),console.info(`file download complete for ${t?.length||Object.keys(l).length} assets.`)}const Sr=x.createContext(null),ut=({children:e})=>{const[r,t]=x.useState(null);return x.useEffect(()=>{let a=!0;return nt().then(l=>{a&&t(l)}),()=>{a=!1,console.info("removing MuJoCo module!"),t(null)}},[]),r?w.jsx(Sr.Provider,{value:r,children:e}):null},fe=()=>{const e=Le.useContext(Sr);return e||(console.warn("mujoco has not been initialized. Make sure that you are using MuJoCoProvider, because useMuJoCo must be used within it.",e),null)},Ar=x.createContext(null);function Ye({src:e,workDir:r="/workspace",assets:t=null,children:a,...l}){var u;const o=fe(),s=x.useRef(!1),[d,y]=x.useState(null);let p;Array.isArray(t)?p=e+","+t?.join(","):p=e+","+((u=Object.values(t||{}))==null?void 0:u.join(",")),x.useEffect(()=>{console.log("shall I download?"),!s.current&&o!=null&&o.FS&&(s.current=!0,console.log("I am downloading."),it(o.FS,e,t,r).then(()=>{const f=jr(r,$e(e),Mr(e));f&&(console.log("I have downloaded."),y(f),s.current=!1)}))},[o?.FS,e,r,t,p]);const c=x.useMemo(()=>{var f,k;if(console.log("triggered useMemo",s.current,d,p),s.current)return{sim:null,dt:null,model:null,state:null,mujoco:o};if(!(o!=null&&o.FS)||!d)return{sim:null,dt:null,model:null,state:null,mujoco:o};const v=$e(d);o.FS.chdir(v),console.log("creating a new MuJoCo instance",p);const n=new o.Model(d),_=new o.State(n),i=new o.Simulation(n,_),m=(k=(f=n?.getOptions)==null?void 0:f.call(n))==null?void 0:k.timestep;return{sim:i,model:n,dt:m,state:_,mujoco:o}},[d,p,s.current]);return!c.mujoco||!c.sim?null:w.jsx(Ar.Provider,{value:c,children:a})}const Z=()=>{const e=Le.useContext(Ar);return(!e.sim||!e.model)&&console.warn(`
    MuJoCo has not been initialized.
    Make sure that you are using MuJoCoProvider, because
    useMuJoCo must be used within a MuJoCoProvider.
    `),e};function Ze(e,r,t=null){if(!t&&e.length!==r.length)return!1;for(let a=0;a<Math.min(t||e.length,r.length);a++)if(e[a]!==r[a])return!1;return!0}const ct=e=>`#${e.map(r=>Math.round(r*255).toString(16).padStart(2,"0")).join("")}`,mt=({n:e,ambient:r})=>{const{mjtLightType:t}=fe(),{sim:a,model:l}=Z(),u=x.useRef(null);return oe(()=>{var o;const s=(o=u.current)==null?void 0:o.children;s&&a.light_xpos.length&&a.light_xdir.length&&s.forEach((d,y)=>{if(!("isLight"in d))return;const p=d,c=te(a.light_xpos,y),f=ot(a.light_xpos,a.light_xdir,y);p&&(Ze(p.position.toArray(),c)?(p.position.set(...c),p.rotation.set(...f)):Ze([...p.rotation],f)&&p.rotation.set(...f))})}),w.jsx("group",{ref:u,children:Array.from(we(0,e)).map((o,s)=>{const d=Array.from(l.light_diffuse.slice(3*s,3*s+3)),y=ct(d),p=l.light_castshadow[s]?{castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-25,"shadow-camera-right":25,"shadow-camera-top":25,"shadow-camera-bottom":-25}:{};return l.light_type[s]==t.mjLIGHT_DIRECTIONAL?w.jsx(Jr,{_key:`mj-directional-light-${s}`,intensity:1,color:y,...p},s):w.jsx(Vr,{_key:`mj-spot-light-${s}`,intensity:1,color:y,decay:l.light_attenuation[3*s],penumbra:.5,...p},s)})},"lighting-gorup")},ft=/^(left|right)-(index|middle|ring|pinky)-finger-(tip|phalanx-distal|phalanx-intermediate|phalanx-proximal)$/,dt=/^(left|right)-thumb-(tip|phalanx-distal|phalanx-proximal)$/,pt=/^(left|right)-wrist$/,xt=({id:e,mocapId:r,mocap_pos:t,mocap_quat:a,names:l,onSiteMove:u,showFrame:o=!0,markerScale:s=.1,gizmoScale:d,handleSize:y,handleWireframe:p})=>{const c=te(t,r[e]),f=je(a,r[e]),k=l[r[e]];console.log("mocap site",e,r[e],c,f,k);const[v,n]=x.useMemo(()=>[new B(...c),new xe(...f)],[c,f]),_=x.useMemo(()=>{const M=new pe;return M.compose(new B(...c),new xe(...f),new B(1,1,1)),M},[c,f]),i=x.useCallback(M=>{v.setFromMatrixPosition(M),n.setFromRotationMatrix(M);const S=r[e]*3;t[S]=v.x,t[S+1]=-v.z,t[S+2]=v.y;const T=r[e]*4;a[T]=n.w,a[T+1]=n.x,a[T+2]=-n.z,a[T+3]=n.y,u?.({site_id:e})},[u,t,a,r,e,v,n]),m=x.useCallback(({world:M})=>i(M),[i]),h=yr(({mode:M})=>M),g=h==="immersive-ar"||h==="immersive-vr",b=k.endsWith("-relative"),E=b?k.replace("-relative",""):k,j=E.match(ft),A=E.match(dt),I=E.match(pt);let F=null,z=null;if(j){const[,M,S,T]=j;z=`${S}-finger-${T}`,F=M}else if(A){const[,M,S]=A;z=`thumb-${S}`,F=M}else if(I){const[,M]=I;z="wrist",F=M}return z&&F?w.jsx(Kr,{jointName:z,position:c,quaternion:f,hand:F,markerScale:.2*s,relativeTracking:b,onMove:m,showFrame:!0}):g?w.jsx(Xr,{position:c,quaternion:f,showFrame:!0,onMove:m,markerScale:s,handleSize:y,wireframe:p}):w.jsx(hr,{matrix:_,annotations:!0,onDrag:i,scale:d||s,lineWidth:5,disableScaling:!0,visible:!o,depthTest:!1},e)},Er=({n:e,mocapId:r,mocap_pos:t,mocap_quat:a,names:l,showFrame:u,onMove:o,gizmoScale:s,markerScale:d=1,handleWireframe:y=!1,handleSize:p=.1})=>{const{showMocapFrame:c}=ee("Render",{showMocapFrame:{value:u}},[u]),f=x.useMemo(()=>new Set,[]),k=x.useCallback(v=>{f.add(v.site_id),setTimeout(()=>{if(!f.size){console.log(Er.name,"async timeout with no dirty mocap");return}const n=[...f];f.clear(),o({mocap_ids:n})},0)},[f,o]);return w.jsx("group",{children:Array.from(we(0,e)).filter(v=>r[v]>=0).map(v=>w.jsx(xt,{id:v,_key:`mocap-${v}`,mocapId:r,mocap_pos:t,mocap_quat:a,gizmoScale:s,markerScale:d,handleSize:p,handleWireframe:y,names:l,showFrame:c,onSiteMove:k},`mocap-${v}`))},"mocap-group")};function ht({model:e,skinId:r,...t}){const a=e.skin_matid[r],{mjtTextureRole:l}=fe(),u=e.mat_texid[a*l.mjNTEXROLE.value+l.mjTEXROLE_RGB.value],{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Ae().setRGB(e.skin_rgba[r*4],e.skin_rgba[r*4+1],e.skin_rgba[r*4+2],se),k=e.geom_rgba[r*4+3];if(a!=-1&&(f=f.setRGB(e.mat_rgba[a*4],e.mat_rgba[a*4+1],e.mat_rgba[a*4+2],se),k=e.mat_rgba[a*4+3],u!=-1)){const v=e.tex_width[u],n=e.tex_height[u],_=e.tex_adr[u],i=e.tex_data,m=new Uint8Array(v*n*4);for(let g=0;g<v*n;g++)m[g*4]=i[_+g*3],m[g*4+1]=i[_+(g*3+1)],m[g*4+2]=i[_+(g*3+2)],m[g*4+3]=255;if(e.tex_colorspace[u]==1)for(let g=0;g<m.length;g+=4)for(let b=0;b<3;b++){const E=m[g+b]/255;m[g+b]=Math.pow(E,1/2.2)*255}c=new Ee(m,v,n,Re);const h=e.tex_type[u];switch(h){case 0:c.wrapS=ue,c.wrapT=ue,e.mat_texuniform[a]==1?(console.log("Texture repeat on skin error"),console.assert(!1)):c.repeat.set(e.mat_texrepeat[a*2],e.mat_texrepeat[a*2+1]);break;case 1:c.wrapS=ie,c.wrapT=ie;break;case 2:c.wrapS=le,c.wrapT=le;break;default:console.warn(`Unsupported texture type: ${h}`)}c.needsUpdate=!0}return{color:f,alpha:k,texture:c}},[r]),{mode:y,wireframe:p}=ee("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:a!=-1?e.mat_specular[a]:void 0,reflectivity:a!=-1?e.mat_reflectance[a]:void 0,roughness:a!=-1?1-e.mat_shininess[a]:void 0,metalness:a!=-1?.4:void 0,map:d,wireframe:p,...t})}function _t(e){return new Float32Array([-e[0],-e[1],-e[2],e[3]])}function gt(e,r){return new Float32Array([e[3]*r[0]+e[0]*r[3]+e[1]*r[2]-e[2]*r[1],e[3]*r[1]-e[0]*r[2]+e[1]*r[3]+e[2]*r[0],e[3]*r[2]+e[0]*r[1]-e[1]*r[0]+e[2]*r[3],e[3]*r[3]-e[0]*r[0]-e[1]*r[1]-e[2]*r[2]])}function yt(e){const r=e[0],t=e[1],a=e[2],l=e[3],u=r+r,o=t+t,s=a+a,d=r*u,y=r*o,p=r*s,c=t*o,f=t*s,k=a*s,v=l*u,n=l*o,_=l*s;return new Float32Array([1-(c+k),y+_,p-n,y-_,1-(d+k),f+v,p+n,f-v,1-(d+c)])}function er(e,r){return new Float32Array([e[0]*r[0]+e[1]*r[1]+e[2]*r[2],e[3]*r[0]+e[4]*r[1]+e[5]*r[2],e[6]*r[0]+e[7]*r[1]+e[8]*r[2]])}function wt(e,r,t){!e.skin_scenevert||e.skin_scenevert.length!==3*e.nskinvert?e.skin_scenevert=new Float32Array(3*e.nskinvert):e.skin_scenevert.fill(0),!e.skin_normal||e.skin_normal.length!==3*e.nskinvert?e.skin_normal=new Float32Array(3*e.nskinvert):e.skin_normal.fill(0);const a=e.skin_vertadr[t],l=e.skin_scenevert;for(let s=e.skin_boneadr[t];s<e.skin_boneadr[t]+e.skin_bonenum[t];s++){let d=N(e.skin_bonebindpos,3*s,3),y=N(e.skin_bonebindquat,4*s,4),p=e.skin_bonebodyid[s],c=N(r.xquat,4*p,4),f=_t(y),k=gt(c,f),v=yt(k),n=er(v,d);for(let _=0;_<3;_++)n[_]=r.xpos[3*p+_]-n[_];for(let _=e.skin_bonevertadr[s];_<e.skin_bonevertadr[s]+e.skin_bonevertnum[s];_++){let i=e.skin_bonevertid[_],m=e.skin_bonevertweight[_],h=N(e.skin_vert,3*(i+a),3),g=er(v,h);for(let b=0;b<3;b++)g[b]+=n[b];for(let b=0;b<3;b++)l[3*(i+a)+b]+=m*g[b]}}for(let s=e.skin_faceadr[t];s<e.skin_faceadr[t]+e.skin_facenum[t];s++){let d=e.skin_face[3*s],y=e.skin_face[3*s+1],p=e.skin_face[3*s+2],c=new Float32Array(3),f=new Float32Array(3);for(let v=0;v<3;v++)c[v]=l[3*(y+a)+v]-l[3*(d+a)+v],f[v]=l[3*(p+a)+v]-l[3*(d+a)+v];let k=new Float32Array(3);k[0]=c[1]*f[2]-c[2]*f[1],k[1]=c[2]*f[0]-c[0]*f[2],k[2]=c[0]*f[1]-c[1]*f[0];for(let v=0;v<3;v++)e.skin_normal[3*(d+a)+v]+=k[v],e.skin_normal[3*(y+a)+v]+=k[v],e.skin_normal[3*(p+a)+v]+=k[v]}for(let s=a;s<a+e.skin_vertnum[t];s++){let d=N(e.skin_normal,3*s,3),y=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]),p=1/Math.max(1e-6,y);for(let c=0;c<3;c++)e.skin_normal[3*s+c]*=p}if(e.skin_inflate){let s=e.skin_inflate[t];for(let d=a;d<a+e.skin_vertnum[t];d++)for(let y=0;y<3;y++)l[3*d+y]+=s*e.skin_normal[3*d+y]}let u=l;for(let s=0;s<u.length;s+=3){const d=u[s+1];u[s+1]=u[s+2],u[s+2]=-d}let o=e.skin_normal;for(let s=0;s<o.length;s+=3){const d=o[s+1];o[s+1]=o[s+2],o[s+2]=-d}return{face_vertices:u,normal:o}}function vt({model:e,simulation:r,skinId:t,...a}){const l=x.useRef(null),u=x.useMemo(()=>Uint32Array.from(N(e.skin_face,3*e.skin_faceadr[t],3*e.skin_facenum[t])),[e]),o=x.useMemo(()=>{let s;return e.skin_texcoordadr[t]>=0&&(s=N(e.skin_texcoord,2*e.skin_texcoordadr[t],2*e.skin_vertnum[t])),s},[e]);return oe(()=>{const s=l.current;if(!s)return;const{face_vertices:d,normal:y}=wt(e,r,t);try{s.attributes.position.array.set(d),s.attributes.position.needsUpdate=!0}catch{s.setAttribute("position",new Se(new Float32Array(d.length),3))}try{s.attributes.normal.array.set(y),s.attributes.normal.needsUpdate=!0}catch{s.setAttribute("normal",new Se(new Float32Array(y.length),3))}}),w.jsxs("bufferGeometry",{ref:l,...a,children:[u!=null&&u.length?w.jsx("bufferAttribute",{attach:"index",array:u,count:u.length,itemSize:1}):null,o!=null&&o.length?w.jsx("bufferAttribute",{attach:"attributes-uv",array:o,count:o.length/2,itemSize:2}):null]})}function bt({model:e,simulation:r,skinId:t,...a}){return w.jsxs("mesh",{receiveShadow:!0,castShadow:!0,frustumCulled:!1,...a,children:[w.jsx(vt,{attach:"geometry",model:e,simulation:r,skinId:t}),w.jsx(ht,{attach:"material",model:e,skinId:t,...a})]})}function kt(e,r=!1){const t=e[0].index!==null,a=new Set(Object.keys(e[0].attributes)),l=new Set(Object.keys(e[0].morphAttributes)),u={},o={},s=e[0].morphTargetsRelative,d=new tt;let y=0;for(let p=0;p<e.length;++p){const c=e[p];let f=0;if(t!==(c.index!==null))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const k in c.attributes){if(!a.has(k))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+'. All geometries must have compatible attributes; make sure "'+k+'" attribute exists among all geometries, or in none of them.'),null;u[k]===void 0&&(u[k]=[]),u[k].push(c.attributes[k]),f++}if(f!==a.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". Make sure all geometries have the same number of attributes."),null;if(s!==c.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const k in c.morphAttributes){if(!l.has(k))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+".  .morphAttributes must be consistent throughout all geometries."),null;o[k]===void 0&&(o[k]=[]),o[k].push(c.morphAttributes[k])}if(r){let k;if(t)k=c.index.count;else if(c.attributes.position!==void 0)k=c.attributes.position.count;else return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+p+". The geometry must have either an index or a position attribute"),null;d.addGroup(y,k,p),y+=k}}if(t){let p=0;const c=[];for(let f=0;f<e.length;++f){const k=e[f].index;for(let v=0;v<k.count;++v)c.push(k.getX(v)+p);p+=e[f].attributes.position.count}d.setIndex(c)}for(const p in u){const c=rr(u[p]);if(!c)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+p+" attribute."),null;d.setAttribute(p,c)}for(const p in o){const c=o[p][0].length;if(c===0)break;d.morphAttributes=d.morphAttributes||{},d.morphAttributes[p]=[];for(let f=0;f<c;++f){const k=[];for(let n=0;n<o[p].length;++n)k.push(o[p][n][f]);const v=rr(k);if(!v)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+p+" morphAttribute."),null;d.morphAttributes[p].push(v)}}return d}function rr(e){let r,t,a,l=-1,u=0;for(let y=0;y<e.length;++y){const p=e[y];if(r===void 0&&(r=p.array.constructor),r!==p.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(t===void 0&&(t=p.itemSize),t!==p.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(a===void 0&&(a=p.normalized),a!==p.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(l===-1&&(l=p.gpuType),l!==p.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;u+=p.count*t}const o=new r(u),s=new Se(o,t,a);let d=0;for(let y=0;y<e.length;++y){const p=e[y];if(p.isInterleavedBufferAttribute){const c=d/t;for(let f=0,k=p.count;f<k;f++)for(let v=0;v<t;v++){const n=p.getComponent(f,v);s.setComponent(f+c,v,n)}}else o.set(p.array,d);d+=p.count*t}return l!==void 0&&(s.gpuType=l),s}var tr=typeof Float32Array<"u"?Float32Array:Array;function Mt(){var e=new tr(3);return tr!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ye(e,r,t){return e[0]=r[0]+t[0],e[1]=r[1]+t[1],e[2]=r[2]+t[2],e}function Pe(e,r,t){return e[0]=r[0]-t[0],e[1]=r[1]-t[1],e[2]=r[2]-t[2],e}function jt(e,r){return e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e}function qe(e,r){var t=r[0],a=r[1],l=r[2],u=t*t+a*a+l*l;return u>0&&(u=1/Math.sqrt(u)),e[0]=r[0]*u,e[1]=r[1]*u,e[2]=r[2]*u,e}function ar(e,r,t){var a=r[0],l=r[1],u=r[2],o=t[0],s=t[1],d=t[2];return e[0]=l*d-u*s,e[1]=u*o-a*d,e[2]=a*s-l*o,e}function Ne(e,r,t,a){var l=[],u=[];return l[0]=r[0]-t[0],l[1]=r[1]-t[1],l[2]=r[2]-t[2],u[0]=l[0],u[1]=l[1]*Math.cos(a)-l[2]*Math.sin(a),u[2]=l[1]*Math.sin(a)+l[2]*Math.cos(a),e[0]=u[0]+t[0],e[1]=u[1]+t[1],e[2]=u[2]+t[2],e}(function(){var e=Mt();return function(r,t,a,l,u,o){var s,d;for(t||(t=3),a||(a=0),l?d=Math.min(l*t+a,r.length):d=r.length,s=a;s<d;s+=t)e[0]=r[s],e[1]=r[s+1],e[2]=r[s+2],u(e,e,o),r[s]=e[0],r[s+1]=e[1],r[s+2]=e[2];return r}})();function St({model:e,flexId:r,...t}){const a=e.flex_matid[r],{mjtTextureRole:l}=fe(),u=e.mat_texid[a*l.mjNTEXROLE.value+l.mjTEXROLE_RGB.value],{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Ae().setRGB(e.flex_rgba[r*4],e.flex_rgba[r*4+1],e.flex_rgba[r*4+2],se),k=e.geom_rgba[r*4+3];if(a!=-1&&(f=f.setRGB(e.mat_rgba[a*4],e.mat_rgba[a*4+1],e.mat_rgba[a*4+2],se),k=e.mat_rgba[a*4+3],u!=-1)){const v=e.tex_width[u],n=e.tex_height[u],_=e.tex_adr[u],i=e.tex_data,m=new Uint8Array(v*n*4);for(let g=0;g<v*n;g++)m[g*4]=i[_+g*3],m[g*4+1]=i[_+(g*3+1)],m[g*4+2]=i[_+(g*3+2)],m[g*4+3]=255;if(e.tex_colorspace[u]==1)for(let g=0;g<m.length;g+=4)for(let b=0;b<3;b++){const E=m[g+b]/255;m[g+b]=Math.pow(E,1/2.2)*255}c=new Ee(m,v,n,Re);const h=e.tex_type[u];switch(h){case 0:c.wrapS=ue,c.wrapT=ue,e.mat_texuniform[a]==1?(console.log("Texture repeat for flex error"),console.assert(!1)):c.repeat.set(e.mat_texrepeat[a*2],e.mat_texrepeat[a*2+1]);break;case 1:c.wrapS=ie,c.wrapT=ie;break;case 2:c.wrapS=le,c.wrapT=le;break;default:console.warn(`Unsupported texture type: ${h}`)}c.needsUpdate=!0}return{color:f,alpha:k,texture:c}},[r]),{mode:y,wireframe:p}=ee("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:a!=-1?e.mat_specular[a]:void 0,reflectivity:a!=-1?e.mat_reflectance[a]:void 0,roughness:a!=-1?1-e.mat_shininess[a]:void 0,metalness:a!=-1?.4:void 0,map:d,wireframe:p,...t})}function Oe(e){for(let r=0;r<e.nflex;r++)r==0?e.flex_faceadr[r]=0:e.flex_faceadr[r]=e.flex_faceadr[r-1]+e.flex_facenum[r-1]}function Me(e){let r=0;for(let t=0;t<e.nflex;t++)r+=e.flex_facenum[t];return r}function nr(e,r){if(e.flex_dim[r]==0)e.flex_facenum[r]=0;else if(e.flex_dim[r]==2)e.flex_facenum[r]=2*e.flex_shellnum[r]+2*e.flex_elemnum[r];else{let t=0,a=0,l=1;for(;l!==0;){l=0;for(let u=0;u<e.flex_elemnum[r];u++)e.flex_elemlayer[e.flex_elemadr[r]+u]===a&&l++;t=Math.max(t,l),a++}e.flex_facenum[r]=Math.max(e.flex_shellnum[r],4*t)}}function At({model:e,simulation:r,flexId:t,smoothShading:a=!0,...l}){const u=x.useRef(null);let o=e.flex_dim[t];const s=e.flex_texcoordadr[t]>=0?N(e.flex_texcoord,2*e.flex_texcoordadr[t],2*e.nflextexcoord):void 0;if(o===1){const n=x.useRef(null),_=x.useMemo(()=>new wr(e.flex_radius[t]),[e.flex_radius[t]]),i=x.useMemo(()=>new He(e.flex_radius[t],e.flex_radius[t]),[e.flex_radius[t]]);return oe(()=>{const m=[];for(let g=0;g<e.flex_vertnum[t];g++){const b=3*(e.flex_vertadr[t]+g),E=r.flexvert_xpos[b],j=r.flexvert_xpos[b+2],A=-r.flexvert_xpos[b+1];_.clone().applyMatrix4(new pe().makeTranslation(E,j,A))}for(let g=0;g<e.flex_edgenum[t];g++){const b=e.flex_edgeadr[t]+g,E=e.flex_edge[2*b],j=e.flex_edge[2*b+1],A=3*(e.flex_vertadr[t]+E),I=3*(e.flex_vertadr[t]+j),F=new B(r.flexvert_xpos[A],r.flexvert_xpos[A+2],-r.flexvert_xpos[A+1]),z=new B(r.flexvert_xpos[I],r.flexvert_xpos[I+2],-r.flexvert_xpos[I+1]),M=new B().subVectors(z,F),S=M.length(),T=new B().addVectors(F,z).multiplyScalar(.5);M.normalize();const C=new xe().setFromUnitVectors(new B(0,1,0),M),O=new pe().makeScale(1,S,1),R=new pe().makeRotationFromQuaternion(C),D=new pe().makeTranslation(T.x,T.y,T.z).multiply(R).multiply(O),P=i.clone();P.applyMatrix4(D),m.push(P)}const h=kt(m,!1);n.current&&(n.current.copy(h),n.current.computeVertexNormals())}),w.jsx("bufferGeometry",{ref:n,attach:"geometry",...l})}const d=x.useMemo(()=>{e.flex_facenum||(e.flex_facenum=new Int32Array(e.nflex)),e.flex_facenum[t]==0&&nr(e,t),e.flex_faceused||(e.flex_faceused=new Int32Array(e.nflex));let n=e.flex_facenum[t],_=new Int32Array(3*n),i=0;if(a)if(o==2){for(let m=0;m<e.flex_elemnum[t];m++){const h=N(e.flex_elemtexcoord,e.flex_elemdataadr[t]+m*(o+1),3);_[3*i]=h[0],_[3*i+1]=h[1],_[3*i+2]=h[2],i++,_[3*i]=h[0],_[3*i+1]=h[2],_[3*i+2]=h[1],i++}for(let m=0;m<e.flex_shellnum[t];m++){const h=N(e.flex_shell,e.flex_shelldataadr[t]+m*o,3);_[3*i]=h[0],_[3*i+1]=h[1],_[3*i+2]=h[1],i++,_[3*i]=h[1],_[3*i+1]=h[0],_[3*i+2]=h[0],i++}}else for(let m=0;m<e.flex_shellnum[t];m++){const h=N(e.flex_shell,e.flex_shelldataadr[t]+m*o,3);_[3*i]=h[0],_[3*i+1]=h[1],_[3*i+2]=h[2],i++}else for(let m=0;m<e.flex_elemnum[t];m++)if(o===2||e.flex_elemlayer[e.flex_elemadr[t]+m]==0)if(o==2){const h=N(e.flex_elemtexcoord,e.flex_elemdataadr[t]+m*(o+1),3);_[3*i]=h[0],_[3*i+1]=h[1],_[3*i+2]=h[2],i++,_[3*i]=h[0],_[3*i+1]=h[2],_[3*i+2]=h[1],i++}else{const h=N(e.flex_elemtexcoord,e.flex_elemdataadr[t]+m*(o+1),4);_[3*i]=h[0],_[3*i+1]=h[1],_[3*i+2]=h[2],i++,_[3*i]=h[0],_[3*i+1]=h[2],_[3*i+2]=h[3],i++,_[3*i]=h[0],_[3*i+1]=h[3],_[3*i+2]=h[1],i++,_[3*i]=h[1],_[3*i+1]=h[3],_[3*i+2]=h[2],i++}return e.flex_faceused[t]=i,e.flex_faceused[t]>e.flex_facenum[t]&&(console.log("Too many flex faces"),console.log(e.flex_faceused[t],e.flex_facenum[t])),_},[t]),y=x.useMemo(()=>{if(e.flex_facenum||(e.flex_facenum=new Int32Array(e.nflex)),e.flex_facenum[t]==0&&nr(e,t),!e.flex_scenetexcoord){let m=Me(e);e.flex_scenetexcoord=new Float32Array(6*m)}e.flex_faceadr||(e.flex_faceadr=new Int32Array(e.nflex),Oe(e));let n=e.flex_facenum[t],_=e.flex_texcoordadr[t]>=0?N(e.flex_scenetexcoord,6*e.flex_faceadr[t],6*n):void 0;if(!s)return _;let i=d.length/3;for(let m=0;m<i;m++)for(let h=0;h<3;h++){const g=d[m*3+h];_[m*6+h*2]=s[g*2],_[m*6+h*2+1]=s[g*2+1]}return _},[t,d[0]]);let p=new Float32Array(3),c=new Float32Array(3),f=new Float32Array(3);function k(n,_,i,m){if(n.flex_faceadr||(n.flex_faceadr=new Int32Array(n.nflex),Oe(n)),n.flex_faceused||(n.flex_faceused=new Int32Array(n.nflex)),!n.flex_face){let I=Me(n);n.flex_face=new Float32Array(9*I)}if(!n.flex_normal){let I=Me(n);n.flex_normal=new Float32Array(9*I)}const h=n.flex_radius[i],g=n.flex_facenum[i];let b=N(_.flexvert_xpos,3*n.flex_vertadr[i],3*n.flex_vertnum[i]),E=N(n.flex_face,9*n.flex_faceadr[i],9*g),j=N(n.flex_normal,9*n.flex_faceadr[i],9*g);function A(I,F,z,M){const S=N(b,3*F,3),T=N(b,3*z,3),C=N(b,3*M,3);for(let P=0;P<3;P++)p[P]=T[P]-S[P],c[P]=C[P]-S[P];f[0]=p[1]*c[2]-p[2]*c[1],f[1]=p[2]*c[0]-p[0]*c[2],f[2]=p[0]*c[1]-p[1]*c[0];const O=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]);O>0&&(f[0]/=O,f[1]/=O,f[2]/=O);const R=9*I;for(let P=0;P<3;P++)E[R+P]=S[P]+f[P]*h,E[R+3+P]=T[P]+f[P]*h,E[R+6+P]=C[P]+f[P]*h;for(let P=0;P<3;P++)j[R+P]=f[P],j[R+3+P]=f[P],j[R+6+P]=f[P];let D=E[R+1];E[R+1]=E[R+2],E[R+2]=-D,D=E[R+4],E[R+4]=E[R+5],E[R+5]=-D,D=E[R+7],E[R+7]=E[R+8],E[R+8]=-D,D=j[R+1],j[R+1]=j[R+2],j[R+2]=-D,D=j[R+4],j[R+4]=j[R+5],j[R+5]=-D,D=j[R+7],j[R+7]=j[R+8],j[R+8]=-D}for(let I=0;I<g;I++)A(I,m[3*I],m[3*I+1],m[3*I+2]);return{face_vertices:E,normal:j,vertices:b}}function v(n,_,i){if(n.vert_normal?n.vert_normal.fill(0):n.vert_normal=new Float32Array(3*n.flex_vertnum[i]),n.flex_faceadr||(n.flex_faceadr=new Int32Array(n.nflex),Oe(n)),n.flex_faceused||(n.flex_faceused=new Int32Array(n.nflex)),!n.flex_face){let M=Me(n);n.flex_face=new Float32Array(9*M)}if(!n.flex_normal){let M=Me(n);n.flex_normal=new Float32Array(9*M)}let m=n.flex_dim[i],h=N(_.flexvert_xpos,3*n.flex_vertadr[i],3*n.flex_vertnum[i]),g=N(n.flex_face,9*n.flex_faceadr[i],9*n.flex_facenum[i]),b=N(n.flex_normal,9*n.flex_faceadr[i],9*n.flex_facenum[i]),E=n.flex_flatskin[i],j=n.flex_radius[i];function A(M,S,T){const C=N(h,3*M,3),O=N(h,3*S,3),R=N(h,3*T,3);Pe(p,O,C),Pe(c,R,C),ar(f,p,c),qe(f,f)}function I(M,S,T,C,O){const R=O>0?1:-1;if(E){A(S,T,C);for(let D=0;D<3;D++)b[9*M+3*D]=R*f[0],b[9*M+3*D+1]=R*f[2],b[9*M+3*D+2]=-R*f[1]}else b[9*M]=R*n.vert_normal[3*S],b[9*M+1]=R*n.vert_normal[3*S+2],b[9*M+2]=-R*n.vert_normal[3*S+1],b[9*M+3]=R*n.vert_normal[3*T],b[9*M+4]=R*n.vert_normal[3*T+2],b[9*M+5]=-R*n.vert_normal[3*T+1],b[9*M+6]=R*n.vert_normal[3*C],b[9*M+7]=R*n.vert_normal[3*C+2],b[9*M+8]=-R*n.vert_normal[3*C+1];g[9*M]=h[3*S]+O*n.vert_normal[3*S],g[9*M+1]=h[3*S+2]+O*n.vert_normal[3*S+2],g[9*M+2]=-h[3*S+1]-O*n.vert_normal[3*S+1],g[9*M+3]=h[3*T]+O*n.vert_normal[3*T],g[9*M+4]=h[3*T+2]+O*n.vert_normal[3*T+2],g[9*M+5]=-h[3*T+1]-O*n.vert_normal[3*T+1],g[9*M+6]=h[3*C]+O*n.vert_normal[3*C],g[9*M+7]=h[3*C+2]+O*n.vert_normal[3*C+2],g[9*M+8]=-h[3*C+1]-O*n.vert_normal[3*C+1]}function F(M,S,T,C){const O=N(h,3*S,3),R=N(h,3*T,3);Pe(p,R,O),ar(f,p,n.vert_normal.subarray(3*T,3*T+3)),qe(f,f),C<0&&jt(f,f);const D=N(b,9*M,3),P=N(b,9*M+3,3),ce=N(b,9*M+6,3);Ne(D,f,[0,0,0],Math.PI/2),Ne(P,f,[0,0,0],Math.PI/2),Ne(ce,f,[0,0,0],Math.PI/2),g[9*M]=h[3*S]+C*n.vert_normal[3*S],g[9*M+1]=h[3*S+2]+C*n.vert_normal[3*S+2],g[9*M+2]=-h[3*S+1]-C*n.vert_normal[3*S+1],g[9*M+3]=h[3*T]+-C*n.vert_normal[3*T],g[9*M+4]=h[3*T+2]+-C*n.vert_normal[3*T+2],g[9*M+5]=-h[3*T+1]- -C*n.vert_normal[3*T+1],g[9*M+6]=h[3*T]+C*n.vert_normal[3*T],g[9*M+7]=h[3*T+2]+C*n.vert_normal[3*T+2],g[9*M+8]=-h[3*T+1]-C*n.vert_normal[3*T+1]}if(m===2)for(let M=0;M<n.flex_elemnum[i];M++){const S=N(n.flex_elem,n.flex_elemdataadr[i]+M*(m+1),3),T=S[0],C=S[1],O=S[2];A(T,C,O);const R=N(n.vert_normal,3*T,3),D=N(n.vert_normal,3*C,3),P=N(n.vert_normal,3*O,3);ye(R,R,f),ye(D,D,f),ye(P,P,f)}else for(let M=0;M<n.flex_shellnum[i];M++){const S=N(n.flex_shell,n.flex_shelldataadr[i]+M*m,3),T=S[0],C=S[1],O=S[2];A(T,C,O);const R=N(n.vert_normal,3*T,3),D=N(n.vert_normal,3*C,3),P=N(n.vert_normal,3*O,3);ye(R,R,f),ye(D,D,f),ye(P,P,f)}for(let M=0;M<n.flex_vertnum[i];M++){const S=N(n.vert_normal,3*M,3);qe(S,S)}let z=0;if(m===2)for(let M=0;M<n.flex_elemnum[i];M++){const S=N(n.flex_elem,n.flex_elemdataadr[i]+M*(m+1),3);I(z,S[0],S[1],S[2],j),z++,I(z,S[0],S[2],S[1],-j),z++}else for(let M=0;M<n.flex_shellnum[i];M++){const S=N(n.flex_shell,n.flex_shelldataadr[i]+M*m,3);I(z,S[0],S[1],S[2],j),z++}if(m==2)for(let M=0;M<n.flex_shellnum[i];M++){const S=N(n.flex_shell,n.flex_shelldataadr[i]+M*m,3);F(z,S[0],S[1],j),z++,F(z,S[1],S[0],-j),z++}return n.flex_faceused[i]=z,n.flex_faceused[i]>n.flex_facenum[i]&&(console.log("Too many flex faces"),console.log(n.flex_faceused[i],n.flex_facenum[i])),{face_vertices:g,normal:b}}return oe(()=>{const n=u.current;if(!n)return;const{face_vertices:_,normal:i}=a?v(e,r,t):k(e,r,t,d);try{n.attributes.position.array.set(_),n.attributes.position.needsUpdate=!0}catch{n.setAttribute("position",new Se(_,3))}try{n.attributes.normal.array.set(i),n.attributes.normal.needsUpdate=!0}catch{n.setAttribute("normal",new Se(i,3))}}),w.jsxs("bufferGeometry",{ref:u,...l,children:[y?w.jsx("bufferAttribute",{attach:"attributes-uv",array:y,count:y.length/2,itemSize:2}):null,"// TODO : Fix this"]})}function Et({model:e,simulation:r,flexId:t,...a}){return w.jsxs("mesh",{receiveShadow:!0,castShadow:!0,frustumCulled:!1,...a,children:[w.jsx(At,{attach:"geometry",model:e,simulation:r,flexId:t}),w.jsx(St,{attach:"material",model:e,flexId:t,...a})]})}function or({size:e,model:r,g:t,texId:a,children:l,...u}){const o=r.geom_dataid[t],s=x.useMemo(()=>{const k=r.mesh_vertnum[o],v=r.mesh_facenum[o],n=N(r.mesh_face,r.mesh_faceadr[o]*3,v*3),_=N(r.mesh_vert,r.mesh_vertadr[o]*3,k*3),i=N(r.mesh_normal,r.mesh_normaladr[o]*3,r.mesh_normalnum[o]*3),m=N(r.mesh_facetexcoord,r.mesh_faceadr[o]*3,v*3),h=N(r.mesh_facenormal,r.mesh_faceadr[o]*3,v*3),g=new Float32Array(k*3),b=new Float32Array(k*2),E=new Float32Array(k*3),j=N(r.mesh_texcoord,r.mesh_texcoordadr[o]*2,r.mesh_texcoordnum[o]*2);for(let A=0;A<v;A++)for(let I=0;I<3;I++){const F=A*3+I,z=n[F],M=m[F],S=h[F];g[z*3]=_[z*3],g[z*3+1]=_[z*3+2],g[z*3+2]=-_[z*3+1],E[z*3]=i[S*3],E[z*3+1]=i[S*3+2],E[z*3+2]=-i[S*3+1],b[z*2]=j[M*2],b[z*2+1]=j[M*2+1]}return{faces:Uint32Array.from(n),vertices:g,normals:E,uvs:b}},[t,o]),{faces:d,vertices:y,normals:p,uvs:c}=s||{},f=x.useRef(null);return x.useLayoutEffect(()=>{var k;(k=f.current)==null||k.computeVertexNormals()},[]),w.jsxs("mesh",{...u,children:[w.jsxs("bufferGeometry",{ref:f,children:[d!=null&&d.length?w.jsx("bufferAttribute",{attach:"index",array:d,count:d.length,itemSize:1}):null,y!=null&&y.length?w.jsx("bufferAttribute",{attach:"attributes-position",array:y,count:y.length/3,itemSize:3}):null,p!=null&&p.length?w.jsx("bufferAttribute",{attach:"attributes-normal",array:p,count:p.length/3,itemSize:3}):null,c!=null&&c.length?w.jsx("bufferAttribute",{attach:"attributes-uv",array:c,count:c.length/2,itemSize:2}):null]}),l]})}const Rt=({dataId:e,...r})=>{const t=x.useRef(null),{model:a}=Z(),l=e,{nrow:u,ncol:o,data:s,size:d}=x.useMemo(()=>{const c=a.hfield_nrow[l],f=a.hfield_ncol[l],k=a.hfield_adr[l],v=c*f,n=a.hfield_data.subarray(k,k+v),_=a.hfield_size.subarray(l*4,l*4+4);return{nrow:c,ncol:f,data:n,size:_}},[a,l]),y=x.useMemo(()=>{const c=new gr(d[0]*2,d[1]*2,o-1,u-1);for(let f=0;f<c.attributes.position.count;f++){const k=f%o,v=Math.floor(f/o),n=s[v*o+k]*d[2],_=c.attributes.position.getX(f),i=c.attributes.position.getY(f);c.attributes.position.setXYZ(f,_,n,i)}return c.computeVertexNormals(),c},[u,o,s,d]),p=x.useMemo(()=>new et({color:"#5577aa"}),[]);return w.jsx("mesh",{ref:t,geometry:y,material:p,...r})},Te={0:Pt,1:Rt,2:Tt,3:zt,4:Ft,5:Ct,6:It,7:or,8:or,"*":qt};function Tt({size:e,model:r,g:t,textId:a,...l}){return w.jsx(Je,{args:[e[0]],...l})}function Ft({size:e,model:r,g:t,textId:a,...l}){return w.jsx(Je,{args:[e[0]],scale:[1,e[2]/e[0],e[1]/e[0]],...l})}function zt({size:e,model:r,g:t,textId:a,...l}){return w.jsx(Zr,{args:[e[0],e[1]*2,20,20],...l})}function Ct({size:e,model:r,g:t,textId:a,...l}){return w.jsx(Yr,{args:[e[0],e[0],e[1]*2],...l})}function It({size:e,model:r,g:t,textId:a,...l}){return w.jsx(Qr,{args:[e[0]*2,e[2]*2,e[1]*2],...l})}function Pt({size:e,model:r,g:t,textId:a,...l}){const u=x.useRef(null);x.useLayoutEffect(()=>{var s;const d=u.current.geometry;return(s=d.rotateX)==null||s.call(d,Math.PI/2),()=>{var y;(y=d.rotateX)==null||y.call(d,-Math.PI/2)}},[]);const o=x.useMemo(()=>{if(Math.min(...e)<=0){let s=100/(e[2]||1);return[100,100,Math.max(s,1)]}else{let s=e[0]*2,d=e[1]*2;return[s,d,s/e[2],d/e[2]]}},[e]);return w.jsx(rt,{ref:u,args:o,...l})}function qt({size:e,model:r,g:t,textId:a,...l}){return w.jsx(Je,{args:[1],...l})}function Nt({model:e,g:r,matId:t,texId:a,...l}){const{mjtGeom:u}=fe(),{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Ae().setRGB(e.geom_rgba[r*4],e.geom_rgba[r*4+1],e.geom_rgba[r*4+2],se),k=e.geom_rgba[r*4+3];if(t!=-1&&(f=f.setRGB(e.mat_rgba[t*4],e.mat_rgba[t*4+1],e.mat_rgba[t*4+2],se),k=e.mat_rgba[t*4+3],a!=-1)){let v=e.geom_size[r*3],n=e.geom_size[r*3+1],_=e.geom_size[r*3+2];e.geom_type[r]===u.mjGEOM_PLANE.value&&(v<=0||n<=0||_<=0)&&(v=100,n=100);const i=e.tex_width[a],m=e.tex_height[a],h=e.tex_adr[a],g=e.tex_data,b=new Uint8Array(i*m*4);for(let j=0;j<i*m;j++)b[j*4]=g[h+j*3],b[j*4+1]=g[h+(j*3+1)],b[j*4+2]=g[h+(j*3+2)],b[j*4+3]=255;if(e.tex_colorspace[a]==1)for(let j=0;j<b.length;j+=4)for(let A=0;A<3;A++){const I=b[j+A]/255;b[j+A]=Math.pow(I,1/2.2)*255}c=new Ee(b,i,m,Re),c.magFilter=br,c.minFilter=kr,c.generateMipmaps=!0;const E=e.tex_type[a];switch(E){case 0:c.wrapS=ue,c.wrapT=ue,e.mat_texuniform[t]==1?c.repeat.set(v*e.mat_texrepeat[t*2],n*e.mat_texrepeat[t*2+1]):c.repeat.set(e.mat_texrepeat[t*2],e.mat_texrepeat[t*2+1]);break;case 1:c.wrapS=ie,c.wrapT=ie;break;case 2:c.wrapS=le,c.wrapT=le;break;default:console.warn(`Unsupported texture type: ${E}`)}c.needsUpdate=!0}return{color:f,alpha:k,texture:c}},[r,t,a]),{mode:y,wireframe:p}=ee("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1},[]);return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:t!=-1?e.mat_specular[t]:void 0,reflectivity:t!=-1?e.mat_reflectance[t]:void 0,roughness:t!=-1?1-e.mat_shininess[t]:void 0,metalness:t!=-1?.4:void 0,map:d,wireframe:p,...l})}function Ot(e,r){return[r[e*3],r[e*3+1],r[e*3+2]]}function Dt({size:e,type:r,index:t,children:a,...l}){const u=Te[r]||Te["*"],{mjtTextureRole:o}=fe(),{model:s}=Z(),d=s.geom_matid[t],y=s.mat_texid[d*o.mjNTEXROLE.value+o.mjTEXROLE_RGB.value];return w.jsxs(u,{castShadow:!0,receiveShadow:!0,size:e,model:s,g:t,texId:y,depthWrite:!0,depthTest:!0,frustumCulled:!0,...l,children:[w.jsx(Nt,{attach:"material",model:s,g:t,matId:d,texId:y,side:vr}),a]})}function Gt({model:e,g:r,matId:t,texId:a,...l}){const{mjtGeom:u}=fe(),{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Ae().setRGB(e.site_rgba[r*4],e.site_rgba[r*4+1],e.site_rgba[r*4+2],se),k=e.site_rgba[r*4+3];if(t!=-1&&(f=f.setRGB(e.mat_rgba[t*4],e.mat_rgba[t*4+1],e.mat_rgba[t*4+2],se),k=e.mat_rgba[t*4+3],a!=-1)){let v=e.site_size[r*3],n=e.site_size[r*3+1],_=e.site_size[r*3+2];e.site_type[r]===u.mjGEOM_PLANE.value&&(v<=0||n<=0||_<=0)&&(v=100,n=100);const i=e.tex_width[a],m=e.tex_height[a],h=e.tex_adr[a],g=e.tex_data,b=new Uint8Array(i*m*4);for(let j=0;j<i*m;j++)b[j*4]=g[h+j*3],b[j*4+1]=g[h+(j*3+1)],b[j*4+2]=g[h+(j*3+2)],b[j*4+3]=255;if(e.tex_colorspace[a]==1)for(let j=0;j<b.length;j+=4)for(let A=0;A<3;A++){const I=b[j+A]/255;b[j+A]=Math.pow(I,1/2.2)*255}c=new Ee(b,i,m,Re),c.magFilter=br,c.minFilter=kr;const E=e.tex_type[a];switch(E){case 0:c.wrapS=ue,c.wrapT=ue,e.mat_texuniform[t]==1?c.repeat.set(v*e.mat_texrepeat[t*2],n*e.mat_texrepeat[t*2+1]):c.repeat.set(e.mat_texrepeat[t*2],e.mat_texrepeat[t*2+1]);break;case 1:c.wrapS=ie,c.wrapT=ie;break;case 2:c.wrapS=le,c.wrapT=le;break;default:console.warn(`Unsupported texture type: ${E}`)}c.needsUpdate=!0}return{color:f,alpha:k,texture:c}},[r,t,a]),{mode:y,wireframe:p}=ee("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshStandardMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,roughness:t!=-1?1-e.mat_shininess[t]:void 0,metalness:t!=-1?.4:void 0,map:d,wireframe:p,...l})}function Bt(e,r){return[r[e*3],r[e*3+1],r[e*3+2]]}function sr({size:e,type:r,index:t,children:a,...l}){const u=Te[r]||Te["*"],{mjtTextureRole:o}=fe(),{model:s}=Z(),d=s.site_matid[t],y=s.mat_texid[d*o.mjNTEXROLE.value+o.mjTEXROLE_RGB.value];return w.jsxs(u,{castShadow:!0,receiveShadow:!0,size:e,model:s,g:t,texId:y,...l,children:[w.jsx(Gt,{attach:"material",model:s,g:t,matId:d,texId:y,side:vr}),a]})}const De=new Set;function Fe(){const{sim:e,model:r}=Z()||{},t=x.useCallback(o=>(De.add(o),()=>{De.delete(o)}),[]),a=x.useCallback(()=>{if(e&&r){for(let o=0;o<e.qfrc_applied.length;o++)e.qfrc_applied[o]=0;for(let o=0;o<e.xfrc_applied.length;o++)e.xfrc_applied[o]=0}De.forEach(o=>o())},[e,r]),l=o=>new B(o.x,-o.z,o.y),u=x.useCallback(({pullPos:o,anchorPos:s,scale:d=10,bodyId:y})=>{if(!e||!r)return;const p=te(e.xpos,y),c=new B(...p),f=o.clone().sub(c),k=(r.body_mass[y]||1)*d,v=f.multiplyScalar(k),n=l(v),_=l(s||c);e.applyForce(n.x,n.y,n.z,0,0,0,_.x,_.y,_.z,y);const i=new B(e.xpos[y*3+0],e.xpos[y*3+1],e.xpos[y*3+2]),m=new B(_.x-i.x,_.y-i.y,_.z-i.z).clone().cross(n),h=y*6;e.xfrc_applied[h+0]=n.x,e.xfrc_applied[h+1]=n.y,e.xfrc_applied[h+2]=n.z,e.xfrc_applied[h+3]=m.x,e.xfrc_applied[h+4]=m.y,e.xfrc_applied[h+5]=m.z},[e,r]);return[t,a,u]}const Rr=x.createContext(null);function lr({dragForceScale:e=1,showArrow:r=!0,showForceText:t=!0,arrowColor:a=16711680,arrowOpacity:l=.5,enabled:u=!0,onDragStart:o,onDragEnd:s,onVisualizationUpdate:d,children:y}){const{gl:p,scene:c,camera:f,controls:k,raycaster:v}=ve(),{sim:n,model:_}=Z()||{},[i]=Fe(),m=yr(q=>q.mode),h=m==="immersive-ar"||m==="immersive-vr",g=x.useRef(!1),b=x.useRef(null),E=x.useRef(null),j=x.useRef(null),A=x.useRef(!1),I=x.useRef(0),F=x.useRef(null),z=x.useRef(null),M=x.useRef(new B),S=x.useRef(new B),T=x.useRef(new B),C=x.useRef(null),O=x.useRef(null),R=x.useRef(null),D=x.useRef(!0),P=x.useRef(null),ce=x.useRef(null),[he,H]=x.useState(!1),[Q,Y]=x.useState(""),$=x.useRef(null);x.useEffect(()=>{if(!r)return;const q=new $r,U=new He(.005,.005,1,32),K=new Be({color:a,transparent:!0,opacity:l}),V=new Ue(U,K);O.current=V,V.position.set(0,.5,0);const re=new Lr(.02,.05,32),X=new Be({color:a,transparent:!0,opacity:l}),ne=new Ue(re,X);return R.current=ne,ne.position.set(0,1,0),q.add(V),q.add(ne),q.visible=!1,c.add(q),C.current=q,()=>{C.current&&(c.remove(C.current),C.current=null),O.current=null,R.current=null}},[c,r,a,l]);const W=q=>{var U;if(!u||!n||!_||!h&&!q.altKey||F.current!==null)return;F.current=q.pointerId,(U=q.target)==null||U.setPointerCapture(q.pointerId);const K=q.point,V=q.object,re=q.eventObject,X=re.userData.bodyId;!V||!(V instanceof Wr)||X<=0||(k&&"enabled"in k&&(D.current=k.enabled,k.enabled=!1),A.current=!0,g.current=!0,I.current=q.distance,b.current=re,E.current=V,j.current=X,M.current.copy(V.worldToLocal(K.clone())),S.current.copy(K),T.current.copy(K),C.current&&(C.current.position.copy(K),C.current.visible=!0),o?.(X),z.current=i(be))},_e=q=>{if(!g.current||!E.current||F.current!==q.pointerId)return;const U=q.ray.origin.clone();U.addScaledVector(q.ray.direction,I.current),T.current.copy(U),L()},G=q=>{var U;F.current===q.pointerId&&(F.current=null,(U=q.target)==null||U.releasePointerCapture(q.pointerId),A.current=!1,g.current=!1,b.current=null,E.current=null,j.current=null,P.current=null,ce.current=null,k&&"enabled"in k&&(k.enabled=D.current),C.current&&(C.current.visible=!1),$.current&&($.current.visible=!1),z.current&&(z.current(),z.current=null),s?.())},L=()=>{if(!E.current||!C.current||!O.current||!R.current)return;C.current.position.copy(S.current);const q=T.current.clone().sub(S.current),U=q.length(),K=q.clone().normalize();d?.({currentWorldPoint:T.current.clone(),worldHitPoint:S.current.clone(),length:U,direction:q.clone(),normalizedDirection:K.clone()});const V=O.current,re=R.current;V&&(V.scale.set(1,U,1),V.position.set(0,U/2,0)),re&&re.position.set(0,U,0),C.current.setRotationFromQuaternion(new xe().setFromUnitVectors(new B(0,1,0),K)),$.current&&($.current.position.copy(T.current),$.current.visible=!0)},me=x.useCallback(()=>{if(!E.current||!n||!_||!g.current||!j.current)return;const q=j.current,U=_.body_mass[q]||1,K=T.current.clone().sub(S.current);let V=U*100*e;const re=K.multiplyScalar(V),X=J(re),ne=J(S.current);P.current=X,ce.current=q,n.applyForce(X.x,X.y,X.z,0,0,0,ne.x,ne.y,ne.z,q);const ze=new B(n.xpos[q*3+0],n.xpos[q*3+1],n.xpos[q*3+2]),Ce=new B(ne.x-ze.x,ne.y-ze.y,ne.z-ze.z).clone().cross(X),ge=q*6;n.xfrc_applied[ge+0]=X.x,n.xfrc_applied[ge+1]=X.y,n.xfrc_applied[ge+2]=X.z,n.xfrc_applied[ge+3]=Ce.x,n.xfrc_applied[ge+4]=Ce.y,n.xfrc_applied[ge+5]=Ce.z},[E,n,_,e,g]),J=q=>new B(q.x,-q.z,q.y),ae=x.useCallback(()=>{if(n&&_&&!(!g.current||!E.current||!j.current)){if(b.current){const q=j.current,U=te(n.xpos,q),K=je(n.xquat,q);b.current.position.set(...U),b.current.quaternion.set(...K),b.current.updateWorldMatrix(!0,!0)}S.current.copy(M.current),E.current.localToWorld(S.current)}},[n,_,g,E,M,S]),be=x.useCallback(()=>{if(!(!g.current||!E.current)&&(ae(),me(),L(),P.current)){const q=P.current,U=q.x.toFixed(2),K=q.y.toFixed(2),V=q.z.toFixed(2),re=`|F|: ${q.length().toFixed(2)} N
Fx: ${U}
Fy: ${K}
Fz: ${V}`;Y(re),H(!0),$.current&&$.current.quaternion.copy(f.quaternion)}},[ae,me,L,f]);oe(()=>{g.current||(H(!1),Y(""))});const Ke=x.useMemo(()=>({dragging:g,selectedPhysicsObject:E,computeForce:ae,applyForce:me,updateForce:be,startDragVr:W,updateDragVr:_e,endDragVr:G}),[g,E,ae,me,be]);return w.jsxs(Rr.Provider,{value:Ke,children:[y,t&&w.jsx(xr,{ref:$,position:[0,0,0],fontSize:.05,color:"white",anchorX:"center",anchorY:"middle",visible:he,"material-depthTest":!1,"material-depthWrite":!1,renderOrder:999,children:Q})]})}const Ve=()=>x.useContext(Rr),Ut=({model:e,sim:r,visible:t,showSites:a,showSiteFrame:l,siteFrameScale:u=.01})=>{const o=x.useRef(null),{startDragVr:s,updateDragVr:d,endDragVr:y}=Ve(),{showSiteFrame:p,showSites:c,siteFrameScale:f}=ee("Render.Sites",{showSites:{value:a},showSiteFrame:{value:l},siteFrameScale:{value:u,min:.001,max:.1,step:1e-4}},[a,l]);return oe(()=>{var k,v;(v=(k=o?.current)==null?void 0:k.children)==null||v.forEach((n,_)=>{const i=te(r.xpos,_),m=je(r.xquat,_);n.position.set(...i),n.quaternion.set(...m)})}),w.jsx("group",{ref:o,children:e?.nbody&&Array.from(we(0,e.nbody)).map((k,v)=>{const n=e.body_geomadr[v],_=n+e.body_geomnum[v],i=Array.from(e.site_bodyid).map((m,h)=>m===v?h:-1).filter(m=>m>=0);return w.jsxs("group",{ref:o,userData:{isDraggable:!0,bodyId:v},onPointerDown:s,onPointerMove:d,onPointerUp:y,children:[Array.from(we(n,_)).map(m=>{const h=Ot(m,e.geom_size),g=e.geom_type[m],b=te(e.geom_pos,m),E=je(e.geom_quat,m),j=e.geom_group[m],A=e.geom_dataid[m];if(t?.includes(j))return w.jsx(Dt,{size:h,type:g,index:m,dataId:A,position:b,quaternion:E},m)}),c&&i.length>=0&&i.map(m=>{const h=Bt(m,e.site_size),g=e.site_type[m],b=te(e.site_pos,m),E=je(e.site_quat,m);return p?w.jsx(sr,{type:g,size:h,index:m,position:b,quaternion:E,children:w.jsx(Hr,{scale:f},"frame-"+m)},m):w.jsx(sr,{type:g,size:h,index:m,position:b,quaternion:E},m)})]},v)})},"robot")};function ir({model:e,tendonId:r,...t}){const a=e.tendon_matid[r],{mjtTextureRole:l}=fe(),u=e.mat_texid[a*l.mjNTEXROLE.value+l.mjTEXROLE_RGB.value],{color:o,alpha:s,texture:d}=x.useMemo(()=>{let c,f=new Ae().setRGB(e.tendon_rgba[r*4],e.tendon_rgba[r*4+1],e.tendon_rgba[r*4+2],se),k=e.tendon_rgba[r*4+3];if(a!=-1&&(f=f.setRGB(e.mat_rgba[a*4],e.mat_rgba[a*4+1],e.mat_rgba[a*4+2],se),k=e.mat_rgba[a*4+3],u!=-1)){const v=e.tex_width[u],n=e.tex_height[u],_=e.tex_adr[u],i=e.tex_data,m=new Uint8Array(v*n*4);for(let g=0;g<v*n;g++)m[g*4]=i[_+g*3],m[g*4+1]=i[_+(g*3+1)],m[g*4+2]=i[_+(g*3+2)],m[g*4+3]=255;if(e.tex_colorspace[u]==1)for(let g=0;g<m.length;g+=4)for(let b=0;b<3;b++){const E=m[g+b]/255;m[g+b]=Math.pow(E,1/2.2)*255}c=new Ee(m,v,n,Re);const h=e.tex_type[u];switch(h){case 0:c.wrapS=ue,c.wrapT=ue,c.repeat.set(e.mat_texrepeat[a*2],e.mat_texrepeat[a*2+1]);break;case 1:c.wrapS=ie,c.wrapT=ie;break;case 2:c.wrapS=le,c.wrapT=le;break;default:console.warn(`Unsupported texture type: ${h}`)}c.needsUpdate=!0}return{color:f,alpha:k,texture:c}},[r]),{mode:y,wireframe:p}=ee("Render",{mode:{value:"rgb",options:["rgb","depth","normal"]},wireframe:!1});return y==="depth"?w.jsx("meshDepthMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):y==="normal"?w.jsx("meshNormalMaterial",{wireframe:p,transparent:!1,opacity:1,side:2}):w.jsx("meshPhysicalMaterial",{color:o,ior:1,transparent:s<1,opacity:s,clearcoat:.5,specularIntensity:a!=-1?e.mat_specular[a]:void 0,reflectivity:a!=-1?e.mat_reflectance[a]:void 0,roughness:a!=-1?1-e.mat_shininess[a]:void 0,metalness:a!=-1?.4:void 0,map:d,wireframe:p,...t})}function $t({model:e,sim:r}){const t=x.useMemo(()=>new He(1,1,1),[]),a=x.useMemo(()=>new wr(1,8,8),[]);return w.jsx(w.Fragment,{children:Array.from({length:e.ntendon}).map((l,u)=>w.jsx(Lt,{model:e,sim:r,tendonId:u,cylinderGeometry:t,sphereGeometry:a},u))})}function Lt({model:e,sim:r,tendonId:t,cylinderGeometry:a,sphereGeometry:l}){const u=x.useRef(null),o=x.useRef(null),s=x.useMemo(()=>new pe,[]),d=x.useMemo(()=>new B,[]),y=x.useMemo(()=>new B,[]),p=x.useMemo(()=>new B,[]),c=x.useMemo(()=>new B,[]),f=x.useMemo(()=>new xe,[]),k=x.useMemo(()=>new xe,[]);return oe(()=>{if(!u.current||!o.current)return;let v=0;const n=r.ten_wrapadr[t],_=e.tendon_width[t];for(let i=n;i<n+r.ten_wrapnum[t]-1;i++){d.fromArray(te(r.wrap_xpos,i)),y.fromArray(te(r.wrap_xpos,i+1));const m=d.lengthSq()>1e-4,h=y.lengthSq()>1e-4;if(m&&(c.set(_,_,_),s.compose(d,k,c),o.current.setMatrixAt(v,s)),h&&(c.set(_,_,_),s.compose(y,k,c),o.current.setMatrixAt(v+1,s)),m&&h){p.addVectors(d,y).multiplyScalar(.5);const g=y.clone().sub(d).normalize();f.setFromUnitVectors(new B(0,1,0),g);const b=d.distanceTo(y);c.set(_,b,_),s.compose(p,f,c),u.current.setMatrixAt(v,s),v++}}u.current.count=v,o.current.count=v>0?v+1:0,u.current.visible=!0,o.current.visible=!0,u.current.instanceMatrix.needsUpdate=!0,o.current.instanceMatrix.needsUpdate=!0}),w.jsxs("group",{children:[w.jsx("instancedMesh",{ref:u,args:[a,void 0,256],castShadow:!0,receiveShadow:!0,frustumCulled:!1,children:w.jsx(ir,{model:e,tendonId:t})}),w.jsx("instancedMesh",{ref:o,args:[l,void 0,256],castShadow:!0,receiveShadow:!0,frustumCulled:!1,children:w.jsx(ir,{model:e,tendonId:t})})]})}function We(e,r){const t={};return r.split(" ").forEach(a=>{e!=null&&e[a]&&(t[a]=Array.from(e[a]))}),t}const ur=x.forwardRef(({_key:e="",frameKeys:r,visible:t,onLoad:a,useLights:l=!0,useMocap:u=!0,showMocapFrame:o=!0,showSites:s=!0,showSiteFrame:d=!0,onMocapMove:y,mocapMarkerScale:p=.1,mocapGizmoScale:c,mocapHandleSize:f=.1,mocapHandleWireframe:k=!1,children:v,...n},_)=>{const{sim:i,model:m,state:h,mujoco:g}=Z()||{};function b(I,F){const z=new TextDecoder("utf-8"),M=I.name_bodyadr[F],S=I.names.indexOf(0,M);return z.decode(I.names.subarray(M,S))}const E=x.useMemo(()=>{if(!m||!m.body_mocapid)return[];const I=[];for(let F=0;F<m.nbody;F++){const z=m.body_mocapid[F];z>=0&&(I[z]=b(m,F))}return I},[m]);x.useEffect(()=>{const I=()=>{i?.resetData(),i?.forward()};_&&(_.current={sim:i,model:m,state:h,mujoco:g,reset:I})},[_,i,m,h,g]);const j=Le.useRef(null),A=n||{};return x.useEffect(()=>{i&&A.qpos&&i.qpos.set(A.qpos),i&&A.qvel&&i.qvel.set(A.qvel)},[i,A.qpos,A.qvel]),x.useEffect(()=>{i&&A.act&&i.act.set(A.act)},[i,A.act]),x.useEffect(()=>{i&&A.ctrl&&i.ctrl.set(A.ctrl)},[i,A.ctrl]),x.useEffect(()=>{i&&A.mocap_pos&&i.mocap_pos.set(A.mocap_pos),i&&A.mocap_quat&&i.mocap_quat.set(A.mocap_quat)},[i,A.mocap_pos,A.mocap_quat]),x.useEffect(()=>{i&&i.forward()},[i,A.qpos,A.qvel,A.act,A.ctrl,A.mocap_pos,A.mocap_quat]),x.useEffect(()=>{if(!m||!i||!a)return;const I=We(i,r);a(I)},[m,i]),!i||!m?null:w.jsxs(w.Fragment,{children:[w.jsx("group",{ref:j,children:w.jsx(Ut,{model:m,sim:i,visible:t,showSites:s,showSiteFrame:d})},"robot"),m?.nskin&&Array.from(we(0,m.nskin)).map((I,F)=>w.jsx(bt,{name:`skin-${F}`,model:m,simulation:i,skinId:F},`skin-${F}`)),m?.nflex&&Array.from(we(0,m.nflex)).map((I,F)=>w.jsx(Et,{name:`Flex-${F}`,model:m,simulation:i,flexId:F,smoothShading:!0},`flex-${F}`)),m?.ntendon&&w.jsx($t,{model:m,sim:i}),l&&w.jsx(mt,{n:m.nlight,ambient:m.light_ambient}),u&&w.jsx(Er,{n:m.nbody,mocapId:m.body_mocapid,mocap_pos:i.mocap_pos,mocap_quat:i.mocap_quat,onMove:y,names:E,showFrame:o,markerScale:p,gizmoScale:c,handleSize:f,handleWireframe:k}),v]})});function Ht(e){const[r,t]=x.useState(e),a=x.useRef(r);return[r,l=>{const u=l instanceof Function?l(a.current):l;a.current=u,t(u)},a]}function Jt(e){if(!(e!=null&&e.length))return[];const r=new Set(e.sort());return Array.from(r)}const cr=({visible:e=[0,1,2],onChange:r})=>{const{model:t}=Z()||{},a=Jt(Object.values(t.geom_group)),l=ee("Render.Groups",Object.fromEntries(a.map(u=>{let o=!1;return e!=null&&e.includes(u)&&(o=!0),[`${u}`,{value:o,label:`geom group ${u}`}]})),[a.join(",")]);return x.useEffect(()=>{const u=a.filter((o,s)=>typeof l[`${o}`]>"u"||!!l[`${o}`]);r?.({visible:u})},[l]),null};function Vt(e,r,t=[]){const a=x.useRef(null),l=x.useRef(e),u=x.useRef(performance.now()),o=x.useRef(null);return x.useEffect(()=>{o.current=r},[r]),x.useEffect(()=>{l.current=e},[e]),x.useEffect(()=>{u.current=performance.now()},[typeof r=="number",r<=0]),x.useEffect(()=>{const s=()=>{if(o.current<=0){u.current=performance.now();return}const d=performance.now(),y=d-u.current;u.current=d,l!=null&&l.current&&l.current(y)};if(o.current>0){const d=setInterval(s,o.current);return a.current=d,()=>clearInterval(d)}},[r,e,...t]),a}function Tr(e){const r=x.useRef(e);return x.useEffect(()=>{r.current=e},[e]),r}function Wt(e){return[...e].reduce((r,t)=>r+Math.abs(t),0)/e.length}function mr({fps:e=60,speed:r=1,pause:t=!1,pauseThreshold:a=.001,timeoutRef:l,timeoutSteps:u=5,onFrame:o,onStep:s,onTimeout:d,frameKeys:y="name time qpos mocap_pos mocap_quat site_xpos geom_xpos sensordata"}){const{sim:p,model:c,dt:f}=Z(),k=ve(j=>j.invalidate),{updateForce:v,dragging:n}=Ve(),[_,i]=Fe();x.useEffect(()=>{if(!(!p||!c))return _(v)},[p,c]);const m=Tr(t),h=x.useMemo(()=>1/e/r,[e,r]),g=x.useRef(0),b=x.useRef(0),E=x.useCallback(j=>{if(!(!c||!p||!r)){if(j>1500){console.warn(`${j}ms has elapsed. If this persists, something is wrong. Skipping simulation.`),g.current=0,b.current=0;return}if(!m.current){for(g.current+=j*r;b.current<h;)p.step(),i(),b.current+=f;if(b.current,b.current%=h,b.current&&k(),Wt(p.qvel||[])<a&&!n.current?(l.current-=1,l.current||d==null||d(!0)):l.current=u,o){const A=We(p,y);o(A,b.current)}}}},[p,c,f,h,e,r,t,o,s,m,a,l,u,n,i,k,y,d]);return Vt(E,1e3*h,[E]),null}function fr({fps:e=60,speed:r=1,frameKeys:t="",onFrame:a,uplink:l,downlink:u}){const{sim:o,model:s,dt:d}=Z(),y=ve(n=>n.invalidate),{updateForce:p}=Ve(),[c,f]=Fe();x.useEffect(()=>{if(!(!o||!s))return c(p)},[o,s]);const k=x.useMemo(()=>{if(!d)return 1;const n=1/e/r;return Math.max(1,Math.floor(n/d))},[d,e,r]),v=x.useCallback(({key:n,rtype:_,data:{act:i,ctrl:m,sim_steps:h,xfrc_applied:g,qfrc_applied:b,xfrc:E,xfrc_bodyId:j,qpos:A,qvel:I}})=>{if(!o||!s)return;if(A&&A.length>0&&o.qpos.set(A),I&&I.length>0&&o.qvel.set(I),i&&i.length>0&&o.act.set(i),m&&m.length>0&&o.ctrl.set(m),g&&g.length>0&&o.xfrc_applied.set(g),b&&b.length>0&&o.qfrc_applied.set(b),typeof E<"u"&&typeof j<"u"){const z=te(o.xpos,j),M=[...E,0,0,0,0,0,0].slice(0,6);o.applyForce(...M,...z,j)}const F=h??k;for(let z=0;z<F;z++)o.step(),f();if(F===0&&(o.forward(),f(),y()),a){const z=We(o,t);a(z,d),l?.publish({ts:Date.now(),etype:_||"MJ_STEP_RESPONSE",value:{dt:F*d,keyFrame:z}})}},[o,s,l,k,d,y,f,t,a]);return x.useEffect(()=>{if(u)return u.subscribe("MJ_STEP",v)},[u,v]),null}function Kt(e){let r=e.length;for(let t=0;t<e.length;t++)r=(r<<5)-r+e[t],r|=0;return r}function Xt(e,r=[]){const[t,a]=x.useState(e);return x.useEffect(()=>a(e),r),[t,a]}const Qt=[0,1,2],Yt=({_ref:e,_key:r="mujoco-default",src:t="",assets:a=[],workDir:l="/workspace",selfProvide:u=!0,timeout:o,threshold:s=.001,fps:d=60,speed:y=1,pause:p=!1,frameKeys:c="name time qpos mocap_pos mocap_quat site_xpos geom_xpos sensordata",visible:f=Qt,useDrag:k=!0,unpauseOnDrag:v=!0,dragForceScale:n=1,showDragArrow:_=!0,showDragForceText:i=!0,useLights:m=!0,useMocap:h=!0,mocapGizmoScale:g,mocapHandleSize:b,mocapMarkerScale:E,mocapHandleWireframe:j,children:A,...I})=>{const{uplink:F,downlink:z}=_r(),[M,S,T]=Ht(p),C=Nr(),O=Or(),R=ve(J=>J.invalidate),{fps:D,speed:P,paused:ce,recording:he}=O||{paused:!1},H=x.useCallback(J=>{F?.publish({ts:Date.now(),etype:"ON_MUJOCO_LOAD",value:{keyFrame:J}})},[F]),Q=x.useCallback((J,ae)=>F?.publish({ts:Date.now(),etype:"ON_MUJOCO_FRAME",value:{dt:ae,keyFrame:J}}),[R,F]);x.useEffect(()=>{const J=({ts:Ke,value:q})=>{var U;C&&C!=null&&C.isRecording&&C?.addKeyFrame(Ur([{key:r,tag:"MuJoCo",...q?.keyFrame}],"children",((U=q?.keyFrame)==null?void 0:U.time)||Date.now()))},ae=F.subscribe("ON_MUJOCO_FRAME",J),be=F.subscribe("ON_MUJOCO_STEPPING",J);return()=>{ae(),be()}},[C,F,r]);const Y=x.useCallback((J,ae)=>F?.publish({ts:Date.now(),etype:"ON_MUJOCO_STEPPING",value:{dt:ae,keyFrame:J},silent:!0}),[R,F]),$=Kt(f),[W,_e]=Xt({visible:f},[$]),G=Tr(o),L=x.useCallback(()=>{G.current=o,v&&S?.(!1)},[v,S]),me=x.useCallback(J=>{G.current=o,T.current&&S(!1)},[T,S]);return u?w.jsx(ut,{children:w.jsx(Ye,{src:t,assets:a,workDir:l,children:w.jsxs(lr,{enabled:k,onDragStart:L,dragForceScale:n,showArrow:_,showForceText:i,children:[w.jsxs(ur,{_key:r,frameKeys:c,onLoad:H,...W,useLights:m,useMocap:h,onMocapMove:me,mocapGizmoScale:g,mocapHandleSize:b,mocapMarkerScale:E,mocapHandleWireframe:j,...I,children:[A,w.jsx(cr,{...W,onChange:_e},`gctrl-${r}`)]},r),w.jsx(mr,{fps:d||D,speed:y||P,pause:M,timeoutRef:G,timeoutSteps:o,frameKeys:c,onFrame:Q,onTimeout:S}),w.jsx(fr,{fps:d,speed:y,frameKeys:c,onFrame:Y,uplink:F,downlink:z})]})})},r):w.jsx(Ye,{src:t,assets:a,workDir:l,children:w.jsxs(lr,{enabled:k,onDragStart:L,children:[w.jsxs(ur,{_key:r,frameKeys:c,onLoad:H,...W,useLights:m,useMocap:h,onMocapMove:me,mocapGizmoScale:g,mocapHandleSize:b,mocapMarkerScale:E,mocapHandleWireframe:j,...I,children:[A,w.jsx(cr,{...W,onChange:_e},`gctrl-${r}`)]},r),w.jsx(mr,{fps:d||D,speed:y||P,pause:M,timeoutRef:G,timeoutSteps:o,frameKeys:c,onFrame:Q,onTimeout:S}),w.jsx(fr,{fps:d,speed:y,frameKeys:c,onFrame:Y,uplink:F,downlink:z})]})})};function Zt(e,r,t){return e=Math.max(r,e),e=Math.min(t,e),e}const ea=({ctrlId:e=-1,offset:r=.01,low:t=.01,high:a=1,cond:l="right-squeeze",value:u="right:thumb-tip,right:index-finger-tip",scale:o=1})=>{const{sim:s,model:d}=Z()||{};oe(()=>{var y,p,c;if(!ke.leftLandmarks&&!ke.rightLandmarks)return;const[f,k]=u.split(","),[v,n]=f.split(":"),[_,i]=k.split(":"),m=(y=ke[`${v}Landmarks`])==null?void 0:y[n],h=(p=ke[`${_}Landmarks`])==null?void 0:p[i];if(!m||!h)return;const[g,b]=l.split("-");if(!((c=ke)!=null&&c[g][b]))return;const E=Fr(Xe(m),Xe(h))-r,j=Zt(E*o,t,a),A=[...s.ctrl];e=(A.length+e)%A.length,A[e]=j,s.ctrl.set(A)})};function ra(e,r,t){return e=Math.max(r,e),e=Math.min(t,e),e}const ta=({ctrlId:e=-1,offset:r=0,low:t=0,high:a=.2,cond:l="right-trigger",scale:u=1})=>{const{sim:o}=Z()||{};return oe(()=>{if(!o||!Ie.left&&!Ie.right)return;const[s,d]=l.split("-"),y=Ie[s];if(!y)return;const p=1-y[`${d}Value`]-r,c=ra(p*u,t,a),f=[...o.ctrl];e=(f.length+e)%f.length,f[e]=c,o.ctrl.set(f)}),null},aa=(e=!1)=>{const[r,t,a]=x.useMemo(()=>{if(e)return[null,null,null];const l=new Gr(-1,1,1,-1,0,1),u=new Be,o=new gr(2,2),s=new Ue(o,u),d=new Br;return d.add(s),[d,u,l]},[]);return x.useCallback(({renderer:l,texture:u})=>{var o;t&&(t.map!==u&&((o=t.map)==null||o.dispose(),t.map=u,t.needsUpdate=!0),l.setRenderTarget(null),l.render(r,a))},[e])};async function na({renderer:e,quality:r}){const t=e.getContext(),a=e.domElement.width,l=e.domElement.height,u=new Uint8Array(a*l*4);return t.readPixels(0,0,a,l,t.RGBA,t.UNSIGNED_BYTE,u),await(await e.domElement.convertToBlob({quality:r,type:"image/jpeg"})).arrayBuffer().then(o=>new Uint8Array(o))}function oa({_ref:e,_key:r,hide:t,width:a=640,height:l=480,matrix:u,fov:o=60,top:s=1,bottom:d=-1,left:y=-1,right:p=1,near:c=.1,far:f=20,renderDepth:k=!1,distanceToCamera:v=.5,ctype:n="perspective",scale:_=10,fps:i=30,downsample:m=2,quality:h=1,showCameraFrustum:g=!0,movable:b=!0,movableScale:E=1,children:j=[],...A}){var I;const F=x.useRef(null),z=x.useRef(null),M=x.useRef(null),{size:S,camera:T,scene:C}=ve(),O=window.devicePixelRatio||1,R=zr(a*O,l*O,k?{depthBuffer:!0}:{}),{sendMsg:D,downlink:P,uplink:ce}=_r(),he=x.useCallback(()=>{if(!M.current||!F.current)return;const G=F.current,L=M.current;G.matrix.copy(L.matrix),G.matrix.decompose(G.position,G.quaternion,G.scale),G.rotation.setFromQuaternion(G.quaternion),D({ts:Date.now(),etype:"CAMERA_MOVE",key:r,value:{matrix:G.matrix.toArray()}})},[M.current,F.current,D]),H=ee(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",{showCameraFrustum:{value:g,label:"ShowFrustum"},camType:{value:n,options:["perspective","orthographic"]}}),Q=ee(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",{near:{value:c,min:.001,step:.05},far:{value:f,min:.1,step:.1},scale:{value:_,min:.1,step:.1}},[c,f]),Y=ee(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",H.camType==="perspective"?{fov:{value:o,min:0,max:170},aspect:{value:a/l,min:.1,max:10}}:{},[H.camType,o,a,l]),$=ee(r?`Mujoco.Camera-${r}`:"Mujoco.Camera",H.camType==="orthographic"?{top:{value:s,min:-10,step:.1},bottom:{value:d,min:-10,step:.1},left:{value:y,min:-10,step:.1},right:{value:p,min:-10,step:.1}}:{},[H.camType,s,d,y,p]),W=x.useMemo(()=>{const G=new Cr({canvas:new OffscreenCanvas(a/m,l/m),antialias:!1,precision:"highp",preserveDrawingBuffer:!0,depth:!0});return G.autoClear=!1,G.setPixelRatio(O),G},[O,l,a,m]);x.useEffect(()=>{let G;H.camType==="perspective"?G=Y.aspect:G=($.right-$.left)/($.top-$.bottom),F.current.aspect=G,F.current.updateProjectionMatrix(),W.setSize(Math.floor(G*l/m),Math.floor(l/m),!1),W.setPixelRatio(O),R.setSize(G*l*O,l*O)},[O,l,a,m,Y.aspect,$.top,$.bottom,$.left,$.right,H.camType]),x.useLayoutEffect(()=>{if(!F.current||!u||u.length!==16)return;const G=F.current;G.matrix.fromArray(u),G.matrix.decompose(G.position,G.quaternion,G.scale),G.rotation.setFromQuaternion(G.quaternion);const L=b?M?.current:z?.current;L&&(L.matrix.fromArray(u),L.matrix.decompose(L.position,L.quaternion,L.scale),L.rotation.setFromQuaternion(L.quaternion))},[u,(I=F.current)==null?void 0:I.uuid]);const _e=aa();return x.useEffect(()=>{if(P)return P.subscribe("MJ_RENDER",async({key:G,rtype:L,data:{quality:me=1}})=>{if(!F.current||G!==r)return;W.setRenderTarget(R),W.render(C,F.current);const J={ts:Date.now(),etype:L||"MJ_RENDER_RESPONSE",key:G,value:{dpr:O,width:a,height:l}};_e({renderer:W,texture:R.texture}),J.value.frame=await na({renderer:W,quality:me}),D(J)})},[D,P,ce,m,W,W.domElement,R]),t?null:w.jsxs(w.Fragment,{children:[H.showCameraFrustum&&!b?w.jsx(Qe,{_ref:z,...Y,...Q,showFocalPlane:!1,...A,children:j}):null,H.showCameraFrustum&&b?w.jsxs(Ir,{_ref:M,onMove:he,matrix:u,scale:E,...A,children:[w.jsx(Qe,{_ref:z,scale:1/E,...Y,...Q,showFocalPlane:!1}),j]}):null,H.camType==="perspective"?w.jsx(Pr,{ref:F,near:Q.near,far:Q.far,...Y,...A}):null,H.camType==="orthographic"?w.jsx(qr,{ref:F,near:Q.near,far:Q.far,...$,...A}):null]})}function sa(e){const r=x.useMemo(()=>new B,[]),t=Array.isArray(e)?e[0]:e.x,a=Array.isArray(e)?e[1]:e.y,l=Array.isArray(e)?e[2]:e.z;x.useMemo(()=>{Array.isArray(e)?r.set(e[0],e[1],e[2]):r.copy(e)},[r,t,a,l]);const u=x.useCallback(o=>{Array.isArray(o)?r.set(o[0],o[1],o[2]):r.copy(o)},[r]);return[r,u]}const dr=e=>new B(e.x,-e.z,e.y),la=({_key:e,bodyId:r,enabled:t=!0,scale:a=20,forceDestination:l=[1,1,1],showForceVector:u=!1,showForceText:o=!1,showPivotControls:s=!0})=>{let d;try{d=Z()}catch(T){return console.warn("AnchorActuator: Error accessing MuJoCo context:",T),null}if(!d)return console.warn("AnchorActuator: Must be used within MuJoCoProvider"),null;const{sim:y,model:p}=d,{camera:c}=ve(),[f]=Fe(),[k,v]=sa(l),[n,_]=x.useState(new B),[i,m]=x.useState(new B),[h,g]=x.useState(!1),[b,E]=x.useState(""),j=x.useRef(null),A=x.useCallback(()=>{if(!t||!y||!p||r<=0||r>=p.nbody)return;const T=te(y.xpos,r),C=new B(...T),O=k.clone().sub(C).multiplyScalar(a),R=dr(O),D=dr(C);if(y.applyForce(R.x,R.y,R.z,0,0,0,D.x,D.y,D.z,r),u||o){const P=new B(D.x,D.z,-D.y),ce=P.clone().add(new B(R.x,R.z,-R.y).multiplyScalar(.01));if(u&&(_(P),m(ce)),o){const he=R.x.toFixed(2),H=R.y.toFixed(2),Q=R.z.toFixed(2),Y=`|F|: ${R.length().toFixed(2)} N
Fx: ${he}
Fy: ${H}
Fz: ${Q}`;E(Y),g(!0)}}},[t,y,p,r,k,a,u,o]),I=x.useMemo(()=>{const T=new pe;return T.makeTranslation(k.x,k.y,k.z),T},[k]),F=T=>{const C=new B;C.setFromMatrixPosition(T),v(C)};x.useEffect(()=>{if(!(!t||!y||!p))return f(A)},[t,y,p,A,f]);const z=x.useMemo(()=>{const T=i.clone().sub(n);return T.length()>0?T.normalize():new B(0,1,0)},[n.x,n.y,n.z,i.x,i.y,i.z]),M=x.useMemo(()=>i.distanceTo(n),[n.x,n.y,n.z,i.x,i.y,i.z]),S=x.useMemo(()=>{const T=new xe;return T.setFromUnitVectors(new B(0,1,0),z),T},[z]);return oe(()=>{j.current&&h&&j.current.quaternion.copy(c.quaternion)}),w.jsxs(w.Fragment,{children:[u&&M>0&&w.jsxs("group",{position:n,quaternion:S,children:[w.jsxs("mesh",{position:[0,M/2,0],children:[w.jsx("cylinderGeometry",{args:[.005,.005,M,8]}),w.jsx("meshBasicMaterial",{color:"red",transparent:!0,opacity:.7})]}),w.jsxs("mesh",{position:[0,M,0],children:[w.jsx("coneGeometry",{args:[.02,.05,8]}),w.jsx("meshBasicMaterial",{color:"red",transparent:!0,opacity:.7})]})]}),o&&w.jsx(xr,{ref:j,position:i,fontSize:.05,color:"white",anchorX:"center",anchorY:"middle",visible:h,"material-depthTest":!1,"material-depthWrite":!1,renderOrder:999,children:b}),s&&w.jsx(hr,{matrix:I,onDrag:F,scale:.5,lineWidth:2,annotations:!0,depthTest:!1})]})},pr="0.0.96",Ge="@vuer-ai/vuer",ia="47ec741";function ua({className:e,packageName:r,packageFullName:t,versionText:a,linkable:l=!0,gitHash:u}){const o=t&&a?`https://www.npmjs.com/package/${t}/v/${a.replace("v","")}`:void 0;return w.jsxs("div",{className:`rounded-uk-xs rounded-r-uk-xs text-uk-sm bg-icon-withbg inline-flex items-center ${e||""}`,style:l?{cursor:"pointer"}:void 0,children:[(r||a)&&w.jsxs("div",{className:"rounded-uk-xs inline-flex items-center overflow-hidden",children:[r&&w.jsx("span",{className:"pl-sm pr-xs py-xxxs bg-brand-primary text-text-withbg text-uk-xs",style:{backgroundColor:"var(--color-brand-primary, var(--brand-primary))",color:"white",textShadow:"0 1px 2px rgba(0, 0, 0, 0.3), inset 0 -1px 0 rgba(255, 255, 255, 0.1)"},children:r}),a&&w.jsx("a",{href:l&&o?o:void 0,className:["pl-xs pr-sm py-xxxs rounded-r-uk-xs","bg-alt-primary","text-text-secondary","text-text-primary text-uk-xs",l&&"hover:text-brand-primary"].join(" "),style:{textShadow:"0 1px 1px rgba(0, 0, 0, 0.2), inset 0 -1px 0 rgba(255, 255, 255, 0.05)"},onClick:l?void 0:s=>s.preventDefault(),children:a})]}),u&&u!=="unknown"&&w.jsxs("a",{href:l?`https://github.com/vuer-ai/mujoco-ts/commit/${u}`:void 0,className:"px-md rounded-uk-ssx font-number-input text-text-tertiary text-uk-xs ml-[0px] bg-transparent py-[0px]",onClick:l?void 0:s=>s.preventDefault(),children:[w.jsx(Dr,{className:"mr-[2px] inline-block size-2"}),u]})]})}function ca({className:e,package:r=!1,prefix:t=!1,linkable:a=!1,version:l=!1,hash:u=!1}){const o=Ge.split("/").pop()||Ge,s=l?t?`v${pr}`:pr:void 0;return w.jsx(ua,{className:e,packageName:r?o:void 0,packageFullName:Ge,versionText:s,linkable:a,gitHash:u?ia:void 0})}const va="name time qpos qvel act ctrl mocap_pos mocap_quat site_xpos site_xmat geom_xpos geom_xmat sensordata qfrc_applied xfrc_applied",ma=(e=!1)=>{if(de.MuJoCo){if(console.warn("MuJoCo already registered:"),!e)return;console.info("Force reload MuJoCo module.")}de.MuJoCo=Yt,de.HandActuator=ea,de.MotionControllerActuator=ta,de.MjCameraView=oa,de.AnchorActuator=la,de.MjBadge=ca,console.info("vuer-mujoco registered:",de)};at["@vuer-ai/mujoco-ts"]=ma;export{va as ALL_KEYFRAME_KEYS,la as AnchorActuator,ia as GIT_HASH,ea as HandActuator,ca as MjBadge,oa as MjCameraView,ta as MotionControllerActuator,Yt as MuJoCo,ur as MuJoCoModel,Sr as MuJoCoModuleContext,ut as MuJoCoModuleProvider,Ye as MuJoCoProvider,pr as PACKAGE_VERSION,ua as PackageBadge,ot as dir2Euler,ma as entrypoint,te as getPosition,je as getQuaternion,wa as getRotMatrix,we as range,ga as setPosition,ya as setQuaternion,N as subArray,Vt as useInterval,Z as useMuJoCo,fe as useMuJoCoModule,Ht as useStateRef,Tr as useValueRef,sa as useVec3State};
